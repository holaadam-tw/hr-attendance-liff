<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ’° è–ªè³‡ - å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .salary-tabs { display: flex; gap: 4px; margin-bottom: 20px; background: var(--gray-light); border-radius: 10px; padding: 3px; }
        .salary-tab { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; transition: all 0.2s; background: transparent; color: var(--gray); }
        .salary-tab.active { background: var(--white); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .salary-view { display: none; }
        .salary-view.active { display: block; animation: pageIn 0.3s ease-out; }

        .salary-month-nav { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px; }
        .salary-month-nav button { background: none; border: none; font-size: 20px; cursor: pointer; padding: 6px 10px; border-radius: 8px; }
        .salary-month-nav button:active { background: var(--gray-light); }
        .salary-month-nav span { font-size: 16px; font-weight: 700; color: var(--dark); min-width: 100px; text-align: center; }

        .chart-container { display: flex; justify-content: center; margin-bottom: 20px; position: relative; }
        .donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .donut-center .amount { font-size: 20px; font-weight: 900; color: var(--dark); }
        .donut-center .label { font-size: 11px; color: var(--gray); font-weight: 600; }
        .chart-legend { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--gray); }
        .legend-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }

        .detail-section { margin-bottom: 16px; }
        .detail-section-title { font-size: 13px; font-weight: 700; color: var(--dark); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .detail-section-title .dot { width: 4px; height: 16px; border-radius: 2px; }
        .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 11px 0; border-bottom: 1px solid var(--gray-light); font-size: 14px; }
        .detail-row:last-child { border-bottom: none; }
        .detail-row .dl { color: var(--gray); }
        .detail-row .dv { font-weight: 700; color: var(--dark); }
        .detail-row .dv.deduct { color: var(--danger); }
        .detail-total { display: flex; justify-content: space-between; padding: 12px 0; font-size: 15px; font-weight: 800; border-top: 2px solid var(--gray-light); margin-top: 4px; }

        /* å‡ºå‹¤æ¦‚æ³ */
        .att-overview { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
        .att-ov-item { text-align: center; padding: 10px 4px; border-radius: 12px; }
        .att-ov-item .ao-num { font-size: 20px; font-weight: 900; }
        .att-ov-item .ao-label { font-size: 10px; font-weight: 600; margin-top: 2px; }

        /* Calculator */
        .calc-mode { display: flex; gap: 6px; margin-bottom: 16px; }
        .calc-mode-btn { flex: 1; padding: 12px 8px; border: 2px solid var(--border); border-radius: 12px; background: var(--white); cursor: pointer; text-align: center; transition: all 0.2s; }
        .calc-mode-btn.active { border-color: var(--primary); background: var(--primary-ghost); }
        .calc-mode-btn:active { transform: scale(0.97); }
        .calc-mode-btn .cm-icon { font-size: 24px; display: block; margin-bottom: 4px; }
        .calc-mode-btn .cm-label { font-size: 12px; font-weight: 700; color: var(--dark); }
        .calc-mode-btn .cm-desc { font-size: 10px; color: var(--gray); margin-top: 2px; }
        .calc-mode-btn.active .cm-label { color: var(--primary); }

        .calc-input-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .calc-input-row label { width: 80px; font-size: 13px; font-weight: 600; color: var(--gray); flex-shrink: 0; }
        .calc-input-row input[type="number"] { flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-size: 16px; font-weight: 700; text-align: right; }
        .calc-input-row input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79,70,229,0.08); }
        .calc-input-row .unit { font-size: 13px; color: var(--gray); font-weight: 600; width: 30px; }

        /* å›ºå®š/æŒ‰å¤© åˆ‡æ› */
        .calc-type-toggle { display: flex; gap: 4px; background: var(--gray-light); border-radius: 8px; padding: 2px; margin-bottom: 12px; }
        .calc-type-btn { flex: 1; padding: 8px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 700; transition: all 0.2s; background: transparent; color: var(--gray); text-align: center; }
        .calc-type-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 1px 4px rgba(0,0,0,0.08); }

        .calc-result { background: var(--primary-gradient); border-radius: 16px; padding: 20px; margin: 16px 0; }
        .calc-result-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
        .calc-result-row .cr-label { font-size: 13px; color: rgba(255,255,255,0.7); }
        .calc-result-row .cr-value { font-size: 15px; font-weight: 800; color: white; }
        .calc-result-row.main .cr-value { font-size: 28px; }
        .calc-result-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 8px 0; }

        .calc-detail-card { background: var(--white); border-radius: 14px; padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow-sm); }
        .calc-detail-title { font-size: 13px; font-weight: 700; color: var(--dark); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .calc-detail-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px; border-bottom: 1px solid var(--gray-light); }
        .calc-detail-row:last-child { border-bottom: none; }
        .calc-detail-row .cdr-label { color: var(--gray); }
        .calc-detail-row .cdr-value { font-weight: 700; color: var(--dark); }
        .calc-detail-row .cdr-formula { font-size: 11px; color: var(--info); display: block; margin-top: 2px; }
    </style>
</head>
<body>
    <div id="loadingPage" class="loading-screen"><div class="spinner"></div><p>ç³»çµ±è¼‰å…¥ä¸­...</p></div>

    <div class="container">
        <div id="salaryPage" class="page active">
            <div class="card" style="padding:16px;">
                <h2 style="text-align:center;font-size:18px;font-weight:800;color:var(--dark);margin-bottom:16px;">ğŸ’° è–ªè³‡ä¸­å¿ƒ</h2>
                <div class="salary-tabs">
                    <button class="salary-tab active" onclick="switchSalaryView('detail')">ğŸ“‹ è–ªè³‡æ˜ç´°</button>
                    <button class="salary-tab" onclick="switchSalaryView('calc')">ğŸ§® è–ªè³‡è©¦ç®—</button>
                </div>
            </div>

            <!-- ====== è–ªè³‡æ˜ç´° ====== -->
            <div id="salaryDetailView" class="salary-view active">
                <div class="card">
                    <div class="salary-month-nav">
                        <button onclick="changeSalaryMonth(-1)">â—€</button>
                        <span id="salaryMonthLabel">2026å¹´ 1æœˆ</span>
                        <button onclick="changeSalaryMonth(1)">â–¶</button>
                    </div>
                    <div style="background:var(--primary-gradient);border-radius:16px;padding:20px;text-align:center;margin-bottom:20px;">
                        <div style="font-size:12px;color:rgba(255,255,255,0.7);font-weight:600;">å¯¦ç™¼è–ªè³‡</div>
                        <div id="netSalary" style="font-size:36px;font-weight:900;color:#fff;margin-top:6px;letter-spacing:-1px;">NT$ 0</div>
                        <div id="paidDate" style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:4px;">å°šæœªç™¼æ”¾</div>
                    </div>

                    <!-- å‡ºå‹¤æ¦‚æ³ -->
                    <div class="att-overview">
                        <div class="att-ov-item" style="background:#ECFDF5;">
                            <div class="ao-num" style="color:#059669;" id="sdWorkDays">0</div>
                            <div class="ao-label" style="color:#059669;">å‡ºå‹¤å¤©æ•¸</div>
                        </div>
                        <div class="att-ov-item" style="background:#FFF7ED;">
                            <div class="ao-num" style="color:#EA580C;" id="sdLate">0</div>
                            <div class="ao-label" style="color:#EA580C;">é²åˆ°æ¬¡æ•¸</div>
                        </div>
                        <div class="att-ov-item" style="background:#EFF6FF;">
                            <div class="ao-num" style="color:#2563EB;" id="sdLeave">0</div>
                            <div class="ao-label" style="color:#2563EB;">è«‹å‡å¤©æ•¸</div>
                        </div>
                    </div>
                    <div id="sdExtraStats" style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;justify-content:center;"></div>

                    <div class="chart-container">
                        <canvas id="donutChart" width="200" height="200"></canvas>
                        <div class="donut-center"><div class="label">ç¸½æ”¶å…¥</div><div class="amount" id="chartTotal">NT$ 0</div></div>
                    </div>
                    <div class="chart-legend" id="chartLegend"></div>
                </div>

                <!-- æ”¶å…¥æ˜ç´° -->
                <div class="card">
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="dot" style="background:var(--success);"></span> æ”¶å…¥æ˜ç´°</div>
                        <div id="incomeRows"></div>
                        <div class="detail-total"><span style="color:var(--success);">æ”¶å…¥åˆè¨ˆ</span><span id="totalIncome" style="color:var(--success);">NT$ 0</span></div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="dot" style="background:var(--danger);"></span> æ‰£æ¬¾æ˜ç´°</div>
                        <div id="deductRows"></div>
                        <div class="detail-total"><span style="color:var(--danger);">æ‰£æ¬¾åˆè¨ˆ</span><span id="totalDeduct" style="color:var(--danger);">-NT$ 0</span></div>
                    </div>
                </div>
            </div>

            <!-- ====== è–ªè³‡è©¦ç®—å™¨ ====== -->
            <div id="salaryCalcView" class="salary-view">
                <div class="card">
                    <div class="text-heading-sm">é¸æ“‡è¨ˆè–ªæ–¹å¼</div>
                    <div class="calc-mode">
                        <div class="calc-mode-btn active" onclick="setCalcMode('monthly', this)">
                            <span class="cm-icon">ğŸ“…</span><span class="cm-label">æœˆè–ªåˆ¶</span><span class="cm-desc">å›ºå®šæœˆè–ª</span>
                        </div>
                        <div class="calc-mode-btn" onclick="setCalcMode('daily', this)">
                            <span class="cm-icon">ğŸ“†</span><span class="cm-label">æ—¥è–ªåˆ¶</span><span class="cm-desc">æŒ‰å¤©è¨ˆç®—</span>
                        </div>
                        <div class="calc-mode-btn" onclick="setCalcMode('hourly', this)">
                            <span class="cm-icon">â°</span><span class="cm-label">æ™‚è–ªåˆ¶</span><span class="cm-desc">æŒ‰æ™‚è¨ˆç®—</span>
                        </div>
                    </div>

                    <div id="calcInputs">
                        <div class="calc-input-row" id="rowMonthly">
                            <label>æœˆè–ª</label>
                            <input type="number" id="calcBase" value="35000" oninput="calculateSalary()">
                            <span class="unit">å…ƒ</span>
                        </div>
                        <div class="calc-input-row" id="rowDaily" style="display:none;">
                            <label>æ—¥è–ª</label>
                            <input type="number" id="calcDaily" value="1500" oninput="calculateSalary()">
                            <span class="unit">å…ƒ</span>
                        </div>
                        <div class="calc-input-row" id="rowHourly" style="display:none;">
                            <label>æ™‚è–ª</label>
                            <input type="number" id="calcHourly" value="190" oninput="calculateSalary()">
                            <span class="unit">å…ƒ</span>
                        </div>
                        <div class="calc-input-row">
                            <label>å‡ºå‹¤å¤©æ•¸</label>
                            <input type="number" id="calcDays" value="22" oninput="calculateSalary()">
                            <span class="unit">å¤©</span>
                        </div>
                        <!-- å¸¶å…¥å¯¦éš›å¤©æ•¸é–‹é—œ -->
                        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#F5F3FF;border-radius:10px;margin:-4px 0 12px;">
                            <span style="font-size:12px;font-weight:700;color:#4F46E5;">ğŸ“Š å¸¶å…¥å¯¦éš›å‡ºå‹¤å¤©æ•¸</span>
                            <div id="realDaysToggle" onclick="toggleRealDays()" style="width:44px;height:26px;border-radius:13px;background:#CBD5E1;position:relative;cursor:pointer;transition:background 0.3s;">
                                <div id="realDaysDot" style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;left:3px;transition:all 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                            </div>
                        </div>
                        <div id="realDaysInfo" style="display:none;padding:8px 12px;background:#ECFDF5;border-radius:10px;margin:-4px 0 12px;font-size:12px;color:#059669;">
                            âœ… å·²å¸¶å…¥ <b id="realDaysMonth">-</b> çš„å¯¦éš›å‡ºå‹¤ <b id="realDaysCount">-</b> å¤©
                        </div>
                        <div class="calc-input-row" id="rowHoursPerDay">
                            <label>æ¯æ—¥å·¥æ™‚</label>
                            <input type="number" id="calcHoursDay" value="8" oninput="calculateSalary()">
                            <span class="unit">æ™‚</span>
                        </div>
                        <div class="calc-input-row">
                            <label>åŠ ç­æ™‚æ•¸</label>
                            <input type="number" id="calcOT" value="0" oninput="calculateSalary()">
                            <span class="unit">æ™‚</span>
                        </div>
                        <div class="calc-input-row">
                            <label>å…¨å‹¤çé‡‘</label>
                            <input type="number" id="calcBonus" value="2000" oninput="calculateSalary()">
                            <span class="unit">å…ƒ</span>
                        </div>

                        <!-- è·å‹™åŠ çµ¦ï¼šå›ºå®š/æŒ‰å¤© -->
                        <div style="font-size:13px;font-weight:700;color:var(--dark);margin:16px 0 8px;">è·å‹™åŠ çµ¦</div>
                        <div class="calc-type-toggle">
                            <button class="calc-type-btn active" onclick="setAllowanceMode('position','fixed',this)">ğŸ“Œ æ¯æœˆå›ºå®š</button>
                            <button class="calc-type-btn" onclick="setAllowanceMode('position','daily',this)">ğŸ“† æŒ‰å¤©è¨ˆç®—</button>
                        </div>
                        <div class="calc-input-row">
                            <label id="posLabel">æœˆé¡</label>
                            <input type="number" id="calcPosition" value="5000" oninput="calculateSalary()">
                            <span class="unit">å…ƒ</span>
                        </div>

                        <!-- ä¼™é£Ÿæ´¥è²¼ï¼šå›ºå®š/æŒ‰å¤© -->
                        <div style="font-size:13px;font-weight:700;color:var(--dark);margin:16px 0 8px;">ä¼™é£Ÿæ´¥è²¼</div>
                        <div class="calc-type-toggle">
                            <button class="calc-type-btn active" onclick="setAllowanceMode('meal','fixed',this)">ğŸ“Œ æ¯æœˆå›ºå®š</button>
                            <button class="calc-type-btn" onclick="setAllowanceMode('meal','daily',this)">ğŸ“† æŒ‰å¤©è¨ˆç®—</button>
                        </div>
                        <div class="calc-input-row">
                            <label id="mealLabel">æœˆé¡</label>
                            <input type="number" id="calcMeal" value="2400" oninput="calculateSalary()">
                            <span class="unit">å…ƒ</span>
                        </div>

                        <div class="calc-input-row" style="margin-top:16px;">
                            <label>å‹é€€è‡ªæ</label>
                            <input type="number" id="calcPension" value="6" min="0" max="6" oninput="calculateSalary()">
                            <span class="unit">%</span>
                        </div>
                    </div>
                </div>

                <!-- è¨ˆç®—çµæœ -->
                <div class="calc-result" id="calcResult">
                    <div class="calc-result-row main">
                        <span class="cr-label">é ä¼°å¯¦é ˜</span>
                        <span class="cr-value" id="crNet">NT$ 0</span>
                    </div>
                    <div class="calc-result-divider"></div>
                    <div class="calc-result-row">
                        <span class="cr-label">ç¸½æ”¶å…¥</span>
                        <span class="cr-value" id="crGross">NT$ 0</span>
                    </div>
                    <div class="calc-result-row">
                        <span class="cr-label">ç¸½æ‰£æ¬¾</span>
                        <span class="cr-value" id="crDeduct">-NT$ 0</span>
                    </div>
                </div>

                <div class="calc-detail-card">
                    <div class="calc-detail-title">ğŸ”„ è–ªè³‡æ›ç®—</div>
                    <div class="calc-detail-row"><span class="cdr-label">æœˆè–ª</span><span class="cdr-value" id="cvMonth">-</span></div>
                    <div class="calc-detail-row"><span class="cdr-label">æ—¥è–ª</span><span class="cdr-value" id="cvDay">-</span></div>
                    <div class="calc-detail-row"><span class="cdr-label">æ™‚è–ª</span><span class="cdr-value" id="cvHour">-</span></div>
                </div>
                <div class="calc-detail-card"><div class="calc-detail-title">ğŸ’š æ”¶å…¥æ˜ç´°</div><div id="calcIncomeRows"></div></div>
                <div class="calc-detail-card"><div class="calc-detail-title">ğŸ”´ æ‰£æ¬¾æ˜ç´°</div><div id="calcDeductRows"></div></div>
                <div class="calc-detail-card"><div class="calc-detail-title">â° åŠ ç­è²»è¨ˆç®—ï¼ˆå‹åŸºæ³• Â§24ï¼‰</div><div id="calcOTRows"></div></div>

                <div class="card" style="padding:16px;">
                    <div class="text-heading-sm">ğŸ¥ å‹å¥ä¿èªªæ˜</div>
                    <div style="font-size:13px;color:var(--gray);line-height:1.8;">
                        <b style="color:var(--dark);">å‹ä¿</b>ï¼šæŠ•ä¿ç´šè· Ã— 12.5% Ã— è‡ªä»˜ 20%<br>
                        <b style="color:var(--dark);">å¥ä¿</b>ï¼šæŠ•ä¿ç´šè· Ã— 5.17% Ã— è‡ªä»˜ 30%<br>
                        <b style="color:var(--dark);">å‹é€€è‡ªæ</b>ï¼šæœˆè–ª Ã— 0~6%ï¼ˆå¯ç¯€ç¨…ï¼‰<br>
                        <b style="color:var(--dark);">æ‰€å¾—ç¨…</b>ï¼šé æ‰£ 5%ï¼ˆå¹´åº¦çµç®—å¤šé€€å°‘è£œï¼‰
                        <div style="padding:10px;background:var(--success-bg,#ECFDF5);border-radius:10px;font-size:12px;color:#059669;margin-top:8px;">
                            ğŸ’¡ å‹é€€è‡ªæå¯å¾å¹´åº¦æ‰€å¾—ç¨…ä¸­æ‰£é™¤ï¼Œå»ºè­°ææ»¿ 6%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="common.js"></script>
    <script>
        let salaryYear = new Date().getFullYear();
        let salaryMonth = new Date().getMonth() - 1;
        if (salaryMonth < 0) { salaryMonth = 11; salaryYear--; }
        let calcMode = 'monthly';
        let positionMode = 'fixed'; // fixed or daily
        let mealMode = 'fixed';

        const CHART_COLORS = ['#4F46E5','#F59E0B','#10B981','#3B82F6','#8B5CF6','#EC4899','#06B6D4'];
        function formatNT(n) { return 'NT$ ' + Math.abs(Math.round(n)).toLocaleString(); }

        // ===== Tab Switch =====
        function switchSalaryView(view) {
            document.querySelectorAll('.salary-tab').forEach((t,i) => t.classList.toggle('active', (view==='detail' ? i===0 : i===1)));
            document.querySelectorAll('.salary-view').forEach(v => v.classList.remove('active'));
            document.getElementById(view === 'detail' ? 'salaryDetailView' : 'salaryCalcView').classList.add('active');
            if (view === 'calc') calculateSalary();
        }

        // ===== Allowance Mode Toggle =====
        function setAllowanceMode(type, mode, btn) {
            if (type === 'position') positionMode = mode;
            else mealMode = mode;
            
            const parent = btn.parentElement;
            parent.querySelectorAll('.calc-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if (type === 'position') {
                document.getElementById('posLabel').textContent = mode === 'fixed' ? 'æœˆé¡' : 'æ—¥é¡';
            } else {
                document.getElementById('mealLabel').textContent = mode === 'fixed' ? 'æœˆé¡' : 'æ—¥é¡';
            }
            calculateSalary();
            
            // å„²å­˜è¨­å®šä¾›ä¸‹æœˆè‡ªå‹•å¸¶å…¥
            try {
                const key = `salary_calc_${type}_mode`;
                localStorage.setItem(key, mode);
            } catch(e) {}
        }

        // ===== Donut Chart =====
        function drawDonut(data) {
            const canvas = document.getElementById('donutChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            canvas.width = 200 * dpr; canvas.height = 200 * dpr;
            canvas.style.width = '200px'; canvas.style.height = '200px';
            ctx.scale(dpr, dpr);
            const cx=100,cy=100,outerR=90,innerR=58;
            const total = data.reduce((s,d) => s + d.value, 0);
            if (total <= 0) return;
            let startAngle = -Math.PI / 2;
            data.forEach((d,i) => {
                const slice = (d.value / total) * Math.PI * 2;
                ctx.beginPath(); ctx.arc(cx,cy,outerR,startAngle,startAngle+slice); ctx.arc(cx,cy,innerR,startAngle+slice,startAngle,true); ctx.closePath();
                ctx.fillStyle = CHART_COLORS[i % CHART_COLORS.length]; ctx.fill();
                startAngle += slice;
            });
            ctx.beginPath(); ctx.arc(cx,cy,innerR-1,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
        }

        // ===== Payroll Detail (with attendance stats) =====
        function renderSalary(s) {
            // å‡ºå‹¤æ¦‚æ³
            const cd = s.calculation_details || {};
            const workDays = cd.actual_days || cd.work_days || s.work_days || '-';
            const lateCount = cd.late_count ?? s.late_count ?? 0;
            const leaveDays = cd.leave_days ?? s.leave_days ?? 0;
            
            document.getElementById('sdWorkDays').textContent = workDays;
            document.getElementById('sdLate').textContent = lateCount;
            document.getElementById('sdLeave').textContent = leaveDays;
            
            // é¡å¤–çµ±è¨ˆï¼ˆåŠ ç­ã€å¤œç­ç­‰ï¼‰
            let extraHtml = '';
            const otHours = cd.overtime_hours || {};
            const totalOT = (otHours.regular || 0) + (otHours.rest_day || 0) + (otHours.holiday || 0);
            if (totalOT > 0) extraHtml += `<span style="font-size:12px;padding:4px 10px;background:#FEF3C7;color:#92400E;border-radius:8px;font-weight:700;">â° åŠ ç­ ${totalOT}h</span>`;
            const nightDays = cd.night_shift_days || 0;
            if (nightDays > 0) extraHtml += `<span style="font-size:12px;padding:4px 10px;background:#EDE9FE;color:#6D28D9;border-radius:8px;font-weight:700;">ğŸŒ™ å¤œç­ ${nightDays}å¤©</span>`;
            const scheduledDays = cd.work_days || 0;
            if (scheduledDays > 0 && workDays !== '-') extraHtml += `<span style="font-size:12px;padding:4px 10px;background:var(--gray-light);color:var(--gray);border-radius:8px;font-weight:700;">ğŸ“… æ‡‰å‡ºå‹¤ ${scheduledDays}å¤©</span>`;
            document.getElementById('sdExtraStats').innerHTML = extraHtml;

            // æ”¶å…¥æ˜ç´°ï¼ˆå¸¶è¨ˆç®—èªªæ˜ï¼‰
            const income = [
                { label:'åŸºæœ¬è–ªè³‡', value: s.base_salary||0, desc: s.salary_type === 'monthly' ? 'å›ºå®šæœˆè–ª' : (s.salary_type === 'daily' ? `æ—¥è–ª Ã— ${workDays}å¤©` : `æ™‚è–ª Ã— å·¥æ™‚`) },
                { label:'è·å‹™åŠ çµ¦', value: s.position_allowance||0, desc: cd.position_mode === 'daily' ? `${formatNT(cd.position_daily||0)}/å¤© Ã— ${workDays}å¤©` : 'æ¯æœˆå›ºå®š' },
                { label:'åŠ ç­è²»', value: s.overtime_pay||0, desc: totalOT > 0 ? `${totalOT}å°æ™‚` : '' },
                { label:'å…¨å‹¤çé‡‘', value: s.full_attendance_bonus||0, desc: (lateCount === 0 && leaveDays === 0) ? 'âœ… é”æˆ' : 'âŒ æœªé”æˆ' },
                { label:'ä¼™é£Ÿæ´¥è²¼', value: s.meal_allowance||0, desc: cd.meal_mode === 'daily' ? `${formatNT(cd.meal_daily||0)}/å¤© Ã— ${workDays}å¤©` : 'æ¯æœˆå›ºå®š' },
                { label:'å¤œç­æ´¥è²¼', value: s.night_allowance||0, desc: nightDays > 0 ? `${nightDays}å¤©` : '' }
            ].filter(i => i.value > 0);

            const deduct = [
                { label:'å‹ä¿è‡ªä»˜', value: s.labor_insurance||0, desc: 'æŠ•ä¿ç´šè· Ã— 12.5% Ã— 20%' },
                { label:'å¥ä¿è‡ªä»˜', value: s.health_insurance||0, desc: 'æŠ•ä¿ç´šè· Ã— 5.17% Ã— 30%' },
                { label:'å‹é€€è‡ªæ', value: s.pension_self||0, desc: `æœˆè–ª Ã— ${cd.pension_self_rate || 6}%` },
                { label:'é æ‰£æ‰€å¾—ç¨…', value: s.income_tax||0, desc: 'ç¸½æ”¶å…¥ Ã— 5%' },
                { label:'äº‹å‡æ‰£æ¬¾', value: s.personal_leave_deduction||0, desc: leaveDays > 0 ? `æ—¥è–ª Ã— ${leaveDays}å¤©` : '' },
                { label:'é²åˆ°æ‰£æ¬¾', value: s.late_deduction||0, desc: lateCount > 0 ? `${lateCount}æ¬¡` : '' }
            ].filter(i => i.value > 0);

            const totalI = income.reduce((a,b) => a+b.value, 0);
            const totalD = deduct.reduce((a,b) => a+b.value, 0);

            document.getElementById('netSalary').textContent = formatNT(totalI - totalD);
            document.getElementById('chartTotal').textContent = formatNT(totalI);
            document.getElementById('totalIncome').textContent = formatNT(totalI);
            document.getElementById('totalDeduct').textContent = '-' + formatNT(totalD);

            if (s.status === 'confirmed' || s.status === 'paid') {
                document.getElementById('paidDate').textContent = `å·²æ–¼ ${s.confirmed_at?.split('T')[0] || ''} ç¢ºèª`;
            }

            drawDonut(income);
            document.getElementById('chartLegend').innerHTML = income.map((d,i) => `<span class="legend-item"><span class="legend-dot" style="background:${CHART_COLORS[i]}"></span>${d.label}</span>`).join('');
            
            document.getElementById('incomeRows').innerHTML = income.map(i =>
                `<div class="detail-row"><span class="dl">${i.label}${i.desc ? `<br><span class="text-sm-secondary">${i.desc}</span>` : ''}</span><span class="dv">${formatNT(i.value)}</span></div>`
            ).join('');
            
            document.getElementById('deductRows').innerHTML = deduct.map(i =>
                `<div class="detail-row"><span class="dl">${i.label}${i.desc ? `<br><span class="text-sm-secondary">${i.desc}</span>` : ''}</span><span class="dv deduct">-${formatNT(i.value)}</span></div>`
            ).join('');
        }

        async function loadSalary() {
            document.getElementById('salaryMonthLabel').textContent = `${salaryYear}å¹´ ${salaryMonth+1}æœˆ`;
            try {
                if (typeof sb !== 'undefined' && liffProfile) {
                    // å…ˆå˜—è©¦ RPC
                    const { data, error } = await sb.rpc('get_employee_payroll', { p_line_user_id: liffProfile.userId, p_year: salaryYear, p_month: salaryMonth+1 });
                    if (!error && data?.success && data.data) { renderSalary(data.data); return; }
                    
                    // å†å˜—è©¦ç›´æ¥æŸ¥è¡¨
                    if (currentEmployee) {
                        const { data: p } = await sb.from('payroll').select('*').eq('employee_id', currentEmployee.id).eq('year', salaryYear).eq('month', salaryMonth+1).maybeSingle();
                        if (p) {
                            // å˜—è©¦è§£æ calculation_details
                            if (p.calculation_details && typeof p.calculation_details === 'string') {
                                try { p.calculation_details = JSON.parse(p.calculation_details); } catch(e) {}
                            }
                            renderSalary(p);
                            return;
                        }
                    }
                }
            } catch(e) { console.log('Fallback:', e.message); }

            // Demo data
            renderSalary({
                base_salary: 45000, overtime_pay: 3200, meal_allowance: 2400, position_allowance: 5000,
                full_attendance_bonus: 2000, night_allowance: 800,
                labor_insurance: 1042, health_insurance: 826, pension_self: 2700, income_tax: 894,
                personal_leave_deduction: 0, late_deduction: 0, status: 'demo',
                calculation_details: {
                    work_days: 22, actual_days: 21, late_count: 0, leave_days: 1,
                    overtime_hours: { regular: 4, rest_day: 0, holiday: 0 },
                    night_shift_days: 2, position_mode: 'fixed', meal_mode: 'fixed',
                    pension_self_rate: 6
                }
            });
        }

        function changeSalaryMonth(d) {
            salaryMonth += d;
            if (salaryMonth < 0) { salaryMonth = 11; salaryYear--; }
            if (salaryMonth > 11) { salaryMonth = 0; salaryYear++; }
            loadSalary();
        }

        // ===== Salary Calculator =====
        function setCalcMode(mode, el) {
            calcMode = mode;
            document.querySelectorAll('.calc-mode-btn').forEach(b => b.classList.remove('active'));
            if (el) el.classList.add('active');
            document.getElementById('rowMonthly').style.display = mode === 'monthly' ? 'flex' : 'none';
            document.getElementById('rowDaily').style.display = mode === 'daily' ? 'flex' : 'none';
            document.getElementById('rowHourly').style.display = mode === 'hourly' ? 'flex' : 'none';
            document.getElementById('rowHoursPerDay').style.display = mode === 'hourly' ? 'flex' : 'none';
            calculateSalary();
        }

        // ===== å‹å¥ä¿ç´šè·å¿«å– =====
        let cachedBrackets = [];
        async function loadInsuranceBrackets() {
            try {
                const { data } = await sb.from('insurance_brackets')
                    .select('*').eq('is_active', true).order('salary_min');
                if (data && data.length > 0) cachedBrackets = data;
            } catch(e) { console.log('ç´šè·è¡¨è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­è¨ˆç®—'); }
        }
        function lookupBracket(salary) {
            if (cachedBrackets.length === 0) return null;
            const b = cachedBrackets.find(r => salary >= r.salary_min && salary <= r.salary_max);
            return b || cachedBrackets[cachedBrackets.length - 1]; // fallback æœ€é«˜ç´šè·
        }

        function calculateSalary() {
            const days = parseFloat(document.getElementById('calcDays').value) || 0;
            const otHours = parseFloat(document.getElementById('calcOT').value) || 0;
            const bonus = parseFloat(document.getElementById('calcBonus').value) || 0;
            const pensionRate = parseFloat(document.getElementById('calcPension').value) || 0;
            const posVal = parseFloat(document.getElementById('calcPosition').value) || 0;
            const mealVal = parseFloat(document.getElementById('calcMeal').value) || 0;

            let monthSalary, dailyRate, hourlyRate;

            if (calcMode === 'monthly') {
                monthSalary = parseFloat(document.getElementById('calcBase').value) || 0;
                dailyRate = Math.round(monthSalary / 30);
                hourlyRate = Math.round(dailyRate / 8);
            } else if (calcMode === 'daily') {
                dailyRate = parseFloat(document.getElementById('calcDaily').value) || 0;
                hourlyRate = Math.round(dailyRate / 8);
                monthSalary = dailyRate * days;
            } else {
                hourlyRate = parseFloat(document.getElementById('calcHourly').value) || 0;
                const hpd = parseFloat(document.getElementById('calcHoursDay').value) || 8;
                dailyRate = hourlyRate * hpd;
                monthSalary = dailyRate * days;
            }

            // è·å‹™åŠ çµ¦ & ä¼™é£Ÿæ´¥è²¼
            const posAmount = positionMode === 'daily' ? posVal * days : posVal;
            const mealAmount = mealMode === 'daily' ? mealVal * days : mealVal;

            // åŠ ç­è²»
            let otPay = 0;
            const otDetail = [];
            if (otHours > 0) {
                const h1 = Math.min(otHours, 2);
                const h2 = Math.max(Math.min(otHours - 2, 2), 0);
                const pay1 = Math.round(hourlyRate * 1.34 * h1);
                const pay2 = Math.round(hourlyRate * 1.67 * h2);
                otPay = pay1 + pay2;
                if (h1 > 0) otDetail.push({ label: `å‰ ${h1} å°æ™‚`, formula: `${hourlyRate} Ã— 1.34 Ã— ${h1}`, value: pay1 });
                if (h2 > 0) otDetail.push({ label: `å¾Œ ${h2} å°æ™‚`, formula: `${hourlyRate} Ã— 1.67 Ã— ${h2}`, value: pay2 });
            }

            const grossBase = (calcMode === 'monthly') ? monthSalary : dailyRate * days;
            const gross = grossBase + otPay + bonus + mealAmount + posAmount;

            // å‹å¥ä¿ â€” æŸ¥ç´šè·è¡¨ï¼ˆæœ‰å¿«å–å‰‡ç”¨ï¼Œç„¡å‰‡ fallback ç›´æ¥è¨ˆç®—ï¼‰
            let laborIns, healthIns, insuredAmt;
            const bracket = lookupBracket(monthSalary);
            if (bracket) {
                insuredAmt = bracket.insured_amount;
                laborIns = Math.round(insuredAmt * (bracket.labor_rate || 0.125) * (bracket.labor_employee_share || 0.2));
                healthIns = Math.round(insuredAmt * (bracket.health_rate || 0.0517) * (bracket.health_employee_share || 0.3));
            } else {
                insuredAmt = monthSalary;
                laborIns = Math.round(monthSalary * 0.125 * 0.2);
                healthIns = Math.round(monthSalary * 0.0517 * 0.3);
            }
            const pension = Math.round(monthSalary * pensionRate / 100);
            const tax = Math.round(gross * 0.05);
            const totalDeduct = laborIns + healthIns + pension + tax;
            const net = gross - totalDeduct;

            document.getElementById('crNet').textContent = formatNT(net);
            document.getElementById('crGross').textContent = formatNT(gross);
            document.getElementById('crDeduct').textContent = '-' + formatNT(totalDeduct);
            document.getElementById('cvMonth').textContent = formatNT(monthSalary);
            document.getElementById('cvDay').textContent = formatNT(dailyRate) + ' /å¤©';
            document.getElementById('cvHour').textContent = formatNT(hourlyRate) + ' /æ™‚';

            // æ”¶å…¥æ˜ç´°
            const posDesc = positionMode === 'daily' ? `${formatNT(posVal)}/å¤© Ã— ${days}å¤©` : 'æ¯æœˆå›ºå®š';
            const mealDesc = mealMode === 'daily' ? `${formatNT(mealVal)}/å¤© Ã— ${days}å¤©` : 'æ¯æœˆå›ºå®š';
            const incomeItems = [
                { label: calcMode === 'monthly' ? 'åŸºæœ¬æœˆè–ª' : 'å‡ºå‹¤è–ªè³‡', value: grossBase, formula: calcMode === 'monthly' ? 'å›ºå®šæœˆè–ª' : `${formatNT(dailyRate)} Ã— ${days}å¤©` },
                { label: 'è·å‹™åŠ çµ¦', value: posAmount, formula: posDesc },
                { label: 'åŠ ç­è²»', value: otPay, formula: otHours > 0 ? `${otHours}å°æ™‚` : '' },
                { label: 'å…¨å‹¤çé‡‘', value: bonus },
                { label: 'ä¼™é£Ÿæ´¥è²¼', value: mealAmount, formula: mealDesc }
            ].filter(i => i.value > 0);

            document.getElementById('calcIncomeRows').innerHTML = incomeItems.map(i =>
                `<div class="calc-detail-row"><span class="cdr-label">${i.label}${i.formula ? `<span class="cdr-formula">${i.formula}</span>` : ''}</span><span class="cdr-value" style="color:var(--success);">${formatNT(i.value)}</span></div>`
            ).join('') + `<div class="calc-detail-row" style="font-weight:800;border-top:2px solid var(--gray-light);"><span>æ”¶å…¥åˆè¨ˆ</span><span style="color:var(--success);">${formatNT(gross)}</span></div>`;

            const deductItems = [
                { label: 'å‹ä¿è‡ªä»˜', value: laborIns, formula: `æŠ•ä¿ ${formatNT(insuredAmt)} Ã— 12.5% Ã— 20%` },
                { label: 'å¥ä¿è‡ªä»˜', value: healthIns, formula: `æŠ•ä¿ ${formatNT(insuredAmt)} Ã— 5.17% Ã— 30%` },
                { label: 'å‹é€€è‡ªæ', value: pension, formula: `${formatNT(monthSalary)} Ã— ${pensionRate}%` },
                { label: 'é æ‰£æ‰€å¾—ç¨…', value: tax, formula: `${formatNT(gross)} Ã— 5%` }
            ].filter(i => i.value > 0);

            document.getElementById('calcDeductRows').innerHTML = deductItems.map(i =>
                `<div class="calc-detail-row"><span class="cdr-label">${i.label}<span class="cdr-formula">${i.formula}</span></span><span class="cdr-value" style="color:var(--danger);">-${formatNT(i.value)}</span></div>`
            ).join('') + `<div class="calc-detail-row" style="font-weight:800;border-top:2px solid var(--gray-light);"><span>æ‰£æ¬¾åˆè¨ˆ</span><span style="color:var(--danger);">-${formatNT(totalDeduct)}</span></div>`;

            if (otDetail.length > 0) {
                document.getElementById('calcOTRows').innerHTML =
                    `<div class="calc-detail-row"><span class="cdr-label">æ™‚è–ª<span class="cdr-formula">æœˆè–ª Ã· 30 Ã· 8</span></span><span class="cdr-value">${formatNT(hourlyRate)}</span></div>` +
                    otDetail.map(d => `<div class="calc-detail-row"><span class="cdr-label">${d.label}<span class="cdr-formula">${d.formula}</span></span><span class="cdr-value" style="color:var(--success);">${formatNT(d.value)}</span></div>`).join('') +
                    `<div class="calc-detail-row" style="font-weight:800;border-top:2px solid var(--gray-light);"><span>åŠ ç­è²»åˆè¨ˆ</span><span style="color:var(--success);">${formatNT(otPay)}</span></div>`;
            } else {
                document.getElementById('calcOTRows').innerHTML = '<div style="text-align:center;color:var(--gray);font-size:13px;padding:12px;">ç„¡åŠ ç­</div>';
            }
        }

        // ===== å¸¶å…¥å¯¦éš›å¤©æ•¸ =====
        let realDaysOn = false;
        async function toggleRealDays() {
            realDaysOn = !realDaysOn;
            const toggle = document.getElementById('realDaysToggle');
            const dot = document.getElementById('realDaysDot');
            const info = document.getElementById('realDaysInfo');
            
            if (realDaysOn) {
                toggle.style.background = '#4F46E5';
                dot.style.left = 'auto'; dot.style.right = '3px';
                
                // å¾è€ƒå‹¤è³‡æ–™å¸¶å…¥
                try {
                    if (typeof sb !== 'undefined' && liffProfile) {
                        const now = new Date();
                        const y = now.getFullYear(), m = now.getMonth() + 1;
                        const { data } = await sb.rpc('get_monthly_attendance', { p_line_user_id: liffProfile.userId, p_year: y, p_month: m });
                        if (data) {
                            const days = data.length;
                            document.getElementById('calcDays').value = days;
                            document.getElementById('realDaysMonth').textContent = `${y}å¹´${m}æœˆ`;
                            document.getElementById('realDaysCount').textContent = days;
                            info.style.display = 'block';
                            calculateSalary();
                            return;
                        }
                    }
                } catch(e) { console.log('å¸¶å…¥å¤©æ•¸å¤±æ•—', e); }
                
                info.innerHTML = '<span style="color:#EA580C;">âš ï¸ ç„¡æ³•å–å¾—è€ƒå‹¤è³‡æ–™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥</span>';
                info.style.background = '#FFF7ED';
                info.style.display = 'block';
            } else {
                toggle.style.background = '#CBD5E1';
                dot.style.right = 'auto'; dot.style.left = '3px';
                info.style.display = 'none';
            }
        }

        // ===== Init =====
        window.addEventListener('load', async () => {
            // è¼‰å…¥ä¸Šæœˆçš„å›ºå®š/æŒ‰å¤©è¨­å®š
            try {
                const pm = localStorage.getItem('salary_calc_position_mode');
                const mm = localStorage.getItem('salary_calc_meal_mode');
                if (pm === 'daily') {
                    positionMode = 'daily';
                    document.getElementById('posLabel').textContent = 'æ—¥é¡';
                    const btns = document.querySelectorAll('.calc-type-toggle')[0]?.querySelectorAll('.calc-type-btn');
                    if (btns) { btns[0].classList.remove('active'); btns[1].classList.add('active'); }
                }
                if (mm === 'daily') {
                    mealMode = 'daily';
                    document.getElementById('mealLabel').textContent = 'æ—¥é¡';
                    const btns = document.querySelectorAll('.calc-type-toggle')[1]?.querySelectorAll('.calc-type-btn');
                    if (btns) { btns[0].classList.remove('active'); btns[1].classList.add('active'); }
                }
            } catch(e) {}

            if (typeof initializeLiff === 'undefined') { loadSalary(); calculateSalary(); return; }
            const init = await initializeLiff();
            if (init) {
                const ok = await checkUserStatus();
                if (ok) {
                    document.getElementById('loadingPage').style.display = 'none';
                    initBottomNav();
                    loadInsuranceBrackets(); // é è¼‰å‹å¥ä¿ç´šè·è¡¨
                    loadSalary();

                    // å¾ salary_settings è‡ªå‹•å¸¶å…¥
                    try {
                        if (currentEmployee) {
                            const { data } = await sb.from('salary_settings')
                                .select('salary_type, base_salary, meal_allowance, full_attendance_bonus, pension_self_rate, position_allowance')
                                .eq('employee_id', currentEmployee.id)
                                .eq('is_current', true)
                                .maybeSingle();

                            if (data) {
                                if (data.salary_type === 'hourly') {
                                    calcMode = 'hourly';
                                    document.getElementById('calcHourly').value = Math.round(data.base_salary / 30 / 8);
                                } else if (data.salary_type === 'daily') {
                                    calcMode = 'daily';
                                    document.getElementById('calcDaily').value = Math.round(data.base_salary / 30);
                                } else {
                                    calcMode = 'monthly';
                                    document.getElementById('calcBase').value = data.base_salary || 35000;
                                }

                                if (data.meal_allowance != null) document.getElementById('calcMeal').value = data.meal_allowance;
                                if (data.full_attendance_bonus != null) document.getElementById('calcBonus').value = data.full_attendance_bonus;
                                if (data.pension_self_rate != null) document.getElementById('calcPension').value = data.pension_self_rate;
                                if (data.position_allowance != null) document.getElementById('calcPosition').value = data.position_allowance;

                                document.querySelectorAll('.calc-mode-btn').forEach(b => b.classList.remove('active'));
                                const mi = { monthly: 0, daily: 1, hourly: 2 };
                                document.querySelectorAll('.calc-mode-btn')[mi[calcMode]]?.classList.add('active');
                                document.getElementById('rowMonthly').style.display = calcMode === 'monthly' ? 'flex' : 'none';
                                document.getElementById('rowDaily').style.display = calcMode === 'daily' ? 'flex' : 'none';
                                document.getElementById('rowHourly').style.display = calcMode === 'hourly' ? 'flex' : 'none';
                                document.getElementById('rowHoursPerDay').style.display = calcMode === 'hourly' ? 'flex' : 'none';
                            }
                        }
                    } catch(e) { console.log('Auto-detect:', e.message); }

                    calculateSalary();
                } else window.location.href = 'index.html';
            } else { document.getElementById('loadingPage').style.display = 'none'; loadSalary(); calculateSalary(); }
        });
    </script>
</body>
</html>
