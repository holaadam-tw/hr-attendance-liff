<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ’° è–ªè³‡æ˜ç´° - å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .salary-month-nav {
            display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px;
        }
        .salary-month-nav button {
            background: none; border: none; font-size: 20px; cursor: pointer;
            padding: 6px 10px; border-radius: 8px; transition: background 0.2s;
        }
        .salary-month-nav button:active { background: var(--gray-light); }
        .salary-month-nav span { font-size: 16px; font-weight: 700; color: var(--dark); min-width: 100px; text-align: center; }

        /* Donut chart */
        .chart-container { display: flex; justify-content: center; margin-bottom: 20px; position: relative; }
        .donut-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center;
        }
        .donut-center .amount { font-size: 20px; font-weight: 900; color: var(--dark); }
        .donut-center .label { font-size: 11px; color: var(--gray); font-weight: 600; }

        /* Legend */
        .chart-legend { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--gray); }
        .legend-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }

        /* Detail rows */
        .detail-section { margin-bottom: 16px; }
        .detail-section-title {
            font-size: 13px; font-weight: 700; color: var(--dark); margin-bottom: 8px;
            display: flex; align-items: center; gap: 6px;
        }
        .detail-section-title .dot { width: 4px; height: 16px; border-radius: 2px; }
        .detail-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 11px 0; border-bottom: 1px solid var(--gray-light); font-size: 14px;
        }
        .detail-row:last-child { border-bottom: none; }
        .detail-row .dl { color: var(--gray); }
        .detail-row .dv { font-weight: 700; color: var(--dark); }
        .detail-row .dv.income { color: var(--success); }
        .detail-row .dv.deduct { color: var(--danger); }
        .detail-total {
            display: flex; justify-content: space-between; padding: 12px 0; font-size: 15px; font-weight: 800;
            border-top: 2px solid var(--gray-light); margin-top: 4px;
        }

        .download-btn {
            width: 100%; padding: 14px; border-radius: 14px; border: none;
            background: var(--primary-gradient); color: #fff; font-weight: 700;
            font-size: 14px; cursor: pointer; box-shadow: 0 4px 16px var(--primary-shadow);
            margin-top: 8px; transition: all 0.2s;
        }
        .download-btn:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <div id="salaryPage" class="page active">
            <div class="card">
                <h2 style="text-align:center;font-size:18px;font-weight:800;color:var(--dark);margin-bottom:16px;">ğŸ’° è–ªè³‡æ˜ç´°</h2>

                <!-- æœˆä»½å°èˆª -->
                <div class="salary-month-nav">
                    <button onclick="changeSalaryMonth(-1)">â—€</button>
                    <span id="salaryMonthLabel">2026å¹´ 1æœˆ</span>
                    <button onclick="changeSalaryMonth(1)">â–¶</button>
                </div>

                <!-- æ·¨è–ªè³‡æ¨™é ­ -->
                <div style="background:var(--primary-gradient);border-radius:16px;padding:20px;text-align:center;margin-bottom:20px;">
                    <div style="font-size:12px;color:rgba(255,255,255,0.7);font-weight:600;">å¯¦ç™¼è–ªè³‡</div>
                    <div id="netSalary" style="font-size:36px;font-weight:900;color:#fff;margin-top:6px;letter-spacing:-1px;">NT$ 45,000</div>
                    <div id="paidDate" style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:4px;">å°šæœªç™¼æ”¾</div>
                </div>

                <!-- åœ“é¤…åœ– -->
                <div class="chart-container">
                    <canvas id="donutChart" width="200" height="200"></canvas>
                    <div class="donut-center">
                        <div class="label">ç¸½æ”¶å…¥</div>
                        <div class="amount" id="chartTotal">NT$ 77,000</div>
                    </div>
                </div>
                <div class="chart-legend" id="chartLegend"></div>
            </div>

            <!-- æ”¶å…¥æ˜ç´° -->
            <div class="card">
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span class="dot" style="background:var(--success);"></span> æ”¶å…¥æ˜ç´°
                    </div>
                    <div id="incomeRows"></div>
                    <div class="detail-total">
                        <span style="color:var(--success);">æ”¶å…¥åˆè¨ˆ</span>
                        <span id="totalIncome" style="color:var(--success);">NT$ 77,000</span>
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-section-title">
                        <span class="dot" style="background:var(--danger);"></span> æ‰£æ¬¾æ˜ç´°
                    </div>
                    <div id="deductRows"></div>
                    <div class="detail-total">
                        <span style="color:var(--danger);">æ‰£æ¬¾åˆè¨ˆ</span>
                        <span id="totalDeduct" style="color:var(--danger);">-NT$ 2,000</span>
                    </div>
                </div>
            </div>

            <button class="download-btn" onclick="showToast('ğŸ“„ PDF ä¸‹è¼‰åŠŸèƒ½é–‹ç™¼ä¸­')">ğŸ“„ ä¸‹è¼‰è–ªè³‡å–® PDF</button>

            <!-- è¨ˆç®—å…¬å¼èªªæ˜ -->
            <div class="card" style="padding:16px; margin-top:16px;">
                <div style="font-size:14px;font-weight:800;color:var(--dark);margin-bottom:12px;">ğŸ“ è–ªè³‡è¨ˆç®—èªªæ˜</div>
                
                <div style="font-size:13px;color:var(--gray);line-height:1.8;">
                    <div style="margin-bottom:12px;">
                        <b style="color:var(--dark);">ğŸ’° åŸºæœ¬è–ªè³‡</b><br>
                        æœˆè–ªåˆ¶å“¡å·¥ç‚ºå›ºå®šæœˆè–ª
                    </div>

                    <div style="margin-bottom:12px;">
                        <b style="color:var(--dark);">â° åŠ ç­è²»è¨ˆç®—ï¼ˆä¾å‹åŸºæ³• Â§24ï¼‰</b><br>
                        <span style="display:block;margin-left:8px;">â€¢ å¹³æ—¥å‰ 2 å°æ™‚ï¼šæ™‚è–ª Ã— <b>1.34</b> å€</span>
                        <span style="display:block;margin-left:8px;">â€¢ å¹³æ—¥å¾Œ 2 å°æ™‚ï¼šæ™‚è–ª Ã— <b>1.67</b> å€</span>
                        <span style="display:block;margin-left:8px;">â€¢ ä¼‘æ¯æ—¥å‰ 2 å°æ™‚ï¼šæ™‚è–ª Ã— <b>1.34</b> å€</span>
                        <span style="display:block;margin-left:8px;">â€¢ ä¼‘æ¯æ—¥ 2-8 å°æ™‚ï¼šæ™‚è–ª Ã— <b>1.67</b> å€</span>
                        <span style="display:block;margin-left:8px;">â€¢ åœ‹å®šå‡æ—¥ï¼šæ™‚è–ª Ã— <b>2.0</b> å€</span>
                        <span style="display:block;margin-left:8px;color:var(--info);">ğŸ“ æ™‚è–ª = æœˆè–ª Ã· 30 Ã· 8</span>
                    </div>

                    <div style="margin-bottom:12px;">
                        <b style="color:var(--dark);">ğŸ† å…¨å‹¤çé‡‘</b><br>
                        ç•¶æœˆç„¡é²åˆ°ã€ç„¡ç¼ºå‹¤ã€ç„¡äº‹å‡æ‰ç™¼æ”¾
                    </div>

                    <div style="margin-bottom:12px;">
                        <b style="color:var(--dark);">ğŸŒ™ å¤œç­æ´¥è²¼</b><br>
                        ä¸­ç­ NT$ 200/å¤©ã€æ™šç­ NT$ 400/å¤©
                    </div>
                </div>
            </div>

            <!-- å‹å¥ä¿èªªæ˜ -->
            <div class="card" style="padding:16px; margin-top:12px;">
                <div style="font-size:14px;font-weight:800;color:var(--dark);margin-bottom:12px;">ğŸ¥ å‹å¥ä¿è²»ç”¨èªªæ˜</div>
                
                <div style="font-size:13px;color:var(--gray);line-height:1.8;">
                    <div style="margin-bottom:12px;">
                        <b style="color:var(--dark);">å‹å·¥ä¿éšªï¼ˆå‹ä¿ï¼‰</b><br>
                        <span style="display:block;margin-left:8px;">â€¢ è²»ç‡ï¼š12.5%ï¼ˆ2025 å¹´ï¼‰</span>
                        <span style="display:block;margin-left:8px;">â€¢ å‹å·¥è‡ªä»˜æ¯”ä¾‹ï¼š<b>20%</b></span>
                        <span style="display:block;margin-left:8px;color:var(--info);">ğŸ“ è‡ªä»˜é¡ = æŠ•ä¿ç´šè· Ã— 12.5% Ã— 20%</span>
                    </div>

                    <div style="margin-bottom:12px;">
                        <b style="color:var(--dark);">å…¨æ°‘å¥åº·ä¿éšªï¼ˆå¥ä¿ï¼‰</b><br>
                        <span style="display:block;margin-left:8px;">â€¢ è²»ç‡ï¼š5.17%ï¼ˆ2025 å¹´ï¼‰</span>
                        <span style="display:block;margin-left:8px;">â€¢ å‹å·¥è‡ªä»˜æ¯”ä¾‹ï¼š<b>30%</b></span>
                        <span style="display:block;margin-left:8px;color:var(--info);">ğŸ“ è‡ªä»˜é¡ = æŠ•ä¿ç´šè· Ã— 5.17% Ã— 30%</span>
                    </div>

                    <div style="margin-bottom:12px;">
                        <b style="color:var(--dark);">å‹å·¥é€€ä¼‘é‡‘ï¼ˆå‹é€€ï¼‰</b><br>
                        <span style="display:block;margin-left:8px;">â€¢ é›‡ä¸»æç¹³ï¼šæœˆè–ª Ã— <b>6%</b>ï¼ˆä¸å¾è–ªè³‡æ‰£ï¼‰</span>
                        <span style="display:block;margin-left:8px;">â€¢ å‹å·¥è‡ªæï¼šæœˆè–ª Ã— <b>0~6%</b>ï¼ˆå¯å…ç¨…ï¼‰</span>
                        <span style="display:block;margin-left:8px;color:var(--success);">ğŸ’¡ è‡ªæé‡‘é¡å¯å¾ç•¶å¹´æ‰€å¾—ç¨…ä¸­æ‰£é™¤</span>
                    </div>

                    <div style="margin-bottom:4px;">
                        <b style="color:var(--dark);">æ‰€å¾—ç¨…é æ‰£</b><br>
                        <span style="display:block;margin-left:8px;">â€¢ ä¾è–ªè³‡ç´šè·é æ‰£ 5%</span>
                        <span style="display:block;margin-left:8px;color:var(--gray);">å¯¦éš›ç¨…é¡ä»¥å¹´åº¦å ±ç¨…çµç®—ç‚ºæº–</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªåˆ— -->
    <nav class="bottom-nav" style="display:none;">
        <a class="nav-item" onclick="window.location.href='index.html'">
            <span class="nav-icon">ğŸ </span><span class="nav-label">é¦–é </span>
        </a>
        <a class="nav-item" onclick="window.location.href='schedule.html'">
            <span class="nav-icon">ğŸ“…</span><span class="nav-label">ç­è¡¨</span>
        </a>
        <a class="nav-item" onclick="window.location.href='checkin.html?type=in'">
            <span class="nav-icon">ğŸ“</span><span class="nav-label">æ‰“å¡</span>
        </a>
        <a class="nav-item active">
            <span class="nav-icon">ğŸ’°</span><span class="nav-label">è–ªè³‡</span>
        </a>
        <a class="nav-item" onclick="window.location.href='services.html#settings'">
            <span class="nav-icon">âš™ï¸</span><span class="nav-label">è¨­å®š</span>
        </a>
    </nav>

    <script src="common.js"></script>
    <script>
        let salaryYear = new Date().getFullYear();
        let salaryMonth = new Date().getMonth() - 1; // é è¨­é¡¯ç¤ºä¸Šå€‹æœˆ
        if (salaryMonth < 0) { salaryMonth = 11; salaryYear--; }

        // Demo salary data
        const demoSalary = {
            base_salary: 45000,
            overtime_pay: 10000,
            meal_allowance: 2400,
            position_allowance: 5000,
            full_attendance_bonus: 2000,
            night_allowance: 800,
            labor_insurance: 1042,
            health_insurance: 826,
            pension_self: 2100,
            income_tax: 894,
            personal_leave_deduction: 0,
            late_deduction: 0,
            status: 'confirmed',
            confirmed_at: '2026-02-05'
        };

        const CHART_COLORS = [
            '#4F46E5', // åŸºæœ¬è–ªè³‡ - ç´«
            '#F59E0B', // è·å‹™åŠ çµ¦ - é»ƒ
            '#10B981', // åŠ ç­è²» - ç¶ 
            '#3B82F6', // å…¨å‹¤çé‡‘ - è—
            '#EF4444', // å‹å¥ä¿æ‰£é™¤ - ç´…
            '#8B5CF6', // ä¼™é£Ÿæ´¥è²¼ - æ·¡ç´«
            '#EC4899', // å¤œç­æ´¥è²¼ - ç²‰
        ];

        function formatNT(n) {
            return 'NT$ ' + Math.abs(n).toLocaleString();
        }

        function drawDonut(data) {
            const canvas = document.getElementById('donutChart');
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            canvas.width = 200 * dpr;
            canvas.height = 200 * dpr;
            canvas.style.width = '200px';
            canvas.style.height = '200px';
            ctx.scale(dpr, dpr);

            const cx = 100, cy = 100, outerR = 90, innerR = 58;
            const total = data.reduce((s, d) => s + d.value, 0);
            let startAngle = -Math.PI / 2;

            // Draw segments
            data.forEach((d, i) => {
                const sliceAngle = (d.value / total) * Math.PI * 2;
                const endAngle = startAngle + sliceAngle;

                ctx.beginPath();
                ctx.arc(cx, cy, outerR, startAngle, endAngle);
                ctx.arc(cx, cy, innerR, endAngle, startAngle, true);
                ctx.closePath();
                ctx.fillStyle = CHART_COLORS[i % CHART_COLORS.length];
                ctx.fill();

                startAngle = endAngle;
            });

            // Center circle (white)
            ctx.beginPath();
            ctx.arc(cx, cy, innerR - 1, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.fill();
        }

        function renderSalary(salary) {
            // Income items
            const incomeItems = [
                { label: 'åŸºæœ¬è–ªè³‡', value: salary.base_salary },
                { label: 'è·å‹™åŠ çµ¦', value: salary.position_allowance },
                { label: 'åŠ ç­è²»', value: salary.overtime_pay },
                { label: 'å…¨å‹¤çé‡‘', value: salary.full_attendance_bonus },
                { label: 'ä¼™é£Ÿæ´¥è²¼', value: salary.meal_allowance },
                { label: 'å¤œç­æ´¥è²¼', value: salary.night_allowance },
            ].filter(i => i.value > 0);

            // Deduct items with formulas
            const deductItems = [
                { label: 'å‹ä¿è‡ªä»˜', value: salary.labor_insurance, desc: 'æŠ•ä¿ç´šè· Ã— 12.5% Ã— 20%' },
                { label: 'å¥ä¿è‡ªä»˜', value: salary.health_insurance, desc: 'æŠ•ä¿ç´šè· Ã— 5.17% Ã— 30%' },
                { label: 'å‹é€€è‡ªæ', value: salary.pension_self || 0, desc: 'æœˆè–ª Ã— 6%' },
                { label: 'é æ‰£æ‰€å¾—ç¨…', value: salary.income_tax || 0, desc: 'ç¸½æ”¶å…¥ Ã— 5%' },
                { label: 'äº‹å‡æ‰£æ¬¾', value: salary.personal_leave_deduction || 0, desc: 'æ—¥è–ª Ã— äº‹å‡å¤©æ•¸' },
                { label: 'é²åˆ°æ‰£æ¬¾', value: salary.late_deduction || 0 },
            ].filter(i => i.value > 0);

            const totalIncome = incomeItems.reduce((s, i) => s + i.value, 0);
            const totalDeduct = deductItems.reduce((s, i) => s + i.value, 0);
            const netSalary = totalIncome - totalDeduct;

            // Update header
            document.getElementById('netSalary').textContent = formatNT(netSalary);
            document.getElementById('chartTotal').textContent = formatNT(totalIncome);
            document.getElementById('totalIncome').textContent = formatNT(totalIncome);
            document.getElementById('totalDeduct').textContent = '-' + formatNT(totalDeduct);

            if (salary.status === 'confirmed' || salary.status === 'paid') {
                document.getElementById('paidDate').textContent = `å·²æ–¼ ${salary.confirmed_at} ç¢ºèª`;
            }

            // Donut chart
            const chartData = incomeItems.map(i => ({ label: i.label, value: i.value }));
            drawDonut(chartData);

            // Legend
            const legendEl = document.getElementById('chartLegend');
            legendEl.innerHTML = chartData.map((d, i) =>
                `<span class="legend-item"><span class="legend-dot" style="background:${CHART_COLORS[i]}"></span>${d.label}</span>`
            ).join('');

            // Income rows
            document.getElementById('incomeRows').innerHTML = incomeItems.map(i =>
                `<div class="detail-row"><span class="dl">${i.label}</span><span class="dv">${formatNT(i.value)}</span></div>`
            ).join('');

            // Deduct rows (with formula)
            document.getElementById('deductRows').innerHTML = deductItems.map(i =>
                `<div class="detail-row">
                    <span class="dl">${i.label}${i.desc ? `<br><span style="font-size:11px;color:#94A3B8;">${i.desc}</span>` : ''}</span>
                    <span class="dv deduct">-${formatNT(i.value)}</span>
                </div>`
            ).join('');
        }

        async function loadSalary() {
            const label = document.getElementById('salaryMonthLabel');
            label.textContent = `${salaryYear}å¹´ ${salaryMonth + 1}æœˆ`;

            try {
                if (typeof sb !== 'undefined' && typeof liffProfile !== 'undefined' && liffProfile) {
                    // å…ˆå˜—è©¦ RPC
                    const { data, error } = await sb.rpc('get_employee_payroll', {
                        p_line_user_id: liffProfile.userId,
                        p_year: salaryYear,
                        p_month: salaryMonth + 1
                    });

                    if (!error && data && data.success && data.data) {
                        renderSalary(data.data);
                        return;
                    }

                    // fallback: ç›´æ¥æŸ¥ payroll è¡¨
                    if (currentEmployee) {
                        const { data: pData, error: pErr } = await sb.from('payroll')
                            .select('*')
                            .eq('employee_id', currentEmployee.id)
                            .eq('year', salaryYear)
                            .eq('month', salaryMonth + 1)
                            .maybeSingle();

                        if (!pErr && pData) {
                            renderSalary(pData);
                            return;
                        }
                    }
                }
            } catch (e) {
                console.log('ä½¿ç”¨ç¤ºç¯„è–ªè³‡:', e.message);
            }

            // Demo fallback
            renderSalary(demoSalary);
        }

        function changeSalaryMonth(delta) {
            salaryMonth += delta;
            if (salaryMonth < 0) { salaryMonth = 11; salaryYear--; }
            if (salaryMonth > 11) { salaryMonth = 0; salaryYear++; }
            loadSalary();
        }

        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') {
                loadSalary();
                return;
            }

            const initialized = await initializeLiff();
            if (initialized) {
                const isLoggedIn = await checkUserStatus();
                if (isLoggedIn) {
                    document.getElementById('loadingPage').style.display = 'none';
                    initBottomNav();
                    loadSalary();
                } else {
                    window.location.href = 'index.html';
                }
            } else {
                document.getElementById('loadingPage').style.display = 'none';
                loadSalary();
            }
        });
    </script>
</body>
</html>
