<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ’° è–ªè³‡ - å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .salary-tabs { display: flex; gap: 4px; margin-bottom: 20px; background: var(--gray-light); border-radius: 10px; padding: 3px; }
        .salary-tab { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; transition: all 0.2s; background: transparent; color: var(--gray); }
        .salary-tab.active { background: var(--white); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .salary-tab:active { transform: scale(0.97); }
        .salary-view { display: none; }
        .salary-view.active { display: block; animation: pageIn 0.3s ease-out; }

        .salary-month-nav { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px; }
        .salary-month-nav button { background: none; border: none; font-size: 20px; cursor: pointer; padding: 6px 10px; border-radius: 8px; }
        .salary-month-nav button:active { background: var(--gray-light); }
        .salary-month-nav span { font-size: 16px; font-weight: 700; color: var(--dark); min-width: 100px; text-align: center; }

        .chart-container { display: flex; justify-content: center; margin-bottom: 20px; position: relative; }
        .donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .donut-center .amount { font-size: 20px; font-weight: 900; color: var(--dark); }
        .donut-center .label { font-size: 11px; color: var(--gray); font-weight: 600; }
        .chart-legend { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--gray); }
        .legend-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }

        .detail-section { margin-bottom: 16px; }
        .detail-section-title { font-size: 13px; font-weight: 700; color: var(--dark); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .detail-section-title .dot { width: 4px; height: 16px; border-radius: 2px; }
        .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 11px 0; border-bottom: 1px solid var(--gray-light); font-size: 14px; }
        .detail-row:last-child { border-bottom: none; }
        .detail-row .dl { color: var(--gray); }
        .detail-row .dv { font-weight: 700; color: var(--dark); }
        .detail-row .dv.deduct { color: var(--danger); }
        .detail-total { display: flex; justify-content: space-between; padding: 12px 0; font-size: 15px; font-weight: 800; border-top: 2px solid var(--gray-light); margin-top: 4px; }

        /* Calculator */
        .calc-mode { display: flex; gap: 6px; margin-bottom: 16px; }
        .calc-mode-btn { flex: 1; padding: 12px 8px; border: 2px solid var(--border); border-radius: 12px; background: var(--white); cursor: pointer; text-align: center; transition: all 0.2s; }
        .calc-mode-btn.active { border-color: var(--primary); background: var(--primary-ghost); }
        .calc-mode-btn:active { transform: scale(0.97); }
        .calc-mode-btn .cm-icon { font-size: 24px; display: block; margin-bottom: 4px; }
        .calc-mode-btn .cm-label { font-size: 12px; font-weight: 700; color: var(--dark); }
        .calc-mode-btn .cm-desc { font-size: 10px; color: var(--gray); margin-top: 2px; }
        .calc-mode-btn.active .cm-label { color: var(--primary); }

        .calc-input-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .calc-input-row label { width: 80px; font-size: 13px; font-weight: 600; color: var(--gray); flex-shrink: 0; }
        .calc-input-row input { flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-size: 16px; font-weight: 700; text-align: right; }
        .calc-input-row input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79,70,229,0.08); }
        .calc-input-row .unit { font-size: 13px; color: var(--gray); font-weight: 600; width: 30px; }

        .calc-result { background: var(--primary-gradient); border-radius: 16px; padding: 20px; margin: 16px 0; }
        .calc-result-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
        .calc-result-row .cr-label { font-size: 13px; color: rgba(255,255,255,0.7); }
        .calc-result-row .cr-value { font-size: 15px; font-weight: 800; color: white; }
        .calc-result-row.main .cr-value { font-size: 28px; }
        .calc-result-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 8px 0; }

        .calc-detail-card { background: var(--white); border-radius: 14px; padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow-sm); }
        .calc-detail-title { font-size: 13px; font-weight: 700; color: var(--dark); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .calc-detail-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px; border-bottom: 1px solid var(--gray-light); }
        .calc-detail-row:last-child { border-bottom: none; }
        .calc-detail-row .cdr-label { color: var(--gray); }
        .calc-detail-row .cdr-value { font-weight: 700; color: var(--dark); }
        .calc-detail-row .cdr-formula { font-size: 11px; color: var(--info); display: block; margin-top: 2px; }
    </style>
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <div id="salaryPage" class="page active">
            <div class="card" style="padding:16px;">
                <h2 style="text-align:center;font-size:18px;font-weight:800;color:var(--dark);margin-bottom:16px;">ğŸ’° è–ªè³‡ä¸­å¿ƒ</h2>

                <!-- é ç±¤ï¼šæ˜ç´° / è©¦ç®— -->
                <div class="salary-tabs">
                    <button class="salary-tab active" onclick="switchSalaryView('detail')">ğŸ“‹ è–ªè³‡æ˜ç´°</button>
                    <button class="salary-tab" onclick="switchSalaryView('calc')">ğŸ§® è–ªè³‡è©¦ç®—</button>
                </div>
            </div>

            <!-- ====== è–ªè³‡æ˜ç´° ====== -->
            <div id="salaryDetailView" class="salary-view active">
                <div class="card">
                    <div class="salary-month-nav">
                        <button onclick="changeSalaryMonth(-1)">â—€</button>
                        <span id="salaryMonthLabel">2026å¹´ 1æœˆ</span>
                        <button onclick="changeSalaryMonth(1)">â–¶</button>
                    </div>
                    <div style="background:var(--primary-gradient);border-radius:16px;padding:20px;text-align:center;margin-bottom:20px;">
                        <div style="font-size:12px;color:rgba(255,255,255,0.7);font-weight:600;">å¯¦ç™¼è–ªè³‡</div>
                        <div id="netSalary" style="font-size:36px;font-weight:900;color:#fff;margin-top:6px;letter-spacing:-1px;">NT$ 0</div>
                        <div id="paidDate" style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:4px;">å°šæœªç™¼æ”¾</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="donutChart" width="200" height="200"></canvas>
                        <div class="donut-center"><div class="label">ç¸½æ”¶å…¥</div><div class="amount" id="chartTotal">NT$ 0</div></div>
                    </div>
                    <div class="chart-legend" id="chartLegend"></div>
                </div>

                <div class="card">
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="dot" style="background:var(--success);"></span> æ”¶å…¥æ˜ç´°</div>
                        <div id="incomeRows"></div>
                        <div class="detail-total"><span style="color:var(--success);">æ”¶å…¥åˆè¨ˆ</span><span id="totalIncome" style="color:var(--success);">NT$ 0</span></div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title"><span class="dot" style="background:var(--danger);"></span> æ‰£æ¬¾æ˜ç´°</div>
                        <div id="deductRows"></div>
                        <div class="detail-total"><span style="color:var(--danger);">æ‰£æ¬¾åˆè¨ˆ</span><span id="totalDeduct" style="color:var(--danger);">-NT$ 0</span></div>
                    </div>
                </div>
            </div>

            <!-- ====== è–ªè³‡è©¦ç®—å™¨ ====== -->
            <div id="salaryCalcView" class="salary-view">
                <!-- è¨ˆç®—æ¨¡å¼é¸æ“‡ -->
                <div class="card">
                    <div style="font-size:14px;font-weight:800;color:var(--dark);margin-bottom:14px;">é¸æ“‡è¨ˆè–ªæ–¹å¼</div>
                    <div class="calc-mode">
                        <div class="calc-mode-btn active" onclick="setCalcMode('monthly')">
                            <span class="cm-icon">ğŸ“…</span>
                            <span class="cm-label">æœˆè–ªåˆ¶</span>
                            <span class="cm-desc">å›ºå®šæœˆè–ª</span>
                        </div>
                        <div class="calc-mode-btn" onclick="setCalcMode('daily')">
                            <span class="cm-icon">ğŸ“†</span>
                            <span class="cm-label">æ—¥è–ªåˆ¶</span>
                            <span class="cm-desc">æŒ‰å¤©è¨ˆç®—</span>
                        </div>
                        <div class="calc-mode-btn" onclick="setCalcMode('hourly')">
                            <span class="cm-icon">â°</span>
                            <span class="cm-label">æ™‚è–ªåˆ¶</span>
                            <span class="cm-desc">æŒ‰æ™‚è¨ˆç®—</span>
                        </div>
                    </div>

                    <!-- è¼¸å…¥å€ -->
                    <div id="calcInputs">
                        <div class="calc-input-row" id="rowMonthly">
                            <label>æœˆè–ª</label>
                            <input type="number" id="calcBase" value="35000" oninput="calculateSalary()">
                            <span class="unit">å…ƒ</span>
                        </div>
                        <div class="calc-input-row" id="rowDaily" style="display:none;">
                            <label>æ—¥è–ª</label>
                            <input type="number" id="calcDaily" value="1500" oninput="calculateSalary()">
                            <span class="unit">å…ƒ</span>
                        </div>
                        <div class="calc-input-row" id="rowHourly" style="display:none;">
                            <label>æ™‚è–ª</label>
                            <input type="number" id="calcHourly" value="190" oninput="calculateSalary()">
                            <span class="unit">å…ƒ</span>
                        </div>
                        <div class="calc-input-row">
                            <label>å‡ºå‹¤å¤©æ•¸</label>
                            <input type="number" id="calcDays" value="22" oninput="calculateSalary()">
                            <span class="unit">å¤©</span>
                        </div>
                        <div class="calc-input-row" id="rowHoursPerDay">
                            <label>æ¯æ—¥å·¥æ™‚</label>
                            <input type="number" id="calcHoursDay" value="8" oninput="calculateSalary()">
                            <span class="unit">æ™‚</span>
                        </div>
                        <div class="calc-input-row">
                            <label>åŠ ç­æ™‚æ•¸</label>
                            <input type="number" id="calcOT" value="0" oninput="calculateSalary()">
                            <span class="unit">æ™‚</span>
                        </div>
                        <div class="calc-input-row">
                            <label>å…¨å‹¤çé‡‘</label>
                            <input type="number" id="calcBonus" value="2000" oninput="calculateSalary()">
                            <span class="unit">å…ƒ</span>
                        </div>
                        <div class="calc-input-row">
                            <label>ä¼™é£Ÿæ´¥è²¼</label>
                            <input type="number" id="calcMeal" value="2400" oninput="calculateSalary()">
                            <span class="unit">å…ƒ</span>
                        </div>
                        <div class="calc-input-row">
                            <label>å‹é€€è‡ªæ</label>
                            <input type="number" id="calcPension" value="6" min="0" max="6" oninput="calculateSalary()">
                            <span class="unit">%</span>
                        </div>
                    </div>
                </div>

                <!-- è¨ˆç®—çµæœ -->
                <div class="calc-result" id="calcResult">
                    <div class="calc-result-row main">
                        <span class="cr-label">é ä¼°å¯¦é ˜</span>
                        <span class="cr-value" id="crNet">NT$ 0</span>
                    </div>
                    <div class="calc-result-divider"></div>
                    <div class="calc-result-row">
                        <span class="cr-label">ç¸½æ”¶å…¥</span>
                        <span class="cr-value" id="crGross">NT$ 0</span>
                    </div>
                    <div class="calc-result-row">
                        <span class="cr-label">ç¸½æ‰£æ¬¾</span>
                        <span class="cr-value" id="crDeduct">-NT$ 0</span>
                    </div>
                </div>

                <!-- æ›ç®—çµæœ -->
                <div class="calc-detail-card">
                    <div class="calc-detail-title">ğŸ”„ è–ªè³‡æ›ç®—</div>
                    <div class="calc-detail-row"><span class="cdr-label">æœˆè–ª</span><span class="cdr-value" id="cvMonth">-</span></div>
                    <div class="calc-detail-row"><span class="cdr-label">æ—¥è–ª</span><span class="cdr-value" id="cvDay">-</span></div>
                    <div class="calc-detail-row"><span class="cdr-label">æ™‚è–ª</span><span class="cdr-value" id="cvHour">-</span></div>
                </div>

                <!-- æ”¶å…¥æ˜ç´° -->
                <div class="calc-detail-card">
                    <div class="calc-detail-title">ğŸ’š æ”¶å…¥æ˜ç´°</div>
                    <div id="calcIncomeRows"></div>
                </div>

                <!-- æ‰£æ¬¾æ˜ç´° -->
                <div class="calc-detail-card">
                    <div class="calc-detail-title">ğŸ”´ æ‰£æ¬¾æ˜ç´°</div>
                    <div id="calcDeductRows"></div>
                </div>

                <!-- åŠ ç­è²»èªªæ˜ -->
                <div class="calc-detail-card">
                    <div class="calc-detail-title">â° åŠ ç­è²»è¨ˆç®—ï¼ˆå‹åŸºæ³• Â§24ï¼‰</div>
                    <div id="calcOTRows"></div>
                </div>

                <!-- å‹å¥ä¿èªªæ˜ -->
                <div class="card" style="padding:16px;">
                    <div style="font-size:14px;font-weight:800;color:var(--dark);margin-bottom:12px;">ğŸ¥ å‹å¥ä¿èªªæ˜</div>
                    <div style="font-size:13px;color:var(--gray);line-height:1.8;">
                        <div style="margin-bottom:10px;">
                            <b style="color:var(--dark);">å‹ä¿</b>ï¼šæŠ•ä¿ç´šè· Ã— 12.5% Ã— è‡ªä»˜ 20%<br>
                            <b style="color:var(--dark);">å¥ä¿</b>ï¼šæŠ•ä¿ç´šè· Ã— 5.17% Ã— è‡ªä»˜ 30%<br>
                            <b style="color:var(--dark);">å‹é€€è‡ªæ</b>ï¼šæœˆè–ª Ã— 0~6%ï¼ˆå¯ç¯€ç¨…ï¼‰<br>
                            <b style="color:var(--dark);">æ‰€å¾—ç¨…</b>ï¼šé æ‰£ 5%ï¼ˆå¹´åº¦çµç®—å¤šé€€å°‘è£œï¼‰
                        </div>
                        <div style="padding:10px;background:var(--success-bg);border-radius:10px;font-size:12px;color:var(--success-text);">
                            ğŸ’¡ å‹é€€è‡ªæéƒ¨åˆ†å¯å¾å¹´åº¦æ‰€å¾—ç¨…ä¸­æ‰£é™¤ï¼Œå»ºè­°ææ»¿ 6%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav" style="display:none;">
        <a class="nav-item" onclick="window.location.href='index.html'"><span class="nav-icon">ğŸ </span><span class="nav-label">é¦–é </span></a>
        <a class="nav-item" onclick="window.location.href='schedule.html'"><span class="nav-icon">ğŸ“…</span><span class="nav-label">ç­è¡¨</span></a>
        <a class="nav-item" onclick="window.location.href='checkin.html?type=in'"><span class="nav-icon">ğŸ“</span><span class="nav-label">æ‰“å¡</span></a>
        <a class="nav-item active"><span class="nav-icon">ğŸ’°</span><span class="nav-label">è–ªè³‡</span></a>
        <a class="nav-item" onclick="window.location.href='admin.html'"><span class="nav-icon">âš™ï¸</span><span class="nav-label">ç®¡ç†</span></a>
    </nav>

    <script src="common.js"></script>
    <script>
        let salaryYear = new Date().getFullYear();
        let salaryMonth = new Date().getMonth() - 1;
        if (salaryMonth < 0) { salaryMonth = 11; salaryYear--; }
        let calcMode = 'monthly';

        const CHART_COLORS = ['#4F46E5','#F59E0B','#10B981','#3B82F6','#8B5CF6','#EC4899','#06B6D4'];
        function formatNT(n) { return 'NT$ ' + Math.abs(Math.round(n)).toLocaleString(); }

        // ===== Tab Switch =====
        function switchSalaryView(view) {
            document.querySelectorAll('.salary-tab').forEach((t,i) => t.classList.toggle('active', (view==='detail' ? i===0 : i===1)));
            document.querySelectorAll('.salary-view').forEach(v => v.classList.remove('active'));
            document.getElementById(view === 'detail' ? 'salaryDetailView' : 'salaryCalcView').classList.add('active');
            if (view === 'calc') calculateSalary();
        }

        // ===== Donut Chart =====
        function drawDonut(data) {
            const canvas = document.getElementById('donutChart');
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            canvas.width = 200 * dpr; canvas.height = 200 * dpr;
            canvas.style.width = '200px'; canvas.style.height = '200px';
            ctx.scale(dpr, dpr);
            const cx=100,cy=100,outerR=90,innerR=58;
            const total = data.reduce((s,d) => s + d.value, 0);
            let startAngle = -Math.PI / 2;
            data.forEach((d,i) => {
                const slice = (d.value / total) * Math.PI * 2;
                ctx.beginPath(); ctx.arc(cx,cy,outerR,startAngle,startAngle+slice); ctx.arc(cx,cy,innerR,startAngle+slice,startAngle,true); ctx.closePath();
                ctx.fillStyle = CHART_COLORS[i % CHART_COLORS.length]; ctx.fill();
                startAngle += slice;
            });
            ctx.beginPath(); ctx.arc(cx,cy,innerR-1,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
        }

        // ===== Payroll Detail =====
        function renderSalary(s) {
            const income = [
                {label:'åŸºæœ¬è–ªè³‡',value:s.base_salary||0},{label:'è·å‹™åŠ çµ¦',value:s.position_allowance||0},
                {label:'åŠ ç­è²»',value:s.overtime_pay||0},{label:'å…¨å‹¤çé‡‘',value:s.full_attendance_bonus||0},
                {label:'ä¼™é£Ÿæ´¥è²¼',value:s.meal_allowance||0},{label:'å¤œç­æ´¥è²¼',value:s.night_allowance||0}
            ].filter(i=>i.value>0);
            const deduct = [
                {label:'å‹ä¿è‡ªä»˜',value:s.labor_insurance||0,desc:'æŠ•ä¿ç´šè·Ã—12.5%Ã—20%'},
                {label:'å¥ä¿è‡ªä»˜',value:s.health_insurance||0,desc:'æŠ•ä¿ç´šè·Ã—5.17%Ã—30%'},
                {label:'å‹é€€è‡ªæ',value:s.pension_self||0,desc:'æœˆè–ªÃ—6%'},
                {label:'é æ‰£æ‰€å¾—ç¨…',value:s.income_tax||0,desc:'ç¸½æ”¶å…¥Ã—5%'},
                {label:'äº‹å‡æ‰£æ¬¾',value:s.personal_leave_deduction||0},{label:'é²åˆ°æ‰£æ¬¾',value:s.late_deduction||0}
            ].filter(i=>i.value>0);
            const totalI = income.reduce((a,b)=>a+b.value,0);
            const totalD = deduct.reduce((a,b)=>a+b.value,0);
            document.getElementById('netSalary').textContent = formatNT(totalI - totalD);
            document.getElementById('chartTotal').textContent = formatNT(totalI);
            document.getElementById('totalIncome').textContent = formatNT(totalI);
            document.getElementById('totalDeduct').textContent = '-' + formatNT(totalD);
            if (s.status==='confirmed'||s.status==='paid') document.getElementById('paidDate').textContent = `å·²æ–¼ ${s.confirmed_at?.split('T')[0]||''} ç¢ºèª`;
            drawDonut(income);
            document.getElementById('chartLegend').innerHTML = income.map((d,i)=>`<span class="legend-item"><span class="legend-dot" style="background:${CHART_COLORS[i]}"></span>${d.label}</span>`).join('');
            document.getElementById('incomeRows').innerHTML = income.map(i=>`<div class="detail-row"><span class="dl">${i.label}</span><span class="dv">${formatNT(i.value)}</span></div>`).join('');
            document.getElementById('deductRows').innerHTML = deduct.map(i=>`<div class="detail-row"><span class="dl">${i.label}${i.desc?`<br><span style="font-size:11px;color:#94A3B8;">${i.desc}</span>`:''}</span><span class="dv deduct">-${formatNT(i.value)}</span></div>`).join('');
        }

        async function loadSalary() {
            document.getElementById('salaryMonthLabel').textContent = `${salaryYear}å¹´ ${salaryMonth+1}æœˆ`;
            try {
                if (typeof sb!=='undefined' && typeof liffProfile!=='undefined' && liffProfile) {
                    const {data,error} = await sb.rpc('get_employee_payroll',{p_line_user_id:liffProfile.userId,p_year:salaryYear,p_month:salaryMonth+1});
                    if (!error && data?.success && data.data) { renderSalary(data.data); return; }
                    if (currentEmployee) {
                        const {data:p} = await sb.from('payroll').select('*').eq('employee_id',currentEmployee.id).eq('year',salaryYear).eq('month',salaryMonth+1).maybeSingle();
                        if (p) { renderSalary(p); return; }
                    }
                }
            } catch(e) { console.log('Demo fallback:', e.message); }
            renderSalary({base_salary:45000,overtime_pay:0,meal_allowance:2400,position_allowance:5000,full_attendance_bonus:2000,night_allowance:0,labor_insurance:1042,health_insurance:826,pension_self:2100,income_tax:894,personal_leave_deduction:0,late_deduction:0,status:'demo'});
        }

        function changeSalaryMonth(d) { salaryMonth+=d; if(salaryMonth<0){salaryMonth=11;salaryYear--;}if(salaryMonth>11){salaryMonth=0;salaryYear++;} loadSalary(); }

        // ===== Salary Calculator =====
        function setCalcMode(mode) {
            calcMode = mode;
            document.querySelectorAll('.calc-mode-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById('rowMonthly').style.display = mode==='monthly' ? 'flex' : 'none';
            document.getElementById('rowDaily').style.display = mode==='daily' ? 'flex' : 'none';
            document.getElementById('rowHourly').style.display = mode==='hourly' ? 'flex' : 'none';
            document.getElementById('rowHoursPerDay').style.display = mode==='hourly' ? 'flex' : 'none';
            calculateSalary();
        }

        function calculateSalary() {
            const days = parseFloat(document.getElementById('calcDays').value) || 0;
            const otHours = parseFloat(document.getElementById('calcOT').value) || 0;
            const bonus = parseFloat(document.getElementById('calcBonus').value) || 0;
            const meal = parseFloat(document.getElementById('calcMeal').value) || 0;
            const pensionRate = parseFloat(document.getElementById('calcPension').value) || 0;

            let monthSalary, dailyRate, hourlyRate;

            if (calcMode === 'monthly') {
                monthSalary = parseFloat(document.getElementById('calcBase').value) || 0;
                dailyRate = Math.round(monthSalary / 30);
                hourlyRate = Math.round(dailyRate / 8);
            } else if (calcMode === 'daily') {
                dailyRate = parseFloat(document.getElementById('calcDaily').value) || 0;
                hourlyRate = Math.round(dailyRate / 8);
                monthSalary = dailyRate * days;
            } else {
                hourlyRate = parseFloat(document.getElementById('calcHourly').value) || 0;
                const hpd = parseFloat(document.getElementById('calcHoursDay').value) || 8;
                dailyRate = hourlyRate * hpd;
                monthSalary = dailyRate * days;
            }

            // åŠ ç­è²»
            let otPay = 0;
            const otDetail = [];
            if (otHours > 0) {
                const h1 = Math.min(otHours, 2);
                const h2 = Math.max(Math.min(otHours - 2, 2), 0);
                const pay1 = Math.round(hourlyRate * 1.34 * h1);
                const pay2 = Math.round(hourlyRate * 1.67 * h2);
                otPay = pay1 + pay2;
                if (h1 > 0) otDetail.push({label:`å‰ ${h1} å°æ™‚`,formula:`${hourlyRate} Ã— 1.34 Ã— ${h1}`,value:pay1});
                if (h2 > 0) otDetail.push({label:`å¾Œ ${h2} å°æ™‚`,formula:`${hourlyRate} Ã— 1.67 Ã— ${h2}`,value:pay2});
            }

            const grossBase = (calcMode === 'monthly') ? monthSalary : dailyRate * days;
            const gross = grossBase + otPay + bonus + meal;

            // å‹å¥ä¿ï¼ˆç”¨æœˆè–ªç•¶æŠ•ä¿ç´šè·ç°¡åŒ–ï¼‰
            const laborIns = Math.round(monthSalary * 0.125 * 0.2);
            const healthIns = Math.round(monthSalary * 0.0517 * 0.3);
            const pension = Math.round(monthSalary * pensionRate / 100);
            const tax = Math.round(gross * 0.05);
            const totalDeduct = laborIns + healthIns + pension + tax;
            const net = gross - totalDeduct;

            // é¡¯ç¤ºçµæœ
            document.getElementById('crNet').textContent = formatNT(net);
            document.getElementById('crGross').textContent = formatNT(gross);
            document.getElementById('crDeduct').textContent = '-' + formatNT(totalDeduct);

            document.getElementById('cvMonth').textContent = formatNT(monthSalary);
            document.getElementById('cvDay').textContent = formatNT(dailyRate) + ' /å¤©';
            document.getElementById('cvHour').textContent = formatNT(hourlyRate) + ' /æ™‚';

            // æ”¶å…¥æ˜ç´°
            const incomeItems = [
                {label: calcMode==='monthly'?'åŸºæœ¬æœˆè–ª':'å‡ºå‹¤è–ªè³‡', value: grossBase, formula: calcMode==='monthly'?'å›ºå®šæœˆè–ª':`${formatNT(dailyRate)} Ã— ${days}å¤©`},
                {label:'åŠ ç­è²»', value:otPay, formula:otHours>0?`${otHours}å°æ™‚`:''},
                {label:'å…¨å‹¤çé‡‘', value:bonus}, {label:'ä¼™é£Ÿæ´¥è²¼', value:meal}
            ].filter(i=>i.value>0);
            document.getElementById('calcIncomeRows').innerHTML = incomeItems.map(i=>
                `<div class="calc-detail-row"><span class="cdr-label">${i.label}${i.formula?`<span class="cdr-formula">${i.formula}</span>`:''}</span><span class="cdr-value" style="color:var(--success);">${formatNT(i.value)}</span></div>`
            ).join('') + `<div class="calc-detail-row" style="font-weight:800;border-top:2px solid var(--gray-light);"><span>æ”¶å…¥åˆè¨ˆ</span><span style="color:var(--success);">${formatNT(gross)}</span></div>`;

            // æ‰£æ¬¾æ˜ç´°
            const deductItems = [
                {label:'å‹ä¿è‡ªä»˜', value:laborIns, formula:`${formatNT(monthSalary)} Ã— 12.5% Ã— 20%`},
                {label:'å¥ä¿è‡ªä»˜', value:healthIns, formula:`${formatNT(monthSalary)} Ã— 5.17% Ã— 30%`},
                {label:'å‹é€€è‡ªæ', value:pension, formula:`${formatNT(monthSalary)} Ã— ${pensionRate}%`},
                {label:'é æ‰£æ‰€å¾—ç¨…', value:tax, formula:`${formatNT(gross)} Ã— 5%`}
            ].filter(i=>i.value>0);
            document.getElementById('calcDeductRows').innerHTML = deductItems.map(i=>
                `<div class="calc-detail-row"><span class="cdr-label">${i.label}<span class="cdr-formula">${i.formula}</span></span><span class="cdr-value" style="color:var(--danger);">-${formatNT(i.value)}</span></div>`
            ).join('') + `<div class="calc-detail-row" style="font-weight:800;border-top:2px solid var(--gray-light);"><span>æ‰£æ¬¾åˆè¨ˆ</span><span style="color:var(--danger);">-${formatNT(totalDeduct)}</span></div>`;

            // åŠ ç­è²»æ˜ç´°
            if (otDetail.length > 0) {
                document.getElementById('calcOTRows').innerHTML = 
                    `<div class="calc-detail-row"><span class="cdr-label">æ™‚è–ª<span class="cdr-formula">æœˆè–ª Ã· 30 Ã· 8</span></span><span class="cdr-value">${formatNT(hourlyRate)}</span></div>` +
                    otDetail.map(d=>`<div class="calc-detail-row"><span class="cdr-label">${d.label}<span class="cdr-formula">${d.formula}</span></span><span class="cdr-value" style="color:var(--success);">${formatNT(d.value)}</span></div>`).join('') +
                    `<div class="calc-detail-row" style="font-weight:800;border-top:2px solid var(--gray-light);"><span>åŠ ç­è²»åˆè¨ˆ</span><span style="color:var(--success);">${formatNT(otPay)}</span></div>`;
            } else {
                document.getElementById('calcOTRows').innerHTML = '<div style="text-align:center;color:var(--gray);font-size:13px;padding:12px;">ç„¡åŠ ç­</div>';
            }
        }

        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') { loadSalary(); calculateSalary(); return; }
            const init = await initializeLiff();
            if (init) {
                const ok = await checkUserStatus();
                if (ok) {
                    document.getElementById('loadingPage').style.display='none';
                    initBottomNav();
                    loadSalary();
                    
                    // è‡ªå‹•åµæ¸¬è¨ˆè–ªæ–¹å¼ä¸¦é å¡«
                    try {
                        if (currentEmployee) {
                            const { data } = await sb.from('salary_settings')
                                .select('salary_type, base_salary, meal_allowance, full_attendance_bonus, pension_self_rate')
                                .eq('employee_id', currentEmployee.id)
                                .eq('is_current', true)
                                .maybeSingle();
                            
                            if (data) {
                                // è¨­å®šè¨ˆè–ªæ¨¡å¼
                                if (data.salary_type === 'hourly') {
                                    calcMode = 'hourly';
                                    document.getElementById('calcHourly').value = Math.round(data.base_salary / 30 / 8);
                                } else if (data.salary_type === 'daily') {
                                    calcMode = 'daily';
                                    document.getElementById('calcDaily').value = Math.round(data.base_salary / 30);
                                } else {
                                    calcMode = 'monthly';
                                    document.getElementById('calcBase').value = data.base_salary || 35000;
                                }
                                
                                // é å¡«å…¶ä»–æ¬„ä½
                                if (data.meal_allowance != null) document.getElementById('calcMeal').value = data.meal_allowance;
                                if (data.full_attendance_bonus != null) document.getElementById('calcBonus').value = data.full_attendance_bonus;
                                if (data.pension_self_rate != null) document.getElementById('calcPension').value = data.pension_self_rate;
                                
                                // æ›´æ–° UI é¡¯ç¤º
                                document.querySelectorAll('.calc-mode-btn').forEach(b => b.classList.remove('active'));
                                const modeMap = { monthly: 0, daily: 1, hourly: 2 };
                                document.querySelectorAll('.calc-mode-btn')[modeMap[calcMode]]?.classList.add('active');
                                document.getElementById('rowMonthly').style.display = calcMode==='monthly' ? 'flex' : 'none';
                                document.getElementById('rowDaily').style.display = calcMode==='daily' ? 'flex' : 'none';
                                document.getElementById('rowHourly').style.display = calcMode==='hourly' ? 'flex' : 'none';
                                document.getElementById('rowHoursPerDay').style.display = calcMode==='hourly' ? 'flex' : 'none';
                            }
                        }
                    } catch(e) { console.log('Auto-detect salary type:', e.message); }
                    
                    calculateSalary();
                }
                else window.location.href = 'index.html';
            } else { document.getElementById('loadingPage').style.display='none'; loadSalary(); calculateSalary(); }
        });
    </script>
</body>
</html>
