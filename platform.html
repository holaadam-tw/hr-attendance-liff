<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ›¡ï¸ å¹³å°ç®¡ç† - SaaS å¾Œå°</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <!-- æ¬Šé™æª¢æŸ¥ -->
        <div id="permissionPage" class="page active">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">ğŸ›¡ï¸</span>
                    <h2>å¹³å°ç®¡ç†å“¡é©—è­‰</h2>
                    <p>æ­£åœ¨é©—è­‰èº«ä»½...</p>
                </div>
                <div id="permissionStatus" class="status-box show info">æª¢æŸ¥æ¬Šé™ä¸­...</div>
            </div>
        </div>

        <!-- å¹³å°é¦–é  -->
        <div id="platformHomePage" class="page">
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="platformAvatar">ğŸ›¡ï¸</div>
                    <div class="user-details">
                        <h2 id="platformName">å¹³å°ç®¡ç†å“¡</h2>
                        <p style="font-size:12px;color:#64748B;">SaaS å¹³å°ç®¡ç†</p>
                    </div>
                </div>
            </div>

            <!-- å„€è¡¨æ¿ -->
            <div class="card" style="padding:16px;margin-bottom:16px;">
                <div style="font-size:14px;font-weight:700;margin-bottom:12px;">ğŸ“Š å¹³å°æ¦‚è¦½</div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
                    <div style="text-align:center;padding:12px;background:#DBEAFE;border-radius:10px;">
                        <div id="statCompanies" style="font-size:24px;font-weight:900;color:#1E40AF;">0</div>
                        <div style="font-size:11px;color:#1E40AF;">å…¬å¸æ•¸</div>
                    </div>
                    <div style="text-align:center;padding:12px;background:#D1FAE5;border-radius:10px;">
                        <div id="statEmployees" style="font-size:24px;font-weight:900;color:#059669;">0</div>
                        <div style="font-size:11px;color:#059669;">å“¡å·¥æ•¸</div>
                    </div>
                    <div style="text-align:center;padding:12px;background:#FEF3C7;border-radius:10px;">
                        <div id="statPending" style="font-size:24px;font-weight:900;color:#D97706;">0</div>
                        <div style="font-size:11px;color:#D97706;">å¾…å¯©æ ¸</div>
                    </div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="showPage('companyMgrPage')">
                    <div class="icon">ğŸ¢</div><div class="label">å…¬å¸ç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="showPage('pendingPage')">
                    <div class="icon">ğŸ“</div><div class="label">ç”³è«‹å¯©æ ¸</div>
                </div>
                <div class="menu-item" onclick="window.location.href='index.html'">
                    <div class="icon">ğŸ </div><div class="label">è¿”å›é¦–é </div>
                </div>
            </div>
        </div>

        <!-- å…¬å¸ç®¡ç†é  -->
        <div id="companyMgrPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('platformHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ¢ å…¬å¸ç®¡ç†</h2>

                <div style="display:flex;gap:8px;margin-bottom:12px;">
                    <input type="text" id="pCompanySearch" placeholder="æœå°‹å…¬å¸..." oninput="filterPlatformCompanies()" style="flex:1;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                    <button class="btn btn-primary" onclick="showPCompanyModal()" style="white-space:nowrap;font-size:13px;padding:10px 16px;">+ æ–°å¢</button>
                </div>

                <div id="pCompanyList">
                    <p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <!-- æ–°å¢/ç·¨è¼¯å…¬å¸ Modal -->
            <div id="pCompanyModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999;overflow-y:auto;">
                <div style="background:#fff;margin:30px auto;max-width:500px;border-radius:16px;padding:24px;">
                    <h3 id="pCompanyModalTitle" style="margin-bottom:16px;">æ–°å¢å…¬å¸</h3>
                    <input type="hidden" id="pCompanyEditId">
                    <div class="form-group"><label>å…¬å¸ä»£ç¢¼ *</label><input type="text" id="pCompanyCode" placeholder="ä¾‹ï¼šCOMPANY_001" style="text-transform:uppercase;"></div>
                    <div class="form-group"><label>å…¬å¸åç¨± *</label><input type="text" id="pCompanyName" placeholder="å…¬å¸å…¨å"></div>
                    <div class="form-group"><label>è¯çµ¡äºº</label><input type="text" id="pContactName" placeholder="è¯çµ¡äººå§“å"></div>
                    <div class="form-group"><label>é›»è©±</label><input type="text" id="pContactPhone" placeholder="é›»è©±"></div>
                    <div class="form-group"><label>Email</label><input type="email" id="pContactEmail" placeholder="email@example.com"></div>
                    <div class="form-group">
                        <label>æ–¹æ¡ˆ</label>
                        <select id="pPlanType" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                            <option value="basic">Basicï¼ˆåŸºæœ¬ï¼‰</option>
                            <option value="pro">Proï¼ˆé€²éšï¼‰</option>
                            <option value="enterprise">Enterpriseï¼ˆä¼æ¥­ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group"><label>å“¡å·¥ä¸Šé™</label><input type="number" id="pMaxEmployees" value="50" min="1"></div>
                    <div class="form-group">
                        <label>ç‹€æ…‹</label>
                        <select id="pStatus" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                            <option value="active">å•Ÿç”¨</option>
                            <option value="pending">å¾…å¯©æ ¸</option>
                            <option value="suspended">æš«åœ</option>
                        </select>
                    </div>

                    <!-- åŠŸèƒ½é–‹é—œ -->
                    <div style="margin-top:16px;padding:14px;background:#F8FAFC;border-radius:12px;">
                        <div style="font-weight:700;font-size:13px;margin-bottom:10px;">ğŸ›ï¸ åŠŸèƒ½é–‹é—œ</div>
                        <div style="display:flex;gap:6px;margin-bottom:10px;">
                            <button type="button" onclick="applyFeaturePreset('general')" style="flex:1;padding:8px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:12px;font-weight:700;cursor:pointer;color:#4F46E5;">ğŸ¢ ä¸€èˆ¬å…¬å¸</button>
                            <button type="button" onclick="applyFeaturePreset('catering')" style="flex:1;padding:8px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:12px;font-weight:700;cursor:pointer;color:#059669;">ğŸ½ï¸ é¤é£²æ¥­</button>
                            <button type="button" onclick="applyFeaturePreset('all')" style="flex:1;padding:8px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:12px;font-weight:700;cursor:pointer;color:#D97706;">âœ… å…¨é–‹</button>
                        </div>
                        <div id="pFeatureToggles" style="display:flex;flex-direction:column;gap:8px;"></div>
                    </div>

                    <div style="display:flex;gap:8px;margin-top:16px;">
                        <button class="btn btn-success" onclick="savePCompany()" style="flex:1;">ğŸ’¾ å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="closePCompanyModal()" style="flex:1;">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <!-- QR Code Modal -->
            <div id="pQrModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999;display:none;">
                <div style="background:#fff;margin:80px auto;max-width:350px;border-radius:16px;padding:24px;text-align:center;">
                    <h3 style="margin-bottom:12px;">ğŸ“± å“¡å·¥ç¶å®š QR Code</h3>
                    <div id="pQrCode" style="display:inline-block;margin-bottom:12px;"></div>
                    <div id="pQrUrl" style="font-size:11px;color:#94A3B8;word-break:break-all;margin-bottom:12px;"></div>
                    <button class="btn btn-secondary" onclick="document.getElementById('pQrModal').style.display='none'" style="width:100%;">é—œé–‰</button>
                </div>
            </div>
        </div>

        <!-- å¾…å¯©æ ¸é  -->
        <div id="pendingPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('platformHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“ å…¬å¸ç”³è«‹å¯©æ ¸</h2>
                <div id="pendingList">
                    <p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        let currentPlatformAdmin = null;
        let allPCompanies = [];

        const FEATURE_LIST = [
            { key: 'leave', label: 'è«‹å‡ç®¡ç†', icon: 'ğŸ“' },
            { key: 'lunch', label: 'ä¾¿ç•¶è¨‚è³¼', icon: 'ğŸ±' },
            { key: 'attendance', label: 'è€ƒå‹¤æŸ¥è©¢', icon: 'ğŸ“Š' },
            { key: 'fieldwork', label: 'å¤–å‹¤æ‰“å¡', icon: 'ğŸ“' },
            { key: 'sales_target', label: 'æ¥­å‹™ç›®æ¨™', icon: 'ğŸ¯' },
            { key: 'store_ordering', label: 'ç·šä¸Šé»é¤/é ç´„', icon: 'ğŸ›ï¸' }
        ];

        const FEATURE_PRESETS = {
            general:  { leave: true, lunch: true, attendance: true, fieldwork: true, sales_target: true, store_ordering: false },
            catering: { leave: true, lunch: false, attendance: true, fieldwork: false, sales_target: false, store_ordering: true },
            all:      { leave: true, lunch: true, attendance: true, fieldwork: true, sales_target: true, store_ordering: true }
        };

        function togglePFeatureCard(card) {
            const on = card.dataset.checked === 'true';
            const box = card.querySelector('div');
            if (on) {
                card.dataset.checked = 'false';
                card.style.borderColor = '#E5E7EB'; card.style.background = '#F8FAFC';
                box.style.borderColor = '#CBD5E1'; box.style.background = '#fff'; box.textContent = '';
            } else {
                card.dataset.checked = 'true';
                card.style.borderColor = '#4F46E5'; card.style.background = '#F5F3FF';
                box.style.borderColor = '#4F46E5'; box.style.background = '#4F46E5'; box.textContent = 'âœ“';
            }
        }

        function applyFeaturePreset(name) {
            const preset = FEATURE_PRESETS[name];
            if (!preset) return;
            FEATURE_LIST.forEach(f => {
                const card = document.getElementById('pFt_' + f.key);
                if (!card) return;
                const on = !!preset[f.key];
                card.dataset.checked = String(on);
                const box = card.querySelector('div');
                card.style.borderColor = on ? '#4F46E5' : '#E5E7EB';
                card.style.background = on ? '#F5F3FF' : '#F8FAFC';
                box.style.borderColor = on ? '#4F46E5' : '#CBD5E1';
                box.style.background = on ? '#4F46E5' : '#fff';
                box.textContent = on ? 'âœ“' : '';
            });
            const labels = { general: 'ä¸€èˆ¬å…¬å¸', catering: 'é¤é£²æ¥­', all: 'å…¨éƒ¨é–‹å•Ÿ' };
            showToast('âœ… å·²å¥—ç”¨ã€Œ' + (labels[name] || name) + 'ã€é è¨­');
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'companyMgrPage') loadPCompanyList();
            if (id === 'pendingPage') loadPendingCompanies();
            if (id === 'platformHomePage') loadDashboard();
        }

        // ===== æ¬Šé™é©—è­‰ =====
        async function checkPlatformPermission() {
            const statusEl = document.getElementById('permissionStatus');
            const loadingPage = document.getElementById('loadingPage');
            try {
                const initialized = await initializeLiff();
                if (loadingPage) loadingPage.style.display = 'none';
                if (!initialized) {
                    statusEl.className = 'status-box show error';
                    statusEl.innerHTML = 'âŒ LIFF åˆå§‹åŒ–å¤±æ•—';
                    return;
                }

                const { data, error } = await sb.from('platform_admins')
                    .select('*')
                    .eq('line_user_id', liffProfile.userId)
                    .eq('is_active', true)
                    .maybeSingle();

                if (!data) {
                    statusEl.className = 'status-box show error';
                    statusEl.innerHTML = 'âŒ æ‚¨ä¸æ˜¯å¹³å°ç®¡ç†å“¡<br><small style="opacity:0.7;">LINE ID: ' + escapeHTML(liffProfile?.userId || '') + '</small>';
                    setTimeout(() => { window.location.href = 'index.html'; }, 5000);
                    return;
                }

                currentPlatformAdmin = data;
                document.getElementById('platformName').textContent = data.name;
                if (liffProfile?.pictureUrl) {
                    const avatar = document.getElementById('platformAvatar');
                    avatar.style.backgroundImage = `url(${liffProfile.pictureUrl})`;
                    avatar.style.backgroundSize = 'cover';
                    avatar.textContent = '';
                }

                statusEl.className = 'status-box show success';
                statusEl.textContent = 'âœ… æ¬Šé™é©—è­‰é€šé';
                setTimeout(() => showPage('platformHomePage'), 800);
            } catch(e) {
                if (loadingPage) loadingPage.style.display = 'none';
                statusEl.className = 'status-box show error';
                statusEl.innerHTML = 'âŒ é©—è­‰å¤±æ•—: ' + (typeof friendlyError === 'function' ? friendlyError(e) : e.message);
            }
        }

        // ===== å„€è¡¨æ¿ =====
        async function loadDashboard() {
            try {
                const [compRes, empRes] = await Promise.all([
                    sb.from('companies').select('id, status'),
                    sb.from('employees').select('id').eq('is_active', true)
                ]);
                const companies = compRes.data || [];
                document.getElementById('statCompanies').textContent = companies.filter(c => c.status === 'active').length;
                document.getElementById('statEmployees').textContent = (empRes.data || []).length;
                document.getElementById('statPending').textContent = companies.filter(c => c.status === 'pending').length;
            } catch(e) { console.error(e); }
        }

        // ===== å…¬å¸ç®¡ç† =====
        async function loadPCompanyList() {
            try {
                const { data } = await sb.from('companies').select('*').order('created_at', { ascending: false });
                allPCompanies = data || [];

                // å–å¾—æ¯å®¶å…¬å¸çš„å“¡å·¥æ•¸
                const { data: empCounts } = await sb.from('employees').select('company_id').eq('is_active', true);
                const countMap = {};
                (empCounts || []).forEach(e => { countMap[e.company_id] = (countMap[e.company_id] || 0) + 1; });
                allPCompanies.forEach(c => { c._empCount = countMap[c.id] || 0; });

                renderPCompanyList(allPCompanies);
            } catch(e) { showToast('âŒ è¼‰å…¥å¤±æ•—'); console.error(e); }
        }

        function filterPlatformCompanies() {
            const q = (document.getElementById('pCompanySearch').value || '').toLowerCase();
            renderPCompanyList(allPCompanies.filter(c =>
                c.name.toLowerCase().includes(q) || (c.code || '').toLowerCase().includes(q)
            ));
        }

        function renderPCompanyList(list) {
            const el = document.getElementById('pCompanyList');
            if (list.length === 0) { el.innerHTML = '<p style="text-align:center;color:#94A3B8;">ç„¡å…¬å¸è³‡æ–™</p>'; return; }

            const statusColors = { active: ['#D1FAE5','#065F46','å•Ÿç”¨'], pending: ['#FEF3C7','#92400E','å¾…å¯©æ ¸'], suspended: ['#FEE2E2','#991B1B','æš«åœ'] };
            const planLabels = { basic: 'Basic', pro: 'Pro', enterprise: 'Enterprise' };

            el.innerHTML = list.map(c => {
                const [bg, fg, label] = statusColors[c.status] || statusColors.active;
                const features = c.features || {};
                const activeFeatures = Object.entries(features).filter(([k,v]) => v).map(([k]) => {
                    const f = FEATURE_LIST.find(x => x.key === k);
                    return f ? f.icon : '';
                }).join(' ');

                return `<div style="background:#fff;border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,0.06);">
                    <div style="display:flex;justify-content:space-between;align-items:start;">
                        <div>
                            <div style="font-weight:700;font-size:15px;">${escapeHTML(c.name)}</div>
                            <div style="font-size:12px;color:#64748B;margin-top:2px;">ä»£ç¢¼ï¼š${escapeHTML(c.code)} ï½œ ${planLabels[c.plan_type] || 'Basic'} ï½œ å“¡å·¥ ${c._empCount}/${c.max_employees || 50}</div>
                            <div style="font-size:11px;margin-top:4px;">${activeFeatures || 'ç„¡åŠŸèƒ½'}</div>
                        </div>
                        <span style="font-size:11px;padding:2px 8px;border-radius:20px;background:${bg};color:${fg};white-space:nowrap;">${label}</span>
                    </div>
                    <div style="display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;">
                        <button onclick="editPCompany('${c.id}')" style="padding:6px 12px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:#4F46E5;">âœï¸ ç·¨è¼¯</button>
                        <button onclick="showPCompanyQR('${c.id}')" style="padding:6px 12px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:#059669;">ğŸ“± QR Code</button>
                        ${c.status === 'active' ? `<button onclick="togglePCompanyStatus('${c.id}','suspended')" style="padding:6px 12px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:#DC2626;">â¸ï¸ æš«åœ</button>` : ''}
                        ${c.status === 'suspended' ? `<button onclick="togglePCompanyStatus('${c.id}','active')" style="padding:6px 12px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:#059669;">â–¶ï¸ å•Ÿç”¨</button>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function showPCompanyModal(editData) {
            document.getElementById('pCompanyEditId').value = editData ? editData.id : '';
            document.getElementById('pCompanyModalTitle').textContent = editData ? 'ç·¨è¼¯å…¬å¸' : 'æ–°å¢å…¬å¸';
            document.getElementById('pCompanyCode').value = editData ? editData.code : '';
            document.getElementById('pCompanyName').value = editData ? editData.name : '';
            document.getElementById('pContactName').value = editData?.contact_name || '';
            document.getElementById('pContactPhone').value = editData?.contact_phone || '';
            document.getElementById('pContactEmail').value = editData?.contact_email || '';
            document.getElementById('pPlanType').value = editData?.plan_type || 'basic';
            document.getElementById('pMaxEmployees').value = editData?.max_employees || 50;
            document.getElementById('pStatus').value = editData?.status || 'active';

            // åŠŸèƒ½é–‹é—œ
            const features = editData?.features || { leave: true, lunch: true, attendance: true, fieldwork: true, sales_target: true, store_ordering: false };
            const togglesEl = document.getElementById('pFeatureToggles');
            togglesEl.innerHTML = FEATURE_LIST.map(f => {
                const on = !!features[f.key];
                return `<div id="pFt_${f.key}" data-key="${f.key}" onclick="togglePFeatureCard(this)" data-checked="${on}"
                    style="display:flex;align-items:center;gap:10px;padding:12px 14px;background:${on ? '#F5F3FF' : '#F8FAFC'};border:2px solid ${on ? '#4F46E5' : '#E5E7EB'};border-radius:12px;cursor:pointer;transition:all 0.2s;">
                    <div style="width:24px;height:24px;border:2px solid ${on ? '#4F46E5' : '#CBD5E1'};border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;background:${on ? '#4F46E5' : '#fff'};color:#fff;font-size:14px;transition:all 0.2s;">${on ? 'âœ“' : ''}</div>
                    <span style="font-size:13px;font-weight:600;">${f.icon} ${f.label}</span>
                </div>`;
            }).join('');

            document.getElementById('pCompanyModal').style.display = 'block';
        }

        function closePCompanyModal() { document.getElementById('pCompanyModal').style.display = 'none'; }

        function editPCompany(id) {
            const c = allPCompanies.find(x => x.id === id);
            if (c) showPCompanyModal(c);
        }

        async function savePCompany() {
            const id = document.getElementById('pCompanyEditId').value;
            const code = document.getElementById('pCompanyCode').value.trim().toUpperCase();
            const name = document.getElementById('pCompanyName').value.trim();
            if (!code || !name) { showToast('âš ï¸ è«‹å¡«å¯«ä»£ç¢¼å’Œåç¨±'); return; }

            const features = {};
            FEATURE_LIST.forEach(f => {
                features[f.key] = document.getElementById('pFt_' + f.key)?.dataset.checked === 'true';
            });

            const row = {
                code, name,
                contact_name: document.getElementById('pContactName').value.trim(),
                contact_phone: document.getElementById('pContactPhone').value.trim(),
                contact_email: document.getElementById('pContactEmail').value.trim(),
                plan_type: document.getElementById('pPlanType').value,
                max_employees: parseInt(document.getElementById('pMaxEmployees').value) || 50,
                status: document.getElementById('pStatus').value,
                features
            };

            try {
                if (id) {
                    const { error } = await sb.from('companies').update(row).eq('id', id);
                    if (error) throw error;
                } else {
                    const { error } = await sb.from('companies').insert(row);
                    if (error) throw error;
                }
                closePCompanyModal();
                showToast('âœ… å·²å„²å­˜');
                loadPCompanyList();
            } catch(e) {
                if (String(e?.message || e).includes('unique')) {
                    showToast('âš ï¸ å…¬å¸ä»£ç¢¼å·²å­˜åœ¨');
                } else {
                    showToast('âŒ å„²å­˜å¤±æ•—'); console.error(e);
                }
            }
        }

        async function togglePCompanyStatus(id, newStatus) {
            const labels = { active: 'å•Ÿç”¨', suspended: 'æš«åœ' };
            if (!confirm(`ç¢ºå®šå°‡æ­¤å…¬å¸è¨­ç‚ºã€Œ${labels[newStatus]}ã€ï¼Ÿ`)) return;
            try {
                const { error } = await sb.from('companies').update({ status: newStatus }).eq('id', id);
                if (error) throw error;
                showToast('âœ… å·²æ›´æ–°');
                loadPCompanyList();
            } catch(e) { showToast('âŒ æ›´æ–°å¤±æ•—'); console.error(e); }
        }

        function showPCompanyQR(id) {
            const c = allPCompanies.find(x => x.id === id);
            if (!c) return;
            const url = `https://liff.line.me/${CONFIG.LIFF_ID}?type=bind&company=${encodeURIComponent(c.code)}`;
            const qrDiv = document.getElementById('pQrCode');
            qrDiv.innerHTML = '';
            new QRCode(qrDiv, { text: url, width: 200, height: 200, colorDark: '#1f2937', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.H });
            document.getElementById('pQrUrl').textContent = url;
            document.getElementById('pQrModal').style.display = 'block';
        }

        // ===== å¾…å¯©æ ¸ =====
        async function loadPendingCompanies() {
            try {
                const { data } = await sb.from('companies').select('*').eq('status', 'pending').order('created_at', { ascending: false });
                const el = document.getElementById('pendingList');
                if (!data || data.length === 0) {
                    el.innerHTML = '<p style="text-align:center;color:#94A3B8;padding:30px;">ğŸ‰ ç„¡å¾…å¯©æ ¸å…¬å¸</p>';
                    return;
                }
                el.innerHTML = data.map(c => `
                    <div style="background:#fff;border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,0.06);">
                        <div style="font-weight:700;font-size:15px;">${escapeHTML(c.name)}</div>
                        <div style="font-size:12px;color:#64748B;margin-top:4px;">ä»£ç¢¼ï¼š${escapeHTML(c.code)}</div>
                        <div style="font-size:12px;color:#64748B;">è¯çµ¡ï¼š${escapeHTML(c.contact_name || '-')} ${escapeHTML(c.contact_phone || '')}</div>
                        <div style="font-size:11px;color:#94A3B8;margin-top:4px;">ç”³è«‹æ™‚é–“ï¼š${new Date(c.created_at).toLocaleString('zh-TW')}</div>
                        <div style="display:flex;gap:8px;margin-top:10px;">
                            <button onclick="approvePCompany('${c.id}')" class="btn btn-success" style="flex:1;font-size:13px;">âœ… æ ¸å‡†</button>
                            <button onclick="rejectPCompany('${c.id}')" class="btn btn-secondary" style="flex:1;font-size:13px;">âŒ æ‹’çµ•</button>
                        </div>
                    </div>
                `).join('');
            } catch(e) { showToast('âŒ è¼‰å…¥å¤±æ•—'); console.error(e); }
        }

        async function approvePCompany(id) {
            if (!confirm('ç¢ºå®šæ ¸å‡†æ­¤å…¬å¸ï¼Ÿ')) return;
            try {
                const { error } = await sb.from('companies').update({ status: 'active' }).eq('id', id);
                if (error) throw error;
                showToast('âœ… å·²æ ¸å‡†');
                loadPendingCompanies();
                loadDashboard();
            } catch(e) { showToast('âŒ æ“ä½œå¤±æ•—'); }
        }

        async function rejectPCompany(id) {
            if (!confirm('ç¢ºå®šæ‹’çµ•æ­¤å…¬å¸ç”³è«‹ï¼Ÿï¼ˆå°‡åˆªé™¤æ­¤è¨˜éŒ„ï¼‰')) return;
            try {
                const { error } = await sb.from('companies').delete().eq('id', id);
                if (error) throw error;
                showToast('âœ… å·²æ‹’çµ•');
                loadPendingCompanies();
                loadDashboard();
            } catch(e) { showToast('âŒ æ“ä½œå¤±æ•—'); }
        }

        // ===== è¼‰å…¥ =====
        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') {
                console.error('common.js æœªæ­£ç¢ºè¼‰å…¥');
                return;
            }
            checkPlatformPermission();
        });
    </script>
</body>
</html>
