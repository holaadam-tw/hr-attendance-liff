<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“… ç­è¡¨æŸ¥è©¢ - å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .cal-header h2 { font-size: 18px; font-weight: 800; color: var(--dark); margin: 0; }
        .cal-nav { display: flex; align-items: center; gap: 12px; }
        .cal-nav button { background: none; border: none; font-size: 20px; cursor: pointer; padding: 6px 10px; border-radius: 8px; transition: background 0.2s; }
        .cal-nav button:active { background: var(--gray-light); }
        .cal-nav span { font-size: 16px; font-weight: 700; color: var(--dark); min-width: 120px; text-align: center; }

        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 20px; }
        .cal-weekday { text-align: center; font-size: 12px; font-weight: 700; color: var(--gray); padding: 8px 0; }
        .cal-day {
            text-align: center; padding: 10px 4px; border-radius: 12px; font-size: 14px;
            font-weight: 600; cursor: pointer; transition: all 0.15s; position: relative;
            min-height: 44px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .cal-day:active { transform: scale(0.92); }
        .cal-day.empty { cursor: default; }
        .cal-day.today { background: var(--primary); color: white; font-weight: 800; box-shadow: 0 4px 12px var(--primary-shadow); }
        .cal-day.selected { background: var(--primary-ghost); color: var(--primary); border: 2px solid var(--primary-light); }
        .cal-day.has-shift::after {
            content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%);
            width: 6px; height: 6px; border-radius: 50%;
        }
        .cal-day.shift-DAY::after { background: var(--info); }
        .cal-day.shift-SWING::after { background: var(--warning); }
        .cal-day.shift-NIGHT::after { background: #8B5CF6; }
        .cal-day.shift-OFF { color: var(--gray); opacity: 0.5; }
        .cal-day.other-month { color: #CBD5E1; }

        .shift-list { display: flex; flex-direction: column; gap: 12px; }
        .shift-day-card {
            background: var(--white); border-radius: 14px; padding: 14px 16px;
            box-shadow: var(--shadow-sm);
        }
        .shift-day-label { font-size: 13px; font-weight: 700; color: var(--gray); margin-bottom: 10px; }
        .shift-day-label.today-label { color: var(--primary); }
        .shift-items { display: flex; gap: 10px; flex-wrap: wrap; }
        .shift-chip {
            padding: 10px 16px; border-radius: 12px; font-size: 13px; font-weight: 700;
            display: flex; flex-direction: column; gap: 2px; min-width: 120px;
        }
        .shift-chip.DAY { background: var(--info-bg); color: var(--info-text); }
        .shift-chip.SWING { background: var(--warning-bg); color: var(--warning-text); }
        .shift-chip.NIGHT { background: #EDE9FE; color: #5B21B6; }
        .shift-chip.OFF { background: var(--gray-light); color: var(--gray); }
        .shift-chip.FLEX { background: var(--success-bg); color: var(--success-text); }
        .shift-chip-name { font-size: 15px; font-weight: 800; }
        .shift-chip-time { font-size: 11px; opacity: 0.8; }

        .swap-btn {
            width: 100%; padding: 14px; border-radius: 14px;
            border: 2px dashed var(--primary-light); background: var(--primary-ghost);
            color: var(--primary); font-weight: 700; font-size: 14px;
            cursor: pointer; margin-top: 16px; transition: all 0.2s;
        }
        .swap-btn:active { transform: scale(0.98); background: #E0E7FF; }
    </style>
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <div id="schedulePage" class="page active">
            <div class="card">
                <div class="cal-header">
                    <h2>ğŸ“… ç­è¡¨æŸ¥è©¢</h2>
                </div>

                <!-- æœˆæ›†å°èˆª -->
                <div class="cal-nav" style="justify-content:center; margin-bottom:16px;">
                    <button onclick="changeMonth(-1)">â—€</button>
                    <span id="calMonthLabel">2026å¹´ 2æœˆ</span>
                    <button onclick="changeMonth(1)">â–¶</button>
                </div>

                <!-- æœˆæ›†æ ¼ -->
                <div class="cal-grid" id="calGrid">
                    <div class="cal-weekday">æ—¥</div>
                    <div class="cal-weekday">ä¸€</div>
                    <div class="cal-weekday">äºŒ</div>
                    <div class="cal-weekday">ä¸‰</div>
                    <div class="cal-weekday">å››</div>
                    <div class="cal-weekday">äº”</div>
                    <div class="cal-weekday">å…­</div>
                </div>
            </div>

            <!-- ç•¶é€±/é¸ä¸­æ—¥æœŸçš„ç­åˆ¥ -->
            <div id="shiftListContainer">
                <div class="shift-list" id="shiftList">
                    <p style="text-align:center;color:var(--gray);padding:20px;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <button class="swap-btn" onclick="openSwapModal()">ğŸ”„ ç”³è«‹æ›ç­</button>

            <!-- æ›ç­ç”³è«‹/è¨˜éŒ„ -->
            <div class="card" style="margin-top:16px;padding:14px;">
                <div style="font-size:14px;font-weight:800;color:var(--dark);margin-bottom:10px;">ğŸ”„ æ›ç­ç”³è«‹</div>
                <div id="swapList"><p style="text-align:center;color:var(--gray);font-size:12px;">è¼‰å…¥ä¸­...</p></div>
            </div>

            <!-- ç­åˆ¥èªªæ˜ -->
            <div class="card" style="padding:14px; margin-top:16px;">
                <div style="font-size:12px; font-weight:700; color:var(--dark); margin-bottom:10px;">ç­åˆ¥èªªæ˜</div>
                <div style="display:flex; flex-wrap:wrap; gap:10px;">
                    <span style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--gray);">
                        <span style="width:12px;height:12px;border-radius:4px;background:var(--info-bg);border:1px solid var(--info);"></span> æ—©ç­
                    </span>
                    <span style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--gray);">
                        <span style="width:12px;height:12px;border-radius:4px;background:var(--warning-bg);border:1px solid var(--warning);"></span> ä¸­ç­
                    </span>
                    <span style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--gray);">
                        <span style="width:12px;height:12px;border-radius:4px;background:#EDE9FE;border:1px solid #8B5CF6;"></span> æ™šç­
                    </span>
                    <span style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--gray);">
                        <span style="width:12px;height:12px;border-radius:4px;background:var(--gray-light);border:1px solid var(--gray);"></span> ä¼‘
                    </span>
                </div>
            </div>
        </div>
        <!-- æ›ç­ Modal -->
        <div id="swapModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center;padding:20px;">
            <div style="background:#fff;border-radius:20px;max-width:360px;width:100%;padding:24px;">
                <h3 style="text-align:center;font-size:16px;font-weight:800;margin-bottom:16px;">ğŸ”„ æ›ç­ç”³è«‹</h3>
                <div class="form-group" style="margin-bottom:12px;">
                    <label style="font-size:13px;font-weight:700;">æ›ç­æ—¥æœŸ</label>
                    <input type="date" id="swapDate" style="width:100%;padding:10px;border:1px solid #E5E7EB;border-radius:10px;">
                </div>
                <div class="form-group" style="margin-bottom:12px;">
                    <label style="font-size:13px;font-weight:700;">è¦è·Ÿèª°æ›ï¼Ÿ</label>
                    <select id="swapTarget" style="width:100%;padding:10px;border:1px solid #E5E7EB;border-radius:10px;font-size:14px;">
                        <option value="">è¼‰å…¥ä¸­...</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom:16px;">
                    <label style="font-size:13px;font-weight:700;">åŸå› </label>
                    <input type="text" id="swapReason" placeholder="å¦‚ï¼šå®¶ä¸­æœ‰äº‹" style="width:100%;padding:10px;border:1px solid #E5E7EB;border-radius:10px;">
                </div>
                <div style="display:flex;gap:8px;">
                    <button onclick="closeSwapModal()" style="flex:1;padding:12px;border:2px solid #E5E7EB;border-radius:12px;background:#fff;font-weight:700;cursor:pointer;">å–æ¶ˆ</button>
                    <button onclick="submitSwapRequest()" style="flex:1;padding:12px;border:none;border-radius:12px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer;">ğŸ“¤ é€å‡º</button>
                </div>
            </div>
        </div>
    </div>



    <script src="common.js"></script>
    <script>
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); // 0-indexed
        let scheduleData = {}; // { '2026-02-10': { shift: 'DAY', name: 'æ—©ç­', time: '08:00-17:00' } }
        let selectedDate = null;

        // Demo data (will be replaced by Supabase query when shift_types/schedules tables exist)
        function generateDemoSchedule(year, month) {
            const data = {};
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const shifts = [
                { code: 'DAY', name: 'æ—©ç­', time: '08:00 - 17:00' },
                { code: 'DAY', name: 'æ—©ç­', time: '08:00 - 17:00' },
                { code: 'SWING', name: 'æ™šç­', time: '13:00 - 22:00' },
                { code: 'SWING', name: 'æ™šç­', time: '13:00 - 22:00' },
                { code: 'NIGHT', name: 'å¤œç­', time: '22:00 - 07:00' },
                { code: 'OFF', name: 'ä¼‘æ¯', time: 'ä¼‘æ¯æ—¥' },
                { code: 'OFF', name: 'ä¼‘æ¯', time: 'ä¼‘æ¯æ—¥' },
            ];

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const shift = shifts[(d - 1) % 7];
                data[dateStr] = shift;
            }
            return data;
        }

        let isFixedDayShift = false;

        // Load schedule from Supabase (fallback to demo)
        async function loadSchedule() {
            // å…ˆæª¢æŸ¥æ’ç­æ¨¡å¼
            try {
                if (typeof sb !== 'undefined') {
                    const { data: modeData } = await sb.from('system_settings').select('value').eq('key', 'scheduling_mode').maybeSingle();
                    if (modeData?.value?.mode === 'fixed') {
                        isFixedDayShift = true;
                        const fStart = modeData.value.start || '08:00';
                        const fEnd = modeData.value.end || '17:00';
                        applyFixedDayShiftUI(fStart, fEnd);
                        return;
                    }
                }
            } catch(e) {}

            isFixedDayShift = false;
            restoreShiftUI();

            try {
                if (typeof sb !== 'undefined' && currentEmployee) {
                    const { data, error } = await sb.rpc('get_employee_schedule', {
                        p_line_user_id: liffProfile.userId,
                        p_year: currentYear,
                        p_month: currentMonth + 1
                    });

                    if (!error && data && data.length > 0) {
                        scheduleData = {};
                        data.forEach(item => {
                            scheduleData[item.date] = {
                                code: item.shift_code || 'DAY',
                                name: item.shift_name || 'æ—©ç­',
                                time: item.is_off_day ? 'ä¼‘æ¯æ—¥' : `${item.start_time?.substr(0,5) || '08:00'} - ${item.end_time?.substr(0,5) || '17:00'}`
                            };
                        });
                        renderCalendar();
                        renderShiftList();
                        return;
                    }
                }
            } catch (e) {
                console.log('ä½¿ç”¨ç¤ºç¯„ç­è¡¨:', e.message);
            }

            // Fallback to demo
            scheduleData = generateDemoSchedule(currentYear, currentMonth);
            renderCalendar();
            renderShiftList();
        }

        function applyFixedDayShiftUI(startTime, endTime) {
            startTime = startTime || '08:00'; endTime = endTime || '17:00';
            const shiftName = startTime < '12:00' ? 'å›ºå®šæ—©ç­' : startTime < '18:00' ? 'å›ºå®šä¸­ç­' : 'å›ºå®šæ™šç­';
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            scheduleData = {};
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dow = new Date(currentYear, currentMonth, d).getDay();
                if (dow === 0 || dow === 6) {
                    scheduleData[dateStr] = { code: 'OFF', name: 'ä¼‘æ¯', time: 'ä¼‘æ¯æ—¥' };
                } else {
                    scheduleData[dateStr] = { code: 'DAY', name: shiftName, time: startTime + ' - ' + endTime };
                }
            }
            renderCalendar();
            renderShiftList();
            // éš±è—æ›ç­æŒ‰éˆ•å’Œæ›ç­å€å¡Š
            const swapBtn = document.querySelector('.swap-btn');
            if (swapBtn) swapBtn.style.display = 'none';
            const swapCard = document.getElementById('swapList')?.closest('.card');
            if (swapCard) swapCard.style.display = 'none';
        }

        function restoreShiftUI() {
            const swapBtn = document.querySelector('.swap-btn');
            if (swapBtn) swapBtn.style.display = '';
            const swapCard = document.getElementById('swapList')?.closest('.card');
            if (swapCard) swapCard.style.display = '';
        }

        function renderCalendar() {
            const grid = document.getElementById('calGrid');
            // Clear old days but keep weekday headers
            const weekdays = grid.querySelectorAll('.cal-weekday');
            grid.innerHTML = '';
            weekdays.forEach(w => grid.appendChild(w));

            const label = document.getElementById('calMonthLabel');
            label.textContent = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            // Previous month padding
            const prevDays = new Date(currentYear, currentMonth, 0).getDate();
            for (let i = firstDay - 1; i >= 0; i--) {
                const el = document.createElement('div');
                el.className = 'cal-day empty other-month';
                el.textContent = prevDays - i;
                grid.appendChild(el);
            }

            // Current month
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const shift = scheduleData[dateStr];
                const el = document.createElement('div');

                let classes = 'cal-day';
                if (dateStr === todayStr) classes += ' today';
                if (dateStr === selectedDate) classes += ' selected';
                if (shift) {
                    classes += ` has-shift shift-${shift.code}`;
                }
                el.className = classes;
                el.textContent = d;
                el.onclick = () => selectDate(dateStr);
                grid.appendChild(el);
            }

            // Next month padding
            const totalCells = grid.children.length;
            const remaining = (7 - (totalCells % 7)) % 7;
            for (let i = 1; i <= remaining; i++) {
                const el = document.createElement('div');
                el.className = 'cal-day empty other-month';
                el.textContent = i;
                grid.appendChild(el);
            }
        }

        function selectDate(dateStr) {
            selectedDate = dateStr;
            renderCalendar();
            renderShiftList();
        }

        function renderShiftList() {
            const list = document.getElementById('shiftList');
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            // Show upcoming 7 days from selected date or today
            const startDate = selectedDate ? new Date(selectedDate) : new Date(currentYear, currentMonth, today.getMonth() === currentMonth ? today.getDate() : 1);
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            let html = '';

            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(d.getDate() + i);
                const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                const shift = scheduleData[dateStr];
                if (!shift) continue;

                const isToday = dateStr === todayStr;
                const dateLabel = `${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')} é€±${days[d.getDay()]}`;

                html += `
                    <div class="shift-day-card" ${isToday ? 'style="border-left:4px solid var(--primary);"' : ''}>
                        <div class="shift-day-label ${isToday ? 'today-label' : ''}">${dateLabel}${isToday ? ' ï¼š' : 'ï¼š'}</div>
                        <div class="shift-items">
                            <div class="shift-chip ${shift.code}">
                                <span class="shift-chip-name">${shift.name}</span>
                                <span class="shift-chip-time">${shift.time}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            list.innerHTML = html || '<p style="text-align:center;color:var(--gray);padding:20px;">æ­¤æœŸé–“ç„¡æ’ç­è³‡æ–™</p>';
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            selectedDate = null;
            loadSchedule();
        }

        // ===== æ›ç­åŠŸèƒ½ =====
        async function openSwapModal() {
            if (!currentEmployee) return showToast('âŒ è«‹å…ˆç™»å…¥');
            const modal = document.getElementById('swapModal');
            modal.style.display = 'flex';
            // é è¨­é¸ä¸­æ—¥æœŸæˆ–æ˜å¤©
            const dateEl = document.getElementById('swapDate');
            if (selectedDate) dateEl.value = selectedDate;
            else { const t = new Date(); t.setDate(t.getDate()+1); dateEl.value = fmtDate(t); }
            // è¼‰å…¥åŒäº‹åˆ—è¡¨
            try {
                const { data } = await sb.from('employees')
                    .select('id, name, department').eq('is_active', true).neq('id', currentEmployee.id).order('name');
                const sel = document.getElementById('swapTarget');
                sel.innerHTML = '<option value="">-- è«‹é¸æ“‡åŒäº‹ --</option>';
                (data||[]).forEach(e => { sel.innerHTML += `<option value="${e.id}">${e.name}ï¼ˆ${e.department||''}ï¼‰</option>`; });
            } catch(e) { showToast('âŒ è¼‰å…¥åŒäº‹å¤±æ•—'); }
        }
        function closeSwapModal() { document.getElementById('swapModal').style.display = 'none'; }

        async function submitSwapRequest() {
            const date = document.getElementById('swapDate')?.value;
            const targetId = document.getElementById('swapTarget')?.value;
            const reason = document.getElementById('swapReason')?.value;
            if (!date || !targetId) return showToast('âŒ è«‹é¸æ“‡æ—¥æœŸå’ŒåŒäº‹');
            
            try {
                // æŸ¥é›™æ–¹ç•¶æ—¥ç­åˆ¥
                const myShift = scheduleData[date]?.name || 'æœªæ’';
                const { data: targetSched } = await sb.from('schedules')
                    .select('shift_types(name)').eq('employee_id', targetId).eq('date', date).maybeSingle();
                const targetShift = targetSched?.shift_types?.name || 'æœªæ’';
                
                const { error } = await sb.from('shift_swap_requests').insert({
                    requester_id: currentEmployee.id,
                    target_id: targetId,
                    swap_date: date,
                    requester_original_shift: myShift,
                    target_original_shift: targetShift,
                    reason: reason || '',
                    status: 'pending_target'
                });
                if (error) throw error;
                
                showToast('âœ… æ›ç­ç”³è«‹å·²é€å‡ºï¼Œç­‰å¾…å°æ–¹ç¢ºèª');
                closeSwapModal();
                loadSwapRequests();
                
                // é€šçŸ¥å°æ–¹
                sendUserNotify(targetId, `ğŸ”„ ${currentEmployee.name} æƒ³è·Ÿæ‚¨æ› ${date} çš„ç­\næ‚¨çš„ç­ï¼š${targetShift} â†’ ${myShift}\nè«‹åˆ°ç­è¡¨é é¢ç¢ºèª`);
            } catch(e) { showToast('âŒ ç”³è«‹å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        async function loadSwapRequests() {
            const el = document.getElementById('swapList');
            if (!el || !currentEmployee) return;
            try {
                const { data } = await sb.from('shift_swap_requests')
                    .select('*, requester:employees!shift_swap_requests_requester_id_fkey(name), target:employees!shift_swap_requests_target_id_fkey(name)')
                    .or(`requester_id.eq.${currentEmployee.id},target_id.eq.${currentEmployee.id}`)
                    .order('created_at', { ascending: false }).limit(10);
                
                if (!data || data.length === 0) { el.innerHTML = '<p style="text-align:center;color:#999;font-size:12px;">å°šç„¡æ›ç­è¨˜éŒ„</p>'; return; }
                
                const statusMap = { pending_target:'â³ ç­‰å°æ–¹', pending_admin:'â³ ç­‰ä¸»ç®¡', approved:'âœ… é€šé', rejected:'âŒ æ‹’çµ•', cancelled:'ğŸš« å–æ¶ˆ' };
                const statusColor = { pending_target:'#F59E0B', pending_admin:'#3B82F6', approved:'#059669', rejected:'#DC2626', cancelled:'#94A3B8' };
                
                el.innerHTML = data.map(r => {
                    const isTarget = r.target_id === currentEmployee.id;
                    const otherName = isTarget ? r.requester?.name : r.target?.name;
                    const showAgree = isTarget && r.status === 'pending_target';
                    
                    return `
                    <div style="padding:10px 0;border-bottom:1px solid #F1F5F9;font-size:13px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <span>ğŸ“… ${r.swap_date} Â· ğŸ”„ ${otherName || '?'}</span>
                            <span style="font-size:11px;padding:3px 8px;border-radius:6px;background:${statusColor[r.status]||'#eee'}20;color:${statusColor[r.status]||'#666'};font-weight:700;">${statusMap[r.status]||r.status}</span>
                        </div>
                        <div style="font-size:11px;color:#64748B;margin-top:3px;">${r.requester_original_shift||''} â†” ${r.target_original_shift||''}${r.reason ? ' Â· '+r.reason : ''}</div>
                        ${showAgree ? `
                            <div style="display:flex;gap:6px;margin-top:8px;">
                                <button onclick="agreeSwap('${r.id}')" style="flex:1;padding:8px;border:none;border-radius:8px;background:#ECFDF5;color:#059669;font-weight:700;font-size:12px;cursor:pointer;">âœ… åŒæ„æ›ç­</button>
                                <button onclick="declineSwap('${r.id}')" style="flex:1;padding:8px;border:none;border-radius:8px;background:#FEF2F2;color:#DC2626;font-weight:700;font-size:12px;cursor:pointer;">âŒ æ‹’çµ•</button>
                            </div>
                        ` : ''}
                    </div>`;
                }).join('');
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#ef4444;font-size:12px;">è¼‰å…¥å¤±æ•—</p>'; }
        }

        async function agreeSwap(id) {
            if (!confirm('ç¢ºå®šåŒæ„æ›ç­ï¼Ÿ')) return;
            try {
                await sb.from('shift_swap_requests').update({ target_agreed: true, status: 'pending_admin' }).eq('id', id);
                showToast('âœ… å·²åŒæ„ï¼Œç­‰å¾…ä¸»ç®¡å¯©æ ¸');
                loadSwapRequests();
                sendAdminNotify('ğŸ”„ æ›ç­ç”³è«‹ï¼šé›™æ–¹å·²åŒæ„ï¼Œè«‹å¯©æ ¸');
            } catch(e) { showToast('âŒ æ“ä½œå¤±æ•—'); }
        }

        async function declineSwap(id) {
            try {
                await sb.from('shift_swap_requests').update({ target_agreed: false, status: 'rejected', rejection_reason: 'å°æ–¹ä¸åŒæ„' }).eq('id', id);
                showToast('âŒ å·²æ‹’çµ•');
                loadSwapRequests();
            } catch(e) { showToast('âŒ æ“ä½œå¤±æ•—'); }
        }

        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') {
                // No common.js, show demo
                loadSchedule();
                return;
            }

            const initialized = await initializeLiff();
            if (initialized) {
                const isLoggedIn = await checkUserStatus();
                if (isLoggedIn) {
                    document.getElementById('loadingPage').style.display = 'none';
                    initBottomNav();
                    loadSchedule();
                    loadSwapRequests();
                } else {
                    window.location.href = 'index.html';
                }
            } else {
                document.getElementById('loadingPage').style.display = 'none';
                loadSchedule();
            }
        });
    </script>
</body>
</html>
