<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>👑 管理後台 - 員工服務中心</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        #lcTable th, #lcTable td, #smTable th, #smTable td { border: 1px solid #F1F5F9; }
        #smTable td:hover { filter: brightness(0.92); }
        #lcTable th, #smTable th { position: sticky; top: 0; background: #fff; z-index: 1; }
    </style>
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>系統載入中...</p>
    </div>

    <div class="container">
        <!-- 權限檢查頁面 -->
        <div id="permissionPage" class="page active">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">🔐</span>
                    <h2>管理員權限檢查</h2>
                    <p>正在驗證您的管理員身份...</p>
                </div>
                <div id="permissionStatus" class="status-box show info">
                    檢查權限中...
                </div>
            </div>
        </div>

        <!-- 管理後台首頁 -->
        <div id="adminHomePage" class="page">
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="adminAvatar">👑</div>
                    <div class="user-details">
                        <h2 id="adminName">管理員</h2>
                        <p id="adminDept">系統管理</p>
                        <p id="adminId" style="font-size: 11px; opacity: 0.7;">ID: -</p>
                    </div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" data-require="admin" onclick="showPage('bonusPage')">
                    <div class="icon">🎁</div><div class="label">年終獎金試算</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('payrollPage')">
                    <div class="icon">💰</div><div class="label">薪資發放</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('locationPage')">
                    <div class="icon">📍</div><div class="label">地點管理</div>
                </div>
                <div class="menu-item" onclick="showPage('employeePage')">
                    <div class="icon">👥</div><div class="label">員工管理</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('leaveApprovalPage')">
                    <div class="icon">✅</div><div class="label">請假審核</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('makeupApprovalPage')">
                    <div class="icon">🔧</div><div class="label">補打卡審核</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('overtimeApprovalPage')">
                    <div class="icon">⏰</div><div class="label">加班審核</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('swapApprovalPage')">
                    <div class="icon">🔄</div><div class="label">換班審核</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('announcementPage')">
                    <div class="icon">📢</div><div class="label">公告管理</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('reportPage')">
                    <div class="icon">📊</div><div class="label">報表匯出</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('staffMgrPage')">
                    <div class="icon">📋</div><div class="label">人力管理</div>
                </div>
                <div class="menu-item" onclick="showPage('lunchMgrPage')">
                    <div class="icon">🍱</div><div class="label">便當管理</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('clientPage')">
                    <div class="icon">🏢</div><div class="label">客戶管理</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('fieldWorkApprovalPage')">
                    <div class="icon">📍</div><div class="label">外勤審核</div>
                </div>
                <div class="menu-item" data-require="admin" data-feature="sales_target" onclick="showPage('salesTargetPage')">
                    <div class="icon">🎯</div><div class="label">業務目標</div>
                </div>
                <div class="menu-item" data-require="admin" data-feature="store_ordering" onclick="showPage('storeManagePage')">
                    <div class="icon">🍽️</div><div class="label">商店管理</div>
                </div>
                <div class="menu-item" data-require="admin" data-feature="store_ordering" onclick="showPage('orderManagePage')">
                    <div class="icon">📦</div><div class="label">訂單管理</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('insurancePage')">
                    <div class="icon">🏥</div><div class="label">勞健保級距</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('companyPage')">
                    <div class="icon">🏛️</div><div class="label">公司管理</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('featurePage')">
                    <div class="icon">🎛️</div><div class="label">功能管理</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('auditLogPage')">
                    <div class="icon">📜</div><div class="label">操作日誌</div>
                </div>
                <div class="menu-item" onclick="window.location.href='index.html'">
                    <div class="icon">🏠</div><div class="label">返回首頁</div>
                </div>
            </div>
        </div>

        <!-- 年終獎金試算頁面 (混合精算) -->
        <div id="bonusPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>🎁 年終獎金試算</h2>
                <div class="form-group">
                    <label>試算年度</label>
                    <select id="bonusYear" onchange="loadHybridBonusData()"></select>
                </div>

                <div id="bonusLoading" style="text-align:center;color:#666;padding:30px;display:none;">⏳ 載入中...</div>

                <div class="lunch-summary" id="bonusSummary" style="display:none;">
                    <h3 style="margin-bottom:15px;">📈 試算摘要</h3>
                    <div class="stat-row"><span>符合資格人數</span><span id="eligibleCount">0</span></div>
                    <div class="stat-row"><span>總預算</span><span id="totalBudget">$0</span></div>
                    <div class="stat-row"><span>平均獎金</span><span id="avgBonus">$0</span></div>
                </div>

                <div id="matrixRef" style="display:none;">
                    <div onclick="toggleMatrixRef()" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#F5F3FF;border-radius:12px;margin-bottom:10px;">
                        <span style="font-weight:700;font-size:13px;color:#4F46E5;">📊 獎金矩陣參考表</span>
                        <span id="matrixRefArrow" style="font-size:12px;color:#4F46E5;">▼</span>
                    </div>
                    <div id="matrixRefBody" style="display:none;overflow-x:auto;margin-bottom:16px;"></div>
                </div>

                <div class="form-group" id="bonusEmpSelect" style="display:none;">
                    <label>選擇員工</label>
                    <select id="bonusEmpDropdown" onchange="renderSelectedBonusCard()">
                        <option value="_all">📋 全部員工總覽</option>
                    </select>
                </div>

                <div id="bonusList" style="margin-top:10px;"></div>

                <div id="bonusActions" style="display:none;margin-top:20px;">
                    <button class="btn btn-success" onclick="saveAllBonuses()" id="saveAllBonusBtn">💾 儲存全部獎金</button>
                    <button class="btn btn-secondary" onclick="exportBonusCSV()" style="margin-top:8px;">📊 匯出 CSV</button>
                </div>
            </div>
        </div>

        <!-- 地點管理頁面 -->
        <div id="locationPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>📍 地點管理</h2>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:10px;">📍 目前打卡地點</h3>
                    <!-- [BUG FIX] 使用與 common.js 一致的 ID -->
                    <div id="locationList">
                        <p style="color:#666;text-align:center;">載入中...</p>
                    </div>
                </div>

                <div style="margin-top: 20px; background:#fff; border-radius:16px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                    <h3 style="margin-bottom:15px;">➕ 新增地點</h3>
                    <div class="form-group">
                        <label>地點名稱</label>
                        <!-- [BUG FIX] 使用與 common.js 一致的 ID -->
                        <input type="text" id="newLocName" placeholder="例如：台北分店">
                    </div>
                    <div class="form-group">
                        <label>打卡半徑 (公尺)</label>
                        <input type="number" id="newLocRadius" value="300">
                    </div>
                    <div class="form-group">
                        <label>座標 (緯度, 經度)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="newLocLat" placeholder="緯度" readonly>
                            <input type="text" id="newLocLng" placeholder="經度" readonly>
                        </div>
                        <button class="btn btn-primary" onclick="getCurrentGPSForSetting()" style="margin-top:10px; font-size:14px; padding:10px;">
                            📍 抓取目前位置
                        </button>
                    </div>
                    <button class="btn btn-success" onclick="addNewLocation()">💾 儲存新地點</button>
                </div>
            </div>
        </div>

        <!-- 員工管理頁面 -->
        <div id="employeePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h2 style="margin:0;">👥 員工管理</h2>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-success" onclick="showAddEmployeeModal()" style="font-size:13px; padding:8px 14px; width:auto; margin:0;">
                            ➕ 新增
                        </button>
                        <button class="btn btn-primary" onclick="showJoinQRCode()" style="font-size:13px; padding:8px 14px; width:auto; margin:0;">
                            📱 QR Code
                        </button>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom:15px;">
                    <input type="text" id="employeeSearch" placeholder="🔍 搜尋姓名或工號" onkeyup="searchEmployees()">
                </div>
                <div id="employeeList">
                    <p style="text-align:center;color:#666;">載入中...</p>
                </div>
            </div>
        </div>

        <!-- 新增員工 Modal -->
        <div id="addEmployeeModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>➕ 新增員工</h3>
                    <button class="modal-close" onclick="closeAddEmployeeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addEmployeeForm">
                        <div class="form-group">
                            <label>姓名 *</label>
                            <input type="text" id="newEmployeeName" required placeholder="請輸入員工姓名">
                        </div>
                        <div class="form-group">
                            <label>工號 *</label>
                            <input type="text" id="newEmployeeNumber" required placeholder="例如：E001">
                        </div>
                        <div class="form-group">
                            <label>部門</label>
                            <select id="newEmployeeDepartment">
                                <option value="管理部">管理部</option>
                                <option value="業務部">業務部</option>
                                <option value="技術部">技術部</option>
                                <option value="人事部">人事部</option>
                                <option value="財務部">財務部</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>職位</label>
                            <input type="text" id="newEmployeePosition" placeholder="例如：專員">
                        </div>
                        <div class="form-group">
                            <label>驗證碼 *</label>
                            <input type="text" id="newEmployeeCode" required placeholder="身分證後4碼或自訂驗證碼">
                            <small style="color:#666; font-size:12px; display:block; margin-top:5px;">
                                💡 建議使用身分證後4碼，員工綁定時需要輸入此驗證碼
                            </small>
                        </div>
                        <div class="form-group">
                            <label>到職日期</label>
                            <input type="date" id="newEmployeeHireDate">
                        </div>
                        <div class="form-group">
                            <label>僱用類型</label>
                            <select id="newEmployeeType">
                                <option value="fulltime">正職</option>
                                <option value="parttime">兼職</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>角色權限</label>
                            <select id="newEmployeeRole">
                                <option value="user">一般員工</option>
                                <option value="manager">主管</option>
                                <option value="admin">管理員</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button type="submit" class="btn btn-success" style="flex:1;">💾 儲存員工</button>
                            <button type="button" class="btn btn-secondary" onclick="closeAddEmployeeModal()" style="flex:1;">取消</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div id="qrModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>📱 員工加入 QR Code</h3>
                    <button class="modal-close" onclick="closeQRModal()">&times;</button>
                </div>
                <div class="modal-body" style="text-align:center;">
                    <div id="qrcode" style="margin:20px auto; display:inline-block;"></div>
                    <div style="margin-top:20px; padding:15px; background:#f3f4f6; border-radius:12px;">
                        <p style="margin:0; font-size:14px; color:#666;">公司代碼</p>
                        <p style="margin:5px 0; font-size:18px; font-weight:bold; color:#1f2937;">HR_SYSTEM_001</p>
                        <p style="margin:5px 0; font-size:12px; color:#9ca3af;">無法掃碼時請手動輸入此代碼</p>
                    </div>
                    <div style="margin-top:15px; padding:12px; background:#fef3c7; border-radius:8px; border-left:4px solid #f59e0b; text-align:left;">
                        <p style="margin:0; font-size:13px; color:#92400e;">
                            <strong>使用說明：</strong><br>
                            1. 員工掃描此 QR Code<br>
                            2. 輸入工號和驗證碼<br>
                            3. 完成綁定即可使用系統
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 薪資設定 Modal -->
        <div id="salarySettingModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>💰 薪資設定</h3>
                    <button class="modal-close" onclick="closeSalarySettingModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="salarySettingEmpName" style="font-size:15px;font-weight:800;color:#0F172A;margin-bottom:16px;text-align:center;"></div>
                    <div class="form-group">
                        <label>計薪方式</label>
                        <select id="ssSalaryType" onchange="onSalaryTypeChange()">
                            <option value="monthly">月薪制</option>
                            <option value="daily">日薪制</option>
                            <option value="hourly">時薪制</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="ssBaseLabel">基本月薪</label>
                        <input type="text" inputmode="numeric" id="ssBaseSalary" placeholder="例如：35,000">
                    </div>
                    <div class="form-group">
                        <label>伙食津貼（月）</label>
                        <input type="text" inputmode="numeric" id="ssMealAllowance" placeholder="例如：2,400" value="0">
                    </div>
                    <div class="form-group">
                        <label>職務加給（月）</label>
                        <input type="text" inputmode="numeric" id="ssPositionAllowance" placeholder="例如：5,000" value="0">
                    </div>
                    <div class="form-group">
                        <label>全勤獎金</label>
                        <input type="text" inputmode="numeric" id="ssFullAttBonus" placeholder="例如：2,000" value="0">
                    </div>
                    <div class="form-group">
                        <label>勞退自提 %</label>
                        <input type="number" id="ssPensionRate" min="0" max="6" placeholder="0~6" value="0">
                    </div>
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="saveSalarySetting()" class="btn btn-success" style="flex:1;">💾 儲存薪資</button>
                        <button onclick="closeSalarySettingModal()" class="btn btn-secondary" style="flex:1;">取消</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 編輯員工 Modal -->
        <div id="editEmployeeModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>✏️ 編輯員工</h3>
                    <button class="modal-close" onclick="closeEditEmployeeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editEmpId">
                    <div class="form-group">
                        <label>姓名</label>
                        <input type="text" id="editEmpName">
                    </div>
                    <div class="form-group">
                        <label>部門</label>
                        <select id="editEmpDept">
                            <option value="管理部">管理部</option>
                            <option value="業務部">業務部</option>
                            <option value="技術部">技術部</option>
                            <option value="人事部">人事部</option>
                            <option value="財務部">財務部</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>職位</label>
                        <input type="text" id="editEmpPosition" placeholder="例如：專員">
                    </div>
                    <div class="form-group">
                        <label>到職日期</label>
                        <input type="date" id="editEmpHireDate">
                    </div>
                    <div class="form-group">
                        <label>僱用類型</label>
                        <select id="editEmpType">
                            <option value="fulltime">正職</option>
                            <option value="parttime">兼職</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="saveEditEmployee()" class="btn btn-success" style="flex:1;">💾 儲存</button>
                        <button onclick="closeEditEmployeeModal()" class="btn btn-secondary" style="flex:1;">取消</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 請假審核頁面 -->
        <div id="leaveApprovalPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>✅ 請假審核</h2>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchLeaveTab('pending')">待審核</button>
                    <button class="tab-btn inactive" onclick="switchLeaveTab('approved')">已通過</button>
                    <button class="tab-btn inactive" onclick="switchLeaveTab('rejected')">已拒絕</button>
                </div>
                <div id="leaveApprovalList">
                    <p style="text-align:center;color:#666;">載入中...</p>
                </div>
            </div>
        </div>

        <!-- ====== 補打卡審核 ====== -->
        <div id="makeupApprovalPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>🔧 補打卡審核</h2>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchMakeupTab('pending')">待審核</button>
                    <button class="tab-btn inactive" onclick="switchMakeupTab('approved')">已通過</button>
                    <button class="tab-btn inactive" onclick="switchMakeupTab('rejected')">已拒絕</button>
                </div>
                <div id="makeupApprovalList"><p style="text-align:center;color:#666;">載入中...</p></div>
            </div>
        </div>

        <!-- ====== 公告管理 ====== -->
        <div id="announcementPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>📢 公告管理</h2>
                <p style="color:#94A3B8;font-size:12px;margin-bottom:16px;">發布的公告會顯示在員工首頁上方</p>

                <!-- 新增公告表單 -->
                <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:16px;">
                    <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">➕ 發布新公告</div>
                    <div class="form-group">
                        <label>類型</label>
                        <select id="annType">
                            <option value="info">📢 一般通知</option>
                            <option value="warning">⚠️ 注意事項</option>
                            <option value="urgent">🚨 緊急通知</option>
                            <option value="event">🎉 活動公告</option>
                        </select>
                    </div>
                    <div class="form-group"><label>標題</label><input type="text" id="annTitle" placeholder="例：下週一停電通知"></div>
                    <div class="form-group"><label>內容 (選填)</label><textarea id="annContent" placeholder="公告詳細內容..."></textarea></div>
                    <div class="form-group">
                        <label>到期日 (選填，留空永久顯示)</label>
                        <input type="date" id="annExpire">
                    </div>
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="annPinned"> 📌 置頂</label>
                    </div>
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="annRequireAck"> ✍️ 強制閱讀簽署（員工必須確認才能使用系統）</label>
                    </div>
                    <button class="btn btn-primary" onclick="publishAnnouncement()">📤 發布公告</button>
                </div>

                <!-- 現有公告列表 -->
                <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">📋 現有公告</div>
                <div id="announcementList"><p style="text-align:center;color:#999;">載入中...</p></div>
            </div>
        </div>

        <!-- ====== 加班審核 ====== -->
        <div id="overtimeApprovalPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>⏰ 加班審核</h2>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchOtTab('pending')">待審核</button>
                    <button class="tab-btn inactive" onclick="switchOtTab('approved')">已通過</button>
                    <button class="tab-btn inactive" onclick="switchOtTab('rejected')">已拒絕</button>
                </div>
                <div id="otApprovalList"><p style="text-align:center;color:#666;">載入中...</p></div>
            </div>
        </div>

        <!-- ====== 換班審核 ====== -->
        <div id="swapApprovalPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>🔄 換班審核</h2>
                <p style="color:#94A3B8;font-size:12px;margin-bottom:12px;">雙方同意後才會出現在此列表</p>
                <div id="swapApprovalList"><p style="text-align:center;color:#666;">載入中...</p></div>
            </div>
        </div>

        <!-- ====== 操作日誌 ====== -->
        <div id="auditLogPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>📜 操作日誌</h2>
                <p style="color:#94A3B8;font-size:12px;margin-bottom:12px;">系統自動記錄所有管理操作</p>
                <div id="auditLogList"><p style="text-align:center;color:#666;">載入中...</p></div>
                <button class="btn btn-secondary" id="loadMoreAudit" onclick="loadAuditLogs(true)" style="margin-top:12px;">載入更多...</button>
            </div>
        </div>

        <!-- 便當管理頁面 -->
        <div id="lunchMgrPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>🍱 便當管理</h2>

                <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-bottom:16px;">
                    <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:8px;">👩‍💼 便當管理員</div>
                    <p style="font-size:12px;color:#94A3B8;margin-bottom:12px;">指定可查看便當訂購明細報表的員工（例如會計），該員工進入便當訂購頁面時會看到完整訂購明細和 CSV 匯出功能。</p>
                    <div style="display:flex;gap:8px;margin-bottom:12px;">
                        <select id="lunchMgrSelect" style="flex:1;padding:10px;border:1px solid #E5E7EB;border-radius:10px;font-size:13px;">
                            <option value="">-- 選擇員工 --</option>
                        </select>
                        <button onclick="addLunchManager()" style="padding:10px 16px;border:none;border-radius:10px;background:#4F46E5;color:#fff;font-weight:700;font-size:13px;cursor:pointer;white-space:nowrap;">+ 新增</button>
                    </div>
                    <div id="lunchMgrList" style="font-size:13px;color:#64748B;">載入中...</div>
                </div>

                <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-bottom:16px;">
                    <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">📊 今日便當統計</div>
                    <div id="adminLunchStats" style="font-size:13px;color:#64748B;">載入中...</div>
                </div>

                <div style="background:#FFF7ED;border-radius:14px;padding:14px;">
                    <div style="font-size:13px;color:#EA580C;line-height:1.6;">
                        <b>💡 說明</b><br>
                        • 被指定的便當管理員進入「便當訂購」頁面後，會自動看到訂購明細報表<br>
                        • 報表包含：統計數字、員工訂購明細、CSV 匯出<br>
                        • 管理者（admin）進入便當頁面也會自動看到報表
                    </div>
                </div>
            </div>
        </div>

        <!-- ====== 薪資發放頁面 ====== -->
        <div id="payrollPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>💰 薪資發放</h2>

                <!-- 薪資設定快捷入口 -->
                <div style="margin-bottom:14px;">
                    <div onclick="toggleSalarySettingPanel()" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#F0FDF4;border:1px solid #BBF7D0;border-radius:12px;">
                        <span style="font-weight:700;font-size:13px;color:#059669;">📋 員工薪資設定</span>
                        <span id="salaryPanelArrow" style="font-size:12px;color:#059669;">▼</span>
                    </div>
                    <div id="salarySettingPanel" style="display:none;margin-top:8px;background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:12px;max-height:400px;overflow-y:auto;">
                        <div id="salarySettingList" style="font-size:13px;">
                            <p style="text-align:center;color:#94A3B8;">載入中...</p>
                        </div>
                    </div>
                </div>

                <!-- 月份選擇 + 計算按鈕 -->
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:16px;">
                    <select id="payrollYear" style="flex:1;padding:10px;border:1px solid #E5E7EB;border-radius:10px;font-size:13px;font-weight:700;"></select>
                    <select id="payrollMonth" style="flex:1;padding:10px;border:1px solid #E5E7EB;border-radius:10px;font-size:13px;font-weight:700;"></select>
                    <button id="calcPayrollBtn" onclick="loadPayrollData()" style="padding:10px 16px;border:none;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:13px;cursor:pointer;white-space:nowrap;">📊 計算薪資</button>
                </div>

                <!-- Loading -->
                <div id="payrollLoading" style="display:none;text-align:center;padding:40px;color:#94A3B8;">
                    <div style="font-size:32px;margin-bottom:8px;">⏳</div>
                    <div style="font-size:14px;">正在計算全員薪資...</div>
                </div>

                <!-- 已發布警告 -->
                <div id="payrollPublishedWarn" style="display:none;background:#FEF3C7;border:1px solid #F59E0B;border-radius:12px;padding:12px;margin-bottom:12px;font-size:13px;color:#92400E;">
                    ⚠️ 此月份薪資已發布，重新計算將覆蓋現有資料
                </div>

                <!-- 摘要卡片 -->
                <div id="payrollSummary" style="display:none;background:linear-gradient(135deg,#4F46E5,#7C3AED);border-radius:16px;padding:20px;color:#fff;margin-bottom:16px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <div style="text-align:center;">
                            <div style="font-size:11px;opacity:0.8;">計算人數</div>
                            <div id="prEmpCount" style="font-size:22px;font-weight:900;">0</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:11px;opacity:0.8;">薪資總額</div>
                            <div id="prTotalNet" style="font-size:22px;font-weight:900;">$0</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:11px;opacity:0.8;">平均實發</div>
                            <div id="prAvgNet" style="font-size:22px;font-weight:900;">$0</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:11px;opacity:0.8;">狀態</div>
                            <div id="prStatus" style="font-size:16px;font-weight:900;">草稿</div>
                        </div>
                    </div>
                </div>

                <!-- 員工選擇 -->
                <div id="payrollEmpSelector" style="display:none;margin-bottom:12px;">
                    <select id="payrollEmpDropdown" onchange="renderPayrollView()" style="width:100%;padding:12px;border:1px solid #E5E7EB;border-radius:12px;font-size:13px;font-weight:700;">
                        <option value="_all">📋 全部員工總覽</option>
                    </select>
                </div>

                <!-- 內容區 -->
                <div id="payrollContent" style="margin-bottom:16px;"></div>

                <!-- 操作按鈕 -->
                <div id="payrollActions" style="display:none;flex-direction:column;gap:10px;">
                    <button id="savePayrollBtn" onclick="saveAllPayroll()" style="width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#059669,#10B981);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">💾 儲存全部（草稿）</button>
                    <button id="publishPayrollBtn" onclick="publishPayroll()" style="width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#DC2626,#EF4444);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">📢 發布薪資（員工可見）</button>
                    <button onclick="exportPayrollCSV()" style="width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#0EA5E9,#38BDF8);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">📥 匯出 CSV</button>
                </div>
            </div>
        </div>

        <!-- 報表匯出頁面 -->
        <div id="reportPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>📊 報表匯出</h2>
                <div class="menu-grid">
                    <div class="menu-item" onclick="exportReport('attendance')">
                        <div class="icon">📈</div><div class="label">出勤報表</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('leave')">
                        <div class="icon">📝</div><div class="label">請假報表</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('bonus')">
                        <div class="icon">🎁</div><div class="label">獎金報表</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('lunch')">
                        <div class="icon">🍱</div><div class="label">便當報表</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('overtime')">
                        <div class="icon">⏰</div><div class="label">加班報表</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('payroll')">
                        <div class="icon">💰</div><div class="label">薪資報表</div>
                    </div>
                    <div class="menu-item" onclick="showPage('fieldWorkApprovalPage')">
                        <div class="icon">📍</div><div class="label">外勤報表</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 功能管理頁面 -->
        <div id="featurePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>🎛️ 功能管理</h2>
                <p style="color:#6b7280;font-size:13px;margin-bottom:16px;">控制員工首頁<b>中間選單</b>顯示哪些功能</p>
                
                <div id="featureToggles" style="display:flex;flex-direction:column;gap:12px;">
                    <!-- 請假 -->
                    <div class="feature-toggle-card" id="ftCard_leave" onclick="toggleFeature('leave')" style="display:flex;align-items:center;gap:14px;padding:16px;background:#fff;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                        <span style="font-size:28px;">📝</span>
                        <div style="flex:1;">
                            <div style="font-weight:800;font-size:14px;color:#0F172A;">我要請假</div>
                            <div style="font-size:12px;color:#94A3B8;margin-top:2px;">請假申請與記錄查詢</div>
                        </div>
                        <div class="ft-indicator" style="width:44px;height:26px;border-radius:13px;background:#4F46E5;position:relative;transition:background 0.3s;">
                            <div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;right:3px;transition:all 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                    <!-- 便當 -->
                    <div class="feature-toggle-card" id="ftCard_lunch" onclick="toggleFeature('lunch')" style="display:flex;align-items:center;gap:14px;padding:16px;background:#fff;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                        <span style="font-size:28px;">🍱</span>
                        <div style="flex:1;">
                            <div style="font-weight:800;font-size:14px;color:#0F172A;">便當訂購</div>
                            <div style="font-size:12px;color:#94A3B8;margin-top:2px;">每日午餐訂購管理</div>
                        </div>
                        <div class="ft-indicator" style="width:44px;height:26px;border-radius:13px;background:#4F46E5;position:relative;transition:background 0.3s;">
                            <div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;right:3px;transition:all 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                    <!-- 考勤 -->
                    <div class="feature-toggle-card" id="ftCard_attendance" onclick="toggleFeature('attendance')" style="display:flex;align-items:center;gap:14px;padding:16px;background:#fff;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                        <span style="font-size:28px;">📊</span>
                        <div style="flex:1;">
                            <div style="font-weight:800;font-size:14px;color:#0F172A;">考勤查詢</div>
                            <div style="font-size:12px;color:#94A3B8;margin-top:2px;">出勤月曆與記錄查詢</div>
                        </div>
                        <div class="ft-indicator" style="width:44px;height:26px;border-radius:13px;background:#4F46E5;position:relative;transition:background 0.3s;">
                            <div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;right:3px;transition:all 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                </div>
                <div id="featureSaveStatus" style="margin-top:12px;text-align:center;font-size:13px;color:#059669;display:none;">✅ 已儲存</div>
                <p style="color:#94A3B8;font-size:12px;margin-top:16px;text-align:center;">💡 底部導航列（首頁/班表/打卡/薪資/管理）為管理員專屬，不受此設定影響</p>

                <!-- LINE Notify 設定 -->
                <div style="margin-top:30px;padding-top:20px;border-top:2px dashed #e5e7eb;">
                    <h3 style="margin-bottom:12px;">🔔 LINE Notify 推播設定</h3>
                    <p style="color:#94A3B8;font-size:12px;margin-bottom:12px;">設定後，請假/補打卡申請會自動推播通知管理員群組</p>
                    <div class="form-group">
                        <label>LINE Notify Token</label>
                        <input type="text" id="lineNotifyToken" placeholder="請貼上 LINE Notify Token">
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-primary" onclick="saveNotifyToken()" style="flex:1;">💾 儲存</button>
                        <button class="btn btn-secondary" onclick="testNotify()" style="flex:1;">🔔 測試推播</button>
                    </div>
                    <div id="notifyStatus" style="margin-top:8px;text-align:center;font-size:13px;display:none;"></div>
                    <div style="margin-top:12px;padding:10px;background:#FFF7ED;border-radius:10px;font-size:11px;color:#EA580C;line-height:1.6;">
                        📌 如何取得 Token：<br>
                        1. 前往 <b>notify-bot.line.me</b><br>
                        2. 登入 → 發行權杖<br>
                        3. 選擇要接收通知的群組<br>
                        4. 複製 Token 貼到上方
                    </div>
                </div>
            </div>
        </div>

        <!-- ====== 人力管理（排班 + 休假 + 設定） ====== -->
        <div id="staffMgrPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>📋 人力管理</h2>

                <!-- 三頁籤 -->
                <div style="display:flex;gap:4px;margin-bottom:16px;background:#F1F5F9;border-radius:10px;padding:3px;">
                    <button class="smTab" onclick="switchStaffTab('shift')" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:#fff;color:#4F46E5;box-shadow:0 1px 4px rgba(0,0,0,0.08);">📋 排班表</button>
                    <button class="smTab" onclick="switchStaffTab('leave')" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:transparent;color:#94A3B8;">🗓️ 休假月表</button>
                    <button class="smTab" onclick="switchStaffTab('setting')" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:transparent;color:#94A3B8;">⚙️ 人力設定</button>
                </div>

                <!-- === 排班表 TAB === -->
                <div id="tabShift" class="staffTabContent">
                    <p style="color:#6b7280;font-size:12px;margin-bottom:12px;">點擊格子切換班別，排好後按儲存</p>
                    <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:12px;">
                        <button onclick="changeShiftWeek(-1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">◀</button>
                        <span id="smWeekLabel" style="font-size:14px;font-weight:700;min-width:180px;text-align:center;">-</span>
                        <button onclick="changeShiftWeek(1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">▶</button>
                        <button onclick="resetShiftWeek()" style="padding:4px 10px;border:1px solid #E5E7EB;border-radius:6px;background:#fff;font-size:11px;font-weight:700;color:#4F46E5;cursor:pointer;">本週</button>
                    </div>
                    <div style="display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap;justify-content:center;">
                        <span style="font-size:10px;padding:3px 8px;background:#DBEAFE;color:#1E40AF;border-radius:6px;font-weight:700;">☀️早</span>
                        <span style="font-size:10px;padding:3px 8px;background:#FEF3C7;color:#92400E;border-radius:6px;font-weight:700;">🌤️中</span>
                        <span style="font-size:10px;padding:3px 8px;background:#EDE9FE;color:#6D28D9;border-radius:6px;font-weight:700;">🌙晚</span>
                        <span style="font-size:10px;padding:3px 8px;background:#ECFDF5;color:#059669;border-radius:6px;font-weight:700;">🏖️休</span>
                        <span style="font-size:10px;padding:3px 8px;background:#F1F5F9;color:#64748B;border-radius:6px;font-weight:700;">⬜未排</span>
                    </div>
                    <!-- 人力不足警告 -->
                    <div id="shiftStaffWarn" style="display:none;padding:10px 14px;background:#FEF2F2;border-radius:10px;margin-bottom:12px;font-size:12px;color:#DC2626;font-weight:700;"></div>
                    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
                        <table id="smTable" style="width:100%;border-collapse:collapse;font-size:12px;min-width:500px;"><thead id="smHead"></thead><tbody id="smBody"></tbody></table>
                    </div>
                    <!-- 每日人力統計 -->
                    <div id="shiftDaySummary" style="display:flex;gap:4px;margin-top:10px;overflow-x:auto;padding-bottom:4px;"></div>
                    <div style="margin-top:14px;display:flex;gap:8px;">
                        <button onclick="saveSchedule()" style="flex:1;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">💾 儲存排班</button>
                        <button onclick="copyLastWeek()" style="padding:14px 20px;border:2px solid #E5E7EB;border-radius:12px;background:#fff;font-weight:700;font-size:14px;cursor:pointer;">📋 複製上週</button>
                    </div>
                    <div id="smSaveStatus" style="margin-top:10px;text-align:center;font-size:13px;display:none;"></div>
                </div>

                <!-- === 休假月表 TAB === -->
                <div id="tabLeave" class="staffTabContent" style="display:none;">
                    <p style="color:#6b7280;font-size:12px;margin-bottom:12px;">一覽全員休假狀態，方便安排工作</p>
                    <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:12px;">
                        <button onclick="changeLeaveCal(-1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">◀</button>
                        <span id="lcMonthLabel" style="font-size:14px;font-weight:700;min-width:120px;text-align:center;">-</span>
                        <button onclick="changeLeaveCal(1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">▶</button>
                        <button onclick="resetLeaveCal()" style="padding:4px 10px;border:1px solid #E5E7EB;border-radius:6px;background:#fff;font-size:11px;font-weight:700;color:#4F46E5;cursor:pointer;">本月</button>
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:12px;">
                        <div style="flex:1;text-align:center;padding:10px;background:#EFF6FF;border-radius:12px;">
                            <div style="font-size:20px;font-weight:900;color:#2563EB;" id="lcTotal">0</div>
                            <div style="font-size:10px;font-weight:600;color:#2563EB;">總請假人次</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:10px;background:#ECFDF5;border-radius:12px;">
                            <div style="font-size:20px;font-weight:900;color:#059669;" id="lcAvail">0</div>
                            <div style="font-size:10px;font-weight:600;color:#059669;">今日可用人力</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:10px;background:#FEF2F2;border-radius:12px;">
                            <div style="font-size:20px;font-weight:900;color:#DC2626;" id="lcMax">0</div>
                            <div style="font-size:10px;font-weight:600;color:#DC2626;">上限</div>
                        </div>
                    </div>
                    <!-- 日期有超過上限的高亮 -->
                    <div id="lcOverWarn" style="display:none;padding:10px 14px;background:#FEF2F2;border-radius:10px;margin-bottom:12px;font-size:12px;color:#DC2626;font-weight:700;"></div>
                    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
                        <table id="lcTable" style="width:100%;border-collapse:collapse;font-size:11px;min-width:600px;"><thead id="lcHead"></thead><tbody id="lcBody"></tbody></table>
                    </div>
                    <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap;">
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#DBEAFE;border-radius:3px;display:inline-block;"></span>特休</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FEE2E2;border-radius:3px;display:inline-block;"></span>病假</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FEF3C7;border-radius:3px;display:inline-block;"></span>事假</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#E0E7FF;border-radius:3px;display:inline-block;"></span>補休</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FCA5A5;border-radius:3px;display:inline-block;border:2px solid #DC2626;"></span>超限</span>
                    </div>
                </div>

                <!-- === 人力設定 TAB === -->
                <div id="tabSetting" class="staffTabContent" style="display:none;">
                    <p style="color:#6b7280;font-size:12px;margin-bottom:16px;">設定請假限制與人力規則</p>

                    <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-bottom:16px;">
                        <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">🚫 同時請假人數上限</div>
                        <p style="font-size:12px;color:#94A3B8;margin-bottom:12px;">當某天已有 N 人請假，第 N+1 人提交申請時會被<b style="color:#DC2626;">自動駁回</b></p>
                        <div style="display:flex;align-items:center;gap:12px;">
                            <button onclick="adjustMaxLeave(-1)" style="width:44px;height:44px;border:2px solid #E5E7EB;border-radius:12px;background:#fff;font-size:20px;cursor:pointer;font-weight:700;">−</button>
                            <div style="flex:1;text-align:center;">
                                <div id="maxLeaveNum" style="font-size:36px;font-weight:900;color:#4F46E5;">2</div>
                                <div style="font-size:11px;color:#94A3B8;">人</div>
                            </div>
                            <button onclick="adjustMaxLeave(1)" style="width:44px;height:44px;border:2px solid #E5E7EB;border-radius:12px;background:#fff;font-size:20px;cursor:pointer;font-weight:700;">+</button>
                        </div>
                        <button onclick="saveMaxLeave()" style="width:100%;margin-top:14px;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">💾 儲存設定</button>
                        <div id="maxLeaveSaveStatus" style="margin-top:8px;text-align:center;font-size:13px;display:none;"></div>
                    </div>

                    <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-bottom:16px;">
                        <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">🏢 排班模式</div>
                        <p style="font-size:12px;color:#94A3B8;margin-bottom:12px;">選擇公司的班別制度，影響排班表與員工班表頁面</p>
                        <div style="display:flex;gap:8px;margin-bottom:12px;">
                            <div id="modeShift" onclick="selectSchedulingMode('shift')" style="flex:1;padding:14px 12px;border:2px solid #4F46E5;border-radius:12px;cursor:pointer;text-align:center;background:#EEF2FF;transition:all 0.2s;">
                                <div style="font-size:24px;margin-bottom:6px;">🔄</div>
                                <div id="modeShiftLabel" style="font-size:13px;font-weight:800;color:#4F46E5;">排班制</div>
                                <div style="font-size:10px;color:#94A3B8;margin-top:4px;">服務業、餐飲、零售<br>早/中/晚輪班</div>
                            </div>
                            <div id="modeFixed" onclick="selectSchedulingMode('fixed')" style="flex:1;padding:14px 12px;border:2px solid #E5E7EB;border-radius:12px;cursor:pointer;text-align:center;background:#fff;transition:all 0.2s;">
                                <div style="font-size:24px;margin-bottom:6px;">☀️</div>
                                <div id="modeFixedLabel" style="font-size:13px;font-weight:800;color:#94A3B8;">固定班</div>
                                <div style="font-size:10px;color:#94A3B8;margin-top:4px;">固定時段上班<br>可自訂時間</div>
                            </div>
                        </div>
                        <!-- 固定班設定（選擇固定班時顯示） -->
                        <div id="fixedShiftConfig" style="display:none;margin-bottom:12px;">
                            <div style="font-size:12px;font-weight:700;color:#4b5563;margin-bottom:8px;">固定班別設定</div>
                            <div style="display:flex;gap:6px;margin-bottom:10px;">
                                <button onclick="setFixedPreset('08:00','17:00')" class="fixedPresetBtn" style="flex:1;padding:8px;border:1px solid #E5E7EB;border-radius:8px;background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:#4F46E5;">☀️ 早班</button>
                                <button onclick="setFixedPreset('13:00','22:00')" class="fixedPresetBtn" style="flex:1;padding:8px;border:1px solid #E5E7EB;border-radius:8px;background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:#F59E0B;">🌤️ 中班</button>
                                <button onclick="setFixedPreset('22:00','07:00')" class="fixedPresetBtn" style="flex:1;padding:8px;border:1px solid #E5E7EB;border-radius:8px;background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:#8B5CF6;">🌙 晚班</button>
                            </div>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <div style="flex:1;">
                                    <label style="font-size:11px;color:#94A3B8;display:block;margin-bottom:4px;">上班時間</label>
                                    <input type="time" id="fixedStartTime" value="08:00" style="width:100%;padding:10px;border:1px solid #E5E7EB;border-radius:8px;font-size:14px;font-weight:700;">
                                </div>
                                <span style="margin-top:16px;font-weight:700;color:#94A3B8;">~</span>
                                <div style="flex:1;">
                                    <label style="font-size:11px;color:#94A3B8;display:block;margin-bottom:4px;">下班時間</label>
                                    <input type="time" id="fixedEndTime" value="17:00" style="width:100%;padding:10px;border:1px solid #E5E7EB;border-radius:8px;font-size:14px;font-weight:700;">
                                </div>
                            </div>
                        </div>
                        <button onclick="saveSchedulingMode()" style="width:100%;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">💾 儲存排班模式</button>
                        <div id="schedModeSaveStatus" style="margin-top:8px;text-align:center;font-size:13px;display:none;"></div>
                    </div>

                    <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-top:16px;">
                        <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">📊 目前人力概況</div>
                        <div id="staffOverview" style="font-size:13px;color:#64748B;line-height:1.8;">載入中...</div>
                    </div>

                    <div style="background:#FFF7ED;border-radius:14px;padding:14px;margin-top:16px;">
                        <div style="font-size:13px;color:#EA580C;line-height:1.6;">
                            <b>💡 自動駁回規則說明</b><br>
                            • 員工填入請假日期時，系統<b>即時檢查</b>該日已有幾人請假<br>
                            • 若加上申請者會超過上限，<b>表單直接鎖定</b>無法提交<br>
                            • 已核准 + 待審核 的假都會被計入<br>
                            • 週末不計入衝突檢查
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 客戶管理頁面 -->
        <div id="clientPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>🏢 客戶管理</h2>

                <div style="display:flex;gap:8px;margin-bottom:12px;">
                    <input type="text" id="clientSearch" placeholder="搜尋公司名稱..." oninput="filterClients()" style="flex:1;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                    <button class="btn btn-primary" onclick="showClientModal()" style="white-space:nowrap;font-size:13px;padding:10px 16px;">+ 新增</button>
                </div>

                <div id="clientList">
                    <p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">載入中...</p>
                </div>

                <!-- 服務項目管理 -->
                <div class="lunch-summary" style="margin-top:20px;">
                    <h3 style="margin-bottom:10px;">🔧 服務項目管理</h3>
                    <div id="serviceItemList"></div>
                    <div style="display:flex;gap:8px;margin-top:10px;">
                        <input type="text" id="newServiceItemName" placeholder="新增服務項目名稱" style="flex:1;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:13px;">
                        <button class="btn btn-success" onclick="addServiceItem()" style="font-size:12px;padding:8px 14px;white-space:nowrap;">新增</button>
                    </div>
                </div>
            </div>

            <!-- 客戶新增/編輯 Modal -->
            <div id="clientModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999;overflow-y:auto;">
                <div style="background:#fff;margin:40px auto;max-width:500px;border-radius:16px;padding:24px;">
                    <h3 id="clientModalTitle" style="margin-bottom:16px;">新增客戶</h3>
                    <input type="hidden" id="clientEditId">
                    <div class="form-group"><label>公司名稱 *</label><input type="text" id="clientCompanyName" placeholder="公司名稱"></div>
                    <div class="form-group"><label>聯絡人</label><input type="text" id="clientContactName" placeholder="聯絡人姓名"></div>
                    <div class="form-group"><label>電話</label><input type="text" id="clientPhone" placeholder="電話"></div>
                    <div class="form-group"><label>地址</label><input type="text" id="clientAddress" placeholder="地址"></div>
                    <div class="form-group">
                        <label>GPS 座標</label>
                        <div style="display:flex;gap:8px;">
                            <input type="text" id="clientLat" placeholder="緯度" style="flex:1;">
                            <input type="text" id="clientLng" placeholder="經度" style="flex:1;">
                        </div>
                        <button class="btn btn-secondary" onclick="getClientGPS()" style="margin-top:6px;font-size:12px;padding:8px;">📍 抓取目前位置</button>
                    </div>
                    <div class="form-group">
                        <label>分類</label>
                        <select id="clientCategory" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                            <option value="general">一般</option>
                            <option value="vip">VIP ⭐</option>
                        </select>
                    </div>
                    <div class="form-group"><label>產業別</label><input type="text" id="clientIndustry" placeholder="例：科技業、製造業"></div>
                    <div class="form-group"><label>備註</label><textarea id="clientNotes" rows="2" placeholder="備註" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;resize:vertical;box-sizing:border-box;"></textarea></div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-success" onclick="saveClient()" style="flex:1;">💾 儲存</button>
                        <button class="btn btn-secondary" onclick="closeClientModal()" style="flex:1;">取消</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 勞健保級距管理頁面 -->
        <div id="insurancePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>🏥 勞健保級距管理</h2>

                <div class="lunch-summary" id="insRateSummary">
                    <h3 style="margin-bottom:10px;">⚙️ 費率設定</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <div class="form-group" style="margin:0;"><label style="font-size:12px;">勞保費率 %</label><input type="number" id="insLaborRate" step="0.01" value="12.50" style="padding:8px;font-size:13px;"></div>
                        <div class="form-group" style="margin:0;"><label style="font-size:12px;">勞保員工負擔比 %</label><input type="number" id="insLaborShare" step="0.01" value="20.00" style="padding:8px;font-size:13px;"></div>
                        <div class="form-group" style="margin:0;"><label style="font-size:12px;">健保費率 %</label><input type="number" id="insHealthRate" step="0.01" value="5.17" style="padding:8px;font-size:13px;"></div>
                        <div class="form-group" style="margin:0;"><label style="font-size:12px;">健保員工負擔比 %</label><input type="number" id="insHealthShare" step="0.01" value="30.00" style="padding:8px;font-size:13px;"></div>
                    </div>
                    <button class="btn btn-primary" onclick="updateAllInsRates()" style="margin-top:10px;font-size:13px;">📝 套用費率到所有級距</button>
                </div>

                <div style="display:flex;justify-content:space-between;align-items:center;margin:16px 0 8px;">
                    <span style="font-size:14px;font-weight:700;">📋 級距表（共 <span id="insCount">0</span> 筆）</span>
                    <button class="btn btn-success" onclick="showInsModal()" style="font-size:12px;padding:8px 14px;width:auto;">+ 新增</button>
                </div>

                <div style="overflow-x:auto;border-radius:12px;border:1px solid #E2E8F0;">
                    <table style="width:100%;border-collapse:collapse;font-size:12px;" id="insTable">
                        <thead>
                            <tr style="background:#F8FAFC;">
                                <th style="padding:8px 6px;text-align:right;white-space:nowrap;">薪資下限</th>
                                <th style="padding:8px 6px;text-align:right;white-space:nowrap;">薪資上限</th>
                                <th style="padding:8px 6px;text-align:right;white-space:nowrap;">投保金額</th>
                                <th style="padding:8px 6px;text-align:center;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="insTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 新增/編輯級距 Modal -->
            <div id="insModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999;overflow-y:auto;">
                <div style="background:#fff;margin:60px auto;max-width:400px;border-radius:16px;padding:24px;">
                    <h3 id="insModalTitle" style="margin-bottom:16px;">新增級距</h3>
                    <input type="hidden" id="insEditId">
                    <div class="form-group"><label>薪資下限 *</label><input type="number" id="insSalaryMin" placeholder="0"></div>
                    <div class="form-group"><label>薪資上限 *</label><input type="number" id="insSalaryMax" placeholder="27470"></div>
                    <div class="form-group"><label>投保金額 *</label><input type="number" id="insAmount" placeholder="27470"></div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-success" onclick="saveInsBracket()" style="flex:1;">💾 儲存</button>
                        <button class="btn btn-secondary" onclick="closeInsModal()" style="flex:1;">取消</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 公司管理頁面 -->
        <div id="companyPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>🏛️ 公司管理</h2>

                <div style="display:flex;gap:8px;margin-bottom:12px;">
                    <input type="text" id="companySearch" placeholder="搜尋公司..." oninput="filterCompanies()" style="flex:1;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                    <button class="btn btn-primary" onclick="showCompanyModal()" style="white-space:nowrap;font-size:13px;padding:10px 16px;">+ 新增</button>
                </div>

                <div id="companyList">
                    <p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">載入中...</p>
                </div>
            </div>

            <!-- 公司新增/編輯 Modal -->
            <div id="companyModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999;overflow-y:auto;">
                <div style="background:#fff;margin:60px auto;max-width:450px;border-radius:16px;padding:24px;">
                    <h3 id="companyModalTitle" style="margin-bottom:16px;">新增公司</h3>
                    <input type="hidden" id="companyEditId">
                    <div class="form-group"><label>公司代碼 *</label><input type="text" id="companyCode" placeholder="例：HR_SYSTEM_001" style="text-transform:uppercase;"></div>
                    <div class="form-group"><label>公司名稱 *</label><input type="text" id="companyName" placeholder="公司全名"></div>
                    <div class="form-group">
                        <label>狀態</label>
                        <select id="companyIsActive" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                            <option value="true">啟用</option>
                            <option value="false">停用</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-success" onclick="saveCompany()" style="flex:1;">💾 儲存</button>
                        <button class="btn btn-secondary" onclick="closeCompanyModal()" style="flex:1;">取消</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 外勤審核頁面 -->
        <div id="fieldWorkApprovalPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>📍 外勤審核</h2>

                <!-- 篩選 -->
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                    <input type="date" id="fwaDateFrom" style="flex:1;min-width:120px;padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;">
                    <input type="date" id="fwaDateTo" style="flex:1;min-width:120px;padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;">
                    <select id="fwaStatusFilter" style="padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;">
                        <option value="submitted">待審核</option>
                        <option value="approved">已核准</option>
                        <option value="rejected">已退回</option>
                        <option value="">全部</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadFieldWorkApprovals()" style="font-size:12px;padding:8px 14px;">查詢</button>
                </div>

                <!-- 統計 -->
                <div style="display:flex;gap:8px;margin-bottom:12px;">
                    <div style="flex:1;text-align:center;padding:8px;background:#DBEAFE;border-radius:8px;">
                        <div style="font-size:18px;font-weight:900;color:#1E40AF;" id="fwaTotal">0</div>
                        <div style="font-size:10px;color:#1E40AF;">總筆數</div>
                    </div>
                    <div style="flex:1;text-align:center;padding:8px;background:#FEF3C7;border-radius:8px;">
                        <div style="font-size:18px;font-weight:900;color:#92400E;" id="fwaPending">0</div>
                        <div style="font-size:10px;color:#92400E;">待審核</div>
                    </div>
                    <div style="flex:1;text-align:center;padding:8px;background:#D1FAE5;border-radius:8px;">
                        <div style="font-size:18px;font-weight:900;color:#059669;" id="fwaTotalHours">0</div>
                        <div style="font-size:10px;color:#059669;">總工時(h)</div>
                    </div>
                </div>

                <div id="fwaList">
                    <p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">請選擇日期查詢</p>
                </div>

                <button class="btn btn-secondary" onclick="exportFieldWorkCSV()" style="width:100%;margin-top:12px;font-size:13px;padding:12px;">📥 匯出外勤 CSV</button>
            </div>

            <!-- 明細 Modal -->
            <div id="fwaDetailModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999;overflow-y:auto;">
                <div style="background:#fff;margin:30px auto;max-width:500px;border-radius:16px;padding:24px;">
                    <div id="fwaDetailContent"></div>
                    <div id="fwaDetailActions" style="display:flex;gap:8px;margin-top:16px;"></div>
                    <button class="btn btn-secondary" onclick="closeFwaDetailModal()" style="width:100%;margin-top:8px;font-size:13px;">關閉</button>
                </div>
            </div>
        </div>

        <!-- ====== 商店管理 ====== -->
        <div id="storeManagePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>🍽️ 商店管理</h2>

                <button class="btn btn-primary" onclick="showStoreModal()" style="margin-bottom:16px;font-size:13px;padding:12px;">+ 新增商店</button>

                <div id="storeList"><p style="text-align:center;color:#999;">載入中...</p></div>
            </div>
        </div>

        <!-- 商店編輯 Modal -->
        <div id="storeModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;padding:20px;">
            <div style="background:#fff;border-radius:16px;width:100%;max-width:440px;max-height:90vh;overflow-y:auto;padding:24px;">
                <h3 id="storeModalTitle" style="margin-bottom:16px;">新增商店</h3>
                <input type="hidden" id="storeEditId">
                <div class="form-group">
                    <label>關聯客戶 *</label>
                    <select id="storeClientSelect" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                        <option value="">-- 選擇客戶 --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>商店名稱 *</label>
                    <input type="text" id="storeNameInput" placeholder="例：Mike's Cafe" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label>URL 代碼 (slug)</label>
                    <input type="text" id="storeSlugInput" placeholder="例：mikes-cafe（英文小寫+連字號）" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label>商店類型</label>
                    <select id="storeTypeSelect" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                        <option value="restaurant">餐飲</option>
                        <option value="service">服務業</option>
                        <option value="retail">零售</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>說明</label>
                    <input type="text" id="storeDescInput" placeholder="選填" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label>電話</label>
                    <input type="tel" id="storePhoneInput" placeholder="選填" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label>地址</label>
                    <input type="text" id="storeAddressInput" placeholder="選填" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label>主題色</label>
                    <input type="color" id="storeColorInput" value="#4F46E5" style="width:60px;height:40px;border:none;cursor:pointer;">
                </div>
                <div style="display:flex;gap:8px;margin-top:16px;">
                    <button onclick="closeStoreModal()" style="flex:1;padding:14px;border:1px solid #E2E8F0;border-radius:10px;background:#fff;font-weight:600;cursor:pointer;color:#64748B;">取消</button>
                    <button onclick="saveStore()" style="flex:1;padding:14px;border:none;border-radius:10px;background:linear-gradient(135deg,#059669,#10B981);color:#fff;font-weight:700;cursor:pointer;">💾 儲存</button>
                </div>
            </div>
        </div>

        <!-- 菜單管理 Modal -->
        <div id="menuManageModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:flex-start;justify-content:center;padding:10px;overflow-y:auto;">
            <div style="background:#fff;border-radius:16px;width:100%;max-width:500px;max-height:95vh;overflow-y:auto;padding:24px;margin:auto;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h3 id="menuManageTitle" style="margin:0;">菜單管理</h3>
                    <button onclick="closeMenuManage()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#94A3B8;">×</button>
                </div>

                <!-- 分類管理 -->
                <div style="background:#F8FAFC;border-radius:12px;padding:14px;margin-bottom:16px;">
                    <div style="font-weight:700;font-size:14px;margin-bottom:8px;">📂 分類</div>
                    <div id="menuCatList" style="margin-bottom:8px;"></div>
                    <div style="display:flex;gap:8px;">
                        <input type="text" id="newCatName" placeholder="新分類名稱" style="flex:1;padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;box-sizing:border-box;">
                        <button onclick="addMenuCategory()" style="padding:8px 14px;border:none;border-radius:8px;background:#4F46E5;color:#fff;font-weight:600;font-size:13px;cursor:pointer;">+ 新增</button>
                    </div>
                </div>

                <!-- 品項管理 -->
                <div style="font-weight:700;font-size:14px;margin-bottom:8px;">🍽️ 品項</div>
                <button onclick="showMenuItemForm()" style="width:100%;padding:10px;border:1px dashed #4F46E5;border-radius:10px;background:#EEF2FF;color:#4F46E5;font-weight:600;font-size:13px;cursor:pointer;margin-bottom:12px;">+ 新增品項</button>
                <div id="menuItemList"></div>

                <!-- 新增/編輯品項表單 -->
                <div id="menuItemForm" style="display:none;background:#F8FAFC;border-radius:12px;padding:14px;margin-top:12px;">
                    <input type="hidden" id="miEditId">
                    <div class="form-group">
                        <label style="font-size:12px;">品名 *</label>
                        <input type="text" id="miName" placeholder="例：招牌牛肉麵" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;box-sizing:border-box;">
                    </div>
                    <div class="form-group">
                        <label style="font-size:12px;">分類</label>
                        <select id="miCategory" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;"></select>
                    </div>
                    <div class="form-group">
                        <label style="font-size:12px;">價格 *</label>
                        <input type="number" id="miPrice" min="0" placeholder="0" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;box-sizing:border-box;">
                    </div>
                    <div class="form-group">
                        <label style="font-size:12px;">說明</label>
                        <input type="text" id="miDesc" placeholder="選填" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;box-sizing:border-box;">
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button onclick="cancelMenuItemForm()" style="flex:1;padding:10px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:13px;cursor:pointer;">取消</button>
                        <button onclick="saveMenuItem()" style="flex:1;padding:10px;border:none;border-radius:8px;background:#059669;color:#fff;font-weight:600;font-size:13px;cursor:pointer;">儲存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div id="storeQRModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:none;align-items:center;justify-content:center;padding:20px;">
            <div style="background:#fff;border-radius:16px;padding:24px;text-align:center;max-width:360px;width:100%;">
                <h3 id="storeQRTitle" style="margin-bottom:12px;"></h3>
                <div id="storeQRCode" style="display:inline-block;margin-bottom:12px;"></div>
                <p id="storeQRUrl" style="font-size:12px;color:#64748B;word-break:break-all;margin-bottom:12px;"></p>
                <button onclick="closeStoreQR()" style="padding:12px 24px;border:1px solid #E2E8F0;border-radius:10px;background:#fff;font-weight:600;cursor:pointer;">關閉</button>
            </div>
        </div>

        <!-- ====== 訂單管理 ====== -->
        <div id="orderManagePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>📦 訂單管理</h2>

                <!-- 篩選 -->
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                    <select id="omStoreFilter" style="flex:1;min-width:120px;padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;">
                        <option value="">全部商店</option>
                    </select>
                    <select id="omStatusFilter" style="padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;">
                        <option value="">全部狀態</option>
                        <option value="pending" selected>待處理</option>
                        <option value="confirmed">已確認</option>
                        <option value="preparing">準備中</option>
                        <option value="ready">可取餐</option>
                        <option value="completed">已完成</option>
                        <option value="cancelled">已取消</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadOrderList()" style="font-size:12px;padding:8px 14px;">查詢</button>
                </div>

                <!-- 統計 -->
                <div style="display:flex;gap:8px;margin-bottom:12px;">
                    <div style="flex:1;text-align:center;padding:8px;background:#FEF3C7;border-radius:8px;">
                        <div style="font-size:18px;font-weight:900;color:#92400E;" id="omPendingCount">0</div>
                        <div style="font-size:10px;color:#92400E;">待處理</div>
                    </div>
                    <div style="flex:1;text-align:center;padding:8px;background:#DBEAFE;border-radius:8px;">
                        <div style="font-size:18px;font-weight:900;color:#1E40AF;" id="omTodayCount">0</div>
                        <div style="font-size:10px;color:#1E40AF;">今日訂單</div>
                    </div>
                    <div style="flex:1;text-align:center;padding:8px;background:#D1FAE5;border-radius:8px;">
                        <div style="font-size:18px;font-weight:900;color:#059669;" id="omTodayRevenue">$0</div>
                        <div style="font-size:10px;color:#059669;">今日營收</div>
                    </div>
                </div>

                <div id="orderList"><p style="text-align:center;color:#999;">載入中...</p></div>
            </div>
        </div>

        <!-- 訂單明細 Modal -->
        <div id="orderDetailModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;padding:20px;">
            <div style="background:#fff;border-radius:16px;width:100%;max-width:420px;max-height:90vh;overflow-y:auto;padding:24px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h3 id="odTitle" style="margin:0;">訂單明細</h3>
                    <button onclick="closeOrderDetail()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#94A3B8;">×</button>
                </div>
                <div id="odContent"></div>
                <div id="odActions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:16px;"></div>
            </div>
        </div>

        <!-- ====== 業務目標管理 ====== -->
        <div id="salesTargetPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>🎯 業務目標管理</h2>

                <!-- 週切換 -->
                <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:16px;">
                    <button onclick="stChangeWeek(-1)" style="padding:8px 14px;border:1px solid #E2E8F0;border-radius:10px;background:#fff;cursor:pointer;font-size:16px;">←</button>
                    <span id="stWeekLabel" style="font-weight:700;font-size:14px;min-width:180px;text-align:center;"></span>
                    <button onclick="stChangeWeek(1)" style="padding:8px 14px;border:1px solid #E2E8F0;border-radius:10px;background:#fff;cursor:pointer;font-size:16px;">→</button>
                </div>

                <!-- 設定目標區 -->
                <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:16px;">
                    <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">🎯 本週全員預設目標</div>
                    <div style="display:flex;gap:12px;margin-bottom:12px;">
                        <div style="flex:1;">
                            <label style="font-size:12px;font-weight:600;color:#64748B;display:block;margin-bottom:4px;">📞 電話拜訪</label>
                            <input type="number" id="stDefaultCall" min="0" value="0" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:12px;font-weight:600;color:#64748B;display:block;margin-bottom:4px;">🏢 實地拜訪</label>
                            <input type="number" id="stDefaultVisit" min="0" value="0" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveDefaultTarget()" style="font-size:13px;padding:10px;">💾 儲存預設目標</button>
                </div>

                <!-- 全員進度總覽 -->
                <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">📊 全員進度總覽</div>
                <div id="stProgressList"><p style="text-align:center;color:#999;">載入中...</p></div>
            </div>
        </div>

    </div>
    <nav class="bottom-nav" id="bottomNav" style="display:none;">
        <a class="nav-item" onclick="window.location.href='index.html'">
            <span class="nav-icon">🏠</span>
            <span class="nav-label">首頁</span>
        </a>
        <a class="nav-item" onclick="window.location.href='schedule.html'">
            <span class="nav-icon">📅</span>
            <span class="nav-label">班表</span>
        </a>
        <a class="nav-item" onclick="window.location.href='checkin.html?type=in'">
            <span class="nav-icon">📍</span>
            <span class="nav-label">打卡</span>
        </a>
        <a class="nav-item" onclick="window.location.href='salary.html'">
            <span class="nav-icon">💰</span>
            <span class="nav-label">薪資</span>
        </a>
        <a class="nav-item active">
            <span class="nav-icon">⚙️</span>
            <span class="nav-label">管理</span>
        </a>
    </nav>

    <script src="common.js"></script>
    <script>
        let currentAdminEmployee = null;

        // ===== 混合精算獎金系統 =====
        const BONUS_MATRIX = {
            S: { A: 2.0, B: 1.8, C: 1.5 },
            A: { A: 1.5, B: 1.3, C: 1.0 },
            B: { A: 1.0, B: 0.8, C: 0.5 }
        };
        const FULL_ATTENDANCE_BONUS = 3000;
        const LATE_PENALTY_PER = 200;
        const GRADE_LABELS = { A: '全勤', B: '正常', C: '待加強' };
        const PERF_LABELS = { S: '卓越', A: '優良', B: '普通' };
        let bonusEmployees = [];
        let bonusPerformance = {};
        let bonusAdjustments = {};

        // 本地日期格式化（避免 toISOString 時區偏移）
        function fmtDate(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        // 頁面切換
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if (id === 'bonusPage') loadHybridBonusData();
            if (id === 'locationPage') renderLocationList();
            if (id === 'employeePage') loadEmployeeList();
            if (id === 'leaveApprovalPage') loadLeaveApprovals('pending');
            if (id === 'makeupApprovalPage') loadMakeupApprovals('pending');
            if (id === 'overtimeApprovalPage') loadOtApprovals('pending');
            if (id === 'swapApprovalPage') loadSwapApprovals();
            if (id === 'announcementPage') loadAnnouncementList();
            if (id === 'auditLogPage') loadAuditLogs();
            if (id === 'featurePage') { loadFeatureSettings(); loadNotifyToken(); }
            if (id === 'staffMgrPage') { loadShiftMgr(); loadMaxLeaveSetting(); loadStaffOverview(); loadSchedulingMode(); }
            if (id === 'lunchMgrPage') { loadLunchManagers(); loadAdminLunchStats(); }
            if (id === 'payrollPage') { initPayrollPage(); }
            if (id === 'clientPage') { loadClientList(); loadServiceItemList(); }
            if (id === 'fieldWorkApprovalPage') { initFieldWorkApproval(); }
            if (id === 'insurancePage') { loadInsuranceBrackets(); }
            if (id === 'companyPage') { loadCompanyList(); }
            if (id === 'salesTargetPage') { initSalesTargetPage(); }
            if (id === 'storeManagePage') { loadStoreList(); }
            if (id === 'orderManagePage') { initOrderManage(); }
        }

        // ===== 功能管理 =====
        let featureState = { leave: true, lunch: true, attendance: true };

        // LINE Notify 設定
        async function loadNotifyToken() {
            try {
                const { data } = await sb.from('system_settings')
                    .select('value').eq('key', 'line_notify_token').maybeSingle();
                if (data?.value?.token) {
                    const el = document.getElementById('lineNotifyToken');
                    if (el) el.value = data.value.token;
                }
            } catch(e) {}
        }

        async function saveNotifyToken() {
            const token = document.getElementById('lineNotifyToken')?.value?.trim();
            if (!token) return showToast('❌ 請輸入 Token');
            const status = document.getElementById('notifyStatus');
            try {
                const { data: existing } = await sb.from('system_settings')
                    .select('id').eq('key', 'line_notify_token').maybeSingle();
                if (existing) {
                    await sb.from('system_settings').update({ value: { token }, updated_at: new Date().toISOString() }).eq('key', 'line_notify_token');
                } else {
                    await sb.from('system_settings').insert({ key: 'line_notify_token', value: { token }, description: 'LINE Notify 推播 Token' });
                }
                showToast('✅ Token 已儲存');
                if (status) { status.style.display = 'block'; status.style.color = '#059669'; status.textContent = '✅ 已儲存'; }
            } catch(e) { showToast('❌ 儲存失敗'); }
        }

        async function testNotify() {
            const status = document.getElementById('notifyStatus');
            if (status) { status.style.display = 'block'; status.style.color = '#6D28D9'; status.textContent = '⏳ 發送測試...'; }
            try {
                await sendAdminNotify('🔔 HR 系統推播測試\n如果您收到此訊息，表示 LINE Notify 設定成功！');
                showToast('✅ 測試推播已發送');
                if (status) { status.style.color = '#059669'; status.textContent = '✅ 推播成功！請查看 LINE 群組'; }
            } catch(e) {
                showToast('❌ 推播失敗');
                if (status) { status.style.color = '#DC2626'; status.textContent = '❌ 推播失敗，請檢查 Token 或 Edge Function'; }
            }
        }

        async function loadFeatureSettings() {
            try {
                const { data } = await sb.from('system_settings')
                    .select('value')
                    .eq('key', 'feature_visibility')
                    .maybeSingle();
                
                if (data?.value) {
                    featureState = { ...featureState, ...data.value };
                }
            } catch(e) {}
            
            // 更新卡片顯示
            ['leave', 'lunch', 'attendance'].forEach(key => updateToggleCard(key));
        }

        function updateToggleCard(key) {
            const card = document.getElementById('ftCard_' + key);
            if (!card) return;
            const on = featureState[key] !== false;
            const indicator = card.querySelector('.ft-indicator');
            const dot = indicator?.querySelector('div');
            
            if (on) {
                card.style.borderColor = '#4F46E5';
                card.style.background = '#F5F3FF';
                indicator.style.background = '#4F46E5';
                if (dot) { dot.style.right = '3px'; dot.style.left = 'auto'; }
            } else {
                card.style.borderColor = '#E5E7EB';
                card.style.background = '#fff';
                indicator.style.background = '#CBD5E1';
                if (dot) { dot.style.left = '3px'; dot.style.right = 'auto'; }
            }
        }

        async function toggleFeature(key) {
            featureState[key] = !featureState[key];
            updateToggleCard(key);
            
            try {
                const { data: existing } = await sb.from('system_settings')
                    .select('id')
                    .eq('key', 'feature_visibility')
                    .maybeSingle();
                
                if (existing) {
                    await sb.from('system_settings')
                        .update({ value: featureState, updated_at: new Date().toISOString() })
                        .eq('key', 'feature_visibility');
                } else {
                    await sb.from('system_settings')
                        .insert({ key: 'feature_visibility', value: featureState, description: '員工可見功能設定' });
                }
                
                const el = document.getElementById('featureSaveStatus');
                el.style.display = 'block';
                el.textContent = featureState[key] ? '✅ 已開啟' : '⛔ 已關閉';
                el.style.color = featureState[key] ? '#059669' : '#DC2626';
                setTimeout(() => el.style.display = 'none', 1500);
            } catch(e) {
                console.error('儲存失敗', e);
                showToast('❌ 儲存失敗');
            }
        }

        // 檢查管理員權限
        async function checkAdminPermission() {
            const statusEl = document.getElementById('permissionStatus');
            const loadingPage = document.getElementById('loadingPage');
            
            try {
                const initialized = await initializeLiff();
                
                // [BUG FIX] 無論成功失敗都要隱藏 loading 畫面
                if (loadingPage) loadingPage.style.display = 'none';
                
                if (!initialized) {
                    showStatus(statusEl, 'error', '❌ LIFF 初始化失敗，請從 LINE 開啟');
                    return;
                }

                console.log('🔑 LINE User ID:', liffProfile?.userId);

                const { data, error } = await sb.from('employees')
                    .select('*')
                    .eq('line_user_id', liffProfile.userId)
                    .in('role', ['admin', 'manager'])
                    .eq('is_active', true)
                    .maybeSingle();

                if (error) {
                    console.error('❌ 資料庫查詢錯誤:', error);
                    showStatus(statusEl, 'error', '❌ 資料庫查詢失敗: ' + error.message);
                    return;
                }
                
                if (!data) {
                    console.log('❌ 找不到管理員/主管資料，LINE ID:', liffProfile?.userId);
                    showStatus(statusEl, 'error', '❌ 您沒有管理權限<br><small style="opacity:0.7">LINE ID: ' + escapeHTML(liffProfile?.userId || '未知') + '</small>', true);
                    setTimeout(() => { window.location.href = 'index.html'; }, 5000);
                    return;
                }

                currentAdminEmployee = data;
                updateAdminInfo(data);
                
                // 載入系統設定（地點等）
                await loadSettings();
                
                showStatus(statusEl, 'success', '✅ 權限驗證通過');
                populateYearSelect('bonusYear');
                setTimeout(() => {
                    showPage('adminHomePage');
                    document.getElementById('bottomNav').style.display = 'flex';
                    applyRoleVisibility();
                }, 800);

            } catch (err) {
                console.error('權限檢查異常:', err);
                if (loadingPage) loadingPage.style.display = 'none';
                showStatus(statusEl, 'error', '❌ 權限檢查失敗: ' + (typeof friendlyError === 'function' ? friendlyError(err) : err.message));
            }
        }

        // [BUG FIX] 修正管理員頭像顯示 — 有圖片時不應顯示 emoji
        function updateAdminInfo(data) {
            const roleLabel = data.role === 'admin' ? '管理員' : '主管';
            document.getElementById('adminName').textContent = data.name;
            document.getElementById('adminDept').textContent = `${data.department || '系統管理'} · ${roleLabel}`;
            document.getElementById('adminId').textContent = `ID: ${data.employee_number}`;

            const avatar = document.getElementById('adminAvatar');
            if (liffProfile?.pictureUrl) {
                avatar.style.backgroundImage = `url(${liffProfile.pictureUrl})`;
                avatar.style.backgroundSize = 'cover';
                avatar.textContent = '';
            } else {
                avatar.textContent = data.role === 'admin' ? '👑' : '👤';
            }
        }

        // 依角色隱藏無權限的選單項目
        function applyRoleVisibility() {
            if (!currentAdminEmployee) return;
            const role = currentAdminEmployee.role;
            if (role === 'admin') return; // admin 看全部

            // manager 只看沒有 data-require="admin" 的項目
            document.querySelectorAll('.menu-grid .menu-item[data-require="admin"]').forEach(el => {
                el.style.display = 'none';
            });
        }

        // ===== 混合精算獎金系統 =====
        async function loadHybridBonusData() {
            const yearEl = document.getElementById('bonusYear');
            const listEl = document.getElementById('bonusList');
            const loadingEl = document.getElementById('bonusLoading');
            const summaryEl = document.getElementById('bonusSummary');
            const actionsEl = document.getElementById('bonusActions');
            const matrixRefEl = document.getElementById('matrixRef');
            if (!yearEl || !listEl) return;
            const year = parseInt(yearEl.value);

            if (loadingEl) loadingEl.style.display = 'block';
            if (summaryEl) summaryEl.style.display = 'none';
            if (actionsEl) actionsEl.style.display = 'none';
            if (matrixRefEl) matrixRefEl.style.display = 'none';
            listEl.innerHTML = '';

            try {
                const [empRes, salaryRes, attRes, leaveRes] = await Promise.all([
                    sb.from('employees').select('id, name, employee_number, department, hire_date').eq('is_active', true).order('department').order('name'),
                    sb.from('salary_settings').select('employee_id, base_salary').eq('is_current', true),
                    sb.from('attendance').select('employee_id, is_late').gte('date', `${year}-01-01`).lte('date', `${year}-12-31`),
                    sb.from('leave_requests').select('employee_id, days').eq('status', 'approved').gte('start_date', `${year}-01-01`).lte('start_date', `${year}-12-31`)
                ]);
                if (empRes.error) throw empRes.error;

                const salaryMap = {};
                (salaryRes.data || []).forEach(s => { salaryMap[s.employee_id] = s.base_salary; });
                const lateMap = {};
                (attRes.data || []).forEach(a => { if (!lateMap[a.employee_id]) lateMap[a.employee_id] = 0; if (a.is_late) lateMap[a.employee_id]++; });
                const leaveMap = {};
                (leaveRes.data || []).forEach(l => { if (!leaveMap[l.employee_id]) leaveMap[l.employee_id] = 0; leaveMap[l.employee_id] += (parseFloat(l.days) || 0); });

                const yearEnd = new Date(year, 11, 31);
                const today = new Date();
                const cutoffDate = yearEnd < today ? yearEnd : today; // 年度已結束用年底，未結束用今天
                bonusEmployees = (empRes.data || []).map(emp => {
                    const baseSalary = salaryMap[emp.id] || 0;
                    const lateCount = lateMap[emp.id] || 0;
                    const leaveDays = leaveMap[emp.id] || 0;
                    let tenureRatio = 1.0;
                    if (emp.hire_date) {
                        const hireDate = new Date(emp.hire_date);
                        const days = Math.max(0, (cutoffDate - hireDate) / 86400000);
                        tenureRatio = Math.min(days / 365, 1.0);
                    }
                    let attendanceGrade = 'B';
                    if (lateCount === 0 && leaveDays === 0) attendanceGrade = 'A';
                    else if (lateCount >= 3 || leaveDays >= 3) attendanceGrade = 'C';

                    return { id: emp.id, name: emp.name, employeeNumber: emp.employee_number, department: emp.department, hireDate: emp.hire_date, baseSalary, lateCount, leaveDays, tenureRatio, attendanceGrade, perfRating: bonusPerformance[emp.id] || 'A' };
                });

                populateBonusEmpDropdown();
                renderSelectedBonusCard();
                updateBonusSummary();
                renderMatrixRefTable();
                if (loadingEl) loadingEl.style.display = 'none';
                if (summaryEl) summaryEl.style.display = 'block';
                if (actionsEl) actionsEl.style.display = 'block';
                if (matrixRefEl) matrixRefEl.style.display = 'block';
                document.getElementById('bonusEmpSelect').style.display = 'block';
            } catch (err) {
                console.error('Bonus load failed:', err);
                if (loadingEl) loadingEl.style.display = 'none';
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗: ' + escapeHTML(friendlyError(err)) + '</p>';
            }
        }

        function calculateBonus(emp) {
            const perfRating = bonusPerformance[emp.id] || emp.perfRating || 'A';
            const manualAdj = bonusAdjustments[emp.id] || 0;
            const multiplier = BONUS_MATRIX[perfRating]?.[emp.attendanceGrade] ?? 1.0;
            const baseAmount = Math.round(emp.baseSalary * emp.tenureRatio * multiplier);
            const fullAtt = emp.attendanceGrade === 'A' ? FULL_ATTENDANCE_BONUS : 0;
            const latePen = emp.lateCount * LATE_PENALTY_PER;
            const finalAmount = Math.max(0, baseAmount + fullAtt - latePen + manualAdj);
            return { perfRating, multiplier, baseAmount, fullAtt, latePen, manualAdj, finalAmount };
        }

        function populateBonusEmpDropdown() {
            const sel = document.getElementById('bonusEmpDropdown');
            if (!sel) return;
            const prev = sel.value;
            sel.innerHTML = '<option value="_all">📋 全部員工總覽</option>';
            bonusEmployees.forEach(emp => {
                const c = calculateBonus(emp);
                sel.innerHTML += `<option value="${emp.id}">${escapeHTML(emp.name)}（${escapeHTML(emp.department || '-')}）— $${c.finalAmount.toLocaleString()}</option>`;
            });
            if (prev && sel.querySelector(`option[value="${prev}"]`)) sel.value = prev;
        }

        function renderSelectedBonusCard() {
            const listEl = document.getElementById('bonusList');
            const sel = document.getElementById('bonusEmpDropdown');
            if (!listEl || !sel) return;
            if (bonusEmployees.length === 0) { listEl.innerHTML = '<p style="text-align:center;color:#999;">無員工資料</p>'; return; }

            const selectedId = sel.value;
            if (selectedId === '_all') { renderAllBonusSummaryTable(); return; }

            const emp = bonusEmployees.find(e => e.id === selectedId);
            if (!emp) { listEl.innerHTML = ''; return; }
            const c = calculateBonus(emp);

            listEl.innerHTML = `
            <div class="bonus-card grade-${emp.attendanceGrade}">
                <div class="bonus-card-header">
                    <div><span class="bonus-card-name">${escapeHTML(emp.name)}</span><span class="bonus-card-dept">${escapeHTML(emp.department || '-')} (${escapeHTML(emp.employeeNumber)})</span></div>
                    <span class="bonus-grade-badge bonus-grade-${emp.attendanceGrade}">出勤 ${emp.attendanceGrade} (${GRADE_LABELS[emp.attendanceGrade]})</span>
                </div>
                <div class="bonus-data-grid">
                    <div><span class="label">遲到</span></div><div><span class="value">${emp.lateCount} 次</span></div>
                    <div><span class="label">請假</span></div><div><span class="value">${emp.leaveDays} 天</span></div>
                    <div><span class="label">底薪</span></div><div><span class="value">$${(emp.baseSalary || 0).toLocaleString()}</span></div>
                    <div><span class="label">年資比例</span></div><div><span class="value">${(emp.tenureRatio * 100).toFixed(0)}%</span></div>
                </div>
                <div class="bonus-controls" style="margin-bottom:10px;">
                    <label style="font-size:12px;font-weight:700;color:#4b5563;white-space:nowrap;">績效評等</label>
                    <select onchange="updatePerformance('${emp.id}', this.value)">
                        ${['S','A','B'].map(r => '<option value="' + r + '"' + (c.perfRating === r ? ' selected' : '') + '>' + r + ' (' + PERF_LABELS[r] + ')</option>').join('')}
                    </select>
                    <span style="font-size:13px;font-weight:800;color:#4F46E5;white-space:nowrap;">x${c.multiplier}</span>
                </div>
                <div class="bonus-breakdown">
                    <div class="row" style="font-size:11px;color:#94A3B8;padding-bottom:6px;">
                        <span><a href="salary.html" style="color:#4F46E5;text-decoration:underline;">底薪$${(emp.baseSalary||0).toLocaleString()}</a> x <a onclick="showPage('employeePage')" style="color:#4F46E5;text-decoration:underline;cursor:pointer;">年資${(emp.tenureRatio*100).toFixed(0)}%</a> x 倍率${c.multiplier}</span>
                        <span>$${c.baseAmount.toLocaleString()}</span>
                    </div>
                    ${c.fullAtt > 0 ? '<div class="row"><span class="plus">+ 全勤獎金</span><span class="plus">+$' + c.fullAtt.toLocaleString() + '</span></div>' : ''}
                    ${c.latePen > 0 ? '<div class="row"><span class="minus">- 遲到扣款 (' + emp.lateCount + 'x$' + LATE_PENALTY_PER + ')</span><span class="minus">-$' + c.latePen.toLocaleString() + '</span></div>' : ''}
                    ${c.manualAdj !== 0 ? '<div class="row"><span>' + (c.manualAdj > 0 ? '+' : '') + ' 手動調整</span><span>' + (c.manualAdj > 0 ? '+' : '') + '$' + c.manualAdj.toLocaleString() + '</span></div>' : ''}
                    <div class="row total"><span>最終金額</span><span>$${c.finalAmount.toLocaleString()}</span></div>
                </div>
                <div class="bonus-controls">
                    <label style="font-size:12px;font-weight:700;color:#4b5563;white-space:nowrap;">手動調整</label>
                    <input type="text" inputmode="numeric" placeholder="±金額" value="${c.manualAdj ? c.manualAdj.toLocaleString() : ''}" onchange="updateAdjustment('${emp.id}', this.value)">
                </div>
            </div>`;
        }

        function renderAllBonusSummaryTable() {
            const listEl = document.getElementById('bonusList');
            if (!listEl) return;
            let html = '<div style="overflow-x:auto;"><table class="matrix-table"><thead><tr><th style="text-align:left;">姓名</th><th>出勤</th><th>績效</th><th>倍率</th><th style="text-align:right;">獎金</th></tr></thead><tbody>';
            bonusEmployees.forEach(emp => {
                const c = calculateBonus(emp);
                html += `<tr style="cursor:pointer;" onclick="document.getElementById('bonusEmpDropdown').value='${emp.id}';renderSelectedBonusCard();">
                    <td style="text-align:left;font-weight:700;">${escapeHTML(emp.name)}</td>
                    <td><span class="bonus-grade-badge bonus-grade-${emp.attendanceGrade}" style="font-size:10px;padding:2px 6px;">${emp.attendanceGrade}</span></td>
                    <td>${c.perfRating}</td>
                    <td>x${c.multiplier}</td>
                    <td style="text-align:right;font-weight:700;">$${c.finalAmount.toLocaleString()}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            listEl.innerHTML = html;
        }

        function updatePerformance(empId, rating) {
            bonusPerformance[empId] = rating;
            populateBonusEmpDropdown();
            renderSelectedBonusCard();
            updateBonusSummary();
        }
        function updateAdjustment(empId, value) {
            const val = parseMoney(value);
            bonusAdjustments[empId] = val;
            populateBonusEmpDropdown();
            renderSelectedBonusCard();
            updateBonusSummary();
        }
        function updateBonusSummary() {
            let total = 0, count = 0;
            bonusEmployees.forEach(emp => { const c = calculateBonus(emp); if (c.finalAmount > 0) { count++; total += c.finalAmount; } });
            document.getElementById('eligibleCount').textContent = count;
            document.getElementById('totalBudget').textContent = `$${total.toLocaleString()}`;
            document.getElementById('avgBonus').textContent = count > 0 ? `$${Math.round(total / count).toLocaleString()}` : '$0';
        }
        function toggleMatrixRef() {
            const body = document.getElementById('matrixRefBody');
            const arrow = document.getElementById('matrixRefArrow');
            if (body.style.display === 'none') { body.style.display = 'block'; arrow.textContent = '▲'; }
            else { body.style.display = 'none'; arrow.textContent = '▼'; }
        }
        function renderMatrixRefTable() {
            const el = document.getElementById('matrixRefBody');
            if (!el) return;
            let html = '<table class="matrix-table"><thead><tr><th>績效＼出勤</th>';
            ['A','B','C'].forEach(g => { html += `<th>${g} (${GRADE_LABELS[g]})</th>`; });
            html += '</tr></thead><tbody>';
            ['S','A','B'].forEach(p => {
                html += `<tr><th>${p} (${PERF_LABELS[p]})</th>`;
                ['A','B','C'].forEach(g => { html += `<td>${BONUS_MATRIX[p][g]}x</td>`; });
                html += '</tr>';
            });
            html += '</tbody></table><div style="font-size:11px;color:#94A3B8;">公式: 底薪 x 年資比 x 矩陣倍率 + 全勤$3,000(A級) - 遲到$200/次 + 手動調整</div>';
            el.innerHTML = html;
        }

        async function saveAllBonuses() {
            const yearEl = document.getElementById('bonusYear');
            if (!yearEl) return;
            const year = parseInt(yearEl.value);
            const btn = document.getElementById('saveAllBonusBtn');
            if (!confirm(`確定要儲存 ${year} 年全部員工的獎金資料？`)) return;
            setBtnLoading(btn, true);
            try {
                const records = bonusEmployees.map(emp => {
                    const c = calculateBonus(emp);
                    return {
                        employee_id: emp.id, year,
                        calculated_bonus: c.baseAmount,
                        adjusted_bonus: c.finalAmount,
                        final_bonus: c.finalAmount,
                        manager_adjustment: c.manualAdj,
                        months_worked: Math.round(emp.tenureRatio * 12 * 10) / 10,
                        is_approved: true,
                        status: 'approved',
                        ai_recommendation: JSON.stringify({ attendance_grade: emp.attendanceGrade, performance_rating: c.perfRating, matrix_multiplier: c.multiplier, full_attendance_bonus: c.fullAtt, late_penalty: c.latePen, base_salary: emp.baseSalary, tenure_ratio: emp.tenureRatio }),
                        updated_at: new Date().toISOString()
                    };
                });
                const { error } = await sb.from('annual_bonus').upsert(records, { onConflict: 'employee_id,year' });
                if (error) throw error;
                writeAuditLog('save_bonus', 'annual_bonus', null, `${year}年獎金`, { count: records.length, total: records.reduce((s, r) => s + r.final_bonus, 0) });
                showToast(`✅ 已儲存 ${records.length} 筆獎金資料`);
            } catch (err) {
                console.error('Save bonus failed:', err);
                showToast('❌ 儲存失敗: ' + friendlyError(err));
            } finally {
                setBtnLoading(btn, false, '💾 儲存全部獎金');
            }
        }

        function exportBonusCSV() {
            const yearEl = document.getElementById('bonusYear');
            if (!yearEl) return;
            const year = parseInt(yearEl.value);
            const rows = [['工號','姓名','部門','底薪','年資比','出勤等級','績效評等','矩陣倍數','基本獎金','全勤獎金','遲到扣款','手動調整','最終獎金']];
            bonusEmployees.forEach(emp => {
                const c = calculateBonus(emp);
                rows.push([emp.employeeNumber, emp.name, emp.department || '-', emp.baseSalary, (emp.tenureRatio * 100).toFixed(0) + '%', emp.attendanceGrade + '(' + GRADE_LABELS[emp.attendanceGrade] + ')', c.perfRating + '(' + PERF_LABELS[c.perfRating] + ')', c.multiplier, c.baseAmount, c.fullAtt, c.latePen, c.manualAdj, c.finalAmount]);
            });
            const csv = '\uFEFF' + rows.map(r => r.map(c => `"${String(c ?? '').replace(/"/g, '""')}"`).join(',')).join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            a.download = `獎金試算_${year}.csv`;
            a.click();
            showToast(`✅ 獎金試算_${year}.csv（${rows.length - 1} 筆）`);
        }

        // 員工 Modal
        function showAddEmployeeModal() {
            document.getElementById('addEmployeeModal').style.display = 'flex';
            document.getElementById('newEmployeeHireDate').value = fmtDate(new Date());
        }

        function closeAddEmployeeModal() {
            document.getElementById('addEmployeeModal').style.display = 'none';
            document.getElementById('addEmployeeForm').reset();
        }

        // 新增員工
        document.getElementById('addEmployeeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const employeeData = {
                name: document.getElementById('newEmployeeName').value.trim(),
                employee_number: document.getElementById('newEmployeeNumber').value.trim(),
                department: document.getElementById('newEmployeeDepartment').value,
                position: document.getElementById('newEmployeePosition').value.trim() || '員工',
                id_card_last_4: document.getElementById('newEmployeeCode').value.trim(),
                hire_date: document.getElementById('newEmployeeHireDate').value,
                role: document.getElementById('newEmployeeRole').value,
                is_active: true,
                company_id: '8a669e2c-7521-43e9-9300-5c004c57e9db',
                created_at: new Date().toISOString()
            };

            if (!employeeData.name || !employeeData.employee_number || !employeeData.id_card_last_4) {
                showToast('⚠️ 請填寫所有必填欄位');
                return;
            }
            
            try {
                const { data, error } = await sb.from('employees').insert([employeeData]);
                if (error) throw error;
                
                showToast('✅ 員工新增成功！');
                closeAddEmployeeModal();
                loadEmployeeList();
            } catch (err) {
                console.error('新增員工失敗:', err);
                showToast('❌ 新增失敗: ' + friendlyError(err));
            }
        });

        // QR Code
        function showJoinQRCode() {
            const modal = document.getElementById('qrModal');
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';
            
            const liffUrl = `https://liff.line.me/${CONFIG.LIFF_ID}?type=bind&company=HR_SYSTEM_001`;
            
            new QRCode(qrcodeDiv, {
                text: liffUrl, width: 200, height: 200,
                colorDark: "#1f2937", colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            modal.style.display = 'flex';
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // 點擊背景關閉 Modal
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // 載入員工列表
        async function loadEmployeeList() {
            const listEl = document.getElementById('employeeList');
            if (!listEl) return;

            try {
                const { data, error } = await sb.from('employees')
                    .select('*')
                    .eq('is_active', true)
                    .order('department', { ascending: true });

                if (error) throw error;

                const roleNames = { 'admin': '管理員', 'manager': '主管', 'user': '一般員工' };

                let html = '';
                data.forEach(emp => {
                    html += `
                        <div class="attendance-item">
                            <div class="date">
                                <div style="display:flex; align-items:center; flex-wrap:wrap; gap:4px;">
                                    <span>${emp.name} - ${emp.employee_number}</span>
                                    <span class="role-${emp.role || 'user'}" style="
                                        padding: 3px 10px; border-radius: 15px; font-size: 11px;
                                        display: inline-block; font-weight: bold;">
                                        ${roleNames[emp.role] || '未知'}
                                    </span>
                                </div>
                            </div>
                            <div class="details">
                                <span>${emp.department || '-'} · ${emp.position || '-'}</span>
                                <span style="font-size:12px;">驗證碼: ${emp.id_card_last_4 || '未設定'}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                到職: ${emp.hire_date || '未設定'} · ${emp.employment_type === 'parttime' ? '兼職' : '正職'} · ${emp.line_user_id ? '✅ 已綁定' : '⏳ 未綁定'}
                            </div>
                            <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
                                <button onclick="openEditEmployeeModal('${emp.id}')" style="padding:7px 12px;border:1px solid #E5E7EB;border-radius:8px;background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:#4F46E5;">✏️ 編輯</button>
                                ${emp.line_user_id ? `
                                    <button onclick="updateEmployeeRoleAdmin('${emp.id}', '${emp.role === 'admin' ? 'user' : 'admin'}', '${escapeHTML(emp.name)}')" style="padding:7px 12px;border:1px solid #E5E7EB;border-radius:8px;background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:#EA580C;">
                                        ${emp.role === 'admin' ? '取消管理員' : '設為管理員'}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                listEl.innerHTML = html || '<p style="text-align:center;color:#999;">無員工資料</p>';

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗</p>';
            }
        }

        // [BUG FIX] 整合角色更新函數，避免重複定義
        async function updateEmployeeRoleAdmin(employeeId, newRole, employeeName) {
            const roleNames = { 'admin': '管理員', 'manager': '主管', 'user': '一般員工' };
            
            try {
                const { error } = await sb.from('employees')
                    .update({ role: newRole })
                    .eq('id', employeeId);
                
                if (error) throw error;
                showToast(`✅ ${employeeName} → ${roleNames[newRole]}`);
                loadEmployeeList();
            } catch (err) {
                console.error(err);
                showToast('❌ 更新失敗: ' + friendlyError(err));
            }
        }

        // 搜尋員工
        function searchEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            const items = document.querySelectorAll('#employeeList .attendance-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // ===== 薪資設定 Modal =====
        let currentSalaryEmpId = null;

        async function openSalarySettingModal(empId, empName) {
            currentSalaryEmpId = empId;
            document.getElementById('salarySettingEmpName').textContent = empName + ' 的薪資設定';
            // 清空
            document.getElementById('ssSalaryType').value = 'monthly';
            document.getElementById('ssBaseSalary').value = '';
            document.getElementById('ssMealAllowance').value = '0';
            document.getElementById('ssPositionAllowance').value = '0';
            document.getElementById('ssFullAttBonus').value = '0';
            document.getElementById('ssPensionRate').value = '0';
            onSalaryTypeChange();
            // 套用千分位格式化
            ['ssBaseSalary','ssMealAllowance','ssPositionAllowance','ssFullAttBonus'].forEach(id => {
                formatMoneyInput(document.getElementById(id));
            });
            // 讀取現有設定
            try {
                const { data } = await sb.from('salary_settings')
                    .select('*')
                    .eq('employee_id', empId)
                    .eq('is_current', true)
                    .maybeSingle();
                if (data) {
                    document.getElementById('ssSalaryType').value = data.salary_type || 'monthly';
                    document.getElementById('ssBaseSalary').value = toMoneyStr(data.base_salary) || '';
                    document.getElementById('ssMealAllowance').value = toMoneyStr(data.meal_allowance || 0);
                    document.getElementById('ssPositionAllowance').value = toMoneyStr(data.position_allowance || 0);
                    document.getElementById('ssFullAttBonus').value = toMoneyStr(data.full_attendance_bonus || 0);
                    document.getElementById('ssPensionRate').value = data.pension_self_rate || 0;
                    onSalaryTypeChange();
                }
            } catch(e) {}
            document.getElementById('salarySettingModal').style.display = 'flex';
        }

        function closeSalarySettingModal() {
            document.getElementById('salarySettingModal').style.display = 'none';
            currentSalaryEmpId = null;
        }

        function onSalaryTypeChange() {
            const t = document.getElementById('ssSalaryType').value;
            const labels = { monthly: '基本月薪', daily: '基本日薪', hourly: '基本時薪' };
            document.getElementById('ssBaseLabel').textContent = labels[t] || '基本月薪';
        }

        async function saveSalarySetting() {
            if (!currentSalaryEmpId) return;
            const base = parseMoney(document.getElementById('ssBaseSalary').value);
            if (!base || base <= 0) { showToast('⚠️ 請輸入基本薪資'); return; }

            const record = {
                employee_id: currentSalaryEmpId,
                salary_type: document.getElementById('ssSalaryType').value,
                base_salary: base,
                meal_allowance: parseMoney(document.getElementById('ssMealAllowance').value),
                position_allowance: parseMoney(document.getElementById('ssPositionAllowance').value),
                full_attendance_bonus: parseMoney(document.getElementById('ssFullAttBonus').value),
                pension_self_rate: parseFloat(document.getElementById('ssPensionRate').value) || 0,
                is_current: true,
                updated_at: new Date().toISOString()
            };

            try {
                // 先將舊的設為非當前
                await sb.from('salary_settings').update({ is_current: false }).eq('employee_id', currentSalaryEmpId).eq('is_current', true);
                // 新增當前設定
                const { error } = await sb.from('salary_settings').insert(record);
                if (error) throw error;
                showToast('✅ 薪資設定已儲存');
                closeSalarySettingModal();
                if (typeof loadSalarySettingList === 'function') loadSalarySettingList();
                if (typeof writeAuditLog === 'function') writeAuditLog('update_salary_setting', { employee_id: currentSalaryEmpId, base_salary: base });
            } catch(e) {
                showToast('❌ 儲存失敗: ' + friendlyError(e));
            }
        }

        // ===== 編輯員工 Modal =====
        async function openEditEmployeeModal(empId) {
            document.getElementById('editEmpId').value = empId;
            try {
                const { data } = await sb.from('employees').select('*').eq('id', empId).single();
                if (data) {
                    document.getElementById('editEmpName').value = data.name || '';
                    document.getElementById('editEmpDept').value = data.department || '管理部';
                    document.getElementById('editEmpPosition').value = data.position || '';
                    document.getElementById('editEmpHireDate').value = data.hire_date || '';
                    document.getElementById('editEmpType').value = data.employment_type || 'fulltime';
                }
            } catch(e) {}
            document.getElementById('editEmployeeModal').style.display = 'flex';
        }

        function closeEditEmployeeModal() {
            document.getElementById('editEmployeeModal').style.display = 'none';
        }

        async function saveEditEmployee() {
            const empId = document.getElementById('editEmpId').value;
            if (!empId) return;
            const updates = {
                name: document.getElementById('editEmpName').value.trim(),
                department: document.getElementById('editEmpDept').value,
                position: document.getElementById('editEmpPosition').value.trim(),
                hire_date: document.getElementById('editEmpHireDate').value,
                employment_type: document.getElementById('editEmpType').value
            };
            if (!updates.name) { showToast('⚠️ 姓名不可為空'); return; }
            try {
                const { error } = await sb.from('employees').update(updates).eq('id', empId);
                if (error) throw error;
                showToast('✅ 員工資料已更新');
                closeEditEmployeeModal();
                loadEmployeeList();
            } catch(e) {
                showToast('❌ 更新失敗: ' + friendlyError(e));
            }
        }

        // 請假審核
        function switchLeaveTab(status) {
            document.querySelectorAll('#leaveApprovalPage .tab-btn').forEach(btn => {
                btn.className = 'tab-btn inactive';
            });
            event.target.className = 'tab-btn active';
            loadLeaveApprovals(status);
        }

        async function loadLeaveApprovals(status) {
            const listEl = document.getElementById('leaveApprovalList');
            if (!listEl) return;

            try {
                const { data, error } = await sb.from('leave_requests')
                    .select(`*, employees!leave_requests_employee_id_fkey(name, employee_number, department)`)
                    .eq('status', status)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const typeMap = { 'annual': '特休', 'sick': '病假', 'personal': '事假', 'compensatory': '補休' };
                const statusText = { 'pending': '待審核', 'approved': '已通過', 'rejected': '已拒絕' };

                let html = '';
                (data || []).forEach(request => {
                    html += `
                        <div class="attendance-item">
                            <div class="date">
                                <span>${request.employees?.name || '未知'} - ${typeMap[request.leave_type] || request.leave_type}</span>
                                <span style="font-size:12px;color:#999;">${request.created_at?.split('T')[0] || ''}</span>
                            </div>
                            <div class="details">
                                <span>${request.start_date} ~ ${request.end_date}</span>
                                <span>${request.employees?.department || '-'}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                ${request.reason || '無原因'}
                            </div>
                            ${request.status === 'rejected' && request.rejection_reason ? `
                                <div style="font-size:12px;color:#DC2626;margin-top:6px;padding:8px 10px;background:#FEF2F2;border-radius:8px;">
                                    ❌ 拒絕原因：${request.rejection_reason}
                                </div>
                            ` : ''}
                            ${status === 'pending' ? `
                                <div style="margin-top:8px;display:flex;gap:6px;">
                                    <button class="btn-success" onclick="approveLeave('${request.id}', 'approved')" style="flex:1;font-size:12px;padding:8px;border:none;border-radius:8px;cursor:pointer;">
                                        ✅ 通過
                                    </button>
                                    <button class="btn-danger" onclick="approveLeave('${request.id}', 'rejected')" style="flex:1;font-size:12px;padding:8px;">
                                        ❌ 拒絕
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                listEl.innerHTML = html || `<p style="text-align:center;color:#999;">無${statusText[status] || ''}的請假申請</p>`;

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗</p>';
            }
        }

        async function approveLeave(requestId, newStatus) {
            // 拒絕時要求填原因
            let rejectionReason = null;
            if (newStatus === 'rejected') {
                rejectionReason = prompt('請輸入拒絕原因（選填）：');
                if (rejectionReason === null) return; // 按取消 = 不操作
            }

            try {
                const updateData = { 
                    status: newStatus,
                    approver_id: currentAdminEmployee.id,
                    approved_at: new Date().toISOString()
                };
                if (newStatus === 'rejected') {
                    updateData.rejection_reason = rejectionReason || '不符合規定';
                }

                // 先查請假資訊（用於通知）
                const { data: reqData } = await sb.from('leave_requests')
                    .select('*, employees(name, id)')
                    .eq('id', requestId).single();

                const { error } = await sb.from('leave_requests')
                    .update(updateData)
                    .eq('id', requestId);

                if (error) throw error;

                // LINE Notify 通知員工
                if (reqData?.employees?.id) {
                    const typeMap = { annual:'特休', sick:'病假', personal:'事假', compensatory:'補休' };
                    const typeName = typeMap[reqData.leave_type] || reqData.leave_type;
                    if (newStatus === 'approved') {
                        sendUserNotify(reqData.employees.id, `✅ 您的${typeName}申請已通過\n📅 ${reqData.start_date} ~ ${reqData.end_date}`);
                    } else {
                        sendUserNotify(reqData.employees.id, `❌ 您的${typeName}申請已被拒絕\n📅 ${reqData.start_date} ~ ${reqData.end_date}\n原因：${updateData.rejection_reason}`);
                    }
                }

                showToast(`✅ 請假申請已${newStatus === 'approved' ? '通過' : '拒絕'}`);
                writeAuditLog(newStatus === 'approved' ? 'approve' : 'reject', 'leave_requests', requestId, reqData?.employees?.name);
                loadLeaveApprovals('pending');

            } catch (err) {
                console.error(err);
                showToast('❌ 審核失敗: ' + friendlyError(err));
            }
        }

        // ===== 人力管理 — 頁籤切換 =====
        function switchStaffTab(tab) {
            document.querySelectorAll('.staffTabContent').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.smTab').forEach(btn => {
                btn.style.background = 'transparent'; btn.style.color = '#94A3B8'; btn.style.boxShadow = 'none';
            });
            const tabEl = document.getElementById({ shift:'tabShift', leave:'tabLeave', setting:'tabSetting' }[tab]);
            if (tabEl) tabEl.style.display = 'block';
            const btns = document.querySelectorAll('.smTab');
            const idx = { shift:0, leave:1, setting:2 }[tab];
            if (btns[idx]) { btns[idx].style.background = '#fff'; btns[idx].style.color = '#4F46E5'; btns[idx].style.boxShadow = '0 1px 4px rgba(0,0,0,0.08)'; }
            if (tab === 'leave') loadLeaveCal();
            if (tab === 'shift') loadShiftMgr();
            if (tab === 'setting') { loadMaxLeaveSetting(); loadStaffOverview(); }
        }

        // ===== 人力設定 =====
        let maxLeaveValue = 2;

        function adjustMaxLeave(d) {
            maxLeaveValue = Math.max(1, Math.min(10, maxLeaveValue + d));
            document.getElementById('maxLeaveNum').textContent = maxLeaveValue;
        }

        async function loadMaxLeaveSetting() {
            try {
                const { data } = await sb.from('system_settings').select('value').eq('key', 'max_concurrent_leave').maybeSingle();
                if (data?.value?.max) { maxLeaveValue = data.value.max; }
            } catch(e) {}
            document.getElementById('maxLeaveNum').textContent = maxLeaveValue;
        }

        async function saveMaxLeave() {
            const statusEl = document.getElementById('maxLeaveSaveStatus');
            try {
                const { data: existing } = await sb.from('system_settings').select('id').eq('key', 'max_concurrent_leave').maybeSingle();
                const val = { max: maxLeaveValue };
                if (existing) {
                    await sb.from('system_settings').update({ value: val, updated_at: new Date().toISOString() }).eq('key', 'max_concurrent_leave');
                } else {
                    await sb.from('system_settings').insert({ key: 'max_concurrent_leave', value: val, description: '同時請假人數上限' });
                }
                statusEl.style.display = 'block'; statusEl.style.color = '#059669'; statusEl.textContent = '✅ 已儲存';
                setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
            } catch(e) {
                statusEl.style.display = 'block'; statusEl.style.color = '#DC2626'; statusEl.textContent = '❌ 儲存失敗';
            }
        }

        // ===== 排班模式設定 =====
        let currentSchedulingMode = 'shift'; // 預設排班制
        let fixedShiftStart = '08:00';
        let fixedShiftEnd = '17:00';

        async function loadSchedulingMode() {
            try {
                const { data } = await sb.from('system_settings').select('value').eq('key', 'scheduling_mode').maybeSingle();
                if (data?.value?.mode) { currentSchedulingMode = data.value.mode; }
                if (data?.value?.start) { fixedShiftStart = data.value.start; }
                if (data?.value?.end) { fixedShiftEnd = data.value.end; }
            } catch(e) {}
            const startEl = document.getElementById('fixedStartTime');
            const endEl = document.getElementById('fixedEndTime');
            if (startEl) startEl.value = fixedShiftStart;
            if (endEl) endEl.value = fixedShiftEnd;
            applySchedulingModeUI();
        }

        function selectSchedulingMode(mode) {
            currentSchedulingMode = mode;
            applySchedulingModeUI();
        }

        function setFixedPreset(start, end) {
            document.getElementById('fixedStartTime').value = start;
            document.getElementById('fixedEndTime').value = end;
            document.querySelectorAll('.fixedPresetBtn').forEach(b => { b.style.background = '#fff'; b.style.border = '1px solid #E5E7EB'; });
            event.target.closest('.fixedPresetBtn').style.background = '#EEF2FF';
            event.target.closest('.fixedPresetBtn').style.border = '2px solid #4F46E5';
        }

        function applySchedulingModeUI() {
            const shiftEl = document.getElementById('modeShift');
            const fixedEl = document.getElementById('modeFixed');
            const shiftLabel = document.getElementById('modeShiftLabel');
            const fixedLabel = document.getElementById('modeFixedLabel');
            const fixedConfig = document.getElementById('fixedShiftConfig');
            if (!shiftEl || !fixedEl) return;
            if (currentSchedulingMode === 'shift') {
                shiftEl.style.border = '2px solid #4F46E5'; shiftEl.style.background = '#EEF2FF';
                if (shiftLabel) shiftLabel.style.color = '#4F46E5';
                fixedEl.style.border = '2px solid #E5E7EB'; fixedEl.style.background = '#fff';
                if (fixedLabel) fixedLabel.style.color = '#94A3B8';
                if (fixedConfig) fixedConfig.style.display = 'none';
            } else {
                fixedEl.style.border = '2px solid #4F46E5'; fixedEl.style.background = '#EEF2FF';
                if (fixedLabel) fixedLabel.style.color = '#4F46E5';
                shiftEl.style.border = '2px solid #E5E7EB'; shiftEl.style.background = '#fff';
                if (shiftLabel) shiftLabel.style.color = '#94A3B8';
                if (fixedConfig) fixedConfig.style.display = 'block';
            }
            applyShiftTabMode();
        }

        function applyShiftTabMode() {
            const shiftContent = document.getElementById('tabShift');
            if (!shiftContent) return;
            let notice = document.getElementById('fixedModeNotice');
            if (currentSchedulingMode === 'fixed') {
                const st = document.getElementById('fixedStartTime')?.value || fixedShiftStart;
                const et = document.getElementById('fixedEndTime')?.value || fixedShiftEnd;
                if (!notice) {
                    notice = document.createElement('div');
                    notice.id = 'fixedModeNotice';
                    notice.style.cssText = 'background:#EEF2FF;border-radius:14px;padding:20px;text-align:center;';
                    shiftContent.insertBefore(notice, shiftContent.firstChild);
                }
                notice.innerHTML = '<div style="font-size:32px;margin-bottom:8px;">☀️</div>' +
                    '<div style="font-size:15px;font-weight:800;color:#4F46E5;margin-bottom:8px;">固定班制</div>' +
                    '<div style="font-size:13px;color:#64748B;line-height:1.6;">所有員工統一上班時間<br><b>' + st + ' - ' + et + '</b></div>' +
                    '<div style="font-size:11px;color:#94A3B8;margin-top:12px;">如需排班請至「人力設定」切換為排班制</div>';
                notice.style.display = 'block';
                Array.from(shiftContent.children).forEach(el => {
                    if (el.id !== 'fixedModeNotice') el.style.display = 'none';
                });
            } else {
                if (notice) notice.style.display = 'none';
                Array.from(shiftContent.children).forEach(el => {
                    if (el.id !== 'fixedModeNotice') el.style.display = '';
                });
            }
        }

        async function saveSchedulingMode() {
            const statusEl = document.getElementById('schedModeSaveStatus');
            try {
                const st = document.getElementById('fixedStartTime')?.value || '08:00';
                const et = document.getElementById('fixedEndTime')?.value || '17:00';
                fixedShiftStart = st; fixedShiftEnd = et;
                const { data: existing } = await sb.from('system_settings').select('id').eq('key', 'scheduling_mode').maybeSingle();
                const val = { mode: currentSchedulingMode, start: st, end: et };
                if (existing) {
                    await sb.from('system_settings').update({ value: val, updated_at: new Date().toISOString() }).eq('key', 'scheduling_mode');
                } else {
                    await sb.from('system_settings').insert({ key: 'scheduling_mode', value: val, description: '排班模式：shift=排班制, fixed=固定班' });
                }
                const modeLabel = currentSchedulingMode === 'shift' ? '排班制' : `固定班 ${st}-${et}`;
                statusEl.style.display = 'block'; statusEl.style.color = '#059669';
                statusEl.textContent = '✅ 已儲存 — ' + modeLabel;
                setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
                applyShiftTabMode();
                if (typeof writeAuditLog === 'function') writeAuditLog('update_scheduling_mode', val);
            } catch(e) {
                statusEl.style.display = 'block'; statusEl.style.color = '#DC2626'; statusEl.textContent = '❌ 儲存失敗';
            }
        }

        // ===== 便當管理員設定 =====
        let lunchManagerIds = [];

        async function loadLunchManagers() {
            try {
                const { data } = await sb.from('system_settings').select('value').eq('key', 'lunch_managers').maybeSingle();
                lunchManagerIds = data?.value?.employee_ids || [];
            } catch(e) { lunchManagerIds = []; }

            const sel = document.getElementById('lunchMgrSelect');
            if (!sel) return;
            try {
                const { data: emps } = await sb.from('employees').select('id, name, employee_number').eq('is_active', true).order('name');
                sel.innerHTML = '<option value="">-- 選擇員工 --</option>';
                (emps || []).forEach(e => {
                    if (!lunchManagerIds.includes(e.id)) {
                        sel.innerHTML += `<option value="${e.id}">${escapeHTML(e.name)}（${escapeHTML(e.employee_number)}）</option>`;
                    }
                });
            } catch(e) {}
            renderLunchManagerList();
        }

        function renderLunchManagerList() {
            const el = document.getElementById('lunchMgrList');
            if (!el) return;
            if (lunchManagerIds.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:12px;">尚未指定便當管理員</p>';
                return;
            }
            sb.from('employees').select('id, name, employee_number').in('id', lunchManagerIds).then(({ data }) => {
                if (!data || data.length === 0) { el.innerHTML = '<p style="color:#94A3B8;">無資料</p>'; return; }
                el.innerHTML = data.map(e => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #F1F5F9;">
                        <span>🍱 ${escapeHTML(e.name)}（${escapeHTML(e.employee_number)}）</span>
                        <button onclick="removeLunchManager('${e.id}')" style="font-size:12px;padding:4px 10px;border:1px solid #FCA5A5;border-radius:8px;background:#FEF2F2;color:#DC2626;cursor:pointer;">移除</button>
                    </div>
                `).join('');
            });
        }

        async function addLunchManager() {
            const sel = document.getElementById('lunchMgrSelect');
            if (!sel?.value) return showToast('請選擇員工');
            lunchManagerIds.push(sel.value);
            await saveLunchManagers();
            loadLunchManagers();
        }

        async function removeLunchManager(empId) {
            lunchManagerIds = lunchManagerIds.filter(id => id !== empId);
            await saveLunchManagers();
            loadLunchManagers();
        }

        async function saveLunchManagers() {
            try {
                const val = { employee_ids: lunchManagerIds };
                const { data: existing } = await sb.from('system_settings').select('id').eq('key', 'lunch_managers').maybeSingle();
                if (existing) {
                    await sb.from('system_settings').update({ value: val, updated_at: new Date().toISOString() }).eq('key', 'lunch_managers');
                } else {
                    await sb.from('system_settings').insert({ key: 'lunch_managers', value: val, description: '便當管理員名單' });
                }
                invalidateSettingsCache();
                showToast('✅ 便當管理員已更新');
            } catch(e) {
                showToast('❌ 儲存失敗');
            }
        }

        async function loadAdminLunchStats() {
            const el = document.getElementById('adminLunchStats');
            if (!el) return;
            const todayStr = getTaiwanDate(0);
            try {
                const { data } = await sb.from('lunch_orders')
                    .select('id, is_vegetarian, status')
                    .eq('order_date', todayStr);
                const orders = (data || []).filter(o => o.status === 'ordered');
                const veg = orders.filter(o => o.is_vegetarian).length;
                const regular = orders.filter(o => !o.is_vegetarian).length;
                const cancelled = (data || []).filter(o => o.status === 'cancelled').length;
                el.innerHTML = `
                    <div style="display:flex;gap:8px;">
                        <div style="flex:1;text-align:center;padding:12px;background:#ECFDF5;border-radius:10px;">
                            <div style="font-size:22px;font-weight:900;color:#059669;">${orders.length}</div>
                            <div style="font-size:11px;font-weight:600;color:#059669;">已訂購</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:12px;background:#EFF6FF;border-radius:10px;">
                            <div style="font-size:22px;font-weight:900;color:#2563EB;">${regular}</div>
                            <div style="font-size:11px;font-weight:600;color:#2563EB;">🍖 葷食</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:12px;background:#F5F3FF;border-radius:10px;">
                            <div style="font-size:22px;font-weight:900;color:#7C3AED;">${veg}</div>
                            <div style="font-size:11px;font-weight:600;color:#7C3AED;">🥗 素食</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:12px;background:#FEF2F2;border-radius:10px;">
                            <div style="font-size:22px;font-weight:900;color:#DC2626;">${cancelled}</div>
                            <div style="font-size:11px;font-weight:600;color:#DC2626;">🚫 不訂</div>
                        </div>
                    </div>`;
            } catch(e) { el.innerHTML = '<p style="color:#94A3B8;">載入失敗</p>'; }
        }

        async function loadStaffOverview() {
            const el = document.getElementById('staffOverview');
            if (!el) return;
            try {
                const { data: emps } = await sb.from('employees').select('id, is_active').eq('is_active', true);
                const total = emps?.length || 0;
                if (total === 0) {
                    el.innerHTML = `
                        <div style="text-align:center;padding:12px;">
                            <div style="font-size:14px;font-weight:700;color:#64748B;margin-bottom:8px;">目前沒有在職員工</div>
                            <button onclick="showPage('employeePage')" style="padding:10px 20px;border:none;border-radius:8px;background:#4F46E5;color:#fff;font-weight:700;font-size:13px;cursor:pointer;">👉 前往新增員工</button>
                        </div>`;
                    return;
                }
                const todayStr = getTaiwanDate();
                const { data: todayLeaves } = await sb.from('leave_requests').select('id')
                    .in('status', ['approved','pending'])
                    .lte('start_date', todayStr).gte('end_date', todayStr);
                const onLeave = todayLeaves?.length || 0;
                el.innerHTML = `
                    <div style="display:flex;gap:8px;margin-bottom:8px;">
                        <span style="padding:6px 12px;background:#ECFDF5;border-radius:8px;font-weight:700;color:#059669;">👥 在職 ${total} 人</span>
                        <span style="padding:6px 12px;background:#FFF7ED;border-radius:8px;font-weight:700;color:#EA580C;">🏖️ 今日請假 ${onLeave} 人</span>
                        <span style="padding:6px 12px;background:#EFF6FF;border-radius:8px;font-weight:700;color:#2563EB;">💪 今日可用 ${total - onLeave} 人</span>
                    </div>
                    <div style="font-size:12px;color:#94A3B8;">目前設定：同時最多 <b style="color:#DC2626;">${maxLeaveValue}</b> 人請假</div>
                `;
            } catch(e) { el.textContent = '載入失敗'; }
        }

        // ===== 休假月表 =====
        let lcYear, lcMonth;
        (function() { const n = new Date(); lcYear = n.getFullYear(); lcMonth = n.getMonth(); })();

        function changeLeaveCal(d) {
            lcMonth += d;
            if (lcMonth < 0) { lcMonth = 11; lcYear--; }
            if (lcMonth > 11) { lcMonth = 0; lcYear++; }
            loadLeaveCal();
        }
        function resetLeaveCal() {
            const n = new Date(); lcYear = n.getFullYear(); lcMonth = n.getMonth();
            loadLeaveCal();
        }

        async function loadLeaveCal() {
            document.getElementById('lcMonthLabel').textContent = `${lcYear}年 ${lcMonth + 1}月`;
            // Loading 狀態
            document.getElementById('lcBody').innerHTML = '<tr><td colspan="32" style="text-align:center;padding:30px;color:#94A3B8;font-size:13px;">⏳ 載入中...</td></tr>';
            document.getElementById('lcHead').innerHTML = '';
            const dim = new Date(lcYear, lcMonth + 1, 0).getDate();
            const ms = `${lcYear}-${String(lcMonth + 1).padStart(2, '0')}-01`;
            const me = `${lcYear}-${String(lcMonth + 1).padStart(2, '0')}-${dim}`;

            // 讀取上限
            let maxC = maxLeaveValue || 2;
            try {
                const { data: s } = await sb.from('system_settings').select('value').eq('key', 'max_concurrent_leave').maybeSingle();
                if (s?.value?.max) maxC = s.value.max;
            } catch(e) {}
            document.getElementById('lcMax').textContent = maxC;

            let employees = [], leaves = [];
            try {
                const { data: emps } = await sb.from('employees').select('id, name, department').eq('is_active', true).order('department').order('name');
                employees = emps || [];
                const { data: lvs } = await sb.from('leave_requests').select('employee_id, start_date, end_date, leave_type, status')
                    .in('status', ['approved', 'pending']).or(`and(start_date.lte.${me},end_date.gte.${ms})`);
                leaves = lvs || [];
            } catch(e) { console.error(e); }

            // 空狀態
            if (employees.length === 0) {
                document.getElementById('lcHead').innerHTML = '';
                document.getElementById('lcBody').innerHTML = `<tr><td style="text-align:center;padding:40px 20px;">
                    <div style="font-size:48px;margin-bottom:12px;">👥</div>
                    <div style="font-size:14px;font-weight:800;color:#0F172A;">尚無員工資料</div>
                    <div style="font-size:12px;color:#94A3B8;margin-top:6px;">請先到「員工管理」新增員工</div>
                </td></tr>`;
                document.getElementById('lcTotal').textContent = '0';
                document.getElementById('lcAvail').textContent = '0';
                document.getElementById('lcOverWarn').style.display = 'none';
                return;
            }

            const wd = ['日','一','二','三','四','五','六'];
            // 計算每天請假人數
            const dayCount = {};
            for (let d = 1; d <= dim; d++) {
                const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                dayCount[ds] = 0;
                leaves.forEach(l => { if (ds >= l.start_date && ds <= (l.end_date || l.start_date)) dayCount[ds]++; });
            }

            // 表頭
            let headHtml = '<tr><th style="position:sticky;left:0;background:#fff;z-index:2;padding:6px 8px;min-width:60px;text-align:left;border-bottom:2px solid #E5E7EB;font-size:11px;">姓名</th>';
            for (let d = 1; d <= dim; d++) {
                const dt = new Date(lcYear, lcMonth, d);
                const isW = dt.getDay()===0 || dt.getDay()===6;
                const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const over = dayCount[ds] >= maxC && !isW;
                const bg = over ? '#FEE2E2' : isW ? '#F1F5F9' : '#fff';
                headHtml += `<th style="padding:4px 2px;min-width:28px;text-align:center;border-bottom:2px solid ${over?'#FCA5A5':'#E5E7EB'};background:${bg};font-size:10px;">
                    <div style="${over?'color:#DC2626;font-weight:900;':''}">${d}</div><div style="color:#94A3B8;font-size:9px;">${wd[dt.getDay()]}</div>
                    ${over ? '<div style="font-size:8px;color:#DC2626;font-weight:900;">滿</div>' : ''}
                </th>`;
            }
            headHtml += '</tr>';
            document.getElementById('lcHead').innerHTML = headHtml;

            // 表身
            const typeColor = { annual:'#DBEAFE', sick:'#FEE2E2', personal:'#FEF3C7', compensatory:'#E0E7FF' };
            const typeEmoji = { annual:'🏖', sick:'🤒', personal:'📋', compensatory:'💤' };
            let totalLeaves = 0;
            const todayStr = getTaiwanDate();
            let todayAvail = employees.length;
            let overDays = [];

            let bodyHtml = '';
            employees.forEach(emp => {
                const empLeaves = leaves.filter(l => l.employee_id === emp.id);
                bodyHtml += `<tr><td style="position:sticky;left:0;background:#fff;z-index:1;padding:6px 8px;font-weight:700;font-size:11px;white-space:nowrap;border-bottom:1px solid #F1F5F9;">${emp.name}</td>`;
                for (let d = 1; d <= dim; d++) {
                    const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const dt = new Date(lcYear, lcMonth, d);
                    const isW = dt.getDay()===0 || dt.getDay()===6;
                    const lv = empLeaves.find(l => ds >= l.start_date && ds <= (l.end_date || l.start_date));
                    const over = dayCount[ds] > maxC && !isW;
                    if (lv) {
                        totalLeaves++;
                        if (ds === todayStr) todayAvail--;
                        const bg = over ? '#FCA5A5' : (typeColor[lv.leave_type] || '#F1F5F9');
                        const emoji = typeEmoji[lv.leave_type] || '📝';
                        const pending = lv.status === 'pending' ? 'opacity:0.6;' : '';
                        bodyHtml += `<td style="text-align:center;background:${bg};border-bottom:1px solid #F1F5F9;${pending}font-size:10px;cursor:default;" title="${emp.name} ${lv.leave_type}${lv.status==='pending'?' (待審)':''}${over?' ⚠超限':''}">${emoji}</td>`;
                    } else if (isW) {
                        bodyHtml += `<td style="background:#F8FAFC;border-bottom:1px solid #F1F5F9;"></td>`;
                    } else {
                        bodyHtml += `<td style="border-bottom:1px solid #F1F5F9;"></td>`;
                    }
                }
                bodyHtml += '</tr>';
            });

            // 底部統計列 — 每日請假人數
            bodyHtml += '<tr style="background:#F8FAFC;"><td style="position:sticky;left:0;background:#F8FAFC;z-index:1;padding:6px 8px;font-weight:700;font-size:10px;color:#64748B;">請假數</td>';
            for (let d = 1; d <= dim; d++) {
                const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dt = new Date(lcYear, lcMonth, d);
                const isW = dt.getDay()===0 || dt.getDay()===6;
                const cnt = dayCount[ds] || 0;
                const over = cnt >= maxC && !isW;
                if (over && !isW) overDays.push(`${lcMonth+1}/${d}`);
                bodyHtml += `<td style="text-align:center;font-size:10px;font-weight:900;color:${over?'#DC2626':cnt>0?'#EA580C':'#CBD5E1'};border-bottom:1px solid #F1F5F9;background:${over?'#FEF2F2':'#F8FAFC'};">${cnt||'-'}</td>`;
            }
            bodyHtml += '</tr>';

            document.getElementById('lcBody').innerHTML = bodyHtml;
            document.getElementById('lcTotal').textContent = totalLeaves;
            document.getElementById('lcAvail').textContent = Math.max(0, todayAvail);

            // 超限警告
            const warnEl = document.getElementById('lcOverWarn');
            if (overDays.length > 0) {
                warnEl.style.display = 'block';
                warnEl.innerHTML = `🚨 以下日期請假人數已達/超過上限（${maxC}人）：<br><b>${overDays.join('、')}</b><br><span style="font-size:11px;opacity:0.7;">員工在這些日期提交請假將被自動駁回</span>`;
            } else {
                warnEl.style.display = 'none';
            }
        }

        // ===== 薪資發放 =====
        let payrollEmployees = [];
        let payrollAdjustments = {};   // { empId: { amount: 0, note: '' } }
        let payrollBrackets = [];
        let payrollIsPublished = false;

        function initPayrollPage() {
            const yEl = document.getElementById('payrollYear');
            const mEl = document.getElementById('payrollMonth');
            if (yEl.options.length > 0) return; // already init
            const now = new Date();
            const cy = now.getFullYear();
            for (let y = cy; y >= cy - 2; y--) yEl.innerHTML += `<option value="${y}">${y} 年</option>`;
            for (let m = 1; m <= 12; m++) mEl.innerHTML += `<option value="${m}">${m} 月</option>`;
            // 預設上月
            const prev = new Date(cy, now.getMonth() - 1, 1);
            yEl.value = prev.getFullYear();
            mEl.value = prev.getMonth() + 1;

            loadSalarySettingList();
        }

        function toggleSalarySettingPanel() {
            const panel = document.getElementById('salarySettingPanel');
            const arrow = document.getElementById('salaryPanelArrow');
            if (panel.style.display === 'none') {
                panel.style.display = 'block'; arrow.textContent = '▲';
            } else {
                panel.style.display = 'none'; arrow.textContent = '▼';
            }
        }

        async function loadSalarySettingList() {
            const listEl = document.getElementById('salarySettingList');
            try {
                const [empRes, ssRes] = await Promise.all([
                    sb.from('employees').select('id, name, employee_number, department').eq('is_active', true).order('department'),
                    sb.from('salary_settings').select('employee_id, salary_type, base_salary').eq('is_current', true)
                ]);
                const ssMap = {};
                (ssRes.data || []).forEach(s => { ssMap[s.employee_id] = s; });
                const typeLabel = { monthly: '月薪', daily: '日薪', hourly: '時薪' };
                const emps = empRes.data || [];
                if (emps.length === 0) { listEl.innerHTML = '<p style="text-align:center;color:#94A3B8;">無員工</p>'; return; }

                listEl.innerHTML = emps.map(emp => {
                    const ss = ssMap[emp.id];
                    const salaryText = ss ? `${typeLabel[ss.salary_type] || '月薪'} ${formatNT(ss.base_salary)}` : '<span style="color:#EF4444;">未設定</span>';
                    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 4px;border-bottom:1px solid #F1F5F9;">
                        <div>
                            <span style="font-weight:600;">${escapeHTML(emp.name)}</span>
                            <span style="color:#94A3B8;font-size:11px;margin-left:4px;">${emp.department || ''}</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:12px;color:#64748B;">${salaryText}</span>
                            <button onclick="openSalarySettingModal('${emp.id}','${escapeHTML(emp.name)}')" style="padding:4px 10px;border:1px solid #D1FAE5;border-radius:6px;background:#ECFDF5;font-size:11px;font-weight:700;cursor:pointer;color:#059669;">設定</button>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) { listEl.innerHTML = '<p style="color:#EF4444;text-align:center;">載入失敗</p>'; console.error(e); }
        }

        async function loadPayrollData() {
            const year = parseInt(document.getElementById('payrollYear').value);
            const month = parseInt(document.getElementById('payrollMonth').value);
            const startDate = `${year}-${String(month).padStart(2,'0')}-01`;
            const endDay = new Date(year, month, 0).getDate();
            const endDate = `${year}-${String(month).padStart(2,'0')}-${String(endDay).padStart(2,'0')}`;

            // UI: show loading
            const loadEl = document.getElementById('payrollLoading');
            const sumEl = document.getElementById('payrollSummary');
            const selEl = document.getElementById('payrollEmpSelector');
            const actEl = document.getElementById('payrollActions');
            const contentEl = document.getElementById('payrollContent');
            const warnEl = document.getElementById('payrollPublishedWarn');
            loadEl.style.display = 'block';
            sumEl.style.display = 'none';
            selEl.style.display = 'none';
            actEl.style.display = 'none';
            contentEl.innerHTML = '';
            warnEl.style.display = 'none';
            payrollAdjustments = {};

            const btn = document.getElementById('calcPayrollBtn');
            const origText = btn.textContent;
            btn.disabled = true; btn.textContent = '⏳ 計算中...';

            try {
                // 平行查詢（OT 和保險級距用 catch 避免表不存在報錯）
                const [empRes, salaryRes, attRes, leaveRes, otRes, existRes, bracketRes] = await Promise.all([
                    sb.from('employees').select('id, name, employee_number, department, is_active').eq('is_active', true),
                    sb.from('salary_settings').select('*').eq('is_current', true),
                    sb.from('attendance').select('employee_id, date, is_late, total_work_hours, overtime_hours, check_in_time, check_out_time').gte('date', startDate).lte('date', endDate),
                    sb.from('leave_requests').select('employee_id, days, leave_type').eq('status', 'approved').gte('start_date', startDate).lte('end_date', endDate),
                    sb.from('overtime_requests').select('employee_id, hours, ot_date').eq('status', 'approved').gte('ot_date', startDate).lte('ot_date', endDate).then(r => r).catch(() => ({ data: [] })),
                    sb.from('payroll').select('*').eq('year', year).eq('month', month),
                    sb.from('insurance_brackets').select('*').eq('is_active', true).order('salary_min').then(r => r).catch(() => ({ data: [] }))
                ]);

                payrollBrackets = bracketRes.data || [];

                // Build lookup maps
                const salaryMap = {};
                (salaryRes.data || []).forEach(s => { salaryMap[s.employee_id] = s; });

                const attMap = {};
                (attRes.data || []).forEach(a => {
                    if (!attMap[a.employee_id]) attMap[a.employee_id] = [];
                    attMap[a.employee_id].push(a);
                });

                const leaveMap = {};
                (leaveRes.data || []).forEach(l => {
                    if (!leaveMap[l.employee_id]) leaveMap[l.employee_id] = { total: 0, personal: 0 };
                    leaveMap[l.employee_id].total += (l.days || 0);
                    if (l.leave_type === 'personal') leaveMap[l.employee_id].personal += (l.days || 0);
                });

                const otMap = {};
                if ((otRes.data || []).length > 0) {
                    // 從加班申請表取得核准加班時數
                    (otRes.data).forEach(o => {
                        otMap[o.employee_id] = (otMap[o.employee_id] || 0) + (o.hours || 0);
                    });
                } else {
                    // Fallback: 從 attendance.overtime_hours 累計
                    (attRes.data || []).forEach(a => {
                        if (a.overtime_hours > 0) {
                            otMap[a.employee_id] = (otMap[a.employee_id] || 0) + a.overtime_hours;
                        }
                    });
                }

                // 已存在的 payroll（載入手動調整）
                const existMap = {};
                (existRes.data || []).forEach(p => {
                    existMap[p.employee_id] = p;
                    if (p.manual_adjustment) {
                        payrollAdjustments[p.employee_id] = { amount: p.manual_adjustment || 0, note: p.adjustment_note || '' };
                    }
                });

                // 檢查是否已發布
                payrollIsPublished = (existRes.data || []).some(p => p.is_published);
                if (payrollIsPublished) warnEl.style.display = 'block';

                // 計算每位員工
                payrollEmployees = (empRes.data || []).map(emp => {
                    const ss = salaryMap[emp.id];
                    if (!ss) return null; // 無薪資設定 skip

                    const atts = attMap[emp.id] || [];
                    const leaves = leaveMap[emp.id] || { total: 0, personal: 0 };
                    const otHours = otMap[emp.id] || 0;

                    return calcEmployeePayroll(emp, ss, atts, leaves, otHours, year, month);
                }).filter(Boolean);

                // 渲染
                populatePayrollDropdown();
                renderPayrollSummary();
                renderPayrollView();

                loadEl.style.display = 'none';
                sumEl.style.display = 'block';
                selEl.style.display = 'block';
                actEl.style.display = 'flex';
            } catch(e) {
                loadEl.style.display = 'none';
                contentEl.innerHTML = `<p style="text-align:center;color:#DC2626;padding:20px;">❌ 計算失敗：${e.message}</p>`;
            } finally {
                btn.disabled = false; btn.textContent = origText;
            }
        }

        function prLookupBracket(salary) {
            if (payrollBrackets.length === 0) return null;
            const b = payrollBrackets.find(r => salary >= r.salary_min && salary <= r.salary_max);
            return b || payrollBrackets[payrollBrackets.length - 1];
        }

        function calcEmployeePayroll(emp, ss, atts, leaves, otHours, year, month) {
            const salaryType = ss.salary_type || 'monthly';
            const baseSalary = ss.base_salary || 0;
            const mealAllowance = ss.meal_allowance || 0;
            const posAllowance = ss.position_allowance || 0;
            const fullAttBonus = ss.full_attendance_bonus || 0;
            const pensionRate = ss.pension_self_rate || 0;
            const taxRate = ss.tax_rate || 5;

            // 出勤統計
            const actualDays = atts.filter(a => a.check_in_time).length;
            const lateCount = atts.filter(a => a.is_late).length;
            const totalWorkHours = atts.reduce((s, a) => s + (a.total_work_hours || 0), 0);
            const leaveDays = leaves.total;
            const personalLeaveDays = leaves.personal;

            // 底薪計算
            let monthSalary, dailyRate, hourlyRate;
            if (salaryType === 'monthly') {
                monthSalary = baseSalary;
                dailyRate = Math.round(baseSalary / 30);
                hourlyRate = Math.round(dailyRate / 8);
            } else if (salaryType === 'daily') {
                dailyRate = baseSalary;
                hourlyRate = Math.round(dailyRate / 8);
                monthSalary = dailyRate * actualDays;
            } else {
                hourlyRate = baseSalary;
                dailyRate = hourlyRate * 8;
                monthSalary = Math.round(hourlyRate * totalWorkHours);
            }

            // 津貼（暫以固定方式計算，TODO: 支援 daily mode）
            const mealAmount = mealAllowance;
            const posAmount = posAllowance;

            // 全勤獎金
            const hasFullAtt = (lateCount === 0 && leaveDays === 0);
            const fullAttAmount = hasFullAtt ? fullAttBonus : 0;

            // 加班費（台灣勞基法 §24）
            let otPay = 0;
            if (otHours > 0) {
                const h1 = Math.min(otHours, 2);
                const h2 = Math.max(Math.min(otHours - 2, 2), 0);
                otPay = Math.round(hourlyRate * 1.34 * h1) + Math.round(hourlyRate * 1.67 * h2);
            }

            // 總收入
            const gross = monthSalary + otPay + fullAttAmount + mealAmount + posAmount;

            // 保險
            const bracket = prLookupBracket(salaryType === 'monthly' ? baseSalary : monthSalary);
            let laborIns = 0, healthIns = 0;
            if (bracket) {
                laborIns = Math.round(bracket.insured_amount * (bracket.labor_rate || 0.125) * (bracket.labor_employee_share || 0.2));
                healthIns = Math.round(bracket.insured_amount * (bracket.health_rate || 0.0517) * (bracket.health_employee_share || 0.3));
            } else {
                laborIns = Math.round(monthSalary * 0.125 * 0.2);
                healthIns = Math.round(monthSalary * 0.0517 * 0.3);
            }

            // 勞退自提
            const pensionSelf = Math.round(monthSalary * pensionRate / 100);

            // 所得稅
            const incomeTax = Math.round(gross * taxRate / 100);

            // 遲到扣款（每次 100 元，可調整）
            const lateDed = lateCount * 100;

            // 事假扣款（日薪 × 天數）
            const personalLeaveDed = Math.round(dailyRate * personalLeaveDays);

            // 手動調整
            const adj = payrollAdjustments[emp.id]?.amount || 0;

            // 總扣款
            const totalDeduct = laborIns + healthIns + pensionSelf + incomeTax + lateDed + personalLeaveDed - adj;

            // 實發
            const net = gross - totalDeduct;

            return {
                employee_id: emp.id,
                name: emp.name,
                employee_number: emp.employee_number,
                department: emp.department || '',
                year, month,
                salary_type: salaryType,
                base_salary: monthSalary,
                overtime_pay: otPay,
                full_attendance_bonus: fullAttAmount,
                meal_allowance: mealAmount,
                position_allowance: posAmount,
                night_allowance: 0,
                late_deduction: lateDed,
                absence_deduction: 0,
                personal_leave_deduction: personalLeaveDed,
                labor_insurance: laborIns,
                health_insurance: healthIns,
                pension_self: pensionSelf,
                income_tax: incomeTax,
                manual_adjustment: adj,
                adjustment_note: payrollAdjustments[emp.id]?.note || '',
                total_deduction: totalDeduct,
                gross_salary: gross,
                net_salary: net,
                calculation_details: {
                    salary_type: salaryType,
                    original_base: baseSalary,
                    actual_days: actualDays,
                    late_count: lateCount,
                    leave_days: leaveDays,
                    personal_leave_days: personalLeaveDays,
                    overtime_hours: otHours,
                    total_work_hours: Math.round(totalWorkHours * 10) / 10,
                    daily_rate: dailyRate,
                    hourly_rate: hourlyRate,
                    pension_self_rate: pensionRate,
                    tax_rate: taxRate,
                    full_attendance: hasFullAtt
                }
            };
        }

        function populatePayrollDropdown() {
            const sel = document.getElementById('payrollEmpDropdown');
            const prev = sel.value;
            sel.innerHTML = '<option value="_all">📋 全部員工總覽</option>';
            payrollEmployees.forEach(emp => {
                sel.innerHTML += `<option value="${emp.employee_id}">${emp.employee_number} ${emp.name}（${emp.department}）— ${formatNT(emp.net_salary)}</option>`;
            });
            if (prev) sel.value = prev;
        }

        function renderPayrollSummary() {
            const total = payrollEmployees.reduce((s, e) => s + e.net_salary, 0);
            const avg = payrollEmployees.length > 0 ? Math.round(total / payrollEmployees.length) : 0;
            document.getElementById('prEmpCount').textContent = payrollEmployees.length;
            document.getElementById('prTotalNet').textContent = formatNT(total);
            document.getElementById('prAvgNet').textContent = formatNT(avg);
            document.getElementById('prStatus').textContent = payrollIsPublished ? '✅ 已發布' : '📝 草稿';
        }

        function renderPayrollView() {
            const sel = document.getElementById('payrollEmpDropdown').value;
            if (sel === '_all') {
                renderAllPayrollTable();
            } else {
                renderPayrollCard(sel);
            }
        }

        function renderAllPayrollTable() {
            const el = document.getElementById('payrollContent');
            if (payrollEmployees.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;padding:20px;">無資料（請確認員工已設定薪資）</p>';
                return;
            }
            let html = '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:12px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.08);">';
            html += '<thead><tr style="background:#F1F5F9;">';
            html += '<th style="padding:10px 8px;text-align:left;font-weight:800;color:#475569;">姓名</th>';
            html += '<th style="padding:10px 4px;text-align:right;font-weight:800;color:#475569;">底薪</th>';
            html += '<th style="padding:10px 4px;text-align:right;font-weight:800;color:#475569;">加班</th>';
            html += '<th style="padding:10px 4px;text-align:right;font-weight:800;color:#475569;">扣款</th>';
            html += '<th style="padding:10px 8px;text-align:right;font-weight:800;color:#059669;">實發</th>';
            html += '</tr></thead><tbody>';

            payrollEmployees.forEach(emp => {
                html += `<tr onclick="document.getElementById('payrollEmpDropdown').value='${emp.employee_id}';renderPayrollView();" style="cursor:pointer;border-bottom:1px solid #F1F5F9;transition:background 0.15s;" onmouseover="this.style.background='#F8FAFC'" onmouseout="this.style.background=''">`;
                html += `<td style="padding:10px 8px;"><div style="font-weight:700;color:#0F172A;">${emp.name}</div><div style="font-size:11px;color:#94A3B8;">${emp.employee_number} · ${emp.department}</div></td>`;
                html += `<td style="padding:10px 4px;text-align:right;color:#334155;">${Math.round(emp.base_salary).toLocaleString()}</td>`;
                html += `<td style="padding:10px 4px;text-align:right;color:#0369A1;">${emp.overtime_pay > 0 ? '+' + Math.round(emp.overtime_pay).toLocaleString() : '-'}</td>`;
                html += `<td style="padding:10px 4px;text-align:right;color:#DC2626;">-${Math.round(emp.total_deduction).toLocaleString()}</td>`;
                html += `<td style="padding:10px 8px;text-align:right;font-weight:900;color:#059669;">${Math.round(emp.net_salary).toLocaleString()}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            el.innerHTML = html;
        }

        function renderPayrollCard(empId) {
            const el = document.getElementById('payrollContent');
            const emp = payrollEmployees.find(e => e.employee_id === empId);
            if (!emp) { el.innerHTML = '<p style="text-align:center;color:#94A3B8;">找不到此員工</p>'; return; }

            const cd = emp.calculation_details || {};
            const typeLabel = { monthly: '月薪制', daily: '日薪制', hourly: '時薪制' };

            // 收入明細
            const incomeItems = [
                { label: '基本薪資', value: emp.base_salary, desc: cd.salary_type === 'monthly' ? '固定月薪' : cd.salary_type === 'daily' ? `日薪 ${cd.original_base?.toLocaleString()} × ${cd.actual_days}天` : `時薪 ${cd.original_base?.toLocaleString()} × ${cd.total_work_hours}h` },
                { label: '加班費', value: emp.overtime_pay, desc: cd.overtime_hours > 0 ? `${cd.overtime_hours}小時` : '' },
                { label: '全勤獎金', value: emp.full_attendance_bonus, desc: cd.full_attendance ? '✅ 達成' : '❌ 未達成' },
                { label: '伙食津貼', value: emp.meal_allowance, desc: '每月固定' },
                { label: '職務加給', value: emp.position_allowance, desc: '每月固定' },
            ].filter(i => i.value > 0);

            // 扣款明細
            const deductItems = [
                { label: '勞保自付', value: emp.labor_insurance, desc: '投保級距×12.5%×20%' },
                { label: '健保自付', value: emp.health_insurance, desc: '投保級距×5.17%×30%' },
                { label: '勞退自提', value: emp.pension_self, desc: cd.pension_self_rate > 0 ? `月薪×${cd.pension_self_rate}%` : '' },
                { label: '所得稅', value: emp.income_tax, desc: `總收入×${cd.tax_rate}%` },
                { label: '遲到扣款', value: emp.late_deduction, desc: cd.late_count > 0 ? `${cd.late_count}次×$100` : '' },
                { label: '事假扣款', value: emp.personal_leave_deduction, desc: cd.personal_leave_days > 0 ? `日薪×${cd.personal_leave_days}天` : '' },
            ].filter(i => i.value > 0);

            const totalIncome = incomeItems.reduce((s, i) => s + i.value, 0);
            const totalDeduct = deductItems.reduce((s, i) => s + i.value, 0);

            let html = `<div style="background:#fff;border-radius:16px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">`;

            // Header
            html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">`;
            html += `<div><div style="font-size:18px;font-weight:900;color:#0F172A;">${emp.name}</div><div style="font-size:12px;color:#94A3B8;">${emp.employee_number} · ${emp.department} · ${typeLabel[emp.salary_type] || emp.salary_type}</div></div>`;
            html += `<div style="text-align:right;"><div style="font-size:11px;color:#94A3B8;">實發薪資</div><div style="font-size:22px;font-weight:900;color:#059669;">${formatNT(emp.net_salary)}</div></div>`;
            html += `</div>`;

            // 出勤摘要
            html += `<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;">`;
            html += `<div style="text-align:center;background:#F8FAFC;border-radius:10px;padding:10px;"><div style="font-size:11px;color:#94A3B8;">出勤</div><div style="font-size:16px;font-weight:800;color:#0F172A;">${cd.actual_days}天</div></div>`;
            html += `<div style="text-align:center;background:#F8FAFC;border-radius:10px;padding:10px;"><div style="font-size:11px;color:#94A3B8;">遲到</div><div style="font-size:16px;font-weight:800;color:${cd.late_count > 0 ? '#DC2626' : '#059669'};">${cd.late_count}次</div></div>`;
            html += `<div style="text-align:center;background:#F8FAFC;border-radius:10px;padding:10px;"><div style="font-size:11px;color:#94A3B8;">請假</div><div style="font-size:16px;font-weight:800;color:#0F172A;">${cd.leave_days}天</div></div>`;
            html += `<div style="text-align:center;background:#F8FAFC;border-radius:10px;padding:10px;"><div style="font-size:11px;color:#94A3B8;">加班</div><div style="font-size:16px;font-weight:800;color:#0369A1;">${cd.overtime_hours}h</div></div>`;
            html += `</div>`;

            // 收入
            html += `<div style="font-size:13px;font-weight:800;color:#059669;margin-bottom:8px;">📈 收入明細</div>`;
            incomeItems.forEach(i => {
                html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #F1F5F9;font-size:13px;">`;
                html += `<div><span style="color:#334155;">${i.label}</span><span style="color:#94A3B8;font-size:11px;margin-left:6px;">${i.desc}</span></div>`;
                html += `<div style="font-weight:700;color:#059669;">+${Math.round(i.value).toLocaleString()}</div>`;
                html += `</div>`;
            });
            html += `<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:14px;font-weight:800;color:#059669;border-top:2px solid #059669;margin-top:4px;">`;
            html += `<div>收入小計</div><div>${formatNT(totalIncome)}</div></div>`;

            // 扣款
            html += `<div style="font-size:13px;font-weight:800;color:#DC2626;margin:16px 0 8px;">📉 扣款明細</div>`;
            deductItems.forEach(i => {
                html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #F1F5F9;font-size:13px;">`;
                html += `<div><span style="color:#334155;">${i.label}</span><span style="color:#94A3B8;font-size:11px;margin-left:6px;">${i.desc}</span></div>`;
                html += `<div style="font-weight:700;color:#DC2626;">-${Math.round(i.value).toLocaleString()}</div>`;
                html += `</div>`;
            });
            html += `<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:14px;font-weight:800;color:#DC2626;border-top:2px solid #DC2626;margin-top:4px;">`;
            html += `<div>扣款小計</div><div>-${formatNT(totalDeduct)}</div></div>`;

            // 手動調整
            html += `<div style="font-size:13px;font-weight:800;color:#7C3AED;margin:16px 0 8px;">✏️ 手動調整</div>`;
            html += `<div style="display:flex;gap:8px;align-items:center;">`;
            html += `<input id="prAdj_${emp.employee_id}" type="text" inputmode="numeric" value="${(emp.manual_adjustment || 0) !== 0 ? emp.manual_adjustment.toLocaleString() : ''}" placeholder="正數=加給，負數=扣款" style="flex:1;padding:10px;border:1px solid #E5E7EB;border-radius:10px;font-size:13px;" onchange="updatePayrollAdjustment('${emp.employee_id}')">`;
            html += `<input id="prAdjNote_${emp.employee_id}" type="text" value="${emp.adjustment_note || ''}" placeholder="備註" style="width:120px;padding:10px;border:1px solid #E5E7EB;border-radius:10px;font-size:13px;" onchange="updatePayrollAdjustment('${emp.employee_id}')">`;
            html += `</div>`;

            html += `</div>`;
            el.innerHTML = html;

            // 格式化金額輸入
            const adjEl = document.getElementById(`prAdj_${emp.employee_id}`);
            if (adjEl) {
                adjEl.addEventListener('input', function() {
                    const neg = this.value.startsWith('-');
                    const raw = this.value.replace(/[^\d]/g, '');
                    this.value = raw ? (neg ? '-' : '') + parseInt(raw, 10).toLocaleString() : '';
                });
            }
        }

        function updatePayrollAdjustment(empId) {
            const amtEl = document.getElementById(`prAdj_${empId}`);
            const noteEl = document.getElementById(`prAdjNote_${empId}`);
            const neg = amtEl.value.startsWith('-');
            const raw = parseInt(amtEl.value.replace(/[^\d]/g, ''), 10) || 0;
            const amount = neg ? -raw : raw;
            payrollAdjustments[empId] = { amount, note: noteEl.value || '' };

            // 重新計算該員工
            const idx = payrollEmployees.findIndex(e => e.employee_id === empId);
            if (idx >= 0) {
                const old = payrollEmployees[idx];
                // manual_adjustment 影響 total_deduction 和 net_salary
                const adjDiff = amount - (old.manual_adjustment || 0);
                old.manual_adjustment = amount;
                old.adjustment_note = noteEl.value || '';
                old.total_deduction = old.total_deduction - adjDiff;
                old.net_salary = old.gross_salary - old.total_deduction;
                payrollEmployees[idx] = old;
            }

            // 更新摘要和下拉選單
            renderPayrollSummary();
            populatePayrollDropdown();
            // 重設下拉到當前員工
            document.getElementById('payrollEmpDropdown').value = empId;
        }

        async function saveAllPayroll() {
            if (payrollEmployees.length === 0) { showToast('⚠️ 無資料可儲存'); return; }
            const year = parseInt(document.getElementById('payrollYear').value);
            const month = parseInt(document.getElementById('payrollMonth').value);

            if (!confirm(`確定儲存 ${year}年${month}月 共 ${payrollEmployees.length} 人薪資（草稿）？`)) return;

            const btn = document.getElementById('savePayrollBtn');
            btn.disabled = true; btn.textContent = '⏳ 儲存中...';

            try {
                const records = payrollEmployees.map(emp => ({
                    employee_id: emp.employee_id,
                    year: emp.year,
                    month: emp.month,
                    salary_type: emp.salary_type,
                    base_salary: emp.base_salary,
                    overtime_pay: emp.overtime_pay,
                    bonus: 0,
                    full_attendance_bonus: emp.full_attendance_bonus,
                    meal_allowance: emp.meal_allowance,
                    position_allowance: emp.position_allowance,
                    night_allowance: emp.night_allowance,
                    late_deduction: emp.late_deduction,
                    absence_deduction: emp.absence_deduction,
                    personal_leave_deduction: emp.personal_leave_deduction,
                    labor_insurance: emp.labor_insurance,
                    health_insurance: emp.health_insurance,
                    pension_self: emp.pension_self,
                    income_tax: emp.income_tax,
                    manual_adjustment: emp.manual_adjustment,
                    adjustment_note: emp.adjustment_note,
                    total_deduction: emp.total_deduction,
                    gross_salary: emp.gross_salary,
                    net_salary: emp.net_salary,
                    calculation_details: emp.calculation_details,
                    is_published: false,
                    updated_at: new Date().toISOString()
                }));

                const { error } = await sb.from('payroll').upsert(records, { onConflict: 'employee_id,year,month' });
                if (error) throw error;

                if (typeof writeAuditLog === 'function') {
                    writeAuditLog('save_payroll', 'payroll', null, `${year}年${month}月薪資草稿`, {
                        count: records.length,
                        total: records.reduce((s, r) => s + r.net_salary, 0)
                    });
                }

                payrollIsPublished = false;
                renderPayrollSummary();
                showToast(`✅ 已儲存 ${records.length} 筆薪資（草稿）`);
            } catch(e) {
                showToast('❌ 儲存失敗：' + (typeof friendlyError === 'function' ? friendlyError(e) : e.message));
            } finally {
                btn.disabled = false; btn.textContent = '💾 儲存全部（草稿）';
            }
        }

        async function publishPayroll() {
            if (payrollEmployees.length === 0) { showToast('⚠️ 請先計算並儲存薪資'); return; }
            const year = parseInt(document.getElementById('payrollYear').value);
            const month = parseInt(document.getElementById('payrollMonth').value);

            if (!confirm(`⚠️ 確定發布 ${year}年${month}月 薪資？\n\n發布後員工將在薪資頁面看到明細。`)) return;

            const btn = document.getElementById('publishPayrollBtn');
            btn.disabled = true; btn.textContent = '⏳ 發布中...';

            try {
                // 先確保已儲存
                const records = payrollEmployees.map(emp => ({
                    employee_id: emp.employee_id,
                    year: emp.year,
                    month: emp.month,
                    salary_type: emp.salary_type,
                    base_salary: emp.base_salary,
                    overtime_pay: emp.overtime_pay,
                    bonus: 0,
                    full_attendance_bonus: emp.full_attendance_bonus,
                    meal_allowance: emp.meal_allowance,
                    position_allowance: emp.position_allowance,
                    night_allowance: emp.night_allowance,
                    late_deduction: emp.late_deduction,
                    absence_deduction: emp.absence_deduction,
                    personal_leave_deduction: emp.personal_leave_deduction,
                    labor_insurance: emp.labor_insurance,
                    health_insurance: emp.health_insurance,
                    pension_self: emp.pension_self,
                    income_tax: emp.income_tax,
                    manual_adjustment: emp.manual_adjustment,
                    adjustment_note: emp.adjustment_note,
                    total_deduction: emp.total_deduction,
                    gross_salary: emp.gross_salary,
                    net_salary: emp.net_salary,
                    calculation_details: emp.calculation_details,
                    is_published: true,
                    updated_at: new Date().toISOString()
                }));

                const { error } = await sb.from('payroll').upsert(records, { onConflict: 'employee_id,year,month' });
                if (error) throw error;

                if (typeof writeAuditLog === 'function') {
                    writeAuditLog('publish_payroll', 'payroll', null, `${year}年${month}月薪資發布`, {
                        count: records.length,
                        total: records.reduce((s, r) => s + r.net_salary, 0)
                    });
                }

                payrollIsPublished = true;
                renderPayrollSummary();
                document.getElementById('payrollPublishedWarn').style.display = 'block';
                showToast(`✅ ${year}年${month}月 薪資已發布（${records.length} 人）`);
            } catch(e) {
                showToast('❌ 發布失敗：' + (typeof friendlyError === 'function' ? friendlyError(e) : e.message));
            } finally {
                btn.disabled = false; btn.textContent = '📢 發布薪資（員工可見）';
            }
        }

        function exportPayrollCSV() {
            if (payrollEmployees.length === 0) { showToast('⚠️ 請先計算薪資'); return; }
            const year = parseInt(document.getElementById('payrollYear').value);
            const month = parseInt(document.getElementById('payrollMonth').value);
            const typeMap = { monthly: '月薪', daily: '日薪', hourly: '時薪' };

            const rows = [['工號','姓名','部門','薪資類型','底薪','加班費','全勤獎金','伙食津貼','職務加給','勞保','健保','勞退','所得稅','遲到扣','請假扣','手動調整','調整備註','總收入','總扣款','實發']];

            payrollEmployees.forEach(emp => {
                rows.push([
                    emp.employee_number, emp.name, emp.department,
                    typeMap[emp.salary_type] || emp.salary_type,
                    emp.base_salary, emp.overtime_pay, emp.full_attendance_bonus,
                    emp.meal_allowance, emp.position_allowance,
                    emp.labor_insurance, emp.health_insurance, emp.pension_self, emp.income_tax,
                    emp.late_deduction, emp.personal_leave_deduction,
                    emp.manual_adjustment, emp.adjustment_note,
                    emp.gross_salary, emp.total_deduction, emp.net_salary
                ]);
            });

            const csv = '\uFEFF' + rows.map(r => r.map(c => `"${String(c ?? '').replace(/"/g, '""')}"`).join(',')).join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            a.download = `薪資明細_${year}年${month}月.csv`;
            a.click();

            if (typeof writeAuditLog === 'function') {
                writeAuditLog('export', 'payroll', null, `薪資明細_${year}年${month}月.csv`, { rows: rows.length - 1 });
            }
            showToast(`✅ 薪資明細_${year}年${month}月.csv（${rows.length - 1} 筆）`);
        }

        // ===== 排班管理 =====
        let smWeekStart;
        (function() {
            const n = new Date(); const dow = n.getDay();
            smWeekStart = new Date(n);
            // 週一起算：dow=0(日)→回退6天, dow=1(一)→回退0天, dow=2(二)→回退1天...
            smWeekStart.setDate(n.getDate() - ((dow + 6) % 7));
            smWeekStart.setHours(0,0,0,0);
        })();

        let smEmployees = [];
        let smScheduleData = {};
        let smLeaveData = {};
        const SHIFT_TYPES = [null, 'morning', 'afternoon', 'night', 'off'];
        const SHIFT_DISPLAY = {
            null: { label:'⬜', bg:'#F8FAFC', color:'#94A3B8', name:'未排' },
            morning: { label:'☀️', bg:'#DBEAFE', color:'#1E40AF', name:'早班' },
            afternoon: { label:'🌤️', bg:'#FEF3C7', color:'#92400E', name:'中班' },
            night: { label:'🌙', bg:'#EDE9FE', color:'#6D28D9', name:'晚班' },
            off: { label:'🏖️', bg:'#ECFDF5', color:'#059669', name:'休假' }
        };

        function changeShiftWeek(d) { smWeekStart.setDate(smWeekStart.getDate() + d*7); loadShiftMgr(); }
        function resetShiftWeek() {
            const n = new Date(); const dow = n.getDay();
            smWeekStart = new Date(n);
            smWeekStart.setDate(n.getDate() - ((dow + 6) % 7));
            smWeekStart.setHours(0,0,0,0);
            loadShiftMgr();
        }

        function getWeekDates() {
            const dates = [];
            for (let i = 0; i < 7; i++) { const d = new Date(smWeekStart); d.setDate(d.getDate()+i); dates.push(d); }
            return dates;
        }

        async function loadShiftMgr() {
            const dates = getWeekDates();
            const startStr = fmtDate(dates[0]);
            const endStr = fmtDate(dates[6]);
            document.getElementById('smWeekLabel').textContent = `${startStr} ~ ${endStr}`;
            // Loading
            document.getElementById('smBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:#94A3B8;font-size:13px;">⏳ 載入中...</td></tr>';
            document.getElementById('smHead').innerHTML = '';
            document.getElementById('shiftDaySummary').innerHTML = '';

            try {
                const { data: emps } = await sb.from('employees').select('id, name, department').eq('is_active', true).order('name');
                smEmployees = emps || [];
                const { data: scheds } = await sb.from('schedules').select('employee_id, date, shift_type_id, shift_types(name, code)')
                    .gte('date', startStr).lte('date', endStr);
                smScheduleData = {};
                (scheds || []).forEach(s => {
                    const code = s.shift_types?.code || s.shift_types?.name || 'morning';
                    smScheduleData[`${s.employee_id}_${s.date}`] = code;
                });
                // 載入該週請假
                const { data: lvs } = await sb.from('leave_requests').select('employee_id, start_date, end_date, status')
                    .in('status', ['approved']).or(`and(start_date.lte.${endStr},end_date.gte.${startStr})`);
                smLeaveData = {};
                (lvs || []).forEach(l => {
                    // 用字串比較避免時區問題
                    const rangeStart = l.start_date > startStr ? l.start_date : startStr;
                    const rangeEnd = (l.end_date || l.start_date) < endStr ? (l.end_date || l.start_date) : endStr;
                    // 逐日標記
                    let cur = new Date(rangeStart + 'T00:00:00');
                    const end = new Date(rangeEnd + 'T00:00:00');
                    while (cur <= end) {
                        smLeaveData[`${l.employee_id}_${fmtDate(cur)}`] = true;
                        cur.setDate(cur.getDate() + 1);
                    }
                });
            } catch(e) { console.error(e); }

            renderShiftTable();
        }

        function renderShiftTable() {
            const dates = getWeekDates();
            const wd = ['日','一','二','三','四','五','六'];

            // 空狀態
            if (smEmployees.length === 0) {
                document.getElementById('smHead').innerHTML = '';
                document.getElementById('smBody').innerHTML = '';
                document.getElementById('shiftDaySummary').innerHTML = `
                    <div style="width:100%;text-align:center;padding:40px 20px;">
                        <div style="font-size:48px;margin-bottom:12px;">👥</div>
                        <div style="font-size:16px;font-weight:800;color:#0F172A;margin-bottom:8px;">尚無員工資料</div>
                        <div style="font-size:13px;color:#94A3B8;margin-bottom:16px;">請先到「員工管理」新增員工，才能排班</div>
                        <button onclick="showPage('employeePage')" style="padding:12px 24px;border:none;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">👉 前往員工管理</button>
                    </div>`;
                document.getElementById('shiftStaffWarn').style.display = 'none';
                return;
            }

            // 表頭
            let headHtml = '<tr><th style="position:sticky;left:0;background:#fff;z-index:2;padding:8px;min-width:60px;text-align:left;border-bottom:2px solid #E5E7EB;font-size:11px;">姓名</th>';
            dates.forEach(d => {
                const isW = d.getDay()===0||d.getDay()===6;
                headHtml += `<th style="padding:6px 4px;min-width:46px;text-align:center;border-bottom:2px solid #E5E7EB;background:${isW?'#F1F5F9':'#fff'};">
                    <div style="font-size:12px;">${d.getDate()}</div><div style="font-size:10px;color:#94A3B8;">週${wd[d.getDay()]}</div>
                </th>`;
            });
            headHtml += '</tr>';
            document.getElementById('smHead').innerHTML = headHtml;

            // 表身
            let bodyHtml = '';
            smEmployees.forEach(emp => {
                bodyHtml += `<tr><td style="position:sticky;left:0;background:#fff;z-index:1;padding:8px;font-weight:700;font-size:11px;white-space:nowrap;border-bottom:1px solid #F1F5F9;">${emp.name}</td>`;
                dates.forEach(d => {
                    const ds = fmtDate(d);
                    const key = `${emp.id}_${ds}`;
                    const onLeave = smLeaveData[key];
                    const shift = smScheduleData[key] || null;
                    const disp = SHIFT_DISPLAY[shift] || SHIFT_DISPLAY[null];
                    if (onLeave) {
                        bodyHtml += `<td style="text-align:center;padding:8px 4px;border-bottom:1px solid #F1F5F9;background:#FEE2E2;font-size:14px;cursor:not-allowed;opacity:0.7;" title="${emp.name} 已請假">🏖️</td>`;
                    } else {
                        bodyHtml += `<td onclick="cycleShift('${key}')" style="text-align:center;padding:8px 4px;cursor:pointer;border-bottom:1px solid #F1F5F9;background:${disp.bg};font-size:14px;transition:all 0.15s;user-select:none;" title="${emp.name} ${ds} ${disp.name}">${disp.label}</td>`;
                    }
                });
                bodyHtml += '</tr>';
            });

            // 每日人力統計列
            bodyHtml += '<tr style="background:#F8FAFC;font-weight:700;"><td style="position:sticky;left:0;background:#F8FAFC;z-index:1;padding:6px 8px;font-size:10px;color:#64748B;">上班人數</td>';
            let warnDays = [];
            dates.forEach(d => {
                const ds = fmtDate(d);
                const isW = d.getDay()===0||d.getDay()===6;
                let working = 0;
                smEmployees.forEach(emp => {
                    const key = `${emp.id}_${ds}`;
                    if (smLeaveData[key]) return;
                    const shift = smScheduleData[key];
                    if (shift && shift !== 'off') working++;
                });
                const low = working > 0 && working <= 2 && !isW;
                if (low) warnDays.push(`${d.getMonth()+1}/${d.getDate()}(${working}人)`);
                bodyHtml += `<td style="text-align:center;font-size:11px;color:${low?'#DC2626':working>0?'#059669':'#94A3B8'};background:${low?'#FEF2F2':'#F8FAFC'};border-bottom:1px solid #F1F5F9;">${working||'-'}</td>`;
            });
            bodyHtml += '</tr>';
            document.getElementById('smBody').innerHTML = bodyHtml;

            // 每日摘要卡片
            let sumHtml = '';
            dates.forEach(d => {
                const ds = fmtDate(d);
                const isW = d.getDay()===0||d.getDay()===6;
                const counts = { morning:0, afternoon:0, night:0, off:0, leave:0, unset:0 };
                smEmployees.forEach(emp => {
                    const key = `${emp.id}_${ds}`;
                    if (smLeaveData[key]) { counts.leave++; return; }
                    const s = smScheduleData[key];
                    if (s && counts.hasOwnProperty(s)) counts[s]++;
                    else counts.unset++;
                });
                const total = counts.morning + counts.afternoon + counts.night;
                const low = total > 0 && total <= 2 && !isW;
                sumHtml += `<div style="min-width:60px;padding:6px 8px;background:${low?'#FEF2F2':'#F8FAFC'};border-radius:8px;text-align:center;flex-shrink:0;${low?'border:2px solid #FCA5A5;':''}">
                    <div style="font-size:10px;font-weight:700;color:#64748B;">${d.getDate()}日</div>
                    <div style="font-size:14px;font-weight:900;color:${low?'#DC2626':'#0F172A'};">${total}人</div>
                    <div style="font-size:9px;color:#94A3B8;">☀${counts.morning} 🌤${counts.afternoon} 🌙${counts.night}</div>
                    ${counts.leave>0?`<div style="font-size:9px;color:#EA580C;">假${counts.leave}</div>`:''}
                </div>`;
            });
            document.getElementById('shiftDaySummary').innerHTML = sumHtml;

            // 人手不足警告
            const warnEl = document.getElementById('shiftStaffWarn');
            if (warnDays.length > 0) {
                warnEl.style.display = 'block';
                warnEl.innerHTML = `⚠️ 人手不足警告：${warnDays.join('、')}<br><span style="font-size:11px;opacity:0.7;">建議調整排班或限制請假</span>`;
            } else {
                warnEl.style.display = 'none';
            }
        }

        function cycleShift(key) {
            const current = smScheduleData[key] || null;
            const idx = SHIFT_TYPES.indexOf(current);
            smScheduleData[key] = SHIFT_TYPES[(idx+1) % SHIFT_TYPES.length];
            renderShiftTable();
        }

        async function saveSchedule() {
            const statusEl = document.getElementById('smSaveStatus');
            statusEl.style.display = 'block'; statusEl.style.color = '#F59E0B'; statusEl.textContent = '⏳ 儲存中...';
            try {
                const { data: shiftTypes } = await sb.from('shift_types').select('id, code, name');
                const stMap = {};
                (shiftTypes || []).forEach(st => { stMap[st.code || st.name] = st.id; });
                const upserts = [];
                for (const [key, shift] of Object.entries(smScheduleData)) {
                    if (!shift) continue;
                    const parts = key.split('_');
                    const empId = parts[0];
                    const date = parts.slice(1).join('-');
                    const stId = stMap[shift];
                    if (!stId) continue;
                    upserts.push({ employee_id: empId, date, shift_type_id: stId });
                }
                if (upserts.length > 0) {
                    const { error } = await sb.from('schedules').upsert(upserts, { onConflict: 'employee_id,date' });
                    if (error) throw error;
                }
                statusEl.style.color = '#059669'; statusEl.textContent = `✅ 已儲存 ${upserts.length} 筆排班`;
                setTimeout(() => { statusEl.style.display = 'none'; }, 2500);
            } catch(e) {
                console.error(e);
                statusEl.style.color = '#DC2626'; statusEl.textContent = '❌ 儲存失敗: ' + e.message;
            }
        }

        async function copyLastWeek() {
            if (!confirm('確定要複製上週排班到本週？\n（已有排班不會被覆蓋）')) return;
            const dates = getWeekDates();
            try {
                const lwStart = new Date(dates[0]); lwStart.setDate(lwStart.getDate()-7);
                const lwEnd = new Date(dates[6]); lwEnd.setDate(lwEnd.getDate()-7);
                const { data: lastScheds } = await sb.from('schedules').select('employee_id, date, shift_type_id, shift_types(code, name)')
                    .gte('date', fmtDate(lwStart)).lte('date', lwEnfmtDate(d));
                let copied = 0;
                (lastScheds || []).forEach(s => {
                    const oldD = new Date(s.date + 'T00:00:00');
                    const newD = new Date(oldD); newD.setDate(newD.getDate()+7);
                    const key = `${s.employee_id}_${fmtDate(newD)}`;
                    if (!smScheduleData[key]) {
                        smScheduleData[key] = s.shift_types?.code || s.shift_types?.name || 'morning';
                        copied++;
                    }
                });
                renderShiftTable();
                showToast(`📋 已複製上週 ${copied} 筆排班`);
            } catch(e) { console.error(e); showToast('❌ 複製失敗'); }
        }


        // ===== 補打卡審核 =====
        function switchMakeupTab(status) {
            document.querySelectorAll('#makeupApprovalPage .tab-btn').forEach(btn => {
                btn.className = 'tab-btn ' + (btn.textContent.includes(status === 'pending' ? '待審' : status === 'approved' ? '已通過' : '已拒絕') ? 'active' : 'inactive');
            });
            loadMakeupApprovals(status);
        }

        async function loadMakeupApprovals(status) {
            const listEl = document.getElementById('makeupApprovalList');
            if (!listEl) return;
            listEl.innerHTML = '<p style="text-align:center;color:#666;">載入中...</p>';

            try {
                const { data } = await sb.from('makeup_punch_requests')
                    .select('*, employees(name, department, employee_number)')
                    .eq('status', status)
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (!data || data.length === 0) {
                    const labels = { pending:'待審核', approved:'已通過', rejected:'已拒絕' };
                    listEl.innerHTML = `<p style="text-align:center;color:#999;">無${labels[status]}的補打卡申請</p>`;
                    return;
                }

                const typeMap = { clock_in:'☀️ 上班', clock_out:'🌙 下班' };
                listEl.innerHTML = data.map(r => `
                    <div style="background:#fff;border-radius:14px;padding:14px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <span style="font-weight:800;font-size:14px;">${r.employees?.name || '?'}</span>
                            <span style="font-size:11px;color:#94A3B8;">${r.employees?.department || ''} · ${r.employees?.employee_number || ''}</span>
                        </div>
                        <div style="display:flex;gap:8px;margin-bottom:8px;font-size:13px;">
                            <span style="padding:4px 10px;background:#EFF6FF;border-radius:8px;color:#2563EB;font-weight:700;">📅 ${r.punch_date}</span>
                            <span style="padding:4px 10px;background:#F5F3FF;border-radius:8px;color:#7C3AED;font-weight:700;">${typeMap[r.punch_type] || r.punch_type} ${r.punch_time || ''}</span>
                        </div>
                        <div style="font-size:12px;color:#64748B;margin-bottom:8px;">${r.reason || ''}</div>
                        ${status === 'pending' ? `
                            <div style="display:flex;gap:8px;">
                                <button onclick="approveMakeupPunch('${r.id}','approved')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#ECFDF5;color:#059669;font-weight:700;font-size:13px;cursor:pointer;">✅ 通過</button>
                                <button onclick="rejectMakeupPunchPrompt('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#FEF2F2;color:#DC2626;font-weight:700;font-size:13px;cursor:pointer;">❌ 拒絕</button>
                            </div>
                        ` : ''}
                        ${r.status === 'approved' ? '<div style="font-size:11px;color:#059669;margin-top:4px;">✅ 已自動寫入出勤記錄</div>' : ''}
                        ${r.rejection_reason ? `<div style="font-size:11px;color:#DC2626;margin-top:4px;">❌ ${r.rejection_reason}</div>` : ''}
                    </div>
                `).join('');
            } catch(e) {
                console.error(e);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗</p>';
            }
        }

        async function approveMakeupPunch(id, status) {
            try {
                const { data: req } = await sb.from('makeup_punch_requests').select('*').eq('id', id).single();
                
                await sb.from('makeup_punch_requests').update({
                    status: status,
                    approver_id: currentAdminEmployee?.id,
                    approved_at: new Date().toISOString()
                }).eq('id', id);

                // 通過後自動寫入 attendance
                if (status === 'approved' && req) {
                    const col = req.punch_type === 'clock_in' ? 'check_in_time' : 'check_out_time';
                    const timeVal = `${req.punch_date}T${req.punch_time}:00`;
                    
                    // 先查是否已有當天記錄
                    const { data: existing } = await sb.from('attendance')
                        .select('id')
                        .eq('employee_id', req.employee_id)
                        .eq('date', req.punch_date)
                        .maybeSingle();
                    
                    if (existing) {
                        await sb.from('attendance').update({
                            [col]: timeVal,
                            is_manual: true,
                            notes: `補打卡 - ${req.reason || ''}`
                        }).eq('id', existing.id);
                    } else {
                        await sb.from('attendance').insert({
                            employee_id: req.employee_id,
                            date: req.punch_date,
                            [col]: timeVal,
                            is_manual: true,
                            status: 'present',
                            notes: `補打卡 - ${req.reason || ''}`
                        });
                    }
                    
                    // 通知員工
                    sendUserNotify(req.employee_id, `✅ 您的補打卡申請已通過\n📅 ${req.punch_date} ${req.punch_type === 'clock_in' ? '上班' : '下班'} ${req.punch_time}`);
                }

                showToast(status === 'approved' ? '✅ 已通過並寫入出勤' : '❌ 已拒絕');
                writeAuditLog(status === 'approved' ? 'approve' : 'reject', 'makeup_punch_requests', id, req?.employees?.name || '');
                loadMakeupApprovals('pending');
            } catch(e) {
                console.error(e);
                showToast('❌ 審核失敗: ' + friendlyError(e));
            }
        }

        function rejectMakeupPunchPrompt(id) {
            const reason = prompt('請輸入拒絕原因（選填）：');
            if (reason === null) return;
            rejectMakeupPunch(id, reason);
        }

        async function rejectMakeupPunch(id, reason) {
            try {
                await sb.from('makeup_punch_requests').update({
                    status: 'rejected',
                    rejection_reason: reason || '不符合規定',
                    approver_id: currentAdminEmployee?.id,
                    approved_at: new Date().toISOString()
                }).eq('id', id);
                showToast('❌ 已拒絕');
                loadMakeupApprovals('pending');
            } catch(e) { showToast('❌ 操作失敗'); }
        }

        // ===== 公告管理 =====
        async function publishAnnouncement() {
            const title = document.getElementById('annTitle')?.value;
            const content = document.getElementById('annContent')?.value;
            const type = document.getElementById('annType')?.value;
            const expire = document.getElementById('annExpire')?.value;
            const pinned = document.getElementById('annPinned')?.checked;
            const requireAck = document.getElementById('annRequireAck')?.checked;
            
            if (!title) return showToast('❌ 請輸入標題');
            
            try {
                // 讀取現有公告
                const { data: existing } = await sb.from('system_settings')
                    .select('value').eq('key', 'announcements').maybeSingle();
                
                const items = existing?.value?.items || [];
                items.unshift({
                    id: Date.now().toString(),
                    title, content, type, pinned,
                    require_ack: requireAck || false,
                    expire_date: expire || null,
                    created_at: new Date().toISOString(),
                    created_by: currentAdminEmployee?.name || 'admin'
                });
                
                if (existing) {
                    await sb.from('system_settings').update({ value: { items }, updated_at: new Date().toISOString() }).eq('key', 'announcements');
                } else {
                    await sb.from('system_settings').insert({ key: 'announcements', value: { items }, description: '公告系統' });
                }
                
                showToast('📢 公告已發布');
                document.getElementById('annTitle').value = '';
                document.getElementById('annContent').value = '';
                document.getElementById('annExpire').value = '';
                document.getElementById('annPinned').checked = false;
                if (document.getElementById('annRequireAck')) document.getElementById('annRequireAck').checked = false;
                loadAnnouncementList();
            } catch(e) { showToast('❌ 發布失敗：' + friendlyError(e)); }
        }

        async function loadAnnouncementList() {
            const el = document.getElementById('announcementList');
            if (!el) return;
            
            try {
                const { data } = await sb.from('system_settings')
                    .select('value').eq('key', 'announcements').maybeSingle();
                
                const items = data?.value?.items || [];
                if (items.length === 0) { el.innerHTML = '<p style="text-align:center;color:#999;">尚無公告</p>'; return; }
                
                const typeIcon = { info:'📢', warning:'⚠️', urgent:'🚨', event:'🎉' };
                const typeColor = { info:'#2563EB', warning:'#EA580C', urgent:'#DC2626', event:'#7C3AED' };
                const typeBg = { info:'#EFF6FF', warning:'#FFF7ED', urgent:'#FEF2F2', event:'#F5F3FF' };
                
                el.innerHTML = items.map(a => `
                    <div style="background:${typeBg[a.type] || '#F1F5F9'};border-radius:12px;padding:14px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <span style="font-weight:800;color:${typeColor[a.type] || '#64748B'};">${typeIcon[a.type] || '📌'} ${a.title}</span>
                            <button onclick="deleteAnnouncement('${a.id}')" style="background:none;border:none;font-size:14px;cursor:pointer;padding:4px;">🗑️</button>
                        </div>
                        ${a.content ? `<div style="font-size:12px;color:#64748B;margin-bottom:4px;">${a.content}</div>` : ''}
                        <div style="font-size:10px;color:#94A3B8;">
                            ${a.pinned ? '📌 置頂 · ' : ''}
                            ${a.expire_date ? '到期：' + a.expire_date + ' · ' : '永久 · '}
                            ${a.created_by || ''} · ${a.created_at ? new Date(a.created_at).toLocaleDateString() : ''}
                        </div>
                    </div>
                `).join('');
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗</p>'; }
        }

        async function deleteAnnouncement(id) {
            if (!confirm('確定刪除此公告？')) return;
            try {
                const { data } = await sb.from('system_settings')
                    .select('value').eq('key', 'announcements').maybeSingle();
                if (!data?.value?.items) return;
                
                const items = data.value.items.filter(a => a.id !== id);
                await sb.from('system_settings').update({ value: { items }, updated_at: new Date().toISOString() }).eq('key', 'announcements');
                showToast('🗑️ 已刪除');
                loadAnnouncementList();
            } catch(e) { showToast('❌ 刪除失敗'); }
        }

        // ===== 加班審核 =====
        function switchOtTab(status) {
            document.querySelectorAll('#overtimeApprovalPage .tab-btn').forEach(btn => {
                btn.className = 'tab-btn ' + (btn.textContent.includes(status === 'pending' ? '待審' : status === 'approved' ? '已通過' : '已拒絕') ? 'active' : 'inactive');
            });
            loadOtApprovals(status);
        }

        async function loadOtApprovals(status) {
            const el = document.getElementById('otApprovalList');
            if (!el) return;
            el.innerHTML = '<p style="text-align:center;color:#666;">載入中...</p>';
            try {
                const { data } = await sb.from('overtime_requests')
                    .select('*, employees(name, department, employee_number)')
                    .eq('status', status).order('created_at', { ascending: false }).limit(20);
                if (!data || data.length === 0) {
                    el.innerHTML = `<p style="text-align:center;color:#999;">無資料</p>`; return;
                }
                const compMap = { pay:'💰 加班費', comp_leave:'🏖️ 換補休' };
                el.innerHTML = data.map(r => `
                    <div style="background:#fff;border-radius:14px;padding:14px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <b>${r.employees?.name || '?'}</b>
                            <span style="font-size:11px;color:#94A3B8;">${r.employees?.department || ''}</span>
                        </div>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px;font-size:12px;">
                            <span style="padding:3px 8px;background:#EFF6FF;border-radius:6px;color:#2563EB;font-weight:700;">📅 ${r.ot_date}</span>
                            <span style="padding:3px 8px;background:#F5F3FF;border-radius:6px;color:#7C3AED;font-weight:700;">⏰ ${r.planned_hours}h</span>
                            <span style="padding:3px 8px;background:#ECFDF5;border-radius:6px;color:#059669;font-weight:700;">${compMap[r.compensation_type] || ''}</span>
                        </div>
                        <div style="font-size:12px;color:#64748B;margin-bottom:6px;">${r.reason || ''}</div>
                        ${status === 'pending' ? `
                            <div style="margin-bottom:8px;">
                                <label style="font-size:12px;font-weight:700;">核准時數：</label>
                                <input type="number" id="otAH_${r.id}" value="${r.planned_hours}" min="0" max="12" step="0.5" style="width:70px;padding:4px;border:1px solid #E5E7EB;border-radius:6px;">h
                            </div>
                            <div style="display:flex;gap:8px;">
                                <button onclick="approveOt('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#ECFDF5;color:#059669;font-weight:700;cursor:pointer;">✅ 通過</button>
                                <button onclick="rejectOtPrompt('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#FEF2F2;color:#DC2626;font-weight:700;cursor:pointer;">❌ 拒絕</button>
                            </div>
                        ` : ''}
                        ${r.approved_hours ? `<div style="font-size:11px;color:#059669;">核准 ${r.approved_hours}h${r.final_hours != null ? ' · 計薪 '+r.final_hours+'h' : ''}</div>` : ''}
                        ${r.rejection_reason ? `<div style="font-size:11px;color:#DC2626;">❌ ${r.rejection_reason}</div>` : ''}
                    </div>
                `).join('');
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗</p>'; }
        }

        async function approveOt(id) {
            const h = parseFloat(document.getElementById(`otAH_${id}`)?.value) || 0;
            if (h <= 0) return showToast('❌ 核准時數需大於 0');
            try {
                const { data: req } = await sb.from('overtime_requests').select('*, employees(name, id)').eq('id', id).single();
                await sb.from('overtime_requests').update({
                    status:'approved', approved_hours:h, approver_id:currentAdminEmployee?.id, approved_at:new Date().toISOString()
                }).eq('id', id);
                writeAuditLog('approve','overtime_requests',id,req?.employees?.name,{approved_hours:h});
                if (req?.employees?.id) sendUserNotify(req.employees.id,`✅ 加班已通過\n📅 ${req.ot_date} 核准 ${h}h`);
                showToast('✅ 已通過'); loadOtApprovals('pending');
            } catch(e) { showToast('❌ 審核失敗'); }
        }
        function rejectOtPrompt(id) { const r = prompt('拒絕原因：'); if(r===null) return; rejectOt(id,r); }
        async function rejectOt(id, reason) {
            try {
                await sb.from('overtime_requests').update({
                    status:'rejected', rejection_reason:reason||'不符合規定',
                    approver_id:currentAdminEmployee?.id, approved_at:new Date().toISOString()
                }).eq('id', id);
                showToast('❌ 已拒絕'); loadOtApprovals('pending');
            } catch(e) { showToast('❌ 操作失敗'); }
        }

        // ===== 換班審核 =====
        async function loadSwapApprovals() {
            const el = document.getElementById('swapApprovalList');
            if (!el) return;
            el.innerHTML = '<p style="text-align:center;color:#666;">載入中...</p>';
            try {
                const { data } = await sb.from('shift_swap_requests')
                    .select('*, requester:employees!shift_swap_requests_requester_id_fkey(name, department), target:employees!shift_swap_requests_target_id_fkey(name, department)')
                    .in('status', ['pending_admin', 'approved', 'rejected'])
                    .order('created_at', { ascending: false }).limit(20);
                
                if (!data || data.length === 0) { el.innerHTML = '<p style="text-align:center;color:#999;">無換班申請</p>'; return; }
                
                const sMap = { pending_admin:'⏳ 待審', approved:'✅ 通過', rejected:'❌ 拒絕' };
                el.innerHTML = data.map(r => `
                    <div style="background:#fff;border-radius:14px;padding:14px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                            <b style="font-size:14px;">${r.requester?.name} ↔ ${r.target?.name}</b>
                            <span style="font-size:11px;color:#94A3B8;">${sMap[r.status] || r.status}</span>
                        </div>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px;font-size:12px;">
                            <span style="padding:3px 8px;background:#EFF6FF;border-radius:6px;color:#2563EB;font-weight:700;">📅 ${r.swap_date}</span>
                            <span style="padding:3px 8px;background:#FFF7ED;border-radius:6px;color:#EA580C;font-weight:700;">${r.requester_original_shift||'?'} ↔ ${r.target_original_shift||'?'}</span>
                        </div>
                        <div style="font-size:11px;color:#64748B;margin-bottom:6px;">✅ 雙方已同意${r.reason ? ' · 原因：'+r.reason : ''}</div>
                        ${r.status === 'pending_admin' ? `
                            <div style="display:flex;gap:8px;">
                                <button onclick="approveSwap('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#ECFDF5;color:#059669;font-weight:700;cursor:pointer;">✅ 核准</button>
                                <button onclick="rejectSwap('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#FEF2F2;color:#DC2626;font-weight:700;cursor:pointer;">❌ 拒絕</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗</p>'; }
        }

        async function approveSwap(id) {
            try {
                const { data: req } = await sb.from('shift_swap_requests')
                    .select('*, requester:employees!shift_swap_requests_requester_id_fkey(name, id), target:employees!shift_swap_requests_target_id_fkey(name, id)')
                    .eq('id', id).single();
                
                // 更新狀態
                await sb.from('shift_swap_requests').update({
                    status: 'approved', approver_id: currentAdminEmployee?.id, approved_at: new Date().toISOString()
                }).eq('id', id);
                
                // 交換排班表（互相更新 schedules）
                if (req) {
                    const date = req.swap_date;
                    // 取得雙方當日排班
                    const { data: s1 } = await sb.from('schedules').select('id, shift_type_id').eq('employee_id', req.requester_id).eq('date', date).maybeSingle();
                    const { data: s2 } = await sb.from('schedules').select('id, shift_type_id').eq('employee_id', req.target_id).eq('date', date).maybeSingle();
                    
                    if (s1 && s2) {
                        // 交換 shift_type_id
                        await sb.from('schedules').update({ shift_type_id: s2.shift_type_id }).eq('id', s1.id);
                        await sb.from('schedules').update({ shift_type_id: s1.shift_type_id }).eq('id', s2.id);
                    }
                    
                    writeAuditLog('approve', 'shift_swap_requests', id, `${req.requester?.name} ↔ ${req.target?.name}`, { date });
                    if (req.requester?.id) sendUserNotify(req.requester.id, `✅ 換班已核准\n📅 ${date} 班表已自動更新`);
                    if (req.target?.id) sendUserNotify(req.target.id, `✅ 換班已核准\n📅 ${date} 班表已自動更新`);
                }
                
                showToast('✅ 已核准，班表已交換');
                loadSwapApprovals();
            } catch(e) { showToast('❌ 審核失敗：' + friendlyError(e)); }
        }

        async function rejectSwap(id) {
            const reason = prompt('拒絕原因：');
            if (reason === null) return;
            try {
                await sb.from('shift_swap_requests').update({
                    status: 'rejected', rejection_reason: reason || '不符規定',
                    approver_id: currentAdminEmployee?.id, approved_at: new Date().toISOString()
                }).eq('id', id);
                showToast('❌ 已拒絕'); loadSwapApprovals();
            } catch(e) { showToast('❌ 操作失敗'); }
        }

        // ===== 操作日誌 =====
        let auditOffset = 0;
        async function loadAuditLogs(more = false) {
            const el = document.getElementById('auditLogList');
            if (!el) return;
            if (!more) { auditOffset = 0; el.innerHTML = ''; }
            try {
                const { data } = await sb.from('hr_audit_logs').select('*').order('created_at',{ascending:false}).range(auditOffset, auditOffset+29);
                if (!data || data.length === 0) { if(auditOffset===0) el.innerHTML = '<p style="text-align:center;color:#999;">尚無記錄</p>'; return; }
                const ai = {create:'➕',update:'✏️',delete:'🗑️',approve:'✅',reject:'❌',export:'📊',acknowledge:'✍️'};
                const al = {create:'新增',update:'修改',delete:'刪除',approve:'通過',reject:'拒絕',export:'匯出',acknowledge:'簽署'};
                el.innerHTML += data.map(r => `
                    <div style="padding:8px 0;border-bottom:1px solid #F1F5F9;font-size:13px;">
                        <div style="display:flex;justify-content:space-between;">
                            <span>${ai[r.action]||'📝'} <b>${r.actor_name||'?'}</b> ${al[r.action]||r.action} <span style="color:#7C3AED;">${r.target_table||''}</span></span>
                            <span style="font-size:10px;color:#94A3B8;">${r.created_at?new Date(r.created_at).toLocaleString('zh-TW'):''}</span>
                        </div>
                        ${r.target_name?`<div style="font-size:11px;color:#64748B;margin-top:2px;">對象：${r.target_name}</div>`:''}
                    </div>
                `).join('');
                auditOffset += data.length;
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗</p>'; }
        }

        // ===== 報表匯出（CSV）=====
        async function exportReport(type) {
            showToast(`📊 正在產生報表...`);
            try {
                const now = new Date();
                const y = now.getFullYear(), m = now.getMonth()+1, ms = `${y}-${String(m).padStart(2,'0')}`;
                let rows = [], fn = '';
                
                if (type === 'attendance') {
                    const { data } = await sb.from('attendance').select('*, employees(name, employee_number, department)').gte('date',ms+'-01').lte('date',ms+'-31').order('date');
                    rows.push(['日期','工號','姓名','部門','上班','下班','狀態','遲到(分)','補卡','備註']);
                    (data||[]).forEach(r => rows.push([r.date,r.employees?.employee_number,r.employees?.name,r.employees?.department,r.check_in_time?.split('T')[1]?.substring(0,5)||'',r.check_out_time?.split('T')[1]?.substring(0,5)||'',r.status,r.late_minutes||0,r.is_manual?'是':'',r.notes||'']));
                    fn = `出勤報表_${ms}.csv`;
                } else if (type === 'leave') {
                    const { data } = await sb.from('leave_requests').select('*, employees(name, employee_number, department)').order('created_at',{ascending:false}).limit(200);
                    const tm = {annual:'特休',sick:'病假',personal:'事假',compensatory:'補休'};
                    rows.push(['工號','姓名','部門','假別','開始','結束','天數','原因','狀態','拒絕原因']);
                    (data||[]).forEach(r => rows.push([r.employees?.employee_number,r.employees?.name,r.employees?.department,tm[r.leave_type]||r.leave_type,r.start_date,r.end_date,r.days||1,r.reason||'',r.status,r.rejection_reason||'']));
                    fn = `請假報表_${ms}.csv`;
                } else if (type === 'overtime') {
                    const { data } = await sb.from('overtime_requests').select('*, employees(name, employee_number, department)').order('ot_date',{ascending:false}).limit(200);
                    rows.push(['工號','姓名','部門','日期','申請h','核准h','實際h','計薪h','補償','狀態']);
                    (data||[]).forEach(r => rows.push([r.employees?.employee_number,r.employees?.name,r.employees?.department,r.ot_date,r.planned_hours,r.approved_hours||'',r.actual_hours||'',r.final_hours||'',r.compensation_type==='pay'?'加班費':'補休',r.status]));
                    fn = `加班報表_${ms}.csv`;
                } else if (type === 'lunch') {
                    const { data } = await sb.from('lunch_orders').select('*, employees(name, employee_number)').gte('order_date',ms+'-01').lte('order_date',ms+'-31').order('order_date');
                    rows.push(['日期','工號','姓名','類型','狀態','備註']);
                    (data||[]).forEach(r => rows.push([r.order_date,r.employees?.employee_number,r.employees?.name,r.is_vegetarian?'素食':'葷食',r.status==='cancelled'?'取消($50)':'已訂',r.notes||'']));
                    fn = `便當報表_${ms}.csv`;
                } else if (type === 'bonus') {
                    const { data } = await sb.from('annual_bonus').select('*, employees(name, employee_number, department)').eq('year',y);
                    rows.push(['工號','姓名','部門','年資(月)','基本獎金','調整','最終','詳細']);
                    (data||[]).forEach(r => {
                        let detail = '';
                        try { const d = JSON.parse(r.ai_recommendation); detail = `${d.performance_rating}/${d.attendance_grade} x${d.matrix_multiplier}`; } catch(e) {}
                        rows.push([r.employees?.employee_number,r.employees?.name,r.employees?.department,r.months_worked,r.base_amount,r.adjustment||0,r.final_bonus||0,detail]);
                    });
                    fn = `獎金報表_${y}.csv`;
                } else if (type === 'payroll') {
                    const { data } = await sb.from('payroll').select('*, employees(name, employee_number, department)').eq('year',y).eq('month',m).order('employees(employee_number)');
                    rows.push(['工號','姓名','部門','薪資類型','底薪','加班費','全勤獎金','伙食津貼','職務加給','勞保','健保','勞退','所得稅','遲到扣','請假扣','手動調整','總收入','總扣款','實發','狀態']);
                    (data||[]).forEach(r => {
                        const cd = r.calculation_details || {};
                        const typeMap = {monthly:'月薪',daily:'日薪',hourly:'時薪'};
                        rows.push([r.employees?.employee_number,r.employees?.name,r.employees?.department,typeMap[r.salary_type]||r.salary_type,r.base_salary,r.overtime_pay,r.full_attendance_bonus,r.meal_allowance||0,r.position_allowance||0,r.labor_insurance,r.health_insurance,r.pension_self||0,r.income_tax||0,r.late_deduction,r.personal_leave_deduction||0,r.manual_adjustment||0,r.gross_salary,r.total_deduction,r.net_salary,r.is_published?'已發布':'草稿']);
                    });
                    fn = `薪資報表_${ms}.csv`;
                }
                
                if (rows.length <= 1) { showToast('⚠️ 無資料'); return; }
                const csv = '\uFEFF' + rows.map(r => r.map(c => `"${String(c??'').replace(/"/g,'""')}"`).join(',')).join('\n');
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
                a.download = fn; a.click();
                writeAuditLog('export',type,null,fn,{rows:rows.length-1});
                showToast(`✅ ${fn}（${rows.length-1} 筆）`);
            } catch(e) { showToast('❌ 匯出失敗：'+friendlyError(e)); }
        }

        // ===== 客戶管理 =====
        let adminClients = [];

        async function loadClientList() {
            try {
                const { data } = await sb.from('clients').select('*').order('company_name');
                adminClients = data || [];
                renderClientList(adminClients);
            } catch(e) { console.error('載入客戶失敗', e); }
        }

        function filterClients() {
            const q = (document.getElementById('clientSearch')?.value || '').toLowerCase();
            const filtered = q ? adminClients.filter(c => c.company_name.toLowerCase().includes(q)) : adminClients;
            renderClientList(filtered);
        }

        function renderClientList(list) {
            const el = document.getElementById('clientList');
            if (!el) return;
            if (list.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">無客戶資料</p>';
                return;
            }
            el.innerHTML = list.map(c => {
                const catBadge = c.category === 'vip'
                    ? '<span style="background:#FEF3C7;color:#92400E;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700;">VIP ⭐</span>'
                    : '<span style="background:#F1F5F9;color:#64748B;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700;">一般</span>';
                return `<div style="background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:14px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <span style="font-weight:700;font-size:14px;">${escapeHTML(c.company_name)}</span>
                        ${catBadge}
                    </div>
                    <div style="font-size:12px;color:#64748B;">
                        ${c.contact_name ? '👤 ' + escapeHTML(c.contact_name) + ' ' : ''}
                        ${c.phone ? '📞 ' + escapeHTML(c.phone) : ''}
                        ${c.industry ? ' · ' + escapeHTML(c.industry) : ''}
                    </div>
                    ${c.address ? '<div style="font-size:11px;color:#94A3B8;margin-top:4px;">📍 ' + escapeHTML(c.address) + '</div>' : ''}
                    <div style="display:flex;gap:6px;margin-top:8px;">
                        <button class="btn btn-secondary" onclick="editClient('${c.id}')" style="font-size:11px;padding:6px 12px;">編輯</button>
                        <button class="btn btn-secondary" onclick="toggleClientActive('${c.id}',${c.is_active})" style="font-size:11px;padding:6px 12px;color:${c.is_active ? '#EF4444' : '#059669'};">${c.is_active ? '停用' : '啟用'}</button>
                    </div>
                </div>`;
            }).join('');
        }

        function showClientModal(id) {
            document.getElementById('clientModal').style.display = 'block';
            document.getElementById('clientEditId').value = id || '';
            document.getElementById('clientModalTitle').textContent = id ? '編輯客戶' : '新增客戶';
            if (!id) {
                ['clientCompanyName','clientContactName','clientPhone','clientAddress','clientLat','clientLng','clientIndustry','clientNotes'].forEach(f => {
                    const el = document.getElementById(f); if (el) el.value = '';
                });
                document.getElementById('clientCategory').value = 'general';
            }
        }

        function closeClientModal() {
            document.getElementById('clientModal').style.display = 'none';
        }

        function editClient(id) {
            const c = adminClients.find(x => x.id === id);
            if (!c) return;
            showClientModal(id);
            document.getElementById('clientCompanyName').value = c.company_name || '';
            document.getElementById('clientContactName').value = c.contact_name || '';
            document.getElementById('clientPhone').value = c.phone || '';
            document.getElementById('clientAddress').value = c.address || '';
            document.getElementById('clientLat').value = c.latitude || '';
            document.getElementById('clientLng').value = c.longitude || '';
            document.getElementById('clientCategory').value = c.category || 'general';
            document.getElementById('clientIndustry').value = c.industry || '';
            document.getElementById('clientNotes').value = c.notes || '';
        }

        async function getClientGPS() {
            try {
                showToast('📍 定位中...');
                const loc = await getGPS();
                document.getElementById('clientLat').value = loc.latitude.toFixed(6);
                document.getElementById('clientLng').value = loc.longitude.toFixed(6);
                showToast('✅ 座標已取得');
            } catch(e) { showToast('❌ 定位失敗：' + friendlyError(e)); }
        }

        async function saveClient() {
            const name = document.getElementById('clientCompanyName').value.trim();
            if (!name) return showToast('請輸入公司名稱');
            const id = document.getElementById('clientEditId').value;
            const record = {
                company_name: name,
                contact_name: document.getElementById('clientContactName').value.trim(),
                phone: document.getElementById('clientPhone').value.trim(),
                address: document.getElementById('clientAddress').value.trim(),
                latitude: parseFloat(document.getElementById('clientLat').value) || null,
                longitude: parseFloat(document.getElementById('clientLng').value) || null,
                category: document.getElementById('clientCategory').value,
                industry: document.getElementById('clientIndustry').value.trim(),
                notes: document.getElementById('clientNotes').value.trim(),
                updated_at: new Date().toISOString()
            };
            try {
                if (id) {
                    const { error } = await sb.from('clients').update(record).eq('id', id);
                    if (error) throw error;
                    writeAuditLog('update_client','clients',id,name);
                    showToast('✅ 客戶已更新');
                } else {
                    const { error } = await sb.from('clients').insert(record);
                    if (error) throw error;
                    writeAuditLog('create_client','clients',null,name);
                    showToast('✅ 客戶已新增');
                }
                closeClientModal();
                loadClientList();
            } catch(e) { showToast('❌ 儲存失敗：' + friendlyError(e)); }
        }

        async function toggleClientActive(id, isActive) {
            const action = isActive ? '停用' : '啟用';
            if (!confirm(`確定${action}此客戶？`)) return;
            try {
                const { error } = await sb.from('clients').update({ is_active: !isActive, updated_at: new Date().toISOString() }).eq('id', id);
                if (error) throw error;
                showToast(`✅ 已${action}`);
                loadClientList();
            } catch(e) { showToast('❌ 操作失敗：' + friendlyError(e)); }
        }

        // ===== 服務項目管理 =====
        async function loadServiceItemList() {
            try {
                const { data } = await sb.from('service_items').select('*').order('name');
                const el = document.getElementById('serviceItemList');
                if (!el) return;
                if (!data || data.length === 0) {
                    el.innerHTML = '<p style="color:#94A3B8;font-size:12px;">尚無服務項目</p>';
                    return;
                }
                el.innerHTML = data.map(s =>
                    `<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #F1F5F9;">
                        <span style="flex:1;font-size:13px;font-weight:600;">${escapeHTML(s.name)}</span>
                        <span style="font-size:11px;color:#94A3B8;">${escapeHTML(s.code || '')}</span>
                        <button onclick="deleteServiceItem('${s.id}','${escapeHTML(s.name)}')" style="background:none;border:none;color:#EF4444;font-size:12px;cursor:pointer;">刪除</button>
                    </div>`
                ).join('');
            } catch(e) { console.error(e); }
        }

        async function addServiceItem() {
            const name = document.getElementById('newServiceItemName')?.value.trim();
            if (!name) return showToast('請輸入服務項目名稱');
            try {
                const { error } = await sb.from('service_items').insert({ name, code: name.substring(0, 10).toUpperCase() });
                if (error) throw error;
                document.getElementById('newServiceItemName').value = '';
                showToast('✅ 已新增');
                loadServiceItemList();
            } catch(e) { showToast('❌ 新增失敗：' + friendlyError(e)); }
        }

        async function deleteServiceItem(id, name) {
            if (!confirm(`確定刪除「${name}」？`)) return;
            try {
                const { error } = await sb.from('service_items').update({ is_active: false }).eq('id', id);
                if (error) throw error;
                showToast('✅ 已刪除');
                loadServiceItemList();
            } catch(e) { showToast('❌ 刪除失敗：' + friendlyError(e)); }
        }

        // ===== 外勤審核 =====
        let fwaLogs = [];

        function initFieldWorkApproval() {
            // 預設日期：今天
            const today = getTaiwanDate();
            document.getElementById('fwaDateFrom').value = today;
            document.getElementById('fwaDateTo').value = today;
            loadFieldWorkApprovals();
        }

        async function loadFieldWorkApprovals() {
            const from = document.getElementById('fwaDateFrom').value;
            const to = document.getElementById('fwaDateTo').value;
            const status = document.getElementById('fwaStatusFilter').value;
            if (!from || !to) return showToast('請選擇日期');

            try {
                let query = sb.from('field_work_logs')
                    .select('*, employees(name, employee_number), clients(company_name), service_items(name)')
                    .gte('work_date', from)
                    .lte('work_date', to)
                    .order('work_date', { ascending: false })
                    .order('arrive_time', { ascending: false });
                if (status) query = query.eq('status', status);

                const { data, error } = await query;
                if (error) throw error;
                fwaLogs = data || [];

                // 統計
                document.getElementById('fwaTotal').textContent = fwaLogs.length;
                document.getElementById('fwaPending').textContent = fwaLogs.filter(l => l.status === 'submitted').length;
                const totalH = fwaLogs.reduce((s, l) => s + (l.work_hours || 0), 0);
                document.getElementById('fwaTotalHours').textContent = totalH.toFixed(1);

                renderFieldWorkApprovals();
            } catch(e) {
                console.error(e);
                showToast('❌ 查詢失敗：' + friendlyError(e));
            }
        }

        function renderFieldWorkApprovals() {
            const el = document.getElementById('fwaList');
            if (!el) return;
            if (fwaLogs.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">無符合條件的紀錄</p>';
                return;
            }
            el.innerHTML = fwaLogs.map(log => {
                const statusMap = { draft:'🟡 草稿', submitted:'🔵 待審核', approved:'🟢 已核准', rejected:'🔴 已退回' };
                const statusLabel = statusMap[log.status] || log.status;
                const empName = log.employees?.name || '?';
                const clientName = log.clients?.company_name || '-';
                const serviceName = log.service_items?.name || '';
                const arriveT = log.arrive_time ? new Date(log.arrive_time).toLocaleTimeString('zh-TW', { hour:'2-digit', minute:'2-digit' }) : '--:--';
                const leaveT = log.leave_time ? new Date(log.leave_time).toLocaleTimeString('zh-TW', { hour:'2-digit', minute:'2-digit' }) : '--:--';
                const hours = log.work_hours ? log.work_hours.toFixed(1) + 'h' : '';

                return `<div style="background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:14px;margin-bottom:8px;cursor:pointer;" onclick="showFwaDetail('${log.id}')">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                        <span style="font-weight:700;font-size:13px;">${escapeHTML(empName)}</span>
                        <span style="font-size:12px;">${statusLabel}</span>
                    </div>
                    <div style="font-size:12px;color:#475569;margin-bottom:2px;">
                        🏢 ${escapeHTML(clientName)}
                        ${serviceName ? ' · ' + escapeHTML(serviceName) : ''}
                    </div>
                    <div style="font-size:11px;color:#94A3B8;">
                        ${log.work_date} ${arriveT} → ${leaveT} ${hours ? '(' + hours + ')' : ''}
                        ${log.mileage ? ' · ' + log.mileage + 'km' : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function showFwaDetail(logId) {
            const log = fwaLogs.find(l => l.id === logId);
            if (!log) return;
            const modal = document.getElementById('fwaDetailModal');
            const content = document.getElementById('fwaDetailContent');
            const actions = document.getElementById('fwaDetailActions');

            const empName = log.employees?.name || '?';
            const empNo = log.employees?.employee_number || '';
            const clientName = log.clients?.company_name || '-';
            const serviceName = log.service_items?.name || '-';
            const arriveT = log.arrive_time ? new Date(log.arrive_time).toLocaleString('zh-TW') : '-';
            const leaveT = log.leave_time ? new Date(log.leave_time).toLocaleString('zh-TW') : '-';

            let photosHtml = '';
            if (log.photo_urls && log.photo_urls.length > 0) {
                photosHtml = '<div style="margin-top:8px;"><b style="font-size:12px;">照片：</b><div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;">' +
                    log.photo_urls.map(url => `<img src="${url}" style="width:100px;height:100px;object-fit:cover;border-radius:8px;border:1px solid #E2E8F0;cursor:pointer;" onclick="window.open('${url}','_blank')">`).join('') +
                    '</div></div>';
            }

            let signatureHtml = '';
            if (log.signature_url) {
                signatureHtml = `<div style="margin-top:8px;"><b style="font-size:12px;">客戶簽名：</b><br><img src="${log.signature_url}" style="max-width:200px;border:1px solid #E2E8F0;border-radius:8px;margin-top:4px;"></div>`;
            }

            content.innerHTML = `
                <h3 style="margin-bottom:12px;">外勤明細</h3>
                <div style="font-size:13px;line-height:2;">
                    <div><b>員工：</b>${escapeHTML(empName)} (${escapeHTML(empNo)})</div>
                    <div><b>客戶：</b>${escapeHTML(clientName)}</div>
                    <div><b>服務項目：</b>${escapeHTML(serviceName)}</div>
                    <div><b>日期：</b>${log.work_date}</div>
                    <div><b>到達：</b>${arriveT}</div>
                    <div><b>離開：</b>${leaveT}</div>
                    <div><b>工時：</b>${log.work_hours ? log.work_hours.toFixed(1) + ' 小時' : '-'}</div>
                    <div><b>里程：</b>${log.mileage || 0} km</div>
                    ${log.arrive_lat ? `<div><b>到達GPS：</b>${log.arrive_lat.toFixed(5)}, ${log.arrive_lng.toFixed(5)}</div>` : ''}
                    ${log.leave_lat ? `<div><b>離開GPS：</b>${log.leave_lat.toFixed(5)}, ${log.leave_lng.toFixed(5)}</div>` : ''}
                    ${log.work_content ? `<div style="margin-top:6px;"><b>工作內容：</b><div style="background:#F8FAFC;padding:8px;border-radius:8px;margin-top:4px;white-space:pre-wrap;">${escapeHTML(log.work_content)}</div></div>` : ''}
                    ${log.notes ? `<div><b>備註：</b>${escapeHTML(log.notes)}</div>` : ''}
                </div>
                ${photosHtml}
                ${signatureHtml}
            `;

            if (log.status === 'submitted') {
                actions.innerHTML = `
                    <button class="btn btn-success" onclick="approveFieldWork('${log.id}')" style="flex:1;font-size:14px;padding:12px;">✅ 核准</button>
                    <button class="btn btn-secondary" onclick="rejectFieldWork('${log.id}')" style="flex:1;font-size:14px;padding:12px;color:#EF4444;">❌ 退回</button>
                `;
            } else {
                actions.innerHTML = '';
            }

            modal.style.display = 'block';
        }

        function closeFwaDetailModal() {
            document.getElementById('fwaDetailModal').style.display = 'none';
        }

        async function approveFieldWork(logId) {
            if (!confirm('確定核准此筆外勤紀錄？')) return;
            try {
                const { error } = await sb.from('field_work_logs').update({
                    status: 'approved',
                    updated_at: new Date().toISOString()
                }).eq('id', logId);
                if (error) throw error;
                writeAuditLog('approve_field_work','field_work_logs',logId,'核准');
                showToast('✅ 已核准');
                closeFwaDetailModal();
                loadFieldWorkApprovals();
            } catch(e) { showToast('❌ 操作失敗：' + friendlyError(e)); }
        }

        async function rejectFieldWork(logId) {
            const reason = prompt('退回原因（選填）：');
            if (reason === null) return;
            try {
                const { error } = await sb.from('field_work_logs').update({
                    status: 'rejected',
                    notes: reason || '退回',
                    updated_at: new Date().toISOString()
                }).eq('id', logId);
                if (error) throw error;
                writeAuditLog('reject_field_work','field_work_logs',logId,'退回');
                showToast('✅ 已退回');
                closeFwaDetailModal();
                loadFieldWorkApprovals();
            } catch(e) { showToast('❌ 操作失敗：' + friendlyError(e)); }
        }

        function exportFieldWorkCSV() {
            if (fwaLogs.length === 0) return showToast('無資料可匯出');
            const rows = [['日期','工號','姓名','客戶','服務項目','到達時間','離開時間','工時','里程(km)','工作內容','狀態','備註']];
            fwaLogs.forEach(l => {
                rows.push([
                    l.work_date,
                    l.employees?.employee_number || '',
                    l.employees?.name || '',
                    l.clients?.company_name || '',
                    l.service_items?.name || '',
                    l.arrive_time ? new Date(l.arrive_time).toLocaleString('zh-TW') : '',
                    l.leave_time ? new Date(l.leave_time).toLocaleString('zh-TW') : '',
                    l.work_hours || 0,
                    l.mileage || 0,
                    l.work_content || '',
                    l.status,
                    l.notes || ''
                ]);
            });
            const csv = '\uFEFF' + rows.map(r => r.map(c => `"${String(c??'').replace(/"/g,'""')}"`).join(',')).join('\n');
            const a = document.createElement('a');
            const from = document.getElementById('fwaDateFrom').value;
            const to = document.getElementById('fwaDateTo').value;
            const fn = `外勤紀錄_${from}_${to}.csv`;
            a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
            a.download = fn; a.click();
            writeAuditLog('export','field_work_logs',null,fn,{rows:rows.length-1});
            showToast(`✅ 已匯出 ${fn}（${rows.length-1} 筆）`);
        }

        // ===== 勞健保級距管理 =====
        let insBrackets = [];

        async function loadInsuranceBrackets() {
            try {
                const { data, error } = await sb.from('insurance_brackets')
                    .select('*').eq('is_active', true).order('salary_min');
                if (error) throw error;
                insBrackets = data || [];
                renderInsTable();

                // 顯示費率（取第一筆）
                if (insBrackets.length > 0) {
                    const b = insBrackets[0];
                    document.getElementById('insLaborRate').value = ((b.labor_rate || 0.125) * 100).toFixed(2);
                    document.getElementById('insLaborShare').value = ((b.labor_employee_share || 0.2) * 100).toFixed(2);
                    document.getElementById('insHealthRate').value = ((b.health_rate || 0.0517) * 100).toFixed(2);
                    document.getElementById('insHealthShare').value = ((b.health_employee_share || 0.3) * 100).toFixed(2);
                }
            } catch(e) { showToast('❌ 載入級距失敗'); console.error(e); }
        }

        function renderInsTable() {
            document.getElementById('insCount').textContent = insBrackets.length;
            const tbody = document.getElementById('insTableBody');
            if (insBrackets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding:20px;text-align:center;color:#94A3B8;">尚無級距資料</td></tr>';
                return;
            }
            tbody.innerHTML = insBrackets.map(b => `
                <tr style="border-bottom:1px solid #F1F5F9;">
                    <td style="padding:6px;text-align:right;">${Number(b.salary_min).toLocaleString()}</td>
                    <td style="padding:6px;text-align:right;">${Number(b.salary_max).toLocaleString()}</td>
                    <td style="padding:6px;text-align:right;font-weight:600;">${Number(b.insured_amount).toLocaleString()}</td>
                    <td style="padding:6px;text-align:center;">
                        <span onclick="editInsBracket('${b.id}')" style="cursor:pointer;margin-right:6px;">✏️</span>
                        <span onclick="deleteInsBracket('${b.id}')" style="cursor:pointer;">🗑️</span>
                    </td>
                </tr>
            `).join('');
        }

        function showInsModal(editData) {
            document.getElementById('insEditId').value = editData ? editData.id : '';
            document.getElementById('insModalTitle').textContent = editData ? '編輯級距' : '新增級距';
            document.getElementById('insSalaryMin').value = editData ? editData.salary_min : '';
            document.getElementById('insSalaryMax').value = editData ? editData.salary_max : '';
            document.getElementById('insAmount').value = editData ? editData.insured_amount : '';
            document.getElementById('insModal').style.display = 'block';
        }
        function closeInsModal() { document.getElementById('insModal').style.display = 'none'; }

        function editInsBracket(id) {
            const b = insBrackets.find(x => x.id === id);
            if (b) showInsModal(b);
        }

        async function saveInsBracket() {
            const id = document.getElementById('insEditId').value;
            const salaryMin = parseFloat(document.getElementById('insSalaryMin').value);
            const salaryMax = parseFloat(document.getElementById('insSalaryMax').value);
            const insuredAmount = parseFloat(document.getElementById('insAmount').value);

            if (isNaN(salaryMin) || isNaN(salaryMax) || isNaN(insuredAmount)) {
                showToast('⚠️ 請填寫完整'); return;
            }

            const laborRate = parseFloat(document.getElementById('insLaborRate').value) / 100;
            const laborShare = parseFloat(document.getElementById('insLaborShare').value) / 100;
            const healthRate = parseFloat(document.getElementById('insHealthRate').value) / 100;
            const healthShare = parseFloat(document.getElementById('insHealthShare').value) / 100;

            const row = {
                salary_min: salaryMin, salary_max: salaryMax, insured_amount: insuredAmount,
                labor_rate: laborRate, labor_employee_share: laborShare,
                health_rate: healthRate, health_employee_share: healthShare, is_active: true
            };

            try {
                if (id) {
                    const { error } = await sb.from('insurance_brackets').update(row).eq('id', id);
                    if (error) throw error;
                    writeAuditLog('update', 'insurance_brackets', id, `投保 ${insuredAmount}`);
                } else {
                    const { error } = await sb.from('insurance_brackets').insert(row);
                    if (error) throw error;
                    writeAuditLog('create', 'insurance_brackets', null, `投保 ${insuredAmount}`);
                }
                closeInsModal();
                showToast('✅ 已儲存');
                loadInsuranceBrackets();
            } catch(e) { showToast('❌ 儲存失敗'); console.error(e); }
        }

        async function deleteInsBracket(id) {
            if (!confirm('確定刪除此級距？')) return;
            try {
                const { error } = await sb.from('insurance_brackets').update({ is_active: false }).eq('id', id);
                if (error) throw error;
                writeAuditLog('delete', 'insurance_brackets', id);
                showToast('✅ 已刪除');
                loadInsuranceBrackets();
            } catch(e) { showToast('❌ 刪除失敗'); console.error(e); }
        }

        async function updateAllInsRates() {
            if (!confirm('確定將費率套用到所有級距？')) return;
            const laborRate = parseFloat(document.getElementById('insLaborRate').value) / 100;
            const laborShare = parseFloat(document.getElementById('insLaborShare').value) / 100;
            const healthRate = parseFloat(document.getElementById('insHealthRate').value) / 100;
            const healthShare = parseFloat(document.getElementById('insHealthShare').value) / 100;

            if (isNaN(laborRate) || isNaN(laborShare) || isNaN(healthRate) || isNaN(healthShare)) {
                showToast('⚠️ 費率格式錯誤'); return;
            }

            try {
                const { error } = await sb.from('insurance_brackets').update({
                    labor_rate: laborRate, labor_employee_share: laborShare,
                    health_rate: healthRate, health_employee_share: healthShare
                }).eq('is_active', true);
                if (error) throw error;
                writeAuditLog('update', 'insurance_brackets', null, `費率更新：勞保${(laborRate*100).toFixed(2)}%/${(laborShare*100).toFixed(2)}% 健保${(healthRate*100).toFixed(2)}%/${(healthShare*100).toFixed(2)}%`);
                showToast('✅ 費率已更新');
                loadInsuranceBrackets();
            } catch(e) { showToast('❌ 更新失敗'); console.error(e); }
        }

        // ===== 公司管理 =====
        let allCompanies = [];

        async function loadCompanyList() {
            try {
                const { data, error } = await sb.from('companies').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                allCompanies = data || [];

                // 取得每家公司的員工數
                const { data: empCounts } = await sb.from('employees')
                    .select('company_id').eq('is_active', true);
                const countMap = {};
                (empCounts || []).forEach(e => {
                    countMap[e.company_id] = (countMap[e.company_id] || 0) + 1;
                });
                allCompanies.forEach(c => { c._empCount = countMap[c.id] || 0; });

                renderCompanyList(allCompanies);
            } catch(e) { showToast('❌ 載入公司列表失敗'); console.error(e); }
        }

        function filterCompanies() {
            const q = (document.getElementById('companySearch').value || '').toLowerCase();
            const filtered = allCompanies.filter(c =>
                c.name.toLowerCase().includes(q) || (c.code || '').toLowerCase().includes(q)
            );
            renderCompanyList(filtered);
        }

        function renderCompanyList(list) {
            const el = document.getElementById('companyList');
            if (list.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">無公司資料</p>';
                return;
            }
            el.innerHTML = list.map(c => `
                <div style="background:#fff;border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,0.06);display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <div style="font-weight:700;font-size:15px;color:#0F172A;">${escapeHTML(c.name)}</div>
                        <div style="font-size:12px;color:#64748B;margin-top:2px;">代碼：${escapeHTML(c.code)} ｜ 員工：${c._empCount} 人</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <span style="font-size:11px;padding:2px 8px;border-radius:20px;background:${c.is_active?'#D1FAE5':'#FEE2E2'};color:${c.is_active?'#065F46':'#991B1B'};">${c.is_active?'啟用':'停用'}</span>
                        <span onclick="editCompany('${c.id}')" style="cursor:pointer;">✏️</span>
                    </div>
                </div>
            `).join('');
        }

        function showCompanyModal(editData) {
            document.getElementById('companyEditId').value = editData ? editData.id : '';
            document.getElementById('companyModalTitle').textContent = editData ? '編輯公司' : '新增公司';
            document.getElementById('companyCode').value = editData ? editData.code : '';
            document.getElementById('companyName').value = editData ? editData.name : '';
            document.getElementById('companyIsActive').value = editData ? String(editData.is_active) : 'true';
            document.getElementById('companyModal').style.display = 'block';
        }
        function closeCompanyModal() { document.getElementById('companyModal').style.display = 'none'; }

        function editCompany(id) {
            const c = allCompanies.find(x => x.id === id);
            if (c) showCompanyModal(c);
        }

        async function saveCompany() {
            const id = document.getElementById('companyEditId').value;
            const code = document.getElementById('companyCode').value.trim().toUpperCase();
            const name = document.getElementById('companyName').value.trim();
            const isActive = document.getElementById('companyIsActive').value === 'true';

            if (!code || !name) { showToast('⚠️ 請填寫代碼和名稱'); return; }

            const row = { code, name, is_active: isActive };

            try {
                if (id) {
                    const { error } = await sb.from('companies').update(row).eq('id', id);
                    if (error) throw error;
                    writeAuditLog('update', 'companies', id, name);
                } else {
                    const { error } = await sb.from('companies').insert(row);
                    if (error) throw error;
                    writeAuditLog('create', 'companies', null, `${name} (${code})`);
                }
                closeCompanyModal();
                showToast('✅ 已儲存');
                loadCompanyList();
            } catch(e) {
                if (String(e).includes('unique') || String(e?.message||'').includes('unique')) {
                    showToast('⚠️ 公司代碼已存在');
                } else {
                    showToast('❌ 儲存失敗'); console.error(e);
                }
            }
        }

        // ===== 商店管理 =====
        let smStores = [];
        let smCurrentStoreId = null;
        let smCategories = [];
        let smItems = [];

        async function loadStoreList() {
            try {
                let q = sb.from('store_profiles').select('*, clients(company_name)').order('created_at', { ascending: false });
                if (currentCompanyId) q = q.eq('company_id', currentCompanyId);
                const { data } = await q;
                smStores = data || [];
                renderStoreList();
            } catch(e) { console.error(e); }
        }

        function renderStoreList() {
            const el = document.getElementById('storeList');
            if (smStores.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">尚無商店</p>';
                return;
            }
            const typeLabel = { restaurant:'🍽️ 餐飲', service:'💈 服務', retail:'🛒 零售' };
            el.innerHTML = smStores.map(s => `
                <div style="background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:14px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <span style="font-weight:700;font-size:14px;">${escapeHTML(s.store_name)}</span>
                        <span style="font-size:11px;color:${s.is_active ? '#059669' : '#94A3B8'};">${s.is_active ? '營業中' : '暫停'}</span>
                    </div>
                    <div style="font-size:12px;color:#64748B;margin-bottom:8px;">
                        ${typeLabel[s.store_type] || s.store_type}
                        ${s.clients?.company_name ? ' · ' + escapeHTML(s.clients.company_name) : ''}
                        ${s.store_slug ? ' · <code>' + escapeHTML(s.store_slug) + '</code>' : ''}
                    </div>
                    <div style="display:flex;gap:6px;flex-wrap:wrap;">
                        <button onclick="editStore('${s.id}')" style="padding:6px 12px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:12px;cursor:pointer;">📝 編輯</button>
                        <button onclick="openMenuManage('${s.id}')" style="padding:6px 12px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:12px;cursor:pointer;">🍽️ 菜單</button>
                        <button onclick="showStoreQR('${s.id}')" style="padding:6px 12px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:12px;cursor:pointer;">📱 QR</button>
                        <button onclick="toggleStoreActive('${s.id}', ${!s.is_active})" style="padding:6px 12px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:12px;cursor:pointer;">${s.is_active ? '⏸️ 暫停' : '▶️ 啟用'}</button>
                    </div>
                </div>
            `).join('');
        }

        async function showStoreModal(storeId) {
            // 載入客戶下拉
            let cq = sb.from('clients').select('id, company_name').eq('is_active', true).order('company_name');
            if (currentCompanyId) cq = cq.eq('company_id', currentCompanyId);
            const { data: clients } = await cq;
            document.getElementById('storeClientSelect').innerHTML = '<option value="">-- 選擇客戶 --</option>' +
                (clients || []).map(c => `<option value="${c.id}">${escapeHTML(c.company_name)}</option>`).join('');

            if (storeId) {
                const s = smStores.find(x => x.id === storeId);
                if (!s) return;
                document.getElementById('storeModalTitle').textContent = '編輯商店';
                document.getElementById('storeEditId').value = s.id;
                document.getElementById('storeClientSelect').value = s.client_id || '';
                document.getElementById('storeNameInput').value = s.store_name;
                document.getElementById('storeSlugInput').value = s.store_slug || '';
                document.getElementById('storeTypeSelect').value = s.store_type || 'restaurant';
                document.getElementById('storeDescInput').value = s.description || '';
                document.getElementById('storePhoneInput').value = s.phone || '';
                document.getElementById('storeAddressInput').value = s.address || '';
                document.getElementById('storeColorInput').value = s.theme_color || '#4F46E5';
            } else {
                document.getElementById('storeModalTitle').textContent = '新增商店';
                document.getElementById('storeEditId').value = '';
                document.getElementById('storeClientSelect').value = '';
                document.getElementById('storeNameInput').value = '';
                document.getElementById('storeSlugInput').value = '';
                document.getElementById('storeTypeSelect').value = 'restaurant';
                document.getElementById('storeDescInput').value = '';
                document.getElementById('storePhoneInput').value = '';
                document.getElementById('storeAddressInput').value = '';
                document.getElementById('storeColorInput').value = '#4F46E5';
            }
            document.getElementById('storeModal').style.display = 'flex';
        }

        function editStore(id) { showStoreModal(id); }
        function closeStoreModal() { document.getElementById('storeModal').style.display = 'none'; }

        async function saveStore() {
            const name = document.getElementById('storeNameInput').value.trim();
            const clientId = document.getElementById('storeClientSelect').value;
            if (!name) return showToast('請輸入商店名稱');
            if (!clientId) return showToast('請選擇關聯客戶');

            const record = {
                client_id: clientId,
                store_name: name,
                store_slug: document.getElementById('storeSlugInput').value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '') || null,
                store_type: document.getElementById('storeTypeSelect').value,
                description: document.getElementById('storeDescInput').value.trim() || null,
                phone: document.getElementById('storePhoneInput').value.trim() || null,
                address: document.getElementById('storeAddressInput').value.trim() || null,
                theme_color: document.getElementById('storeColorInput').value
            };
            if (currentCompanyId) record.company_id = currentCompanyId;

            try {
                const editId = document.getElementById('storeEditId').value;
                if (editId) {
                    record.updated_at = new Date().toISOString();
                    await sb.from('store_profiles').update(record).eq('id', editId);
                } else {
                    await sb.from('store_profiles').insert(record);
                }
                showToast('✅ 商店已儲存');
                closeStoreModal();
                await loadStoreList();
            } catch(e) {
                console.error(e);
                showToast('❌ 儲存失敗：' + friendlyError(e));
            }
        }

        async function toggleStoreActive(id, active) {
            try {
                await sb.from('store_profiles').update({ is_active: active, updated_at: new Date().toISOString() }).eq('id', id);
                showToast(active ? '✅ 已啟用' : '⏸️ 已暫停');
                await loadStoreList();
            } catch(e) { showToast('❌ 操作失敗'); }
        }

        function showStoreQR(storeId) {
            const s = smStores.find(x => x.id === storeId);
            if (!s) return;
            const slug = s.store_slug || s.id;
            const url = `${location.origin}/order.html?store=${slug}`;
            document.getElementById('storeQRTitle').textContent = s.store_name;
            document.getElementById('storeQRUrl').textContent = url;
            const qrEl = document.getElementById('storeQRCode');
            qrEl.innerHTML = '';
            if (typeof QRCode !== 'undefined') {
                new QRCode(qrEl, { text: url, width: 200, height: 200 });
            } else {
                qrEl.innerHTML = '<p style="color:#94A3B8;">QRCode 元件未載入</p>';
            }
            document.getElementById('storeQRModal').style.display = 'flex';
        }

        function closeStoreQR() { document.getElementById('storeQRModal').style.display = 'none'; }

        // --- 菜單管理 ---
        async function openMenuManage(storeId) {
            smCurrentStoreId = storeId;
            const s = smStores.find(x => x.id === storeId);
            document.getElementById('menuManageTitle').textContent = (s?.store_name || '') + ' 菜單管理';

            await Promise.all([loadMenuCategories(), loadMenuItems()]);
            document.getElementById('menuManageModal').style.display = 'flex';
        }

        function closeMenuManage() {
            document.getElementById('menuManageModal').style.display = 'none';
            smCurrentStoreId = null;
        }

        async function loadMenuCategories() {
            const { data } = await sb.from('menu_categories')
                .select('*')
                .eq('store_id', smCurrentStoreId)
                .order('sort_order');
            smCategories = data || [];
            renderMenuCatList();
            updateMiCategorySelect();
        }

        function renderMenuCatList() {
            const el = document.getElementById('menuCatList');
            if (smCategories.length === 0) {
                el.innerHTML = '<p style="font-size:12px;color:#94A3B8;">尚無分類</p>';
                return;
            }
            el.innerHTML = smCategories.map(c => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #F1F5F9;">
                    <span style="font-size:13px;font-weight:600;">${escapeHTML(c.name)}</span>
                    <button onclick="deleteMenuCategory('${c.id}')" style="background:none;border:none;color:#EF4444;cursor:pointer;font-size:12px;">刪除</button>
                </div>
            `).join('');
        }

        function updateMiCategorySelect() {
            const sel = document.getElementById('miCategory');
            sel.innerHTML = '<option value="">-- 不分類 --</option>' +
                smCategories.map(c => `<option value="${c.id}">${escapeHTML(c.name)}</option>`).join('');
        }

        async function addMenuCategory() {
            const name = document.getElementById('newCatName').value.trim();
            if (!name) return showToast('請輸入分類名稱');
            try {
                await sb.from('menu_categories').insert({
                    store_id: smCurrentStoreId,
                    name: name,
                    sort_order: smCategories.length
                });
                document.getElementById('newCatName').value = '';
                showToast('✅ 分類已新增');
                await loadMenuCategories();
            } catch(e) { showToast('❌ 新增失敗'); }
        }

        async function deleteMenuCategory(id) {
            if (!confirm('確定刪除此分類？（品項不會被刪除）')) return;
            try {
                await sb.from('menu_categories').delete().eq('id', id);
                showToast('✅ 已刪除');
                await loadMenuCategories();
            } catch(e) { showToast('❌ 刪除失敗'); }
        }

        async function loadMenuItems() {
            const { data } = await sb.from('menu_items')
                .select('*, menu_categories(name)')
                .eq('store_id', smCurrentStoreId)
                .order('sort_order');
            smItems = data || [];
            renderMenuItemList();
        }

        function renderMenuItemList() {
            const el = document.getElementById('menuItemList');
            if (smItems.length === 0) {
                el.innerHTML = '<p style="font-size:12px;color:#94A3B8;text-align:center;">尚無品項</p>';
                return;
            }
            el.innerHTML = smItems.map(i => `
                <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #F1F5F9;">
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:600;font-size:13px;">${escapeHTML(i.name)} ${!i.is_available ? '<span style="color:#EF4444;font-size:11px;">售完</span>' : ''}</div>
                        <div style="font-size:11px;color:#64748B;">${i.menu_categories?.name || '未分類'} · $${i.price}</div>
                    </div>
                    <button onclick="editMenuItem('${i.id}')" style="padding:4px 10px;border:1px solid #E2E8F0;border-radius:6px;background:#fff;font-size:11px;cursor:pointer;">編輯</button>
                    <button onclick="toggleItemAvail('${i.id}', ${!i.is_available})" style="padding:4px 10px;border:1px solid #E2E8F0;border-radius:6px;background:#fff;font-size:11px;cursor:pointer;">${i.is_available ? '下架' : '上架'}</button>
                </div>
            `).join('');
        }

        function showMenuItemForm(itemId) {
            document.getElementById('menuItemForm').style.display = 'block';
            if (itemId) {
                const i = smItems.find(x => x.id === itemId);
                if (!i) return;
                document.getElementById('miEditId').value = i.id;
                document.getElementById('miName').value = i.name;
                document.getElementById('miCategory').value = i.category_id || '';
                document.getElementById('miPrice').value = i.price;
                document.getElementById('miDesc').value = i.description || '';
            } else {
                document.getElementById('miEditId').value = '';
                document.getElementById('miName').value = '';
                document.getElementById('miCategory').value = '';
                document.getElementById('miPrice').value = '';
                document.getElementById('miDesc').value = '';
            }
        }

        function editMenuItem(id) { showMenuItemForm(id); }
        function cancelMenuItemForm() { document.getElementById('menuItemForm').style.display = 'none'; }

        async function saveMenuItem() {
            const name = document.getElementById('miName').value.trim();
            const price = parseFloat(document.getElementById('miPrice').value);
            if (!name) return showToast('請輸入品名');
            if (isNaN(price) || price < 0) return showToast('請輸入有效價格');

            const record = {
                store_id: smCurrentStoreId,
                name: name,
                category_id: document.getElementById('miCategory').value || null,
                price: price,
                description: document.getElementById('miDesc').value.trim() || null
            };

            try {
                const editId = document.getElementById('miEditId').value;
                if (editId) {
                    record.updated_at = new Date().toISOString();
                    await sb.from('menu_items').update(record).eq('id', editId);
                } else {
                    record.sort_order = smItems.length;
                    await sb.from('menu_items').insert(record);
                }
                showToast('✅ 品項已儲存');
                cancelMenuItemForm();
                await loadMenuItems();
            } catch(e) {
                console.error(e);
                showToast('❌ 儲存失敗');
            }
        }

        async function toggleItemAvail(id, avail) {
            try {
                await sb.from('menu_items').update({ is_available: avail, updated_at: new Date().toISOString() }).eq('id', id);
                showToast(avail ? '✅ 已上架' : '⏸️ 已下架');
                await loadMenuItems();
            } catch(e) { showToast('❌ 操作失敗'); }
        }

        // ===== 訂單管理 =====
        let omOrders = [];

        async function initOrderManage() {
            // 填充商店下拉
            let sq = sb.from('store_profiles').select('id, store_name').eq('is_active', true);
            if (currentCompanyId) sq = sq.eq('company_id', currentCompanyId);
            const { data: stores } = await sq;
            document.getElementById('omStoreFilter').innerHTML = '<option value="">全部商店</option>' +
                (stores || []).map(s => `<option value="${s.id}">${escapeHTML(s.store_name)}</option>`).join('');
            await loadOrderList();
        }

        async function loadOrderList() {
            try {
                let q = sb.from('orders').select('*, store_profiles(store_name)').order('created_at', { ascending: false }).limit(100);
                const storeFilter = document.getElementById('omStoreFilter').value;
                const statusFilter = document.getElementById('omStatusFilter').value;
                if (storeFilter) q = q.eq('store_id', storeFilter);
                if (statusFilter) q = q.eq('status', statusFilter);

                const { data } = await q;
                omOrders = data || [];
                renderOrderList();
                updateOrderStats();
            } catch(e) { console.error(e); }
        }

        function updateOrderStats() {
            const today = fmtDate(new Date());
            const todayOrders = omOrders.filter(o => o.created_at && o.created_at.startsWith(today));
            const pending = omOrders.filter(o => o.status === 'pending').length;
            const revenue = todayOrders.filter(o => o.status !== 'cancelled').reduce((s, o) => s + (parseFloat(o.total) || 0), 0);

            document.getElementById('omPendingCount').textContent = pending;
            document.getElementById('omTodayCount').textContent = todayOrders.length;
            document.getElementById('omTodayRevenue').textContent = '$' + revenue;
        }

        function renderOrderList() {
            const el = document.getElementById('orderList');
            if (omOrders.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">尚無訂單</p>';
                return;
            }
            const statusMap = {
                pending: { label:'待處理', color:'#92400E', bg:'#FEF3C7' },
                confirmed: { label:'已確認', color:'#1E40AF', bg:'#DBEAFE' },
                preparing: { label:'準備中', color:'#7C3AED', bg:'#F5F3FF' },
                ready: { label:'可取餐', color:'#059669', bg:'#D1FAE5' },
                completed: { label:'已完成', color:'#64748B', bg:'#F1F5F9' },
                cancelled: { label:'已取消', color:'#DC2626', bg:'#FEF2F2' }
            };
            el.innerHTML = omOrders.map(o => {
                const st = statusMap[o.status] || { label:o.status, color:'#64748B', bg:'#F1F5F9' };
                const time = o.created_at ? new Date(o.created_at).toLocaleString('zh-TW', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }) : '';
                const itemCount = (o.items || []).reduce((s, i) => s + (i.qty || 1), 0);
                return `<div onclick="showOrderDetail('${o.id}')" style="background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:14px;margin-bottom:8px;cursor:pointer;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                        <span style="font-weight:700;font-size:14px;">#${escapeHTML(o.order_number)}</span>
                        <span style="font-size:11px;font-weight:600;padding:2px 10px;border-radius:10px;background:${st.bg};color:${st.color};">${st.label}</span>
                    </div>
                    <div style="font-size:12px;color:#64748B;">
                        ${o.store_profiles?.store_name ? escapeHTML(o.store_profiles.store_name) + ' · ' : ''}
                        ${escapeHTML(o.customer_name || '?')}
                        ${o.table_number ? ' · 桌' + escapeHTML(o.table_number) : ''}
                        · ${itemCount}品 · <b>$${o.total}</b>
                        · ${time}
                    </div>
                </div>`;
            }).join('');
        }

        function showOrderDetail(orderId) {
            const o = omOrders.find(x => x.id === orderId);
            if (!o) return;
            document.getElementById('odTitle').textContent = '#' + o.order_number;
            const typeLabel = { dine_in:'內用', takeout:'外帶', delivery:'外送' };
            const items = o.items || [];
            document.getElementById('odContent').innerHTML = `
                <div style="margin-bottom:12px;">
                    <div style="font-size:13px;color:#64748B;">顧客</div>
                    <div style="font-weight:600;">${escapeHTML(o.customer_name || '?')} ${o.customer_phone ? '· ' + escapeHTML(o.customer_phone) : ''}</div>
                    <div style="font-size:13px;color:#64748B;">${typeLabel[o.order_type] || ''} ${o.table_number ? '· 桌號 ' + escapeHTML(o.table_number) : ''}</div>
                </div>
                <div style="border-top:1px solid #F1F5F9;padding-top:8px;">
                    ${items.map(i => `<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:14px;">
                        <span>${escapeHTML(i.name)} x${i.qty}</span>
                        <span style="font-weight:600;">$${i.subtotal || i.price * i.qty}</span>
                    </div>`).join('')}
                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-top:1px solid #E2E8F0;margin-top:4px;font-weight:800;">
                        <span>合計</span><span>$${o.total}</span>
                    </div>
                </div>
                ${o.notes ? '<div style="margin-top:8px;font-size:13px;color:#64748B;">備註：' + escapeHTML(o.notes) + '</div>' : ''}
            `;

            // 狀態操作按鈕
            const actions = [];
            if (o.status === 'pending') {
                actions.push(`<button onclick="updateOrderStatus('${o.id}','confirmed')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#2563EB;color:#fff;font-weight:600;cursor:pointer;">✅ 確認</button>`);
                actions.push(`<button onclick="updateOrderStatus('${o.id}','cancelled')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#EF4444;color:#fff;font-weight:600;cursor:pointer;">❌ 取消</button>`);
            }
            if (o.status === 'confirmed') {
                actions.push(`<button onclick="updateOrderStatus('${o.id}','preparing')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#7C3AED;color:#fff;font-weight:600;cursor:pointer;">🍳 開始準備</button>`);
            }
            if (o.status === 'preparing') {
                actions.push(`<button onclick="updateOrderStatus('${o.id}','ready')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#059669;color:#fff;font-weight:600;cursor:pointer;">🔔 可取餐</button>`);
            }
            if (o.status === 'ready') {
                actions.push(`<button onclick="updateOrderStatus('${o.id}','completed')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#64748B;color:#fff;font-weight:600;cursor:pointer;">✅ 完成</button>`);
            }
            document.getElementById('odActions').innerHTML = actions.join('');
            document.getElementById('orderDetailModal').style.display = 'flex';
        }

        function closeOrderDetail() { document.getElementById('orderDetailModal').style.display = 'none'; }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                await sb.from('orders').update({ status: newStatus, updated_at: new Date().toISOString() }).eq('id', orderId);
                showToast('✅ 狀態已更新');
                closeOrderDetail();
                await loadOrderList();
            } catch(e) {
                console.error(e);
                showToast('❌ 更新失敗');
            }
        }

        // ===== 業務目標管理 =====
        let stWeekStart = null;
        let stEmployees = [];

        function stGetMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            date.setDate(diff);
            date.setHours(0, 0, 0, 0);
            return date;
        }

        function stGetSunday(monday) {
            const sun = new Date(monday);
            sun.setDate(sun.getDate() + 6);
            return sun;
        }

        async function initSalesTargetPage() {
            stWeekStart = stGetMonday(new Date());
            await loadSalesTargetData();
        }

        function stChangeWeek(offset) {
            stWeekStart.setDate(stWeekStart.getDate() + offset * 7);
            loadSalesTargetData();
        }

        async function loadSalesTargetData() {
            const monday = fmtDate(stWeekStart);
            const sunday = fmtDate(stGetSunday(stWeekStart));

            document.getElementById('stWeekLabel').textContent =
                `${monday.substring(5).replace('-','/')} ~ ${sunday.substring(5).replace('-','/')}`;

            try {
                // 載入全員預設目標
                const { data: defaultTarget } = await sb.from('sales_targets')
                    .select('*')
                    .is('employee_id', null)
                    .eq('week_start', monday)
                    .maybeSingle();

                document.getElementById('stDefaultCall').value = defaultTarget?.call_target || 0;
                document.getElementById('stDefaultVisit').value = defaultTarget?.visit_target || 0;

                // 載入所有業務員（role = user 或全部）
                let empQuery = sb.from('employees').select('id, name, employee_number, role').eq('is_active', true);
                if (currentCompanyId) empQuery = empQuery.eq('company_id', currentCompanyId);
                const { data: employees } = await empQuery.order('name');
                stEmployees = employees || [];

                // 載入個人目標
                const { data: targets } = await sb.from('sales_targets')
                    .select('*')
                    .eq('week_start', monday)
                    .not('employee_id', 'is', null);
                const targetMap = {};
                (targets || []).forEach(t => { targetMap[t.employee_id] = t; });

                // 載入本週所有活動
                const { data: activities } = await sb.from('sales_activities')
                    .select('employee_id, activity_type')
                    .gte('activity_date', monday)
                    .lte('activity_date', sunday);

                // 統計每人達成
                const activityCount = {};
                (activities || []).forEach(a => {
                    if (!activityCount[a.employee_id]) activityCount[a.employee_id] = { call: 0, visit: 0 };
                    if (a.activity_type === 'call') activityCount[a.employee_id].call++;
                    if (a.activity_type === 'visit') activityCount[a.employee_id].visit++;
                });

                renderSalesTargetProgress(targetMap, activityCount, defaultTarget);
            } catch(e) {
                console.error('載入業務目標失敗', e);
                document.getElementById('stProgressList').innerHTML = '<p style="color:#ef4444;text-align:center;">載入失敗</p>';
            }
        }

        function renderSalesTargetProgress(targetMap, activityCount, defaultTarget) {
            const el = document.getElementById('stProgressList');
            if (stEmployees.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;">尚無員工資料</p>';
                return;
            }

            const defCall = defaultTarget?.call_target || 0;
            const defVisit = defaultTarget?.visit_target || 0;

            el.innerHTML = stEmployees.map(emp => {
                const t = targetMap[emp.id];
                const callTarget = t ? t.call_target : defCall;
                const visitTarget = t ? t.visit_target : defVisit;
                const done = activityCount[emp.id] || { call: 0, visit: 0 };
                const callPct = callTarget > 0 ? Math.min(100, Math.round(done.call / callTarget * 100)) : 0;
                const visitPct = visitTarget > 0 ? Math.min(100, Math.round(done.visit / visitTarget * 100)) : 0;

                return `<div style="background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:14px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="font-weight:700;font-size:14px;">${escapeHTML(emp.name)}</span>
                        <span style="font-size:11px;color:#94A3B8;">${escapeHTML(emp.employee_number || '')}</span>
                    </div>
                    <div style="display:flex;gap:12px;">
                        <div style="flex:1;">
                            <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:2px;">
                                <span>📞 電話</span>
                                <span style="font-weight:700;">${done.call}/${callTarget}</span>
                            </div>
                            <div style="width:100%;height:6px;background:#E2E8F0;border-radius:3px;overflow:hidden;">
                                <div style="height:100%;background:${callPct >= 100 ? '#059669' : '#4F46E5'};width:${callPct}%;border-radius:3px;"></div>
                            </div>
                        </div>
                        <div style="flex:1;">
                            <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:2px;">
                                <span>🏢 拜訪</span>
                                <span style="font-weight:700;">${done.visit}/${visitTarget}</span>
                            </div>
                            <div style="width:100%;height:6px;background:#E2E8F0;border-radius:3px;overflow:hidden;">
                                <div style="height:100%;background:${visitPct >= 100 ? '#059669' : '#10B981'};width:${visitPct}%;border-radius:3px;"></div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function saveDefaultTarget() {
            const callTarget = parseInt(document.getElementById('stDefaultCall').value) || 0;
            const visitTarget = parseInt(document.getElementById('stDefaultVisit').value) || 0;
            const weekStart = fmtDate(stWeekStart);

            try {
                const record = {
                    employee_id: null,
                    week_start: weekStart,
                    call_target: callTarget,
                    visit_target: visitTarget,
                    created_by: currentAdminEmployee?.id || null
                };
                if (currentCompanyId) record.company_id = currentCompanyId;

                // upsert: employee_id=NULL + week_start unique
                // 先查有沒有
                const { data: existing } = await sb.from('sales_targets')
                    .select('id')
                    .is('employee_id', null)
                    .eq('week_start', weekStart)
                    .maybeSingle();

                if (existing) {
                    await sb.from('sales_targets').update({
                        call_target: callTarget,
                        visit_target: visitTarget
                    }).eq('id', existing.id);
                } else {
                    await sb.from('sales_targets').insert(record);
                }

                showToast('✅ 預設目標已儲存');
                await loadSalesTargetData();
            } catch(e) {
                console.error(e);
                showToast('❌ 儲存失敗：' + friendlyError(e));
            }
        }

        // 頁面載入
        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') {
                console.error('common.js 未正確載入');
                return;
            }
            checkAdminPermission();
        });
    </script>
</body>
</html>
