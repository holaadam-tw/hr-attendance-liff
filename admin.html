<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>👑 管理後台 - 員工服務中心</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        #lcTable th, #lcTable td, #smTable th, #smTable td { border: 1px solid #F1F5F9; }
        #smTable td:hover { filter: brightness(0.92); }
        #lcTable th, #smTable th { position: sticky; top: 0; background: #fff; z-index: 1; }
    </style>
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>系統載入中...</p>
    </div>

    <div class="container">
        <!-- 權限檢查頁面 -->
        <div id="permissionPage" class="page active">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">🔐</span>
                    <h2>管理員權限檢查</h2>
                    <p>正在驗證您的管理員身份...</p>
                </div>
                <div id="permissionStatus" class="status-box show info">
                    檢查權限中...
                </div>
            </div>
        </div>

        <!-- 管理後台首頁 -->
        <div id="adminHomePage" class="page">
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="adminAvatar">👑</div>
                    <div class="user-details">
                        <h2 id="adminName">管理員</h2>
                        <p id="adminDept">系統管理</p>
                        <p id="adminId" style="font-size: 11px; opacity: 0.7;">ID: -</p>
                    </div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="showPage('bonusPage')">
                    <div class="icon">🎁</div><div class="label">年終獎金試算</div>
                </div>
                <div class="menu-item" onclick="showPage('locationPage')">
                    <div class="icon">📍</div><div class="label">地點管理</div>
                </div>
                <div class="menu-item" onclick="showPage('employeePage')">
                    <div class="icon">👥</div><div class="label">員工管理</div>
                </div>
                <div class="menu-item" onclick="showPage('leaveApprovalPage')">
                    <div class="icon">✅</div><div class="label">請假審核</div>
                </div>
                <div class="menu-item" onclick="showPage('makeupApprovalPage')">
                    <div class="icon">🔧</div><div class="label">補打卡審核</div>
                </div>
                <div class="menu-item" onclick="showPage('overtimeApprovalPage')">
                    <div class="icon">⏰</div><div class="label">加班審核</div>
                </div>
                <div class="menu-item" onclick="showPage('swapApprovalPage')">
                    <div class="icon">🔄</div><div class="label">換班審核</div>
                </div>
                <div class="menu-item" onclick="showPage('announcementPage')">
                    <div class="icon">📢</div><div class="label">公告管理</div>
                </div>
                <div class="menu-item" onclick="showPage('reportPage')">
                    <div class="icon">📊</div><div class="label">報表匯出</div>
                </div>
                <div class="menu-item" onclick="showPage('staffMgrPage')">
                    <div class="icon">📋</div><div class="label">人力管理</div>
                </div>
                <div class="menu-item" onclick="showPage('featurePage')">
                    <div class="icon">🎛️</div><div class="label">功能管理</div>
                </div>
                <div class="menu-item" onclick="showPage('auditLogPage')">
                    <div class="icon">📜</div><div class="label">操作日誌</div>
                </div>
                <div class="menu-item" onclick="window.location.href='index.html'">
                    <div class="icon">🏠</div><div class="label">返回首頁</div>
                </div>
            </div>
        </div>

        <!-- 年終獎金試算頁面 (混合精算) -->
        <div id="bonusPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>🎁 年終獎金試算</h2>
                <div class="form-group">
                    <label>試算年度</label>
                    <select id="bonusYear" onchange="loadHybridBonusData()"></select>
                </div>

                <div id="bonusLoading" style="text-align:center;color:#666;padding:30px;display:none;">⏳ 載入中...</div>

                <div class="lunch-summary" id="bonusSummary" style="display:none;">
                    <h3 style="margin-bottom:15px;">📈 試算摘要</h3>
                    <div class="stat-row"><span>符合資格人數</span><span id="eligibleCount">0</span></div>
                    <div class="stat-row"><span>總預算</span><span id="totalBudget">$0</span></div>
                    <div class="stat-row"><span>平均獎金</span><span id="avgBonus">$0</span></div>
                </div>

                <div id="matrixRef" style="display:none;">
                    <div onclick="toggleMatrixRef()" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#F5F3FF;border-radius:12px;margin-bottom:10px;">
                        <span style="font-weight:700;font-size:13px;color:#4F46E5;">📊 獎金矩陣參考表</span>
                        <span id="matrixRefArrow" style="font-size:12px;color:#4F46E5;">▼</span>
                    </div>
                    <div id="matrixRefBody" style="display:none;overflow-x:auto;margin-bottom:16px;"></div>
                </div>

                <div id="bonusList" style="margin-top:10px;"></div>

                <div id="bonusActions" style="display:none;margin-top:20px;">
                    <button class="btn btn-success" onclick="saveAllBonuses()" id="saveAllBonusBtn">💾 儲存全部獎金</button>
                    <button class="btn btn-secondary" onclick="exportBonusCSV()" style="margin-top:8px;">📊 匯出 CSV</button>
                </div>
            </div>
        </div>

        <!-- 地點管理頁面 -->
        <div id="locationPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>📍 地點管理</h2>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:10px;">📍 目前打卡地點</h3>
                    <!-- [BUG FIX] 使用與 common.js 一致的 ID -->
                    <div id="locationList">
                        <p style="color:#666;text-align:center;">載入中...</p>
                    </div>
                </div>

                <div style="margin-top: 20px; background:#fff; border-radius:16px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                    <h3 style="margin-bottom:15px;">➕ 新增地點</h3>
                    <div class="form-group">
                        <label>地點名稱</label>
                        <!-- [BUG FIX] 使用與 common.js 一致的 ID -->
                        <input type="text" id="newLocName" placeholder="例如：台北分店">
                    </div>
                    <div class="form-group">
                        <label>打卡半徑 (公尺)</label>
                        <input type="number" id="newLocRadius" value="300">
                    </div>
                    <div class="form-group">
                        <label>座標 (緯度, 經度)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="newLocLat" placeholder="緯度" readonly>
                            <input type="text" id="newLocLng" placeholder="經度" readonly>
                        </div>
                        <button class="btn btn-primary" onclick="getCurrentGPSForSetting()" style="margin-top:10px; font-size:14px; padding:10px;">
                            📍 抓取目前位置
                        </button>
                    </div>
                    <button class="btn btn-success" onclick="addNewLocation()">💾 儲存新地點</button>
                </div>
            </div>
        </div>

        <!-- 員工管理頁面 -->
        <div id="employeePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h2 style="margin:0;">👥 員工管理</h2>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-success" onclick="showAddEmployeeModal()" style="font-size:13px; padding:8px 14px; width:auto; margin:0;">
                            ➕ 新增
                        </button>
                        <button class="btn btn-primary" onclick="showJoinQRCode()" style="font-size:13px; padding:8px 14px; width:auto; margin:0;">
                            📱 QR Code
                        </button>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom:15px;">
                    <input type="text" id="employeeSearch" placeholder="🔍 搜尋姓名或工號" onkeyup="searchEmployees()">
                </div>
                <div id="employeeList">
                    <p style="text-align:center;color:#666;">載入中...</p>
                </div>
            </div>
        </div>

        <!-- 新增員工 Modal -->
        <div id="addEmployeeModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>➕ 新增員工</h3>
                    <button class="modal-close" onclick="closeAddEmployeeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addEmployeeForm">
                        <div class="form-group">
                            <label>姓名 *</label>
                            <input type="text" id="newEmployeeName" required placeholder="請輸入員工姓名">
                        </div>
                        <div class="form-group">
                            <label>工號 *</label>
                            <input type="text" id="newEmployeeNumber" required placeholder="例如：E001">
                        </div>
                        <div class="form-group">
                            <label>部門</label>
                            <select id="newEmployeeDepartment">
                                <option value="管理部">管理部</option>
                                <option value="業務部">業務部</option>
                                <option value="技術部">技術部</option>
                                <option value="人事部">人事部</option>
                                <option value="財務部">財務部</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>職位</label>
                            <input type="text" id="newEmployeePosition" placeholder="例如：專員">
                        </div>
                        <div class="form-group">
                            <label>驗證碼 *</label>
                            <input type="text" id="newEmployeeCode" required placeholder="身分證後4碼或自訂驗證碼">
                            <small style="color:#666; font-size:12px; display:block; margin-top:5px;">
                                💡 建議使用身分證後4碼，員工綁定時需要輸入此驗證碼
                            </small>
                        </div>
                        <div class="form-group">
                            <label>到職日期</label>
                            <input type="date" id="newEmployeeHireDate">
                        </div>
                        <div class="form-group">
                            <label>角色權限</label>
                            <select id="newEmployeeRole">
                                <option value="user">一般員工</option>
                                <option value="manager">主管</option>
                                <option value="admin">管理員</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button type="submit" class="btn btn-success" style="flex:1;">💾 儲存員工</button>
                            <button type="button" class="btn btn-secondary" onclick="closeAddEmployeeModal()" style="flex:1;">取消</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div id="qrModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>📱 員工加入 QR Code</h3>
                    <button class="modal-close" onclick="closeQRModal()">&times;</button>
                </div>
                <div class="modal-body" style="text-align:center;">
                    <div id="qrcode" style="margin:20px auto; display:inline-block;"></div>
                    <div style="margin-top:20px; padding:15px; background:#f3f4f6; border-radius:12px;">
                        <p style="margin:0; font-size:14px; color:#666;">公司代碼</p>
                        <p style="margin:5px 0; font-size:18px; font-weight:bold; color:#1f2937;">HR_SYSTEM_001</p>
                        <p style="margin:5px 0; font-size:12px; color:#9ca3af;">無法掃碼時請手動輸入此代碼</p>
                    </div>
                    <div style="margin-top:15px; padding:12px; background:#fef3c7; border-radius:8px; border-left:4px solid #f59e0b; text-align:left;">
                        <p style="margin:0; font-size:13px; color:#92400e;">
                            <strong>使用說明：</strong><br>
                            1. 員工掃描此 QR Code<br>
                            2. 輸入工號和驗證碼<br>
                            3. 完成綁定即可使用系統
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 請假審核頁面 -->
        <div id="leaveApprovalPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>✅ 請假審核</h2>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchLeaveTab('pending')">待審核</button>
                    <button class="tab-btn inactive" onclick="switchLeaveTab('approved')">已通過</button>
                    <button class="tab-btn inactive" onclick="switchLeaveTab('rejected')">已拒絕</button>
                </div>
                <div id="leaveApprovalList">
                    <p style="text-align:center;color:#666;">載入中...</p>
                </div>
            </div>
        </div>

        <!-- ====== 補打卡審核 ====== -->
        <div id="makeupApprovalPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>🔧 補打卡審核</h2>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchMakeupTab('pending')">待審核</button>
                    <button class="tab-btn inactive" onclick="switchMakeupTab('approved')">已通過</button>
                    <button class="tab-btn inactive" onclick="switchMakeupTab('rejected')">已拒絕</button>
                </div>
                <div id="makeupApprovalList"><p style="text-align:center;color:#666;">載入中...</p></div>
            </div>
        </div>

        <!-- ====== 公告管理 ====== -->
        <div id="announcementPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>📢 公告管理</h2>
                <p style="color:#94A3B8;font-size:12px;margin-bottom:16px;">發布的公告會顯示在員工首頁上方</p>

                <!-- 新增公告表單 -->
                <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:16px;">
                    <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">➕ 發布新公告</div>
                    <div class="form-group">
                        <label>類型</label>
                        <select id="annType">
                            <option value="info">📢 一般通知</option>
                            <option value="warning">⚠️ 注意事項</option>
                            <option value="urgent">🚨 緊急通知</option>
                            <option value="event">🎉 活動公告</option>
                        </select>
                    </div>
                    <div class="form-group"><label>標題</label><input type="text" id="annTitle" placeholder="例：下週一停電通知"></div>
                    <div class="form-group"><label>內容 (選填)</label><textarea id="annContent" placeholder="公告詳細內容..."></textarea></div>
                    <div class="form-group">
                        <label>到期日 (選填，留空永久顯示)</label>
                        <input type="date" id="annExpire">
                    </div>
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="annPinned"> 📌 置頂</label>
                    </div>
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="annRequireAck"> ✍️ 強制閱讀簽署（員工必須確認才能使用系統）</label>
                    </div>
                    <button class="btn btn-primary" onclick="publishAnnouncement()">📤 發布公告</button>
                </div>

                <!-- 現有公告列表 -->
                <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">📋 現有公告</div>
                <div id="announcementList"><p style="text-align:center;color:#999;">載入中...</p></div>
            </div>
        </div>

        <!-- ====== 加班審核 ====== -->
        <div id="overtimeApprovalPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>⏰ 加班審核</h2>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchOtTab('pending')">待審核</button>
                    <button class="tab-btn inactive" onclick="switchOtTab('approved')">已通過</button>
                    <button class="tab-btn inactive" onclick="switchOtTab('rejected')">已拒絕</button>
                </div>
                <div id="otApprovalList"><p style="text-align:center;color:#666;">載入中...</p></div>
            </div>
        </div>

        <!-- ====== 換班審核 ====== -->
        <div id="swapApprovalPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>🔄 換班審核</h2>
                <p style="color:#94A3B8;font-size:12px;margin-bottom:12px;">雙方同意後才會出現在此列表</p>
                <div id="swapApprovalList"><p style="text-align:center;color:#666;">載入中...</p></div>
            </div>
        </div>

        <!-- ====== 操作日誌 ====== -->
        <div id="auditLogPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>📜 操作日誌</h2>
                <p style="color:#94A3B8;font-size:12px;margin-bottom:12px;">系統自動記錄所有管理操作</p>
                <div id="auditLogList"><p style="text-align:center;color:#666;">載入中...</p></div>
                <button class="btn btn-secondary" id="loadMoreAudit" onclick="loadAuditLogs(true)" style="margin-top:12px;">載入更多...</button>
            </div>
        </div>

        <!-- 報表匯出頁面 -->
        <div id="reportPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>📊 報表匯出</h2>
                <div class="menu-grid">
                    <div class="menu-item" onclick="exportReport('attendance')">
                        <div class="icon">📈</div><div class="label">出勤報表</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('leave')">
                        <div class="icon">📝</div><div class="label">請假報表</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('bonus')">
                        <div class="icon">🎁</div><div class="label">獎金報表</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('lunch')">
                        <div class="icon">🍱</div><div class="label">便當報表</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('overtime')">
                        <div class="icon">⏰</div><div class="label">加班報表</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 功能管理頁面 -->
        <div id="featurePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>🎛️ 功能管理</h2>
                <p style="color:#6b7280;font-size:13px;margin-bottom:16px;">控制員工首頁<b>中間選單</b>顯示哪些功能</p>
                
                <div id="featureToggles" style="display:flex;flex-direction:column;gap:12px;">
                    <!-- 請假 -->
                    <div class="feature-toggle-card" id="ftCard_leave" onclick="toggleFeature('leave')" style="display:flex;align-items:center;gap:14px;padding:16px;background:#fff;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                        <span style="font-size:28px;">📝</span>
                        <div style="flex:1;">
                            <div style="font-weight:800;font-size:14px;color:#0F172A;">我要請假</div>
                            <div style="font-size:12px;color:#94A3B8;margin-top:2px;">請假申請與記錄查詢</div>
                        </div>
                        <div class="ft-indicator" style="width:44px;height:26px;border-radius:13px;background:#4F46E5;position:relative;transition:background 0.3s;">
                            <div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;right:3px;transition:all 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                    <!-- 便當 -->
                    <div class="feature-toggle-card" id="ftCard_lunch" onclick="toggleFeature('lunch')" style="display:flex;align-items:center;gap:14px;padding:16px;background:#fff;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                        <span style="font-size:28px;">🍱</span>
                        <div style="flex:1;">
                            <div style="font-weight:800;font-size:14px;color:#0F172A;">便當訂購</div>
                            <div style="font-size:12px;color:#94A3B8;margin-top:2px;">每日午餐訂購管理</div>
                        </div>
                        <div class="ft-indicator" style="width:44px;height:26px;border-radius:13px;background:#4F46E5;position:relative;transition:background 0.3s;">
                            <div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;right:3px;transition:all 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                    <!-- 考勤 -->
                    <div class="feature-toggle-card" id="ftCard_attendance" onclick="toggleFeature('attendance')" style="display:flex;align-items:center;gap:14px;padding:16px;background:#fff;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                        <span style="font-size:28px;">📊</span>
                        <div style="flex:1;">
                            <div style="font-weight:800;font-size:14px;color:#0F172A;">考勤查詢</div>
                            <div style="font-size:12px;color:#94A3B8;margin-top:2px;">出勤月曆與記錄查詢</div>
                        </div>
                        <div class="ft-indicator" style="width:44px;height:26px;border-radius:13px;background:#4F46E5;position:relative;transition:background 0.3s;">
                            <div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;right:3px;transition:all 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                </div>
                <div id="featureSaveStatus" style="margin-top:12px;text-align:center;font-size:13px;color:#059669;display:none;">✅ 已儲存</div>
                <p style="color:#94A3B8;font-size:12px;margin-top:16px;text-align:center;">💡 底部導航列（首頁/班表/打卡/薪資/管理）為管理員專屬，不受此設定影響</p>

                <!-- LINE Notify 設定 -->
                <div style="margin-top:30px;padding-top:20px;border-top:2px dashed #e5e7eb;">
                    <h3 style="margin-bottom:12px;">🔔 LINE Notify 推播設定</h3>
                    <p style="color:#94A3B8;font-size:12px;margin-bottom:12px;">設定後，請假/補打卡申請會自動推播通知管理員群組</p>
                    <div class="form-group">
                        <label>LINE Notify Token</label>
                        <input type="text" id="lineNotifyToken" placeholder="請貼上 LINE Notify Token">
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-primary" onclick="saveNotifyToken()" style="flex:1;">💾 儲存</button>
                        <button class="btn btn-secondary" onclick="testNotify()" style="flex:1;">🔔 測試推播</button>
                    </div>
                    <div id="notifyStatus" style="margin-top:8px;text-align:center;font-size:13px;display:none;"></div>
                    <div style="margin-top:12px;padding:10px;background:#FFF7ED;border-radius:10px;font-size:11px;color:#EA580C;line-height:1.6;">
                        📌 如何取得 Token：<br>
                        1. 前往 <b>notify-bot.line.me</b><br>
                        2. 登入 → 發行權杖<br>
                        3. 選擇要接收通知的群組<br>
                        4. 複製 Token 貼到上方
                    </div>
                </div>
            </div>
        </div>

        <!-- ====== 人力管理（排班 + 休假 + 設定） ====== -->
        <div id="staffMgrPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">← 返回</button>
            <div class="checkin-page">
                <h2>📋 人力管理</h2>

                <!-- 三頁籤 -->
                <div style="display:flex;gap:4px;margin-bottom:16px;background:#F1F5F9;border-radius:10px;padding:3px;">
                    <button class="smTab" onclick="switchStaffTab('shift')" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:#fff;color:#4F46E5;box-shadow:0 1px 4px rgba(0,0,0,0.08);">📋 排班表</button>
                    <button class="smTab" onclick="switchStaffTab('leave')" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:transparent;color:#94A3B8;">🗓️ 休假月表</button>
                    <button class="smTab" onclick="switchStaffTab('setting')" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:transparent;color:#94A3B8;">⚙️ 人力設定</button>
                </div>

                <!-- === 排班表 TAB === -->
                <div id="tabShift" class="staffTabContent">
                    <p style="color:#6b7280;font-size:12px;margin-bottom:12px;">點擊格子切換班別，排好後按儲存</p>
                    <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:12px;">
                        <button onclick="changeShiftWeek(-1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">◀</button>
                        <span id="smWeekLabel" style="font-size:14px;font-weight:700;min-width:180px;text-align:center;">-</span>
                        <button onclick="changeShiftWeek(1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">▶</button>
                        <button onclick="resetShiftWeek()" style="padding:4px 10px;border:1px solid #E5E7EB;border-radius:6px;background:#fff;font-size:11px;font-weight:700;color:#4F46E5;cursor:pointer;">本週</button>
                    </div>
                    <div style="display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap;justify-content:center;">
                        <span style="font-size:10px;padding:3px 8px;background:#DBEAFE;color:#1E40AF;border-radius:6px;font-weight:700;">☀️早</span>
                        <span style="font-size:10px;padding:3px 8px;background:#FEF3C7;color:#92400E;border-radius:6px;font-weight:700;">🌤️中</span>
                        <span style="font-size:10px;padding:3px 8px;background:#EDE9FE;color:#6D28D9;border-radius:6px;font-weight:700;">🌙晚</span>
                        <span style="font-size:10px;padding:3px 8px;background:#ECFDF5;color:#059669;border-radius:6px;font-weight:700;">🏖️休</span>
                        <span style="font-size:10px;padding:3px 8px;background:#F1F5F9;color:#64748B;border-radius:6px;font-weight:700;">⬜未排</span>
                    </div>
                    <!-- 人力不足警告 -->
                    <div id="shiftStaffWarn" style="display:none;padding:10px 14px;background:#FEF2F2;border-radius:10px;margin-bottom:12px;font-size:12px;color:#DC2626;font-weight:700;"></div>
                    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
                        <table id="smTable" style="width:100%;border-collapse:collapse;font-size:12px;min-width:500px;"><thead id="smHead"></thead><tbody id="smBody"></tbody></table>
                    </div>
                    <!-- 每日人力統計 -->
                    <div id="shiftDaySummary" style="display:flex;gap:4px;margin-top:10px;overflow-x:auto;padding-bottom:4px;"></div>
                    <div style="margin-top:14px;display:flex;gap:8px;">
                        <button onclick="saveSchedule()" style="flex:1;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">💾 儲存排班</button>
                        <button onclick="copyLastWeek()" style="padding:14px 20px;border:2px solid #E5E7EB;border-radius:12px;background:#fff;font-weight:700;font-size:14px;cursor:pointer;">📋 複製上週</button>
                    </div>
                    <div id="smSaveStatus" style="margin-top:10px;text-align:center;font-size:13px;display:none;"></div>
                </div>

                <!-- === 休假月表 TAB === -->
                <div id="tabLeave" class="staffTabContent" style="display:none;">
                    <p style="color:#6b7280;font-size:12px;margin-bottom:12px;">一覽全員休假狀態，方便安排工作</p>
                    <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:12px;">
                        <button onclick="changeLeaveCal(-1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">◀</button>
                        <span id="lcMonthLabel" style="font-size:14px;font-weight:700;min-width:120px;text-align:center;">-</span>
                        <button onclick="changeLeaveCal(1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">▶</button>
                        <button onclick="resetLeaveCal()" style="padding:4px 10px;border:1px solid #E5E7EB;border-radius:6px;background:#fff;font-size:11px;font-weight:700;color:#4F46E5;cursor:pointer;">本月</button>
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:12px;">
                        <div style="flex:1;text-align:center;padding:10px;background:#EFF6FF;border-radius:12px;">
                            <div style="font-size:20px;font-weight:900;color:#2563EB;" id="lcTotal">0</div>
                            <div style="font-size:10px;font-weight:600;color:#2563EB;">總請假人次</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:10px;background:#ECFDF5;border-radius:12px;">
                            <div style="font-size:20px;font-weight:900;color:#059669;" id="lcAvail">0</div>
                            <div style="font-size:10px;font-weight:600;color:#059669;">今日可用人力</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:10px;background:#FEF2F2;border-radius:12px;">
                            <div style="font-size:20px;font-weight:900;color:#DC2626;" id="lcMax">0</div>
                            <div style="font-size:10px;font-weight:600;color:#DC2626;">上限</div>
                        </div>
                    </div>
                    <!-- 日期有超過上限的高亮 -->
                    <div id="lcOverWarn" style="display:none;padding:10px 14px;background:#FEF2F2;border-radius:10px;margin-bottom:12px;font-size:12px;color:#DC2626;font-weight:700;"></div>
                    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
                        <table id="lcTable" style="width:100%;border-collapse:collapse;font-size:11px;min-width:600px;"><thead id="lcHead"></thead><tbody id="lcBody"></tbody></table>
                    </div>
                    <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap;">
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#DBEAFE;border-radius:3px;display:inline-block;"></span>特休</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FEE2E2;border-radius:3px;display:inline-block;"></span>病假</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FEF3C7;border-radius:3px;display:inline-block;"></span>事假</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#E0E7FF;border-radius:3px;display:inline-block;"></span>補休</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FCA5A5;border-radius:3px;display:inline-block;border:2px solid #DC2626;"></span>超限</span>
                    </div>
                </div>

                <!-- === 人力設定 TAB === -->
                <div id="tabSetting" class="staffTabContent" style="display:none;">
                    <p style="color:#6b7280;font-size:12px;margin-bottom:16px;">設定請假限制與人力規則</p>

                    <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-bottom:16px;">
                        <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">🚫 同時請假人數上限</div>
                        <p style="font-size:12px;color:#94A3B8;margin-bottom:12px;">當某天已有 N 人請假，第 N+1 人提交申請時會被<b style="color:#DC2626;">自動駁回</b></p>
                        <div style="display:flex;align-items:center;gap:12px;">
                            <button onclick="adjustMaxLeave(-1)" style="width:44px;height:44px;border:2px solid #E5E7EB;border-radius:12px;background:#fff;font-size:20px;cursor:pointer;font-weight:700;">−</button>
                            <div style="flex:1;text-align:center;">
                                <div id="maxLeaveNum" style="font-size:36px;font-weight:900;color:#4F46E5;">2</div>
                                <div style="font-size:11px;color:#94A3B8;">人</div>
                            </div>
                            <button onclick="adjustMaxLeave(1)" style="width:44px;height:44px;border:2px solid #E5E7EB;border-radius:12px;background:#fff;font-size:20px;cursor:pointer;font-weight:700;">+</button>
                        </div>
                        <button onclick="saveMaxLeave()" style="width:100%;margin-top:14px;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">💾 儲存設定</button>
                        <div id="maxLeaveSaveStatus" style="margin-top:8px;text-align:center;font-size:13px;display:none;"></div>
                    </div>

                    <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                        <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">📊 目前人力概況</div>
                        <div id="staffOverview" style="font-size:13px;color:#64748B;line-height:1.8;">載入中...</div>
                    </div>

                    <div style="background:#FFF7ED;border-radius:14px;padding:14px;margin-top:16px;">
                        <div style="font-size:13px;color:#EA580C;line-height:1.6;">
                            <b>💡 自動駁回規則說明</b><br>
                            • 員工填入請假日期時，系統<b>即時檢查</b>該日已有幾人請假<br>
                            • 若加上申請者會超過上限，<b>表單直接鎖定</b>無法提交<br>
                            • 已核准 + 待審核 的假都會被計入<br>
                            • 週末不計入衝突檢查
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <nav class="bottom-nav" id="bottomNav" style="display:none;">
        <a class="nav-item" onclick="window.location.href='index.html'">
            <span class="nav-icon">🏠</span>
            <span class="nav-label">首頁</span>
        </a>
        <a class="nav-item" onclick="window.location.href='schedule.html'">
            <span class="nav-icon">📅</span>
            <span class="nav-label">班表</span>
        </a>
        <a class="nav-item" onclick="window.location.href='checkin.html?type=in'">
            <span class="nav-icon">📍</span>
            <span class="nav-label">打卡</span>
        </a>
        <a class="nav-item" onclick="window.location.href='salary.html'">
            <span class="nav-icon">💰</span>
            <span class="nav-label">薪資</span>
        </a>
        <a class="nav-item active">
            <span class="nav-icon">⚙️</span>
            <span class="nav-label">管理</span>
        </a>
    </nav>

    <script src="common.js"></script>
    <script>
        let currentAdminEmployee = null;

        // ===== 混合精算獎金系統 =====
        const BONUS_MATRIX = {
            S: { A: 2.0, B: 1.8, C: 1.5 },
            A: { A: 1.5, B: 1.3, C: 1.0 },
            B: { A: 1.0, B: 0.8, C: 0.5 }
        };
        const FULL_ATTENDANCE_BONUS = 3000;
        const LATE_PENALTY_PER = 200;
        const GRADE_LABELS = { A: '全勤', B: '正常', C: '待加強' };
        const PERF_LABELS = { S: '卓越', A: '優良', B: '普通' };
        let bonusEmployees = [];
        let bonusPerformance = {};
        let bonusAdjustments = {};

        // 本地日期格式化（避免 toISOString 時區偏移）
        function fmtDate(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        // 頁面切換
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if (id === 'bonusPage') loadHybridBonusData();
            if (id === 'locationPage') renderLocationList();
            if (id === 'employeePage') loadEmployeeList();
            if (id === 'leaveApprovalPage') loadLeaveApprovals('pending');
            if (id === 'makeupApprovalPage') loadMakeupApprovals('pending');
            if (id === 'overtimeApprovalPage') loadOtApprovals('pending');
            if (id === 'swapApprovalPage') loadSwapApprovals();
            if (id === 'announcementPage') loadAnnouncementList();
            if (id === 'auditLogPage') loadAuditLogs();
            if (id === 'featurePage') { loadFeatureSettings(); loadNotifyToken(); }
            if (id === 'staffMgrPage') { loadShiftMgr(); loadMaxLeaveSetting(); loadStaffOverview(); }
        }

        // ===== 功能管理 =====
        let featureState = { leave: true, lunch: true, attendance: true };

        // LINE Notify 設定
        async function loadNotifyToken() {
            try {
                const { data } = await sb.from('hr_settings')
                    .select('value').eq('key', 'line_notify_token').maybeSingle();
                if (data?.value?.token) {
                    const el = document.getElementById('lineNotifyToken');
                    if (el) el.value = data.value.token;
                }
            } catch(e) {}
        }

        async function saveNotifyToken() {
            const token = document.getElementById('lineNotifyToken')?.value?.trim();
            if (!token) return showToast('❌ 請輸入 Token');
            const status = document.getElementById('notifyStatus');
            try {
                const { data: existing } = await sb.from('hr_settings')
                    .select('id').eq('key', 'line_notify_token').maybeSingle();
                if (existing) {
                    await sb.from('hr_settings').update({ value: { token }, updated_at: new Date().toISOString() }).eq('key', 'line_notify_token');
                } else {
                    await sb.from('hr_settings').insert({ key: 'line_notify_token', value: { token }, description: 'LINE Notify 推播 Token' });
                }
                showToast('✅ Token 已儲存');
                if (status) { status.style.display = 'block'; status.style.color = '#059669'; status.textContent = '✅ 已儲存'; }
            } catch(e) { showToast('❌ 儲存失敗'); }
        }

        async function testNotify() {
            const status = document.getElementById('notifyStatus');
            if (status) { status.style.display = 'block'; status.style.color = '#6D28D9'; status.textContent = '⏳ 發送測試...'; }
            try {
                await sendAdminNotify('🔔 HR 系統推播測試\n如果您收到此訊息，表示 LINE Notify 設定成功！');
                showToast('✅ 測試推播已發送');
                if (status) { status.style.color = '#059669'; status.textContent = '✅ 推播成功！請查看 LINE 群組'; }
            } catch(e) {
                showToast('❌ 推播失敗');
                if (status) { status.style.color = '#DC2626'; status.textContent = '❌ 推播失敗，請檢查 Token 或 Edge Function'; }
            }
        }

        async function loadFeatureSettings() {
            try {
                const { data } = await sb.from('hr_settings')
                    .select('value')
                    .eq('key', 'feature_visibility')
                    .maybeSingle();
                
                if (data?.value) {
                    featureState = { ...featureState, ...data.value };
                }
            } catch(e) {}
            
            // 更新卡片顯示
            ['leave', 'lunch', 'attendance'].forEach(key => updateToggleCard(key));
        }

        function updateToggleCard(key) {
            const card = document.getElementById('ftCard_' + key);
            if (!card) return;
            const on = featureState[key] !== false;
            const indicator = card.querySelector('.ft-indicator');
            const dot = indicator?.querySelector('div');
            
            if (on) {
                card.style.borderColor = '#4F46E5';
                card.style.background = '#F5F3FF';
                indicator.style.background = '#4F46E5';
                if (dot) { dot.style.right = '3px'; dot.style.left = 'auto'; }
            } else {
                card.style.borderColor = '#E5E7EB';
                card.style.background = '#fff';
                indicator.style.background = '#CBD5E1';
                if (dot) { dot.style.left = '3px'; dot.style.right = 'auto'; }
            }
        }

        async function toggleFeature(key) {
            featureState[key] = !featureState[key];
            updateToggleCard(key);
            
            try {
                const { data: existing } = await sb.from('hr_settings')
                    .select('id')
                    .eq('key', 'feature_visibility')
                    .maybeSingle();
                
                if (existing) {
                    await sb.from('hr_settings')
                        .update({ value: featureState, updated_at: new Date().toISOString() })
                        .eq('key', 'feature_visibility');
                } else {
                    await sb.from('hr_settings')
                        .insert({ key: 'feature_visibility', value: featureState, description: '員工可見功能設定' });
                }
                
                const el = document.getElementById('featureSaveStatus');
                el.style.display = 'block';
                el.textContent = featureState[key] ? '✅ 已開啟' : '⛔ 已關閉';
                el.style.color = featureState[key] ? '#059669' : '#DC2626';
                setTimeout(() => el.style.display = 'none', 1500);
            } catch(e) {
                console.error('儲存失敗', e);
                showToast('❌ 儲存失敗');
            }
        }

        // 檢查管理員權限
        async function checkAdminPermission() {
            const statusEl = document.getElementById('permissionStatus');
            const loadingPage = document.getElementById('loadingPage');
            
            try {
                const initialized = await initializeLiff();
                
                // [BUG FIX] 無論成功失敗都要隱藏 loading 畫面
                if (loadingPage) loadingPage.style.display = 'none';
                
                if (!initialized) {
                    showStatus(statusEl, 'error', '❌ LIFF 初始化失敗，請從 LINE 開啟');
                    return;
                }

                console.log('🔑 LINE User ID:', liffProfile?.userId);

                const { data, error } = await sb.from('employees')
                    .select('*')
                    .eq('line_user_id', liffProfile.userId)
                    .eq('role', 'admin')
                    .eq('is_active', true)
                    .maybeSingle();

                if (error) {
                    console.error('❌ 資料庫查詢錯誤:', error);
                    showStatus(statusEl, 'error', '❌ 資料庫查詢失敗: ' + error.message);
                    return;
                }
                
                if (!data) {
                    console.log('❌ 找不到管理員資料，LINE ID:', liffProfile?.userId);
                    showStatus(statusEl, 'error', '❌ 您沒有管理員權限<br><small style="opacity:0.7">LINE ID: ' + escapeHTML(liffProfile?.userId || '未知') + '</small>', true);
                    setTimeout(() => { window.location.href = 'index.html'; }, 5000);
                    return;
                }

                currentAdminEmployee = data;
                updateAdminInfo(data);
                
                // 載入系統設定（地點等）
                await loadSettings();
                
                showStatus(statusEl, 'success', '✅ 權限驗證通過');
                populateYearSelect('bonusYear');
                setTimeout(() => {
                    showPage('adminHomePage');
                    document.getElementById('bottomNav').style.display = 'flex';
                }, 800);

            } catch (err) {
                console.error('權限檢查異常:', err);
                if (loadingPage) loadingPage.style.display = 'none';
                showStatus(statusEl, 'error', '❌ 權限檢查失敗: ' + (typeof friendlyError === 'function' ? friendlyError(err) : err.message));
            }
        }

        // [BUG FIX] 修正管理員頭像顯示 — 有圖片時不應顯示 emoji
        function updateAdminInfo(data) {
            document.getElementById('adminName').textContent = data.name;
            document.getElementById('adminDept').textContent = `${data.department || '系統管理'} · 管理員`;
            document.getElementById('adminId').textContent = `ID: ${data.employee_number}`;
            
            const avatar = document.getElementById('adminAvatar');
            if (liffProfile?.pictureUrl) {
                avatar.style.backgroundImage = `url(${liffProfile.pictureUrl})`;
                avatar.style.backgroundSize = 'cover';
                avatar.textContent = '';
            } else {
                avatar.textContent = '👑';
            }
        }

        // ===== 混合精算獎金系統 =====
        async function loadHybridBonusData() {
            const yearEl = document.getElementById('bonusYear');
            const listEl = document.getElementById('bonusList');
            const loadingEl = document.getElementById('bonusLoading');
            const summaryEl = document.getElementById('bonusSummary');
            const actionsEl = document.getElementById('bonusActions');
            const matrixRefEl = document.getElementById('matrixRef');
            if (!yearEl || !listEl) return;
            const year = parseInt(yearEl.value);

            if (loadingEl) loadingEl.style.display = 'block';
            if (summaryEl) summaryEl.style.display = 'none';
            if (actionsEl) actionsEl.style.display = 'none';
            if (matrixRefEl) matrixRefEl.style.display = 'none';
            listEl.innerHTML = '';

            try {
                const [empRes, salaryRes, attRes, leaveRes] = await Promise.all([
                    sb.from('employees').select('id, name, employee_number, department, hire_date').eq('is_active', true).order('department').order('name'),
                    sb.from('salary_settings').select('employee_id, base_salary').eq('is_current', true),
                    sb.from('attendance').select('employee_id, is_late').gte('date', `${year}-01-01`).lte('date', `${year}-12-31`),
                    sb.from('leave_requests').select('employee_id, days').eq('status', 'approved').gte('start_date', `${year}-01-01`).lte('start_date', `${year}-12-31`)
                ]);
                if (empRes.error) throw empRes.error;

                const salaryMap = {};
                (salaryRes.data || []).forEach(s => { salaryMap[s.employee_id] = s.base_salary; });
                const lateMap = {};
                (attRes.data || []).forEach(a => { if (!lateMap[a.employee_id]) lateMap[a.employee_id] = 0; if (a.is_late) lateMap[a.employee_id]++; });
                const leaveMap = {};
                (leaveRes.data || []).forEach(l => { if (!leaveMap[l.employee_id]) leaveMap[l.employee_id] = 0; leaveMap[l.employee_id] += (parseFloat(l.days) || 0); });

                const yearEnd = new Date(year, 11, 31);
                bonusEmployees = (empRes.data || []).map(emp => {
                    const baseSalary = salaryMap[emp.id] || 0;
                    const lateCount = lateMap[emp.id] || 0;
                    const leaveDays = leaveMap[emp.id] || 0;
                    let tenureRatio = 1.0;
                    if (emp.hire_date) {
                        const days = Math.max(0, (yearEnd - new Date(emp.hire_date)) / 86400000);
                        tenureRatio = Math.min(days / 365, 1.0);
                    }
                    let attendanceGrade = 'B';
                    if (lateCount === 0 && leaveDays === 0) attendanceGrade = 'A';
                    else if (lateCount >= 3 || leaveDays >= 3) attendanceGrade = 'C';

                    return { id: emp.id, name: emp.name, employeeNumber: emp.employee_number, department: emp.department, hireDate: emp.hire_date, baseSalary, lateCount, leaveDays, tenureRatio, attendanceGrade, perfRating: bonusPerformance[emp.id] || 'A' };
                });

                renderBonusCards();
                updateBonusSummary();
                renderMatrixRefTable();
                if (loadingEl) loadingEl.style.display = 'none';
                if (summaryEl) summaryEl.style.display = 'block';
                if (actionsEl) actionsEl.style.display = 'block';
                if (matrixRefEl) matrixRefEl.style.display = 'block';
            } catch (err) {
                console.error('Bonus load failed:', err);
                if (loadingEl) loadingEl.style.display = 'none';
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗: ' + escapeHTML(friendlyError(err)) + '</p>';
            }
        }

        function calculateBonus(emp) {
            const perfRating = bonusPerformance[emp.id] || emp.perfRating || 'A';
            const manualAdj = bonusAdjustments[emp.id] || 0;
            const multiplier = BONUS_MATRIX[perfRating]?.[emp.attendanceGrade] ?? 1.0;
            const baseAmount = Math.round(emp.baseSalary * emp.tenureRatio * multiplier);
            const fullAtt = emp.attendanceGrade === 'A' ? FULL_ATTENDANCE_BONUS : 0;
            const latePen = emp.lateCount * LATE_PENALTY_PER;
            const finalAmount = Math.max(0, baseAmount + fullAtt - latePen + manualAdj);
            return { perfRating, multiplier, baseAmount, fullAtt, latePen, manualAdj, finalAmount };
        }

        function renderBonusCards() {
            const listEl = document.getElementById('bonusList');
            if (!listEl) return;
            if (bonusEmployees.length === 0) { listEl.innerHTML = '<p style="text-align:center;color:#999;">無員工資料</p>'; return; }

            let html = '';
            bonusEmployees.forEach(emp => {
                const c = calculateBonus(emp);
                html += `
                <div class="bonus-card grade-${emp.attendanceGrade}" id="bonusCard_${emp.id}">
                    <div class="bonus-card-header">
                        <div><span class="bonus-card-name">${escapeHTML(emp.name)}</span><span class="bonus-card-dept">${escapeHTML(emp.department || '-')} (${escapeHTML(emp.employeeNumber)})</span></div>
                        <span class="bonus-grade-badge bonus-grade-${emp.attendanceGrade}">出勤 ${emp.attendanceGrade} (${GRADE_LABELS[emp.attendanceGrade]})</span>
                    </div>
                    <div class="bonus-data-grid">
                        <div><span class="label">遲到</span></div><div><span class="value">${emp.lateCount} 次</span></div>
                        <div><span class="label">請假</span></div><div><span class="value">${emp.leaveDays} 天</span></div>
                        <div><span class="label">底薪</span></div><div><span class="value">$${(emp.baseSalary || 0).toLocaleString()}</span></div>
                        <div><span class="label">年資比例</span></div><div><span class="value">${(emp.tenureRatio * 100).toFixed(0)}%</span></div>
                    </div>
                    <div class="bonus-controls" style="margin-bottom:10px;">
                        <label style="font-size:12px;font-weight:700;color:#4b5563;white-space:nowrap;">績效評等</label>
                        <select onchange="updatePerformance('${emp.id}', this.value)">
                            ${['S','A','B'].map(r => '<option value="' + r + '"' + (c.perfRating === r ? ' selected' : '') + '>' + r + ' (' + PERF_LABELS[r] + ')</option>').join('')}
                        </select>
                        <span style="font-size:13px;font-weight:800;color:#4F46E5;white-space:nowrap;">x${c.multiplier}</span>
                    </div>
                    <div class="bonus-breakdown">
                        <div class="row"><span>底薪 x 年資 x 矩陣</span><span>$${c.baseAmount.toLocaleString()}</span></div>
                        ${c.fullAtt > 0 ? '<div class="row"><span class="plus">+ 全勤獎金</span><span class="plus">+$' + c.fullAtt.toLocaleString() + '</span></div>' : ''}
                        ${c.latePen > 0 ? '<div class="row"><span class="minus">- 遲到扣款 (' + emp.lateCount + 'x$' + LATE_PENALTY_PER + ')</span><span class="minus">-$' + c.latePen.toLocaleString() + '</span></div>' : ''}
                        ${c.manualAdj !== 0 ? '<div class="row"><span>' + (c.manualAdj > 0 ? '+' : '') + ' 手動調整</span><span>' + (c.manualAdj > 0 ? '+' : '') + '$' + c.manualAdj.toLocaleString() + '</span></div>' : ''}
                        <div class="row total"><span>最終金額</span><span>$${c.finalAmount.toLocaleString()}</span></div>
                    </div>
                    <div class="bonus-controls">
                        <label style="font-size:12px;font-weight:700;color:#4b5563;white-space:nowrap;">手動調整</label>
                        <input type="number" placeholder="±金額" value="${c.manualAdj || ''}" onchange="updateAdjustment('${emp.id}', this.value)">
                    </div>
                </div>`;
            });
            listEl.innerHTML = html;
        }

        function updatePerformance(empId, rating) {
            bonusPerformance[empId] = rating;
            renderBonusCards();
            updateBonusSummary();
        }
        function updateAdjustment(empId, value) {
            const val = parseInt(value);
            bonusAdjustments[empId] = isNaN(val) ? 0 : val;
            renderBonusCards();
            updateBonusSummary();
        }
        function updateBonusSummary() {
            let total = 0, count = 0;
            bonusEmployees.forEach(emp => { const c = calculateBonus(emp); if (c.finalAmount > 0) { count++; total += c.finalAmount; } });
            document.getElementById('eligibleCount').textContent = count;
            document.getElementById('totalBudget').textContent = `$${total.toLocaleString()}`;
            document.getElementById('avgBonus').textContent = count > 0 ? `$${Math.round(total / count).toLocaleString()}` : '$0';
        }
        function toggleMatrixRef() {
            const body = document.getElementById('matrixRefBody');
            const arrow = document.getElementById('matrixRefArrow');
            if (body.style.display === 'none') { body.style.display = 'block'; arrow.textContent = '▲'; }
            else { body.style.display = 'none'; arrow.textContent = '▼'; }
        }
        function renderMatrixRefTable() {
            const el = document.getElementById('matrixRefBody');
            if (!el) return;
            let html = '<table class="matrix-table"><thead><tr><th>績效＼出勤</th>';
            ['A','B','C'].forEach(g => { html += `<th>${g} (${GRADE_LABELS[g]})</th>`; });
            html += '</tr></thead><tbody>';
            ['S','A','B'].forEach(p => {
                html += `<tr><th>${p} (${PERF_LABELS[p]})</th>`;
                ['A','B','C'].forEach(g => { html += `<td>${BONUS_MATRIX[p][g]}x</td>`; });
                html += '</tr>';
            });
            html += '</tbody></table><div style="font-size:11px;color:#94A3B8;">公式: 底薪 x 年資比 x 矩陣倍率 + 全勤$3,000(A級) - 遲到$200/次 + 手動調整</div>';
            el.innerHTML = html;
        }

        async function saveAllBonuses() {
            const yearEl = document.getElementById('bonusYear');
            if (!yearEl) return;
            const year = parseInt(yearEl.value);
            const btn = document.getElementById('saveAllBonusBtn');
            if (!confirm(`確定要儲存 ${year} 年全部員工的獎金資料？`)) return;
            setBtnLoading(btn, true);
            try {
                const records = bonusEmployees.map(emp => {
                    const c = calculateBonus(emp);
                    return {
                        employee_id: emp.id, year, base_amount: c.baseAmount,
                        adjustment: c.manualAdj, final_bonus: c.finalAmount,
                        manager_adjustment: c.manualAdj,
                        months_worked: Math.round(emp.tenureRatio * 12 * 10) / 10,
                        is_approved: true,
                        ai_recommendation: JSON.stringify({ attendance_grade: emp.attendanceGrade, performance_rating: c.perfRating, matrix_multiplier: c.multiplier, full_attendance_bonus: c.fullAtt, late_penalty: c.latePen, base_salary: emp.baseSalary, tenure_ratio: emp.tenureRatio }),
                        updated_at: new Date().toISOString()
                    };
                });
                const { error } = await sb.from('annual_bonus').upsert(records, { onConflict: 'employee_id,year' });
                if (error) throw error;
                writeAuditLog('save_bonus', 'annual_bonus', null, `${year}年獎金`, { count: records.length, total: records.reduce((s, r) => s + r.final_bonus, 0) });
                showToast(`✅ 已儲存 ${records.length} 筆獎金資料`);
            } catch (err) {
                console.error('Save bonus failed:', err);
                showToast('❌ 儲存失敗: ' + friendlyError(err));
            } finally {
                setBtnLoading(btn, false, '💾 儲存全部獎金');
            }
        }

        function exportBonusCSV() {
            const yearEl = document.getElementById('bonusYear');
            if (!yearEl) return;
            const year = parseInt(yearEl.value);
            const rows = [['工號','姓名','部門','底薪','年資比','出勤等級','績效評等','矩陣倍數','基本獎金','全勤獎金','遲到扣款','手動調整','最終獎金']];
            bonusEmployees.forEach(emp => {
                const c = calculateBonus(emp);
                rows.push([emp.employeeNumber, emp.name, emp.department || '-', emp.baseSalary, (emp.tenureRatio * 100).toFixed(0) + '%', emp.attendanceGrade + '(' + GRADE_LABELS[emp.attendanceGrade] + ')', c.perfRating + '(' + PERF_LABELS[c.perfRating] + ')', c.multiplier, c.baseAmount, c.fullAtt, c.latePen, c.manualAdj, c.finalAmount]);
            });
            const csv = '\uFEFF' + rows.map(r => r.map(c => `"${String(c ?? '').replace(/"/g, '""')}"`).join(',')).join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            a.download = `獎金試算_${year}.csv`;
            a.click();
            showToast(`✅ 獎金試算_${year}.csv（${rows.length - 1} 筆）`);
        }

        // 員工 Modal
        function showAddEmployeeModal() {
            document.getElementById('addEmployeeModal').style.display = 'flex';
            document.getElementById('newEmployeeHireDate').value = fmtDate(new Date());
        }

        function closeAddEmployeeModal() {
            document.getElementById('addEmployeeModal').style.display = 'none';
            document.getElementById('addEmployeeForm').reset();
        }

        // 新增員工
        document.getElementById('addEmployeeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const employeeData = {
                name: document.getElementById('newEmployeeName').value.trim(),
                employee_number: document.getElementById('newEmployeeNumber').value.trim(),
                department: document.getElementById('newEmployeeDepartment').value,
                position: document.getElementById('newEmployeePosition').value.trim() || '員工',
                id_card_last_4: document.getElementById('newEmployeeCode').value.trim(),
                hire_date: document.getElementById('newEmployeeHireDate').value,
                role: document.getElementById('newEmployeeRole').value,
                is_active: true,
                status: 'active',
                company_id: '8a669e2c-7521-43e9-9300-5c004c57e9db',
                created_at: new Date().toISOString()
            };

            if (!employeeData.name || !employeeData.employee_number || !employeeData.id_card_last_4) {
                showToast('⚠️ 請填寫所有必填欄位');
                return;
            }
            
            try {
                const { data, error } = await sb.from('employees').insert([employeeData]);
                if (error) throw error;
                
                showToast('✅ 員工新增成功！');
                closeAddEmployeeModal();
                loadEmployeeList();
            } catch (err) {
                console.error('新增員工失敗:', err);
                showToast('❌ 新增失敗: ' + friendlyError(err));
            }
        });

        // QR Code
        function showJoinQRCode() {
            const modal = document.getElementById('qrModal');
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';
            
            const liffUrl = `https://liff.line.me/${CONFIG.LIFF_ID}?type=bind&company=HR_SYSTEM_001`;
            
            new QRCode(qrcodeDiv, {
                text: liffUrl, width: 200, height: 200,
                colorDark: "#1f2937", colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            modal.style.display = 'flex';
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // 點擊背景關閉 Modal
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // 載入員工列表
        async function loadEmployeeList() {
            const listEl = document.getElementById('employeeList');
            if (!listEl) return;

            try {
                const { data, error } = await sb.from('employees')
                    .select('*')
                    .eq('is_active', true)
                    .order('department', { ascending: true });

                if (error) throw error;

                const roleNames = { 'admin': '管理員', 'manager': '主管', 'user': '一般員工' };

                let html = '';
                data.forEach(emp => {
                    html += `
                        <div class="attendance-item">
                            <div class="date">
                                <div style="display:flex; align-items:center; flex-wrap:wrap; gap:4px;">
                                    <span>${emp.name} - ${emp.employee_number}</span>
                                    <span class="role-${emp.role || 'user'}" style="
                                        padding: 3px 10px; border-radius: 15px; font-size: 11px;
                                        display: inline-block; font-weight: bold;">
                                        ${roleNames[emp.role] || '未知'}
                                    </span>
                                </div>
                            </div>
                            <div class="details">
                                <span>${emp.department || '-'} · ${emp.position || '-'}</span>
                                <span style="font-size:12px;">驗證碼: ${emp.id_card_last_4 || '未設定'}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                到職: ${emp.hire_date || '未設定'} · ${emp.line_user_id ? '✅ 已綁定' : '⏳ 未綁定'}
                            </div>
                            ${emp.line_user_id ? `
                                <div style="margin-top:8px;display:flex;gap:8px;">
                                    <button class="btn-success-sm" onclick="updateEmployeeRoleAdmin('${emp.id}', 'admin', '${emp.name}')" style="flex:1;padding:8px 12px;border:none;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;${emp.role === 'admin' ? 'opacity:0.4;pointer-events:none;' : ''}">
                                        設為管理員
                                    </button>
                                    <button class="btn-danger" onclick="updateEmployeeRoleAdmin('${emp.id}', 'user', '${emp.name}')" style="flex:1;padding:8px 12px;border-radius:10px;font-size:12px;font-weight:700;${emp.role !== 'admin' ? 'opacity:0.4;pointer-events:none;' : ''}">
                                        取消管理員
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                listEl.innerHTML = html || '<p style="text-align:center;color:#999;">無員工資料</p>';

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗</p>';
            }
        }

        // [BUG FIX] 整合角色更新函數，避免重複定義
        async function updateEmployeeRoleAdmin(employeeId, newRole, employeeName) {
            const roleNames = { 'admin': '管理員', 'manager': '主管', 'user': '一般員工' };
            
            try {
                const { error } = await sb.from('employees')
                    .update({ role: newRole })
                    .eq('id', employeeId);
                
                if (error) throw error;
                showToast(`✅ ${employeeName} → ${roleNames[newRole]}`);
                loadEmployeeList();
            } catch (err) {
                console.error(err);
                showToast('❌ 更新失敗: ' + friendlyError(err));
            }
        }

        // 搜尋員工
        function searchEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            const items = document.querySelectorAll('#employeeList .attendance-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // 請假審核
        function switchLeaveTab(status) {
            document.querySelectorAll('#leaveApprovalPage .tab-btn').forEach(btn => {
                btn.className = 'tab-btn inactive';
            });
            event.target.className = 'tab-btn active';
            loadLeaveApprovals(status);
        }

        async function loadLeaveApprovals(status) {
            const listEl = document.getElementById('leaveApprovalList');
            if (!listEl) return;

            try {
                const { data, error } = await sb.from('leave_requests')
                    .select(`*, employees!leave_requests_employee_id_fkey(name, employee_number, department)`)
                    .eq('status', status)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const typeMap = { 'annual': '特休', 'sick': '病假', 'personal': '事假', 'compensatory': '補休' };
                const statusText = { 'pending': '待審核', 'approved': '已通過', 'rejected': '已拒絕' };

                let html = '';
                (data || []).forEach(request => {
                    html += `
                        <div class="attendance-item">
                            <div class="date">
                                <span>${request.employees?.name || '未知'} - ${typeMap[request.leave_type] || request.leave_type}</span>
                                <span style="font-size:12px;color:#999;">${request.created_at?.split('T')[0] || ''}</span>
                            </div>
                            <div class="details">
                                <span>${request.start_date} ~ ${request.end_date}</span>
                                <span>${request.employees?.department || '-'}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                ${request.reason || '無原因'}
                            </div>
                            ${request.status === 'rejected' && request.rejection_reason ? `
                                <div style="font-size:12px;color:#DC2626;margin-top:6px;padding:8px 10px;background:#FEF2F2;border-radius:8px;">
                                    ❌ 拒絕原因：${request.rejection_reason}
                                </div>
                            ` : ''}
                            ${status === 'pending' ? `
                                <div style="margin-top:8px;display:flex;gap:6px;">
                                    <button class="btn-success" onclick="approveLeave('${request.id}', 'approved')" style="flex:1;font-size:12px;padding:8px;border:none;border-radius:8px;cursor:pointer;">
                                        ✅ 通過
                                    </button>
                                    <button class="btn-danger" onclick="approveLeave('${request.id}', 'rejected')" style="flex:1;font-size:12px;padding:8px;">
                                        ❌ 拒絕
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                listEl.innerHTML = html || `<p style="text-align:center;color:#999;">無${statusText[status] || ''}的請假申請</p>`;

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗</p>';
            }
        }

        async function approveLeave(requestId, newStatus) {
            // 拒絕時要求填原因
            let rejectionReason = null;
            if (newStatus === 'rejected') {
                rejectionReason = prompt('請輸入拒絕原因（選填）：');
                if (rejectionReason === null) return; // 按取消 = 不操作
            }

            try {
                const updateData = { 
                    status: newStatus,
                    approver_id: currentAdminEmployee.id,
                    approved_at: new Date().toISOString()
                };
                if (newStatus === 'rejected') {
                    updateData.rejection_reason = rejectionReason || '不符合規定';
                }

                // 先查請假資訊（用於通知）
                const { data: reqData } = await sb.from('leave_requests')
                    .select('*, employees(name, id)')
                    .eq('id', requestId).single();

                const { error } = await sb.from('leave_requests')
                    .update(updateData)
                    .eq('id', requestId);

                if (error) throw error;

                // LINE Notify 通知員工
                if (reqData?.employees?.id) {
                    const typeMap = { annual:'特休', sick:'病假', personal:'事假', compensatory:'補休' };
                    const typeName = typeMap[reqData.leave_type] || reqData.leave_type;
                    if (newStatus === 'approved') {
                        sendUserNotify(reqData.employees.id, `✅ 您的${typeName}申請已通過\n📅 ${reqData.start_date} ~ ${reqData.end_date}`);
                    } else {
                        sendUserNotify(reqData.employees.id, `❌ 您的${typeName}申請已被拒絕\n📅 ${reqData.start_date} ~ ${reqData.end_date}\n原因：${updateData.rejection_reason}`);
                    }
                }

                showToast(`✅ 請假申請已${newStatus === 'approved' ? '通過' : '拒絕'}`);
                writeAuditLog(newStatus === 'approved' ? 'approve' : 'reject', 'leave_requests', requestId, reqData?.employees?.name);
                loadLeaveApprovals('pending');

            } catch (err) {
                console.error(err);
                showToast('❌ 審核失敗: ' + friendlyError(err));
            }
        }

        // ===== 人力管理 — 頁籤切換 =====
        function switchStaffTab(tab) {
            document.querySelectorAll('.staffTabContent').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.smTab').forEach(btn => {
                btn.style.background = 'transparent'; btn.style.color = '#94A3B8'; btn.style.boxShadow = 'none';
            });
            const tabEl = document.getElementById({ shift:'tabShift', leave:'tabLeave', setting:'tabSetting' }[tab]);
            if (tabEl) tabEl.style.display = 'block';
            const btns = document.querySelectorAll('.smTab');
            const idx = { shift:0, leave:1, setting:2 }[tab];
            if (btns[idx]) { btns[idx].style.background = '#fff'; btns[idx].style.color = '#4F46E5'; btns[idx].style.boxShadow = '0 1px 4px rgba(0,0,0,0.08)'; }
            if (tab === 'leave') loadLeaveCal();
            if (tab === 'shift') loadShiftMgr();
            if (tab === 'setting') { loadMaxLeaveSetting(); loadStaffOverview(); }
        }

        // ===== 人力設定 =====
        let maxLeaveValue = 2;

        function adjustMaxLeave(d) {
            maxLeaveValue = Math.max(1, Math.min(10, maxLeaveValue + d));
            document.getElementById('maxLeaveNum').textContent = maxLeaveValue;
        }

        async function loadMaxLeaveSetting() {
            try {
                const { data } = await sb.from('hr_settings').select('value').eq('key', 'max_concurrent_leave').maybeSingle();
                if (data?.value?.max) { maxLeaveValue = data.value.max; }
            } catch(e) {}
            document.getElementById('maxLeaveNum').textContent = maxLeaveValue;
        }

        async function saveMaxLeave() {
            const statusEl = document.getElementById('maxLeaveSaveStatus');
            try {
                const { data: existing } = await sb.from('hr_settings').select('id').eq('key', 'max_concurrent_leave').maybeSingle();
                const val = { max: maxLeaveValue };
                if (existing) {
                    await sb.from('hr_settings').update({ value: val, updated_at: new Date().toISOString() }).eq('key', 'max_concurrent_leave');
                } else {
                    await sb.from('hr_settings').insert({ key: 'max_concurrent_leave', value: val, description: '同時請假人數上限' });
                }
                statusEl.style.display = 'block'; statusEl.style.color = '#059669'; statusEl.textContent = '✅ 已儲存';
                setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
            } catch(e) {
                statusEl.style.display = 'block'; statusEl.style.color = '#DC2626'; statusEl.textContent = '❌ 儲存失敗';
            }
        }

        async function loadStaffOverview() {
            const el = document.getElementById('staffOverview');
            if (!el) return;
            try {
                const { data: emps } = await sb.from('employees').select('id, is_active').eq('is_active', true);
                const total = emps?.length || 0;
                if (total === 0) {
                    el.innerHTML = `
                        <div style="text-align:center;padding:12px;">
                            <div style="font-size:14px;font-weight:700;color:#64748B;margin-bottom:8px;">目前沒有在職員工</div>
                            <button onclick="showPage('employeePage')" style="padding:10px 20px;border:none;border-radius:8px;background:#4F46E5;color:#fff;font-weight:700;font-size:13px;cursor:pointer;">👉 前往新增員工</button>
                        </div>`;
                    return;
                }
                const todayStr = getTaiwanDate();
                const { data: todayLeaves } = await sb.from('leave_requests').select('id')
                    .in('status', ['approved','pending'])
                    .lte('start_date', todayStr).gte('end_date', todayStr);
                const onLeave = todayLeaves?.length || 0;
                el.innerHTML = `
                    <div style="display:flex;gap:8px;margin-bottom:8px;">
                        <span style="padding:6px 12px;background:#ECFDF5;border-radius:8px;font-weight:700;color:#059669;">👥 在職 ${total} 人</span>
                        <span style="padding:6px 12px;background:#FFF7ED;border-radius:8px;font-weight:700;color:#EA580C;">🏖️ 今日請假 ${onLeave} 人</span>
                        <span style="padding:6px 12px;background:#EFF6FF;border-radius:8px;font-weight:700;color:#2563EB;">💪 今日可用 ${total - onLeave} 人</span>
                    </div>
                    <div style="font-size:12px;color:#94A3B8;">目前設定：同時最多 <b style="color:#DC2626;">${maxLeaveValue}</b> 人請假</div>
                `;
            } catch(e) { el.textContent = '載入失敗'; }
        }

        // ===== 休假月表 =====
        let lcYear, lcMonth;
        (function() { const n = new Date(); lcYear = n.getFullYear(); lcMonth = n.getMonth(); })();

        function changeLeaveCal(d) {
            lcMonth += d;
            if (lcMonth < 0) { lcMonth = 11; lcYear--; }
            if (lcMonth > 11) { lcMonth = 0; lcYear++; }
            loadLeaveCal();
        }
        function resetLeaveCal() {
            const n = new Date(); lcYear = n.getFullYear(); lcMonth = n.getMonth();
            loadLeaveCal();
        }

        async function loadLeaveCal() {
            document.getElementById('lcMonthLabel').textContent = `${lcYear}年 ${lcMonth + 1}月`;
            // Loading 狀態
            document.getElementById('lcBody').innerHTML = '<tr><td colspan="32" style="text-align:center;padding:30px;color:#94A3B8;font-size:13px;">⏳ 載入中...</td></tr>';
            document.getElementById('lcHead').innerHTML = '';
            const dim = new Date(lcYear, lcMonth + 1, 0).getDate();
            const ms = `${lcYear}-${String(lcMonth + 1).padStart(2, '0')}-01`;
            const me = `${lcYear}-${String(lcMonth + 1).padStart(2, '0')}-${dim}`;

            // 讀取上限
            let maxC = maxLeaveValue || 2;
            try {
                const { data: s } = await sb.from('hr_settings').select('value').eq('key', 'max_concurrent_leave').maybeSingle();
                if (s?.value?.max) maxC = s.value.max;
            } catch(e) {}
            document.getElementById('lcMax').textContent = maxC;

            let employees = [], leaves = [];
            try {
                const { data: emps } = await sb.from('employees').select('id, name, department').eq('is_active', true).order('department').order('name');
                employees = emps || [];
                const { data: lvs } = await sb.from('leave_requests').select('employee_id, start_date, end_date, leave_type, status')
                    .in('status', ['approved', 'pending']).or(`and(start_date.lte.${me},end_date.gte.${ms})`);
                leaves = lvs || [];
            } catch(e) { console.error(e); }

            // 空狀態
            if (employees.length === 0) {
                document.getElementById('lcHead').innerHTML = '';
                document.getElementById('lcBody').innerHTML = `<tr><td style="text-align:center;padding:40px 20px;">
                    <div style="font-size:48px;margin-bottom:12px;">👥</div>
                    <div style="font-size:14px;font-weight:800;color:#0F172A;">尚無員工資料</div>
                    <div style="font-size:12px;color:#94A3B8;margin-top:6px;">請先到「員工管理」新增員工</div>
                </td></tr>`;
                document.getElementById('lcTotal').textContent = '0';
                document.getElementById('lcAvail').textContent = '0';
                document.getElementById('lcOverWarn').style.display = 'none';
                return;
            }

            const wd = ['日','一','二','三','四','五','六'];
            // 計算每天請假人數
            const dayCount = {};
            for (let d = 1; d <= dim; d++) {
                const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                dayCount[ds] = 0;
                leaves.forEach(l => { if (ds >= l.start_date && ds <= (l.end_date || l.start_date)) dayCount[ds]++; });
            }

            // 表頭
            let headHtml = '<tr><th style="position:sticky;left:0;background:#fff;z-index:2;padding:6px 8px;min-width:60px;text-align:left;border-bottom:2px solid #E5E7EB;font-size:11px;">姓名</th>';
            for (let d = 1; d <= dim; d++) {
                const dt = new Date(lcYear, lcMonth, d);
                const isW = dt.getDay()===0 || dt.getDay()===6;
                const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const over = dayCount[ds] >= maxC && !isW;
                const bg = over ? '#FEE2E2' : isW ? '#F1F5F9' : '#fff';
                headHtml += `<th style="padding:4px 2px;min-width:28px;text-align:center;border-bottom:2px solid ${over?'#FCA5A5':'#E5E7EB'};background:${bg};font-size:10px;">
                    <div style="${over?'color:#DC2626;font-weight:900;':''}">${d}</div><div style="color:#94A3B8;font-size:9px;">${wd[dt.getDay()]}</div>
                    ${over ? '<div style="font-size:8px;color:#DC2626;font-weight:900;">滿</div>' : ''}
                </th>`;
            }
            headHtml += '</tr>';
            document.getElementById('lcHead').innerHTML = headHtml;

            // 表身
            const typeColor = { annual:'#DBEAFE', sick:'#FEE2E2', personal:'#FEF3C7', compensatory:'#E0E7FF' };
            const typeEmoji = { annual:'🏖', sick:'🤒', personal:'📋', compensatory:'💤' };
            let totalLeaves = 0;
            const todayStr = getTaiwanDate();
            let todayAvail = employees.length;
            let overDays = [];

            let bodyHtml = '';
            employees.forEach(emp => {
                const empLeaves = leaves.filter(l => l.employee_id === emp.id);
                bodyHtml += `<tr><td style="position:sticky;left:0;background:#fff;z-index:1;padding:6px 8px;font-weight:700;font-size:11px;white-space:nowrap;border-bottom:1px solid #F1F5F9;">${emp.name}</td>`;
                for (let d = 1; d <= dim; d++) {
                    const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const dt = new Date(lcYear, lcMonth, d);
                    const isW = dt.getDay()===0 || dt.getDay()===6;
                    const lv = empLeaves.find(l => ds >= l.start_date && ds <= (l.end_date || l.start_date));
                    const over = dayCount[ds] > maxC && !isW;
                    if (lv) {
                        totalLeaves++;
                        if (ds === todayStr) todayAvail--;
                        const bg = over ? '#FCA5A5' : (typeColor[lv.leave_type] || '#F1F5F9');
                        const emoji = typeEmoji[lv.leave_type] || '📝';
                        const pending = lv.status === 'pending' ? 'opacity:0.6;' : '';
                        bodyHtml += `<td style="text-align:center;background:${bg};border-bottom:1px solid #F1F5F9;${pending}font-size:10px;cursor:default;" title="${emp.name} ${lv.leave_type}${lv.status==='pending'?' (待審)':''}${over?' ⚠超限':''}">${emoji}</td>`;
                    } else if (isW) {
                        bodyHtml += `<td style="background:#F8FAFC;border-bottom:1px solid #F1F5F9;"></td>`;
                    } else {
                        bodyHtml += `<td style="border-bottom:1px solid #F1F5F9;"></td>`;
                    }
                }
                bodyHtml += '</tr>';
            });

            // 底部統計列 — 每日請假人數
            bodyHtml += '<tr style="background:#F8FAFC;"><td style="position:sticky;left:0;background:#F8FAFC;z-index:1;padding:6px 8px;font-weight:700;font-size:10px;color:#64748B;">請假數</td>';
            for (let d = 1; d <= dim; d++) {
                const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dt = new Date(lcYear, lcMonth, d);
                const isW = dt.getDay()===0 || dt.getDay()===6;
                const cnt = dayCount[ds] || 0;
                const over = cnt >= maxC && !isW;
                if (over && !isW) overDays.push(`${lcMonth+1}/${d}`);
                bodyHtml += `<td style="text-align:center;font-size:10px;font-weight:900;color:${over?'#DC2626':cnt>0?'#EA580C':'#CBD5E1'};border-bottom:1px solid #F1F5F9;background:${over?'#FEF2F2':'#F8FAFC'};">${cnt||'-'}</td>`;
            }
            bodyHtml += '</tr>';

            document.getElementById('lcBody').innerHTML = bodyHtml;
            document.getElementById('lcTotal').textContent = totalLeaves;
            document.getElementById('lcAvail').textContent = Math.max(0, todayAvail);

            // 超限警告
            const warnEl = document.getElementById('lcOverWarn');
            if (overDays.length > 0) {
                warnEl.style.display = 'block';
                warnEl.innerHTML = `🚨 以下日期請假人數已達/超過上限（${maxC}人）：<br><b>${overDays.join('、')}</b><br><span style="font-size:11px;opacity:0.7;">員工在這些日期提交請假將被自動駁回</span>`;
            } else {
                warnEl.style.display = 'none';
            }
        }

        // ===== 排班管理 =====
        let smWeekStart;
        (function() {
            const n = new Date(); const dow = n.getDay();
            smWeekStart = new Date(n);
            // 週一起算：dow=0(日)→回退6天, dow=1(一)→回退0天, dow=2(二)→回退1天...
            smWeekStart.setDate(n.getDate() - ((dow + 6) % 7));
            smWeekStart.setHours(0,0,0,0);
        })();

        let smEmployees = [];
        let smScheduleData = {};
        let smLeaveData = {};
        const SHIFT_TYPES = [null, 'morning', 'afternoon', 'night', 'off'];
        const SHIFT_DISPLAY = {
            null: { label:'⬜', bg:'#F8FAFC', color:'#94A3B8', name:'未排' },
            morning: { label:'☀️', bg:'#DBEAFE', color:'#1E40AF', name:'早班' },
            afternoon: { label:'🌤️', bg:'#FEF3C7', color:'#92400E', name:'中班' },
            night: { label:'🌙', bg:'#EDE9FE', color:'#6D28D9', name:'晚班' },
            off: { label:'🏖️', bg:'#ECFDF5', color:'#059669', name:'休假' }
        };

        function changeShiftWeek(d) { smWeekStart.setDate(smWeekStart.getDate() + d*7); loadShiftMgr(); }
        function resetShiftWeek() {
            const n = new Date(); const dow = n.getDay();
            smWeekStart = new Date(n);
            smWeekStart.setDate(n.getDate() - ((dow + 6) % 7));
            smWeekStart.setHours(0,0,0,0);
            loadShiftMgr();
        }

        function getWeekDates() {
            const dates = [];
            for (let i = 0; i < 7; i++) { const d = new Date(smWeekStart); d.setDate(d.getDate()+i); dates.push(d); }
            return dates;
        }

        async function loadShiftMgr() {
            const dates = getWeekDates();
            const startStr = fmtDate(dates[0]);
            const endStr = fmtDate(dates[6]);
            document.getElementById('smWeekLabel').textContent = `${startStr} ~ ${endStr}`;
            // Loading
            document.getElementById('smBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:#94A3B8;font-size:13px;">⏳ 載入中...</td></tr>';
            document.getElementById('smHead').innerHTML = '';
            document.getElementById('shiftDaySummary').innerHTML = '';

            try {
                const { data: emps } = await sb.from('employees').select('id, name, department').eq('is_active', true).order('name');
                smEmployees = emps || [];
                const { data: scheds } = await sb.from('schedules').select('employee_id, date, shift_type_id, shift_types(name, code)')
                    .gte('date', startStr).lte('date', endStr);
                smScheduleData = {};
                (scheds || []).forEach(s => {
                    const code = s.shift_types?.code || s.shift_types?.name || 'morning';
                    smScheduleData[`${s.employee_id}_${s.date}`] = code;
                });
                // 載入該週請假
                const { data: lvs } = await sb.from('leave_requests').select('employee_id, start_date, end_date, status')
                    .in('status', ['approved']).or(`and(start_date.lte.${endStr},end_date.gte.${startStr})`);
                smLeaveData = {};
                (lvs || []).forEach(l => {
                    // 用字串比較避免時區問題
                    const rangeStart = l.start_date > startStr ? l.start_date : startStr;
                    const rangeEnd = (l.end_date || l.start_date) < endStr ? (l.end_date || l.start_date) : endStr;
                    // 逐日標記
                    let cur = new Date(rangeStart + 'T00:00:00');
                    const end = new Date(rangeEnd + 'T00:00:00');
                    while (cur <= end) {
                        smLeaveData[`${l.employee_id}_${fmtDate(cur)}`] = true;
                        cur.setDate(cur.getDate() + 1);
                    }
                });
            } catch(e) { console.error(e); }

            renderShiftTable();
        }

        function renderShiftTable() {
            const dates = getWeekDates();
            const wd = ['日','一','二','三','四','五','六'];

            // 空狀態
            if (smEmployees.length === 0) {
                document.getElementById('smHead').innerHTML = '';
                document.getElementById('smBody').innerHTML = '';
                document.getElementById('shiftDaySummary').innerHTML = `
                    <div style="width:100%;text-align:center;padding:40px 20px;">
                        <div style="font-size:48px;margin-bottom:12px;">👥</div>
                        <div style="font-size:16px;font-weight:800;color:#0F172A;margin-bottom:8px;">尚無員工資料</div>
                        <div style="font-size:13px;color:#94A3B8;margin-bottom:16px;">請先到「員工管理」新增員工，才能排班</div>
                        <button onclick="showPage('employeePage')" style="padding:12px 24px;border:none;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">👉 前往員工管理</button>
                    </div>`;
                document.getElementById('shiftStaffWarn').style.display = 'none';
                return;
            }

            // 表頭
            let headHtml = '<tr><th style="position:sticky;left:0;background:#fff;z-index:2;padding:8px;min-width:60px;text-align:left;border-bottom:2px solid #E5E7EB;font-size:11px;">姓名</th>';
            dates.forEach(d => {
                const isW = d.getDay()===0||d.getDay()===6;
                headHtml += `<th style="padding:6px 4px;min-width:46px;text-align:center;border-bottom:2px solid #E5E7EB;background:${isW?'#F1F5F9':'#fff'};">
                    <div style="font-size:12px;">${d.getDate()}</div><div style="font-size:10px;color:#94A3B8;">週${wd[d.getDay()]}</div>
                </th>`;
            });
            headHtml += '</tr>';
            document.getElementById('smHead').innerHTML = headHtml;

            // 表身
            let bodyHtml = '';
            smEmployees.forEach(emp => {
                bodyHtml += `<tr><td style="position:sticky;left:0;background:#fff;z-index:1;padding:8px;font-weight:700;font-size:11px;white-space:nowrap;border-bottom:1px solid #F1F5F9;">${emp.name}</td>`;
                dates.forEach(d => {
                    const ds = fmtDate(d);
                    const key = `${emp.id}_${ds}`;
                    const onLeave = smLeaveData[key];
                    const shift = smScheduleData[key] || null;
                    const disp = SHIFT_DISPLAY[shift] || SHIFT_DISPLAY[null];
                    if (onLeave) {
                        bodyHtml += `<td style="text-align:center;padding:8px 4px;border-bottom:1px solid #F1F5F9;background:#FEE2E2;font-size:14px;cursor:not-allowed;opacity:0.7;" title="${emp.name} 已請假">🏖️</td>`;
                    } else {
                        bodyHtml += `<td onclick="cycleShift('${key}')" style="text-align:center;padding:8px 4px;cursor:pointer;border-bottom:1px solid #F1F5F9;background:${disp.bg};font-size:14px;transition:all 0.15s;user-select:none;" title="${emp.name} ${ds} ${disp.name}">${disp.label}</td>`;
                    }
                });
                bodyHtml += '</tr>';
            });

            // 每日人力統計列
            bodyHtml += '<tr style="background:#F8FAFC;font-weight:700;"><td style="position:sticky;left:0;background:#F8FAFC;z-index:1;padding:6px 8px;font-size:10px;color:#64748B;">上班人數</td>';
            let warnDays = [];
            dates.forEach(d => {
                const ds = fmtDate(d);
                const isW = d.getDay()===0||d.getDay()===6;
                let working = 0;
                smEmployees.forEach(emp => {
                    const key = `${emp.id}_${ds}`;
                    if (smLeaveData[key]) return;
                    const shift = smScheduleData[key];
                    if (shift && shift !== 'off') working++;
                });
                const low = working > 0 && working <= 2 && !isW;
                if (low) warnDays.push(`${d.getMonth()+1}/${d.getDate()}(${working}人)`);
                bodyHtml += `<td style="text-align:center;font-size:11px;color:${low?'#DC2626':working>0?'#059669':'#94A3B8'};background:${low?'#FEF2F2':'#F8FAFC'};border-bottom:1px solid #F1F5F9;">${working||'-'}</td>`;
            });
            bodyHtml += '</tr>';
            document.getElementById('smBody').innerHTML = bodyHtml;

            // 每日摘要卡片
            let sumHtml = '';
            dates.forEach(d => {
                const ds = fmtDate(d);
                const isW = d.getDay()===0||d.getDay()===6;
                const counts = { morning:0, afternoon:0, night:0, off:0, leave:0, unset:0 };
                smEmployees.forEach(emp => {
                    const key = `${emp.id}_${ds}`;
                    if (smLeaveData[key]) { counts.leave++; return; }
                    const s = smScheduleData[key];
                    if (s && counts.hasOwnProperty(s)) counts[s]++;
                    else counts.unset++;
                });
                const total = counts.morning + counts.afternoon + counts.night;
                const low = total > 0 && total <= 2 && !isW;
                sumHtml += `<div style="min-width:60px;padding:6px 8px;background:${low?'#FEF2F2':'#F8FAFC'};border-radius:8px;text-align:center;flex-shrink:0;${low?'border:2px solid #FCA5A5;':''}">
                    <div style="font-size:10px;font-weight:700;color:#64748B;">${d.getDate()}日</div>
                    <div style="font-size:14px;font-weight:900;color:${low?'#DC2626':'#0F172A'};">${total}人</div>
                    <div style="font-size:9px;color:#94A3B8;">☀${counts.morning} 🌤${counts.afternoon} 🌙${counts.night}</div>
                    ${counts.leave>0?`<div style="font-size:9px;color:#EA580C;">假${counts.leave}</div>`:''}
                </div>`;
            });
            document.getElementById('shiftDaySummary').innerHTML = sumHtml;

            // 人手不足警告
            const warnEl = document.getElementById('shiftStaffWarn');
            if (warnDays.length > 0) {
                warnEl.style.display = 'block';
                warnEl.innerHTML = `⚠️ 人手不足警告：${warnDays.join('、')}<br><span style="font-size:11px;opacity:0.7;">建議調整排班或限制請假</span>`;
            } else {
                warnEl.style.display = 'none';
            }
        }

        function cycleShift(key) {
            const current = smScheduleData[key] || null;
            const idx = SHIFT_TYPES.indexOf(current);
            smScheduleData[key] = SHIFT_TYPES[(idx+1) % SHIFT_TYPES.length];
            renderShiftTable();
        }

        async function saveSchedule() {
            const statusEl = document.getElementById('smSaveStatus');
            statusEl.style.display = 'block'; statusEl.style.color = '#F59E0B'; statusEl.textContent = '⏳ 儲存中...';
            try {
                const { data: shiftTypes } = await sb.from('shift_types').select('id, code, name');
                const stMap = {};
                (shiftTypes || []).forEach(st => { stMap[st.code || st.name] = st.id; });
                const upserts = [];
                for (const [key, shift] of Object.entries(smScheduleData)) {
                    if (!shift) continue;
                    const parts = key.split('_');
                    const empId = parts[0];
                    const date = parts.slice(1).join('-');
                    const stId = stMap[shift];
                    if (!stId) continue;
                    upserts.push({ employee_id: empId, date, shift_type_id: stId });
                }
                if (upserts.length > 0) {
                    const { error } = await sb.from('schedules').upsert(upserts, { onConflict: 'employee_id,date' });
                    if (error) throw error;
                }
                statusEl.style.color = '#059669'; statusEl.textContent = `✅ 已儲存 ${upserts.length} 筆排班`;
                setTimeout(() => { statusEl.style.display = 'none'; }, 2500);
            } catch(e) {
                console.error(e);
                statusEl.style.color = '#DC2626'; statusEl.textContent = '❌ 儲存失敗: ' + e.message;
            }
        }

        async function copyLastWeek() {
            if (!confirm('確定要複製上週排班到本週？\n（已有排班不會被覆蓋）')) return;
            const dates = getWeekDates();
            try {
                const lwStart = new Date(dates[0]); lwStart.setDate(lwStart.getDate()-7);
                const lwEnd = new Date(dates[6]); lwEnd.setDate(lwEnd.getDate()-7);
                const { data: lastScheds } = await sb.from('schedules').select('employee_id, date, shift_type_id, shift_types(code, name)')
                    .gte('date', fmtDate(lwStart)).lte('date', lwEnfmtDate(d));
                let copied = 0;
                (lastScheds || []).forEach(s => {
                    const oldD = new Date(s.date + 'T00:00:00');
                    const newD = new Date(oldD); newD.setDate(newD.getDate()+7);
                    const key = `${s.employee_id}_${fmtDate(newD)}`;
                    if (!smScheduleData[key]) {
                        smScheduleData[key] = s.shift_types?.code || s.shift_types?.name || 'morning';
                        copied++;
                    }
                });
                renderShiftTable();
                showToast(`📋 已複製上週 ${copied} 筆排班`);
            } catch(e) { console.error(e); showToast('❌ 複製失敗'); }
        }


        // ===== 補打卡審核 =====
        function switchMakeupTab(status) {
            document.querySelectorAll('#makeupApprovalPage .tab-btn').forEach(btn => {
                btn.className = 'tab-btn ' + (btn.textContent.includes(status === 'pending' ? '待審' : status === 'approved' ? '已通過' : '已拒絕') ? 'active' : 'inactive');
            });
            loadMakeupApprovals(status);
        }

        async function loadMakeupApprovals(status) {
            const listEl = document.getElementById('makeupApprovalList');
            if (!listEl) return;
            listEl.innerHTML = '<p style="text-align:center;color:#666;">載入中...</p>';

            try {
                const { data } = await sb.from('makeup_punch_requests')
                    .select('*, employees(name, department, employee_number)')
                    .eq('status', status)
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (!data || data.length === 0) {
                    const labels = { pending:'待審核', approved:'已通過', rejected:'已拒絕' };
                    listEl.innerHTML = `<p style="text-align:center;color:#999;">無${labels[status]}的補打卡申請</p>`;
                    return;
                }

                const typeMap = { clock_in:'☀️ 上班', clock_out:'🌙 下班' };
                listEl.innerHTML = data.map(r => `
                    <div style="background:#fff;border-radius:14px;padding:14px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <span style="font-weight:800;font-size:14px;">${r.employees?.name || '?'}</span>
                            <span style="font-size:11px;color:#94A3B8;">${r.employees?.department || ''} · ${r.employees?.employee_number || ''}</span>
                        </div>
                        <div style="display:flex;gap:8px;margin-bottom:8px;font-size:13px;">
                            <span style="padding:4px 10px;background:#EFF6FF;border-radius:8px;color:#2563EB;font-weight:700;">📅 ${r.punch_date}</span>
                            <span style="padding:4px 10px;background:#F5F3FF;border-radius:8px;color:#7C3AED;font-weight:700;">${typeMap[r.punch_type] || r.punch_type} ${r.punch_time || ''}</span>
                        </div>
                        <div style="font-size:12px;color:#64748B;margin-bottom:8px;">${r.reason || ''}</div>
                        ${status === 'pending' ? `
                            <div style="display:flex;gap:8px;">
                                <button onclick="approveMakeupPunch('${r.id}','approved')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#ECFDF5;color:#059669;font-weight:700;font-size:13px;cursor:pointer;">✅ 通過</button>
                                <button onclick="rejectMakeupPunchPrompt('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#FEF2F2;color:#DC2626;font-weight:700;font-size:13px;cursor:pointer;">❌ 拒絕</button>
                            </div>
                        ` : ''}
                        ${r.status === 'approved' ? '<div style="font-size:11px;color:#059669;margin-top:4px;">✅ 已自動寫入出勤記錄</div>' : ''}
                        ${r.rejection_reason ? `<div style="font-size:11px;color:#DC2626;margin-top:4px;">❌ ${r.rejection_reason}</div>` : ''}
                    </div>
                `).join('');
            } catch(e) {
                console.error(e);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗</p>';
            }
        }

        async function approveMakeupPunch(id, status) {
            try {
                const { data: req } = await sb.from('makeup_punch_requests').select('*').eq('id', id).single();
                
                await sb.from('makeup_punch_requests').update({
                    status: status,
                    approver_id: currentAdminEmployee?.id,
                    approved_at: new Date().toISOString()
                }).eq('id', id);

                // 通過後自動寫入 attendance
                if (status === 'approved' && req) {
                    const col = req.punch_type === 'clock_in' ? 'check_in_time' : 'check_out_time';
                    const timeVal = `${req.punch_date}T${req.punch_time}:00`;
                    
                    // 先查是否已有當天記錄
                    const { data: existing } = await sb.from('attendance')
                        .select('id')
                        .eq('employee_id', req.employee_id)
                        .eq('date', req.punch_date)
                        .maybeSingle();
                    
                    if (existing) {
                        await sb.from('attendance').update({
                            [col]: timeVal,
                            is_manual: true,
                            notes: `補打卡 - ${req.reason || ''}`
                        }).eq('id', existing.id);
                    } else {
                        await sb.from('attendance').insert({
                            employee_id: req.employee_id,
                            date: req.punch_date,
                            [col]: timeVal,
                            is_manual: true,
                            status: 'present',
                            notes: `補打卡 - ${req.reason || ''}`
                        });
                    }
                    
                    // 通知員工
                    sendUserNotify(req.employee_id, `✅ 您的補打卡申請已通過\n📅 ${req.punch_date} ${req.punch_type === 'clock_in' ? '上班' : '下班'} ${req.punch_time}`);
                }

                showToast(status === 'approved' ? '✅ 已通過並寫入出勤' : '❌ 已拒絕');
                writeAuditLog(status === 'approved' ? 'approve' : 'reject', 'makeup_punch_requests', id, req?.employees?.name || '');
                loadMakeupApprovals('pending');
            } catch(e) {
                console.error(e);
                showToast('❌ 審核失敗: ' + friendlyError(e));
            }
        }

        function rejectMakeupPunchPrompt(id) {
            const reason = prompt('請輸入拒絕原因（選填）：');
            if (reason === null) return;
            rejectMakeupPunch(id, reason);
        }

        async function rejectMakeupPunch(id, reason) {
            try {
                await sb.from('makeup_punch_requests').update({
                    status: 'rejected',
                    rejection_reason: reason || '不符合規定',
                    approver_id: currentAdminEmployee?.id,
                    approved_at: new Date().toISOString()
                }).eq('id', id);
                showToast('❌ 已拒絕');
                loadMakeupApprovals('pending');
            } catch(e) { showToast('❌ 操作失敗'); }
        }

        // ===== 公告管理 =====
        async function publishAnnouncement() {
            const title = document.getElementById('annTitle')?.value;
            const content = document.getElementById('annContent')?.value;
            const type = document.getElementById('annType')?.value;
            const expire = document.getElementById('annExpire')?.value;
            const pinned = document.getElementById('annPinned')?.checked;
            const requireAck = document.getElementById('annRequireAck')?.checked;
            
            if (!title) return showToast('❌ 請輸入標題');
            
            try {
                // 讀取現有公告
                const { data: existing } = await sb.from('hr_settings')
                    .select('value').eq('key', 'announcements').maybeSingle();
                
                const items = existing?.value?.items || [];
                items.unshift({
                    id: Date.now().toString(),
                    title, content, type, pinned,
                    require_ack: requireAck || false,
                    expire_date: expire || null,
                    created_at: new Date().toISOString(),
                    created_by: currentAdminEmployee?.name || 'admin'
                });
                
                if (existing) {
                    await sb.from('hr_settings').update({ value: { items }, updated_at: new Date().toISOString() }).eq('key', 'announcements');
                } else {
                    await sb.from('hr_settings').insert({ key: 'announcements', value: { items }, description: '公告系統' });
                }
                
                showToast('📢 公告已發布');
                document.getElementById('annTitle').value = '';
                document.getElementById('annContent').value = '';
                document.getElementById('annExpire').value = '';
                document.getElementById('annPinned').checked = false;
                if (document.getElementById('annRequireAck')) document.getElementById('annRequireAck').checked = false;
                loadAnnouncementList();
            } catch(e) { showToast('❌ 發布失敗：' + friendlyError(e)); }
        }

        async function loadAnnouncementList() {
            const el = document.getElementById('announcementList');
            if (!el) return;
            
            try {
                const { data } = await sb.from('hr_settings')
                    .select('value').eq('key', 'announcements').maybeSingle();
                
                const items = data?.value?.items || [];
                if (items.length === 0) { el.innerHTML = '<p style="text-align:center;color:#999;">尚無公告</p>'; return; }
                
                const typeIcon = { info:'📢', warning:'⚠️', urgent:'🚨', event:'🎉' };
                const typeColor = { info:'#2563EB', warning:'#EA580C', urgent:'#DC2626', event:'#7C3AED' };
                const typeBg = { info:'#EFF6FF', warning:'#FFF7ED', urgent:'#FEF2F2', event:'#F5F3FF' };
                
                el.innerHTML = items.map(a => `
                    <div style="background:${typeBg[a.type] || '#F1F5F9'};border-radius:12px;padding:14px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <span style="font-weight:800;color:${typeColor[a.type] || '#64748B'};">${typeIcon[a.type] || '📌'} ${a.title}</span>
                            <button onclick="deleteAnnouncement('${a.id}')" style="background:none;border:none;font-size:14px;cursor:pointer;padding:4px;">🗑️</button>
                        </div>
                        ${a.content ? `<div style="font-size:12px;color:#64748B;margin-bottom:4px;">${a.content}</div>` : ''}
                        <div style="font-size:10px;color:#94A3B8;">
                            ${a.pinned ? '📌 置頂 · ' : ''}
                            ${a.expire_date ? '到期：' + a.expire_date + ' · ' : '永久 · '}
                            ${a.created_by || ''} · ${a.created_at ? new Date(a.created_at).toLocaleDateString() : ''}
                        </div>
                    </div>
                `).join('');
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗</p>'; }
        }

        async function deleteAnnouncement(id) {
            if (!confirm('確定刪除此公告？')) return;
            try {
                const { data } = await sb.from('hr_settings')
                    .select('value').eq('key', 'announcements').maybeSingle();
                if (!data?.value?.items) return;
                
                const items = data.value.items.filter(a => a.id !== id);
                await sb.from('hr_settings').update({ value: { items }, updated_at: new Date().toISOString() }).eq('key', 'announcements');
                showToast('🗑️ 已刪除');
                loadAnnouncementList();
            } catch(e) { showToast('❌ 刪除失敗'); }
        }

        // ===== 加班審核 =====
        function switchOtTab(status) {
            document.querySelectorAll('#overtimeApprovalPage .tab-btn').forEach(btn => {
                btn.className = 'tab-btn ' + (btn.textContent.includes(status === 'pending' ? '待審' : status === 'approved' ? '已通過' : '已拒絕') ? 'active' : 'inactive');
            });
            loadOtApprovals(status);
        }

        async function loadOtApprovals(status) {
            const el = document.getElementById('otApprovalList');
            if (!el) return;
            el.innerHTML = '<p style="text-align:center;color:#666;">載入中...</p>';
            try {
                const { data } = await sb.from('overtime_requests')
                    .select('*, employees(name, department, employee_number)')
                    .eq('status', status).order('created_at', { ascending: false }).limit(20);
                if (!data || data.length === 0) {
                    el.innerHTML = `<p style="text-align:center;color:#999;">無資料</p>`; return;
                }
                const compMap = { pay:'💰 加班費', comp_leave:'🏖️ 換補休' };
                el.innerHTML = data.map(r => `
                    <div style="background:#fff;border-radius:14px;padding:14px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <b>${r.employees?.name || '?'}</b>
                            <span style="font-size:11px;color:#94A3B8;">${r.employees?.department || ''}</span>
                        </div>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px;font-size:12px;">
                            <span style="padding:3px 8px;background:#EFF6FF;border-radius:6px;color:#2563EB;font-weight:700;">📅 ${r.ot_date}</span>
                            <span style="padding:3px 8px;background:#F5F3FF;border-radius:6px;color:#7C3AED;font-weight:700;">⏰ ${r.planned_hours}h</span>
                            <span style="padding:3px 8px;background:#ECFDF5;border-radius:6px;color:#059669;font-weight:700;">${compMap[r.compensation_type] || ''}</span>
                        </div>
                        <div style="font-size:12px;color:#64748B;margin-bottom:6px;">${r.reason || ''}</div>
                        ${status === 'pending' ? `
                            <div style="margin-bottom:8px;">
                                <label style="font-size:12px;font-weight:700;">核准時數：</label>
                                <input type="number" id="otAH_${r.id}" value="${r.planned_hours}" min="0" max="12" step="0.5" style="width:70px;padding:4px;border:1px solid #E5E7EB;border-radius:6px;">h
                            </div>
                            <div style="display:flex;gap:8px;">
                                <button onclick="approveOt('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#ECFDF5;color:#059669;font-weight:700;cursor:pointer;">✅ 通過</button>
                                <button onclick="rejectOtPrompt('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#FEF2F2;color:#DC2626;font-weight:700;cursor:pointer;">❌ 拒絕</button>
                            </div>
                        ` : ''}
                        ${r.approved_hours ? `<div style="font-size:11px;color:#059669;">核准 ${r.approved_hours}h${r.final_hours != null ? ' · 計薪 '+r.final_hours+'h' : ''}</div>` : ''}
                        ${r.rejection_reason ? `<div style="font-size:11px;color:#DC2626;">❌ ${r.rejection_reason}</div>` : ''}
                    </div>
                `).join('');
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗</p>'; }
        }

        async function approveOt(id) {
            const h = parseFloat(document.getElementById(`otAH_${id}`)?.value) || 0;
            if (h <= 0) return showToast('❌ 核准時數需大於 0');
            try {
                const { data: req } = await sb.from('overtime_requests').select('*, employees(name, id)').eq('id', id).single();
                await sb.from('overtime_requests').update({
                    status:'approved', approved_hours:h, approver_id:currentAdminEmployee?.id, approved_at:new Date().toISOString()
                }).eq('id', id);
                writeAuditLog('approve','overtime_requests',id,req?.employees?.name,{approved_hours:h});
                if (req?.employees?.id) sendUserNotify(req.employees.id,`✅ 加班已通過\n📅 ${req.ot_date} 核准 ${h}h`);
                showToast('✅ 已通過'); loadOtApprovals('pending');
            } catch(e) { showToast('❌ 審核失敗'); }
        }
        function rejectOtPrompt(id) { const r = prompt('拒絕原因：'); if(r===null) return; rejectOt(id,r); }
        async function rejectOt(id, reason) {
            try {
                await sb.from('overtime_requests').update({
                    status:'rejected', rejection_reason:reason||'不符合規定',
                    approver_id:currentAdminEmployee?.id, approved_at:new Date().toISOString()
                }).eq('id', id);
                showToast('❌ 已拒絕'); loadOtApprovals('pending');
            } catch(e) { showToast('❌ 操作失敗'); }
        }

        // ===== 換班審核 =====
        async function loadSwapApprovals() {
            const el = document.getElementById('swapApprovalList');
            if (!el) return;
            el.innerHTML = '<p style="text-align:center;color:#666;">載入中...</p>';
            try {
                const { data } = await sb.from('shift_swap_requests')
                    .select('*, requester:employees!shift_swap_requests_requester_id_fkey(name, department), target:employees!shift_swap_requests_target_id_fkey(name, department)')
                    .in('status', ['pending_admin', 'approved', 'rejected'])
                    .order('created_at', { ascending: false }).limit(20);
                
                if (!data || data.length === 0) { el.innerHTML = '<p style="text-align:center;color:#999;">無換班申請</p>'; return; }
                
                const sMap = { pending_admin:'⏳ 待審', approved:'✅ 通過', rejected:'❌ 拒絕' };
                el.innerHTML = data.map(r => `
                    <div style="background:#fff;border-radius:14px;padding:14px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                            <b style="font-size:14px;">${r.requester?.name} ↔ ${r.target?.name}</b>
                            <span style="font-size:11px;color:#94A3B8;">${sMap[r.status] || r.status}</span>
                        </div>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px;font-size:12px;">
                            <span style="padding:3px 8px;background:#EFF6FF;border-radius:6px;color:#2563EB;font-weight:700;">📅 ${r.swap_date}</span>
                            <span style="padding:3px 8px;background:#FFF7ED;border-radius:6px;color:#EA580C;font-weight:700;">${r.requester_original_shift||'?'} ↔ ${r.target_original_shift||'?'}</span>
                        </div>
                        <div style="font-size:11px;color:#64748B;margin-bottom:6px;">✅ 雙方已同意${r.reason ? ' · 原因：'+r.reason : ''}</div>
                        ${r.status === 'pending_admin' ? `
                            <div style="display:flex;gap:8px;">
                                <button onclick="approveSwap('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#ECFDF5;color:#059669;font-weight:700;cursor:pointer;">✅ 核准</button>
                                <button onclick="rejectSwap('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#FEF2F2;color:#DC2626;font-weight:700;cursor:pointer;">❌ 拒絕</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗</p>'; }
        }

        async function approveSwap(id) {
            try {
                const { data: req } = await sb.from('shift_swap_requests')
                    .select('*, requester:employees!shift_swap_requests_requester_id_fkey(name, id), target:employees!shift_swap_requests_target_id_fkey(name, id)')
                    .eq('id', id).single();
                
                // 更新狀態
                await sb.from('shift_swap_requests').update({
                    status: 'approved', approver_id: currentAdminEmployee?.id, approved_at: new Date().toISOString()
                }).eq('id', id);
                
                // 交換排班表（互相更新 schedules）
                if (req) {
                    const date = req.swap_date;
                    // 取得雙方當日排班
                    const { data: s1 } = await sb.from('schedules').select('id, shift_type_id').eq('employee_id', req.requester_id).eq('date', date).maybeSingle();
                    const { data: s2 } = await sb.from('schedules').select('id, shift_type_id').eq('employee_id', req.target_id).eq('date', date).maybeSingle();
                    
                    if (s1 && s2) {
                        // 交換 shift_type_id
                        await sb.from('schedules').update({ shift_type_id: s2.shift_type_id }).eq('id', s1.id);
                        await sb.from('schedules').update({ shift_type_id: s1.shift_type_id }).eq('id', s2.id);
                    }
                    
                    writeAuditLog('approve', 'shift_swap_requests', id, `${req.requester?.name} ↔ ${req.target?.name}`, { date });
                    if (req.requester?.id) sendUserNotify(req.requester.id, `✅ 換班已核准\n📅 ${date} 班表已自動更新`);
                    if (req.target?.id) sendUserNotify(req.target.id, `✅ 換班已核准\n📅 ${date} 班表已自動更新`);
                }
                
                showToast('✅ 已核准，班表已交換');
                loadSwapApprovals();
            } catch(e) { showToast('❌ 審核失敗：' + friendlyError(e)); }
        }

        async function rejectSwap(id) {
            const reason = prompt('拒絕原因：');
            if (reason === null) return;
            try {
                await sb.from('shift_swap_requests').update({
                    status: 'rejected', rejection_reason: reason || '不符規定',
                    approver_id: currentAdminEmployee?.id, approved_at: new Date().toISOString()
                }).eq('id', id);
                showToast('❌ 已拒絕'); loadSwapApprovals();
            } catch(e) { showToast('❌ 操作失敗'); }
        }

        // ===== 操作日誌 =====
        let auditOffset = 0;
        async function loadAuditLogs(more = false) {
            const el = document.getElementById('auditLogList');
            if (!el) return;
            if (!more) { auditOffset = 0; el.innerHTML = ''; }
            try {
                const { data } = await sb.from('hr_audit_logs').select('*').order('created_at',{ascending:false}).range(auditOffset, auditOffset+29);
                if (!data || data.length === 0) { if(auditOffset===0) el.innerHTML = '<p style="text-align:center;color:#999;">尚無記錄</p>'; return; }
                const ai = {create:'➕',update:'✏️',delete:'🗑️',approve:'✅',reject:'❌',export:'📊',acknowledge:'✍️'};
                const al = {create:'新增',update:'修改',delete:'刪除',approve:'通過',reject:'拒絕',export:'匯出',acknowledge:'簽署'};
                el.innerHTML += data.map(r => `
                    <div style="padding:8px 0;border-bottom:1px solid #F1F5F9;font-size:13px;">
                        <div style="display:flex;justify-content:space-between;">
                            <span>${ai[r.action]||'📝'} <b>${r.actor_name||'?'}</b> ${al[r.action]||r.action} <span style="color:#7C3AED;">${r.target_table||''}</span></span>
                            <span style="font-size:10px;color:#94A3B8;">${r.created_at?new Date(r.created_at).toLocaleString('zh-TW'):''}</span>
                        </div>
                        ${r.target_name?`<div style="font-size:11px;color:#64748B;margin-top:2px;">對象：${r.target_name}</div>`:''}
                    </div>
                `).join('');
                auditOffset += data.length;
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#ef4444;">載入失敗</p>'; }
        }

        // ===== 報表匯出（CSV）=====
        async function exportReport(type) {
            showToast(`📊 正在產生報表...`);
            try {
                const now = new Date();
                const y = now.getFullYear(), m = now.getMonth()+1, ms = `${y}-${String(m).padStart(2,'0')}`;
                let rows = [], fn = '';
                
                if (type === 'attendance') {
                    const { data } = await sb.from('attendance').select('*, employees(name, employee_number, department)').gte('date',ms+'-01').lte('date',ms+'-31').order('date');
                    rows.push(['日期','工號','姓名','部門','上班','下班','狀態','遲到(分)','補卡','備註']);
                    (data||[]).forEach(r => rows.push([r.date,r.employees?.employee_number,r.employees?.name,r.employees?.department,r.check_in_time?.split('T')[1]?.substring(0,5)||'',r.check_out_time?.split('T')[1]?.substring(0,5)||'',r.status,r.late_minutes||0,r.is_manual?'是':'',r.notes||'']));
                    fn = `出勤報表_${ms}.csv`;
                } else if (type === 'leave') {
                    const { data } = await sb.from('leave_requests').select('*, employees(name, employee_number, department)').order('created_at',{ascending:false}).limit(200);
                    const tm = {annual:'特休',sick:'病假',personal:'事假',compensatory:'補休'};
                    rows.push(['工號','姓名','部門','假別','開始','結束','天數','原因','狀態','拒絕原因']);
                    (data||[]).forEach(r => rows.push([r.employees?.employee_number,r.employees?.name,r.employees?.department,tm[r.leave_type]||r.leave_type,r.start_date,r.end_date,r.days||1,r.reason||'',r.status,r.rejection_reason||'']));
                    fn = `請假報表_${ms}.csv`;
                } else if (type === 'overtime') {
                    const { data } = await sb.from('overtime_requests').select('*, employees(name, employee_number, department)').order('ot_date',{ascending:false}).limit(200);
                    rows.push(['工號','姓名','部門','日期','申請h','核准h','實際h','計薪h','補償','狀態']);
                    (data||[]).forEach(r => rows.push([r.employees?.employee_number,r.employees?.name,r.employees?.department,r.ot_date,r.planned_hours,r.approved_hours||'',r.actual_hours||'',r.final_hours||'',r.compensation_type==='pay'?'加班費':'補休',r.status]));
                    fn = `加班報表_${ms}.csv`;
                } else if (type === 'lunch') {
                    const { data } = await sb.from('lunch_orders').select('*, employees(name, employee_number)').gte('order_date',ms+'-01').lte('order_date',ms+'-31').order('order_date');
                    rows.push(['日期','工號','姓名','類型','狀態','備註']);
                    (data||[]).forEach(r => rows.push([r.order_date,r.employees?.employee_number,r.employees?.name,r.is_vegetarian?'素食':'葷食',r.status==='cancelled'?'取消($50)':'已訂',r.notes||'']));
                    fn = `便當報表_${ms}.csv`;
                } else if (type === 'bonus') {
                    const { data } = await sb.from('annual_bonus').select('*, employees(name, employee_number, department)').eq('year',y);
                    rows.push(['工號','姓名','部門','年資(月)','基本獎金','調整','最終','詳細']);
                    (data||[]).forEach(r => {
                        let detail = '';
                        try { const d = JSON.parse(r.ai_recommendation); detail = `${d.performance_rating}/${d.attendance_grade} x${d.matrix_multiplier}`; } catch(e) {}
                        rows.push([r.employees?.employee_number,r.employees?.name,r.employees?.department,r.months_worked,r.base_amount,r.adjustment||0,r.final_bonus||0,detail]);
                    });
                    fn = `獎金報表_${y}.csv`;
                }
                
                if (rows.length <= 1) { showToast('⚠️ 無資料'); return; }
                const csv = '\uFEFF' + rows.map(r => r.map(c => `"${String(c??'').replace(/"/g,'""')}"`).join(',')).join('\n');
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
                a.download = fn; a.click();
                writeAuditLog('export',type,null,fn,{rows:rows.length-1});
                showToast(`✅ ${fn}（${rows.length-1} 筆）`);
            } catch(e) { showToast('❌ 匯出失敗：'+friendlyError(e)); }
        }

        // 頁面載入
        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') {
                console.error('common.js 未正確載入');
                return;
            }
            checkAdminPermission();
        });
    </script>
</body>
</html>
