<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‘‘ ç®¡ç†å¾Œå° - å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        #lcTable th, #lcTable td, #smTable th, #smTable td { border: 1px solid #F1F5F9; }
        #smTable td:hover { filter: brightness(0.92); }
        #lcTable th, #smTable th { position: sticky; top: 0; background: #fff; z-index: 1; }

        /* ===== èœå–®ç·¨è¼¯å™¨æŠ½å±œ ===== */
        .mi-drawer-mask { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.45); z-index:9000; }
        .mi-drawer { position:fixed; top:0; left:0; right:0; bottom:0; z-index:9001; max-width:520px; margin:0 auto; background:#F8FAFC; display:flex; flex-direction:column; animation:miSlideUp 0.28s ease-out; }
        @keyframes miSlideUp { from { transform:translateY(100%); } to { transform:translateY(0); } }
        .mi-drawer-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:#fff; border-bottom:1px solid #E2E8F0; flex-shrink:0; }
        .mi-drawer-body { flex:1; overflow-y:auto; padding:16px; -webkit-overflow-scrolling:touch; }
        .mi-drawer-footer { display:flex; gap:10px; padding:12px 16px; background:#fff; border-top:1px solid #E2E8F0; flex-shrink:0; }
        /* åˆ†æ®µå¡ç‰‡ */
        .mi-section { background:#fff; border-radius:14px; border:1.5px solid #E2E8F0; margin-bottom:12px; overflow:hidden; }
        .mi-section-hd { display:flex; align-items:center; justify-content:space-between; padding:13px 16px; cursor:pointer; user-select:none; }
        .mi-section-hd .title { display:flex; align-items:center; gap:8px; font-size:14px; font-weight:800; color:#0F172A; }
        .mi-section-hd .arrow { font-size:11px; color:#94A3B8; transition:transform 0.2s; }
        .mi-section-hd .arrow.open { transform:rotate(180deg); }
        .mi-section-bd { padding:16px; border-top:1px solid #F1F5F9; }
        /* è¡¨å–®æ¬„ä½ */
        .mi-field { margin-bottom:14px; }
        .mi-field label { display:block; font-size:12px; font-weight:700; color:#334155; margin-bottom:5px; }
        .mi-field label .req { color:#DC2626; }
        .mi-field .hint { font-size:11px; color:#94A3B8; margin-top:3px; }
        .mi-input { width:100%; padding:10px 12px; border:1.5px solid #E2E8F0; border-radius:10px; font-size:14px; color:#0F172A; outline:none; box-sizing:border-box; transition:border-color 0.2s; background:#fff; }
        .mi-input:focus { border-color:#4F46E5; }
        .mi-select { width:100%; padding:10px 12px; border:1.5px solid #E2E8F0; border-radius:10px; font-size:14px; color:#0F172A; background:#fff; }
        /* å“é …å¡ç‰‡ */
        .mi-card { display:flex; align-items:center; gap:12px; padding:12px; background:#fff; border-radius:14px; border:1px solid #E2E8F0; margin-bottom:8px; transition:opacity 0.2s; }
        .mi-card.sold-out { opacity:0.55; }
        .mi-card-img { width:56px; height:56px; border-radius:12px; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:24px; background:linear-gradient(135deg,#EEF2FF,#F1F5F9); border:1px solid #F1F5F9; overflow:hidden; }
        .mi-card-img img { width:100%; height:100%; object-fit:cover; }
        .mi-card-info { flex:1; min-width:0; }
        .mi-card-info .name { font-size:14px; font-weight:800; color:#0F172A; display:flex; align-items:center; gap:5px; flex-wrap:wrap; }
        .mi-card-info .meta { font-size:12px; color:#64748B; display:flex; align-items:center; gap:6px; margin-top:3px; }
        .mi-card-info .meta .price { font-weight:800; color:#4F46E5; }
        .mi-badge { padding:2px 7px; border-radius:5px; font-size:10px; font-weight:700; white-space:nowrap; }
        .mi-badge-combo { background:#FEF3C7; color:#92400E; }
        .mi-badge-sold { background:#FEE2E2; color:#DC2626; }
        .mi-badge-opt { background:#EEF2FF; color:#4F46E5; }
        /* é¸é …ç¾¤çµ„ç·¨è¼¯å™¨ */
        .og-card { border:1.5px solid #E2E8F0; border-radius:12px; padding:12px; margin-bottom:10px; background:#F8FAFC; }
        .og-header { display:flex; gap:6px; margin-bottom:10px; align-items:center; flex-wrap:wrap; }
        .og-toggle-group { display:flex; background:#F1F5F9; border-radius:8px; overflow:hidden; }
        .og-toggle { padding:5px 10px; border:none; font-size:11px; font-weight:700; cursor:pointer; }
        .og-toggle.active { background:#4F46E5; color:#fff; }
        .og-toggle:not(.active) { background:transparent; color:#64748B; }
        .og-req-btn { padding:5px 10px; border:1.5px solid #E2E8F0; border-radius:8px; font-size:11px; font-weight:700; cursor:pointer; white-space:nowrap; }
        .og-req-btn.on { border-color:#4F46E5; background:#EEF2FF; color:#4F46E5; }
        .og-req-btn.off { border-color:#E2E8F0; background:#fff; color:#94A3B8; }
        .og-del-btn { width:28px; height:28px; border:none; border-radius:8px; background:#FEE2E2; color:#DC2626; font-size:13px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .og-choice { display:flex; gap:6px; margin-bottom:6px; align-items:center; padding-left:24px; }
        .og-choice-name { flex:1; padding:7px 10px; border:1px solid #E2E8F0; border-radius:8px; font-size:12px; outline:none; background:#fff; }
        .og-price-wrap { position:relative; width:72px; }
        .og-price-wrap .prefix { position:absolute; left:8px; top:50%; transform:translateY(-50%); font-size:11px; color:#94A3B8; }
        .og-price-wrap input { width:100%; padding:7px 10px 7px 28px; border:1px solid #E2E8F0; border-radius:8px; font-size:12px; outline:none; box-sizing:border-box; background:#fff; }
        /* å®¢äººé è¦½ */
        .mi-preview { background:#F8FAFC; border-radius:16px; padding:16px; border:1.5px solid #E2E8F0; }
        .mi-preview-phone { background:#fff; border-radius:14px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,0.06); border:1px solid #F1F5F9; }
        .mi-preview-img { height:120px; background:linear-gradient(135deg,#EEF2FF,#F1F5F9); display:flex; align-items:center; justify-content:center; font-size:36px; overflow:hidden; }
        .mi-preview-img img { width:100%; height:100%; object-fit:cover; }
        .mi-preview-bd { padding:14px; }
        .mi-tpl-btn { padding:4px 12px; border:1.5px solid #E2E8F0; border-radius:8px; background:#fff; font-size:12px; font-weight:600; color:#475569; cursor:pointer; transition:all 0.15s; }
        .mi-tpl-btn:hover { border-color:#4F46E5; color:#4F46E5; }
    </style>
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <!-- æ¬Šé™æª¢æŸ¥é é¢ -->
        <div id="permissionPage" class="page active">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">ğŸ”</span>
                    <h2>ç®¡ç†å“¡æ¬Šé™æª¢æŸ¥</h2>
                    <p>æ­£åœ¨é©—è­‰æ‚¨çš„ç®¡ç†å“¡èº«ä»½...</p>
                </div>
                <div id="permissionStatus" class="status-box show info">
                    æª¢æŸ¥æ¬Šé™ä¸­...
                </div>
            </div>
        </div>

        <!-- ç®¡ç†å¾Œå°é¦–é  -->
        <div id="adminHomePage" class="page">
            <div class="user-card">
                <div id="adminCompanyName" style="font-size:13px;font-weight:700;color:#4F46E5;margin-bottom:8px;display:none;"></div>
                <div class="user-info">
                    <div class="avatar" id="adminAvatar">ğŸ‘‘</div>
                    <div class="user-details">
                        <h2 id="adminName">ç®¡ç†å“¡</h2>
                        <p id="adminDept">ç³»çµ±ç®¡ç†</p>
                        <p id="adminId" style="font-size: 11px; opacity: 0.7;">ID: -</p>
                    </div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" data-require="admin" onclick="showPage('bonusPage')">
                    <div class="icon">ğŸ</div><div class="label">å¹´çµ‚çé‡‘è©¦ç®—</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('payrollPage')">
                    <div class="icon">ğŸ’°</div><div class="label">è–ªè³‡ç™¼æ”¾</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('locationPage')">
                    <div class="icon">ğŸ“</div><div class="label">åœ°é»ç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="showPage('employeePage')">
                    <div class="icon">ğŸ‘¥</div><div class="label">å“¡å·¥ç®¡ç†</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('approvalCenterPage')">
                    <div class="icon">ğŸ“‹</div><div class="label">å¯©æ ¸ä¸­å¿ƒ</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('announcementPage')">
                    <div class="icon">ğŸ“¢</div><div class="label">å…¬å‘Šç®¡ç†</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('reportPage')">
                    <div class="icon">ğŸ“Š</div><div class="label">å ±è¡¨åŒ¯å‡º</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('staffMgrPage')">
                    <div class="icon">ğŸ“‹</div><div class="label">äººåŠ›ç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="showPage('lunchMgrPage')">
                    <div class="icon">ğŸ±</div><div class="label">ä¾¿ç•¶ç®¡ç†</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('clientPage')">
                    <div class="icon">ğŸ¢</div><div class="label">å®¢æˆ¶ç®¡ç†</div>
                </div>
                <div class="menu-item" data-require="admin" data-feature="fieldwork,sales_target" onclick="showPage('fieldSalesAdminPage')">
                    <div class="icon">ğŸ“</div><div class="label">å¤–å‹¤/æ¥­å‹™</div>
                </div>
                <div class="menu-item" data-require="admin" data-feature="store_ordering" onclick="showPage('restaurantPage')">
                    <div class="icon">ğŸ½ï¸</div><div class="label">é¤é£²æ¥­ç®¡ç†</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('insurancePage')">
                    <div class="icon">ğŸ¥</div><div class="label">å‹å¥ä¿ç´šè·</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('featurePage')">
                    <div class="icon">ğŸ›ï¸</div><div class="label">åŠŸèƒ½ç®¡ç†</div>
                </div>
                <div class="menu-item" data-require="admin" onclick="showPage('auditLogPage')">
                    <div class="icon">ğŸ“œ</div><div class="label">æ“ä½œæ—¥èªŒ</div>
                </div>
                <div class="menu-item" onclick="window.location.href='index.html'">
                    <div class="icon">ğŸ </div><div class="label">è¿”å›é¦–é </div>
                </div>
            </div>
        </div>

        <!-- å¹´çµ‚çé‡‘è©¦ç®—é é¢ (æ··åˆç²¾ç®—) -->
        <div id="bonusPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ å¹´çµ‚çé‡‘è©¦ç®—</h2>
                <div class="form-group">
                    <label>è©¦ç®—å¹´åº¦</label>
                    <select id="bonusYear" onchange="loadHybridBonusData()"></select>
                </div>

                <div id="bonusLoading" style="text-align:center;color:#666;padding:30px;display:none;">â³ è¼‰å…¥ä¸­...</div>

                <div class="lunch-summary" id="bonusSummary" style="display:none;">
                    <h3 style="margin-bottom:15px;">ğŸ“ˆ è©¦ç®—æ‘˜è¦</h3>
                    <div class="stat-row"><span>ç¬¦åˆè³‡æ ¼äººæ•¸</span><span id="eligibleCount">0</span></div>
                    <div class="stat-row"><span>ç¸½é ç®—</span><span id="totalBudget">$0</span></div>
                    <div class="stat-row"><span>å¹³å‡çé‡‘</span><span id="avgBonus">$0</span></div>
                </div>

                <div id="matrixRef" style="display:none;">
                    <div onclick="toggleMatrixRef()" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#F5F3FF;border-radius:12px;margin-bottom:10px;">
                        <span style="font-weight:700;font-size:13px;color:#4F46E5;">ğŸ“Š çé‡‘çŸ©é™£åƒè€ƒè¡¨</span>
                        <span id="matrixRefArrow" style="font-size:12px;color:#4F46E5;">â–¼</span>
                    </div>
                    <div id="matrixRefBody" style="display:none;overflow-x:auto;margin-bottom:16px;"></div>
                </div>

                <div class="form-group" id="bonusEmpSelect" style="display:none;">
                    <label>é¸æ“‡å“¡å·¥</label>
                    <select id="bonusEmpDropdown" onchange="renderSelectedBonusCard()">
                        <option value="_all">ğŸ“‹ å…¨éƒ¨å“¡å·¥ç¸½è¦½</option>
                    </select>
                </div>

                <div id="bonusList" style="margin-top:10px;"></div>

                <div id="bonusActions" style="display:none;margin-top:20px;">
                    <button class="btn btn-success" onclick="saveAllBonuses()" id="saveAllBonusBtn">ğŸ’¾ å„²å­˜å…¨éƒ¨çé‡‘</button>
                    <button class="btn btn-secondary" onclick="exportBonusCSV()" style="margin-top:8px;">ğŸ“Š åŒ¯å‡º CSV</button>
                </div>
            </div>
        </div>

        <!-- åœ°é»ç®¡ç†é é¢ -->
        <div id="locationPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“ åœ°é»ç®¡ç†</h2>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:10px;">ğŸ“ ç›®å‰æ‰“å¡åœ°é»</h3>
                    <!-- [BUG FIX] ä½¿ç”¨èˆ‡ common.js ä¸€è‡´çš„ ID -->
                    <div id="locationList">
                        <p style="color:#666;text-align:center;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <div style="margin-top: 20px; background:#fff; border-radius:16px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                    <h3 style="margin-bottom:15px;">â• æ–°å¢åœ°é»</h3>
                    <div class="form-group">
                        <label>åœ°é»åç¨±</label>
                        <!-- [BUG FIX] ä½¿ç”¨èˆ‡ common.js ä¸€è‡´çš„ ID -->
                        <input type="text" id="newLocName" placeholder="ä¾‹å¦‚ï¼šå°åŒ—åˆ†åº—">
                    </div>
                    <div class="form-group">
                        <label>æ‰“å¡åŠå¾‘ (å…¬å°º)</label>
                        <input type="number" id="newLocRadius" value="300">
                    </div>
                    <div class="form-group">
                        <label>åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="newLocLat" placeholder="ç·¯åº¦" readonly>
                            <input type="text" id="newLocLng" placeholder="ç¶“åº¦" readonly>
                        </div>
                        <button class="btn btn-primary" onclick="getCurrentGPSForSetting()" style="margin-top:10px; font-size:14px; padding:10px;">
                            ğŸ“ æŠ“å–ç›®å‰ä½ç½®
                        </button>
                    </div>
                    <button class="btn btn-success" onclick="addNewLocation()">ğŸ’¾ å„²å­˜æ–°åœ°é»</button>
                </div>
            </div>
        </div>

        <!-- å“¡å·¥ç®¡ç†é é¢ -->
        <div id="employeePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h2 style="margin:0;">ğŸ‘¥ å“¡å·¥ç®¡ç†</h2>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-success" onclick="showAddEmployeeModal()" style="font-size:13px; padding:8px 14px; width:auto; margin:0;">
                            â• æ–°å¢
                        </button>
                        <button class="btn btn-primary" onclick="showJoinQRCode()" style="font-size:13px; padding:8px 14px; width:auto; margin:0;">
                            ğŸ“± QR Code
                        </button>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom:15px;">
                    <input type="text" id="employeeSearch" placeholder="ğŸ” æœå°‹å§“åæˆ–å·¥è™Ÿ" onkeyup="searchEmployees()">
                </div>
                <div id="employeeList">
                    <p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- æ–°å¢å“¡å·¥ Modal -->
        <div id="addEmployeeModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>â• æ–°å¢å“¡å·¥</h3>
                    <button class="modal-close" onclick="closeAddEmployeeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addEmployeeForm">
                        <div class="form-group">
                            <label>å§“å *</label>
                            <input type="text" id="newEmployeeName" required placeholder="è«‹è¼¸å…¥å“¡å·¥å§“å">
                        </div>
                        <div class="form-group">
                            <label>å·¥è™Ÿ *</label>
                            <input type="text" id="newEmployeeNumber" required placeholder="ä¾‹å¦‚ï¼šE001">
                        </div>
                        <div class="form-group">
                            <label>éƒ¨é–€</label>
                            <select id="newEmployeeDepartment">
                                <option value="ç®¡ç†éƒ¨">ç®¡ç†éƒ¨</option>
                                <option value="æ¥­å‹™éƒ¨">æ¥­å‹™éƒ¨</option>
                                <option value="æŠ€è¡“éƒ¨">æŠ€è¡“éƒ¨</option>
                                <option value="äººäº‹éƒ¨">äººäº‹éƒ¨</option>
                                <option value="è²¡å‹™éƒ¨">è²¡å‹™éƒ¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è·ä½</label>
                            <input type="text" id="newEmployeePosition" placeholder="ä¾‹å¦‚ï¼šå°ˆå“¡">
                        </div>
                        <div class="form-group">
                            <label>é©—è­‰ç¢¼ *</label>
                            <input type="text" id="newEmployeeCode" required placeholder="èº«åˆ†è­‰å¾Œ4ç¢¼æˆ–è‡ªè¨‚é©—è­‰ç¢¼">
                            <small style="color:#666; font-size:12px; display:block; margin-top:5px;">
                                ğŸ’¡ å»ºè­°ä½¿ç”¨èº«åˆ†è­‰å¾Œ4ç¢¼ï¼Œå“¡å·¥ç¶å®šæ™‚éœ€è¦è¼¸å…¥æ­¤é©—è­‰ç¢¼
                            </small>
                        </div>
                        <div class="form-group">
                            <label>åˆ°è·æ—¥æœŸ</label>
                            <input type="date" id="newEmployeeHireDate">
                        </div>
                        <div class="form-group">
                            <label>åƒ±ç”¨é¡å‹</label>
                            <select id="newEmployeeType">
                                <option value="fulltime">æ­£è·</option>
                                <option value="parttime">å…¼è·</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è§’è‰²æ¬Šé™</label>
                            <select id="newEmployeeRole">
                                <option value="user">ä¸€èˆ¬å“¡å·¥</option>
                                <option value="manager">ä¸»ç®¡</option>
                                <option value="admin">ç®¡ç†å“¡</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button type="submit" class="btn btn-success" style="flex:1;">ğŸ’¾ å„²å­˜å“¡å·¥</button>
                            <button type="button" class="btn btn-secondary" onclick="closeAddEmployeeModal()" style="flex:1;">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div id="qrModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ğŸ“± å“¡å·¥åŠ å…¥ QR Code</h3>
                    <button class="modal-close" onclick="closeQRModal()">&times;</button>
                </div>
                <div class="modal-body" style="text-align:center;">
                    <div id="qrcode" style="margin:20px auto; display:inline-block;"></div>
                    <div style="margin-top:20px; padding:15px; background:#f3f4f6; border-radius:12px;">
                        <p style="margin:0; font-size:14px; color:#666;">å…¬å¸ä»£ç¢¼</p>
                        <p style="margin:5px 0; font-size:18px; font-weight:bold; color:#1f2937;">HR_SYSTEM_001</p>
                        <p style="margin:5px 0; font-size:12px; color:#9ca3af;">ç„¡æ³•æƒç¢¼æ™‚è«‹æ‰‹å‹•è¼¸å…¥æ­¤ä»£ç¢¼</p>
                    </div>
                    <div style="margin-top:15px; padding:12px; background:#fef3c7; border-radius:8px; border-left:4px solid #f59e0b; text-align:left;">
                        <p style="margin:0; font-size:13px; color:#92400e;">
                            <strong>ä½¿ç”¨èªªæ˜ï¼š</strong><br>
                            1. å“¡å·¥æƒææ­¤ QR Code<br>
                            2. è¼¸å…¥å·¥è™Ÿå’Œé©—è­‰ç¢¼<br>
                            3. å®Œæˆç¶å®šå³å¯ä½¿ç”¨ç³»çµ±
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è–ªè³‡è¨­å®š Modal -->
        <div id="salarySettingModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ğŸ’° è–ªè³‡è¨­å®š</h3>
                    <button class="modal-close" onclick="closeSalarySettingModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="salarySettingEmpName" style="font-size:15px;font-weight:800;color:#0F172A;margin-bottom:16px;text-align:center;"></div>
                    <div class="form-group">
                        <label>è¨ˆè–ªæ–¹å¼</label>
                        <select id="ssSalaryType" onchange="onSalaryTypeChange()">
                            <option value="monthly">æœˆè–ªåˆ¶</option>
                            <option value="daily">æ—¥è–ªåˆ¶</option>
                            <option value="hourly">æ™‚è–ªåˆ¶</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="ssBaseLabel">åŸºæœ¬æœˆè–ª</label>
                        <input type="text" inputmode="numeric" id="ssBaseSalary" placeholder="ä¾‹å¦‚ï¼š35,000">
                    </div>
                    <div class="form-group">
                        <label>ä¼™é£Ÿæ´¥è²¼ï¼ˆæœˆï¼‰</label>
                        <input type="text" inputmode="numeric" id="ssMealAllowance" placeholder="ä¾‹å¦‚ï¼š2,400" value="0">
                    </div>
                    <div class="form-group">
                        <label>è·å‹™åŠ çµ¦ï¼ˆæœˆï¼‰</label>
                        <input type="text" inputmode="numeric" id="ssPositionAllowance" placeholder="ä¾‹å¦‚ï¼š5,000" value="0">
                    </div>
                    <div class="form-group">
                        <label>å…¨å‹¤çé‡‘</label>
                        <input type="text" inputmode="numeric" id="ssFullAttBonus" placeholder="ä¾‹å¦‚ï¼š2,000" value="0">
                    </div>
                    <div class="form-group">
                        <label>å‹é€€è‡ªæ %</label>
                        <input type="number" id="ssPensionRate" min="0" max="6" placeholder="0~6" value="0">
                    </div>
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="saveSalarySetting()" class="btn btn-success" style="flex:1;">ğŸ’¾ å„²å­˜è–ªè³‡</button>
                        <button onclick="closeSalarySettingModal()" class="btn btn-secondary" style="flex:1;">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç·¨è¼¯å“¡å·¥ Modal -->
        <div id="editEmployeeModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>âœï¸ ç·¨è¼¯å“¡å·¥</h3>
                    <button class="modal-close" onclick="closeEditEmployeeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editEmpId">
                    <div class="form-group">
                        <label>å§“å</label>
                        <input type="text" id="editEmpName">
                    </div>
                    <div class="form-group">
                        <label>éƒ¨é–€</label>
                        <select id="editEmpDept">
                            <option value="ç®¡ç†éƒ¨">ç®¡ç†éƒ¨</option>
                            <option value="æ¥­å‹™éƒ¨">æ¥­å‹™éƒ¨</option>
                            <option value="æŠ€è¡“éƒ¨">æŠ€è¡“éƒ¨</option>
                            <option value="äººäº‹éƒ¨">äººäº‹éƒ¨</option>
                            <option value="è²¡å‹™éƒ¨">è²¡å‹™éƒ¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è·ä½</label>
                        <select id="editEmpPosition">
                            <option value="">-- é¸æ“‡è·ä½ --</option>
                            <option value="æ¥­å‹™">æ¥­å‹™</option>
                            <option value="è¡Œæ”¿">è¡Œæ”¿</option>
                            <option value="å·¥ç¨‹">å·¥ç¨‹</option>
                            <option value="ä¸»ç®¡">ä¸»ç®¡</option>
                            <option value="å€‰ç®¡">å€‰ç®¡</option>
                            <option value="å®¢æœ">å®¢æœ</option>
                            <option value="æœƒè¨ˆ">æœƒè¨ˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>åˆ°è·æ—¥æœŸ</label>
                        <input type="date" id="editEmpHireDate">
                    </div>
                    <div class="form-group">
                        <label>åƒ±ç”¨é¡å‹</label>
                        <select id="editEmpType">
                            <option value="fulltime">æ­£è·</option>
                            <option value="parttime">å…¼è·</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button onclick="saveEditEmployee()" class="btn btn-success" style="flex:1;">ğŸ’¾ å„²å­˜</button>
                        <button onclick="closeEditEmployeeModal()" class="btn btn-secondary" style="flex:1;">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è«‹å‡å¯©æ ¸é é¢ -->
        <!-- ====== å¯©æ ¸ä¸­å¿ƒï¼ˆåˆä½µï¼šè«‹å‡/è£œæ‰“å¡/åŠ ç­/æ›ç­ï¼‰ ====== -->
        <div id="approvalCenterPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“‹ å¯©æ ¸ä¸­å¿ƒ</h2>
                <!-- å¯©æ ¸é¡å‹åˆ‡æ› -->
                <div style="display:flex;gap:4px;margin-bottom:16px;background:#F1F5F9;border-radius:10px;padding:3px;">
                    <button class="aprTab aprTabActive" onclick="switchApprovalType('leave',this)" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:#fff;color:#4F46E5;box-shadow:0 1px 4px rgba(0,0,0,0.08);">âœ… è«‹å‡</button>
                    <button class="aprTab" onclick="switchApprovalType('makeup',this)" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:transparent;color:#94A3B8;">ğŸ”§ è£œæ‰“å¡</button>
                    <button class="aprTab" onclick="switchApprovalType('overtime',this)" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:transparent;color:#94A3B8;">â° åŠ ç­</button>
                    <button class="aprTab" onclick="switchApprovalType('swap',this)" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:transparent;color:#94A3B8;">ğŸ”„ æ›ç­</button>
                </div>

                <!-- è«‹å‡å¯©æ ¸ -->
                <div id="aprLeave" class="aprContent">
                    <div class="tabs" id="leaveApprovalTabs">
                        <button class="tab-btn active" onclick="switchLeaveTab('pending')">å¾…å¯©æ ¸</button>
                        <button class="tab-btn inactive" onclick="switchLeaveTab('approved')">å·²é€šé</button>
                        <button class="tab-btn inactive" onclick="switchLeaveTab('rejected')">å·²æ‹’çµ•</button>
                    </div>
                    <div id="leaveApprovalList"><p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p></div>
                </div>

                <!-- è£œæ‰“å¡å¯©æ ¸ -->
                <div id="aprMakeup" class="aprContent" style="display:none;">
                    <div class="tabs" id="makeupApprovalTabs">
                        <button class="tab-btn active" onclick="switchMakeupTab('pending')">å¾…å¯©æ ¸</button>
                        <button class="tab-btn inactive" onclick="switchMakeupTab('approved')">å·²é€šé</button>
                        <button class="tab-btn inactive" onclick="switchMakeupTab('rejected')">å·²æ‹’çµ•</button>
                    </div>
                    <div id="makeupApprovalList"><p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p></div>
                </div>

                <!-- åŠ ç­å¯©æ ¸ -->
                <div id="aprOvertime" class="aprContent" style="display:none;">
                    <div class="tabs" id="overtimeApprovalTabs">
                        <button class="tab-btn active" onclick="switchOtTab('pending')">å¾…å¯©æ ¸</button>
                        <button class="tab-btn inactive" onclick="switchOtTab('approved')">å·²é€šé</button>
                        <button class="tab-btn inactive" onclick="switchOtTab('rejected')">å·²æ‹’çµ•</button>
                    </div>
                    <div id="otApprovalList"><p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p></div>
                </div>

                <!-- æ›ç­å¯©æ ¸ -->
                <div id="aprSwap" class="aprContent" style="display:none;">
                    <p style="color:#94A3B8;font-size:12px;margin-bottom:12px;">é›™æ–¹åŒæ„å¾Œæ‰æœƒå‡ºç¾åœ¨æ­¤åˆ—è¡¨</p>
                    <div id="swapApprovalList"><p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p></div>
                </div>
            </div>
        </div>

        <!-- ====== å…¬å‘Šç®¡ç† ====== -->
        <div id="announcementPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“¢ å…¬å‘Šç®¡ç†</h2>
                <p style="color:#94A3B8;font-size:12px;margin-bottom:16px;">ç™¼å¸ƒçš„å…¬å‘Šæœƒé¡¯ç¤ºåœ¨å“¡å·¥é¦–é ä¸Šæ–¹</p>

                <!-- æ–°å¢å…¬å‘Šè¡¨å–® -->
                <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:16px;">
                    <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">â• ç™¼å¸ƒæ–°å…¬å‘Š</div>
                    <div class="form-group">
                        <label>é¡å‹</label>
                        <select id="annType">
                            <option value="info">ğŸ“¢ ä¸€èˆ¬é€šçŸ¥</option>
                            <option value="warning">âš ï¸ æ³¨æ„äº‹é …</option>
                            <option value="urgent">ğŸš¨ ç·Šæ€¥é€šçŸ¥</option>
                            <option value="event">ğŸ‰ æ´»å‹•å…¬å‘Š</option>
                        </select>
                    </div>
                    <div class="form-group"><label>æ¨™é¡Œ</label><input type="text" id="annTitle" placeholder="ä¾‹ï¼šä¸‹é€±ä¸€åœé›»é€šçŸ¥"></div>
                    <div class="form-group"><label>å…§å®¹ (é¸å¡«)</label><textarea id="annContent" placeholder="å…¬å‘Šè©³ç´°å…§å®¹..."></textarea></div>
                    <div class="form-group">
                        <label>åˆ°æœŸæ—¥ (é¸å¡«ï¼Œç•™ç©ºæ°¸ä¹…é¡¯ç¤º)</label>
                        <input type="date" id="annExpire">
                    </div>
                    <div class="form-group" style="display:flex;flex-direction:column;gap:10px;">
                        <input type="checkbox" id="annPinned" style="display:none;">
                        <div id="annPinnedCard" onclick="toggleAnnCheck('annPinned')"
                             style="display:flex;align-items:center;gap:12px;padding:14px;background:#F8FAFC;border:2px solid #E5E7EB;border-radius:12px;cursor:pointer;transition:all 0.2s;">
                            <div id="annPinnedBox" style="width:26px;height:26px;border:2px solid #CBD5E1;border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;background:#fff;font-size:16px;color:#fff;"></div>
                            <span style="font-size:14px;font-weight:600;">ğŸ“Œ ç½®é ‚</span>
                        </div>
                        <input type="checkbox" id="annRequireAck" style="display:none;">
                        <div id="annRequireAckCard" onclick="toggleAnnCheck('annRequireAck')"
                             style="display:flex;align-items:center;gap:12px;padding:14px;background:#F8FAFC;border:2px solid #E5E7EB;border-radius:12px;cursor:pointer;transition:all 0.2s;">
                            <div id="annRequireAckBox" style="width:26px;height:26px;border:2px solid #CBD5E1;border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;background:#fff;font-size:16px;color:#fff;"></div>
                            <span style="font-size:14px;font-weight:600;">âœï¸ å¼·åˆ¶é–±è®€ç°½ç½²ï¼ˆå“¡å·¥å¿…é ˆç¢ºèªæ‰èƒ½ä½¿ç”¨ç³»çµ±ï¼‰</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="publishAnnouncement()">ğŸ“¤ ç™¼å¸ƒå…¬å‘Š</button>
                </div>

                <!-- ç¾æœ‰å…¬å‘Šåˆ—è¡¨ -->
                <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">ğŸ“‹ ç¾æœ‰å…¬å‘Š</div>
                <div id="announcementList"><p style="text-align:center;color:#999;">è¼‰å…¥ä¸­...</p></div>
            </div>
        </div>


        <!-- ====== æ“ä½œæ—¥èªŒ ====== -->
        <div id="auditLogPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“œ æ“ä½œæ—¥èªŒ</h2>
                <p style="color:#94A3B8;font-size:12px;margin-bottom:12px;">ç³»çµ±è‡ªå‹•è¨˜éŒ„æ‰€æœ‰ç®¡ç†æ“ä½œ</p>
                <div id="auditLogList"><p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p></div>
                <button class="btn btn-secondary" id="loadMoreAudit" onclick="loadAuditLogs(true)" style="margin-top:12px;">è¼‰å…¥æ›´å¤š...</button>
            </div>
        </div>

        <!-- ä¾¿ç•¶ç®¡ç†é é¢ -->
        <div id="lunchMgrPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ± ä¾¿ç•¶ç®¡ç†</h2>

                <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-bottom:16px;">
                    <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:8px;">ğŸ‘©â€ğŸ’¼ ä¾¿ç•¶ç®¡ç†å“¡</div>
                    <p style="font-size:12px;color:#94A3B8;margin-bottom:12px;">æŒ‡å®šå¯æŸ¥çœ‹ä¾¿ç•¶è¨‚è³¼æ˜ç´°å ±è¡¨çš„å“¡å·¥ï¼ˆä¾‹å¦‚æœƒè¨ˆï¼‰ï¼Œè©²å“¡å·¥é€²å…¥ä¾¿ç•¶è¨‚è³¼é é¢æ™‚æœƒçœ‹åˆ°å®Œæ•´è¨‚è³¼æ˜ç´°å’Œ CSV åŒ¯å‡ºåŠŸèƒ½ã€‚</p>
                    <div style="display:flex;gap:8px;margin-bottom:12px;">
                        <select id="lunchMgrSelect" style="flex:1;padding:10px;border:1px solid #E5E7EB;border-radius:10px;font-size:13px;">
                            <option value="">-- é¸æ“‡å“¡å·¥ --</option>
                        </select>
                        <button onclick="addLunchManager()" style="padding:10px 16px;border:none;border-radius:10px;background:#4F46E5;color:#fff;font-weight:700;font-size:13px;cursor:pointer;white-space:nowrap;">+ æ–°å¢</button>
                    </div>
                    <div id="lunchMgrList" style="font-size:13px;color:#64748B;">è¼‰å…¥ä¸­...</div>
                </div>

                <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-bottom:16px;">
                    <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">ğŸ“Š ä»Šæ—¥ä¾¿ç•¶çµ±è¨ˆ</div>
                    <div id="adminLunchStats" style="font-size:13px;color:#64748B;">è¼‰å…¥ä¸­...</div>
                </div>

                <div style="background:#FFF7ED;border-radius:14px;padding:14px;">
                    <div style="font-size:13px;color:#EA580C;line-height:1.6;">
                        <b>ğŸ’¡ èªªæ˜</b><br>
                        â€¢ è¢«æŒ‡å®šçš„ä¾¿ç•¶ç®¡ç†å“¡é€²å…¥ã€Œä¾¿ç•¶è¨‚è³¼ã€é é¢å¾Œï¼Œæœƒè‡ªå‹•çœ‹åˆ°è¨‚è³¼æ˜ç´°å ±è¡¨<br>
                        â€¢ å ±è¡¨åŒ…å«ï¼šçµ±è¨ˆæ•¸å­—ã€å“¡å·¥è¨‚è³¼æ˜ç´°ã€CSV åŒ¯å‡º<br>
                        â€¢ ç®¡ç†è€…ï¼ˆadminï¼‰é€²å…¥ä¾¿ç•¶é é¢ä¹Ÿæœƒè‡ªå‹•çœ‹åˆ°å ±è¡¨
                    </div>
                </div>
            </div>
        </div>

        <!-- ====== è–ªè³‡ç™¼æ”¾é é¢ ====== -->
        <div id="payrollPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ’° è–ªè³‡ç™¼æ”¾</h2>

                <!-- è–ªè³‡è¨­å®šå¿«æ·å…¥å£ -->
                <div style="margin-bottom:14px;">
                    <div onclick="toggleSalarySettingPanel()" style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#F0FDF4;border:1px solid #BBF7D0;border-radius:12px;">
                        <span style="font-weight:700;font-size:13px;color:#059669;">ğŸ“‹ å“¡å·¥è–ªè³‡è¨­å®š</span>
                        <span id="salaryPanelArrow" style="font-size:12px;color:#059669;">â–¼</span>
                    </div>
                    <div id="salarySettingPanel" style="display:none;margin-top:8px;background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:12px;max-height:400px;overflow-y:auto;">
                        <div id="salarySettingList" style="font-size:13px;">
                            <p style="text-align:center;color:#94A3B8;">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>

                <!-- æœˆä»½é¸æ“‡ + è¨ˆç®—æŒ‰éˆ• -->
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:16px;">
                    <select id="payrollYear" style="flex:1;padding:10px;border:1px solid #E5E7EB;border-radius:10px;font-size:13px;font-weight:700;"></select>
                    <select id="payrollMonth" style="flex:1;padding:10px;border:1px solid #E5E7EB;border-radius:10px;font-size:13px;font-weight:700;"></select>
                    <button id="calcPayrollBtn" onclick="loadPayrollData()" style="padding:10px 16px;border:none;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:13px;cursor:pointer;white-space:nowrap;">ğŸ“Š è¨ˆç®—è–ªè³‡</button>
                </div>

                <!-- Loading -->
                <div id="payrollLoading" style="display:none;text-align:center;padding:40px;color:#94A3B8;">
                    <div style="font-size:32px;margin-bottom:8px;">â³</div>
                    <div style="font-size:14px;">æ­£åœ¨è¨ˆç®—å…¨å“¡è–ªè³‡...</div>
                </div>

                <!-- å·²ç™¼å¸ƒè­¦å‘Š -->
                <div id="payrollPublishedWarn" style="display:none;background:#FEF3C7;border:1px solid #F59E0B;border-radius:12px;padding:12px;margin-bottom:12px;font-size:13px;color:#92400E;">
                    âš ï¸ æ­¤æœˆä»½è–ªè³‡å·²ç™¼å¸ƒï¼Œé‡æ–°è¨ˆç®—å°‡è¦†è“‹ç¾æœ‰è³‡æ–™
                </div>

                <!-- æ‘˜è¦å¡ç‰‡ -->
                <div id="payrollSummary" style="display:none;background:linear-gradient(135deg,#4F46E5,#7C3AED);border-radius:16px;padding:20px;color:#fff;margin-bottom:16px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <div style="text-align:center;">
                            <div style="font-size:11px;opacity:0.8;">è¨ˆç®—äººæ•¸</div>
                            <div id="prEmpCount" style="font-size:22px;font-weight:900;">0</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:11px;opacity:0.8;">è–ªè³‡ç¸½é¡</div>
                            <div id="prTotalNet" style="font-size:22px;font-weight:900;">$0</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:11px;opacity:0.8;">å¹³å‡å¯¦ç™¼</div>
                            <div id="prAvgNet" style="font-size:22px;font-weight:900;">$0</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:11px;opacity:0.8;">ç‹€æ…‹</div>
                            <div id="prStatus" style="font-size:16px;font-weight:900;">è‰ç¨¿</div>
                        </div>
                    </div>
                </div>

                <!-- å“¡å·¥é¸æ“‡ -->
                <div id="payrollEmpSelector" style="display:none;margin-bottom:12px;">
                    <select id="payrollEmpDropdown" onchange="renderPayrollView()" style="width:100%;padding:12px;border:1px solid #E5E7EB;border-radius:12px;font-size:13px;font-weight:700;">
                        <option value="_all">ğŸ“‹ å…¨éƒ¨å“¡å·¥ç¸½è¦½</option>
                    </select>
                </div>

                <!-- å…§å®¹å€ -->
                <div id="payrollContent" style="margin-bottom:16px;"></div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div id="payrollActions" style="display:none;flex-direction:column;gap:10px;">
                    <button id="savePayrollBtn" onclick="saveAllPayroll()" style="width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#059669,#10B981);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ’¾ å„²å­˜å…¨éƒ¨ï¼ˆè‰ç¨¿ï¼‰</button>
                    <button id="publishPayrollBtn" onclick="publishPayroll()" style="width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#DC2626,#EF4444);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ“¢ ç™¼å¸ƒè–ªè³‡ï¼ˆå“¡å·¥å¯è¦‹ï¼‰</button>
                    <button onclick="exportPayrollCSV()" style="width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#0EA5E9,#38BDF8);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ“¥ åŒ¯å‡º CSV</button>
                </div>
            </div>
        </div>

        <!-- å ±è¡¨åŒ¯å‡ºé é¢ -->
        <div id="reportPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“Š å ±è¡¨åŒ¯å‡º</h2>
                <div class="menu-grid">
                    <div class="menu-item" onclick="exportReport('attendance')">
                        <div class="icon">ğŸ“ˆ</div><div class="label">å‡ºå‹¤å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('leave')">
                        <div class="icon">ğŸ“</div><div class="label">è«‹å‡å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('bonus')">
                        <div class="icon">ğŸ</div><div class="label">çé‡‘å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('lunch')">
                        <div class="icon">ğŸ±</div><div class="label">ä¾¿ç•¶å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('overtime')">
                        <div class="icon">â°</div><div class="label">åŠ ç­å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('payroll')">
                        <div class="icon">ğŸ’°</div><div class="label">è–ªè³‡å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="showPage('fieldSalesAdminPage')">
                        <div class="icon">ğŸ“</div><div class="label">å¤–å‹¤å ±è¡¨</div>
                    </div>
                    <div class="menu-item" data-feature="store_ordering" onclick="exportReport('orders')">
                        <div class="icon">ğŸ½ï¸</div><div class="label">è¨‚å–®å ±è¡¨</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½ç®¡ç†é é¢ -->
        <div id="featurePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ›ï¸ åŠŸèƒ½ç®¡ç†</h2>
                <p style="color:#6b7280;font-size:13px;margin-bottom:16px;">æ§åˆ¶å“¡å·¥é¦–é <b>ä¸­é–“é¸å–®</b>é¡¯ç¤ºå“ªäº›åŠŸèƒ½</p>
                
                <div id="featureToggles" style="display:flex;flex-direction:column;gap:12px;">
                    <p id="featureLoadingHint" style="text-align:center;color:#94A3B8;font-size:13px;">è¼‰å…¥ä¸­...</p>
                </div>
                <div id="featureSaveStatus" style="margin-top:12px;text-align:center;font-size:13px;color:#059669;display:none;">âœ… å·²å„²å­˜</div>
                <p style="color:#94A3B8;font-size:12px;margin-top:16px;text-align:center;">ğŸ’¡ åº•éƒ¨å°èˆªåˆ—ï¼ˆé¦–é /ç­è¡¨/æ‰“å¡/è–ªè³‡/ç®¡ç†ï¼‰ç‚ºç®¡ç†å“¡å°ˆå±¬ï¼Œä¸å—æ­¤è¨­å®šå½±éŸ¿</p>

                <!-- LINE Notify è¨­å®š -->
                <div style="margin-top:30px;padding-top:20px;border-top:2px dashed #e5e7eb;">
                    <h3 style="margin-bottom:12px;">ğŸ”” LINE Notify æ¨æ’­è¨­å®š</h3>
                    <p style="color:#94A3B8;font-size:12px;margin-bottom:12px;">è¨­å®šå¾Œï¼Œè«‹å‡/è£œæ‰“å¡ç”³è«‹æœƒè‡ªå‹•æ¨æ’­é€šçŸ¥ç®¡ç†å“¡ç¾¤çµ„</p>
                    <div class="form-group">
                        <label>LINE Notify Token</label>
                        <input type="text" id="lineNotifyToken" placeholder="è«‹è²¼ä¸Š LINE Notify Token">
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-primary" onclick="saveNotifyToken()" style="flex:1;">ğŸ’¾ å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="testNotify()" style="flex:1;">ğŸ”” æ¸¬è©¦æ¨æ’­</button>
                    </div>
                    <div id="notifyStatus" style="margin-top:8px;text-align:center;font-size:13px;display:none;"></div>
                    <div style="margin-top:12px;padding:10px;background:#FFF7ED;border-radius:10px;font-size:11px;color:#EA580C;line-height:1.6;">
                        ğŸ“Œ å¦‚ä½•å–å¾— Tokenï¼š<br>
                        1. å‰å¾€ <b>notify-bot.line.me</b><br>
                        2. ç™»å…¥ â†’ ç™¼è¡Œæ¬Šæ–<br>
                        3. é¸æ“‡è¦æ¥æ”¶é€šçŸ¥çš„ç¾¤çµ„<br>
                        4. è¤‡è£½ Token è²¼åˆ°ä¸Šæ–¹
                    </div>
                </div>
            </div>
        </div>

        <!-- ====== äººåŠ›ç®¡ç†ï¼ˆæ’ç­ + ä¼‘å‡ + è¨­å®šï¼‰ ====== -->
        <div id="staffMgrPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“‹ äººåŠ›ç®¡ç†</h2>

                <!-- ä¸‰é ç±¤ -->
                <div style="display:flex;gap:4px;margin-bottom:16px;background:#F1F5F9;border-radius:10px;padding:3px;">
                    <button class="smTab" onclick="switchStaffTab('shift')" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:#fff;color:#4F46E5;box-shadow:0 1px 4px rgba(0,0,0,0.08);">ğŸ“‹ æ’ç­è¡¨</button>
                    <button class="smTab" onclick="switchStaffTab('leave')" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:transparent;color:#94A3B8;">ğŸ—“ï¸ ä¼‘å‡æœˆè¡¨</button>
                    <button class="smTab" onclick="switchStaffTab('setting')" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:transparent;color:#94A3B8;">âš™ï¸ äººåŠ›è¨­å®š</button>
                </div>

                <!-- === æ’ç­è¡¨ TAB === -->
                <div id="tabShift" class="staffTabContent">
                    <p style="color:#6b7280;font-size:12px;margin-bottom:12px;">é»æ“Šæ ¼å­åˆ‡æ›ç­åˆ¥ï¼Œæ’å¥½å¾ŒæŒ‰å„²å­˜</p>
                    <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:12px;">
                        <button onclick="changeShiftWeek(-1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">â—€</button>
                        <span id="smWeekLabel" style="font-size:14px;font-weight:700;min-width:180px;text-align:center;">-</span>
                        <button onclick="changeShiftWeek(1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">â–¶</button>
                        <button onclick="resetShiftWeek()" style="padding:4px 10px;border:1px solid #E5E7EB;border-radius:6px;background:#fff;font-size:11px;font-weight:700;color:#4F46E5;cursor:pointer;">æœ¬é€±</button>
                    </div>
                    <div style="display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap;justify-content:center;">
                        <span style="font-size:10px;padding:3px 8px;background:#DBEAFE;color:#1E40AF;border-radius:6px;font-weight:700;">â˜€ï¸æ—©</span>
                        <span style="font-size:10px;padding:3px 8px;background:#FEF3C7;color:#92400E;border-radius:6px;font-weight:700;">ğŸŒ¤ï¸ä¸­</span>
                        <span style="font-size:10px;padding:3px 8px;background:#EDE9FE;color:#6D28D9;border-radius:6px;font-weight:700;">ğŸŒ™æ™š</span>
                        <span style="font-size:10px;padding:3px 8px;background:#ECFDF5;color:#059669;border-radius:6px;font-weight:700;">ğŸ–ï¸ä¼‘</span>
                        <span style="font-size:10px;padding:3px 8px;background:#F1F5F9;color:#64748B;border-radius:6px;font-weight:700;">â¬œæœªæ’</span>
                    </div>
                    <!-- äººåŠ›ä¸è¶³è­¦å‘Š -->
                    <div id="shiftStaffWarn" style="display:none;padding:10px 14px;background:#FEF2F2;border-radius:10px;margin-bottom:12px;font-size:12px;color:#DC2626;font-weight:700;"></div>
                    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
                        <table id="smTable" style="width:100%;border-collapse:collapse;font-size:12px;min-width:500px;"><thead id="smHead"></thead><tbody id="smBody"></tbody></table>
                    </div>
                    <!-- æ¯æ—¥äººåŠ›çµ±è¨ˆ -->
                    <div id="shiftDaySummary" style="display:flex;gap:4px;margin-top:10px;overflow-x:auto;padding-bottom:4px;"></div>
                    <div style="margin-top:14px;display:flex;gap:8px;">
                        <button onclick="saveSchedule()" style="flex:1;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ’¾ å„²å­˜æ’ç­</button>
                        <button onclick="copyLastWeek()" style="padding:14px 20px;border:2px solid #E5E7EB;border-radius:12px;background:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ“‹ è¤‡è£½ä¸Šé€±</button>
                    </div>
                    <div id="smSaveStatus" style="margin-top:10px;text-align:center;font-size:13px;display:none;"></div>
                </div>

                <!-- === ä¼‘å‡æœˆè¡¨ TAB === -->
                <div id="tabLeave" class="staffTabContent" style="display:none;">
                    <p style="color:#6b7280;font-size:12px;margin-bottom:12px;">ä¸€è¦½å…¨å“¡ä¼‘å‡ç‹€æ…‹ï¼Œæ–¹ä¾¿å®‰æ’å·¥ä½œ</p>
                    <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:12px;">
                        <button onclick="changeLeaveCal(-1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">â—€</button>
                        <span id="lcMonthLabel" style="font-size:14px;font-weight:700;min-width:120px;text-align:center;">-</span>
                        <button onclick="changeLeaveCal(1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">â–¶</button>
                        <button onclick="resetLeaveCal()" style="padding:4px 10px;border:1px solid #E5E7EB;border-radius:6px;background:#fff;font-size:11px;font-weight:700;color:#4F46E5;cursor:pointer;">æœ¬æœˆ</button>
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:12px;">
                        <div style="flex:1;text-align:center;padding:10px;background:#EFF6FF;border-radius:12px;">
                            <div style="font-size:20px;font-weight:900;color:#2563EB;" id="lcTotal">0</div>
                            <div style="font-size:10px;font-weight:600;color:#2563EB;">ç¸½è«‹å‡äººæ¬¡</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:10px;background:#ECFDF5;border-radius:12px;">
                            <div style="font-size:20px;font-weight:900;color:#059669;" id="lcAvail">0</div>
                            <div style="font-size:10px;font-weight:600;color:#059669;">ä»Šæ—¥å¯ç”¨äººåŠ›</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:10px;background:#FEF2F2;border-radius:12px;">
                            <div style="font-size:20px;font-weight:900;color:#DC2626;" id="lcMax">0</div>
                            <div style="font-size:10px;font-weight:600;color:#DC2626;">ä¸Šé™</div>
                        </div>
                    </div>
                    <!-- æ—¥æœŸæœ‰è¶…éä¸Šé™çš„é«˜äº® -->
                    <div id="lcOverWarn" style="display:none;padding:10px 14px;background:#FEF2F2;border-radius:10px;margin-bottom:12px;font-size:12px;color:#DC2626;font-weight:700;"></div>
                    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
                        <table id="lcTable" style="width:100%;border-collapse:collapse;font-size:11px;min-width:600px;"><thead id="lcHead"></thead><tbody id="lcBody"></tbody></table>
                    </div>
                    <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap;">
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#DBEAFE;border-radius:3px;display:inline-block;"></span>ç‰¹ä¼‘</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FEE2E2;border-radius:3px;display:inline-block;"></span>ç—…å‡</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FEF3C7;border-radius:3px;display:inline-block;"></span>äº‹å‡</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#E0E7FF;border-radius:3px;display:inline-block;"></span>è£œä¼‘</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FCA5A5;border-radius:3px;display:inline-block;border:2px solid #DC2626;"></span>è¶…é™</span>
                    </div>
                </div>

                <!-- === äººåŠ›è¨­å®š TAB === -->
                <div id="tabSetting" class="staffTabContent" style="display:none;">
                    <p style="color:#6b7280;font-size:12px;margin-bottom:16px;">è¨­å®šè«‹å‡é™åˆ¶èˆ‡äººåŠ›è¦å‰‡</p>

                    <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-bottom:16px;">
                        <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">ğŸš« åŒæ™‚è«‹å‡äººæ•¸ä¸Šé™</div>
                        <p style="font-size:12px;color:#94A3B8;margin-bottom:12px;">ç•¶æŸå¤©å·²æœ‰ N äººè«‹å‡ï¼Œç¬¬ N+1 äººæäº¤ç”³è«‹æ™‚æœƒè¢«<b style="color:#DC2626;">è‡ªå‹•é§å›</b></p>
                        <div style="display:flex;align-items:center;gap:12px;">
                            <button onclick="adjustMaxLeave(-1)" style="width:44px;height:44px;border:2px solid #E5E7EB;border-radius:12px;background:#fff;font-size:20px;cursor:pointer;font-weight:700;">âˆ’</button>
                            <div style="flex:1;text-align:center;">
                                <div id="maxLeaveNum" style="font-size:36px;font-weight:900;color:#4F46E5;">2</div>
                                <div style="font-size:11px;color:#94A3B8;">äºº</div>
                            </div>
                            <button onclick="adjustMaxLeave(1)" style="width:44px;height:44px;border:2px solid #E5E7EB;border-radius:12px;background:#fff;font-size:20px;cursor:pointer;font-weight:700;">+</button>
                        </div>
                        <button onclick="saveMaxLeave()" style="width:100%;margin-top:14px;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ’¾ å„²å­˜è¨­å®š</button>
                        <div id="maxLeaveSaveStatus" style="margin-top:8px;text-align:center;font-size:13px;display:none;"></div>
                    </div>

                    <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-bottom:16px;">
                        <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">ğŸ¢ æ’ç­æ¨¡å¼</div>
                        <p style="font-size:12px;color:#94A3B8;margin-bottom:12px;">é¸æ“‡å…¬å¸çš„ç­åˆ¥åˆ¶åº¦ï¼Œå½±éŸ¿æ’ç­è¡¨èˆ‡å“¡å·¥ç­è¡¨é é¢</p>
                        <div style="display:flex;gap:8px;margin-bottom:12px;">
                            <div id="modeShift" onclick="selectSchedulingMode('shift')" style="flex:1;padding:14px 12px;border:2px solid #4F46E5;border-radius:12px;cursor:pointer;text-align:center;background:#EEF2FF;transition:all 0.2s;">
                                <div style="font-size:24px;margin-bottom:6px;">ğŸ”„</div>
                                <div id="modeShiftLabel" style="font-size:13px;font-weight:800;color:#4F46E5;">æ’ç­åˆ¶</div>
                                <div style="font-size:10px;color:#94A3B8;margin-top:4px;">æœå‹™æ¥­ã€é¤é£²ã€é›¶å”®<br>æ—©/ä¸­/æ™šè¼ªç­</div>
                            </div>
                            <div id="modeFixed" onclick="selectSchedulingMode('fixed')" style="flex:1;padding:14px 12px;border:2px solid #E5E7EB;border-radius:12px;cursor:pointer;text-align:center;background:#fff;transition:all 0.2s;">
                                <div style="font-size:24px;margin-bottom:6px;">â˜€ï¸</div>
                                <div id="modeFixedLabel" style="font-size:13px;font-weight:800;color:#94A3B8;">å›ºå®šç­</div>
                                <div style="font-size:10px;color:#94A3B8;margin-top:4px;">å›ºå®šæ™‚æ®µä¸Šç­<br>å¯è‡ªè¨‚æ™‚é–“</div>
                            </div>
                        </div>
                        <!-- å›ºå®šç­è¨­å®šï¼ˆé¸æ“‡å›ºå®šç­æ™‚é¡¯ç¤ºï¼‰ -->
                        <div id="fixedShiftConfig" style="display:none;margin-bottom:12px;">
                            <div style="font-size:12px;font-weight:700;color:#4b5563;margin-bottom:8px;">å›ºå®šç­åˆ¥è¨­å®š</div>
                            <div style="display:flex;gap:6px;margin-bottom:10px;">
                                <button onclick="setFixedPreset('08:00','17:00')" class="fixedPresetBtn" style="flex:1;padding:8px;border:1px solid #E5E7EB;border-radius:8px;background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:#4F46E5;">â˜€ï¸ æ—©ç­</button>
                                <button onclick="setFixedPreset('13:00','22:00')" class="fixedPresetBtn" style="flex:1;padding:8px;border:1px solid #E5E7EB;border-radius:8px;background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:#F59E0B;">ğŸŒ¤ï¸ ä¸­ç­</button>
                                <button onclick="setFixedPreset('22:00','07:00')" class="fixedPresetBtn" style="flex:1;padding:8px;border:1px solid #E5E7EB;border-radius:8px;background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:#8B5CF6;">ğŸŒ™ æ™šç­</button>
                            </div>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <div style="flex:1;">
                                    <label style="font-size:11px;color:#94A3B8;display:block;margin-bottom:4px;">ä¸Šç­æ™‚é–“</label>
                                    <input type="time" id="fixedStartTime" value="08:00" style="width:100%;padding:10px;border:1px solid #E5E7EB;border-radius:8px;font-size:14px;font-weight:700;">
                                </div>
                                <span style="margin-top:16px;font-weight:700;color:#94A3B8;">~</span>
                                <div style="flex:1;">
                                    <label style="font-size:11px;color:#94A3B8;display:block;margin-bottom:4px;">ä¸‹ç­æ™‚é–“</label>
                                    <input type="time" id="fixedEndTime" value="17:00" style="width:100%;padding:10px;border:1px solid #E5E7EB;border-radius:8px;font-size:14px;font-weight:700;">
                                </div>
                            </div>
                        </div>
                        <button onclick="saveSchedulingMode()" style="width:100%;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ’¾ å„²å­˜æ’ç­æ¨¡å¼</button>
                        <div id="schedModeSaveStatus" style="margin-top:8px;text-align:center;font-size:13px;display:none;"></div>
                    </div>

                    <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-top:16px;">
                        <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">ğŸ“Š ç›®å‰äººåŠ›æ¦‚æ³</div>
                        <div id="staffOverview" style="font-size:13px;color:#64748B;line-height:1.8;">è¼‰å…¥ä¸­...</div>
                    </div>

                    <div style="background:#FFF7ED;border-radius:14px;padding:14px;margin-top:16px;">
                        <div style="font-size:13px;color:#EA580C;line-height:1.6;">
                            <b>ğŸ’¡ è‡ªå‹•é§å›è¦å‰‡èªªæ˜</b><br>
                            â€¢ å“¡å·¥å¡«å…¥è«‹å‡æ—¥æœŸæ™‚ï¼Œç³»çµ±<b>å³æ™‚æª¢æŸ¥</b>è©²æ—¥å·²æœ‰å¹¾äººè«‹å‡<br>
                            â€¢ è‹¥åŠ ä¸Šç”³è«‹è€…æœƒè¶…éä¸Šé™ï¼Œ<b>è¡¨å–®ç›´æ¥é–å®š</b>ç„¡æ³•æäº¤<br>
                            â€¢ å·²æ ¸å‡† + å¾…å¯©æ ¸ çš„å‡éƒ½æœƒè¢«è¨ˆå…¥<br>
                            â€¢ é€±æœ«ä¸è¨ˆå…¥è¡çªæª¢æŸ¥
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- å®¢æˆ¶ç®¡ç†é é¢ -->
        <div id="clientPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ¢ å®¢æˆ¶ç®¡ç†</h2>

                <div style="display:flex;gap:8px;margin-bottom:12px;">
                    <input type="text" id="clientSearch" placeholder="æœå°‹å…¬å¸åç¨±..." oninput="filterClients()" style="flex:1;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                    <button class="btn btn-primary" onclick="showClientModal()" style="white-space:nowrap;font-size:13px;padding:10px 16px;">+ æ–°å¢</button>
                </div>

                <div id="clientList">
                    <p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">è¼‰å…¥ä¸­...</p>
                </div>

                <!-- æœå‹™é …ç›®ç®¡ç† -->
                <div class="lunch-summary" style="margin-top:20px;">
                    <h3 style="margin-bottom:10px;">ğŸ”§ æœå‹™é …ç›®ç®¡ç†</h3>
                    <div id="serviceItemList"></div>
                    <div style="display:flex;gap:8px;margin-top:10px;">
                        <input type="text" id="newServiceItemName" placeholder="æ–°å¢æœå‹™é …ç›®åç¨±" style="flex:1;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:13px;">
                        <button class="btn btn-success" onclick="addServiceItem()" style="font-size:12px;padding:8px 14px;white-space:nowrap;">æ–°å¢</button>
                    </div>
                </div>
            </div>

            <!-- å®¢æˆ¶æ–°å¢/ç·¨è¼¯ Modal -->
            <div id="clientModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999;overflow-y:auto;">
                <div style="background:#fff;margin:40px auto;max-width:500px;border-radius:16px;padding:24px;">
                    <h3 id="clientModalTitle" style="margin-bottom:16px;">æ–°å¢å®¢æˆ¶</h3>
                    <input type="hidden" id="clientEditId">
                    <div class="form-group"><label>å…¬å¸åç¨± *</label><input type="text" id="clientCompanyName" placeholder="å…¬å¸åç¨±"></div>
                    <div class="form-group"><label>è¯çµ¡äºº</label><input type="text" id="clientContactName" placeholder="è¯çµ¡äººå§“å"></div>
                    <div class="form-group"><label>é›»è©±</label><input type="text" id="clientPhone" placeholder="é›»è©±"></div>
                    <div class="form-group"><label>åœ°å€</label><input type="text" id="clientAddress" placeholder="åœ°å€"></div>
                    <div class="form-group">
                        <label>GPS åº§æ¨™</label>
                        <div style="display:flex;gap:8px;">
                            <input type="text" id="clientLat" placeholder="ç·¯åº¦" style="flex:1;">
                            <input type="text" id="clientLng" placeholder="ç¶“åº¦" style="flex:1;">
                        </div>
                        <button class="btn btn-secondary" onclick="getClientGPS()" style="margin-top:6px;font-size:12px;padding:8px;">ğŸ“ æŠ“å–ç›®å‰ä½ç½®</button>
                    </div>
                    <div class="form-group">
                        <label>åˆ†é¡</label>
                        <select id="clientCategory" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                            <option value="general">ä¸€èˆ¬</option>
                            <option value="vip">VIP â­</option>
                        </select>
                    </div>
                    <div class="form-group"><label>ç”¢æ¥­åˆ¥</label><input type="text" id="clientIndustry" placeholder="ä¾‹ï¼šç§‘æŠ€æ¥­ã€è£½é€ æ¥­"></div>
                    <div class="form-group"><label>å‚™è¨»</label><textarea id="clientNotes" rows="2" placeholder="å‚™è¨»" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;resize:vertical;box-sizing:border-box;"></textarea></div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-success" onclick="saveClient()" style="flex:1;">ğŸ’¾ å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="closeClientModal()" style="flex:1;">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å‹å¥ä¿ç´šè·ç®¡ç†é é¢ -->
        <div id="insurancePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ¥ å‹å¥ä¿ç´šè·ç®¡ç†</h2>

                <div class="lunch-summary" id="insRateSummary">
                    <h3 style="margin-bottom:10px;">âš™ï¸ è²»ç‡è¨­å®š</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <div class="form-group" style="margin:0;"><label style="font-size:12px;">å‹ä¿è²»ç‡ %</label><input type="number" id="insLaborRate" step="0.01" value="12.50" style="padding:8px;font-size:13px;"></div>
                        <div class="form-group" style="margin:0;"><label style="font-size:12px;">å‹ä¿å“¡å·¥è² æ“”æ¯” %</label><input type="number" id="insLaborShare" step="0.01" value="20.00" style="padding:8px;font-size:13px;"></div>
                        <div class="form-group" style="margin:0;"><label style="font-size:12px;">å¥ä¿è²»ç‡ %</label><input type="number" id="insHealthRate" step="0.01" value="5.17" style="padding:8px;font-size:13px;"></div>
                        <div class="form-group" style="margin:0;"><label style="font-size:12px;">å¥ä¿å“¡å·¥è² æ“”æ¯” %</label><input type="number" id="insHealthShare" step="0.01" value="30.00" style="padding:8px;font-size:13px;"></div>
                    </div>
                    <button class="btn btn-primary" onclick="updateAllInsRates()" style="margin-top:10px;font-size:13px;">ğŸ“ å¥—ç”¨è²»ç‡åˆ°æ‰€æœ‰ç´šè·</button>
                </div>

                <div style="display:flex;justify-content:space-between;align-items:center;margin:16px 0 8px;">
                    <span style="font-size:14px;font-weight:700;">ğŸ“‹ ç´šè·è¡¨ï¼ˆå…± <span id="insCount">0</span> ç­†ï¼‰</span>
                    <button class="btn btn-success" onclick="showInsModal()" style="font-size:12px;padding:8px 14px;width:auto;">+ æ–°å¢</button>
                </div>

                <div style="overflow-x:auto;border-radius:12px;border:1px solid #E2E8F0;">
                    <table style="width:100%;border-collapse:collapse;font-size:12px;" id="insTable">
                        <thead>
                            <tr style="background:#F8FAFC;">
                                <th style="padding:8px 6px;text-align:right;white-space:nowrap;">è–ªè³‡ä¸‹é™</th>
                                <th style="padding:8px 6px;text-align:right;white-space:nowrap;">è–ªè³‡ä¸Šé™</th>
                                <th style="padding:8px 6px;text-align:right;white-space:nowrap;">æŠ•ä¿é‡‘é¡</th>
                                <th style="padding:8px 6px;text-align:center;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="insTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- æ–°å¢/ç·¨è¼¯ç´šè· Modal -->
            <div id="insModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999;overflow-y:auto;">
                <div style="background:#fff;margin:60px auto;max-width:400px;border-radius:16px;padding:24px;">
                    <h3 id="insModalTitle" style="margin-bottom:16px;">æ–°å¢ç´šè·</h3>
                    <input type="hidden" id="insEditId">
                    <div class="form-group"><label>è–ªè³‡ä¸‹é™ *</label><input type="number" id="insSalaryMin" placeholder="0"></div>
                    <div class="form-group"><label>è–ªè³‡ä¸Šé™ *</label><input type="number" id="insSalaryMax" placeholder="27470"></div>
                    <div class="form-group"><label>æŠ•ä¿é‡‘é¡ *</label><input type="number" id="insAmount" placeholder="27470"></div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-success" onclick="saveInsBracket()" style="flex:1;">ğŸ’¾ å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="closeInsModal()" style="flex:1;">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ====== å¤–å‹¤/æ¥­å‹™ åˆä½µç®¡ç†é  ====== -->
        <div id="fieldSalesAdminPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“ å¤–å‹¤/æ¥­å‹™</h2>
                <!-- Tab åˆ‡æ› -->
                <div style="display:flex;gap:4px;margin-bottom:16px;background:#F1F5F9;border-radius:10px;padding:3px;">
                    <button class="fsaTab" onclick="switchFieldSalesAdmin('approval',this)" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:13px;background:#fff;color:#4F46E5;box-shadow:0 1px 4px rgba(0,0,0,0.08);">ğŸ“‹ å¤–å‹¤å¯©æ ¸</button>
                    <button class="fsaTab" onclick="switchFieldSalesAdmin('target',this)" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:13px;background:transparent;color:#94A3B8;">ğŸ¯ æ¥­å‹™ç›®æ¨™</button>
                </div>

                <!-- å¤–å‹¤å¯©æ ¸ Tab -->
                <div id="fsaApprovalTab">
                    <!-- ç¯©é¸ -->
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                        <input type="date" id="fwaDateFrom" style="flex:1;min-width:120px;padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;">
                        <input type="date" id="fwaDateTo" style="flex:1;min-width:120px;padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;">
                        <select id="fwaStatusFilter" style="padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;">
                            <option value="submitted">å¾…å¯©æ ¸</option>
                            <option value="approved">å·²æ ¸å‡†</option>
                            <option value="rejected">å·²é€€å›</option>
                            <option value="">å…¨éƒ¨</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadFieldWorkApprovals()" style="font-size:12px;padding:8px 14px;">æŸ¥è©¢</button>
                    </div>

                    <!-- çµ±è¨ˆ -->
                    <div style="display:flex;gap:8px;margin-bottom:12px;">
                        <div style="flex:1;text-align:center;padding:8px;background:#DBEAFE;border-radius:8px;">
                            <div style="font-size:18px;font-weight:900;color:#1E40AF;" id="fwaTotal">0</div>
                            <div style="font-size:10px;color:#1E40AF;">ç¸½ç­†æ•¸</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:8px;background:#FEF3C7;border-radius:8px;">
                            <div style="font-size:18px;font-weight:900;color:#92400E;" id="fwaPending">0</div>
                            <div style="font-size:10px;color:#92400E;">å¾…å¯©æ ¸</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:8px;background:#D1FAE5;border-radius:8px;">
                            <div style="font-size:18px;font-weight:900;color:#059669;" id="fwaTotalHours">0</div>
                            <div style="font-size:10px;color:#059669;">ç¸½å·¥æ™‚(h)</div>
                        </div>
                    </div>

                    <div id="fwaList">
                        <p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">è«‹é¸æ“‡æ—¥æœŸæŸ¥è©¢</p>
                    </div>

                    <button class="btn btn-secondary" onclick="exportFieldWorkCSV()" style="width:100%;margin-top:12px;font-size:13px;padding:12px;">ğŸ“¥ åŒ¯å‡ºå¤–å‹¤ CSV</button>
                </div>

                <!-- æ¥­å‹™ç›®æ¨™ Tab -->
                <div id="fsaTargetTab" style="display:none;">
                    <!-- é€±åˆ‡æ› -->
                    <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:16px;">
                        <button onclick="stChangeWeek(-1)" style="padding:8px 14px;border:1px solid #E2E8F0;border-radius:10px;background:#fff;cursor:pointer;font-size:16px;">â†</button>
                        <span id="stWeekLabel" style="font-weight:700;font-size:14px;min-width:180px;text-align:center;"></span>
                        <button onclick="stChangeWeek(1)" style="padding:8px 14px;border:1px solid #E2E8F0;border-radius:10px;background:#fff;cursor:pointer;font-size:16px;">â†’</button>
                    </div>

                    <!-- è¨­å®šç›®æ¨™å€ -->
                    <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:16px;">
                        <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">ğŸ¯ æœ¬é€±å…¨å“¡é è¨­ç›®æ¨™</div>
                        <div style="display:flex;gap:12px;margin-bottom:12px;">
                            <div style="flex:1;">
                                <label style="font-size:12px;font-weight:600;color:#64748B;display:block;margin-bottom:4px;">ğŸ“ é›»è©±æ‹œè¨ª</label>
                                <input type="number" id="stDefaultCall" min="0" value="0" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                            </div>
                            <div style="flex:1;">
                                <label style="font-size:12px;font-weight:600;color:#64748B;display:block;margin-bottom:4px;">ğŸ¢ å¯¦åœ°æ‹œè¨ª</label>
                                <input type="number" id="stDefaultVisit" min="0" value="0" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveDefaultTarget()" style="font-size:13px;padding:10px;">ğŸ’¾ å„²å­˜é è¨­ç›®æ¨™</button>
                    </div>

                    <!-- å…¨å“¡é€²åº¦ç¸½è¦½ -->
                    <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">ğŸ“Š å…¨å“¡é€²åº¦ç¸½è¦½</div>
                    <div id="stProgressList"><p style="text-align:center;color:#999;">è¼‰å…¥ä¸­...</p></div>
                </div>
            </div>

            <!-- æ˜ç´° Modal -->
            <div id="fwaDetailModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999;overflow-y:auto;">
                <div style="background:#fff;margin:30px auto;max-width:500px;border-radius:16px;padding:24px;">
                    <div id="fwaDetailContent"></div>
                    <div id="fwaDetailActions" style="display:flex;gap:8px;margin-top:16px;"></div>
                    <button class="btn btn-secondary" onclick="closeFwaDetailModal()" style="width:100%;margin-top:8px;font-size:13px;">é—œé–‰</button>
                </div>
            </div>
        </div>

        <!-- ====== é¤é£²æ¥­ç®¡ç† ====== -->
        <div id="restaurantPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ½ï¸ é¤é£²æ¥­ç®¡ç†</h2>
                <button class="btn btn-primary" onclick="showStoreModal()" style="margin-bottom:16px;font-size:13px;padding:12px;">+ æ–°å¢å•†åº—</button>
                <div id="restaurantStoreList"><p style="text-align:center;color:#999;">è¼‰å…¥ä¸­...</p></div>
            </div>
        </div>

        <!-- å•†åº—è©³æƒ…é  -->
        <div id="restaurantDetailPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('restaurantPage')" style="width:auto;margin-bottom:10px;">â† è¿”å›å•†åº—åˆ—è¡¨</button>
            <div class="checkin-page">
                <!-- åº—é ­è³‡è¨Š -->
                <div id="rdStoreHeader" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <h2 id="rdStoreName" style="margin:0;font-size:18px;"></h2>
                    <div style="display:flex;gap:6px;">
                        <button onclick="previewStoreOrder()" style="padding:6px 10px;border:none;border-radius:8px;background:#4F46E5;color:#fff;font-size:12px;cursor:pointer;">ğŸ‘ï¸ é è¦½</button>
                        <button onclick="showStoreQR(rdCurrentStoreId)" style="padding:6px 10px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:12px;cursor:pointer;">ğŸ“± QR</button>
                        <button onclick="editStore(rdCurrentStoreId)" style="padding:6px 10px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:12px;cursor:pointer;">ğŸ“ ç·¨è¼¯</button>
                    </div>
                </div>
                <div id="rdStorePreviewLink" style="margin-bottom:8px;"></div>
                <div id="rdAcceptOrderToggle" style="margin-bottom:12px;"></div>

                <!-- Tab åˆ‡æ› -->
                <div style="display:flex;gap:0;margin-bottom:14px;border-bottom:2px solid #E2E8F0;">
                    <div class="rdTab rdTabActive" onclick="switchRestaurantTab('orders',this)" style="flex:1;text-align:center;padding:10px 0;font-size:13px;font-weight:700;cursor:pointer;border-bottom:3px solid #4F46E5;margin-bottom:-2px;color:#4F46E5;">ğŸ“‹ è¨‚å–®</div>
                    <div class="rdTab" onclick="switchRestaurantTab('menu',this)" style="flex:1;text-align:center;padding:10px 0;font-size:13px;font-weight:600;cursor:pointer;color:#94A3B8;">ğŸ½ï¸ èœå–®</div>
                    <div class="rdTab" onclick="switchRestaurantTab('settings',this)" style="flex:1;text-align:center;padding:10px 0;font-size:13px;font-weight:600;cursor:pointer;color:#94A3B8;">âš™ï¸ è¨­å®š</div>
                </div>

                <!-- è¨‚å–® Tab -->
                <div id="rdOrdersTab">
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
                        <select id="rdStatusFilter" style="flex:1;padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;">
                            <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                            <option value="pending" selected>å¾…è™•ç†</option>
                            <option value="confirmed">å·²ç¢ºèª</option>
                            <option value="preparing">æº–å‚™ä¸­</option>
                            <option value="ready">å¯å–é¤</option>
                            <option value="completed">å·²å®Œæˆ</option>
                            <option value="cancelled">å·²å–æ¶ˆ</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadStoreOrders()" style="font-size:12px;padding:8px 14px;">æŸ¥è©¢</button>
                    </div>
                    <!-- çµ±è¨ˆ -->
                    <div style="display:flex;gap:8px;margin-bottom:12px;">
                        <div style="flex:1;text-align:center;padding:8px;background:#FEF3C7;border-radius:8px;">
                            <div style="font-size:18px;font-weight:900;color:#92400E;" id="rdPendingCount">0</div>
                            <div style="font-size:10px;color:#92400E;">å¾…è™•ç†</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:8px;background:#DBEAFE;border-radius:8px;">
                            <div style="font-size:18px;font-weight:900;color:#1E40AF;" id="rdTodayCount">0</div>
                            <div style="font-size:10px;color:#1E40AF;">ä»Šæ—¥è¨‚å–®</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:8px;background:#D1FAE5;border-radius:8px;">
                            <div style="font-size:18px;font-weight:900;color:#059669;" id="rdTodayRevenue">$0</div>
                            <div style="font-size:10px;color:#059669;">ä»Šæ—¥ç‡Ÿæ”¶</div>
                        </div>
                    </div>
                    <!-- ç†±éŠ· TOP 5 -->
                    <div id="rdTopSelling" style="display:none;background:#FFFBEB;border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:12px;"></div>
                    <div id="rdOrderList"><p style="text-align:center;color:#999;">è¼‰å…¥ä¸­...</p></div>
                </div>

                <!-- èœå–® Tab -->
                <div id="rdMenuTab" style="display:none;">
                    <!-- åˆ†é¡ç®¡ç† -->
                    <div style="background:#F8FAFC;border-radius:12px;padding:14px;margin-bottom:16px;">
                        <div style="font-weight:700;font-size:14px;margin-bottom:8px;">ğŸ“‚ åˆ†é¡</div>
                        <div id="menuCatList" style="margin-bottom:8px;"></div>
                        <div style="display:flex;gap:8px;">
                            <input type="text" id="newCatName" placeholder="æ–°åˆ†é¡åç¨±" style="flex:1;padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;box-sizing:border-box;">
                            <button onclick="addMenuCategory()" style="padding:8px 14px;border:none;border-radius:8px;background:#4F46E5;color:#fff;font-weight:600;font-size:13px;cursor:pointer;">+ æ–°å¢</button>
                        </div>
                    </div>
                    <!-- å“é …ç®¡ç† -->
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div>
                            <span style="font-weight:700;font-size:14px;">ğŸ½ï¸ å“é …</span>
                            <span id="menuItemCount" style="font-size:12px;color:#94A3B8;margin-left:6px;"></span>
                        </div>
                        <button onclick="showCopyMenuModal()" style="padding:6px 12px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:11px;cursor:pointer;">ğŸ“‹ è¤‡è£½èœå–®åˆ°å…¶ä»–å•†åº—</button>
                    </div>
                    <button onclick="showMenuItemForm()" style="width:100%;padding:12px;border:2px dashed #4F46E5;border-radius:14px;background:#EEF2FF;color:#4F46E5;font-weight:800;font-size:14px;cursor:pointer;margin-bottom:12px;">+ æ–°å¢å“é …</button>
                    <div id="menuItemList"></div>

                    <!-- å…¨è¢å¹•æŠ½å±œï¼šæ–°å¢/ç·¨è¼¯å“é … -->
                    <div id="miDrawerMask" class="mi-drawer-mask" style="display:none;" onclick="cancelMenuItemForm()"></div>
                    <div id="miDrawer" class="mi-drawer" style="display:none;">
                        <input type="hidden" id="miEditId">
                        <input type="hidden" id="miImageUrl">
                        <input type="file" id="miImageFile" accept="image/*" onchange="handleMenuImageUpload(this)" style="display:none;">
                        <!-- é ‚éƒ¨æ¬„ -->
                        <div class="mi-drawer-header">
                            <button onclick="cancelMenuItemForm()" style="border:none;background:none;font-size:14px;font-weight:700;color:#64748B;cursor:pointer;padding:6px 0;">âœ• å–æ¶ˆ</button>
                            <span id="miDrawerTitle" style="font-size:15px;font-weight:900;color:#0F172A;">æ–°å¢å“é …</span>
                            <button onclick="toggleMiPreview()" id="miPreviewBtn" style="border:1.5px solid #E2E8F0;background:#fff;color:#64748B;border-radius:8px;font-size:11px;font-weight:700;padding:6px 10px;cursor:pointer;">ğŸ‘ é è¦½</button>
                        </div>
                        <!-- å¯æ²å‹•å…§å®¹ -->
                        <div class="mi-drawer-body">
                            <!-- é è¦½é¢æ¿ -->
                            <div id="miPreviewPanel" style="display:none;"></div>
                            <!-- è¡¨å–®é¢æ¿ -->
                            <div id="miFormPanel">
                                <!-- Section 1: åŸºæœ¬è³‡è¨Š -->
                                <div class="mi-section">
                                    <div class="mi-section-hd" onclick="toggleMiSection(this)">
                                        <div class="title"><span>ğŸ“</span> åŸºæœ¬è³‡è¨Š</div>
                                        <span class="arrow open">â–¼</span>
                                    </div>
                                    <div class="mi-section-bd">
                                        <div class="mi-field">
                                            <label>å“å <span class="req">*</span></label>
                                            <input type="text" id="miName" class="mi-input" placeholder="ä¾‹ï¼šæ‹›ç‰Œç‰›è‚‰éºµ">
                                        </div>
                                        <div style="display:flex;gap:10px;">
                                            <div class="mi-field" style="flex:1;">
                                                <label>åˆ†é¡</label>
                                                <select id="miCategory" class="mi-select"></select>
                                            </div>
                                            <div class="mi-field" style="flex:1;">
                                                <label>åƒ¹æ ¼ <span class="req">*</span></label>
                                                <div style="position:relative;">
                                                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;font-weight:800;color:#94A3B8;">$</span>
                                                    <input type="number" id="miPrice" class="mi-input" min="0" placeholder="0" style="padding-left:28px;">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mi-field">
                                            <label>èªªæ˜</label>
                                            <input type="text" id="miDesc" class="mi-input" placeholder="ç°¡çŸ­æè¿°å“é …ç‰¹è‰²">
                                            <div class="hint">é¸å¡«ï¼Œæœƒé¡¯ç¤ºåœ¨å®¢äººé»é¤é é¢</div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Section 2: å“é …åœ–ç‰‡ -->
                                <div class="mi-section">
                                    <div class="mi-section-hd" onclick="toggleMiSection(this)">
                                        <div class="title"><span>ğŸ“·</span> å“é …åœ–ç‰‡</div>
                                        <span class="arrow">â–¼</span>
                                    </div>
                                    <div class="mi-section-bd" style="display:none;">
                                        <div id="miImageArea" onclick="document.getElementById('miImageFile').click()" style="border:2px dashed #CBD5E1;border-radius:14px;padding:20px;text-align:center;cursor:pointer;background:#F8FAFC;">
                                            <img id="miImagePreview" style="width:100px;height:100px;border-radius:12px;object-fit:cover;display:none;border:1px solid #E2E8F0;margin:0 auto 8px;">
                                            <div id="miImagePlaceholder">
                                                <div style="font-size:32px;margin-bottom:4px;">ğŸ“·</div>
                                                <div style="font-size:12px;font-weight:700;color:#64748B;">é»æ“Šä¸Šå‚³å“é …åœ–ç‰‡</div>
                                                <div style="font-size:11px;color:#94A3B8;margin-top:2px;">å»ºè­° 400Ã—400ï¼ŒJPG/PNG</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Section 3: å®¢è£½åŒ–é¸é … -->
                                <div class="mi-section">
                                    <div class="mi-section-hd" onclick="toggleMiSection(this)">
                                        <div class="title"><span>ğŸ›</span> å®¢è£½åŒ–é¸é … <span id="miOptBadge" class="mi-badge mi-badge-opt" style="display:none;"></span></div>
                                        <span class="arrow">â–¼</span>
                                    </div>
                                    <div class="mi-section-bd" id="miOptionsSection" style="display:none;">
                                        <div id="miOptionsEditor"></div>
                                    </div>
                                </div>
                                <!-- Section 4: å¥—é¤çµ„åˆ -->
                                <div class="mi-section">
                                    <div class="mi-section-hd" onclick="toggleMiSection(this)">
                                        <div class="title"><span>ğŸ±</span> å¥—é¤çµ„åˆ</div>
                                        <span class="arrow">â–¼</span>
                                    </div>
                                    <div class="mi-section-bd" id="miComboSection" style="display:none;">
                                        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:8px 0;">
                                            <div id="miComboToggle" onclick="toggleComboSwitch()" style="width:44px;height:24px;border-radius:12px;background:#CBD5E1;position:relative;cursor:pointer;transition:background 0.2s;">
                                                <div id="miComboKnob" style="width:20px;height:20px;border-radius:10px;background:#fff;position:absolute;top:2px;left:2px;transition:left 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                                            </div>
                                            <span id="miComboLabel" style="font-size:13px;font-weight:700;color:#64748B;">æ­¤å“é …ç‚ºå¥—é¤çµ„åˆ</span>
                                        </label>
                                        <div id="miComboEditor" style="display:none;margin-top:8px;">
                                            <div style="margin-bottom:10px;padding:12px;background:#EEF2FF;border-radius:10px;font-size:12px;color:#4F46E5;line-height:1.6;">
                                                ğŸ’¡ å¥—é¤æ¨¡å¼ä¸‹ï¼Œå®¢äººå¯å¾å¤šå€‹ç¾¤çµ„ä¸­å„é¸ä¸€é …çµ„åˆã€‚
                                            </div>
                                            <div id="miComboGroups"></div>
                                            <button type="button" onclick="addComboGroup()" style="width:100%;padding:10px;border:1.5px dashed #CBD5E1;border-radius:10px;background:transparent;font-size:12px;font-weight:700;color:#64748B;cursor:pointer;">+ æ–°å¢å¥—é¤ç¾¤çµ„</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- åº•éƒ¨æ“ä½œåˆ— -->
                        <div class="mi-drawer-footer">
                            <button id="miDeleteBtn" onclick="deleteMenuItem()" style="display:none;padding:14px 16px;border:1.5px solid #DC2626;border-radius:12px;background:#fff;color:#DC2626;font-size:13px;font-weight:700;cursor:pointer;">ğŸ—‘</button>
                            <button onclick="saveMenuItem()" id="miSaveBtn" style="flex:1;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#059669,#047857);color:#fff;font-size:15px;font-weight:800;cursor:pointer;transition:all 0.2s;">âœ… æ–°å¢å“é …</button>
                        </div>
                    </div>
                </div>

                <!-- è¨­å®š Tab -->
                <div id="rdSettingsTab" style="display:none;">
                    <!-- åŸºæœ¬è³‡æ–™ï¼ˆç”¨ç¾æœ‰ storeModal ç·¨è¼¯ï¼‰ -->
                    <div style="background:#F8FAFC;border-radius:12px;padding:14px;margin-bottom:14px;">
                        <div style="font-weight:700;font-size:14px;margin-bottom:10px;">ğŸ“‹ åŸºæœ¬è³‡æ–™</div>
                        <div id="rdStoreInfo" style="font-size:13px;color:#64748B;"></div>
                        <button onclick="editStore(rdCurrentStoreId)" style="margin-top:8px;padding:8px 16px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:12px;cursor:pointer;">ğŸ“ ç·¨è¼¯åŸºæœ¬è³‡æ–™</button>
                    </div>
                    <!-- ç‡Ÿæ¥­æ™‚é–“ -->
                    <div style="background:#F8FAFC;border-radius:12px;padding:14px;margin-bottom:14px;">
                        <div style="font-weight:700;font-size:14px;margin-bottom:10px;">ğŸ• ç‡Ÿæ¥­æ™‚é–“</div>
                        <div id="rdBusinessHours"></div>
                        <button onclick="saveBusinessHours()" class="btn btn-success" style="margin-top:10px;font-size:13px;padding:10px 20px;">ğŸ’¾ å„²å­˜ç‡Ÿæ¥­æ™‚é–“</button>
                    </div>
                    <!-- LINE ç¾¤çµ„ -->
                    <div style="background:#F8FAFC;border-radius:12px;padding:14px;margin-bottom:14px;">
                        <div style="font-weight:700;font-size:14px;margin-bottom:10px;">ğŸ’¬ LINE ç¾¤çµ„æ¨æ’­</div>
                        <p style="font-size:11px;color:#94A3B8;margin-bottom:8px;">å°‡ Bot åŠ å…¥ç¾¤çµ„å¾Œï¼Œåœ¨ç¾¤çµ„ä¸­è¼¸å…¥ /groupid å–å¾—ç¾¤çµ„ ID</p>
                        <input type="text" id="rdLineGroupId" placeholder="LINE Group ID" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;box-sizing:border-box;">
                        <button onclick="saveLineGroupId()" class="btn btn-success" style="margin-top:8px;font-size:13px;padding:10px 20px;">ğŸ’¾ å„²å­˜</button>
                    </div>
                    <!-- é›†é»è¨­å®š -->
                    <div style="background:#F8FAFC;border-radius:12px;padding:14px;margin-bottom:14px;">
                        <div style="font-weight:700;font-size:14px;margin-bottom:10px;">ğŸ¯ æœƒå“¡é›†é»</div>
                        <div class="form-group" style="margin-bottom:8px;">
                            <label style="font-size:12px;">æ¯æ¶ˆè²»å¤šå°‘å…ƒå¾— 1 é»</label>
                            <input type="number" id="rdLoyaltySpend" min="1" placeholder="50" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;box-sizing:border-box;">
                        </div>
                        <div class="form-group" style="margin-bottom:8px;">
                            <label style="font-size:12px;">å¤šå°‘é»å¯å…Œæ›æŠ˜æ‰£</label>
                            <input type="number" id="rdLoyaltyPoints" min="1" placeholder="10" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;box-sizing:border-box;">
                        </div>
                        <div class="form-group" style="margin-bottom:8px;">
                            <label style="font-size:12px;">æŠ˜æ‰£é‡‘é¡ (å…ƒ)</label>
                            <input type="number" id="rdLoyaltyDiscount" min="1" placeholder="50" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;box-sizing:border-box;">
                        </div>
                        <button onclick="saveLoyaltyConfig()" class="btn btn-success" style="font-size:13px;padding:10px 20px;">ğŸ’¾ å„²å­˜é›†é»è¨­å®š</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å•†åº—ç·¨è¼¯ Modal -->
        <div id="storeModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;padding:20px;">
            <div style="background:#fff;border-radius:16px;width:100%;max-width:440px;max-height:90vh;overflow-y:auto;padding:24px;">
                <h3 id="storeModalTitle" style="margin-bottom:16px;">æ–°å¢å•†åº—</h3>
                <input type="hidden" id="storeEditId">
                <div class="form-group">
                    <label>å•†åº—åç¨± *</label>
                    <input type="text" id="storeNameInput" placeholder="ä¾‹ï¼šMike's Cafe" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label>URL ä»£ç¢¼ (slug)</label>
                    <input type="text" id="storeSlugInput" placeholder="ä¾‹ï¼šmikes-cafeï¼ˆè‹±æ–‡å°å¯«+é€£å­—è™Ÿï¼‰" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label>å•†åº—é¡å‹</label>
                    <select id="storeTypeSelect" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                        <option value="restaurant">é¤é£²</option>
                        <option value="service">æœå‹™æ¥­</option>
                        <option value="retail">é›¶å”®</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>èªªæ˜</label>
                    <input type="text" id="storeDescInput" placeholder="é¸å¡«" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label>é›»è©±</label>
                    <input type="tel" id="storePhoneInput" placeholder="é¸å¡«" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label>åœ°å€</label>
                    <input type="text" id="storeAddressInput" placeholder="é¸å¡«" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label>ä¸»é¡Œè‰²</label>
                    <input type="color" id="storeColorInput" value="#4F46E5" style="width:60px;height:40px;border:none;cursor:pointer;">
                </div>
                <div style="display:flex;gap:8px;margin-top:16px;">
                    <button onclick="closeStoreModal()" style="flex:1;padding:14px;border:1px solid #E2E8F0;border-radius:10px;background:#fff;font-weight:600;cursor:pointer;color:#64748B;">å–æ¶ˆ</button>
                    <button onclick="saveStore()" style="flex:1;padding:14px;border:none;border-radius:10px;background:linear-gradient(135deg,#059669,#10B981);color:#fff;font-weight:700;cursor:pointer;">ğŸ’¾ å„²å­˜</button>
                </div>
            </div>
        </div>

        <!-- èœå–®è¤‡è£½ Modal -->
        <div id="copyMenuModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;padding:20px;">
            <div style="background:#fff;border-radius:16px;width:100%;max-width:400px;padding:24px;">
                <h3 style="margin-bottom:12px;">ğŸ“‹ è¤‡è£½èœå–®åˆ°å…¶ä»–å•†åº—</h3>
                <p style="font-size:12px;color:#EF4444;margin-bottom:12px;">æœƒè¦†è“‹ç›®æ¨™å•†åº—çš„ç¾æœ‰èœå–®</p>
                <div id="copyMenuTargets" style="margin-bottom:16px;"></div>
                <div style="display:flex;gap:8px;">
                    <button onclick="closeCopyMenuModal()" style="flex:1;padding:10px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:13px;cursor:pointer;">å–æ¶ˆ</button>
                    <button onclick="executeCopyMenu()" style="flex:1;padding:10px;border:none;border-radius:8px;background:#4F46E5;color:#fff;font-weight:600;font-size:13px;cursor:pointer;">ç¢ºå®šè¤‡è£½</button>
                </div>
            </div>
        </div>

        <!-- å•†åº— QR Code Modal -->
        <div id="storeQRModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;padding:20px;">
            <div style="background:#fff;border-radius:16px;width:100%;max-width:380px;padding:24px;text-align:center;">
                <h3 id="storeQRTitle" style="margin-bottom:12px;"></h3>
                <div id="storeQRCode" style="display:inline-block;margin:12px 0;"></div>
                <div style="margin-top:8px;">
                    <p id="storeQRUrl" style="font-size:11px;color:#64748B;word-break:break-all;margin-bottom:12px;"></p>
                    <button onclick="copyStoreUrl()" style="padding:8px 16px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:12px;cursor:pointer;margin-right:6px;">ğŸ“‹ è¤‡è£½é€£çµ</button>
                    <button onclick="openStorePreview()" style="padding:8px 16px;border:none;border-radius:8px;background:#4F46E5;color:#fff;font-size:12px;cursor:pointer;">ğŸ‘ï¸ é è¦½é»é¤é </button>
                </div>
                <button onclick="closeStoreQR()" style="margin-top:16px;padding:10px 24px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;font-size:13px;cursor:pointer;">é—œé–‰</button>
            </div>
        </div>

        <!-- è¨‚å–®æ˜ç´° Modal -->
        <div id="orderDetailModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;padding:20px;">
            <div style="background:#fff;border-radius:16px;width:100%;max-width:420px;max-height:90vh;overflow-y:auto;padding:24px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h3 id="odTitle" style="margin:0;">è¨‚å–®æ˜ç´°</h3>
                    <button onclick="closeOrderDetail()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#94A3B8;">Ã—</button>
                </div>
                <div id="odContent"></div>
                <div id="odActions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:16px;"></div>
            </div>
        </div>

    </div>
    <nav class="bottom-nav" id="bottomNav" style="display:none;">
        <a class="nav-item" onclick="window.location.href='index.html'">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-label">é¦–é </span>
        </a>
        <a class="nav-item" onclick="window.location.href='schedule.html'">
            <span class="nav-icon">ğŸ“…</span>
            <span class="nav-label">ç­è¡¨</span>
        </a>
        <a class="nav-item" onclick="window.location.href='checkin.html?type=in'">
            <span class="nav-icon">ğŸ“</span>
            <span class="nav-label">æ‰“å¡</span>
        </a>
        <a class="nav-item" onclick="window.location.href='salary.html'">
            <span class="nav-icon">ğŸ’°</span>
            <span class="nav-label">è–ªè³‡</span>
        </a>
        <a class="nav-item active">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-label">ç®¡ç†</span>
        </a>
    </nav>

    <script src="common.js"></script>
    <script>
        let currentAdminEmployee = null;

        // ===== æ··åˆç²¾ç®—çé‡‘ç³»çµ± =====
        const BONUS_MATRIX = {
            S: { A: 2.0, B: 1.8, C: 1.5 },
            A: { A: 1.5, B: 1.3, C: 1.0 },
            B: { A: 1.0, B: 0.8, C: 0.5 }
        };
        const FULL_ATTENDANCE_BONUS = 3000;
        const LATE_PENALTY_PER = 200;
        const GRADE_LABELS = { A: 'å…¨å‹¤', B: 'æ­£å¸¸', C: 'å¾…åŠ å¼·' };
        const PERF_LABELS = { S: 'å“è¶Š', A: 'å„ªè‰¯', B: 'æ™®é€š' };
        let bonusEmployees = [];
        let bonusPerformance = {};
        let bonusAdjustments = {};

        // æœ¬åœ°æ—¥æœŸæ ¼å¼åŒ–ï¼ˆé¿å… toISOString æ™‚å€åç§»ï¼‰
        function fmtDate(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        // é é¢åˆ‡æ›
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if (id === 'bonusPage') loadHybridBonusData();
            if (id === 'locationPage') renderLocationList();
            if (id === 'employeePage') loadEmployeeList();
            if (id === 'approvalCenterPage') { switchApprovalType('leave', document.querySelector('.aprTab')); }
            if (id === 'announcementPage') loadAnnouncementList();
            if (id === 'auditLogPage') loadAuditLogs();
            if (id === 'featurePage') { loadFeatureSettings(); loadNotifyToken(); }
            if (id === 'staffMgrPage') { loadShiftMgr(); loadMaxLeaveSetting(); loadStaffOverview(); loadSchedulingMode(); }
            if (id === 'lunchMgrPage') { loadLunchManagers(); loadAdminLunchStats(); }
            if (id === 'payrollPage') { initPayrollPage(); }
            if (id === 'clientPage') { loadClientList(); loadServiceItemList(); }
            if (id === 'fieldSalesAdminPage') { switchFieldSalesAdmin('approval', document.querySelector('.fsaTab')); }
            if (id === 'insurancePage') { loadInsuranceBrackets(); }
            if (id === 'restaurantPage') { loadRestaurantList(); }
            if (id === 'restaurantDetailPage') { /* loaded via openRestaurantDetail */ }
        }

        // ===== åŠŸèƒ½ç®¡ç† =====
        const ADMIN_FEATURE_LIST = [
            { key: 'leave',          label: 'æˆ‘è¦è«‹å‡',      desc: 'è«‹å‡ç”³è«‹èˆ‡è¨˜éŒ„æŸ¥è©¢',   icon: 'ğŸ“' },
            { key: 'lunch',          label: 'ä¾¿ç•¶è¨‚è³¼',      desc: 'æ¯æ—¥åˆé¤è¨‚è³¼ç®¡ç†',     icon: 'ğŸ±' },
            { key: 'attendance',     label: 'è€ƒå‹¤æŸ¥è©¢',      desc: 'å‡ºå‹¤æœˆæ›†èˆ‡è¨˜éŒ„æŸ¥è©¢',   icon: 'ğŸ“Š' },
            { key: 'fieldwork,sales_target', label: 'å¤–å‹¤/æ¥­å‹™', desc: 'å¤–å‹¤æ‰“å¡ã€æ¥­å‹™ç›®æ¨™èˆ‡é€±å ±', icon: 'ğŸ“' },
            { key: 'store_ordering', label: 'ç·šä¸Šé»é¤/é ç´„',  desc: 'ç·šä¸Šé ç´„èˆ‡é»é¤æœå‹™',   icon: 'ğŸ›ï¸' }
        ];
        let companyAllowedFeatures = null;
        let featureState = { leave: true, lunch: true, attendance: true, fieldwork: true, sales_target: true, store_ordering: false };

        // LINE Notify è¨­å®š
        async function loadNotifyToken() {
            try {
                const { data } = await sb.from('system_settings')
                    .select('value').eq('key', 'line_notify_token').maybeSingle();
                if (data?.value?.token) {
                    const el = document.getElementById('lineNotifyToken');
                    if (el) el.value = data.value.token;
                }
            } catch(e) {}
        }

        async function saveNotifyToken() {
            const token = document.getElementById('lineNotifyToken')?.value?.trim();
            if (!token) return showToast('âŒ è«‹è¼¸å…¥ Token');
            const status = document.getElementById('notifyStatus');
            try {
                const { data: existing } = await sb.from('system_settings')
                    .select('id').eq('key', 'line_notify_token').maybeSingle();
                if (existing) {
                    await sb.from('system_settings').update({ value: { token }, updated_at: new Date().toISOString() }).eq('key', 'line_notify_token');
                } else {
                    await sb.from('system_settings').insert({ key: 'line_notify_token', value: { token }, description: 'LINE Notify æ¨æ’­ Token' });
                }
                showToast('âœ… Token å·²å„²å­˜');
                if (status) { status.style.display = 'block'; status.style.color = '#059669'; status.textContent = 'âœ… å·²å„²å­˜'; }
            } catch(e) { showToast('âŒ å„²å­˜å¤±æ•—'); }
        }

        async function testNotify() {
            const status = document.getElementById('notifyStatus');
            if (status) { status.style.display = 'block'; status.style.color = '#6D28D9'; status.textContent = 'â³ ç™¼é€æ¸¬è©¦...'; }
            try {
                await sendAdminNotify('ğŸ”” HR ç³»çµ±æ¨æ’­æ¸¬è©¦\nå¦‚æœæ‚¨æ”¶åˆ°æ­¤è¨Šæ¯ï¼Œè¡¨ç¤º LINE Notify è¨­å®šæˆåŠŸï¼');
                showToast('âœ… æ¸¬è©¦æ¨æ’­å·²ç™¼é€');
                if (status) { status.style.color = '#059669'; status.textContent = 'âœ… æ¨æ’­æˆåŠŸï¼è«‹æŸ¥çœ‹ LINE ç¾¤çµ„'; }
            } catch(e) {
                showToast('âŒ æ¨æ’­å¤±æ•—');
                if (status) { status.style.color = '#DC2626'; status.textContent = 'âŒ æ¨æ’­å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token æˆ– Edge Function'; }
            }
        }

        async function loadFeatureSettings() {
            try {
                const { data } = await sb.from('system_settings')
                    .select('value')
                    .eq('key', 'feature_visibility')
                    .maybeSingle();
                if (data?.value) {
                    featureState = { ...featureState, ...data.value };
                }
            } catch(e) {}

            // æ ¹æ“šå¹³å°å…è¨±çš„åŠŸèƒ½ï¼Œå‹•æ…‹ç”¢ç”Ÿ toggle å¡ç‰‡
            const allowed = companyAllowedFeatures || {};
            const defaultAllowed = { leave: true, lunch: true, attendance: true, fieldwork: true, sales_target: true, store_ordering: false };
            const visibleFeatures = ADMIN_FEATURE_LIST.filter(f => {
                const keys = f.key.split(',');
                if (companyAllowedFeatures) {
                    return keys.some(k => allowed[k.trim()] === true);
                }
                return keys.some(k => defaultAllowed[k.trim()] !== false);
            });

            const container = document.getElementById('featureToggles');
            if (visibleFeatures.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;">ç›®å‰ç„¡å¯ç®¡ç†çš„åŠŸèƒ½ï¼Œè«‹è¯ç¹«å¹³å°ç®¡ç†å“¡é–‹é€šã€‚</p>';
                return;
            }

            container.innerHTML = visibleFeatures.map(f => {
                const keys = f.key.split(',');
                const on = keys.some(k => featureState[k.trim()] !== false);
                const cardId = f.key.replace(',', '_');
                return `
                <div class="feature-toggle-card" id="ftCard_${cardId}" onclick="toggleFeature('${f.key}')"
                     style="display:flex;align-items:center;gap:14px;padding:16px;background:${on ? '#F5F3FF' : '#F8FAFC'};border:2px solid ${on ? '#4F46E5' : '#E5E7EB'};border-radius:14px;cursor:pointer;transition:all 0.2s;">
                    <div class="ft-indicator" style="width:26px;height:26px;border:2px solid ${on ? '#4F46E5' : '#CBD5E1'};border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0;background:${on ? '#4F46E5' : '#fff'};color:#fff;font-size:16px;transition:all 0.2s;">${on ? 'âœ“' : ''}</div>
                    <span style="font-size:28px;">${f.icon}</span>
                    <div style="flex:1;">
                        <div style="font-weight:800;font-size:14px;color:#0F172A;">${f.label}</div>
                        <div style="font-size:12px;color:#94A3B8;margin-top:2px;">${f.desc}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function updateToggleCard(key) {
            const cardId = key.replace(',', '_');
            const card = document.getElementById('ftCard_' + cardId);
            if (!card) return;
            const keys = key.split(',');
            const on = keys.some(k => featureState[k.trim()] !== false);
            const box = card.querySelector('.ft-indicator');

            if (on) {
                card.style.borderColor = '#4F46E5';
                card.style.background = '#F5F3FF';
                box.style.borderColor = '#4F46E5';
                box.style.background = '#4F46E5';
                box.textContent = 'âœ“';
            } else {
                card.style.borderColor = '#E5E7EB';
                card.style.background = '#F8FAFC';
                box.style.borderColor = '#CBD5E1';
                box.style.background = '#fff';
                box.textContent = '';
            }
        }

        async function toggleFeature(key) {
            const keys = key.split(',');
            // åˆ¤æ–·ç›®å‰æ˜¯é–‹é‚„æ˜¯é—œï¼ˆä»»ä¸€å­ key é–‹å•Ÿ = é–‹ï¼‰
            const currentlyOn = keys.some(k => featureState[k.trim()] !== false);
            // å…¨éƒ¨å­ key ä¸€èµ·åˆ‡æ›
            keys.forEach(k => { featureState[k.trim()] = !currentlyOn; });
            updateToggleCard(key);
            
            try {
                const { data: existing } = await sb.from('system_settings')
                    .select('id')
                    .eq('key', 'feature_visibility')
                    .maybeSingle();
                
                if (existing) {
                    await sb.from('system_settings')
                        .update({ value: featureState, updated_at: new Date().toISOString() })
                        .eq('key', 'feature_visibility');
                } else {
                    await sb.from('system_settings')
                        .insert({ key: 'feature_visibility', value: featureState, description: 'å“¡å·¥å¯è¦‹åŠŸèƒ½è¨­å®š' });
                }
                
                // æ¸…é™¤å¿«å–ï¼Œè®“å“¡å·¥ç«¯ä¸‹æ¬¡è¼‰å…¥æ™‚å–å¾—æœ€æ–°è¨­å®š
                invalidateSettingsCache();

                const el = document.getElementById('featureSaveStatus');
                el.style.display = 'block';
                el.textContent = featureState[key] ? 'âœ… å·²é–‹å•Ÿ' : 'â›” å·²é—œé–‰';
                el.style.color = featureState[key] ? '#059669' : '#DC2626';
                setTimeout(() => el.style.display = 'none', 1500);
            } catch(e) {
                console.error('å„²å­˜å¤±æ•—', e);
                showToast('âŒ å„²å­˜å¤±æ•—');
            }
        }

        // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
        async function checkAdminPermission() {
            const statusEl = document.getElementById('permissionStatus');
            const loadingPage = document.getElementById('loadingPage');
            
            try {
                const initialized = await initializeLiff();
                
                // [BUG FIX] ç„¡è«–æˆåŠŸå¤±æ•—éƒ½è¦éš±è— loading ç•«é¢
                if (loadingPage) loadingPage.style.display = 'none';
                
                if (!initialized) {
                    showStatus(statusEl, 'error', 'âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹å¾ LINE é–‹å•Ÿ');
                    return;
                }

                console.log('ğŸ”‘ LINE User ID:', liffProfile?.userId);

                const { data, error } = await sb.from('employees')
                    .select('*')
                    .eq('line_user_id', liffProfile.userId)
                    .in('role', ['admin', 'manager'])
                    .eq('is_active', true)
                    .maybeSingle();

                if (error) {
                    console.error('âŒ è³‡æ–™åº«æŸ¥è©¢éŒ¯èª¤:', error);
                    showStatus(statusEl, 'error', 'âŒ è³‡æ–™åº«æŸ¥è©¢å¤±æ•—: ' + error.message);
                    return;
                }
                
                if (!data) {
                    console.log('âŒ æ‰¾ä¸åˆ°ç®¡ç†å“¡/ä¸»ç®¡è³‡æ–™ï¼ŒLINE ID:', liffProfile?.userId);
                    showStatus(statusEl, 'error', 'âŒ æ‚¨æ²’æœ‰ç®¡ç†æ¬Šé™<br><small style="opacity:0.7">LINE ID: ' + escapeHTML(liffProfile?.userId || 'æœªçŸ¥') + '</small>', true);
                    setTimeout(() => { window.location.href = 'index.html'; }, 5000);
                    return;
                }

                currentAdminEmployee = data;
                updateAdminInfo(data);

                // è¼‰å…¥ç³»çµ±è¨­å®šï¼ˆåœ°é»ç­‰ï¼‰
                await loadSettings();

                // è¼‰å…¥å…¬å¸åŠŸèƒ½è¨­å®šï¼ˆå¹³å°ç®¡ç†å“¡è¨­å®šçš„å…è¨±åŠŸèƒ½ï¼‰+ å…¬å¸åç¨±
                if (data.company_id) {
                    try {
                        const { data: compData } = await sb.from('companies')
                            .select('name, features')
                            .eq('id', data.company_id)
                            .maybeSingle();
                        companyAllowedFeatures = compData?.features || null;
                        // é¡¯ç¤ºå…¬å¸åç¨±
                        if (compData?.name) {
                            const el = document.getElementById('adminCompanyName');
                            if (el) { el.textContent = compData.name; el.style.display = 'block'; }
                        }
                    } catch(e) { console.log('è¼‰å…¥å…¬å¸åŠŸèƒ½è¨­å®šå¤±æ•—', e); }
                }

                showStatus(statusEl, 'success', 'âœ… æ¬Šé™é©—è­‰é€šé');
                populateYearSelect('bonusYear');
                setTimeout(() => {
                    showPage('adminHomePage');
                    document.getElementById('bottomNav').style.display = 'flex';
                    applyRoleVisibility();
                    applyAdminFeatureVisibility();
                }, 800);

            } catch (err) {
                console.error('æ¬Šé™æª¢æŸ¥ç•°å¸¸:', err);
                if (loadingPage) loadingPage.style.display = 'none';
                showStatus(statusEl, 'error', 'âŒ æ¬Šé™æª¢æŸ¥å¤±æ•—: ' + (typeof friendlyError === 'function' ? friendlyError(err) : err.message));
            }
        }

        // [BUG FIX] ä¿®æ­£ç®¡ç†å“¡é ­åƒé¡¯ç¤º â€” æœ‰åœ–ç‰‡æ™‚ä¸æ‡‰é¡¯ç¤º emoji
        function updateAdminInfo(data) {
            const roleLabel = data.role === 'admin' ? 'ç®¡ç†å“¡' : 'ä¸»ç®¡';
            document.getElementById('adminName').textContent = data.name;
            document.getElementById('adminDept').textContent = `${data.department || 'ç³»çµ±ç®¡ç†'} Â· ${roleLabel}`;
            document.getElementById('adminId').textContent = `ID: ${data.employee_number}`;

            const avatar = document.getElementById('adminAvatar');
            if (liffProfile?.pictureUrl) {
                avatar.style.backgroundImage = `url(${liffProfile.pictureUrl})`;
                avatar.style.backgroundSize = 'cover';
                avatar.textContent = '';
            } else {
                avatar.textContent = data.role === 'admin' ? 'ğŸ‘‘' : 'ğŸ‘¤';
            }
        }

        // ä¾è§’è‰²éš±è—ç„¡æ¬Šé™çš„é¸å–®é …ç›®
        function applyRoleVisibility() {
            if (!currentAdminEmployee) return;
            const role = currentAdminEmployee.role;
            if (role === 'admin') return; // admin çœ‹å…¨éƒ¨

            // manager åªçœ‹æ²’æœ‰ data-require="admin" çš„é …ç›®
            document.querySelectorAll('.menu-grid .menu-item[data-require="admin"]').forEach(el => {
                el.style.display = 'none';
            });
        }

        // ä¾å…¬å¸åŠŸèƒ½éš±è—æœªé–‹å•Ÿçš„é¸å–®é …ç›®ï¼ˆæ”¯æ´ comma-separated OR é‚è¼¯ï¼‰
        function applyAdminFeatureVisibility() {
            if (!companyAllowedFeatures) return;
            document.querySelectorAll('.menu-grid .menu-item[data-feature]').forEach(el => {
                const keys = el.getAttribute('data-feature').split(',');
                const visible = keys.some(k => companyAllowedFeatures[k.trim()] === true);
                if (!visible) el.style.display = 'none';
            });
        }

        // ===== å¤–å‹¤/æ¥­å‹™ tab åˆ‡æ› =====
        function switchFieldSalesAdmin(tab, btn) {
            document.querySelectorAll('.fsaTab').forEach(t => {
                t.style.background = 'transparent'; t.style.color = '#94A3B8'; t.style.boxShadow = 'none';
            });
            if (btn) { btn.style.background = '#fff'; btn.style.color = '#4F46E5'; btn.style.boxShadow = '0 1px 4px rgba(0,0,0,0.08)'; }
            document.getElementById('fsaApprovalTab').style.display = tab === 'approval' ? 'block' : 'none';
            document.getElementById('fsaTargetTab').style.display = tab === 'target' ? 'block' : 'none';
            if (tab === 'approval') initFieldWorkApproval();
            if (tab === 'target') initSalesTargetPage();
        }

        // ===== æ··åˆç²¾ç®—çé‡‘ç³»çµ± =====
        async function loadHybridBonusData() {
            const yearEl = document.getElementById('bonusYear');
            const listEl = document.getElementById('bonusList');
            const loadingEl = document.getElementById('bonusLoading');
            const summaryEl = document.getElementById('bonusSummary');
            const actionsEl = document.getElementById('bonusActions');
            const matrixRefEl = document.getElementById('matrixRef');
            if (!yearEl || !listEl) return;
            const year = parseInt(yearEl.value);

            if (loadingEl) loadingEl.style.display = 'block';
            if (summaryEl) summaryEl.style.display = 'none';
            if (actionsEl) actionsEl.style.display = 'none';
            if (matrixRefEl) matrixRefEl.style.display = 'none';
            listEl.innerHTML = '';

            try {
                const [empRes, salaryRes, attRes, leaveRes] = await Promise.all([
                    sb.from('employees').select('id, name, employee_number, department, hire_date').eq('is_active', true).order('department').order('name'),
                    sb.from('salary_settings').select('employee_id, base_salary').eq('is_current', true),
                    sb.from('attendance').select('employee_id, is_late').gte('date', `${year}-01-01`).lte('date', `${year}-12-31`),
                    sb.from('leave_requests').select('employee_id, days').eq('status', 'approved').gte('start_date', `${year}-01-01`).lte('start_date', `${year}-12-31`)
                ]);
                if (empRes.error) throw empRes.error;

                const salaryMap = {};
                (salaryRes.data || []).forEach(s => { salaryMap[s.employee_id] = s.base_salary; });
                const lateMap = {};
                (attRes.data || []).forEach(a => { if (!lateMap[a.employee_id]) lateMap[a.employee_id] = 0; if (a.is_late) lateMap[a.employee_id]++; });
                const leaveMap = {};
                (leaveRes.data || []).forEach(l => { if (!leaveMap[l.employee_id]) leaveMap[l.employee_id] = 0; leaveMap[l.employee_id] += (parseFloat(l.days) || 0); });

                const yearEnd = new Date(year, 11, 31);
                const today = new Date();
                const cutoffDate = yearEnd < today ? yearEnd : today; // å¹´åº¦å·²çµæŸç”¨å¹´åº•ï¼ŒæœªçµæŸç”¨ä»Šå¤©
                bonusEmployees = (empRes.data || []).map(emp => {
                    const baseSalary = salaryMap[emp.id] || 0;
                    const lateCount = lateMap[emp.id] || 0;
                    const leaveDays = leaveMap[emp.id] || 0;
                    let tenureRatio = 1.0;
                    if (emp.hire_date) {
                        const hireDate = new Date(emp.hire_date);
                        const days = Math.max(0, (cutoffDate - hireDate) / 86400000);
                        tenureRatio = Math.min(days / 365, 1.0);
                    }
                    let attendanceGrade = 'B';
                    if (lateCount === 0 && leaveDays === 0) attendanceGrade = 'A';
                    else if (lateCount >= 3 || leaveDays >= 3) attendanceGrade = 'C';

                    return { id: emp.id, name: emp.name, employeeNumber: emp.employee_number, department: emp.department, hireDate: emp.hire_date, baseSalary, lateCount, leaveDays, tenureRatio, attendanceGrade, perfRating: bonusPerformance[emp.id] || 'A' };
                });

                populateBonusEmpDropdown();
                renderSelectedBonusCard();
                updateBonusSummary();
                renderMatrixRefTable();
                if (loadingEl) loadingEl.style.display = 'none';
                if (summaryEl) summaryEl.style.display = 'block';
                if (actionsEl) actionsEl.style.display = 'block';
                if (matrixRefEl) matrixRefEl.style.display = 'block';
                document.getElementById('bonusEmpSelect').style.display = 'block';
            } catch (err) {
                console.error('Bonus load failed:', err);
                if (loadingEl) loadingEl.style.display = 'none';
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—: ' + escapeHTML(friendlyError(err)) + '</p>';
            }
        }

        function calculateBonus(emp) {
            const perfRating = bonusPerformance[emp.id] || emp.perfRating || 'A';
            const manualAdj = bonusAdjustments[emp.id] || 0;
            const multiplier = BONUS_MATRIX[perfRating]?.[emp.attendanceGrade] ?? 1.0;
            const baseAmount = Math.round(emp.baseSalary * emp.tenureRatio * multiplier);
            const fullAtt = emp.attendanceGrade === 'A' ? FULL_ATTENDANCE_BONUS : 0;
            const latePen = emp.lateCount * LATE_PENALTY_PER;
            const finalAmount = Math.max(0, baseAmount + fullAtt - latePen + manualAdj);
            return { perfRating, multiplier, baseAmount, fullAtt, latePen, manualAdj, finalAmount };
        }

        function populateBonusEmpDropdown() {
            const sel = document.getElementById('bonusEmpDropdown');
            if (!sel) return;
            const prev = sel.value;
            sel.innerHTML = '<option value="_all">ğŸ“‹ å…¨éƒ¨å“¡å·¥ç¸½è¦½</option>';
            bonusEmployees.forEach(emp => {
                const c = calculateBonus(emp);
                sel.innerHTML += `<option value="${emp.id}">${escapeHTML(emp.name)}ï¼ˆ${escapeHTML(emp.department || '-')}ï¼‰â€” $${c.finalAmount.toLocaleString()}</option>`;
            });
            if (prev && sel.querySelector(`option[value="${prev}"]`)) sel.value = prev;
        }

        function renderSelectedBonusCard() {
            const listEl = document.getElementById('bonusList');
            const sel = document.getElementById('bonusEmpDropdown');
            if (!listEl || !sel) return;
            if (bonusEmployees.length === 0) { listEl.innerHTML = '<p style="text-align:center;color:#999;">ç„¡å“¡å·¥è³‡æ–™</p>'; return; }

            const selectedId = sel.value;
            if (selectedId === '_all') { renderAllBonusSummaryTable(); return; }

            const emp = bonusEmployees.find(e => e.id === selectedId);
            if (!emp) { listEl.innerHTML = ''; return; }
            const c = calculateBonus(emp);

            listEl.innerHTML = `
            <div class="bonus-card grade-${emp.attendanceGrade}">
                <div class="bonus-card-header">
                    <div><span class="bonus-card-name">${escapeHTML(emp.name)}</span><span class="bonus-card-dept">${escapeHTML(emp.department || '-')} (${escapeHTML(emp.employeeNumber)})</span></div>
                    <span class="bonus-grade-badge bonus-grade-${emp.attendanceGrade}">å‡ºå‹¤ ${emp.attendanceGrade} (${GRADE_LABELS[emp.attendanceGrade]})</span>
                </div>
                <div class="bonus-data-grid">
                    <div><span class="label">é²åˆ°</span></div><div><span class="value">${emp.lateCount} æ¬¡</span></div>
                    <div><span class="label">è«‹å‡</span></div><div><span class="value">${emp.leaveDays} å¤©</span></div>
                    <div><span class="label">åº•è–ª</span></div><div><span class="value">$${(emp.baseSalary || 0).toLocaleString()}</span></div>
                    <div><span class="label">å¹´è³‡æ¯”ä¾‹</span></div><div><span class="value">${(emp.tenureRatio * 100).toFixed(0)}%</span></div>
                </div>
                <div class="bonus-controls" style="margin-bottom:10px;">
                    <label style="font-size:12px;font-weight:700;color:#4b5563;white-space:nowrap;">ç¸¾æ•ˆè©•ç­‰</label>
                    <select onchange="updatePerformance('${emp.id}', this.value)">
                        ${['S','A','B'].map(r => '<option value="' + r + '"' + (c.perfRating === r ? ' selected' : '') + '>' + r + ' (' + PERF_LABELS[r] + ')</option>').join('')}
                    </select>
                    <span style="font-size:13px;font-weight:800;color:#4F46E5;white-space:nowrap;">x${c.multiplier}</span>
                </div>
                <div class="bonus-breakdown">
                    <div class="row" style="font-size:11px;color:#94A3B8;padding-bottom:6px;">
                        <span><a href="salary.html" style="color:#4F46E5;text-decoration:underline;">åº•è–ª$${(emp.baseSalary||0).toLocaleString()}</a> x <a onclick="showPage('employeePage')" style="color:#4F46E5;text-decoration:underline;cursor:pointer;">å¹´è³‡${(emp.tenureRatio*100).toFixed(0)}%</a> x å€ç‡${c.multiplier}</span>
                        <span>$${c.baseAmount.toLocaleString()}</span>
                    </div>
                    ${c.fullAtt > 0 ? '<div class="row"><span class="plus">+ å…¨å‹¤çé‡‘</span><span class="plus">+$' + c.fullAtt.toLocaleString() + '</span></div>' : ''}
                    ${c.latePen > 0 ? '<div class="row"><span class="minus">- é²åˆ°æ‰£æ¬¾ (' + emp.lateCount + 'x$' + LATE_PENALTY_PER + ')</span><span class="minus">-$' + c.latePen.toLocaleString() + '</span></div>' : ''}
                    ${c.manualAdj !== 0 ? '<div class="row"><span>' + (c.manualAdj > 0 ? '+' : '') + ' æ‰‹å‹•èª¿æ•´</span><span>' + (c.manualAdj > 0 ? '+' : '') + '$' + c.manualAdj.toLocaleString() + '</span></div>' : ''}
                    <div class="row total"><span>æœ€çµ‚é‡‘é¡</span><span>$${c.finalAmount.toLocaleString()}</span></div>
                </div>
                <div class="bonus-controls">
                    <label style="font-size:12px;font-weight:700;color:#4b5563;white-space:nowrap;">æ‰‹å‹•èª¿æ•´</label>
                    <input type="text" inputmode="numeric" placeholder="Â±é‡‘é¡" value="${c.manualAdj ? c.manualAdj.toLocaleString() : ''}" onchange="updateAdjustment('${emp.id}', this.value)">
                </div>
            </div>`;
        }

        function renderAllBonusSummaryTable() {
            const listEl = document.getElementById('bonusList');
            if (!listEl) return;
            let html = '<div style="overflow-x:auto;"><table class="matrix-table"><thead><tr><th style="text-align:left;">å§“å</th><th>å‡ºå‹¤</th><th>ç¸¾æ•ˆ</th><th>å€ç‡</th><th style="text-align:right;">çé‡‘</th></tr></thead><tbody>';
            bonusEmployees.forEach(emp => {
                const c = calculateBonus(emp);
                html += `<tr style="cursor:pointer;" onclick="document.getElementById('bonusEmpDropdown').value='${emp.id}';renderSelectedBonusCard();">
                    <td style="text-align:left;font-weight:700;">${escapeHTML(emp.name)}</td>
                    <td><span class="bonus-grade-badge bonus-grade-${emp.attendanceGrade}" style="font-size:10px;padding:2px 6px;">${emp.attendanceGrade}</span></td>
                    <td>${c.perfRating}</td>
                    <td>x${c.multiplier}</td>
                    <td style="text-align:right;font-weight:700;">$${c.finalAmount.toLocaleString()}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            listEl.innerHTML = html;
        }

        function updatePerformance(empId, rating) {
            bonusPerformance[empId] = rating;
            populateBonusEmpDropdown();
            renderSelectedBonusCard();
            updateBonusSummary();
        }
        function updateAdjustment(empId, value) {
            const val = parseMoney(value);
            bonusAdjustments[empId] = val;
            populateBonusEmpDropdown();
            renderSelectedBonusCard();
            updateBonusSummary();
        }
        function updateBonusSummary() {
            let total = 0, count = 0;
            bonusEmployees.forEach(emp => { const c = calculateBonus(emp); if (c.finalAmount > 0) { count++; total += c.finalAmount; } });
            document.getElementById('eligibleCount').textContent = count;
            document.getElementById('totalBudget').textContent = `$${total.toLocaleString()}`;
            document.getElementById('avgBonus').textContent = count > 0 ? `$${Math.round(total / count).toLocaleString()}` : '$0';
        }
        function toggleMatrixRef() {
            const body = document.getElementById('matrixRefBody');
            const arrow = document.getElementById('matrixRefArrow');
            if (body.style.display === 'none') { body.style.display = 'block'; arrow.textContent = 'â–²'; }
            else { body.style.display = 'none'; arrow.textContent = 'â–¼'; }
        }
        function renderMatrixRefTable() {
            const el = document.getElementById('matrixRefBody');
            if (!el) return;
            let html = '<table class="matrix-table"><thead><tr><th>ç¸¾æ•ˆï¼¼å‡ºå‹¤</th>';
            ['A','B','C'].forEach(g => { html += `<th>${g} (${GRADE_LABELS[g]})</th>`; });
            html += '</tr></thead><tbody>';
            ['S','A','B'].forEach(p => {
                html += `<tr><th>${p} (${PERF_LABELS[p]})</th>`;
                ['A','B','C'].forEach(g => { html += `<td>${BONUS_MATRIX[p][g]}x</td>`; });
                html += '</tr>';
            });
            html += '</tbody></table><div style="font-size:11px;color:#94A3B8;">å…¬å¼: åº•è–ª x å¹´è³‡æ¯” x çŸ©é™£å€ç‡ + å…¨å‹¤$3,000(Aç´š) - é²åˆ°$200/æ¬¡ + æ‰‹å‹•èª¿æ•´</div>';
            el.innerHTML = html;
        }

        async function saveAllBonuses() {
            const yearEl = document.getElementById('bonusYear');
            if (!yearEl) return;
            const year = parseInt(yearEl.value);
            const btn = document.getElementById('saveAllBonusBtn');
            if (!confirm(`ç¢ºå®šè¦å„²å­˜ ${year} å¹´å…¨éƒ¨å“¡å·¥çš„çé‡‘è³‡æ–™ï¼Ÿ`)) return;
            setBtnLoading(btn, true);
            try {
                const records = bonusEmployees.map(emp => {
                    const c = calculateBonus(emp);
                    return {
                        employee_id: emp.id, year,
                        calculated_bonus: c.baseAmount,
                        adjusted_bonus: c.finalAmount,
                        final_bonus: c.finalAmount,
                        manager_adjustment: c.manualAdj,
                        months_worked: Math.round(emp.tenureRatio * 12 * 10) / 10,
                        is_approved: true,
                        status: 'approved',
                        ai_recommendation: JSON.stringify({ attendance_grade: emp.attendanceGrade, performance_rating: c.perfRating, matrix_multiplier: c.multiplier, full_attendance_bonus: c.fullAtt, late_penalty: c.latePen, base_salary: emp.baseSalary, tenure_ratio: emp.tenureRatio }),
                        updated_at: new Date().toISOString()
                    };
                });
                const { error } = await sb.from('annual_bonus').upsert(records, { onConflict: 'employee_id,year' });
                if (error) throw error;
                writeAuditLog('save_bonus', 'annual_bonus', null, `${year}å¹´çé‡‘`, { count: records.length, total: records.reduce((s, r) => s + r.final_bonus, 0) });
                showToast(`âœ… å·²å„²å­˜ ${records.length} ç­†çé‡‘è³‡æ–™`);
            } catch (err) {
                console.error('Save bonus failed:', err);
                showToast('âŒ å„²å­˜å¤±æ•—: ' + friendlyError(err));
            } finally {
                setBtnLoading(btn, false, 'ğŸ’¾ å„²å­˜å…¨éƒ¨çé‡‘');
            }
        }

        function exportBonusCSV() {
            const yearEl = document.getElementById('bonusYear');
            if (!yearEl) return;
            const year = parseInt(yearEl.value);
            const rows = [['å·¥è™Ÿ','å§“å','éƒ¨é–€','åº•è–ª','å¹´è³‡æ¯”','å‡ºå‹¤ç­‰ç´š','ç¸¾æ•ˆè©•ç­‰','çŸ©é™£å€æ•¸','åŸºæœ¬çé‡‘','å…¨å‹¤çé‡‘','é²åˆ°æ‰£æ¬¾','æ‰‹å‹•èª¿æ•´','æœ€çµ‚çé‡‘']];
            bonusEmployees.forEach(emp => {
                const c = calculateBonus(emp);
                rows.push([emp.employeeNumber, emp.name, emp.department || '-', emp.baseSalary, (emp.tenureRatio * 100).toFixed(0) + '%', emp.attendanceGrade + '(' + GRADE_LABELS[emp.attendanceGrade] + ')', c.perfRating + '(' + PERF_LABELS[c.perfRating] + ')', c.multiplier, c.baseAmount, c.fullAtt, c.latePen, c.manualAdj, c.finalAmount]);
            });
            const csv = '\uFEFF' + rows.map(r => r.map(c => `"${String(c ?? '').replace(/"/g, '""')}"`).join(',')).join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            a.download = `çé‡‘è©¦ç®—_${year}.csv`;
            a.click();
            showToast(`âœ… çé‡‘è©¦ç®—_${year}.csvï¼ˆ${rows.length - 1} ç­†ï¼‰`);
        }

        // å“¡å·¥ Modal
        function showAddEmployeeModal() {
            document.getElementById('addEmployeeModal').style.display = 'flex';
            document.getElementById('newEmployeeHireDate').value = fmtDate(new Date());
        }

        function closeAddEmployeeModal() {
            document.getElementById('addEmployeeModal').style.display = 'none';
            document.getElementById('addEmployeeForm').reset();
        }

        // æ–°å¢å“¡å·¥
        document.getElementById('addEmployeeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const employeeData = {
                name: document.getElementById('newEmployeeName').value.trim(),
                employee_number: document.getElementById('newEmployeeNumber').value.trim(),
                department: document.getElementById('newEmployeeDepartment').value,
                position: document.getElementById('newEmployeePosition').value.trim() || 'å“¡å·¥',
                id_card_last_4: document.getElementById('newEmployeeCode').value.trim(),
                hire_date: document.getElementById('newEmployeeHireDate').value,
                role: document.getElementById('newEmployeeRole').value,
                is_active: true,
                company_id: '8a669e2c-7521-43e9-9300-5c004c57e9db',
                created_at: new Date().toISOString()
            };

            if (!employeeData.name || !employeeData.employee_number || !employeeData.id_card_last_4) {
                showToast('âš ï¸ è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }
            
            try {
                const { data, error } = await sb.from('employees').insert([employeeData]);
                if (error) throw error;
                
                showToast('âœ… å“¡å·¥æ–°å¢æˆåŠŸï¼');
                closeAddEmployeeModal();
                loadEmployeeList();
            } catch (err) {
                console.error('æ–°å¢å“¡å·¥å¤±æ•—:', err);
                showToast('âŒ æ–°å¢å¤±æ•—: ' + friendlyError(err));
            }
        });

        // QR Code
        function showJoinQRCode() {
            const modal = document.getElementById('qrModal');
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';
            
            const liffUrl = `https://liff.line.me/${CONFIG.LIFF_ID}?type=bind&company=HR_SYSTEM_001`;
            
            new QRCode(qrcodeDiv, {
                text: liffUrl, width: 200, height: 200,
                colorDark: "#1f2937", colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            modal.style.display = 'flex';
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰ Modal
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // è¼‰å…¥å“¡å·¥åˆ—è¡¨
        async function loadEmployeeList() {
            const listEl = document.getElementById('employeeList');
            if (!listEl) return;

            try {
                const { data, error } = await sb.from('employees')
                    .select('*')
                    .eq('is_active', true)
                    .order('department', { ascending: true });

                if (error) throw error;

                const roleNames = { 'admin': 'ç®¡ç†å“¡', 'manager': 'ä¸»ç®¡', 'user': 'ä¸€èˆ¬å“¡å·¥' };

                let html = '';
                data.forEach(emp => {
                    html += `
                        <div class="attendance-item">
                            <div class="date">
                                <div style="display:flex; align-items:center; flex-wrap:wrap; gap:4px;">
                                    <span>${emp.name} - ${emp.employee_number}</span>
                                    <span class="role-${emp.role || 'user'}" style="
                                        padding: 3px 10px; border-radius: 15px; font-size: 11px;
                                        display: inline-block; font-weight: bold;">
                                        ${roleNames[emp.role] || 'æœªçŸ¥'}
                                    </span>
                                </div>
                            </div>
                            <div class="details">
                                <span>${emp.department || '-'} Â· ${emp.position || '-'}</span>
                                <span style="font-size:12px;">é©—è­‰ç¢¼: ${emp.id_card_last_4 || 'æœªè¨­å®š'}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                åˆ°è·: ${emp.hire_date || 'æœªè¨­å®š'} Â· ${emp.employment_type === 'parttime' ? 'å…¼è·' : 'æ­£è·'} Â· ${emp.line_user_id ? 'âœ… å·²ç¶å®š' : 'â³ æœªç¶å®š'}
                            </div>
                            <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
                                <button onclick="openEditEmployeeModal('${emp.id}')" style="padding:7px 12px;border:1px solid #E5E7EB;border-radius:8px;background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:#4F46E5;">âœï¸ ç·¨è¼¯</button>
                                ${emp.line_user_id ? `
                                    <button onclick="updateEmployeeRoleAdmin('${emp.id}', '${emp.role === 'admin' ? 'user' : 'admin'}', '${escapeHTML(emp.name)}')" style="padding:7px 12px;border:1px solid #E5E7EB;border-radius:8px;background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:#EA580C;">
                                        ${emp.role === 'admin' ? 'å–æ¶ˆç®¡ç†å“¡' : 'è¨­ç‚ºç®¡ç†å“¡'}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                listEl.innerHTML = html || '<p style="text-align:center;color:#999;">ç„¡å“¡å·¥è³‡æ–™</p>';

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // [BUG FIX] æ•´åˆè§’è‰²æ›´æ–°å‡½æ•¸ï¼Œé¿å…é‡è¤‡å®šç¾©
        async function updateEmployeeRoleAdmin(employeeId, newRole, employeeName) {
            const roleNames = { 'admin': 'ç®¡ç†å“¡', 'manager': 'ä¸»ç®¡', 'user': 'ä¸€èˆ¬å“¡å·¥' };
            
            try {
                const { error } = await sb.from('employees')
                    .update({ role: newRole })
                    .eq('id', employeeId);
                
                if (error) throw error;
                showToast(`âœ… ${employeeName} â†’ ${roleNames[newRole]}`);
                loadEmployeeList();
            } catch (err) {
                console.error(err);
                showToast('âŒ æ›´æ–°å¤±æ•—: ' + friendlyError(err));
            }
        }

        // æœå°‹å“¡å·¥
        function searchEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            const items = document.querySelectorAll('#employeeList .attendance-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // ===== è–ªè³‡è¨­å®š Modal =====
        let currentSalaryEmpId = null;

        async function openSalarySettingModal(empId, empName) {
            currentSalaryEmpId = empId;
            document.getElementById('salarySettingEmpName').textContent = empName + ' çš„è–ªè³‡è¨­å®š';
            // æ¸…ç©º
            document.getElementById('ssSalaryType').value = 'monthly';
            document.getElementById('ssBaseSalary').value = '';
            document.getElementById('ssMealAllowance').value = '0';
            document.getElementById('ssPositionAllowance').value = '0';
            document.getElementById('ssFullAttBonus').value = '0';
            document.getElementById('ssPensionRate').value = '0';
            onSalaryTypeChange();
            // å¥—ç”¨åƒåˆ†ä½æ ¼å¼åŒ–
            ['ssBaseSalary','ssMealAllowance','ssPositionAllowance','ssFullAttBonus'].forEach(id => {
                formatMoneyInput(document.getElementById(id));
            });
            // è®€å–ç¾æœ‰è¨­å®š
            try {
                const { data } = await sb.from('salary_settings')
                    .select('*')
                    .eq('employee_id', empId)
                    .eq('is_current', true)
                    .maybeSingle();
                if (data) {
                    document.getElementById('ssSalaryType').value = data.salary_type || 'monthly';
                    document.getElementById('ssBaseSalary').value = toMoneyStr(data.base_salary) || '';
                    document.getElementById('ssMealAllowance').value = toMoneyStr(data.meal_allowance || 0);
                    document.getElementById('ssPositionAllowance').value = toMoneyStr(data.position_allowance || 0);
                    document.getElementById('ssFullAttBonus').value = toMoneyStr(data.full_attendance_bonus || 0);
                    document.getElementById('ssPensionRate').value = data.pension_self_rate || 0;
                    onSalaryTypeChange();
                }
            } catch(e) {}
            document.getElementById('salarySettingModal').style.display = 'flex';
        }

        function closeSalarySettingModal() {
            document.getElementById('salarySettingModal').style.display = 'none';
            currentSalaryEmpId = null;
        }

        function onSalaryTypeChange() {
            const t = document.getElementById('ssSalaryType').value;
            const labels = { monthly: 'åŸºæœ¬æœˆè–ª', daily: 'åŸºæœ¬æ—¥è–ª', hourly: 'åŸºæœ¬æ™‚è–ª' };
            document.getElementById('ssBaseLabel').textContent = labels[t] || 'åŸºæœ¬æœˆè–ª';
        }

        async function saveSalarySetting() {
            if (!currentSalaryEmpId) return;
            const base = parseMoney(document.getElementById('ssBaseSalary').value);
            if (!base || base <= 0) { showToast('âš ï¸ è«‹è¼¸å…¥åŸºæœ¬è–ªè³‡'); return; }

            const record = {
                employee_id: currentSalaryEmpId,
                salary_type: document.getElementById('ssSalaryType').value,
                base_salary: base,
                meal_allowance: parseMoney(document.getElementById('ssMealAllowance').value),
                position_allowance: parseMoney(document.getElementById('ssPositionAllowance').value),
                full_attendance_bonus: parseMoney(document.getElementById('ssFullAttBonus').value),
                pension_self_rate: parseFloat(document.getElementById('ssPensionRate').value) || 0,
                is_current: true,
                updated_at: new Date().toISOString()
            };

            try {
                // å…ˆå°‡èˆŠçš„è¨­ç‚ºéç•¶å‰
                await sb.from('salary_settings').update({ is_current: false }).eq('employee_id', currentSalaryEmpId).eq('is_current', true);
                // æ–°å¢ç•¶å‰è¨­å®š
                const { error } = await sb.from('salary_settings').insert(record);
                if (error) throw error;
                showToast('âœ… è–ªè³‡è¨­å®šå·²å„²å­˜');
                closeSalarySettingModal();
                if (typeof loadSalarySettingList === 'function') loadSalarySettingList();
                if (typeof writeAuditLog === 'function') writeAuditLog('update_salary_setting', { employee_id: currentSalaryEmpId, base_salary: base });
            } catch(e) {
                showToast('âŒ å„²å­˜å¤±æ•—: ' + friendlyError(e));
            }
        }

        // ===== ç·¨è¼¯å“¡å·¥ Modal =====
        async function openEditEmployeeModal(empId) {
            document.getElementById('editEmpId').value = empId;
            try {
                const { data } = await sb.from('employees').select('*').eq('id', empId).single();
                if (data) {
                    document.getElementById('editEmpName').value = data.name || '';
                    document.getElementById('editEmpDept').value = data.department || 'ç®¡ç†éƒ¨';
                    document.getElementById('editEmpPosition').value = data.position || '';
                    document.getElementById('editEmpHireDate').value = data.hire_date || '';
                    document.getElementById('editEmpType').value = data.employment_type || 'fulltime';
                }
            } catch(e) {}
            document.getElementById('editEmployeeModal').style.display = 'flex';
        }

        function closeEditEmployeeModal() {
            document.getElementById('editEmployeeModal').style.display = 'none';
        }

        async function saveEditEmployee() {
            const empId = document.getElementById('editEmpId').value;
            if (!empId) return;
            const updates = {
                name: document.getElementById('editEmpName').value.trim(),
                department: document.getElementById('editEmpDept').value,
                position: document.getElementById('editEmpPosition').value.trim(),
                hire_date: document.getElementById('editEmpHireDate').value,
                employment_type: document.getElementById('editEmpType').value
            };
            if (!updates.name) { showToast('âš ï¸ å§“åä¸å¯ç‚ºç©º'); return; }
            try {
                const { error } = await sb.from('employees').update(updates).eq('id', empId);
                if (error) throw error;
                showToast('âœ… å“¡å·¥è³‡æ–™å·²æ›´æ–°');
                closeEditEmployeeModal();
                loadEmployeeList();
            } catch(e) {
                showToast('âŒ æ›´æ–°å¤±æ•—: ' + friendlyError(e));
            }
        }

        // ===== å¯©æ ¸ä¸­å¿ƒ =====
        function switchApprovalType(type, btn) {
            // éš±è—æ‰€æœ‰å¯©æ ¸å…§å®¹
            document.querySelectorAll('.aprContent').forEach(el => el.style.display = 'none');
            // é‡è¨­æ‰€æœ‰é ‚å±¤ tab æ¨£å¼
            document.querySelectorAll('.aprTab').forEach(t => {
                t.style.background = 'transparent';
                t.style.color = '#94A3B8';
                t.style.boxShadow = 'none';
            });
            // å•Ÿç”¨é¸ä¸­çš„ tab
            if (btn) {
                btn.style.background = '#fff';
                btn.style.color = '#4F46E5';
                btn.style.boxShadow = '0 1px 4px rgba(0,0,0,0.08)';
            }
            // é¡¯ç¤ºå°æ‡‰å…§å®¹
            const map = { leave: 'aprLeave', makeup: 'aprMakeup', overtime: 'aprOvertime', swap: 'aprSwap' };
            const target = document.getElementById(map[type]);
            if (target) target.style.display = 'block';
            // è¼‰å…¥è³‡æ–™
            if (type === 'leave') loadLeaveApprovals('pending');
            if (type === 'makeup') loadMakeupApprovals('pending');
            if (type === 'overtime') loadOtApprovals('pending');
            if (type === 'swap') loadSwapApprovals();
        }

        // è«‹å‡å¯©æ ¸
        function switchLeaveTab(status) {
            document.querySelectorAll('#leaveApprovalTabs .tab-btn').forEach(btn => {
                btn.className = 'tab-btn inactive';
            });
            event.target.className = 'tab-btn active';
            loadLeaveApprovals(status);
        }

        async function loadLeaveApprovals(status) {
            const listEl = document.getElementById('leaveApprovalList');
            if (!listEl) return;

            try {
                const { data, error } = await sb.from('leave_requests')
                    .select(`*, employees!leave_requests_employee_id_fkey(name, employee_number, department)`)
                    .eq('status', status)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const typeMap = { 'annual': 'ç‰¹ä¼‘', 'sick': 'ç—…å‡', 'personal': 'äº‹å‡', 'compensatory': 'è£œä¼‘' };
                const statusText = { 'pending': 'å¾…å¯©æ ¸', 'approved': 'å·²é€šé', 'rejected': 'å·²æ‹’çµ•' };

                let html = '';
                (data || []).forEach(request => {
                    html += `
                        <div class="attendance-item">
                            <div class="date">
                                <span>${request.employees?.name || 'æœªçŸ¥'} - ${typeMap[request.leave_type] || request.leave_type}</span>
                                <span style="font-size:12px;color:#999;">${request.created_at?.split('T')[0] || ''}</span>
                            </div>
                            <div class="details">
                                <span>${request.start_date} ~ ${request.end_date}</span>
                                <span>${request.employees?.department || '-'}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                ${request.reason || 'ç„¡åŸå› '}
                            </div>
                            ${request.status === 'rejected' && request.rejection_reason ? `
                                <div style="font-size:12px;color:#DC2626;margin-top:6px;padding:8px 10px;background:#FEF2F2;border-radius:8px;">
                                    âŒ æ‹’çµ•åŸå› ï¼š${request.rejection_reason}
                                </div>
                            ` : ''}
                            ${status === 'pending' ? `
                                <div style="margin-top:8px;display:flex;gap:6px;">
                                    <button class="btn-success" onclick="approveLeave('${request.id}', 'approved')" style="flex:1;font-size:12px;padding:8px;border:none;border-radius:8px;cursor:pointer;">
                                        âœ… é€šé
                                    </button>
                                    <button class="btn-danger" onclick="approveLeave('${request.id}', 'rejected')" style="flex:1;font-size:12px;padding:8px;">
                                        âŒ æ‹’çµ•
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                listEl.innerHTML = html || `<p style="text-align:center;color:#999;">ç„¡${statusText[status] || ''}çš„è«‹å‡ç”³è«‹</p>`;

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        async function approveLeave(requestId, newStatus) {
            // æ‹’çµ•æ™‚è¦æ±‚å¡«åŸå› 
            let rejectionReason = null;
            if (newStatus === 'rejected') {
                rejectionReason = prompt('è«‹è¼¸å…¥æ‹’çµ•åŸå› ï¼ˆé¸å¡«ï¼‰ï¼š');
                if (rejectionReason === null) return; // æŒ‰å–æ¶ˆ = ä¸æ“ä½œ
            }

            try {
                const updateData = { 
                    status: newStatus,
                    approver_id: currentAdminEmployee.id,
                    approved_at: new Date().toISOString()
                };
                if (newStatus === 'rejected') {
                    updateData.rejection_reason = rejectionReason || 'ä¸ç¬¦åˆè¦å®š';
                }

                // å…ˆæŸ¥è«‹å‡è³‡è¨Šï¼ˆç”¨æ–¼é€šçŸ¥ï¼‰
                const { data: reqData } = await sb.from('leave_requests')
                    .select('*, employees(name, id)')
                    .eq('id', requestId).single();

                const { error } = await sb.from('leave_requests')
                    .update(updateData)
                    .eq('id', requestId);

                if (error) throw error;

                // LINE Notify é€šçŸ¥å“¡å·¥
                if (reqData?.employees?.id) {
                    const typeMap = { annual:'ç‰¹ä¼‘', sick:'ç—…å‡', personal:'äº‹å‡', compensatory:'è£œä¼‘' };
                    const typeName = typeMap[reqData.leave_type] || reqData.leave_type;
                    if (newStatus === 'approved') {
                        sendUserNotify(reqData.employees.id, `âœ… æ‚¨çš„${typeName}ç”³è«‹å·²é€šé\nğŸ“… ${reqData.start_date} ~ ${reqData.end_date}`);
                    } else {
                        sendUserNotify(reqData.employees.id, `âŒ æ‚¨çš„${typeName}ç”³è«‹å·²è¢«æ‹’çµ•\nğŸ“… ${reqData.start_date} ~ ${reqData.end_date}\nåŸå› ï¼š${updateData.rejection_reason}`);
                    }
                }

                showToast(`âœ… è«‹å‡ç”³è«‹å·²${newStatus === 'approved' ? 'é€šé' : 'æ‹’çµ•'}`);
                writeAuditLog(newStatus === 'approved' ? 'approve' : 'reject', 'leave_requests', requestId, reqData?.employees?.name);
                loadLeaveApprovals('pending');

            } catch (err) {
                console.error(err);
                showToast('âŒ å¯©æ ¸å¤±æ•—: ' + friendlyError(err));
            }
        }

        // ===== äººåŠ›ç®¡ç† â€” é ç±¤åˆ‡æ› =====
        function switchStaffTab(tab) {
            document.querySelectorAll('.staffTabContent').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.smTab').forEach(btn => {
                btn.style.background = 'transparent'; btn.style.color = '#94A3B8'; btn.style.boxShadow = 'none';
            });
            const tabEl = document.getElementById({ shift:'tabShift', leave:'tabLeave', setting:'tabSetting' }[tab]);
            if (tabEl) tabEl.style.display = 'block';
            const btns = document.querySelectorAll('.smTab');
            const idx = { shift:0, leave:1, setting:2 }[tab];
            if (btns[idx]) { btns[idx].style.background = '#fff'; btns[idx].style.color = '#4F46E5'; btns[idx].style.boxShadow = '0 1px 4px rgba(0,0,0,0.08)'; }
            if (tab === 'leave') loadLeaveCal();
            if (tab === 'shift') loadShiftMgr();
            if (tab === 'setting') { loadMaxLeaveSetting(); loadStaffOverview(); }
        }

        // ===== äººåŠ›è¨­å®š =====
        let maxLeaveValue = 2;

        function adjustMaxLeave(d) {
            maxLeaveValue = Math.max(1, Math.min(10, maxLeaveValue + d));
            document.getElementById('maxLeaveNum').textContent = maxLeaveValue;
        }

        async function loadMaxLeaveSetting() {
            try {
                const { data } = await sb.from('system_settings').select('value').eq('key', 'max_concurrent_leave').maybeSingle();
                if (data?.value?.max) { maxLeaveValue = data.value.max; }
            } catch(e) {}
            document.getElementById('maxLeaveNum').textContent = maxLeaveValue;
        }

        async function saveMaxLeave() {
            const statusEl = document.getElementById('maxLeaveSaveStatus');
            try {
                const { data: existing } = await sb.from('system_settings').select('id').eq('key', 'max_concurrent_leave').maybeSingle();
                const val = { max: maxLeaveValue };
                if (existing) {
                    await sb.from('system_settings').update({ value: val, updated_at: new Date().toISOString() }).eq('key', 'max_concurrent_leave');
                } else {
                    await sb.from('system_settings').insert({ key: 'max_concurrent_leave', value: val, description: 'åŒæ™‚è«‹å‡äººæ•¸ä¸Šé™' });
                }
                statusEl.style.display = 'block'; statusEl.style.color = '#059669'; statusEl.textContent = 'âœ… å·²å„²å­˜';
                setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
            } catch(e) {
                statusEl.style.display = 'block'; statusEl.style.color = '#DC2626'; statusEl.textContent = 'âŒ å„²å­˜å¤±æ•—';
            }
        }

        // ===== æ’ç­æ¨¡å¼è¨­å®š =====
        let currentSchedulingMode = 'shift'; // é è¨­æ’ç­åˆ¶
        let fixedShiftStart = '08:00';
        let fixedShiftEnd = '17:00';

        async function loadSchedulingMode() {
            try {
                const { data } = await sb.from('system_settings').select('value').eq('key', 'scheduling_mode').maybeSingle();
                if (data?.value?.mode) { currentSchedulingMode = data.value.mode; }
                if (data?.value?.start) { fixedShiftStart = data.value.start; }
                if (data?.value?.end) { fixedShiftEnd = data.value.end; }
            } catch(e) {}
            const startEl = document.getElementById('fixedStartTime');
            const endEl = document.getElementById('fixedEndTime');
            if (startEl) startEl.value = fixedShiftStart;
            if (endEl) endEl.value = fixedShiftEnd;
            applySchedulingModeUI();
        }

        function selectSchedulingMode(mode) {
            currentSchedulingMode = mode;
            applySchedulingModeUI();
        }

        function setFixedPreset(start, end) {
            document.getElementById('fixedStartTime').value = start;
            document.getElementById('fixedEndTime').value = end;
            document.querySelectorAll('.fixedPresetBtn').forEach(b => { b.style.background = '#fff'; b.style.border = '1px solid #E5E7EB'; });
            event.target.closest('.fixedPresetBtn').style.background = '#EEF2FF';
            event.target.closest('.fixedPresetBtn').style.border = '2px solid #4F46E5';
        }

        function applySchedulingModeUI() {
            const shiftEl = document.getElementById('modeShift');
            const fixedEl = document.getElementById('modeFixed');
            const shiftLabel = document.getElementById('modeShiftLabel');
            const fixedLabel = document.getElementById('modeFixedLabel');
            const fixedConfig = document.getElementById('fixedShiftConfig');
            if (!shiftEl || !fixedEl) return;
            if (currentSchedulingMode === 'shift') {
                shiftEl.style.border = '2px solid #4F46E5'; shiftEl.style.background = '#EEF2FF';
                if (shiftLabel) shiftLabel.style.color = '#4F46E5';
                fixedEl.style.border = '2px solid #E5E7EB'; fixedEl.style.background = '#fff';
                if (fixedLabel) fixedLabel.style.color = '#94A3B8';
                if (fixedConfig) fixedConfig.style.display = 'none';
            } else {
                fixedEl.style.border = '2px solid #4F46E5'; fixedEl.style.background = '#EEF2FF';
                if (fixedLabel) fixedLabel.style.color = '#4F46E5';
                shiftEl.style.border = '2px solid #E5E7EB'; shiftEl.style.background = '#fff';
                if (shiftLabel) shiftLabel.style.color = '#94A3B8';
                if (fixedConfig) fixedConfig.style.display = 'block';
            }
            applyShiftTabMode();
        }

        function applyShiftTabMode() {
            const shiftContent = document.getElementById('tabShift');
            if (!shiftContent) return;
            let notice = document.getElementById('fixedModeNotice');
            if (currentSchedulingMode === 'fixed') {
                const st = document.getElementById('fixedStartTime')?.value || fixedShiftStart;
                const et = document.getElementById('fixedEndTime')?.value || fixedShiftEnd;
                if (!notice) {
                    notice = document.createElement('div');
                    notice.id = 'fixedModeNotice';
                    notice.style.cssText = 'background:#EEF2FF;border-radius:14px;padding:20px;text-align:center;';
                    shiftContent.insertBefore(notice, shiftContent.firstChild);
                }
                notice.innerHTML = '<div style="font-size:32px;margin-bottom:8px;">â˜€ï¸</div>' +
                    '<div style="font-size:15px;font-weight:800;color:#4F46E5;margin-bottom:8px;">å›ºå®šç­åˆ¶</div>' +
                    '<div style="font-size:13px;color:#64748B;line-height:1.6;">æ‰€æœ‰å“¡å·¥çµ±ä¸€ä¸Šç­æ™‚é–“<br><b>' + st + ' - ' + et + '</b></div>' +
                    '<div style="font-size:11px;color:#94A3B8;margin-top:12px;">å¦‚éœ€æ’ç­è«‹è‡³ã€ŒäººåŠ›è¨­å®šã€åˆ‡æ›ç‚ºæ’ç­åˆ¶</div>';
                notice.style.display = 'block';
                Array.from(shiftContent.children).forEach(el => {
                    if (el.id !== 'fixedModeNotice') el.style.display = 'none';
                });
            } else {
                if (notice) notice.style.display = 'none';
                Array.from(shiftContent.children).forEach(el => {
                    if (el.id !== 'fixedModeNotice') el.style.display = '';
                });
            }
        }

        async function saveSchedulingMode() {
            const statusEl = document.getElementById('schedModeSaveStatus');
            try {
                const st = document.getElementById('fixedStartTime')?.value || '08:00';
                const et = document.getElementById('fixedEndTime')?.value || '17:00';
                fixedShiftStart = st; fixedShiftEnd = et;
                const { data: existing } = await sb.from('system_settings').select('id').eq('key', 'scheduling_mode').maybeSingle();
                const val = { mode: currentSchedulingMode, start: st, end: et };
                if (existing) {
                    await sb.from('system_settings').update({ value: val, updated_at: new Date().toISOString() }).eq('key', 'scheduling_mode');
                } else {
                    await sb.from('system_settings').insert({ key: 'scheduling_mode', value: val, description: 'æ’ç­æ¨¡å¼ï¼šshift=æ’ç­åˆ¶, fixed=å›ºå®šç­' });
                }
                const modeLabel = currentSchedulingMode === 'shift' ? 'æ’ç­åˆ¶' : `å›ºå®šç­ ${st}-${et}`;
                statusEl.style.display = 'block'; statusEl.style.color = '#059669';
                statusEl.textContent = 'âœ… å·²å„²å­˜ â€” ' + modeLabel;
                setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
                applyShiftTabMode();
                if (typeof writeAuditLog === 'function') writeAuditLog('update_scheduling_mode', val);
            } catch(e) {
                statusEl.style.display = 'block'; statusEl.style.color = '#DC2626'; statusEl.textContent = 'âŒ å„²å­˜å¤±æ•—';
            }
        }

        // ===== ä¾¿ç•¶ç®¡ç†å“¡è¨­å®š =====
        let lunchManagerIds = [];

        async function loadLunchManagers() {
            try {
                const { data } = await sb.from('system_settings').select('value').eq('key', 'lunch_managers').maybeSingle();
                lunchManagerIds = data?.value?.employee_ids || [];
            } catch(e) { lunchManagerIds = []; }

            const sel = document.getElementById('lunchMgrSelect');
            if (!sel) return;
            try {
                const { data: emps } = await sb.from('employees').select('id, name, employee_number').eq('is_active', true).order('name');
                sel.innerHTML = '<option value="">-- é¸æ“‡å“¡å·¥ --</option>';
                (emps || []).forEach(e => {
                    if (!lunchManagerIds.includes(e.id)) {
                        sel.innerHTML += `<option value="${e.id}">${escapeHTML(e.name)}ï¼ˆ${escapeHTML(e.employee_number)}ï¼‰</option>`;
                    }
                });
            } catch(e) {}
            renderLunchManagerList();
        }

        function renderLunchManagerList() {
            const el = document.getElementById('lunchMgrList');
            if (!el) return;
            if (lunchManagerIds.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:12px;">å°šæœªæŒ‡å®šä¾¿ç•¶ç®¡ç†å“¡</p>';
                return;
            }
            sb.from('employees').select('id, name, employee_number').in('id', lunchManagerIds).then(({ data }) => {
                if (!data || data.length === 0) { el.innerHTML = '<p style="color:#94A3B8;">ç„¡è³‡æ–™</p>'; return; }
                el.innerHTML = data.map(e => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #F1F5F9;">
                        <span>ğŸ± ${escapeHTML(e.name)}ï¼ˆ${escapeHTML(e.employee_number)}ï¼‰</span>
                        <button onclick="removeLunchManager('${e.id}')" style="font-size:12px;padding:4px 10px;border:1px solid #FCA5A5;border-radius:8px;background:#FEF2F2;color:#DC2626;cursor:pointer;">ç§»é™¤</button>
                    </div>
                `).join('');
            });
        }

        async function addLunchManager() {
            const sel = document.getElementById('lunchMgrSelect');
            if (!sel?.value) return showToast('è«‹é¸æ“‡å“¡å·¥');
            lunchManagerIds.push(sel.value);
            await saveLunchManagers();
            loadLunchManagers();
        }

        async function removeLunchManager(empId) {
            lunchManagerIds = lunchManagerIds.filter(id => id !== empId);
            await saveLunchManagers();
            loadLunchManagers();
        }

        async function saveLunchManagers() {
            try {
                const val = { employee_ids: lunchManagerIds };
                const { data: existing } = await sb.from('system_settings').select('id').eq('key', 'lunch_managers').maybeSingle();
                if (existing) {
                    await sb.from('system_settings').update({ value: val, updated_at: new Date().toISOString() }).eq('key', 'lunch_managers');
                } else {
                    await sb.from('system_settings').insert({ key: 'lunch_managers', value: val, description: 'ä¾¿ç•¶ç®¡ç†å“¡åå–®' });
                }
                invalidateSettingsCache();
                showToast('âœ… ä¾¿ç•¶ç®¡ç†å“¡å·²æ›´æ–°');
            } catch(e) {
                showToast('âŒ å„²å­˜å¤±æ•—');
            }
        }

        async function loadAdminLunchStats() {
            const el = document.getElementById('adminLunchStats');
            if (!el) return;
            const todayStr = getTaiwanDate(0);
            try {
                const { data } = await sb.from('lunch_orders')
                    .select('id, is_vegetarian, status')
                    .eq('order_date', todayStr);
                const orders = (data || []).filter(o => o.status === 'ordered');
                const veg = orders.filter(o => o.is_vegetarian).length;
                const regular = orders.filter(o => !o.is_vegetarian).length;
                const cancelled = (data || []).filter(o => o.status === 'cancelled').length;
                el.innerHTML = `
                    <div style="display:flex;gap:8px;">
                        <div style="flex:1;text-align:center;padding:12px;background:#ECFDF5;border-radius:10px;">
                            <div style="font-size:22px;font-weight:900;color:#059669;">${orders.length}</div>
                            <div style="font-size:11px;font-weight:600;color:#059669;">å·²è¨‚è³¼</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:12px;background:#EFF6FF;border-radius:10px;">
                            <div style="font-size:22px;font-weight:900;color:#2563EB;">${regular}</div>
                            <div style="font-size:11px;font-weight:600;color:#2563EB;">ğŸ– è‘·é£Ÿ</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:12px;background:#F5F3FF;border-radius:10px;">
                            <div style="font-size:22px;font-weight:900;color:#7C3AED;">${veg}</div>
                            <div style="font-size:11px;font-weight:600;color:#7C3AED;">ğŸ¥— ç´ é£Ÿ</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:12px;background:#FEF2F2;border-radius:10px;">
                            <div style="font-size:22px;font-weight:900;color:#DC2626;">${cancelled}</div>
                            <div style="font-size:11px;font-weight:600;color:#DC2626;">ğŸš« ä¸è¨‚</div>
                        </div>
                    </div>`;
            } catch(e) { el.innerHTML = '<p style="color:#94A3B8;">è¼‰å…¥å¤±æ•—</p>'; }
        }

        async function loadStaffOverview() {
            const el = document.getElementById('staffOverview');
            if (!el) return;
            try {
                const { data: emps } = await sb.from('employees').select('id, is_active').eq('is_active', true);
                const total = emps?.length || 0;
                if (total === 0) {
                    el.innerHTML = `
                        <div style="text-align:center;padding:12px;">
                            <div style="font-size:14px;font-weight:700;color:#64748B;margin-bottom:8px;">ç›®å‰æ²’æœ‰åœ¨è·å“¡å·¥</div>
                            <button onclick="showPage('employeePage')" style="padding:10px 20px;border:none;border-radius:8px;background:#4F46E5;color:#fff;font-weight:700;font-size:13px;cursor:pointer;">ğŸ‘‰ å‰å¾€æ–°å¢å“¡å·¥</button>
                        </div>`;
                    return;
                }
                const todayStr = getTaiwanDate();
                const { data: todayLeaves } = await sb.from('leave_requests').select('id')
                    .in('status', ['approved','pending'])
                    .lte('start_date', todayStr).gte('end_date', todayStr);
                const onLeave = todayLeaves?.length || 0;
                el.innerHTML = `
                    <div style="display:flex;gap:8px;margin-bottom:8px;">
                        <span style="padding:6px 12px;background:#ECFDF5;border-radius:8px;font-weight:700;color:#059669;">ğŸ‘¥ åœ¨è· ${total} äºº</span>
                        <span style="padding:6px 12px;background:#FFF7ED;border-radius:8px;font-weight:700;color:#EA580C;">ğŸ–ï¸ ä»Šæ—¥è«‹å‡ ${onLeave} äºº</span>
                        <span style="padding:6px 12px;background:#EFF6FF;border-radius:8px;font-weight:700;color:#2563EB;">ğŸ’ª ä»Šæ—¥å¯ç”¨ ${total - onLeave} äºº</span>
                    </div>
                    <div style="font-size:12px;color:#94A3B8;">ç›®å‰è¨­å®šï¼šåŒæ™‚æœ€å¤š <b style="color:#DC2626;">${maxLeaveValue}</b> äººè«‹å‡</div>
                `;
            } catch(e) { el.textContent = 'è¼‰å…¥å¤±æ•—'; }
        }

        // ===== ä¼‘å‡æœˆè¡¨ =====
        let lcYear, lcMonth;
        (function() { const n = new Date(); lcYear = n.getFullYear(); lcMonth = n.getMonth(); })();

        function changeLeaveCal(d) {
            lcMonth += d;
            if (lcMonth < 0) { lcMonth = 11; lcYear--; }
            if (lcMonth > 11) { lcMonth = 0; lcYear++; }
            loadLeaveCal();
        }
        function resetLeaveCal() {
            const n = new Date(); lcYear = n.getFullYear(); lcMonth = n.getMonth();
            loadLeaveCal();
        }

        async function loadLeaveCal() {
            document.getElementById('lcMonthLabel').textContent = `${lcYear}å¹´ ${lcMonth + 1}æœˆ`;
            // Loading ç‹€æ…‹
            document.getElementById('lcBody').innerHTML = '<tr><td colspan="32" style="text-align:center;padding:30px;color:#94A3B8;font-size:13px;">â³ è¼‰å…¥ä¸­...</td></tr>';
            document.getElementById('lcHead').innerHTML = '';
            const dim = new Date(lcYear, lcMonth + 1, 0).getDate();
            const ms = `${lcYear}-${String(lcMonth + 1).padStart(2, '0')}-01`;
            const me = `${lcYear}-${String(lcMonth + 1).padStart(2, '0')}-${dim}`;

            // è®€å–ä¸Šé™
            let maxC = maxLeaveValue || 2;
            try {
                const { data: s } = await sb.from('system_settings').select('value').eq('key', 'max_concurrent_leave').maybeSingle();
                if (s?.value?.max) maxC = s.value.max;
            } catch(e) {}
            document.getElementById('lcMax').textContent = maxC;

            let employees = [], leaves = [];
            try {
                const { data: emps } = await sb.from('employees').select('id, name, department').eq('is_active', true).order('department').order('name');
                employees = emps || [];
                const { data: lvs } = await sb.from('leave_requests').select('employee_id, start_date, end_date, leave_type, status')
                    .in('status', ['approved', 'pending']).or(`and(start_date.lte.${me},end_date.gte.${ms})`);
                leaves = lvs || [];
            } catch(e) { console.error(e); }

            // ç©ºç‹€æ…‹
            if (employees.length === 0) {
                document.getElementById('lcHead').innerHTML = '';
                document.getElementById('lcBody').innerHTML = `<tr><td style="text-align:center;padding:40px 20px;">
                    <div style="font-size:48px;margin-bottom:12px;">ğŸ‘¥</div>
                    <div style="font-size:14px;font-weight:800;color:#0F172A;">å°šç„¡å“¡å·¥è³‡æ–™</div>
                    <div style="font-size:12px;color:#94A3B8;margin-top:6px;">è«‹å…ˆåˆ°ã€Œå“¡å·¥ç®¡ç†ã€æ–°å¢å“¡å·¥</div>
                </td></tr>`;
                document.getElementById('lcTotal').textContent = '0';
                document.getElementById('lcAvail').textContent = '0';
                document.getElementById('lcOverWarn').style.display = 'none';
                return;
            }

            const wd = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            // è¨ˆç®—æ¯å¤©è«‹å‡äººæ•¸
            const dayCount = {};
            for (let d = 1; d <= dim; d++) {
                const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                dayCount[ds] = 0;
                leaves.forEach(l => { if (ds >= l.start_date && ds <= (l.end_date || l.start_date)) dayCount[ds]++; });
            }

            // è¡¨é ­
            let headHtml = '<tr><th style="position:sticky;left:0;background:#fff;z-index:2;padding:6px 8px;min-width:60px;text-align:left;border-bottom:2px solid #E5E7EB;font-size:11px;">å§“å</th>';
            for (let d = 1; d <= dim; d++) {
                const dt = new Date(lcYear, lcMonth, d);
                const isW = dt.getDay()===0 || dt.getDay()===6;
                const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const over = dayCount[ds] >= maxC && !isW;
                const bg = over ? '#FEE2E2' : isW ? '#F1F5F9' : '#fff';
                headHtml += `<th style="padding:4px 2px;min-width:28px;text-align:center;border-bottom:2px solid ${over?'#FCA5A5':'#E5E7EB'};background:${bg};font-size:10px;">
                    <div style="${over?'color:#DC2626;font-weight:900;':''}">${d}</div><div style="color:#94A3B8;font-size:9px;">${wd[dt.getDay()]}</div>
                    ${over ? '<div style="font-size:8px;color:#DC2626;font-weight:900;">æ»¿</div>' : ''}
                </th>`;
            }
            headHtml += '</tr>';
            document.getElementById('lcHead').innerHTML = headHtml;

            // è¡¨èº«
            const typeColor = { annual:'#DBEAFE', sick:'#FEE2E2', personal:'#FEF3C7', compensatory:'#E0E7FF' };
            const typeEmoji = { annual:'ğŸ–', sick:'ğŸ¤’', personal:'ğŸ“‹', compensatory:'ğŸ’¤' };
            let totalLeaves = 0;
            const todayStr = getTaiwanDate();
            let todayAvail = employees.length;
            let overDays = [];

            let bodyHtml = '';
            employees.forEach(emp => {
                const empLeaves = leaves.filter(l => l.employee_id === emp.id);
                bodyHtml += `<tr><td style="position:sticky;left:0;background:#fff;z-index:1;padding:6px 8px;font-weight:700;font-size:11px;white-space:nowrap;border-bottom:1px solid #F1F5F9;">${emp.name}</td>`;
                for (let d = 1; d <= dim; d++) {
                    const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const dt = new Date(lcYear, lcMonth, d);
                    const isW = dt.getDay()===0 || dt.getDay()===6;
                    const lv = empLeaves.find(l => ds >= l.start_date && ds <= (l.end_date || l.start_date));
                    const over = dayCount[ds] > maxC && !isW;
                    if (lv) {
                        totalLeaves++;
                        if (ds === todayStr) todayAvail--;
                        const bg = over ? '#FCA5A5' : (typeColor[lv.leave_type] || '#F1F5F9');
                        const emoji = typeEmoji[lv.leave_type] || 'ğŸ“';
                        const pending = lv.status === 'pending' ? 'opacity:0.6;' : '';
                        bodyHtml += `<td style="text-align:center;background:${bg};border-bottom:1px solid #F1F5F9;${pending}font-size:10px;cursor:default;" title="${emp.name} ${lv.leave_type}${lv.status==='pending'?' (å¾…å¯©)':''}${over?' âš è¶…é™':''}">${emoji}</td>`;
                    } else if (isW) {
                        bodyHtml += `<td style="background:#F8FAFC;border-bottom:1px solid #F1F5F9;"></td>`;
                    } else {
                        bodyHtml += `<td style="border-bottom:1px solid #F1F5F9;"></td>`;
                    }
                }
                bodyHtml += '</tr>';
            });

            // åº•éƒ¨çµ±è¨ˆåˆ— â€” æ¯æ—¥è«‹å‡äººæ•¸
            bodyHtml += '<tr style="background:#F8FAFC;"><td style="position:sticky;left:0;background:#F8FAFC;z-index:1;padding:6px 8px;font-weight:700;font-size:10px;color:#64748B;">è«‹å‡æ•¸</td>';
            for (let d = 1; d <= dim; d++) {
                const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dt = new Date(lcYear, lcMonth, d);
                const isW = dt.getDay()===0 || dt.getDay()===6;
                const cnt = dayCount[ds] || 0;
                const over = cnt >= maxC && !isW;
                if (over && !isW) overDays.push(`${lcMonth+1}/${d}`);
                bodyHtml += `<td style="text-align:center;font-size:10px;font-weight:900;color:${over?'#DC2626':cnt>0?'#EA580C':'#CBD5E1'};border-bottom:1px solid #F1F5F9;background:${over?'#FEF2F2':'#F8FAFC'};">${cnt||'-'}</td>`;
            }
            bodyHtml += '</tr>';

            document.getElementById('lcBody').innerHTML = bodyHtml;
            document.getElementById('lcTotal').textContent = totalLeaves;
            document.getElementById('lcAvail').textContent = Math.max(0, todayAvail);

            // è¶…é™è­¦å‘Š
            const warnEl = document.getElementById('lcOverWarn');
            if (overDays.length > 0) {
                warnEl.style.display = 'block';
                warnEl.innerHTML = `ğŸš¨ ä»¥ä¸‹æ—¥æœŸè«‹å‡äººæ•¸å·²é”/è¶…éä¸Šé™ï¼ˆ${maxC}äººï¼‰ï¼š<br><b>${overDays.join('ã€')}</b><br><span style="font-size:11px;opacity:0.7;">å“¡å·¥åœ¨é€™äº›æ—¥æœŸæäº¤è«‹å‡å°‡è¢«è‡ªå‹•é§å›</span>`;
            } else {
                warnEl.style.display = 'none';
            }
        }

        // ===== è–ªè³‡ç™¼æ”¾ =====
        let payrollEmployees = [];
        let payrollAdjustments = {};   // { empId: { amount: 0, note: '' } }
        let payrollBrackets = [];
        let payrollIsPublished = false;

        function initPayrollPage() {
            const yEl = document.getElementById('payrollYear');
            const mEl = document.getElementById('payrollMonth');
            if (yEl.options.length > 0) return; // already init
            const now = new Date();
            const cy = now.getFullYear();
            for (let y = cy; y >= cy - 2; y--) yEl.innerHTML += `<option value="${y}">${y} å¹´</option>`;
            for (let m = 1; m <= 12; m++) mEl.innerHTML += `<option value="${m}">${m} æœˆ</option>`;
            // é è¨­ä¸Šæœˆ
            const prev = new Date(cy, now.getMonth() - 1, 1);
            yEl.value = prev.getFullYear();
            mEl.value = prev.getMonth() + 1;

            loadSalarySettingList();
        }

        function toggleSalarySettingPanel() {
            const panel = document.getElementById('salarySettingPanel');
            const arrow = document.getElementById('salaryPanelArrow');
            if (panel.style.display === 'none') {
                panel.style.display = 'block'; arrow.textContent = 'â–²';
            } else {
                panel.style.display = 'none'; arrow.textContent = 'â–¼';
            }
        }

        async function loadSalarySettingList() {
            const listEl = document.getElementById('salarySettingList');
            try {
                const [empRes, ssRes] = await Promise.all([
                    sb.from('employees').select('id, name, employee_number, department').eq('is_active', true).order('department'),
                    sb.from('salary_settings').select('employee_id, salary_type, base_salary').eq('is_current', true)
                ]);
                const ssMap = {};
                (ssRes.data || []).forEach(s => { ssMap[s.employee_id] = s; });
                const typeLabel = { monthly: 'æœˆè–ª', daily: 'æ—¥è–ª', hourly: 'æ™‚è–ª' };
                const emps = empRes.data || [];
                if (emps.length === 0) { listEl.innerHTML = '<p style="text-align:center;color:#94A3B8;">ç„¡å“¡å·¥</p>'; return; }

                listEl.innerHTML = emps.map(emp => {
                    const ss = ssMap[emp.id];
                    const salaryText = ss ? `${typeLabel[ss.salary_type] || 'æœˆè–ª'} ${formatNT(ss.base_salary)}` : '<span style="color:#EF4444;">æœªè¨­å®š</span>';
                    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 4px;border-bottom:1px solid #F1F5F9;">
                        <div>
                            <span style="font-weight:600;">${escapeHTML(emp.name)}</span>
                            <span style="color:#94A3B8;font-size:11px;margin-left:4px;">${emp.department || ''}</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:12px;color:#64748B;">${salaryText}</span>
                            <button onclick="openSalarySettingModal('${emp.id}','${escapeHTML(emp.name)}')" style="padding:4px 10px;border:1px solid #D1FAE5;border-radius:6px;background:#ECFDF5;font-size:11px;font-weight:700;cursor:pointer;color:#059669;">è¨­å®š</button>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) { listEl.innerHTML = '<p style="color:#EF4444;text-align:center;">è¼‰å…¥å¤±æ•—</p>'; console.error(e); }
        }

        async function loadPayrollData() {
            const year = parseInt(document.getElementById('payrollYear').value);
            const month = parseInt(document.getElementById('payrollMonth').value);
            const startDate = `${year}-${String(month).padStart(2,'0')}-01`;
            const endDay = new Date(year, month, 0).getDate();
            const endDate = `${year}-${String(month).padStart(2,'0')}-${String(endDay).padStart(2,'0')}`;

            // UI: show loading
            const loadEl = document.getElementById('payrollLoading');
            const sumEl = document.getElementById('payrollSummary');
            const selEl = document.getElementById('payrollEmpSelector');
            const actEl = document.getElementById('payrollActions');
            const contentEl = document.getElementById('payrollContent');
            const warnEl = document.getElementById('payrollPublishedWarn');
            loadEl.style.display = 'block';
            sumEl.style.display = 'none';
            selEl.style.display = 'none';
            actEl.style.display = 'none';
            contentEl.innerHTML = '';
            warnEl.style.display = 'none';
            payrollAdjustments = {};

            const btn = document.getElementById('calcPayrollBtn');
            const origText = btn.textContent;
            btn.disabled = true; btn.textContent = 'â³ è¨ˆç®—ä¸­...';

            try {
                // å¹³è¡ŒæŸ¥è©¢ï¼ˆOT å’Œä¿éšªç´šè·ç”¨ catch é¿å…è¡¨ä¸å­˜åœ¨å ±éŒ¯ï¼‰
                const [empRes, salaryRes, attRes, leaveRes, otRes, existRes, bracketRes] = await Promise.all([
                    sb.from('employees').select('id, name, employee_number, department, is_active').eq('is_active', true),
                    sb.from('salary_settings').select('*').eq('is_current', true),
                    sb.from('attendance').select('employee_id, date, is_late, total_work_hours, overtime_hours, check_in_time, check_out_time').gte('date', startDate).lte('date', endDate),
                    sb.from('leave_requests').select('employee_id, days, leave_type').eq('status', 'approved').gte('start_date', startDate).lte('end_date', endDate),
                    sb.from('overtime_requests').select('employee_id, hours, ot_date').eq('status', 'approved').gte('ot_date', startDate).lte('ot_date', endDate).then(r => r).catch(() => ({ data: [] })),
                    sb.from('payroll').select('*').eq('year', year).eq('month', month),
                    sb.from('insurance_brackets').select('*').eq('is_active', true).order('salary_min').then(r => r).catch(() => ({ data: [] }))
                ]);

                payrollBrackets = bracketRes.data || [];

                // Build lookup maps
                const salaryMap = {};
                (salaryRes.data || []).forEach(s => { salaryMap[s.employee_id] = s; });

                const attMap = {};
                (attRes.data || []).forEach(a => {
                    if (!attMap[a.employee_id]) attMap[a.employee_id] = [];
                    attMap[a.employee_id].push(a);
                });

                const leaveMap = {};
                (leaveRes.data || []).forEach(l => {
                    if (!leaveMap[l.employee_id]) leaveMap[l.employee_id] = { total: 0, personal: 0 };
                    leaveMap[l.employee_id].total += (l.days || 0);
                    if (l.leave_type === 'personal') leaveMap[l.employee_id].personal += (l.days || 0);
                });

                const otMap = {};
                if ((otRes.data || []).length > 0) {
                    // å¾åŠ ç­ç”³è«‹è¡¨å–å¾—æ ¸å‡†åŠ ç­æ™‚æ•¸
                    (otRes.data).forEach(o => {
                        otMap[o.employee_id] = (otMap[o.employee_id] || 0) + (o.hours || 0);
                    });
                } else {
                    // Fallback: å¾ attendance.overtime_hours ç´¯è¨ˆ
                    (attRes.data || []).forEach(a => {
                        if (a.overtime_hours > 0) {
                            otMap[a.employee_id] = (otMap[a.employee_id] || 0) + a.overtime_hours;
                        }
                    });
                }

                // å·²å­˜åœ¨çš„ payrollï¼ˆè¼‰å…¥æ‰‹å‹•èª¿æ•´ï¼‰
                const existMap = {};
                (existRes.data || []).forEach(p => {
                    existMap[p.employee_id] = p;
                    if (p.manual_adjustment) {
                        payrollAdjustments[p.employee_id] = { amount: p.manual_adjustment || 0, note: p.adjustment_note || '' };
                    }
                });

                // æª¢æŸ¥æ˜¯å¦å·²ç™¼å¸ƒ
                payrollIsPublished = (existRes.data || []).some(p => p.is_published);
                if (payrollIsPublished) warnEl.style.display = 'block';

                // è¨ˆç®—æ¯ä½å“¡å·¥
                payrollEmployees = (empRes.data || []).map(emp => {
                    const ss = salaryMap[emp.id];
                    if (!ss) return null; // ç„¡è–ªè³‡è¨­å®š skip

                    const atts = attMap[emp.id] || [];
                    const leaves = leaveMap[emp.id] || { total: 0, personal: 0 };
                    const otHours = otMap[emp.id] || 0;

                    return calcEmployeePayroll(emp, ss, atts, leaves, otHours, year, month);
                }).filter(Boolean);

                // æ¸²æŸ“
                populatePayrollDropdown();
                renderPayrollSummary();
                renderPayrollView();

                loadEl.style.display = 'none';
                sumEl.style.display = 'block';
                selEl.style.display = 'block';
                actEl.style.display = 'flex';
            } catch(e) {
                loadEl.style.display = 'none';
                contentEl.innerHTML = `<p style="text-align:center;color:#DC2626;padding:20px;">âŒ è¨ˆç®—å¤±æ•—ï¼š${e.message}</p>`;
            } finally {
                btn.disabled = false; btn.textContent = origText;
            }
        }

        function prLookupBracket(salary) {
            if (payrollBrackets.length === 0) return null;
            const b = payrollBrackets.find(r => salary >= r.salary_min && salary <= r.salary_max);
            return b || payrollBrackets[payrollBrackets.length - 1];
        }

        function calcEmployeePayroll(emp, ss, atts, leaves, otHours, year, month) {
            const salaryType = ss.salary_type || 'monthly';
            const baseSalary = ss.base_salary || 0;
            const mealAllowance = ss.meal_allowance || 0;
            const posAllowance = ss.position_allowance || 0;
            const fullAttBonus = ss.full_attendance_bonus || 0;
            const pensionRate = ss.pension_self_rate || 0;
            const taxRate = ss.tax_rate || 5;

            // å‡ºå‹¤çµ±è¨ˆ
            const actualDays = atts.filter(a => a.check_in_time).length;
            const lateCount = atts.filter(a => a.is_late).length;
            const totalWorkHours = atts.reduce((s, a) => s + (a.total_work_hours || 0), 0);
            const leaveDays = leaves.total;
            const personalLeaveDays = leaves.personal;

            // åº•è–ªè¨ˆç®—
            let monthSalary, dailyRate, hourlyRate;
            if (salaryType === 'monthly') {
                monthSalary = baseSalary;
                dailyRate = Math.round(baseSalary / 30);
                hourlyRate = Math.round(dailyRate / 8);
            } else if (salaryType === 'daily') {
                dailyRate = baseSalary;
                hourlyRate = Math.round(dailyRate / 8);
                monthSalary = dailyRate * actualDays;
            } else {
                hourlyRate = baseSalary;
                dailyRate = hourlyRate * 8;
                monthSalary = Math.round(hourlyRate * totalWorkHours);
            }

            // æ´¥è²¼ï¼ˆæš«ä»¥å›ºå®šæ–¹å¼è¨ˆç®—ï¼ŒTODO: æ”¯æ´ daily modeï¼‰
            const mealAmount = mealAllowance;
            const posAmount = posAllowance;

            // å…¨å‹¤çé‡‘
            const hasFullAtt = (lateCount === 0 && leaveDays === 0);
            const fullAttAmount = hasFullAtt ? fullAttBonus : 0;

            // åŠ ç­è²»ï¼ˆå°ç£å‹åŸºæ³• Â§24ï¼‰
            let otPay = 0;
            if (otHours > 0) {
                const h1 = Math.min(otHours, 2);
                const h2 = Math.max(Math.min(otHours - 2, 2), 0);
                otPay = Math.round(hourlyRate * 1.34 * h1) + Math.round(hourlyRate * 1.67 * h2);
            }

            // ç¸½æ”¶å…¥
            const gross = monthSalary + otPay + fullAttAmount + mealAmount + posAmount;

            // ä¿éšª
            const bracket = prLookupBracket(salaryType === 'monthly' ? baseSalary : monthSalary);
            let laborIns = 0, healthIns = 0;
            if (bracket) {
                laborIns = Math.round(bracket.insured_amount * (bracket.labor_rate || 0.125) * (bracket.labor_employee_share || 0.2));
                healthIns = Math.round(bracket.insured_amount * (bracket.health_rate || 0.0517) * (bracket.health_employee_share || 0.3));
            } else {
                laborIns = Math.round(monthSalary * 0.125 * 0.2);
                healthIns = Math.round(monthSalary * 0.0517 * 0.3);
            }

            // å‹é€€è‡ªæ
            const pensionSelf = Math.round(monthSalary * pensionRate / 100);

            // æ‰€å¾—ç¨…
            const incomeTax = Math.round(gross * taxRate / 100);

            // é²åˆ°æ‰£æ¬¾ï¼ˆæ¯æ¬¡ 100 å…ƒï¼Œå¯èª¿æ•´ï¼‰
            const lateDed = lateCount * 100;

            // äº‹å‡æ‰£æ¬¾ï¼ˆæ—¥è–ª Ã— å¤©æ•¸ï¼‰
            const personalLeaveDed = Math.round(dailyRate * personalLeaveDays);

            // æ‰‹å‹•èª¿æ•´
            const adj = payrollAdjustments[emp.id]?.amount || 0;

            // ç¸½æ‰£æ¬¾
            const totalDeduct = laborIns + healthIns + pensionSelf + incomeTax + lateDed + personalLeaveDed - adj;

            // å¯¦ç™¼
            const net = gross - totalDeduct;

            return {
                employee_id: emp.id,
                name: emp.name,
                employee_number: emp.employee_number,
                department: emp.department || '',
                year, month,
                salary_type: salaryType,
                base_salary: monthSalary,
                overtime_pay: otPay,
                full_attendance_bonus: fullAttAmount,
                meal_allowance: mealAmount,
                position_allowance: posAmount,
                night_allowance: 0,
                late_deduction: lateDed,
                absence_deduction: 0,
                personal_leave_deduction: personalLeaveDed,
                labor_insurance: laborIns,
                health_insurance: healthIns,
                pension_self: pensionSelf,
                income_tax: incomeTax,
                manual_adjustment: adj,
                adjustment_note: payrollAdjustments[emp.id]?.note || '',
                total_deduction: totalDeduct,
                gross_salary: gross,
                net_salary: net,
                calculation_details: {
                    salary_type: salaryType,
                    original_base: baseSalary,
                    actual_days: actualDays,
                    late_count: lateCount,
                    leave_days: leaveDays,
                    personal_leave_days: personalLeaveDays,
                    overtime_hours: otHours,
                    total_work_hours: Math.round(totalWorkHours * 10) / 10,
                    daily_rate: dailyRate,
                    hourly_rate: hourlyRate,
                    pension_self_rate: pensionRate,
                    tax_rate: taxRate,
                    full_attendance: hasFullAtt
                }
            };
        }

        function populatePayrollDropdown() {
            const sel = document.getElementById('payrollEmpDropdown');
            const prev = sel.value;
            sel.innerHTML = '<option value="_all">ğŸ“‹ å…¨éƒ¨å“¡å·¥ç¸½è¦½</option>';
            payrollEmployees.forEach(emp => {
                sel.innerHTML += `<option value="${emp.employee_id}">${emp.employee_number} ${emp.name}ï¼ˆ${emp.department}ï¼‰â€” ${formatNT(emp.net_salary)}</option>`;
            });
            if (prev) sel.value = prev;
        }

        function renderPayrollSummary() {
            const total = payrollEmployees.reduce((s, e) => s + e.net_salary, 0);
            const avg = payrollEmployees.length > 0 ? Math.round(total / payrollEmployees.length) : 0;
            document.getElementById('prEmpCount').textContent = payrollEmployees.length;
            document.getElementById('prTotalNet').textContent = formatNT(total);
            document.getElementById('prAvgNet').textContent = formatNT(avg);
            document.getElementById('prStatus').textContent = payrollIsPublished ? 'âœ… å·²ç™¼å¸ƒ' : 'ğŸ“ è‰ç¨¿';
        }

        function renderPayrollView() {
            const sel = document.getElementById('payrollEmpDropdown').value;
            if (sel === '_all') {
                renderAllPayrollTable();
            } else {
                renderPayrollCard(sel);
            }
        }

        function renderAllPayrollTable() {
            const el = document.getElementById('payrollContent');
            if (payrollEmployees.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;padding:20px;">ç„¡è³‡æ–™ï¼ˆè«‹ç¢ºèªå“¡å·¥å·²è¨­å®šè–ªè³‡ï¼‰</p>';
                return;
            }
            let html = '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:12px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.08);">';
            html += '<thead><tr style="background:#F1F5F9;">';
            html += '<th style="padding:10px 8px;text-align:left;font-weight:800;color:#475569;">å§“å</th>';
            html += '<th style="padding:10px 4px;text-align:right;font-weight:800;color:#475569;">åº•è–ª</th>';
            html += '<th style="padding:10px 4px;text-align:right;font-weight:800;color:#475569;">åŠ ç­</th>';
            html += '<th style="padding:10px 4px;text-align:right;font-weight:800;color:#475569;">æ‰£æ¬¾</th>';
            html += '<th style="padding:10px 8px;text-align:right;font-weight:800;color:#059669;">å¯¦ç™¼</th>';
            html += '</tr></thead><tbody>';

            payrollEmployees.forEach(emp => {
                html += `<tr onclick="document.getElementById('payrollEmpDropdown').value='${emp.employee_id}';renderPayrollView();" style="cursor:pointer;border-bottom:1px solid #F1F5F9;transition:background 0.15s;" onmouseover="this.style.background='#F8FAFC'" onmouseout="this.style.background=''">`;
                html += `<td style="padding:10px 8px;"><div style="font-weight:700;color:#0F172A;">${emp.name}</div><div style="font-size:11px;color:#94A3B8;">${emp.employee_number} Â· ${emp.department}</div></td>`;
                html += `<td style="padding:10px 4px;text-align:right;color:#334155;">${Math.round(emp.base_salary).toLocaleString()}</td>`;
                html += `<td style="padding:10px 4px;text-align:right;color:#0369A1;">${emp.overtime_pay > 0 ? '+' + Math.round(emp.overtime_pay).toLocaleString() : '-'}</td>`;
                html += `<td style="padding:10px 4px;text-align:right;color:#DC2626;">-${Math.round(emp.total_deduction).toLocaleString()}</td>`;
                html += `<td style="padding:10px 8px;text-align:right;font-weight:900;color:#059669;">${Math.round(emp.net_salary).toLocaleString()}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            el.innerHTML = html;
        }

        function renderPayrollCard(empId) {
            const el = document.getElementById('payrollContent');
            const emp = payrollEmployees.find(e => e.employee_id === empId);
            if (!emp) { el.innerHTML = '<p style="text-align:center;color:#94A3B8;">æ‰¾ä¸åˆ°æ­¤å“¡å·¥</p>'; return; }

            const cd = emp.calculation_details || {};
            const typeLabel = { monthly: 'æœˆè–ªåˆ¶', daily: 'æ—¥è–ªåˆ¶', hourly: 'æ™‚è–ªåˆ¶' };

            // æ”¶å…¥æ˜ç´°
            const incomeItems = [
                { label: 'åŸºæœ¬è–ªè³‡', value: emp.base_salary, desc: cd.salary_type === 'monthly' ? 'å›ºå®šæœˆè–ª' : cd.salary_type === 'daily' ? `æ—¥è–ª ${cd.original_base?.toLocaleString()} Ã— ${cd.actual_days}å¤©` : `æ™‚è–ª ${cd.original_base?.toLocaleString()} Ã— ${cd.total_work_hours}h` },
                { label: 'åŠ ç­è²»', value: emp.overtime_pay, desc: cd.overtime_hours > 0 ? `${cd.overtime_hours}å°æ™‚` : '' },
                { label: 'å…¨å‹¤çé‡‘', value: emp.full_attendance_bonus, desc: cd.full_attendance ? 'âœ… é”æˆ' : 'âŒ æœªé”æˆ' },
                { label: 'ä¼™é£Ÿæ´¥è²¼', value: emp.meal_allowance, desc: 'æ¯æœˆå›ºå®š' },
                { label: 'è·å‹™åŠ çµ¦', value: emp.position_allowance, desc: 'æ¯æœˆå›ºå®š' },
            ].filter(i => i.value > 0);

            // æ‰£æ¬¾æ˜ç´°
            const deductItems = [
                { label: 'å‹ä¿è‡ªä»˜', value: emp.labor_insurance, desc: 'æŠ•ä¿ç´šè·Ã—12.5%Ã—20%' },
                { label: 'å¥ä¿è‡ªä»˜', value: emp.health_insurance, desc: 'æŠ•ä¿ç´šè·Ã—5.17%Ã—30%' },
                { label: 'å‹é€€è‡ªæ', value: emp.pension_self, desc: cd.pension_self_rate > 0 ? `æœˆè–ªÃ—${cd.pension_self_rate}%` : '' },
                { label: 'æ‰€å¾—ç¨…', value: emp.income_tax, desc: `ç¸½æ”¶å…¥Ã—${cd.tax_rate}%` },
                { label: 'é²åˆ°æ‰£æ¬¾', value: emp.late_deduction, desc: cd.late_count > 0 ? `${cd.late_count}æ¬¡Ã—$100` : '' },
                { label: 'äº‹å‡æ‰£æ¬¾', value: emp.personal_leave_deduction, desc: cd.personal_leave_days > 0 ? `æ—¥è–ªÃ—${cd.personal_leave_days}å¤©` : '' },
            ].filter(i => i.value > 0);

            const totalIncome = incomeItems.reduce((s, i) => s + i.value, 0);
            const totalDeduct = deductItems.reduce((s, i) => s + i.value, 0);

            let html = `<div style="background:#fff;border-radius:16px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">`;

            // Header
            html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">`;
            html += `<div><div style="font-size:18px;font-weight:900;color:#0F172A;">${emp.name}</div><div style="font-size:12px;color:#94A3B8;">${emp.employee_number} Â· ${emp.department} Â· ${typeLabel[emp.salary_type] || emp.salary_type}</div></div>`;
            html += `<div style="text-align:right;"><div style="font-size:11px;color:#94A3B8;">å¯¦ç™¼è–ªè³‡</div><div style="font-size:22px;font-weight:900;color:#059669;">${formatNT(emp.net_salary)}</div></div>`;
            html += `</div>`;

            // å‡ºå‹¤æ‘˜è¦
            html += `<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;">`;
            html += `<div style="text-align:center;background:#F8FAFC;border-radius:10px;padding:10px;"><div style="font-size:11px;color:#94A3B8;">å‡ºå‹¤</div><div style="font-size:16px;font-weight:800;color:#0F172A;">${cd.actual_days}å¤©</div></div>`;
            html += `<div style="text-align:center;background:#F8FAFC;border-radius:10px;padding:10px;"><div style="font-size:11px;color:#94A3B8;">é²åˆ°</div><div style="font-size:16px;font-weight:800;color:${cd.late_count > 0 ? '#DC2626' : '#059669'};">${cd.late_count}æ¬¡</div></div>`;
            html += `<div style="text-align:center;background:#F8FAFC;border-radius:10px;padding:10px;"><div style="font-size:11px;color:#94A3B8;">è«‹å‡</div><div style="font-size:16px;font-weight:800;color:#0F172A;">${cd.leave_days}å¤©</div></div>`;
            html += `<div style="text-align:center;background:#F8FAFC;border-radius:10px;padding:10px;"><div style="font-size:11px;color:#94A3B8;">åŠ ç­</div><div style="font-size:16px;font-weight:800;color:#0369A1;">${cd.overtime_hours}h</div></div>`;
            html += `</div>`;

            // æ”¶å…¥
            html += `<div style="font-size:13px;font-weight:800;color:#059669;margin-bottom:8px;">ğŸ“ˆ æ”¶å…¥æ˜ç´°</div>`;
            incomeItems.forEach(i => {
                html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #F1F5F9;font-size:13px;">`;
                html += `<div><span style="color:#334155;">${i.label}</span><span style="color:#94A3B8;font-size:11px;margin-left:6px;">${i.desc}</span></div>`;
                html += `<div style="font-weight:700;color:#059669;">+${Math.round(i.value).toLocaleString()}</div>`;
                html += `</div>`;
            });
            html += `<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:14px;font-weight:800;color:#059669;border-top:2px solid #059669;margin-top:4px;">`;
            html += `<div>æ”¶å…¥å°è¨ˆ</div><div>${formatNT(totalIncome)}</div></div>`;

            // æ‰£æ¬¾
            html += `<div style="font-size:13px;font-weight:800;color:#DC2626;margin:16px 0 8px;">ğŸ“‰ æ‰£æ¬¾æ˜ç´°</div>`;
            deductItems.forEach(i => {
                html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #F1F5F9;font-size:13px;">`;
                html += `<div><span style="color:#334155;">${i.label}</span><span style="color:#94A3B8;font-size:11px;margin-left:6px;">${i.desc}</span></div>`;
                html += `<div style="font-weight:700;color:#DC2626;">-${Math.round(i.value).toLocaleString()}</div>`;
                html += `</div>`;
            });
            html += `<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:14px;font-weight:800;color:#DC2626;border-top:2px solid #DC2626;margin-top:4px;">`;
            html += `<div>æ‰£æ¬¾å°è¨ˆ</div><div>-${formatNT(totalDeduct)}</div></div>`;

            // æ‰‹å‹•èª¿æ•´
            html += `<div style="font-size:13px;font-weight:800;color:#7C3AED;margin:16px 0 8px;">âœï¸ æ‰‹å‹•èª¿æ•´</div>`;
            html += `<div style="display:flex;gap:8px;align-items:center;">`;
            html += `<input id="prAdj_${emp.employee_id}" type="text" inputmode="numeric" value="${(emp.manual_adjustment || 0) !== 0 ? emp.manual_adjustment.toLocaleString() : ''}" placeholder="æ­£æ•¸=åŠ çµ¦ï¼Œè² æ•¸=æ‰£æ¬¾" style="flex:1;padding:10px;border:1px solid #E5E7EB;border-radius:10px;font-size:13px;" onchange="updatePayrollAdjustment('${emp.employee_id}')">`;
            html += `<input id="prAdjNote_${emp.employee_id}" type="text" value="${emp.adjustment_note || ''}" placeholder="å‚™è¨»" style="width:120px;padding:10px;border:1px solid #E5E7EB;border-radius:10px;font-size:13px;" onchange="updatePayrollAdjustment('${emp.employee_id}')">`;
            html += `</div>`;

            html += `</div>`;
            el.innerHTML = html;

            // æ ¼å¼åŒ–é‡‘é¡è¼¸å…¥
            const adjEl = document.getElementById(`prAdj_${emp.employee_id}`);
            if (adjEl) {
                adjEl.addEventListener('input', function() {
                    const neg = this.value.startsWith('-');
                    const raw = this.value.replace(/[^\d]/g, '');
                    this.value = raw ? (neg ? '-' : '') + parseInt(raw, 10).toLocaleString() : '';
                });
            }
        }

        function updatePayrollAdjustment(empId) {
            const amtEl = document.getElementById(`prAdj_${empId}`);
            const noteEl = document.getElementById(`prAdjNote_${empId}`);
            const neg = amtEl.value.startsWith('-');
            const raw = parseInt(amtEl.value.replace(/[^\d]/g, ''), 10) || 0;
            const amount = neg ? -raw : raw;
            payrollAdjustments[empId] = { amount, note: noteEl.value || '' };

            // é‡æ–°è¨ˆç®—è©²å“¡å·¥
            const idx = payrollEmployees.findIndex(e => e.employee_id === empId);
            if (idx >= 0) {
                const old = payrollEmployees[idx];
                // manual_adjustment å½±éŸ¿ total_deduction å’Œ net_salary
                const adjDiff = amount - (old.manual_adjustment || 0);
                old.manual_adjustment = amount;
                old.adjustment_note = noteEl.value || '';
                old.total_deduction = old.total_deduction - adjDiff;
                old.net_salary = old.gross_salary - old.total_deduction;
                payrollEmployees[idx] = old;
            }

            // æ›´æ–°æ‘˜è¦å’Œä¸‹æ‹‰é¸å–®
            renderPayrollSummary();
            populatePayrollDropdown();
            // é‡è¨­ä¸‹æ‹‰åˆ°ç•¶å‰å“¡å·¥
            document.getElementById('payrollEmpDropdown').value = empId;
        }

        async function saveAllPayroll() {
            if (payrollEmployees.length === 0) { showToast('âš ï¸ ç„¡è³‡æ–™å¯å„²å­˜'); return; }
            const year = parseInt(document.getElementById('payrollYear').value);
            const month = parseInt(document.getElementById('payrollMonth').value);

            if (!confirm(`ç¢ºå®šå„²å­˜ ${year}å¹´${month}æœˆ å…± ${payrollEmployees.length} äººè–ªè³‡ï¼ˆè‰ç¨¿ï¼‰ï¼Ÿ`)) return;

            const btn = document.getElementById('savePayrollBtn');
            btn.disabled = true; btn.textContent = 'â³ å„²å­˜ä¸­...';

            try {
                const records = payrollEmployees.map(emp => ({
                    employee_id: emp.employee_id,
                    year: emp.year,
                    month: emp.month,
                    salary_type: emp.salary_type,
                    base_salary: emp.base_salary,
                    overtime_pay: emp.overtime_pay,
                    bonus: 0,
                    full_attendance_bonus: emp.full_attendance_bonus,
                    meal_allowance: emp.meal_allowance,
                    position_allowance: emp.position_allowance,
                    night_allowance: emp.night_allowance,
                    late_deduction: emp.late_deduction,
                    absence_deduction: emp.absence_deduction,
                    personal_leave_deduction: emp.personal_leave_deduction,
                    labor_insurance: emp.labor_insurance,
                    health_insurance: emp.health_insurance,
                    pension_self: emp.pension_self,
                    income_tax: emp.income_tax,
                    manual_adjustment: emp.manual_adjustment,
                    adjustment_note: emp.adjustment_note,
                    total_deduction: emp.total_deduction,
                    gross_salary: emp.gross_salary,
                    net_salary: emp.net_salary,
                    calculation_details: emp.calculation_details,
                    is_published: false,
                    updated_at: new Date().toISOString()
                }));

                const { error } = await sb.from('payroll').upsert(records, { onConflict: 'employee_id,year,month' });
                if (error) throw error;

                if (typeof writeAuditLog === 'function') {
                    writeAuditLog('save_payroll', 'payroll', null, `${year}å¹´${month}æœˆè–ªè³‡è‰ç¨¿`, {
                        count: records.length,
                        total: records.reduce((s, r) => s + r.net_salary, 0)
                    });
                }

                payrollIsPublished = false;
                renderPayrollSummary();
                showToast(`âœ… å·²å„²å­˜ ${records.length} ç­†è–ªè³‡ï¼ˆè‰ç¨¿ï¼‰`);
            } catch(e) {
                showToast('âŒ å„²å­˜å¤±æ•—ï¼š' + (typeof friendlyError === 'function' ? friendlyError(e) : e.message));
            } finally {
                btn.disabled = false; btn.textContent = 'ğŸ’¾ å„²å­˜å…¨éƒ¨ï¼ˆè‰ç¨¿ï¼‰';
            }
        }

        async function publishPayroll() {
            if (payrollEmployees.length === 0) { showToast('âš ï¸ è«‹å…ˆè¨ˆç®—ä¸¦å„²å­˜è–ªè³‡'); return; }
            const year = parseInt(document.getElementById('payrollYear').value);
            const month = parseInt(document.getElementById('payrollMonth').value);

            if (!confirm(`âš ï¸ ç¢ºå®šç™¼å¸ƒ ${year}å¹´${month}æœˆ è–ªè³‡ï¼Ÿ\n\nç™¼å¸ƒå¾Œå“¡å·¥å°‡åœ¨è–ªè³‡é é¢çœ‹åˆ°æ˜ç´°ã€‚`)) return;

            const btn = document.getElementById('publishPayrollBtn');
            btn.disabled = true; btn.textContent = 'â³ ç™¼å¸ƒä¸­...';

            try {
                // å…ˆç¢ºä¿å·²å„²å­˜
                const records = payrollEmployees.map(emp => ({
                    employee_id: emp.employee_id,
                    year: emp.year,
                    month: emp.month,
                    salary_type: emp.salary_type,
                    base_salary: emp.base_salary,
                    overtime_pay: emp.overtime_pay,
                    bonus: 0,
                    full_attendance_bonus: emp.full_attendance_bonus,
                    meal_allowance: emp.meal_allowance,
                    position_allowance: emp.position_allowance,
                    night_allowance: emp.night_allowance,
                    late_deduction: emp.late_deduction,
                    absence_deduction: emp.absence_deduction,
                    personal_leave_deduction: emp.personal_leave_deduction,
                    labor_insurance: emp.labor_insurance,
                    health_insurance: emp.health_insurance,
                    pension_self: emp.pension_self,
                    income_tax: emp.income_tax,
                    manual_adjustment: emp.manual_adjustment,
                    adjustment_note: emp.adjustment_note,
                    total_deduction: emp.total_deduction,
                    gross_salary: emp.gross_salary,
                    net_salary: emp.net_salary,
                    calculation_details: emp.calculation_details,
                    is_published: true,
                    updated_at: new Date().toISOString()
                }));

                const { error } = await sb.from('payroll').upsert(records, { onConflict: 'employee_id,year,month' });
                if (error) throw error;

                if (typeof writeAuditLog === 'function') {
                    writeAuditLog('publish_payroll', 'payroll', null, `${year}å¹´${month}æœˆè–ªè³‡ç™¼å¸ƒ`, {
                        count: records.length,
                        total: records.reduce((s, r) => s + r.net_salary, 0)
                    });
                }

                payrollIsPublished = true;
                renderPayrollSummary();
                document.getElementById('payrollPublishedWarn').style.display = 'block';
                showToast(`âœ… ${year}å¹´${month}æœˆ è–ªè³‡å·²ç™¼å¸ƒï¼ˆ${records.length} äººï¼‰`);
            } catch(e) {
                showToast('âŒ ç™¼å¸ƒå¤±æ•—ï¼š' + (typeof friendlyError === 'function' ? friendlyError(e) : e.message));
            } finally {
                btn.disabled = false; btn.textContent = 'ğŸ“¢ ç™¼å¸ƒè–ªè³‡ï¼ˆå“¡å·¥å¯è¦‹ï¼‰';
            }
        }

        function exportPayrollCSV() {
            if (payrollEmployees.length === 0) { showToast('âš ï¸ è«‹å…ˆè¨ˆç®—è–ªè³‡'); return; }
            const year = parseInt(document.getElementById('payrollYear').value);
            const month = parseInt(document.getElementById('payrollMonth').value);
            const typeMap = { monthly: 'æœˆè–ª', daily: 'æ—¥è–ª', hourly: 'æ™‚è–ª' };

            const rows = [['å·¥è™Ÿ','å§“å','éƒ¨é–€','è–ªè³‡é¡å‹','åº•è–ª','åŠ ç­è²»','å…¨å‹¤çé‡‘','ä¼™é£Ÿæ´¥è²¼','è·å‹™åŠ çµ¦','å‹ä¿','å¥ä¿','å‹é€€','æ‰€å¾—ç¨…','é²åˆ°æ‰£','è«‹å‡æ‰£','æ‰‹å‹•èª¿æ•´','èª¿æ•´å‚™è¨»','ç¸½æ”¶å…¥','ç¸½æ‰£æ¬¾','å¯¦ç™¼']];

            payrollEmployees.forEach(emp => {
                rows.push([
                    emp.employee_number, emp.name, emp.department,
                    typeMap[emp.salary_type] || emp.salary_type,
                    emp.base_salary, emp.overtime_pay, emp.full_attendance_bonus,
                    emp.meal_allowance, emp.position_allowance,
                    emp.labor_insurance, emp.health_insurance, emp.pension_self, emp.income_tax,
                    emp.late_deduction, emp.personal_leave_deduction,
                    emp.manual_adjustment, emp.adjustment_note,
                    emp.gross_salary, emp.total_deduction, emp.net_salary
                ]);
            });

            const csv = '\uFEFF' + rows.map(r => r.map(c => `"${String(c ?? '').replace(/"/g, '""')}"`).join(',')).join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            a.download = `è–ªè³‡æ˜ç´°_${year}å¹´${month}æœˆ.csv`;
            a.click();

            if (typeof writeAuditLog === 'function') {
                writeAuditLog('export', 'payroll', null, `è–ªè³‡æ˜ç´°_${year}å¹´${month}æœˆ.csv`, { rows: rows.length - 1 });
            }
            showToast(`âœ… è–ªè³‡æ˜ç´°_${year}å¹´${month}æœˆ.csvï¼ˆ${rows.length - 1} ç­†ï¼‰`);
        }

        // ===== æ’ç­ç®¡ç† =====
        let smWeekStart;
        (function() {
            const n = new Date(); const dow = n.getDay();
            smWeekStart = new Date(n);
            // é€±ä¸€èµ·ç®—ï¼šdow=0(æ—¥)â†’å›é€€6å¤©, dow=1(ä¸€)â†’å›é€€0å¤©, dow=2(äºŒ)â†’å›é€€1å¤©...
            smWeekStart.setDate(n.getDate() - ((dow + 6) % 7));
            smWeekStart.setHours(0,0,0,0);
        })();

        let smEmployees = [];
        let smScheduleData = {};
        let smLeaveData = {};
        const SHIFT_TYPES = [null, 'morning', 'afternoon', 'night', 'off'];
        const SHIFT_DISPLAY = {
            null: { label:'â¬œ', bg:'#F8FAFC', color:'#94A3B8', name:'æœªæ’' },
            morning: { label:'â˜€ï¸', bg:'#DBEAFE', color:'#1E40AF', name:'æ—©ç­' },
            afternoon: { label:'ğŸŒ¤ï¸', bg:'#FEF3C7', color:'#92400E', name:'ä¸­ç­' },
            night: { label:'ğŸŒ™', bg:'#EDE9FE', color:'#6D28D9', name:'æ™šç­' },
            off: { label:'ğŸ–ï¸', bg:'#ECFDF5', color:'#059669', name:'ä¼‘å‡' }
        };

        function changeShiftWeek(d) { smWeekStart.setDate(smWeekStart.getDate() + d*7); loadShiftMgr(); }
        function resetShiftWeek() {
            const n = new Date(); const dow = n.getDay();
            smWeekStart = new Date(n);
            smWeekStart.setDate(n.getDate() - ((dow + 6) % 7));
            smWeekStart.setHours(0,0,0,0);
            loadShiftMgr();
        }

        function getWeekDates() {
            const dates = [];
            for (let i = 0; i < 7; i++) { const d = new Date(smWeekStart); d.setDate(d.getDate()+i); dates.push(d); }
            return dates;
        }

        async function loadShiftMgr() {
            const dates = getWeekDates();
            const startStr = fmtDate(dates[0]);
            const endStr = fmtDate(dates[6]);
            document.getElementById('smWeekLabel').textContent = `${startStr} ~ ${endStr}`;
            // Loading
            document.getElementById('smBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:#94A3B8;font-size:13px;">â³ è¼‰å…¥ä¸­...</td></tr>';
            document.getElementById('smHead').innerHTML = '';
            document.getElementById('shiftDaySummary').innerHTML = '';

            try {
                const { data: emps } = await sb.from('employees').select('id, name, department').eq('is_active', true).order('name');
                smEmployees = emps || [];
                const { data: scheds } = await sb.from('schedules').select('employee_id, date, shift_type_id, shift_types(name, code)')
                    .gte('date', startStr).lte('date', endStr);
                smScheduleData = {};
                (scheds || []).forEach(s => {
                    const code = s.shift_types?.code || s.shift_types?.name || 'morning';
                    smScheduleData[`${s.employee_id}_${s.date}`] = code;
                });
                // è¼‰å…¥è©²é€±è«‹å‡
                const { data: lvs } = await sb.from('leave_requests').select('employee_id, start_date, end_date, status')
                    .in('status', ['approved']).or(`and(start_date.lte.${endStr},end_date.gte.${startStr})`);
                smLeaveData = {};
                (lvs || []).forEach(l => {
                    // ç”¨å­—ä¸²æ¯”è¼ƒé¿å…æ™‚å€å•é¡Œ
                    const rangeStart = l.start_date > startStr ? l.start_date : startStr;
                    const rangeEnd = (l.end_date || l.start_date) < endStr ? (l.end_date || l.start_date) : endStr;
                    // é€æ—¥æ¨™è¨˜
                    let cur = new Date(rangeStart + 'T00:00:00');
                    const end = new Date(rangeEnd + 'T00:00:00');
                    while (cur <= end) {
                        smLeaveData[`${l.employee_id}_${fmtDate(cur)}`] = true;
                        cur.setDate(cur.getDate() + 1);
                    }
                });
            } catch(e) { console.error(e); }

            renderShiftTable();
        }

        function renderShiftTable() {
            const dates = getWeekDates();
            const wd = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

            // ç©ºç‹€æ…‹
            if (smEmployees.length === 0) {
                document.getElementById('smHead').innerHTML = '';
                document.getElementById('smBody').innerHTML = '';
                document.getElementById('shiftDaySummary').innerHTML = `
                    <div style="width:100%;text-align:center;padding:40px 20px;">
                        <div style="font-size:48px;margin-bottom:12px;">ğŸ‘¥</div>
                        <div style="font-size:16px;font-weight:800;color:#0F172A;margin-bottom:8px;">å°šç„¡å“¡å·¥è³‡æ–™</div>
                        <div style="font-size:13px;color:#94A3B8;margin-bottom:16px;">è«‹å…ˆåˆ°ã€Œå“¡å·¥ç®¡ç†ã€æ–°å¢å“¡å·¥ï¼Œæ‰èƒ½æ’ç­</div>
                        <button onclick="showPage('employeePage')" style="padding:12px 24px;border:none;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ‘‰ å‰å¾€å“¡å·¥ç®¡ç†</button>
                    </div>`;
                document.getElementById('shiftStaffWarn').style.display = 'none';
                return;
            }

            // è¡¨é ­
            let headHtml = '<tr><th style="position:sticky;left:0;background:#fff;z-index:2;padding:8px;min-width:60px;text-align:left;border-bottom:2px solid #E5E7EB;font-size:11px;">å§“å</th>';
            dates.forEach(d => {
                const isW = d.getDay()===0||d.getDay()===6;
                headHtml += `<th style="padding:6px 4px;min-width:46px;text-align:center;border-bottom:2px solid #E5E7EB;background:${isW?'#F1F5F9':'#fff'};">
                    <div style="font-size:12px;">${d.getDate()}</div><div style="font-size:10px;color:#94A3B8;">é€±${wd[d.getDay()]}</div>
                </th>`;
            });
            headHtml += '</tr>';
            document.getElementById('smHead').innerHTML = headHtml;

            // è¡¨èº«
            let bodyHtml = '';
            smEmployees.forEach(emp => {
                bodyHtml += `<tr><td style="position:sticky;left:0;background:#fff;z-index:1;padding:8px;font-weight:700;font-size:11px;white-space:nowrap;border-bottom:1px solid #F1F5F9;">${emp.name}</td>`;
                dates.forEach(d => {
                    const ds = fmtDate(d);
                    const key = `${emp.id}_${ds}`;
                    const onLeave = smLeaveData[key];
                    const shift = smScheduleData[key] || null;
                    const disp = SHIFT_DISPLAY[shift] || SHIFT_DISPLAY[null];
                    if (onLeave) {
                        bodyHtml += `<td style="text-align:center;padding:8px 4px;border-bottom:1px solid #F1F5F9;background:#FEE2E2;font-size:14px;cursor:not-allowed;opacity:0.7;" title="${emp.name} å·²è«‹å‡">ğŸ–ï¸</td>`;
                    } else {
                        bodyHtml += `<td onclick="cycleShift('${key}')" style="text-align:center;padding:8px 4px;cursor:pointer;border-bottom:1px solid #F1F5F9;background:${disp.bg};font-size:14px;transition:all 0.15s;user-select:none;" title="${emp.name} ${ds} ${disp.name}">${disp.label}</td>`;
                    }
                });
                bodyHtml += '</tr>';
            });

            // æ¯æ—¥äººåŠ›çµ±è¨ˆåˆ—
            bodyHtml += '<tr style="background:#F8FAFC;font-weight:700;"><td style="position:sticky;left:0;background:#F8FAFC;z-index:1;padding:6px 8px;font-size:10px;color:#64748B;">ä¸Šç­äººæ•¸</td>';
            let warnDays = [];
            dates.forEach(d => {
                const ds = fmtDate(d);
                const isW = d.getDay()===0||d.getDay()===6;
                let working = 0;
                smEmployees.forEach(emp => {
                    const key = `${emp.id}_${ds}`;
                    if (smLeaveData[key]) return;
                    const shift = smScheduleData[key];
                    if (shift && shift !== 'off') working++;
                });
                const low = working > 0 && working <= 2 && !isW;
                if (low) warnDays.push(`${d.getMonth()+1}/${d.getDate()}(${working}äºº)`);
                bodyHtml += `<td style="text-align:center;font-size:11px;color:${low?'#DC2626':working>0?'#059669':'#94A3B8'};background:${low?'#FEF2F2':'#F8FAFC'};border-bottom:1px solid #F1F5F9;">${working||'-'}</td>`;
            });
            bodyHtml += '</tr>';
            document.getElementById('smBody').innerHTML = bodyHtml;

            // æ¯æ—¥æ‘˜è¦å¡ç‰‡
            let sumHtml = '';
            dates.forEach(d => {
                const ds = fmtDate(d);
                const isW = d.getDay()===0||d.getDay()===6;
                const counts = { morning:0, afternoon:0, night:0, off:0, leave:0, unset:0 };
                smEmployees.forEach(emp => {
                    const key = `${emp.id}_${ds}`;
                    if (smLeaveData[key]) { counts.leave++; return; }
                    const s = smScheduleData[key];
                    if (s && counts.hasOwnProperty(s)) counts[s]++;
                    else counts.unset++;
                });
                const total = counts.morning + counts.afternoon + counts.night;
                const low = total > 0 && total <= 2 && !isW;
                sumHtml += `<div style="min-width:60px;padding:6px 8px;background:${low?'#FEF2F2':'#F8FAFC'};border-radius:8px;text-align:center;flex-shrink:0;${low?'border:2px solid #FCA5A5;':''}">
                    <div style="font-size:10px;font-weight:700;color:#64748B;">${d.getDate()}æ—¥</div>
                    <div style="font-size:14px;font-weight:900;color:${low?'#DC2626':'#0F172A'};">${total}äºº</div>
                    <div style="font-size:9px;color:#94A3B8;">â˜€${counts.morning} ğŸŒ¤${counts.afternoon} ğŸŒ™${counts.night}</div>
                    ${counts.leave>0?`<div style="font-size:9px;color:#EA580C;">å‡${counts.leave}</div>`:''}
                </div>`;
            });
            document.getElementById('shiftDaySummary').innerHTML = sumHtml;

            // äººæ‰‹ä¸è¶³è­¦å‘Š
            const warnEl = document.getElementById('shiftStaffWarn');
            if (warnDays.length > 0) {
                warnEl.style.display = 'block';
                warnEl.innerHTML = `âš ï¸ äººæ‰‹ä¸è¶³è­¦å‘Šï¼š${warnDays.join('ã€')}<br><span style="font-size:11px;opacity:0.7;">å»ºè­°èª¿æ•´æ’ç­æˆ–é™åˆ¶è«‹å‡</span>`;
            } else {
                warnEl.style.display = 'none';
            }
        }

        function cycleShift(key) {
            const current = smScheduleData[key] || null;
            const idx = SHIFT_TYPES.indexOf(current);
            smScheduleData[key] = SHIFT_TYPES[(idx+1) % SHIFT_TYPES.length];
            renderShiftTable();
        }

        async function saveSchedule() {
            const statusEl = document.getElementById('smSaveStatus');
            statusEl.style.display = 'block'; statusEl.style.color = '#F59E0B'; statusEl.textContent = 'â³ å„²å­˜ä¸­...';
            try {
                const { data: shiftTypes } = await sb.from('shift_types').select('id, code, name');
                const stMap = {};
                (shiftTypes || []).forEach(st => { stMap[st.code || st.name] = st.id; });
                const upserts = [];
                for (const [key, shift] of Object.entries(smScheduleData)) {
                    if (!shift) continue;
                    const parts = key.split('_');
                    const empId = parts[0];
                    const date = parts.slice(1).join('-');
                    const stId = stMap[shift];
                    if (!stId) continue;
                    upserts.push({ employee_id: empId, date, shift_type_id: stId });
                }
                if (upserts.length > 0) {
                    const { error } = await sb.from('schedules').upsert(upserts, { onConflict: 'employee_id,date' });
                    if (error) throw error;
                }
                statusEl.style.color = '#059669'; statusEl.textContent = `âœ… å·²å„²å­˜ ${upserts.length} ç­†æ’ç­`;
                setTimeout(() => { statusEl.style.display = 'none'; }, 2500);
            } catch(e) {
                console.error(e);
                statusEl.style.color = '#DC2626'; statusEl.textContent = 'âŒ å„²å­˜å¤±æ•—: ' + e.message;
            }
        }

        async function copyLastWeek() {
            if (!confirm('ç¢ºå®šè¦è¤‡è£½ä¸Šé€±æ’ç­åˆ°æœ¬é€±ï¼Ÿ\nï¼ˆå·²æœ‰æ’ç­ä¸æœƒè¢«è¦†è“‹ï¼‰')) return;
            const dates = getWeekDates();
            try {
                const lwStart = new Date(dates[0]); lwStart.setDate(lwStart.getDate()-7);
                const lwEnd = new Date(dates[6]); lwEnd.setDate(lwEnd.getDate()-7);
                const { data: lastScheds } = await sb.from('schedules').select('employee_id, date, shift_type_id, shift_types(code, name)')
                    .gte('date', fmtDate(lwStart)).lte('date', lwEnfmtDate(d));
                let copied = 0;
                (lastScheds || []).forEach(s => {
                    const oldD = new Date(s.date + 'T00:00:00');
                    const newD = new Date(oldD); newD.setDate(newD.getDate()+7);
                    const key = `${s.employee_id}_${fmtDate(newD)}`;
                    if (!smScheduleData[key]) {
                        smScheduleData[key] = s.shift_types?.code || s.shift_types?.name || 'morning';
                        copied++;
                    }
                });
                renderShiftTable();
                showToast(`ğŸ“‹ å·²è¤‡è£½ä¸Šé€± ${copied} ç­†æ’ç­`);
            } catch(e) { console.error(e); showToast('âŒ è¤‡è£½å¤±æ•—'); }
        }


        // ===== è£œæ‰“å¡å¯©æ ¸ =====
        function switchMakeupTab(status) {
            document.querySelectorAll('#makeupApprovalTabs .tab-btn').forEach(btn => {
                btn.className = 'tab-btn inactive';
            });
            event.target.className = 'tab-btn active';
            loadMakeupApprovals(status);
        }

        async function loadMakeupApprovals(status) {
            const listEl = document.getElementById('makeupApprovalList');
            if (!listEl) return;
            listEl.innerHTML = '<p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>';

            try {
                const { data } = await sb.from('makeup_punch_requests')
                    .select('*, employees(name, department, employee_number)')
                    .eq('status', status)
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (!data || data.length === 0) {
                    const labels = { pending:'å¾…å¯©æ ¸', approved:'å·²é€šé', rejected:'å·²æ‹’çµ•' };
                    listEl.innerHTML = `<p style="text-align:center;color:#999;">ç„¡${labels[status]}çš„è£œæ‰“å¡ç”³è«‹</p>`;
                    return;
                }

                const typeMap = { clock_in:'â˜€ï¸ ä¸Šç­', clock_out:'ğŸŒ™ ä¸‹ç­' };
                listEl.innerHTML = data.map(r => `
                    <div style="background:#fff;border-radius:14px;padding:14px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <span style="font-weight:800;font-size:14px;">${r.employees?.name || '?'}</span>
                            <span style="font-size:11px;color:#94A3B8;">${r.employees?.department || ''} Â· ${r.employees?.employee_number || ''}</span>
                        </div>
                        <div style="display:flex;gap:8px;margin-bottom:8px;font-size:13px;">
                            <span style="padding:4px 10px;background:#EFF6FF;border-radius:8px;color:#2563EB;font-weight:700;">ğŸ“… ${r.punch_date}</span>
                            <span style="padding:4px 10px;background:#F5F3FF;border-radius:8px;color:#7C3AED;font-weight:700;">${typeMap[r.punch_type] || r.punch_type} ${r.punch_time || ''}</span>
                        </div>
                        <div style="font-size:12px;color:#64748B;margin-bottom:8px;">${r.reason || ''}</div>
                        ${status === 'pending' ? `
                            <div style="display:flex;gap:8px;">
                                <button onclick="approveMakeupPunch('${r.id}','approved')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#ECFDF5;color:#059669;font-weight:700;font-size:13px;cursor:pointer;">âœ… é€šé</button>
                                <button onclick="rejectMakeupPunchPrompt('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#FEF2F2;color:#DC2626;font-weight:700;font-size:13px;cursor:pointer;">âŒ æ‹’çµ•</button>
                            </div>
                        ` : ''}
                        ${r.status === 'approved' ? '<div style="font-size:11px;color:#059669;margin-top:4px;">âœ… å·²è‡ªå‹•å¯«å…¥å‡ºå‹¤è¨˜éŒ„</div>' : ''}
                        ${r.rejection_reason ? `<div style="font-size:11px;color:#DC2626;margin-top:4px;">âŒ ${r.rejection_reason}</div>` : ''}
                    </div>
                `).join('');
            } catch(e) {
                console.error(e);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        async function approveMakeupPunch(id, status) {
            try {
                const { data: req } = await sb.from('makeup_punch_requests').select('*').eq('id', id).single();
                
                await sb.from('makeup_punch_requests').update({
                    status: status,
                    approver_id: currentAdminEmployee?.id,
                    approved_at: new Date().toISOString()
                }).eq('id', id);

                // é€šéå¾Œè‡ªå‹•å¯«å…¥ attendance
                if (status === 'approved' && req) {
                    const col = req.punch_type === 'clock_in' ? 'check_in_time' : 'check_out_time';
                    const timeVal = `${req.punch_date}T${req.punch_time}:00`;
                    
                    // å…ˆæŸ¥æ˜¯å¦å·²æœ‰ç•¶å¤©è¨˜éŒ„
                    const { data: existing } = await sb.from('attendance')
                        .select('id')
                        .eq('employee_id', req.employee_id)
                        .eq('date', req.punch_date)
                        .maybeSingle();
                    
                    if (existing) {
                        await sb.from('attendance').update({
                            [col]: timeVal,
                            is_manual: true,
                            notes: `è£œæ‰“å¡ - ${req.reason || ''}`
                        }).eq('id', existing.id);
                    } else {
                        await sb.from('attendance').insert({
                            employee_id: req.employee_id,
                            date: req.punch_date,
                            [col]: timeVal,
                            is_manual: true,
                            status: 'present',
                            notes: `è£œæ‰“å¡ - ${req.reason || ''}`
                        });
                    }
                    
                    // é€šçŸ¥å“¡å·¥
                    sendUserNotify(req.employee_id, `âœ… æ‚¨çš„è£œæ‰“å¡ç”³è«‹å·²é€šé\nğŸ“… ${req.punch_date} ${req.punch_type === 'clock_in' ? 'ä¸Šç­' : 'ä¸‹ç­'} ${req.punch_time}`);
                }

                showToast(status === 'approved' ? 'âœ… å·²é€šéä¸¦å¯«å…¥å‡ºå‹¤' : 'âŒ å·²æ‹’çµ•');
                writeAuditLog(status === 'approved' ? 'approve' : 'reject', 'makeup_punch_requests', id, req?.employees?.name || '');
                loadMakeupApprovals('pending');
            } catch(e) {
                console.error(e);
                showToast('âŒ å¯©æ ¸å¤±æ•—: ' + friendlyError(e));
            }
        }

        function rejectMakeupPunchPrompt(id) {
            const reason = prompt('è«‹è¼¸å…¥æ‹’çµ•åŸå› ï¼ˆé¸å¡«ï¼‰ï¼š');
            if (reason === null) return;
            rejectMakeupPunch(id, reason);
        }

        async function rejectMakeupPunch(id, reason) {
            try {
                await sb.from('makeup_punch_requests').update({
                    status: 'rejected',
                    rejection_reason: reason || 'ä¸ç¬¦åˆè¦å®š',
                    approver_id: currentAdminEmployee?.id,
                    approved_at: new Date().toISOString()
                }).eq('id', id);
                showToast('âŒ å·²æ‹’çµ•');
                loadMakeupApprovals('pending');
            } catch(e) { showToast('âŒ æ“ä½œå¤±æ•—'); }
        }

        // ===== å…¬å‘Šç®¡ç† =====
        function toggleAnnCheck(id) {
            const cb = document.getElementById(id);
            if (!cb) return;
            cb.checked = !cb.checked;
            const card = document.getElementById(id + 'Card');
            const box = document.getElementById(id + 'Box');
            if (cb.checked) {
                card.style.borderColor = '#4F46E5';
                card.style.background = '#F5F3FF';
                box.style.background = '#4F46E5';
                box.style.borderColor = '#4F46E5';
                box.innerHTML = 'âœ“';
            } else {
                card.style.borderColor = '#E5E7EB';
                card.style.background = '#F8FAFC';
                box.style.background = '#fff';
                box.style.borderColor = '#CBD5E1';
                box.innerHTML = '';
            }
        }

        async function publishAnnouncement() {
            const title = document.getElementById('annTitle')?.value;
            const content = document.getElementById('annContent')?.value;
            const type = document.getElementById('annType')?.value;
            const expire = document.getElementById('annExpire')?.value;
            const pinned = document.getElementById('annPinned')?.checked;
            const requireAck = document.getElementById('annRequireAck')?.checked;
            
            if (!title) return showToast('âŒ è«‹è¼¸å…¥æ¨™é¡Œ');
            
            try {
                // è®€å–ç¾æœ‰å…¬å‘Š
                const { data: existing } = await sb.from('system_settings')
                    .select('value').eq('key', 'announcements').maybeSingle();
                
                const items = existing?.value?.items || [];
                items.unshift({
                    id: Date.now().toString(),
                    title, content, type, pinned,
                    require_ack: requireAck || false,
                    expire_date: expire || null,
                    created_at: new Date().toISOString(),
                    created_by: currentAdminEmployee?.name || 'admin'
                });
                
                if (existing) {
                    await sb.from('system_settings').update({ value: { items }, updated_at: new Date().toISOString() }).eq('key', 'announcements');
                } else {
                    await sb.from('system_settings').insert({ key: 'announcements', value: { items }, description: 'å…¬å‘Šç³»çµ±' });
                }
                
                showToast('ğŸ“¢ å…¬å‘Šå·²ç™¼å¸ƒ');
                document.getElementById('annTitle').value = '';
                document.getElementById('annContent').value = '';
                document.getElementById('annExpire').value = '';
                document.getElementById('annPinned').checked = false;
                if (document.getElementById('annRequireAck')) document.getElementById('annRequireAck').checked = false;
                loadAnnouncementList();
            } catch(e) { showToast('âŒ ç™¼å¸ƒå¤±æ•—ï¼š' + friendlyError(e)); }
        }

        async function loadAnnouncementList() {
            const el = document.getElementById('announcementList');
            if (!el) return;
            
            try {
                const { data } = await sb.from('system_settings')
                    .select('value').eq('key', 'announcements').maybeSingle();
                
                const items = data?.value?.items || [];
                if (items.length === 0) { el.innerHTML = '<p style="text-align:center;color:#999;">å°šç„¡å…¬å‘Š</p>'; return; }
                
                const typeIcon = { info:'ğŸ“¢', warning:'âš ï¸', urgent:'ğŸš¨', event:'ğŸ‰' };
                const typeColor = { info:'#2563EB', warning:'#EA580C', urgent:'#DC2626', event:'#7C3AED' };
                const typeBg = { info:'#EFF6FF', warning:'#FFF7ED', urgent:'#FEF2F2', event:'#F5F3FF' };
                
                el.innerHTML = items.map(a => `
                    <div style="background:${typeBg[a.type] || '#F1F5F9'};border-radius:12px;padding:14px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <span style="font-weight:800;color:${typeColor[a.type] || '#64748B'};">${typeIcon[a.type] || 'ğŸ“Œ'} ${a.title}</span>
                            <button onclick="deleteAnnouncement('${a.id}')" style="background:none;border:none;font-size:14px;cursor:pointer;padding:4px;">ğŸ—‘ï¸</button>
                        </div>
                        ${a.content ? `<div style="font-size:12px;color:#64748B;margin-bottom:4px;">${a.content}</div>` : ''}
                        <div style="font-size:10px;color:#94A3B8;">
                            ${a.pinned ? 'ğŸ“Œ ç½®é ‚ Â· ' : ''}
                            ${a.expire_date ? 'åˆ°æœŸï¼š' + a.expire_date + ' Â· ' : 'æ°¸ä¹… Â· '}
                            ${a.created_by || ''} Â· ${a.created_at ? new Date(a.created_at).toLocaleDateString() : ''}
                        </div>
                    </div>
                `).join('');
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>'; }
        }

        async function deleteAnnouncement(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤å…¬å‘Šï¼Ÿ')) return;
            try {
                const { data } = await sb.from('system_settings')
                    .select('value').eq('key', 'announcements').maybeSingle();
                if (!data?.value?.items) return;
                
                const items = data.value.items.filter(a => a.id !== id);
                await sb.from('system_settings').update({ value: { items }, updated_at: new Date().toISOString() }).eq('key', 'announcements');
                showToast('ğŸ—‘ï¸ å·²åˆªé™¤');
                loadAnnouncementList();
            } catch(e) { showToast('âŒ åˆªé™¤å¤±æ•—'); }
        }

        // ===== åŠ ç­å¯©æ ¸ =====
        function switchOtTab(status) {
            document.querySelectorAll('#overtimeApprovalTabs .tab-btn').forEach(btn => {
                btn.className = 'tab-btn inactive';
            });
            event.target.className = 'tab-btn active';
            loadOtApprovals(status);
        }

        async function loadOtApprovals(status) {
            const el = document.getElementById('otApprovalList');
            if (!el) return;
            el.innerHTML = '<p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>';
            try {
                const { data } = await sb.from('overtime_requests')
                    .select('*, employees(name, department, employee_number)')
                    .eq('status', status).order('created_at', { ascending: false }).limit(20);
                if (!data || data.length === 0) {
                    el.innerHTML = `<p style="text-align:center;color:#999;">ç„¡è³‡æ–™</p>`; return;
                }
                const compMap = { pay:'ğŸ’° åŠ ç­è²»', comp_leave:'ğŸ–ï¸ æ›è£œä¼‘' };
                el.innerHTML = data.map(r => `
                    <div style="background:#fff;border-radius:14px;padding:14px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <b>${r.employees?.name || '?'}</b>
                            <span style="font-size:11px;color:#94A3B8;">${r.employees?.department || ''}</span>
                        </div>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px;font-size:12px;">
                            <span style="padding:3px 8px;background:#EFF6FF;border-radius:6px;color:#2563EB;font-weight:700;">ğŸ“… ${r.ot_date}</span>
                            <span style="padding:3px 8px;background:#F5F3FF;border-radius:6px;color:#7C3AED;font-weight:700;">â° ${r.planned_hours}h</span>
                            <span style="padding:3px 8px;background:#ECFDF5;border-radius:6px;color:#059669;font-weight:700;">${compMap[r.compensation_type] || ''}</span>
                        </div>
                        <div style="font-size:12px;color:#64748B;margin-bottom:6px;">${r.reason || ''}</div>
                        ${status === 'pending' ? `
                            <div style="margin-bottom:8px;">
                                <label style="font-size:12px;font-weight:700;">æ ¸å‡†æ™‚æ•¸ï¼š</label>
                                <input type="number" id="otAH_${r.id}" value="${r.planned_hours}" min="0" max="12" step="0.5" style="width:70px;padding:4px;border:1px solid #E5E7EB;border-radius:6px;">h
                            </div>
                            <div style="display:flex;gap:8px;">
                                <button onclick="approveOt('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#ECFDF5;color:#059669;font-weight:700;cursor:pointer;">âœ… é€šé</button>
                                <button onclick="rejectOtPrompt('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#FEF2F2;color:#DC2626;font-weight:700;cursor:pointer;">âŒ æ‹’çµ•</button>
                            </div>
                        ` : ''}
                        ${r.approved_hours ? `<div style="font-size:11px;color:#059669;">æ ¸å‡† ${r.approved_hours}h${r.final_hours != null ? ' Â· è¨ˆè–ª '+r.final_hours+'h' : ''}</div>` : ''}
                        ${r.rejection_reason ? `<div style="font-size:11px;color:#DC2626;">âŒ ${r.rejection_reason}</div>` : ''}
                    </div>
                `).join('');
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>'; }
        }

        async function approveOt(id) {
            const h = parseFloat(document.getElementById(`otAH_${id}`)?.value) || 0;
            if (h <= 0) return showToast('âŒ æ ¸å‡†æ™‚æ•¸éœ€å¤§æ–¼ 0');
            try {
                const { data: req } = await sb.from('overtime_requests').select('*, employees(name, id)').eq('id', id).single();
                await sb.from('overtime_requests').update({
                    status:'approved', approved_hours:h, approver_id:currentAdminEmployee?.id, approved_at:new Date().toISOString()
                }).eq('id', id);
                writeAuditLog('approve','overtime_requests',id,req?.employees?.name,{approved_hours:h});
                if (req?.employees?.id) sendUserNotify(req.employees.id,`âœ… åŠ ç­å·²é€šé\nğŸ“… ${req.ot_date} æ ¸å‡† ${h}h`);
                showToast('âœ… å·²é€šé'); loadOtApprovals('pending');
            } catch(e) { showToast('âŒ å¯©æ ¸å¤±æ•—'); }
        }
        function rejectOtPrompt(id) { const r = prompt('æ‹’çµ•åŸå› ï¼š'); if(r===null) return; rejectOt(id,r); }
        async function rejectOt(id, reason) {
            try {
                await sb.from('overtime_requests').update({
                    status:'rejected', rejection_reason:reason||'ä¸ç¬¦åˆè¦å®š',
                    approver_id:currentAdminEmployee?.id, approved_at:new Date().toISOString()
                }).eq('id', id);
                showToast('âŒ å·²æ‹’çµ•'); loadOtApprovals('pending');
            } catch(e) { showToast('âŒ æ“ä½œå¤±æ•—'); }
        }

        // ===== æ›ç­å¯©æ ¸ =====
        async function loadSwapApprovals() {
            const el = document.getElementById('swapApprovalList');
            if (!el) return;
            el.innerHTML = '<p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>';
            try {
                const { data } = await sb.from('shift_swap_requests')
                    .select('*, requester:employees!shift_swap_requests_requester_id_fkey(name, department), target:employees!shift_swap_requests_target_id_fkey(name, department)')
                    .in('status', ['pending_admin', 'approved', 'rejected'])
                    .order('created_at', { ascending: false }).limit(20);
                
                if (!data || data.length === 0) { el.innerHTML = '<p style="text-align:center;color:#999;">ç„¡æ›ç­ç”³è«‹</p>'; return; }
                
                const sMap = { pending_admin:'â³ å¾…å¯©', approved:'âœ… é€šé', rejected:'âŒ æ‹’çµ•' };
                el.innerHTML = data.map(r => `
                    <div style="background:#fff;border-radius:14px;padding:14px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                            <b style="font-size:14px;">${r.requester?.name} â†” ${r.target?.name}</b>
                            <span style="font-size:11px;color:#94A3B8;">${sMap[r.status] || r.status}</span>
                        </div>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px;font-size:12px;">
                            <span style="padding:3px 8px;background:#EFF6FF;border-radius:6px;color:#2563EB;font-weight:700;">ğŸ“… ${r.swap_date}</span>
                            <span style="padding:3px 8px;background:#FFF7ED;border-radius:6px;color:#EA580C;font-weight:700;">${r.requester_original_shift||'?'} â†” ${r.target_original_shift||'?'}</span>
                        </div>
                        <div style="font-size:11px;color:#64748B;margin-bottom:6px;">âœ… é›™æ–¹å·²åŒæ„${r.reason ? ' Â· åŸå› ï¼š'+r.reason : ''}</div>
                        ${r.status === 'pending_admin' ? `
                            <div style="display:flex;gap:8px;">
                                <button onclick="approveSwap('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#ECFDF5;color:#059669;font-weight:700;cursor:pointer;">âœ… æ ¸å‡†</button>
                                <button onclick="rejectSwap('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#FEF2F2;color:#DC2626;font-weight:700;cursor:pointer;">âŒ æ‹’çµ•</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>'; }
        }

        async function approveSwap(id) {
            try {
                const { data: req } = await sb.from('shift_swap_requests')
                    .select('*, requester:employees!shift_swap_requests_requester_id_fkey(name, id), target:employees!shift_swap_requests_target_id_fkey(name, id)')
                    .eq('id', id).single();
                
                // æ›´æ–°ç‹€æ…‹
                await sb.from('shift_swap_requests').update({
                    status: 'approved', approver_id: currentAdminEmployee?.id, approved_at: new Date().toISOString()
                }).eq('id', id);
                
                // äº¤æ›æ’ç­è¡¨ï¼ˆäº’ç›¸æ›´æ–° schedulesï¼‰
                if (req) {
                    const date = req.swap_date;
                    // å–å¾—é›™æ–¹ç•¶æ—¥æ’ç­
                    const { data: s1 } = await sb.from('schedules').select('id, shift_type_id').eq('employee_id', req.requester_id).eq('date', date).maybeSingle();
                    const { data: s2 } = await sb.from('schedules').select('id, shift_type_id').eq('employee_id', req.target_id).eq('date', date).maybeSingle();
                    
                    if (s1 && s2) {
                        // äº¤æ› shift_type_id
                        await sb.from('schedules').update({ shift_type_id: s2.shift_type_id }).eq('id', s1.id);
                        await sb.from('schedules').update({ shift_type_id: s1.shift_type_id }).eq('id', s2.id);
                    }
                    
                    writeAuditLog('approve', 'shift_swap_requests', id, `${req.requester?.name} â†” ${req.target?.name}`, { date });
                    if (req.requester?.id) sendUserNotify(req.requester.id, `âœ… æ›ç­å·²æ ¸å‡†\nğŸ“… ${date} ç­è¡¨å·²è‡ªå‹•æ›´æ–°`);
                    if (req.target?.id) sendUserNotify(req.target.id, `âœ… æ›ç­å·²æ ¸å‡†\nğŸ“… ${date} ç­è¡¨å·²è‡ªå‹•æ›´æ–°`);
                }
                
                showToast('âœ… å·²æ ¸å‡†ï¼Œç­è¡¨å·²äº¤æ›');
                loadSwapApprovals();
            } catch(e) { showToast('âŒ å¯©æ ¸å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        async function rejectSwap(id) {
            const reason = prompt('æ‹’çµ•åŸå› ï¼š');
            if (reason === null) return;
            try {
                await sb.from('shift_swap_requests').update({
                    status: 'rejected', rejection_reason: reason || 'ä¸ç¬¦è¦å®š',
                    approver_id: currentAdminEmployee?.id, approved_at: new Date().toISOString()
                }).eq('id', id);
                showToast('âŒ å·²æ‹’çµ•'); loadSwapApprovals();
            } catch(e) { showToast('âŒ æ“ä½œå¤±æ•—'); }
        }

        // ===== æ“ä½œæ—¥èªŒ =====
        let auditOffset = 0;
        async function loadAuditLogs(more = false) {
            const el = document.getElementById('auditLogList');
            if (!el) return;
            if (!more) { auditOffset = 0; el.innerHTML = ''; }
            try {
                const { data } = await sb.from('hr_audit_logs').select('*').order('created_at',{ascending:false}).range(auditOffset, auditOffset+29);
                if (!data || data.length === 0) { if(auditOffset===0) el.innerHTML = '<p style="text-align:center;color:#999;">å°šç„¡è¨˜éŒ„</p>'; return; }
                const ai = {create:'â•',update:'âœï¸',delete:'ğŸ—‘ï¸',approve:'âœ…',reject:'âŒ',export:'ğŸ“Š',acknowledge:'âœï¸'};
                const al = {create:'æ–°å¢',update:'ä¿®æ”¹',delete:'åˆªé™¤',approve:'é€šé',reject:'æ‹’çµ•',export:'åŒ¯å‡º',acknowledge:'ç°½ç½²'};
                el.innerHTML += data.map(r => `
                    <div style="padding:8px 0;border-bottom:1px solid #F1F5F9;font-size:13px;">
                        <div style="display:flex;justify-content:space-between;">
                            <span>${ai[r.action]||'ğŸ“'} <b>${r.actor_name||'?'}</b> ${al[r.action]||r.action} <span style="color:#7C3AED;">${r.target_table||''}</span></span>
                            <span style="font-size:10px;color:#94A3B8;">${r.created_at?new Date(r.created_at).toLocaleString('zh-TW'):''}</span>
                        </div>
                        ${r.target_name?`<div style="font-size:11px;color:#64748B;margin-top:2px;">å°è±¡ï¼š${r.target_name}</div>`:''}
                    </div>
                `).join('');
                auditOffset += data.length;
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>'; }
        }

        // ===== å ±è¡¨åŒ¯å‡ºï¼ˆCSVï¼‰=====
        async function exportReport(type) {
            showToast(`ğŸ“Š æ­£åœ¨ç”¢ç”Ÿå ±è¡¨...`);
            try {
                const now = new Date();
                const y = now.getFullYear(), m = now.getMonth()+1, ms = `${y}-${String(m).padStart(2,'0')}`;
                let rows = [], fn = '';
                
                if (type === 'attendance') {
                    const { data } = await sb.from('attendance').select('*, employees(name, employee_number, department)').gte('date',ms+'-01').lte('date',ms+'-31').order('date');
                    rows.push(['æ—¥æœŸ','å·¥è™Ÿ','å§“å','éƒ¨é–€','ä¸Šç­','ä¸‹ç­','ç‹€æ…‹','é²åˆ°(åˆ†)','è£œå¡','å‚™è¨»']);
                    (data||[]).forEach(r => rows.push([r.date,r.employees?.employee_number,r.employees?.name,r.employees?.department,r.check_in_time?.split('T')[1]?.substring(0,5)||'',r.check_out_time?.split('T')[1]?.substring(0,5)||'',r.status,r.late_minutes||0,r.is_manual?'æ˜¯':'',r.notes||'']));
                    fn = `å‡ºå‹¤å ±è¡¨_${ms}.csv`;
                } else if (type === 'leave') {
                    const { data } = await sb.from('leave_requests').select('*, employees(name, employee_number, department)').order('created_at',{ascending:false}).limit(200);
                    const tm = {annual:'ç‰¹ä¼‘',sick:'ç—…å‡',personal:'äº‹å‡',compensatory:'è£œä¼‘'};
                    rows.push(['å·¥è™Ÿ','å§“å','éƒ¨é–€','å‡åˆ¥','é–‹å§‹','çµæŸ','å¤©æ•¸','åŸå› ','ç‹€æ…‹','æ‹’çµ•åŸå› ']);
                    (data||[]).forEach(r => rows.push([r.employees?.employee_number,r.employees?.name,r.employees?.department,tm[r.leave_type]||r.leave_type,r.start_date,r.end_date,r.days||1,r.reason||'',r.status,r.rejection_reason||'']));
                    fn = `è«‹å‡å ±è¡¨_${ms}.csv`;
                } else if (type === 'overtime') {
                    const { data } = await sb.from('overtime_requests').select('*, employees(name, employee_number, department)').order('ot_date',{ascending:false}).limit(200);
                    rows.push(['å·¥è™Ÿ','å§“å','éƒ¨é–€','æ—¥æœŸ','ç”³è«‹h','æ ¸å‡†h','å¯¦éš›h','è¨ˆè–ªh','è£œå„Ÿ','ç‹€æ…‹']);
                    (data||[]).forEach(r => rows.push([r.employees?.employee_number,r.employees?.name,r.employees?.department,r.ot_date,r.planned_hours,r.approved_hours||'',r.actual_hours||'',r.final_hours||'',r.compensation_type==='pay'?'åŠ ç­è²»':'è£œä¼‘',r.status]));
                    fn = `åŠ ç­å ±è¡¨_${ms}.csv`;
                } else if (type === 'lunch') {
                    const { data } = await sb.from('lunch_orders').select('*, employees(name, employee_number)').gte('order_date',ms+'-01').lte('order_date',ms+'-31').order('order_date');
                    rows.push(['æ—¥æœŸ','å·¥è™Ÿ','å§“å','é¡å‹','ç‹€æ…‹','å‚™è¨»']);
                    (data||[]).forEach(r => rows.push([r.order_date,r.employees?.employee_number,r.employees?.name,r.is_vegetarian?'ç´ é£Ÿ':'è‘·é£Ÿ',r.status==='cancelled'?'å–æ¶ˆ($50)':'å·²è¨‚',r.notes||'']));
                    fn = `ä¾¿ç•¶å ±è¡¨_${ms}.csv`;
                } else if (type === 'bonus') {
                    const { data } = await sb.from('annual_bonus').select('*, employees(name, employee_number, department)').eq('year',y);
                    rows.push(['å·¥è™Ÿ','å§“å','éƒ¨é–€','å¹´è³‡(æœˆ)','åŸºæœ¬çé‡‘','èª¿æ•´','æœ€çµ‚','è©³ç´°']);
                    (data||[]).forEach(r => {
                        let detail = '';
                        try { const d = JSON.parse(r.ai_recommendation); detail = `${d.performance_rating}/${d.attendance_grade} x${d.matrix_multiplier}`; } catch(e) {}
                        rows.push([r.employees?.employee_number,r.employees?.name,r.employees?.department,r.months_worked,r.base_amount,r.adjustment||0,r.final_bonus||0,detail]);
                    });
                    fn = `çé‡‘å ±è¡¨_${y}.csv`;
                } else if (type === 'payroll') {
                    const { data } = await sb.from('payroll').select('*, employees(name, employee_number, department)').eq('year',y).eq('month',m).order('employees(employee_number)');
                    rows.push(['å·¥è™Ÿ','å§“å','éƒ¨é–€','è–ªè³‡é¡å‹','åº•è–ª','åŠ ç­è²»','å…¨å‹¤çé‡‘','ä¼™é£Ÿæ´¥è²¼','è·å‹™åŠ çµ¦','å‹ä¿','å¥ä¿','å‹é€€','æ‰€å¾—ç¨…','é²åˆ°æ‰£','è«‹å‡æ‰£','æ‰‹å‹•èª¿æ•´','ç¸½æ”¶å…¥','ç¸½æ‰£æ¬¾','å¯¦ç™¼','ç‹€æ…‹']);
                    (data||[]).forEach(r => {
                        const cd = r.calculation_details || {};
                        const typeMap = {monthly:'æœˆè–ª',daily:'æ—¥è–ª',hourly:'æ™‚è–ª'};
                        rows.push([r.employees?.employee_number,r.employees?.name,r.employees?.department,typeMap[r.salary_type]||r.salary_type,r.base_salary,r.overtime_pay,r.full_attendance_bonus,r.meal_allowance||0,r.position_allowance||0,r.labor_insurance,r.health_insurance,r.pension_self||0,r.income_tax||0,r.late_deduction,r.personal_leave_deduction||0,r.manual_adjustment||0,r.gross_salary,r.total_deduction,r.net_salary,r.is_published?'å·²ç™¼å¸ƒ':'è‰ç¨¿']);
                    });
                    fn = `è–ªè³‡å ±è¡¨_${ms}.csv`;
                }

                else if (type === 'orders') {
                    // æœ€è¿‘ 3 å€‹æœˆè¨‚å–®
                    const threeMonthsAgo = new Date();
                    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                    const since = fmtDate(threeMonthsAgo);
                    let oq = sb.from('orders').select('*, store_profiles(store_name)').gte('created_at', since + 'T00:00:00').order('created_at', { ascending: false });
                    const { data: od } = await oq;
                    const typeLabel = { dine_in:'å…§ç”¨', takeout:'å¤–å¸¶', delivery:'å¤–é€' };
                    const stLabel = { pending:'å¾…è™•ç†', confirmed:'å·²ç¢ºèª', preparing:'æº–å‚™ä¸­', ready:'å¯å–é¤', completed:'å·²å®Œæˆ', cancelled:'å·²å–æ¶ˆ' };
                    rows.push(['è¨‚å–®è™Ÿ','å•†åº—','å–é¤è™Ÿ','å®¢äºº','é›»è©±','é¡å‹','å“é …æ˜ç´°','åˆè¨ˆ','ç‹€æ…‹','ä¸‹å–®æ™‚é–“']);
                    (od || []).forEach(o => {
                        const itemStr = (o.items || []).map(i => `${i.name}x${i.qty}`).join('ã€');
                        rows.push([o.order_number, o.store_profiles?.store_name || '', o.pickup_number || '', o.customer_name || '', o.customer_phone || '', typeLabel[o.order_type] || o.order_type || '', itemStr, o.total, stLabel[o.status] || o.status, o.created_at?.substring(0, 16).replace('T', ' ') || '']);
                    });
                    fn = `è¨‚å–®å ±è¡¨_${ms}.csv`;
                }

                if (rows.length <= 1) { showToast('âš ï¸ ç„¡è³‡æ–™'); return; }
                const csv = '\uFEFF' + rows.map(r => r.map(c => `"${String(c??'').replace(/"/g,'""')}"`).join(',')).join('\n');
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
                a.download = fn; a.click();
                writeAuditLog('export',type,null,fn,{rows:rows.length-1});
                showToast(`âœ… ${fn}ï¼ˆ${rows.length-1} ç­†ï¼‰`);
            } catch(e) { showToast('âŒ åŒ¯å‡ºå¤±æ•—ï¼š'+friendlyError(e)); }
        }

        // ===== å®¢æˆ¶ç®¡ç† =====
        let adminClients = [];

        async function loadClientList() {
            try {
                const { data } = await sb.from('clients').select('*').order('company_name');
                adminClients = data || [];
                renderClientList(adminClients);
            } catch(e) { console.error('è¼‰å…¥å®¢æˆ¶å¤±æ•—', e); }
        }

        function filterClients() {
            const q = (document.getElementById('clientSearch')?.value || '').toLowerCase();
            const filtered = q ? adminClients.filter(c => c.company_name.toLowerCase().includes(q)) : adminClients;
            renderClientList(filtered);
        }

        function renderClientList(list) {
            const el = document.getElementById('clientList');
            if (!el) return;
            if (list.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">ç„¡å®¢æˆ¶è³‡æ–™</p>';
                return;
            }
            el.innerHTML = list.map(c => {
                const catBadge = c.category === 'vip'
                    ? '<span style="background:#FEF3C7;color:#92400E;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700;">VIP â­</span>'
                    : '<span style="background:#F1F5F9;color:#64748B;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700;">ä¸€èˆ¬</span>';
                return `<div style="background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:14px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <span style="font-weight:700;font-size:14px;">${escapeHTML(c.company_name)}</span>
                        ${catBadge}
                    </div>
                    <div style="font-size:12px;color:#64748B;">
                        ${c.contact_name ? 'ğŸ‘¤ ' + escapeHTML(c.contact_name) + ' ' : ''}
                        ${c.phone ? 'ğŸ“ ' + escapeHTML(c.phone) : ''}
                        ${c.industry ? ' Â· ' + escapeHTML(c.industry) : ''}
                    </div>
                    ${c.address ? '<div style="font-size:11px;color:#94A3B8;margin-top:4px;">ğŸ“ ' + escapeHTML(c.address) + '</div>' : ''}
                    <div style="display:flex;gap:6px;margin-top:8px;">
                        <button class="btn btn-secondary" onclick="editClient('${c.id}')" style="font-size:11px;padding:6px 12px;">ç·¨è¼¯</button>
                        <button class="btn btn-secondary" onclick="toggleClientActive('${c.id}',${c.is_active})" style="font-size:11px;padding:6px 12px;color:${c.is_active ? '#EF4444' : '#059669'};">${c.is_active ? 'åœç”¨' : 'å•Ÿç”¨'}</button>
                    </div>
                </div>`;
            }).join('');
        }

        function showClientModal(id) {
            document.getElementById('clientModal').style.display = 'block';
            document.getElementById('clientEditId').value = id || '';
            document.getElementById('clientModalTitle').textContent = id ? 'ç·¨è¼¯å®¢æˆ¶' : 'æ–°å¢å®¢æˆ¶';
            if (!id) {
                ['clientCompanyName','clientContactName','clientPhone','clientAddress','clientLat','clientLng','clientIndustry','clientNotes'].forEach(f => {
                    const el = document.getElementById(f); if (el) el.value = '';
                });
                document.getElementById('clientCategory').value = 'general';
            }
        }

        function closeClientModal() {
            document.getElementById('clientModal').style.display = 'none';
        }

        function editClient(id) {
            const c = adminClients.find(x => x.id === id);
            if (!c) return;
            showClientModal(id);
            document.getElementById('clientCompanyName').value = c.company_name || '';
            document.getElementById('clientContactName').value = c.contact_name || '';
            document.getElementById('clientPhone').value = c.phone || '';
            document.getElementById('clientAddress').value = c.address || '';
            document.getElementById('clientLat').value = c.latitude || '';
            document.getElementById('clientLng').value = c.longitude || '';
            document.getElementById('clientCategory').value = c.category || 'general';
            document.getElementById('clientIndustry').value = c.industry || '';
            document.getElementById('clientNotes').value = c.notes || '';
        }

        async function getClientGPS() {
            try {
                showToast('ğŸ“ å®šä½ä¸­...');
                const loc = await getGPS();
                document.getElementById('clientLat').value = loc.latitude.toFixed(6);
                document.getElementById('clientLng').value = loc.longitude.toFixed(6);
                showToast('âœ… åº§æ¨™å·²å–å¾—');
            } catch(e) { showToast('âŒ å®šä½å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        async function saveClient() {
            const name = document.getElementById('clientCompanyName').value.trim();
            if (!name) return showToast('è«‹è¼¸å…¥å…¬å¸åç¨±');
            const id = document.getElementById('clientEditId').value;
            const record = {
                company_name: name,
                contact_name: document.getElementById('clientContactName').value.trim(),
                phone: document.getElementById('clientPhone').value.trim(),
                address: document.getElementById('clientAddress').value.trim(),
                latitude: parseFloat(document.getElementById('clientLat').value) || null,
                longitude: parseFloat(document.getElementById('clientLng').value) || null,
                category: document.getElementById('clientCategory').value,
                industry: document.getElementById('clientIndustry').value.trim(),
                notes: document.getElementById('clientNotes').value.trim(),
                updated_at: new Date().toISOString()
            };
            try {
                if (id) {
                    const { error } = await sb.from('clients').update(record).eq('id', id);
                    if (error) throw error;
                    writeAuditLog('update_client','clients',id,name);
                    showToast('âœ… å®¢æˆ¶å·²æ›´æ–°');
                } else {
                    const { error } = await sb.from('clients').insert(record);
                    if (error) throw error;
                    writeAuditLog('create_client','clients',null,name);
                    showToast('âœ… å®¢æˆ¶å·²æ–°å¢');
                }
                closeClientModal();
                loadClientList();
            } catch(e) { showToast('âŒ å„²å­˜å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        async function toggleClientActive(id, isActive) {
            const action = isActive ? 'åœç”¨' : 'å•Ÿç”¨';
            if (!confirm(`ç¢ºå®š${action}æ­¤å®¢æˆ¶ï¼Ÿ`)) return;
            try {
                const { error } = await sb.from('clients').update({ is_active: !isActive, updated_at: new Date().toISOString() }).eq('id', id);
                if (error) throw error;
                showToast(`âœ… å·²${action}`);
                loadClientList();
            } catch(e) { showToast('âŒ æ“ä½œå¤±æ•—ï¼š' + friendlyError(e)); }
        }

        // ===== æœå‹™é …ç›®ç®¡ç† =====
        async function loadServiceItemList() {
            try {
                const { data } = await sb.from('service_items').select('*').order('name');
                const el = document.getElementById('serviceItemList');
                if (!el) return;
                if (!data || data.length === 0) {
                    el.innerHTML = '<p style="color:#94A3B8;font-size:12px;">å°šç„¡æœå‹™é …ç›®</p>';
                    return;
                }
                el.innerHTML = data.map(s =>
                    `<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #F1F5F9;">
                        <span style="flex:1;font-size:13px;font-weight:600;">${escapeHTML(s.name)}</span>
                        <span style="font-size:11px;color:#94A3B8;">${escapeHTML(s.code || '')}</span>
                        <button onclick="deleteServiceItem('${s.id}','${escapeHTML(s.name)}')" style="background:none;border:none;color:#EF4444;font-size:12px;cursor:pointer;">åˆªé™¤</button>
                    </div>`
                ).join('');
            } catch(e) { console.error(e); }
        }

        async function addServiceItem() {
            const name = document.getElementById('newServiceItemName')?.value.trim();
            if (!name) return showToast('è«‹è¼¸å…¥æœå‹™é …ç›®åç¨±');
            try {
                const { error } = await sb.from('service_items').insert({ name, code: name.substring(0, 10).toUpperCase() });
                if (error) throw error;
                document.getElementById('newServiceItemName').value = '';
                showToast('âœ… å·²æ–°å¢');
                loadServiceItemList();
            } catch(e) { showToast('âŒ æ–°å¢å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        async function deleteServiceItem(id, name) {
            if (!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) return;
            try {
                const { error } = await sb.from('service_items').update({ is_active: false }).eq('id', id);
                if (error) throw error;
                showToast('âœ… å·²åˆªé™¤');
                loadServiceItemList();
            } catch(e) { showToast('âŒ åˆªé™¤å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        // ===== å¤–å‹¤å¯©æ ¸ =====
        let fwaLogs = [];

        function initFieldWorkApproval() {
            // é è¨­æ—¥æœŸï¼šä»Šå¤©
            const today = getTaiwanDate();
            document.getElementById('fwaDateFrom').value = today;
            document.getElementById('fwaDateTo').value = today;
            loadFieldWorkApprovals();
        }

        async function loadFieldWorkApprovals() {
            const from = document.getElementById('fwaDateFrom').value;
            const to = document.getElementById('fwaDateTo').value;
            const status = document.getElementById('fwaStatusFilter').value;
            if (!from || !to) return showToast('è«‹é¸æ“‡æ—¥æœŸ');

            try {
                let query = sb.from('field_work_logs')
                    .select('*, employees(name, employee_number), clients(company_name), service_items(name)')
                    .gte('work_date', from)
                    .lte('work_date', to)
                    .order('work_date', { ascending: false })
                    .order('arrive_time', { ascending: false });
                if (status) query = query.eq('status', status);

                const { data, error } = await query;
                if (error) throw error;
                fwaLogs = data || [];

                // çµ±è¨ˆ
                document.getElementById('fwaTotal').textContent = fwaLogs.length;
                document.getElementById('fwaPending').textContent = fwaLogs.filter(l => l.status === 'submitted').length;
                const totalH = fwaLogs.reduce((s, l) => s + (l.work_hours || 0), 0);
                document.getElementById('fwaTotalHours').textContent = totalH.toFixed(1);

                renderFieldWorkApprovals();
            } catch(e) {
                console.error(e);
                showToast('âŒ æŸ¥è©¢å¤±æ•—ï¼š' + friendlyError(e));
            }
        }

        function renderFieldWorkApprovals() {
            const el = document.getElementById('fwaList');
            if (!el) return;
            if (fwaLogs.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">ç„¡ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</p>';
                return;
            }
            el.innerHTML = fwaLogs.map(log => {
                const statusMap = { draft:'ğŸŸ¡ è‰ç¨¿', submitted:'ğŸ”µ å¾…å¯©æ ¸', approved:'ğŸŸ¢ å·²æ ¸å‡†', rejected:'ğŸ”´ å·²é€€å›' };
                const statusLabel = statusMap[log.status] || log.status;
                const empName = log.employees?.name || '?';
                const clientName = log.clients?.company_name || '-';
                const serviceName = log.service_items?.name || '';
                const arriveT = log.arrive_time ? new Date(log.arrive_time).toLocaleTimeString('zh-TW', { hour:'2-digit', minute:'2-digit' }) : '--:--';
                const leaveT = log.leave_time ? new Date(log.leave_time).toLocaleTimeString('zh-TW', { hour:'2-digit', minute:'2-digit' }) : '--:--';
                const hours = log.work_hours ? log.work_hours.toFixed(1) + 'h' : '';

                return `<div style="background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:14px;margin-bottom:8px;cursor:pointer;" onclick="showFwaDetail('${log.id}')">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                        <span style="font-weight:700;font-size:13px;">${escapeHTML(empName)}</span>
                        <span style="font-size:12px;">${statusLabel}</span>
                    </div>
                    <div style="font-size:12px;color:#475569;margin-bottom:2px;">
                        ğŸ¢ ${escapeHTML(clientName)}
                        ${serviceName ? ' Â· ' + escapeHTML(serviceName) : ''}
                    </div>
                    <div style="font-size:11px;color:#94A3B8;">
                        ${log.work_date} ${arriveT} â†’ ${leaveT} ${hours ? '(' + hours + ')' : ''}
                        ${log.mileage ? ' Â· ' + log.mileage + 'km' : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function showFwaDetail(logId) {
            const log = fwaLogs.find(l => l.id === logId);
            if (!log) return;
            const modal = document.getElementById('fwaDetailModal');
            const content = document.getElementById('fwaDetailContent');
            const actions = document.getElementById('fwaDetailActions');

            const empName = log.employees?.name || '?';
            const empNo = log.employees?.employee_number || '';
            const clientName = log.clients?.company_name || '-';
            const serviceName = log.service_items?.name || '-';
            const arriveT = log.arrive_time ? new Date(log.arrive_time).toLocaleString('zh-TW') : '-';
            const leaveT = log.leave_time ? new Date(log.leave_time).toLocaleString('zh-TW') : '-';

            let photosHtml = '';
            if (log.photo_urls && log.photo_urls.length > 0) {
                photosHtml = '<div style="margin-top:8px;"><b style="font-size:12px;">ç…§ç‰‡ï¼š</b><div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;">' +
                    log.photo_urls.map(url => `<img src="${url}" style="width:100px;height:100px;object-fit:cover;border-radius:8px;border:1px solid #E2E8F0;cursor:pointer;" onclick="window.open('${url}','_blank')">`).join('') +
                    '</div></div>';
            }

            let signatureHtml = '';
            if (log.signature_url) {
                signatureHtml = `<div style="margin-top:8px;"><b style="font-size:12px;">å®¢æˆ¶ç°½åï¼š</b><br><img src="${log.signature_url}" style="max-width:200px;border:1px solid #E2E8F0;border-radius:8px;margin-top:4px;"></div>`;
            }

            content.innerHTML = `
                <h3 style="margin-bottom:12px;">å¤–å‹¤æ˜ç´°</h3>
                <div style="font-size:13px;line-height:2;">
                    <div><b>å“¡å·¥ï¼š</b>${escapeHTML(empName)} (${escapeHTML(empNo)})</div>
                    <div><b>å®¢æˆ¶ï¼š</b>${escapeHTML(clientName)}</div>
                    <div><b>æœå‹™é …ç›®ï¼š</b>${escapeHTML(serviceName)}</div>
                    <div><b>æ—¥æœŸï¼š</b>${log.work_date}</div>
                    <div><b>åˆ°é”ï¼š</b>${arriveT}</div>
                    <div><b>é›¢é–‹ï¼š</b>${leaveT}</div>
                    <div><b>å·¥æ™‚ï¼š</b>${log.work_hours ? log.work_hours.toFixed(1) + ' å°æ™‚' : '-'}</div>
                    <div><b>é‡Œç¨‹ï¼š</b>${log.mileage || 0} km</div>
                    ${log.arrive_lat ? `<div><b>åˆ°é”GPSï¼š</b>${log.arrive_lat.toFixed(5)}, ${log.arrive_lng.toFixed(5)}</div>` : ''}
                    ${log.leave_lat ? `<div><b>é›¢é–‹GPSï¼š</b>${log.leave_lat.toFixed(5)}, ${log.leave_lng.toFixed(5)}</div>` : ''}
                    ${log.work_content ? `<div style="margin-top:6px;"><b>å·¥ä½œå…§å®¹ï¼š</b><div style="background:#F8FAFC;padding:8px;border-radius:8px;margin-top:4px;white-space:pre-wrap;">${escapeHTML(log.work_content)}</div></div>` : ''}
                    ${log.notes ? `<div><b>å‚™è¨»ï¼š</b>${escapeHTML(log.notes)}</div>` : ''}
                </div>
                ${photosHtml}
                ${signatureHtml}
            `;

            if (log.status === 'submitted') {
                actions.innerHTML = `
                    <button class="btn btn-success" onclick="approveFieldWork('${log.id}')" style="flex:1;font-size:14px;padding:12px;">âœ… æ ¸å‡†</button>
                    <button class="btn btn-secondary" onclick="rejectFieldWork('${log.id}')" style="flex:1;font-size:14px;padding:12px;color:#EF4444;">âŒ é€€å›</button>
                `;
            } else {
                actions.innerHTML = '';
            }

            modal.style.display = 'block';
        }

        function closeFwaDetailModal() {
            document.getElementById('fwaDetailModal').style.display = 'none';
        }

        async function approveFieldWork(logId) {
            if (!confirm('ç¢ºå®šæ ¸å‡†æ­¤ç­†å¤–å‹¤ç´€éŒ„ï¼Ÿ')) return;
            try {
                const { error } = await sb.from('field_work_logs').update({
                    status: 'approved',
                    updated_at: new Date().toISOString()
                }).eq('id', logId);
                if (error) throw error;
                writeAuditLog('approve_field_work','field_work_logs',logId,'æ ¸å‡†');
                showToast('âœ… å·²æ ¸å‡†');
                closeFwaDetailModal();
                loadFieldWorkApprovals();
            } catch(e) { showToast('âŒ æ“ä½œå¤±æ•—ï¼š' + friendlyError(e)); }
        }

        async function rejectFieldWork(logId) {
            const reason = prompt('é€€å›åŸå› ï¼ˆé¸å¡«ï¼‰ï¼š');
            if (reason === null) return;
            try {
                const { error } = await sb.from('field_work_logs').update({
                    status: 'rejected',
                    notes: reason || 'é€€å›',
                    updated_at: new Date().toISOString()
                }).eq('id', logId);
                if (error) throw error;
                writeAuditLog('reject_field_work','field_work_logs',logId,'é€€å›');
                showToast('âœ… å·²é€€å›');
                closeFwaDetailModal();
                loadFieldWorkApprovals();
            } catch(e) { showToast('âŒ æ“ä½œå¤±æ•—ï¼š' + friendlyError(e)); }
        }

        function exportFieldWorkCSV() {
            if (fwaLogs.length === 0) return showToast('ç„¡è³‡æ–™å¯åŒ¯å‡º');
            const rows = [['æ—¥æœŸ','å·¥è™Ÿ','å§“å','å®¢æˆ¶','æœå‹™é …ç›®','åˆ°é”æ™‚é–“','é›¢é–‹æ™‚é–“','å·¥æ™‚','é‡Œç¨‹(km)','å·¥ä½œå…§å®¹','ç‹€æ…‹','å‚™è¨»']];
            fwaLogs.forEach(l => {
                rows.push([
                    l.work_date,
                    l.employees?.employee_number || '',
                    l.employees?.name || '',
                    l.clients?.company_name || '',
                    l.service_items?.name || '',
                    l.arrive_time ? new Date(l.arrive_time).toLocaleString('zh-TW') : '',
                    l.leave_time ? new Date(l.leave_time).toLocaleString('zh-TW') : '',
                    l.work_hours || 0,
                    l.mileage || 0,
                    l.work_content || '',
                    l.status,
                    l.notes || ''
                ]);
            });
            const csv = '\uFEFF' + rows.map(r => r.map(c => `"${String(c??'').replace(/"/g,'""')}"`).join(',')).join('\n');
            const a = document.createElement('a');
            const from = document.getElementById('fwaDateFrom').value;
            const to = document.getElementById('fwaDateTo').value;
            const fn = `å¤–å‹¤ç´€éŒ„_${from}_${to}.csv`;
            a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
            a.download = fn; a.click();
            writeAuditLog('export','field_work_logs',null,fn,{rows:rows.length-1});
            showToast(`âœ… å·²åŒ¯å‡º ${fn}ï¼ˆ${rows.length-1} ç­†ï¼‰`);
        }

        // ===== å‹å¥ä¿ç´šè·ç®¡ç† =====
        let insBrackets = [];

        async function loadInsuranceBrackets() {
            try {
                const { data, error } = await sb.from('insurance_brackets')
                    .select('*').eq('is_active', true).order('salary_min');
                if (error) throw error;
                insBrackets = data || [];
                renderInsTable();

                // é¡¯ç¤ºè²»ç‡ï¼ˆå–ç¬¬ä¸€ç­†ï¼‰
                if (insBrackets.length > 0) {
                    const b = insBrackets[0];
                    document.getElementById('insLaborRate').value = ((b.labor_rate || 0.125) * 100).toFixed(2);
                    document.getElementById('insLaborShare').value = ((b.labor_employee_share || 0.2) * 100).toFixed(2);
                    document.getElementById('insHealthRate').value = ((b.health_rate || 0.0517) * 100).toFixed(2);
                    document.getElementById('insHealthShare').value = ((b.health_employee_share || 0.3) * 100).toFixed(2);
                }
            } catch(e) { showToast('âŒ è¼‰å…¥ç´šè·å¤±æ•—'); console.error(e); }
        }

        function renderInsTable() {
            document.getElementById('insCount').textContent = insBrackets.length;
            const tbody = document.getElementById('insTableBody');
            if (insBrackets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding:20px;text-align:center;color:#94A3B8;">å°šç„¡ç´šè·è³‡æ–™</td></tr>';
                return;
            }
            tbody.innerHTML = insBrackets.map(b => `
                <tr style="border-bottom:1px solid #F1F5F9;">
                    <td style="padding:6px;text-align:right;">${Number(b.salary_min).toLocaleString()}</td>
                    <td style="padding:6px;text-align:right;">${Number(b.salary_max).toLocaleString()}</td>
                    <td style="padding:6px;text-align:right;font-weight:600;">${Number(b.insured_amount).toLocaleString()}</td>
                    <td style="padding:6px;text-align:center;">
                        <span onclick="editInsBracket('${b.id}')" style="cursor:pointer;margin-right:6px;">âœï¸</span>
                        <span onclick="deleteInsBracket('${b.id}')" style="cursor:pointer;">ğŸ—‘ï¸</span>
                    </td>
                </tr>
            `).join('');
        }

        function showInsModal(editData) {
            document.getElementById('insEditId').value = editData ? editData.id : '';
            document.getElementById('insModalTitle').textContent = editData ? 'ç·¨è¼¯ç´šè·' : 'æ–°å¢ç´šè·';
            document.getElementById('insSalaryMin').value = editData ? editData.salary_min : '';
            document.getElementById('insSalaryMax').value = editData ? editData.salary_max : '';
            document.getElementById('insAmount').value = editData ? editData.insured_amount : '';
            document.getElementById('insModal').style.display = 'block';
        }
        function closeInsModal() { document.getElementById('insModal').style.display = 'none'; }

        function editInsBracket(id) {
            const b = insBrackets.find(x => x.id === id);
            if (b) showInsModal(b);
        }

        async function saveInsBracket() {
            const id = document.getElementById('insEditId').value;
            const salaryMin = parseFloat(document.getElementById('insSalaryMin').value);
            const salaryMax = parseFloat(document.getElementById('insSalaryMax').value);
            const insuredAmount = parseFloat(document.getElementById('insAmount').value);

            if (isNaN(salaryMin) || isNaN(salaryMax) || isNaN(insuredAmount)) {
                showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´'); return;
            }

            const laborRate = parseFloat(document.getElementById('insLaborRate').value) / 100;
            const laborShare = parseFloat(document.getElementById('insLaborShare').value) / 100;
            const healthRate = parseFloat(document.getElementById('insHealthRate').value) / 100;
            const healthShare = parseFloat(document.getElementById('insHealthShare').value) / 100;

            const row = {
                salary_min: salaryMin, salary_max: salaryMax, insured_amount: insuredAmount,
                labor_rate: laborRate, labor_employee_share: laborShare,
                health_rate: healthRate, health_employee_share: healthShare, is_active: true
            };

            try {
                if (id) {
                    const { error } = await sb.from('insurance_brackets').update(row).eq('id', id);
                    if (error) throw error;
                    writeAuditLog('update', 'insurance_brackets', id, `æŠ•ä¿ ${insuredAmount}`);
                } else {
                    const { error } = await sb.from('insurance_brackets').insert(row);
                    if (error) throw error;
                    writeAuditLog('create', 'insurance_brackets', null, `æŠ•ä¿ ${insuredAmount}`);
                }
                closeInsModal();
                showToast('âœ… å·²å„²å­˜');
                loadInsuranceBrackets();
            } catch(e) { showToast('âŒ å„²å­˜å¤±æ•—'); console.error(e); }
        }

        async function deleteInsBracket(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ç´šè·ï¼Ÿ')) return;
            try {
                const { error } = await sb.from('insurance_brackets').update({ is_active: false }).eq('id', id);
                if (error) throw error;
                writeAuditLog('delete', 'insurance_brackets', id);
                showToast('âœ… å·²åˆªé™¤');
                loadInsuranceBrackets();
            } catch(e) { showToast('âŒ åˆªé™¤å¤±æ•—'); console.error(e); }
        }

        async function updateAllInsRates() {
            if (!confirm('ç¢ºå®šå°‡è²»ç‡å¥—ç”¨åˆ°æ‰€æœ‰ç´šè·ï¼Ÿ')) return;
            const laborRate = parseFloat(document.getElementById('insLaborRate').value) / 100;
            const laborShare = parseFloat(document.getElementById('insLaborShare').value) / 100;
            const healthRate = parseFloat(document.getElementById('insHealthRate').value) / 100;
            const healthShare = parseFloat(document.getElementById('insHealthShare').value) / 100;

            if (isNaN(laborRate) || isNaN(laborShare) || isNaN(healthRate) || isNaN(healthShare)) {
                showToast('âš ï¸ è²»ç‡æ ¼å¼éŒ¯èª¤'); return;
            }

            try {
                const { error } = await sb.from('insurance_brackets').update({
                    labor_rate: laborRate, labor_employee_share: laborShare,
                    health_rate: healthRate, health_employee_share: healthShare
                }).eq('is_active', true);
                if (error) throw error;
                writeAuditLog('update', 'insurance_brackets', null, `è²»ç‡æ›´æ–°ï¼šå‹ä¿${(laborRate*100).toFixed(2)}%/${(laborShare*100).toFixed(2)}% å¥ä¿${(healthRate*100).toFixed(2)}%/${(healthShare*100).toFixed(2)}%`);
                showToast('âœ… è²»ç‡å·²æ›´æ–°');
                loadInsuranceBrackets();
            } catch(e) { showToast('âŒ æ›´æ–°å¤±æ•—'); console.error(e); }
        }

        // ===== å…¬å¸ç®¡ç† =====
        let allCompanies = [];

        async function loadCompanyList() {
            try {
                const { data, error } = await sb.from('companies').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                allCompanies = data || [];

                // å–å¾—æ¯å®¶å…¬å¸çš„å“¡å·¥æ•¸
                const { data: empCounts } = await sb.from('employees')
                    .select('company_id').eq('is_active', true);
                const countMap = {};
                (empCounts || []).forEach(e => {
                    countMap[e.company_id] = (countMap[e.company_id] || 0) + 1;
                });
                allCompanies.forEach(c => { c._empCount = countMap[c.id] || 0; });

                renderCompanyList(allCompanies);
            } catch(e) { showToast('âŒ è¼‰å…¥å…¬å¸åˆ—è¡¨å¤±æ•—'); console.error(e); }
        }

        function filterCompanies() {
            const q = (document.getElementById('companySearch').value || '').toLowerCase();
            const filtered = allCompanies.filter(c =>
                c.name.toLowerCase().includes(q) || (c.code || '').toLowerCase().includes(q)
            );
            renderCompanyList(filtered);
        }

        function renderCompanyList(list) {
            const el = document.getElementById('companyList');
            if (list.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">ç„¡å…¬å¸è³‡æ–™</p>';
                return;
            }
            el.innerHTML = list.map(c => `
                <div style="background:#fff;border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,0.06);display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <div style="font-weight:700;font-size:15px;color:#0F172A;">${escapeHTML(c.name)}</div>
                        <div style="font-size:12px;color:#64748B;margin-top:2px;">ä»£ç¢¼ï¼š${escapeHTML(c.code)} ï½œ å“¡å·¥ï¼š${c._empCount} äºº</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <span style="font-size:11px;padding:2px 8px;border-radius:20px;background:${c.is_active?'#D1FAE5':'#FEE2E2'};color:${c.is_active?'#065F46':'#991B1B'};">${c.is_active?'å•Ÿç”¨':'åœç”¨'}</span>
                        <span onclick="editCompany('${c.id}')" style="cursor:pointer;">âœï¸</span>
                    </div>
                </div>
            `).join('');
        }

        function showCompanyModal(editData) {
            document.getElementById('companyEditId').value = editData ? editData.id : '';
            document.getElementById('companyModalTitle').textContent = editData ? 'ç·¨è¼¯å…¬å¸' : 'æ–°å¢å…¬å¸';
            document.getElementById('companyCode').value = editData ? editData.code : '';
            document.getElementById('companyName').value = editData ? editData.name : '';
            document.getElementById('companyIsActive').value = editData ? String(editData.is_active) : 'true';
            document.getElementById('companyModal').style.display = 'block';
        }
        function closeCompanyModal() { document.getElementById('companyModal').style.display = 'none'; }

        function editCompany(id) {
            const c = allCompanies.find(x => x.id === id);
            if (c) showCompanyModal(c);
        }

        async function saveCompany() {
            const id = document.getElementById('companyEditId').value;
            const code = document.getElementById('companyCode').value.trim().toUpperCase();
            const name = document.getElementById('companyName').value.trim();
            const isActive = document.getElementById('companyIsActive').value === 'true';

            if (!code || !name) { showToast('âš ï¸ è«‹å¡«å¯«ä»£ç¢¼å’Œåç¨±'); return; }

            const row = { code, name, is_active: isActive };

            try {
                if (id) {
                    const { error } = await sb.from('companies').update(row).eq('id', id);
                    if (error) throw error;
                    writeAuditLog('update', 'companies', id, name);
                } else {
                    const { error } = await sb.from('companies').insert(row);
                    if (error) throw error;
                    writeAuditLog('create', 'companies', null, `${name} (${code})`);
                }
                closeCompanyModal();
                showToast('âœ… å·²å„²å­˜');
                loadCompanyList();
            } catch(e) {
                if (String(e).includes('unique') || String(e?.message||'').includes('unique')) {
                    showToast('âš ï¸ å…¬å¸ä»£ç¢¼å·²å­˜åœ¨');
                } else {
                    showToast('âŒ å„²å­˜å¤±æ•—'); console.error(e);
                }
            }
        }

        // ===== é¤é£²æ¥­ç®¡ç† =====
        let smStores = [];
        let smCurrentStoreId = null;
        let rdCurrentStoreId = null;
        let smCategories = [];
        let smItems = [];
        let rdOrders = [];
        let miOptionGroups = []; // å®¢è£½åŒ–é¸é …æš«å­˜
        let miComboGroups = []; // å¥—é¤çµ„åˆæš«å­˜

        // --- å•†åº—åˆ—è¡¨ ---
        async function loadRestaurantList() {
            try {
                let q = sb.from('store_profiles').select('*').order('created_at', { ascending: false });
                if (currentCompanyId) q = q.eq('company_id', currentCompanyId);
                const { data } = await q;
                smStores = data || [];
                // è¼‰å…¥æ¯åº—ä»Šæ—¥è¨‚å–®çµ±è¨ˆ
                const today = fmtDate(new Date());
                const { data: todayOrders } = await sb.from('orders').select('store_id, status, total').gte('created_at', today + 'T00:00:00');
                const stats = {};
                (todayOrders || []).forEach(o => {
                    if (!stats[o.store_id]) stats[o.store_id] = { total: 0, pending: 0, revenue: 0 };
                    stats[o.store_id].total++;
                    if (o.status === 'pending') stats[o.store_id].pending++;
                    if (o.status !== 'cancelled') stats[o.store_id].revenue += parseFloat(o.total) || 0;
                });
                renderRestaurantList(stats);
            } catch(e) { console.error(e); }
        }

        function renderRestaurantList(stats) {
            const el = document.getElementById('restaurantStoreList');
            if (smStores.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">å°šç„¡å•†åº—ï¼Œè«‹é»ã€Œ+ æ–°å¢å•†åº—ã€å»ºç«‹</p>';
                return;
            }
            el.innerHTML = smStores.map(s => {
                const st = stats[s.id] || { total: 0, pending: 0, revenue: 0 };
                return `<div onclick="openRestaurantDetail('${s.id}')" style="background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:14px;margin-bottom:8px;cursor:pointer;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <span style="font-weight:700;font-size:15px;">${escapeHTML(s.store_name)}</span>
                        <span style="font-size:11px;padding:2px 10px;border-radius:10px;background:${s.is_active !== false ? '#D1FAE5' : '#F1F5F9'};color:${s.is_active !== false ? '#059669' : '#94A3B8'};font-weight:600;">${s.is_active !== false ? 'ç‡Ÿæ¥­ä¸­' : 'æš«åœ'}</span>
                    </div>
                    <div style="display:flex;gap:12px;font-size:12px;color:#64748B;">
                        <span>ä»Šæ—¥ <b style="color:#1E40AF;">${st.total}</b> å–®</span>
                        ${st.pending > 0 ? '<span style="color:#DC2626;font-weight:700;">å¾…è™•ç† ' + st.pending + '</span>' : ''}
                        <span>ç‡Ÿæ”¶ <b style="color:#059669;">$${st.revenue}</b></span>
                    </div>
                </div>`;
            }).join('');
        }

        // --- å•†åº—è©³æƒ… ---
        async function openRestaurantDetail(storeId) {
            rdCurrentStoreId = storeId;
            smCurrentStoreId = storeId;
            const s = smStores.find(x => x.id === storeId);
            if (!s) return;
            document.getElementById('rdStoreName').textContent = s.store_name;
            // é è¦½é€£çµ
            const previewUrl = getStoreOrderUrl(s);
            document.getElementById('rdStorePreviewLink').innerHTML = `
                <div style="background:#EEF2FF;border-radius:8px;padding:8px 12px;display:flex;align-items:center;gap:8px;">
                    <span style="font-size:11px;color:#4F46E5;flex:1;word-break:break-all;">${escapeHTML(previewUrl)}</span>
                    <button onclick="navigator.clipboard.writeText('${previewUrl}').then(()=>showToast('âœ… å·²è¤‡è£½'))" style="padding:4px 8px;border:1px solid #C7D2FE;border-radius:6px;background:#fff;font-size:11px;cursor:pointer;white-space:nowrap;">ğŸ“‹ è¤‡è£½</button>
                </div>`;
            // æ¥å–®ç‹€æ…‹
            renderAcceptOrderToggle(s);
            // é è¨­é¡¯ç¤ºè¨‚å–® Tab
            switchRestaurantTab('orders', document.querySelector('.rdTab'));
            showPage('restaurantDetailPage');
        }
        function previewStoreOrder() {
            const s = smStores.find(x => x.id === rdCurrentStoreId);
            if (!s) return showToast('æ‰¾ä¸åˆ°å•†åº—è³‡æ–™');
            window.open(getStoreOrderUrl(s), '_blank');
        }

        function renderAcceptOrderToggle(s) {
            const on = s.accept_orders !== false;
            document.getElementById('rdAcceptOrderToggle').innerHTML = `
                <button onclick="toggleAcceptOrders('${s.id}', ${!on})" style="width:100%;padding:10px;border:none;border-radius:10px;background:${on ? '#D1FAE5' : '#FEF2F2'};color:${on ? '#059669' : '#DC2626'};font-weight:700;font-size:13px;cursor:pointer;">
                    ${on ? 'ğŸŸ¢ é–‹æ”¾æ¥å–®ä¸­ â€” é»æ“Šæš«åœ' : 'ğŸ”´ å·²æš«åœæ¥å–® â€” é»æ“Šé–‹æ”¾'}
                </button>`;
        }

        async function toggleAcceptOrders(storeId, accept) {
            try {
                await sb.from('store_profiles').update({ accept_orders: accept, updated_at: new Date().toISOString() }).eq('id', storeId);
                const s = smStores.find(x => x.id === storeId);
                if (s) s.accept_orders = accept;
                renderAcceptOrderToggle(s || { accept_orders: accept });
                showToast(accept ? 'ğŸŸ¢ å·²é–‹æ”¾æ¥å–®' : 'ğŸ”´ å·²æš«åœæ¥å–®');
            } catch(e) { showToast('âŒ æ“ä½œå¤±æ•—'); }
        }

        function switchRestaurantTab(tab, el) {
            // åˆ‡æ› Tab æ¨£å¼
            document.querySelectorAll('.rdTab').forEach(t => {
                t.style.borderBottom = 'none'; t.style.color = '#94A3B8'; t.classList.remove('rdTabActive');
            });
            if (el) { el.style.borderBottom = '3px solid #4F46E5'; el.style.color = '#4F46E5'; el.classList.add('rdTabActive'); }
            document.getElementById('rdOrdersTab').style.display = tab === 'orders' ? '' : 'none';
            document.getElementById('rdMenuTab').style.display = tab === 'menu' ? '' : 'none';
            document.getElementById('rdSettingsTab').style.display = tab === 'settings' ? '' : 'none';
            if (tab === 'orders') loadStoreOrders();
            if (tab === 'menu') { loadMenuCategories(); loadMenuItems(); }
            if (tab === 'settings') loadStoreSettings();
        }

        // --- è¨‚å–® Tab ---
        async function loadStoreOrders() {
            try {
                let q = sb.from('orders').select('*').eq('store_id', rdCurrentStoreId).order('created_at', { ascending: false }).limit(100);
                const statusFilter = document.getElementById('rdStatusFilter').value;
                if (statusFilter) q = q.eq('status', statusFilter);
                const { data } = await q;
                rdOrders = data || [];
                renderStoreOrderList();
                updateStoreOrderStats();
                renderTopSelling();
            } catch(e) { console.error(e); }
        }

        function updateStoreOrderStats() {
            const today = fmtDate(new Date());
            const todayOrders = rdOrders.filter(o => o.created_at && o.created_at.startsWith(today));
            const pending = rdOrders.filter(o => o.status === 'pending').length;
            const revenue = todayOrders.filter(o => o.status !== 'cancelled').reduce((s, o) => s + (parseFloat(o.total) || 0), 0);
            document.getElementById('rdPendingCount').textContent = pending;
            document.getElementById('rdTodayCount').textContent = todayOrders.length;
            document.getElementById('rdTodayRevenue').textContent = '$' + revenue;
        }

        function renderTopSelling() {
            const today = fmtDate(new Date());
            const todayOrders = rdOrders.filter(o => o.created_at && o.created_at.startsWith(today) && o.status !== 'cancelled');
            const itemCount = {};
            todayOrders.forEach(o => (o.items || []).forEach(i => {
                itemCount[i.name] = (itemCount[i.name] || 0) + (i.qty || 1);
            }));
            const sorted = Object.entries(itemCount).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const el = document.getElementById('rdTopSelling');
            if (sorted.length === 0) { el.style.display = 'none'; return; }
            el.style.display = '';
            el.innerHTML = '<div style="font-weight:700;margin-bottom:4px;">ğŸ”¥ ä»Šæ—¥ç†±éŠ·</div>' +
                sorted.map((s, i) => `<span style="margin-right:10px;">${i+1}. ${escapeHTML(s[0])} Ã—${s[1]}</span>`).join('');
        }

        function renderStoreOrderList() {
            const el = document.getElementById('rdOrderList');
            if (rdOrders.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">å°šç„¡è¨‚å–®</p>';
                return;
            }
            const statusMap = {
                pending: { label:'å¾…è™•ç†', color:'#92400E', bg:'#FEF3C7' },
                confirmed: { label:'å·²ç¢ºèª', color:'#1E40AF', bg:'#DBEAFE' },
                preparing: { label:'æº–å‚™ä¸­', color:'#7C3AED', bg:'#F5F3FF' },
                ready: { label:'å¯å–é¤', color:'#059669', bg:'#D1FAE5' },
                completed: { label:'å·²å®Œæˆ', color:'#64748B', bg:'#F1F5F9' },
                cancelled: { label:'å·²å–æ¶ˆ', color:'#DC2626', bg:'#FEF2F2' }
            };
            el.innerHTML = rdOrders.map(o => {
                const st = statusMap[o.status] || { label:o.status, color:'#64748B', bg:'#F1F5F9' };
                const time = o.created_at ? new Date(o.created_at).toLocaleString('zh-TW', { hour:'2-digit', minute:'2-digit' }) : '';
                const itemCount = (o.items || []).reduce((s, i) => s + (i.qty || 1), 0);
                const pickup = o.pickup_number ? '#' + String(o.pickup_number).padStart(3, '0') + ' ' : '';
                const typeLabel = { dine_in:'å…§ç”¨', takeout:'å¤–å¸¶', delivery:'å¤–é€' };
                return `<div onclick="showOrderDetail('${o.id}')" style="background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:14px;margin-bottom:8px;cursor:pointer;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                        <span style="font-weight:700;font-size:14px;">${pickup}#${escapeHTML(o.order_number)}</span>
                        <span style="font-size:11px;font-weight:600;padding:2px 10px;border-radius:10px;background:${st.bg};color:${st.color};">${st.label}</span>
                    </div>
                    <div style="font-size:12px;color:#64748B;">
                        ${escapeHTML(o.customer_name || '?')}
                        ${o.order_type ? ' Â· ' + (typeLabel[o.order_type] || o.order_type) : ''}
                        ${o.table_number ? ' Â· æ¡Œ' + escapeHTML(o.table_number) : ''}
                        ${o.pickup_time ? ' Â· å–é¤ ' + escapeHTML(o.pickup_time) : ''}
                        Â· ${itemCount}å“ Â· <b>$${o.total}</b> Â· ${time}
                    </div>
                </div>`;
            }).join('');
        }

        function showOrderDetail(orderId) {
            const o = rdOrders.find(x => x.id === orderId);
            if (!o) return;
            const pickup = o.pickup_number ? ' å–é¤è™Ÿ #' + String(o.pickup_number).padStart(3, '0') : '';
            document.getElementById('odTitle').textContent = '#' + o.order_number + pickup;
            const typeLabel = { dine_in:'å…§ç”¨', takeout:'å¤–å¸¶', delivery:'å¤–é€' };
            const items = o.items || [];
            document.getElementById('odContent').innerHTML = `
                <div style="margin-bottom:12px;">
                    <div style="font-size:13px;color:#64748B;">é¡§å®¢</div>
                    <div style="font-weight:600;">${escapeHTML(o.customer_name || '?')} ${o.customer_phone ? 'Â· ' + escapeHTML(o.customer_phone) : ''}</div>
                    <div style="font-size:13px;color:#64748B;">${typeLabel[o.order_type] || ''} ${o.table_number ? 'Â· æ¡Œè™Ÿ ' + escapeHTML(o.table_number) : ''} ${o.pickup_time ? 'Â· å–é¤ ' + escapeHTML(o.pickup_time) : ''}</div>
                </div>
                <div style="border-top:1px solid #F1F5F9;padding-top:8px;">
                    ${items.map(i => {
                        const optStr = i.options ? '<div style="font-size:11px;color:#94A3B8;margin-left:16px;">' + escapeHTML(i.options) + '</div>' : '';
                        return `<div style="padding:4px 0;font-size:14px;">
                            <div style="display:flex;justify-content:space-between;">
                                <span>${escapeHTML(i.name)} x${i.qty}</span>
                                <span style="font-weight:600;">$${i.subtotal || i.price * i.qty}</span>
                            </div>${optStr}
                        </div>`;
                    }).join('')}
                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-top:1px solid #E2E8F0;margin-top:4px;font-weight:800;">
                        <span>åˆè¨ˆ</span><span>$${o.total}</span>
                    </div>
                </div>
                ${o.notes ? '<div style="margin-top:8px;font-size:13px;color:#64748B;">å‚™è¨»ï¼š' + escapeHTML(o.notes) + '</div>' : ''}
            `;
            const actions = [];
            if (o.status === 'pending') {
                actions.push(`<button onclick="updateOrderStatus('${o.id}','confirmed')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#2563EB;color:#fff;font-weight:600;cursor:pointer;">âœ… ç¢ºèª</button>`);
                actions.push(`<button onclick="updateOrderStatus('${o.id}','cancelled')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#EF4444;color:#fff;font-weight:600;cursor:pointer;">âŒ å–æ¶ˆ</button>`);
            }
            if (o.status === 'confirmed') actions.push(`<button onclick="updateOrderStatus('${o.id}','preparing')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#7C3AED;color:#fff;font-weight:600;cursor:pointer;">ğŸ³ é–‹å§‹æº–å‚™</button>`);
            if (o.status === 'preparing') actions.push(`<button onclick="updateOrderStatus('${o.id}','ready')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#059669;color:#fff;font-weight:600;cursor:pointer;">ğŸ”” å¯å–é¤</button>`);
            if (o.status === 'ready') actions.push(`<button onclick="updateOrderStatus('${o.id}','completed')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#64748B;color:#fff;font-weight:600;cursor:pointer;">âœ… å®Œæˆ</button>`);
            document.getElementById('odActions').innerHTML = actions.join('');
            document.getElementById('orderDetailModal').style.display = 'flex';
        }

        function closeOrderDetail() { document.getElementById('orderDetailModal').style.display = 'none'; }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                await sb.from('orders').update({ status: newStatus, updated_at: new Date().toISOString() }).eq('id', orderId);
                // LINE æ¨æ’­çµ¦å®¢äºº
                const o = rdOrders.find(x => x.id === orderId);
                if (o?.customer_line_id) {
                    const pickup = o.pickup_number ? '#' + String(o.pickup_number).padStart(3, '0') : '#' + o.order_number;
                    const msgs = {
                        confirmed: `âœ… æ‚¨çš„è¨‚å–® ${pickup} å·²ç¢ºèªï¼Œæ­£åœ¨æº–å‚™ä¸­`,
                        ready: `ğŸ”” æ‚¨çš„é¤é» ${pickup} å·²å®Œæˆï¼Œè«‹å–é¤ï¼`,
                        cancelled: `âŒ æ‚¨çš„è¨‚å–® ${pickup} å·²å–æ¶ˆ`
                    };
                    if (msgs[newStatus]) {
                        try { await sb.functions.invoke('send-line-notify', { body: { userId: o.customer_line_id, message: msgs[newStatus] } }); } catch(e2) { console.warn('æ¨æ’­å¤±æ•—', e2); }
                    }
                }
                showToast('âœ… ç‹€æ…‹å·²æ›´æ–°');
                closeOrderDetail();
                await loadStoreOrders();
            } catch(e) {
                console.error(e);
                showToast('âŒ æ›´æ–°å¤±æ•—');
            }
        }

        // --- å•†åº—åŸºæœ¬ CRUD ---
        async function showStoreModal(storeId) {
            if (storeId) {
                let s = smStores.find(x => x.id === storeId);
                if (!s) {
                    // å˜—è©¦å¾ DB é‡æ–°è¼‰å…¥
                    const { data } = await sb.from('store_profiles').select('*').eq('id', storeId).maybeSingle();
                    if (!data) return showToast('æ‰¾ä¸åˆ°å•†åº—è³‡æ–™');
                    s = data;
                    smStores.push(s);
                }
                document.getElementById('storeModalTitle').textContent = 'ç·¨è¼¯å•†åº—';
                document.getElementById('storeEditId').value = s.id;
                document.getElementById('storeNameInput').value = s.store_name;
                document.getElementById('storeSlugInput').value = s.store_slug || '';
                document.getElementById('storeTypeSelect').value = s.store_type || 'restaurant';
                document.getElementById('storeDescInput').value = s.description || '';
                document.getElementById('storePhoneInput').value = s.phone || '';
                document.getElementById('storeAddressInput').value = s.address || '';
                document.getElementById('storeColorInput').value = s.theme_color || '#4F46E5';
            } else {
                document.getElementById('storeModalTitle').textContent = 'æ–°å¢å•†åº—';
                document.getElementById('storeEditId').value = '';
                document.getElementById('storeNameInput').value = '';
                document.getElementById('storeSlugInput').value = '';
                document.getElementById('storeTypeSelect').value = 'restaurant';
                document.getElementById('storeDescInput').value = '';
                document.getElementById('storePhoneInput').value = '';
                document.getElementById('storeAddressInput').value = '';
                document.getElementById('storeColorInput').value = '#4F46E5';
            }
            document.getElementById('storeModal').style.display = 'flex';
        }
        function editStore(id) { showStoreModal(id); }
        function closeStoreModal() { document.getElementById('storeModal').style.display = 'none'; }

        async function saveStore() {
            const name = document.getElementById('storeNameInput').value.trim();
            if (!name) return showToast('è«‹è¼¸å…¥å•†åº—åç¨±');
            const record = {
                store_name: name,
                store_slug: document.getElementById('storeSlugInput').value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '') || null,
                store_type: document.getElementById('storeTypeSelect').value,
                description: document.getElementById('storeDescInput').value.trim() || null,
                phone: document.getElementById('storePhoneInput').value.trim() || null,
                address: document.getElementById('storeAddressInput').value.trim() || null,
                theme_color: document.getElementById('storeColorInput').value
            };
            if (currentCompanyId) record.company_id = currentCompanyId;
            try {
                const editId = document.getElementById('storeEditId').value;
                let res;
                if (editId) {
                    record.updated_at = new Date().toISOString();
                    res = await sb.from('store_profiles').update(record).eq('id', editId);
                } else {
                    res = await sb.from('store_profiles').insert(record);
                }
                if (res.error) throw res.error;
                showToast('âœ… å•†åº—å·²å„²å­˜');
                closeStoreModal();
                await loadRestaurantList();
            } catch(e) { showToast('âŒ å„²å­˜å¤±æ•—ï¼š' + (e.message || e)); }
        }

        function showStoreQR(storeId) {
            const s = smStores.find(x => x.id === storeId);
            if (!s) return showToast('æ‰¾ä¸åˆ°å•†åº—è³‡æ–™');
            const url = getStoreOrderUrl(s);
            document.getElementById('storeQRTitle').textContent = s.store_name;
            document.getElementById('storeQRUrl').textContent = url;
            const qrEl = document.getElementById('storeQRCode');
            qrEl.innerHTML = '';
            if (typeof QRCode !== 'undefined') {
                new QRCode(qrEl, { text: url, width: 200, height: 200 });
            } else { qrEl.innerHTML = '<p style="color:#94A3B8;">QRCode å…ƒä»¶æœªè¼‰å…¥</p>'; }
            document.getElementById('storeQRModal').style.display = 'flex';
        }
        function closeStoreQR() { document.getElementById('storeQRModal').style.display = 'none'; }
        function getStoreOrderUrl(s) {
            const slug = s.store_slug || s.id;
            const base = location.hostname === 'localhost' ? location.origin : 'https://' + location.hostname;
            return base + location.pathname.replace('admin.html', 'order.html') + '?store=' + slug;
        }
        function copyStoreUrl() {
            const url = document.getElementById('storeQRUrl').textContent;
            navigator.clipboard.writeText(url).then(() => showToast('âœ… å·²è¤‡è£½é€£çµ')).catch(() => showToast('è¤‡è£½å¤±æ•—'));
        }
        function openStorePreview() {
            const url = document.getElementById('storeQRUrl').textContent;
            window.open(url, '_blank');
        }

        // --- èœå–®ç®¡ç† ---
        async function loadMenuCategories() {
            const { data } = await sb.from('menu_categories').select('*').eq('store_id', smCurrentStoreId).order('sort_order');
            smCategories = data || [];
            renderMenuCatList();
            updateMiCategorySelect();
        }
        function renderMenuCatList() {
            const el = document.getElementById('menuCatList');
            if (smCategories.length === 0) { el.innerHTML = '<p style="font-size:12px;color:#94A3B8;">å°šç„¡åˆ†é¡</p>'; return; }
            el.innerHTML = smCategories.map(c => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #F1F5F9;">
                    <span style="font-size:13px;font-weight:600;">${escapeHTML(c.name)}</span>
                    <button onclick="deleteMenuCategory('${c.id}')" style="background:none;border:none;color:#EF4444;cursor:pointer;font-size:12px;">åˆªé™¤</button>
                </div>`).join('');
        }
        function updateMiCategorySelect() {
            document.getElementById('miCategory').innerHTML = '<option value="">-- ä¸åˆ†é¡ --</option>' +
                smCategories.map(c => `<option value="${c.id}">${escapeHTML(c.name)}</option>`).join('');
        }
        async function addMenuCategory() {
            const name = document.getElementById('newCatName').value.trim();
            if (!name) return showToast('è«‹è¼¸å…¥åˆ†é¡åç¨±');
            try {
                await sb.from('menu_categories').insert({ store_id: smCurrentStoreId, name, sort_order: smCategories.length });
                document.getElementById('newCatName').value = '';
                showToast('âœ… åˆ†é¡å·²æ–°å¢');
                await loadMenuCategories();
            } catch(e) { showToast('âŒ æ–°å¢å¤±æ•—'); }
        }
        async function deleteMenuCategory(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤åˆ†é¡ï¼Ÿï¼ˆå“é …ä¸æœƒè¢«åˆªé™¤ï¼‰')) return;
            try { await sb.from('menu_categories').delete().eq('id', id); showToast('âœ… å·²åˆªé™¤'); await loadMenuCategories(); }
            catch(e) { showToast('âŒ åˆªé™¤å¤±æ•—'); }
        }

        async function loadMenuItems() {
            const { data } = await sb.from('menu_items').select('*, menu_categories(name)').eq('store_id', smCurrentStoreId).order('sort_order');
            smItems = data || [];
            renderMenuItemList();
        }
        function renderMenuItemList() {
            const el = document.getElementById('menuItemList');
            const countEl = document.getElementById('menuItemCount');
            if (countEl) {
                const avail = smItems.filter(i => i.is_available !== false).length;
                countEl.textContent = smItems.length + ' å€‹å“é … Â· ' + avail + ' å€‹ä¸Šæ¶ä¸­';
            }
            if (smItems.length === 0) { el.innerHTML = '<p style="font-size:12px;color:#94A3B8;text-align:center;padding:20px;">å°šç„¡å“é …ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢</p>'; return; }
            // æŒ‰åˆ†é¡åˆ†çµ„
            const grouped = {};
            smItems.forEach(i => {
                const catName = i.menu_categories?.name || 'æœªåˆ†é¡';
                const catId = i.category_id || '__none__';
                if (!grouped[catId]) grouped[catId] = { name: catName, items: [] };
                grouped[catId].items.push(i);
            });
            let html = '';
            for (const catId of Object.keys(grouped)) {
                const g = grouped[catId];
                const cat = smCategories.find(c => c.id === catId);
                html += `<div style="margin-bottom:16px;">
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;padding:0 4px;">
                        <span style="font-size:13px;font-weight:800;color:#334155;">${escapeHTML(g.name)}</span>
                        <span style="font-size:11px;color:#94A3B8;">${g.items.length}</span>
                    </div>`;
                html += g.items.map(i => {
                    const optCount = (i.options && Array.isArray(i.options)) ? i.options.length : 0;
                    const imgHtml = i.image_url
                        ? `<div class="mi-card-img"><img src="${i.image_url}" loading="lazy"></div>`
                        : `<div class="mi-card-img">ğŸ½</div>`;
                    let badges = '';
                    if (i.is_combo) badges += '<span class="mi-badge mi-badge-combo">å¥—é¤</span>';
                    if (!i.is_available) badges += '<span class="mi-badge mi-badge-sold">å”®å®Œ</span>';
                    return `<div class="mi-card${i.is_available === false ? ' sold-out' : ''}">
                        ${imgHtml}
                        <div class="mi-card-info">
                            <div class="name">${escapeHTML(i.name)} ${badges}</div>
                            <div class="meta">
                                <span class="price">$${i.price}</span>
                                ${optCount ? '<span>' + optCount + 'çµ„é¸é …</span>' : ''}
                            </div>
                        </div>
                        <div style="display:flex;gap:4px;flex-shrink:0;">
                            <button onclick="toggleItemAvail('${i.id}',${!i.is_available})" style="padding:6px 10px;border:1px solid ${i.is_available ? '#E2E8F0' : '#059669'};border-radius:8px;background:${i.is_available ? '#fff' : '#ECFDF5'};color:${i.is_available ? '#64748B' : '#059669'};font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;">${i.is_available !== false ? 'æ¨™å”®å®Œ' : 'ä¸Šæ¶'}</button>
                            <button onclick="editMenuItem('${i.id}')" style="padding:6px 10px;border:1px solid #E2E8F0;border-radius:8px;background:#fff;color:#4F46E5;font-size:11px;font-weight:700;cursor:pointer;">ç·¨è¼¯</button>
                        </div>
                    </div>`;
                }).join('');
                html += '</div>';
            }
            el.innerHTML = html;
        }

        // --- å…¨è¢å¹•æŠ½å±œ ---
        let miIsComboOn = false;
        let miPreviewMode = false;

        function showMenuItemForm(itemId) {
            const drawer = document.getElementById('miDrawer');
            const mask = document.getElementById('miDrawerMask');
            drawer.style.display = 'flex';
            mask.style.display = 'block';
            miPreviewMode = false;
            document.getElementById('miPreviewPanel').style.display = 'none';
            document.getElementById('miFormPanel').style.display = '';
            document.getElementById('miPreviewBtn').style.borderColor = '#E2E8F0';
            document.getElementById('miPreviewBtn').style.background = '#fff';
            document.getElementById('miPreviewBtn').style.color = '#64748B';

            if (itemId) {
                const i = smItems.find(x => x.id === itemId);
                if (!i) return;
                document.getElementById('miEditId').value = i.id;
                document.getElementById('miDrawerTitle').textContent = 'ç·¨è¼¯å“é …';
                document.getElementById('miSaveBtn').textContent = 'âœ… æ›´æ–°å“é …';
                document.getElementById('miDeleteBtn').style.display = '';
                document.getElementById('miName').value = i.name;
                document.getElementById('miCategory').value = i.category_id || '';
                document.getElementById('miPrice').value = i.price;
                document.getElementById('miDesc').value = i.description || '';
                document.getElementById('miImageUrl').value = i.image_url || '';
                const preview = document.getElementById('miImagePreview');
                const placeholder = document.getElementById('miImagePlaceholder');
                if (i.image_url) { preview.src = i.image_url; preview.style.display = 'block'; placeholder.style.display = 'none'; }
                else { preview.style.display = 'none'; placeholder.style.display = ''; }
                miOptionGroups = (i.options && Array.isArray(i.options)) ? JSON.parse(JSON.stringify(i.options)) : [];
                miIsComboOn = !!i.is_combo;
                miComboGroups = (i.combo_config && i.combo_config.groups) ? JSON.parse(JSON.stringify(i.combo_config.groups)) : [];
            } else {
                document.getElementById('miEditId').value = '';
                document.getElementById('miDrawerTitle').textContent = 'æ–°å¢å“é …';
                document.getElementById('miSaveBtn').textContent = 'âœ… æ–°å¢å“é …';
                document.getElementById('miDeleteBtn').style.display = 'none';
                document.getElementById('miName').value = '';
                document.getElementById('miCategory').value = '';
                document.getElementById('miPrice').value = '';
                document.getElementById('miDesc').value = '';
                document.getElementById('miImageUrl').value = '';
                document.getElementById('miImagePreview').style.display = 'none';
                document.getElementById('miImagePlaceholder').style.display = '';
                miOptionGroups = [];
                miIsComboOn = false;
                miComboGroups = [];
            }
            updateComboSwitchUI();
            renderOptionEditor();
            renderComboEditor();
            // å¦‚æœæœ‰é¸é …ï¼Œå±•é–‹é¸é …å€
            if (miOptionGroups.length > 0) {
                const sec = document.getElementById('miOptionsSection');
                if (sec) { sec.style.display = ''; sec.previousElementSibling.querySelector('.arrow').classList.add('open'); }
            }
            // å¦‚æœæ˜¯å¥—é¤ï¼Œå±•é–‹å¥—é¤å€
            if (miIsComboOn) {
                const sec = document.getElementById('miComboSection');
                if (sec) { sec.style.display = ''; sec.previousElementSibling.querySelector('.arrow').classList.add('open'); }
                document.getElementById('miComboEditor').style.display = '';
            }
            // æ›´æ–°é¸é … badge
            updateOptBadge();
        }
        function editMenuItem(id) { showMenuItemForm(id); }
        function cancelMenuItemForm() {
            document.getElementById('miDrawer').style.display = 'none';
            document.getElementById('miDrawerMask').style.display = 'none';
        }

        function toggleMiSection(hd) {
            const bd = hd.nextElementSibling;
            const arrow = hd.querySelector('.arrow');
            if (bd.style.display === 'none') {
                bd.style.display = '';
                arrow.classList.add('open');
            } else {
                bd.style.display = 'none';
                arrow.classList.remove('open');
            }
        }

        function toggleMiPreview() {
            miPreviewMode = !miPreviewMode;
            const btn = document.getElementById('miPreviewBtn');
            if (miPreviewMode) {
                syncOptionEditor();
                document.getElementById('miFormPanel').style.display = 'none';
                document.getElementById('miPreviewPanel').style.display = '';
                btn.style.borderColor = '#4F46E5'; btn.style.background = '#EEF2FF'; btn.style.color = '#4F46E5';
                renderMiPreview();
            } else {
                document.getElementById('miFormPanel').style.display = '';
                document.getElementById('miPreviewPanel').style.display = 'none';
                btn.style.borderColor = '#E2E8F0'; btn.style.background = '#fff'; btn.style.color = '#64748B';
            }
        }

        function renderMiPreview() {
            const name = document.getElementById('miName').value.trim() || 'å“å';
            const price = parseFloat(document.getElementById('miPrice').value) || 0;
            const desc = document.getElementById('miDesc').value.trim();
            const imgUrl = document.getElementById('miImageUrl').value;
            const imgHtml = imgUrl ? `<img src="${imgUrl}" style="width:100%;height:100%;object-fit:cover;">` : 'ğŸ“·';
            let optHtml = '';
            miOptionGroups.forEach(g => {
                if (!g.name) return;
                optHtml += `<div style="margin-bottom:10px;">
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
                        <span style="font-size:12px;font-weight:800;color:#1E293B;">${escapeHTML(g.name)}</span>
                        ${g.required ? '<span style="font-size:9px;padding:1px 5px;background:#FEE2E2;color:#DC2626;border-radius:4px;font-weight:700;">å¿…é¸</span>' : ''}
                        <span style="font-size:10px;color:#94A3B8;">${g.type === 'single' ? 'å–®é¸' : 'å¯å¤šé¸'}</span>
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:4px;">
                        ${(g.choices || []).filter(c => c.label).map((c, j) => {
                            const sel = j === 0 && g.type === 'single';
                            return `<span style="padding:5px 10px;border:1.5px solid ${sel ? '#4F46E5' : '#E2E8F0'};border-radius:8px;background:${sel ? '#EEF2FF' : '#fff'};font-size:12px;font-weight:600;color:${sel ? '#4F46E5' : '#334155'};">${escapeHTML(c.label)}${c.price > 0 ? '<span style="color:#94A3B8;margin-left:4px;">+$' + c.price + '</span>' : ''}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            });
            document.getElementById('miPreviewPanel').innerHTML = `
                <div class="mi-preview">
                    <div style="font-size:10px;font-weight:700;color:#94A3B8;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">ğŸ“± å®¢äººçœ‹åˆ°çš„æ¨£å­</div>
                    <div class="mi-preview-phone">
                        <div class="mi-preview-img">${imgHtml}</div>
                        <div class="mi-preview-bd">
                            <div style="font-size:16px;font-weight:800;color:#0F172A;margin-bottom:4px;">${escapeHTML(name)}</div>
                            ${desc ? '<div style="font-size:12px;color:#64748B;margin-bottom:8px;">' + escapeHTML(desc) + '</div>' : ''}
                            <div style="font-size:18px;font-weight:900;color:#4F46E5;margin-bottom:12px;">$ ${price}</div>
                            ${optHtml}
                            <button style="width:100%;padding:12px;border:none;border-radius:12px;background:linear-gradient(135deg,#4F46E5,#3730A3);color:#fff;font-size:14px;font-weight:800;margin-top:8px;cursor:default;">ğŸ›’ åŠ å…¥è³¼ç‰©è»Š Â· $${price}</button>
                        </div>
                    </div>
                </div>`;
        }

        function updateOptBadge() {
            const badge = document.getElementById('miOptBadge');
            if (miOptionGroups.length > 0) {
                badge.textContent = miOptionGroups.length + 'çµ„';
                badge.style.display = '';
            } else {
                badge.style.display = 'none';
            }
        }

        // --- å¥—é¤ toggle switch ---
        function toggleComboSwitch() {
            miIsComboOn = !miIsComboOn;
            updateComboSwitchUI();
            document.getElementById('miComboEditor').style.display = miIsComboOn ? '' : 'none';
        }
        function updateComboSwitchUI() {
            const toggle = document.getElementById('miComboToggle');
            const knob = document.getElementById('miComboKnob');
            const label = document.getElementById('miComboLabel');
            if (miIsComboOn) {
                toggle.style.background = '#4F46E5';
                knob.style.left = '22px';
                label.style.color = '#4F46E5';
            } else {
                toggle.style.background = '#CBD5E1';
                knob.style.left = '2px';
                label.style.color = '#64748B';
            }
        }

        async function saveMenuItem() {
            const name = document.getElementById('miName').value.trim();
            const price = parseFloat(document.getElementById('miPrice').value);
            if (!name) return showToast('è«‹è¼¸å…¥å“å');
            if (isNaN(price) || price < 0) return showToast('è«‹è¼¸å…¥æœ‰æ•ˆåƒ¹æ ¼');
            syncOptionEditor();
            syncComboEditor();
            const record = {
                store_id: smCurrentStoreId, name,
                category_id: document.getElementById('miCategory').value || null,
                price,
                description: document.getElementById('miDesc').value.trim() || null,
                image_url: document.getElementById('miImageUrl').value || null,
                options: miOptionGroups.length > 0 ? miOptionGroups : null,
                is_combo: miIsComboOn,
                combo_config: miIsComboOn && miComboGroups.length > 0 ? { groups: miComboGroups } : null
            };
            try {
                const editId = document.getElementById('miEditId').value;
                let res;
                if (editId) {
                    record.updated_at = new Date().toISOString();
                    res = await sb.from('menu_items').update(record).eq('id', editId);
                } else {
                    record.sort_order = smItems.length;
                    res = await sb.from('menu_items').insert(record);
                }
                if (res.error) throw res.error;
                showToast('âœ… å“é …å·²å„²å­˜');
                cancelMenuItemForm();
                await loadMenuItems();
            } catch(e) { showToast('âŒ å„²å­˜å¤±æ•—ï¼š' + (e.message || e)); }
        }

        async function deleteMenuItem() {
            const editId = document.getElementById('miEditId').value;
            if (!editId) return;
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å“é …å—ï¼Ÿ')) return;
            try {
                const res = await sb.from('menu_items').delete().eq('id', editId);
                if (res.error) throw res.error;
                showToast('âœ… å“é …å·²åˆªé™¤');
                cancelMenuItemForm();
                await loadMenuItems();
            } catch(e) { showToast('âŒ åˆªé™¤å¤±æ•—ï¼š' + (e.message || e)); }
        }

        async function toggleItemAvail(id, avail) {
            try {
                await sb.from('menu_items').update({ is_available: avail, updated_at: new Date().toISOString() }).eq('id', id);
                showToast(avail ? 'âœ… å·²æ¢å¾©ä¸Šæ¶' : 'ğŸ”´ å·²æ¨™è¨˜å”®å®Œ');
                await loadMenuItems();
            } catch(e) { showToast('âŒ æ“ä½œå¤±æ•—'); }
        }

        // --- å“é …åœ–ç‰‡ä¸Šå‚³ ---
        async function handleMenuImageUpload(input) {
            const file = input.files[0];
            if (!file) return;
            try {
                showToast('â˜ï¸ ä¸Šå‚³ä¸­...');
                const bitmap = await createImageBitmap(file);
                let cw = bitmap.width, ch = bitmap.height;
                const MAX = 400;
                if (cw > MAX) { ch = Math.round(ch * MAX / cw); cw = MAX; }
                if (ch > MAX) { cw = Math.round(cw * MAX / ch); ch = MAX; }
                const canvas = document.createElement('canvas');
                canvas.width = cw; canvas.height = ch;
                canvas.getContext('2d').drawImage(bitmap, 0, 0, cw, ch);
                const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.7));
                const s = smStores.find(x => x.id === smCurrentStoreId);
                const slug = s?.store_slug || smCurrentStoreId;
                const fileName = `menu/${slug}/${Date.now()}.jpg`;
                const { error } = await sb.storage.from(CONFIG.BUCKET).upload(fileName, blob);
                if (error) throw error;
                const { data: urlData } = sb.storage.from(CONFIG.BUCKET).getPublicUrl(fileName);
                const url = urlData?.publicUrl || urlData?.publicURL;
                document.getElementById('miImageUrl').value = url;
                const preview = document.getElementById('miImagePreview');
                preview.src = url; preview.style.display = 'block';
                const placeholder = document.getElementById('miImagePlaceholder');
                if (placeholder) placeholder.style.display = 'none';
                showToast('âœ… åœ–ç‰‡å·²ä¸Šå‚³');
            } catch(e) { showToast('âŒ åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼š' + (e.message || e)); }
            input.value = '';
        }

        // --- å®¢è£½åŒ–é¸é …ï¼ˆè¦–è¦ºåŒ–ç·¨è¼¯å™¨ï¼‰---
        const OPTION_TEMPLATES = {
            drink: [
                { name: 'ç”œåº¦', required: true, type: 'single', choices: [{label:'æ­£å¸¸ç³–',price:0},{label:'å°‘ç³–',price:0},{label:'åŠç³–',price:0},{label:'å¾®ç³–',price:0},{label:'ç„¡ç³–',price:0}] },
                { name: 'å†°é‡', required: true, type: 'single', choices: [{label:'æ­£å¸¸å†°',price:0},{label:'å°‘å†°',price:0},{label:'å¾®å†°',price:0},{label:'å»å†°',price:0},{label:'ç†±é£²',price:0}] }
            ],
            food: [
                { name: 'è¾£åº¦', required: false, type: 'single', choices: [{label:'ä¸è¾£',price:0},{label:'å°è¾£',price:0},{label:'ä¸­è¾£',price:0},{label:'å¤§è¾£',price:0}] },
                { name: 'åŠ æ–™', required: false, type: 'multi', choices: [{label:'åŠ è›‹',price:10},{label:'åŠ èµ·å¸',price:15},{label:'åŠ åŸ¹æ ¹',price:20}] }
            ],
            size: [
                { name: 'å°ºå¯¸', required: true, type: 'single', choices: [{label:'å°',price:0},{label:'ä¸­',price:10},{label:'å¤§',price:20}] }
            ]
        };
        function applyOptionTemplate(tpl) {
            syncOptionEditor();
            const newGroups = JSON.parse(JSON.stringify(OPTION_TEMPLATES[tpl] || []));
            miOptionGroups = [...miOptionGroups, ...newGroups];
            renderOptionEditor();
            updateOptBadge();
        }
        function addOptionGroup() {
            syncOptionEditor();
            miOptionGroups.push({ name: '', required: false, type: 'single', choices: [{ label: '', price: 0 }] });
            renderOptionEditor();
            updateOptBadge();
        }
        function removeOptionGroup(idx) { syncOptionEditor(); miOptionGroups.splice(idx, 1); renderOptionEditor(); updateOptBadge(); }
        function addOptionChoice(gIdx) {
            syncOptionEditor();
            miOptionGroups[gIdx].choices.push({ label: '', price: 0 });
            renderOptionEditor();
        }
        function removeOptionChoice(gIdx, cIdx) { syncOptionEditor(); miOptionGroups[gIdx].choices.splice(cIdx, 1); renderOptionEditor(); }
        function toggleOptionType(gIdx, type) {
            syncOptionEditor();
            miOptionGroups[gIdx].type = type;
            renderOptionEditor();
        }
        function toggleOptionReq(gIdx) {
            syncOptionEditor();
            miOptionGroups[gIdx].required = !miOptionGroups[gIdx].required;
            renderOptionEditor();
        }
        function syncOptionEditor() {
            document.querySelectorAll('.optGrp').forEach((grpEl, gIdx) => {
                if (!miOptionGroups[gIdx]) return;
                miOptionGroups[gIdx].name = grpEl.querySelector('.optGrpName').value;
                grpEl.querySelectorAll('.optChoice').forEach((cEl, cIdx) => {
                    if (!miOptionGroups[gIdx].choices[cIdx]) return;
                    miOptionGroups[gIdx].choices[cIdx].label = cEl.querySelector('.optCLabel').value;
                    miOptionGroups[gIdx].choices[cIdx].price = parseFloat(cEl.querySelector('.optCPrice').value) || 0;
                });
            });
        }
        function renderOptionEditor() {
            const el = document.getElementById('miOptionsEditor');
            // æ¨¡æ¿æŒ‰éˆ• + ç¾¤çµ„åˆ—è¡¨
            let html = `<div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;align-items:center;">
                <span style="font-size:11px;color:#94A3B8;">å¿«é€Ÿå¥—ç”¨ï¼š</span>
                <button class="mi-tpl-btn" onclick="applyOptionTemplate('drink')">â˜• é£²æ–™</button>
                <button class="mi-tpl-btn" onclick="applyOptionTemplate('food')">ğŸœ é¤é»</button>
                <button class="mi-tpl-btn" onclick="applyOptionTemplate('size')">ğŸ“ å°ºå¯¸</button>
            </div>`;
            if (miOptionGroups.length === 0) {
                html += '<p style="font-size:12px;color:#94A3B8;text-align:center;padding:8px;">å°šç„¡å®¢è£½é¸é …</p>';
            } else {
                html += miOptionGroups.map((g, gIdx) => `
                    <div class="optGrp og-card">
                        <div class="og-header">
                            <span style="color:#94A3B8;cursor:grab;font-size:14px;">â ¿</span>
                            <input class="optGrpName" value="${escapeHTML(g.name)}" placeholder="ç¾¤çµ„åç¨±ï¼ˆå¦‚ï¼šè¾£åº¦ï¼‰" style="flex:1;padding:8px 10px;border:1.5px solid #E2E8F0;border-radius:8px;font-size:13px;font-weight:700;outline:none;background:#fff;">
                            <div class="og-toggle-group">
                                <button class="og-toggle${g.type==='single'?' active':''}" onclick="toggleOptionType(${gIdx},'single')">å–®é¸</button>
                                <button class="og-toggle${g.type==='multi'?' active':''}" onclick="toggleOptionType(${gIdx},'multi')">å¤šé¸</button>
                            </div>
                            <button class="og-req-btn ${g.required?'on':'off'}" onclick="toggleOptionReq(${gIdx})">å¿…é¸</button>
                            <button class="og-del-btn" onclick="removeOptionGroup(${gIdx})">âœ•</button>
                        </div>
                        ${g.choices.map((c, cIdx) => `
                            <div class="optChoice og-choice">
                                <span style="font-size:10px;color:#CBD5E1;">${g.type === 'single' ? 'â—‹' : 'â˜'}</span>
                                <input class="optCLabel og-choice-name" value="${escapeHTML(c.label)}" placeholder="é¸é …åç¨±">
                                <div class="og-price-wrap">
                                    <span class="prefix">+$</span>
                                    <input class="optCPrice" type="number" value="${c.price}" min="0">
                                </div>
                                <button onclick="removeOptionChoice(${gIdx},${cIdx})" style="width:24px;height:24px;border:none;border-radius:6px;background:transparent;color:#94A3B8;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;">âœ•</button>
                            </div>
                        `).join('')}
                        <button onclick="addOptionChoice(${gIdx})" style="padding:4px 10px;border:1px dashed #CBD5E1;border-radius:6px;background:transparent;font-size:11px;color:#64748B;cursor:pointer;margin-top:2px;margin-left:24px;">+ æ–°å¢é¸é …</button>
                    </div>
                `).join('');
            }
            html += `<button onclick="addOptionGroup()" style="width:100%;padding:10px;border:1.5px dashed #CBD5E1;border-radius:10px;background:transparent;font-size:12px;font-weight:700;color:#64748B;cursor:pointer;margin-top:4px;">+ æ–°å¢é¸é …ç¾¤çµ„</button>`;
            el.innerHTML = html;
        }

        // --- å¥—é¤çµ„åˆç·¨è¼¯å™¨ ---
        function addComboGroup() {
            miComboGroups.push({ name: '', pick: 1, items: [] });
            renderComboEditor();
        }
        function removeComboGroup(idx) { miComboGroups.splice(idx, 1); renderComboEditor(); }
        function syncComboEditor() {
            document.querySelectorAll('#miComboGroups .comboGrp').forEach((grpEl, gIdx) => {
                if (!miComboGroups[gIdx]) return;
                miComboGroups[gIdx].name = grpEl.querySelector('.comboGrpName').value;
                miComboGroups[gIdx].pick = parseInt(grpEl.querySelector('.comboGrpPick').value) || 1;
                // æ”¶é›†å‹¾é¸çš„å“é … ID
                const checked = grpEl.querySelectorAll('.comboItemCheck:checked');
                miComboGroups[gIdx].items = Array.from(checked).map(c => c.value);
            });
        }
        function renderComboEditor() {
            const el = document.getElementById('miComboGroups');
            if (!el) return;
            if (miComboGroups.length === 0) { el.innerHTML = '<p style="font-size:11px;color:#94A3B8;">å°šç„¡å¥—é¤ç¾¤çµ„</p>'; return; }
            // å–å¾—ç›®å‰å•†åº—çš„æ‰€æœ‰å“é …ï¼ˆæ’é™¤è‡ªå·±ï¼‰
            const editId = document.getElementById('miEditId').value;
            const availItems = smItems.filter(i => i.id !== editId);
            el.innerHTML = miComboGroups.map((g, gIdx) => `
                <div class="comboGrp" style="border:1px solid #E2E8F0;border-radius:8px;padding:10px;margin-bottom:8px;background:#fff;">
                    <div style="display:flex;gap:4px;align-items:center;margin-bottom:6px;">
                        <input class="comboGrpName" value="${escapeHTML(g.name)}" placeholder="ç¾¤çµ„åç¨±ï¼ˆå¦‚ï¼šä¸»é¤é¸1ï¼‰" onchange="syncComboEditor()" style="flex:1;padding:6px;border:1px solid #E2E8F0;border-radius:6px;font-size:12px;">
                        <span style="font-size:11px;white-space:nowrap;">é¸</span>
                        <select class="comboGrpPick" onchange="syncComboEditor()" style="padding:4px;border:1px solid #E2E8F0;border-radius:6px;font-size:11px;">
                            <option value="-1" ${g.pick===-1?'selected':''}>ä»»é¸</option>
                            <option value="1" ${g.pick===1?'selected':''}>1</option>
                            <option value="2" ${g.pick===2?'selected':''}>2</option>
                            <option value="3" ${g.pick===3?'selected':''}>3</option>
                        </select>
                        <button onclick="removeComboGroup(${gIdx})" style="background:none;border:none;color:#EF4444;cursor:pointer;font-size:14px;">Ã—</button>
                    </div>
                    <div style="max-height:150px;overflow-y:auto;margin-left:8px;">
                        ${availItems.length === 0 ? '<p style="font-size:11px;color:#94A3B8;">è«‹å…ˆæ–°å¢å…¶ä»–å“é …</p>' :
                        availItems.map(item => `
                            <label style="display:flex;align-items:center;gap:6px;font-size:12px;padding:2px 0;cursor:pointer;">
                                <input type="checkbox" class="comboItemCheck" value="${item.id}" ${g.items.includes(item.id)?'checked':''} onchange="syncComboEditor()">
                                ${escapeHTML(item.name)} ($${item.price})
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // --- è¨­å®š Tab ---
        function loadStoreSettings() {
            const s = smStores.find(x => x.id === rdCurrentStoreId);
            if (!s) return;
            // åŸºæœ¬è³‡æ–™
            document.getElementById('rdStoreInfo').innerHTML = `
                <div>åç¨±ï¼š${escapeHTML(s.store_name)}</div>
                <div>é¡å‹ï¼š${{ restaurant:'é¤é£²', service:'æœå‹™æ¥­', retail:'é›¶å”®' }[s.store_type] || s.store_type}</div>
                ${s.phone ? '<div>é›»è©±ï¼š' + escapeHTML(s.phone) + '</div>' : ''}
                ${s.address ? '<div>åœ°å€ï¼š' + escapeHTML(s.address) + '</div>' : ''}
                ${s.store_slug ? '<div>Slugï¼š' + escapeHTML(s.store_slug) + '</div>' : ''}
            `;
            // ç‡Ÿæ¥­æ™‚é–“
            const bh = s.business_hours || {};
            const days = [['mon','ä¸€'],['tue','äºŒ'],['wed','ä¸‰'],['thu','å››'],['fri','äº”'],['sat','å…­'],['sun','æ—¥']];
            document.getElementById('rdBusinessHours').innerHTML = days.map(([key, label]) => {
                const d = bh[key] || { open: true, start: '08:00', end: '20:00' };
                return `<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:13px;" data-day="${key}">
                    <span style="width:24px;font-weight:600;">${label}</span>
                    <label style="font-size:12px;"><input type="checkbox" class="bhOpen" ${d.open ? 'checked' : ''}> ç‡Ÿæ¥­</label>
                    <input type="time" class="bhStart" value="${d.start || '08:00'}" style="padding:4px;border:1px solid #E2E8F0;border-radius:6px;font-size:12px;">
                    <span>~</span>
                    <input type="time" class="bhEnd" value="${d.end || '20:00'}" style="padding:4px;border:1px solid #E2E8F0;border-radius:6px;font-size:12px;">
                </div>`;
            }).join('');
            // LINE ç¾¤çµ„
            document.getElementById('rdLineGroupId').value = s.line_group_id || '';
            // é›†é»è¨­å®š
            const lc = s.loyalty_config || {};
            document.getElementById('rdLoyaltySpend').value = lc.spend_per_point || '';
            document.getElementById('rdLoyaltyPoints').value = lc.points_to_redeem || '';
            document.getElementById('rdLoyaltyDiscount').value = lc.discount_amount || '';
        }

        async function saveBusinessHours() {
            const bh = {};
            document.querySelectorAll('#rdBusinessHours [data-day]').forEach(row => {
                bh[row.dataset.day] = {
                    open: row.querySelector('.bhOpen').checked,
                    start: row.querySelector('.bhStart').value,
                    end: row.querySelector('.bhEnd').value
                };
            });
            try {
                await sb.from('store_profiles').update({ business_hours: bh, updated_at: new Date().toISOString() }).eq('id', rdCurrentStoreId);
                const s = smStores.find(x => x.id === rdCurrentStoreId);
                if (s) s.business_hours = bh;
                showToast('âœ… ç‡Ÿæ¥­æ™‚é–“å·²å„²å­˜');
            } catch(e) { showToast('âŒ å„²å­˜å¤±æ•—'); }
        }

        async function saveLineGroupId() {
            const gid = document.getElementById('rdLineGroupId').value.trim();
            try {
                await sb.from('store_profiles').update({ line_group_id: gid || null, updated_at: new Date().toISOString() }).eq('id', rdCurrentStoreId);
                const s = smStores.find(x => x.id === rdCurrentStoreId);
                if (s) s.line_group_id = gid || null;
                showToast('âœ… LINE ç¾¤çµ„å·²å„²å­˜');
            } catch(e) { showToast('âŒ å„²å­˜å¤±æ•—'); }
        }

        async function saveLoyaltyConfig() {
            const config = {
                spend_per_point: parseInt(document.getElementById('rdLoyaltySpend').value) || 50,
                points_to_redeem: parseInt(document.getElementById('rdLoyaltyPoints').value) || 10,
                discount_amount: parseInt(document.getElementById('rdLoyaltyDiscount').value) || 50
            };
            try {
                await sb.from('store_profiles').update({ loyalty_config: config, updated_at: new Date().toISOString() }).eq('id', rdCurrentStoreId);
                const s = smStores.find(x => x.id === rdCurrentStoreId);
                if (s) s.loyalty_config = config;
                showToast('âœ… é›†é»è¨­å®šå·²å„²å­˜');
            } catch(e) { showToast('âŒ å„²å­˜å¤±æ•—'); }
        }

        // --- èœå–®è¤‡è£½ ---
        function showCopyMenuModal() {
            const targets = smStores.filter(s => s.id !== smCurrentStoreId);
            if (targets.length === 0) return showToast('æ²’æœ‰å…¶ä»–å•†åº—å¯ä»¥è¤‡è£½');
            document.getElementById('copyMenuTargets').innerHTML = targets.map(s => `
                <label style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #F1F5F9;font-size:13px;">
                    <input type="checkbox" class="copyTarget" value="${s.id}">
                    ${escapeHTML(s.store_name)}
                </label>
            `).join('');
            document.getElementById('copyMenuModal').style.display = 'flex';
        }
        function closeCopyMenuModal() { document.getElementById('copyMenuModal').style.display = 'none'; }
        async function executeCopyMenu() {
            const targets = [];
            document.querySelectorAll('.copyTarget:checked').forEach(cb => targets.push(cb.value));
            if (targets.length === 0) return showToast('è«‹é¸æ“‡ç›®æ¨™å•†åº—');
            if (!confirm(`ç¢ºå®šå°‡èœå–®è¤‡è£½åˆ° ${targets.length} é–“å•†åº—ï¼Ÿæœƒè¦†è“‹ç›®æ¨™çš„ç¾æœ‰èœå–®ã€‚`)) return;
            try {
                for (const targetId of targets) {
                    // åˆªé™¤ç›®æ¨™çš„ç¾æœ‰èœå–®
                    await sb.from('menu_items').delete().eq('store_id', targetId);
                    await sb.from('menu_categories').delete().eq('store_id', targetId);
                    // è¤‡è£½åˆ†é¡
                    const catMap = {};
                    for (const c of smCategories) {
                        const { data } = await sb.from('menu_categories').insert({ store_id: targetId, name: c.name, sort_order: c.sort_order }).select().single();
                        catMap[c.id] = data.id;
                    }
                    // è¤‡è£½å“é …
                    for (const i of smItems) {
                        await sb.from('menu_items').insert({
                            store_id: targetId,
                            name: i.name, category_id: i.category_id ? catMap[i.category_id] : null,
                            price: i.price, description: i.description, image_url: i.image_url,
                            is_available: i.is_available, sort_order: i.sort_order, options: i.options, tags: i.tags
                        });
                    }
                }
                showToast(`âœ… å·²è¤‡è£½åˆ° ${targets.length} é–“å•†åº—`);
                closeCopyMenuModal();
            } catch(e) { showToast('âŒ è¤‡è£½å¤±æ•—ï¼š' + (e.message || e)); }
        }

        // ===== æ¥­å‹™ç›®æ¨™ç®¡ç† =====
        let stWeekStart = null;
        let stEmployees = [];

        function stGetMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            date.setDate(diff);
            date.setHours(0, 0, 0, 0);
            return date;
        }

        function stGetSunday(monday) {
            const sun = new Date(monday);
            sun.setDate(sun.getDate() + 6);
            return sun;
        }

        async function initSalesTargetPage() {
            stWeekStart = stGetMonday(new Date());
            await loadSalesTargetData();
        }

        function stChangeWeek(offset) {
            stWeekStart.setDate(stWeekStart.getDate() + offset * 7);
            loadSalesTargetData();
        }

        async function loadSalesTargetData() {
            const monday = fmtDate(stWeekStart);
            const sunday = fmtDate(stGetSunday(stWeekStart));

            document.getElementById('stWeekLabel').textContent =
                `${monday.substring(5).replace('-','/')} ~ ${sunday.substring(5).replace('-','/')}`;

            try {
                // è¼‰å…¥å…¨å“¡é è¨­ç›®æ¨™
                const { data: defaultTarget } = await sb.from('sales_targets')
                    .select('*')
                    .is('employee_id', null)
                    .eq('week_start', monday)
                    .maybeSingle();

                document.getElementById('stDefaultCall').value = defaultTarget?.call_target || 0;
                document.getElementById('stDefaultVisit').value = defaultTarget?.visit_target || 0;

                // åªè¼‰å…¥ã€Œæ¥­å‹™ã€è·ä½å“¡å·¥
                let empQuery = sb.from('employees').select('id, name, employee_number, role, position').eq('is_active', true).eq('position', 'æ¥­å‹™');
                if (currentCompanyId) empQuery = empQuery.eq('company_id', currentCompanyId);
                const { data: employees } = await empQuery.order('name');
                stEmployees = employees || [];

                // è¼‰å…¥å€‹äººç›®æ¨™
                const { data: targets } = await sb.from('sales_targets')
                    .select('*')
                    .eq('week_start', monday)
                    .not('employee_id', 'is', null);
                const targetMap = {};
                (targets || []).forEach(t => { targetMap[t.employee_id] = t; });

                // è¼‰å…¥æœ¬é€±æ‰€æœ‰æ´»å‹•
                const { data: activities } = await sb.from('sales_activities')
                    .select('employee_id, activity_type')
                    .gte('activity_date', monday)
                    .lte('activity_date', sunday);

                // çµ±è¨ˆæ¯äººé”æˆ
                const activityCount = {};
                (activities || []).forEach(a => {
                    if (!activityCount[a.employee_id]) activityCount[a.employee_id] = { call: 0, visit: 0 };
                    if (a.activity_type === 'call') activityCount[a.employee_id].call++;
                    if (a.activity_type === 'visit') activityCount[a.employee_id].visit++;
                });

                renderSalesTargetProgress(targetMap, activityCount, defaultTarget);
            } catch(e) {
                console.error('è¼‰å…¥æ¥­å‹™ç›®æ¨™å¤±æ•—', e);
                document.getElementById('stProgressList').innerHTML = '<p style="color:#ef4444;text-align:center;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        function renderSalesTargetProgress(targetMap, activityCount, defaultTarget) {
            const el = document.getElementById('stProgressList');
            if (stEmployees.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;">å°šç„¡å“¡å·¥è³‡æ–™</p>';
                return;
            }

            const defCall = defaultTarget?.call_target || 0;
            const defVisit = defaultTarget?.visit_target || 0;

            el.innerHTML = stEmployees.map(emp => {
                const t = targetMap[emp.id];
                const callTarget = t ? t.call_target : defCall;
                const visitTarget = t ? t.visit_target : defVisit;
                const done = activityCount[emp.id] || { call: 0, visit: 0 };
                const callPct = callTarget > 0 ? Math.min(100, Math.round(done.call / callTarget * 100)) : 0;
                const visitPct = visitTarget > 0 ? Math.min(100, Math.round(done.visit / visitTarget * 100)) : 0;

                return `<div style="background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:14px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="font-weight:700;font-size:14px;">${escapeHTML(emp.name)}</span>
                        <span style="font-size:11px;color:#94A3B8;">${escapeHTML(emp.employee_number || '')}</span>
                    </div>
                    <div style="display:flex;gap:12px;">
                        <div style="flex:1;">
                            <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:2px;">
                                <span>ğŸ“ é›»è©±</span>
                                <span style="font-weight:700;">${done.call}/${callTarget}</span>
                            </div>
                            <div style="width:100%;height:6px;background:#E2E8F0;border-radius:3px;overflow:hidden;">
                                <div style="height:100%;background:${callPct >= 100 ? '#059669' : '#4F46E5'};width:${callPct}%;border-radius:3px;"></div>
                            </div>
                        </div>
                        <div style="flex:1;">
                            <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:2px;">
                                <span>ğŸ¢ æ‹œè¨ª</span>
                                <span style="font-weight:700;">${done.visit}/${visitTarget}</span>
                            </div>
                            <div style="width:100%;height:6px;background:#E2E8F0;border-radius:3px;overflow:hidden;">
                                <div style="height:100%;background:${visitPct >= 100 ? '#059669' : '#10B981'};width:${visitPct}%;border-radius:3px;"></div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function saveDefaultTarget() {
            const callTarget = parseInt(document.getElementById('stDefaultCall').value) || 0;
            const visitTarget = parseInt(document.getElementById('stDefaultVisit').value) || 0;
            const weekStart = fmtDate(stWeekStart);

            try {
                const record = {
                    employee_id: null,
                    week_start: weekStart,
                    call_target: callTarget,
                    visit_target: visitTarget,
                    created_by: currentAdminEmployee?.id || null
                };
                if (currentCompanyId) record.company_id = currentCompanyId;

                // upsert: employee_id=NULL + week_start unique
                // å…ˆæŸ¥æœ‰æ²’æœ‰
                const { data: existing } = await sb.from('sales_targets')
                    .select('id')
                    .is('employee_id', null)
                    .eq('week_start', weekStart)
                    .maybeSingle();

                if (existing) {
                    await sb.from('sales_targets').update({
                        call_target: callTarget,
                        visit_target: visitTarget
                    }).eq('id', existing.id);
                } else {
                    await sb.from('sales_targets').insert(record);
                }

                showToast('âœ… é è¨­ç›®æ¨™å·²å„²å­˜');
                await loadSalesTargetData();
            } catch(e) {
                console.error(e);
                showToast('âŒ å„²å­˜å¤±æ•—ï¼š' + friendlyError(e));
            }
        }

        // é é¢è¼‰å…¥
        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') {
                console.error('common.js æœªæ­£ç¢ºè¼‰å…¥');
                return;
            }
            checkAdminPermission();
        });
    </script>
</body>
</html>
