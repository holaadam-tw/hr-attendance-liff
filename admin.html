<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‘‘ ç®¡ç†å¾Œå° - å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <!-- æ¬Šé™æª¢æŸ¥é é¢ -->
        <div id="permissionPage" class="page active">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">ğŸ”</span>
                    <h2>ç®¡ç†å“¡æ¬Šé™æª¢æŸ¥</h2>
                    <p>æ­£åœ¨é©—è­‰æ‚¨çš„ç®¡ç†å“¡èº«ä»½...</p>
                </div>
                <div id="permissionStatus" class="status-box show info">
                    æª¢æŸ¥æ¬Šé™ä¸­...
                </div>
            </div>
        </div>

        <!-- ç®¡ç†å¾Œå°é¦–é  -->
        <div id="adminHomePage" class="page">
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="adminAvatar">ğŸ‘‘</div>
                    <div class="user-details">
                        <h2 id="adminName">ç®¡ç†å“¡</h2>
                        <p id="adminDept">ç³»çµ±ç®¡ç†</p>
                        <p id="adminId" style="font-size: 11px; opacity: 0.7;">ID: -</p>
                    </div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="showPage('bonusPage')">
                    <div class="icon">ğŸ</div><div class="label">å¹´çµ‚çé‡‘è©¦ç®—</div>
                </div>
                <div class="menu-item" onclick="showPage('locationPage')">
                    <div class="icon">ğŸ“</div><div class="label">åœ°é»ç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="showPage('employeePage')">
                    <div class="icon">ğŸ‘¥</div><div class="label">å“¡å·¥ç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="showPage('leaveApprovalPage')">
                    <div class="icon">âœ…</div><div class="label">è«‹å‡å¯©æ ¸</div>
                </div>
                <div class="menu-item" onclick="showPage('reportPage')">
                    <div class="icon">ğŸ“Š</div><div class="label">å ±è¡¨åŒ¯å‡º</div>
                </div>
                <div class="menu-item" onclick="window.location.href='index.html'">
                    <div class="icon">ğŸ </div><div class="label">è¿”å›é¦–é </div>
                </div>
            </div>
        </div>

        <!-- å¹´çµ‚çé‡‘è©¦ç®—é é¢ -->
        <div id="bonusPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ å¹´çµ‚çé‡‘è©¦ç®—</h2>
                <div class="form-group">
                    <label>è©¦ç®—å¹´åº¦</label>
                    <select id="bonusYear" onchange="loadAllBonusStats()">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:15px;">ğŸ“ˆ è©¦ç®—æ‘˜è¦</h3>
                    <div class="stat-row"><span>ç¬¦åˆè³‡æ ¼äººæ•¸</span><span id="eligibleCount">0</span></div>
                    <div class="stat-row"><span>æœªç¬¦åˆè³‡æ ¼äººæ•¸</span><span id="ineligibleCount">0</span></div>
                    <div class="stat-row"><span>ç¸½é ç®—</span><span id="totalBudget">0</span></div>
                    <div class="stat-row"><span>å¹³å‡çé‡‘</span><span id="avgBonus">0</span></div>
                </div>

                <div id="bonusList" style="margin-top:20px;">
                    <p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- åœ°é»ç®¡ç†é é¢ -->
        <div id="locationPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“ åœ°é»ç®¡ç†</h2>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:10px;">ğŸ“ ç›®å‰æ‰“å¡åœ°é»</h3>
                    <div id="adminLocationList">
                        <p style="color:#666;text-align:center;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <div class="binding-card" style="margin-top: 20px;">
                    <h3 style="margin-bottom:15px;">â• æ–°å¢åœ°é»</h3>
                    <div class="form-group">
                        <label>åœ°é»åç¨±</label>
                        <input type="text" id="adminNewLocName" placeholder="ä¾‹å¦‚ï¼šå°åŒ—åˆ†åº—">
                    </div>
                    <div class="form-group">
                        <label>æ‰“å¡åŠå¾‘ (å…¬å°º)</label>
                        <input type="number" id="adminNewLocRadius" value="300">
                    </div>
                    <div class="form-group">
                        <label>åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="adminNewLocLat" placeholder="ç·¯åº¦" readonly>
                            <input type="text" id="adminNewLocLng" placeholder="ç¶“åº¦" readonly>
                        </div>
                        <button class="btn btn-primary" onclick="getCurrentGPSForAdmin()" style="margin-top:10px; font-size:14px; padding:10px;">
                            ğŸ“ æŠ“å–ç›®å‰ä½ç½®
                        </button>
                    </div>
                    <button class="btn btn-success" onclick="addNewLocationForAdmin()">ğŸ’¾ å„²å­˜æ–°åœ°é»</button>
                </div>
            </div>
        </div>

        <!-- å“¡å·¥ç®¡ç†é é¢ -->
        <div id="employeePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2>ğŸ‘¥ å“¡å·¥ç®¡ç†</h2>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-success" onclick="showAddEmployeeModal()" style="font-size:14px; padding:8px 16px;">
                            â• æ–°å¢å“¡å·¥
                        </button>
                        <button class="btn btn-primary" onclick="showJoinQRCode()" style="font-size:14px; padding:8px 16px;">
                            ğŸ“± é¡¯ç¤ºåŠ å…¥å…¬å¸ QR Code
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>æœå°‹å“¡å·¥</label>
                    <input type="text" id="employeeSearch" placeholder="è¼¸å…¥å§“åæˆ–å·¥è™Ÿ" onkeyup="searchEmployees()">
                </div>
                <div id="employeeList">
                    <p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- æ–°å¢å“¡å·¥ Modal -->
        <div id="addEmployeeModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>â• æ–°å¢å“¡å·¥</h3>
                    <button class="modal-close" onclick="closeAddEmployeeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addEmployeeForm">
                        <div class="form-group">
                            <label>å§“å *</label>
                            <input type="text" id="newEmployeeName" required placeholder="è«‹è¼¸å…¥å“¡å·¥å§“å">
                        </div>
                        <div class="form-group">
                            <label>å·¥è™Ÿ *</label>
                            <input type="text" id="newEmployeeNumber" required placeholder="ä¾‹å¦‚ï¼šE001">
                        </div>
                        <div class="form-group">
                            <label>éƒ¨é–€</label>
                            <select id="newEmployeeDepartment">
                                <option value="ç®¡ç†éƒ¨">ç®¡ç†éƒ¨</option>
                                <option value="æ¥­å‹™éƒ¨">æ¥­å‹™éƒ¨</option>
                                <option value="æŠ€è¡“éƒ¨">æŠ€è¡“éƒ¨</option>
                                <option value="äººäº‹éƒ¨">äººäº‹éƒ¨</option>
                                <option value="è²¡å‹™éƒ¨">è²¡å‹™éƒ¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è·ä½</label>
                            <input type="text" id="newEmployeePosition" placeholder="ä¾‹å¦‚ï¼šå°ˆå“¡">
                        </div>
                        <div class="form-group">
                            <label>é©—è­‰ç¢¼ *</label>
                            <input type="text" id="newEmployeeCode" required placeholder="èº«åˆ†è­‰å¾Œ4ç¢¼æˆ–è‡ªè¨‚é©—è­‰ç¢¼">
                            <small style="color:#666; font-size:12px; display:block; margin-top:5px;">
                                ğŸ’¡ å»ºè­°ä½¿ç”¨èº«åˆ†è­‰å¾Œ4ç¢¼ï¼Œå“¡å·¥ç¶å®šæ™‚éœ€è¦è¼¸å…¥æ­¤é©—è­‰ç¢¼
                            </small>
                        </div>
                        <div class="form-group">
                            <label>åˆ°è·æ—¥æœŸ</label>
                            <input type="date" id="newEmployeeHireDate">
                        </div>
                        <div class="form-group">
                            <label>è§’è‰²æ¬Šé™</label>
                            <select id="newEmployeeRole">
                                <option value="user">ä¸€èˆ¬å“¡å·¥</option>
                                <option value="manager">ä¸»ç®¡</option>
                                <option value="admin">ç®¡ç†å“¡</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button type="submit" class="btn btn-success" style="flex:1;">ğŸ’¾ å„²å­˜å“¡å·¥</button>
                            <button type="button" class="btn btn-secondary" onclick="closeAddEmployeeModal()" style="flex:1;">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div id="qrModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ğŸ“± å“¡å·¥åŠ å…¥å…¬å¸ QR Code</h3>
                    <button class="modal-close" onclick="closeQRModal()">&times;</button>
                </div>
                <div class="modal-body" style="text-align:center;">
                    <div id="qrcode" style="margin:20px auto; display:inline-block;"></div>
                    <div style="margin-top:20px; padding:15px; background:#f3f4f6; border-radius:8px;">
                        <p style="margin:0; font-size:14px; color:#666;">å…¬å¸ä»£ç¢¼</p>
                        <p style="margin:5px 0; font-size:18px; font-weight:bold; color:#1f2937;">HR_SYSTEM_001</p>
                        <p style="margin:5px 0; font-size:12px; color:#9ca3af;">ç„¡æ³•æƒç¢¼æ™‚è«‹æ‰‹å‹•è¼¸å…¥æ­¤ä»£ç¢¼</p>
                    </div>
                    <div style="margin-top:15px; padding:10px; background:#fef3c7; border-radius:8px; border-left:4px solid #f59e0b;">
                        <p style="margin:0; font-size:13px; color:#92400e;">
                            <strong>ä½¿ç”¨èªªæ˜ï¼š</strong><br>
                            1. å“¡å·¥æƒææ­¤ QR Code<br>
                            2. è¼¸å…¥å·¥è™Ÿå’Œé©—è­‰ç¢¼<br>
                            3. å®Œæˆç¶å®šå³å¯ä½¿ç”¨ç³»çµ±
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è«‹å‡å¯©æ ¸é é¢ -->
        <div id="leaveApprovalPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>âœ… è«‹å‡å¯©æ ¸</h2>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchLeaveTab('pending')">å¾…å¯©æ ¸</button>
                    <button class="tab-btn inactive" onclick="switchLeaveTab('approved')">å·²é€šé</button>
                    <button class="tab-btn inactive" onclick="switchLeaveTab('rejected')">å·²æ‹’çµ•</button>
                </div>
                <div id="leaveApprovalList">
                    <p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- å ±è¡¨åŒ¯å‡ºé é¢ -->
        <div id="reportPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“Š å ±è¡¨åŒ¯å‡º</h2>
                <div class="menu-grid">
                    <div class="menu-item" onclick="exportReport('attendance')">
                        <div class="icon">ğŸ“ˆ</div><div class="label">å‡ºå‹¤å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('leave')">
                        <div class="icon">ğŸ“</div><div class="label">è«‹å‡å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('bonus')">
                        <div class="icon">ğŸ</div><div class="label">çé‡‘å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('lunch')">
                        <div class="icon">ğŸ±</div><div class="label">ä¾¿ç•¶å ±è¡¨</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        let currentAdminEmployee = null;
        let allBonusStats = [];

        // é é¢åˆ‡æ›åŠŸèƒ½
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if(id==='bonusPage') loadAllBonusStats();
            if(id==='locationPage') renderAdminLocationList();
            if(id==='employeePage') loadEmployeeList();
            if(id==='leaveApprovalPage') loadLeaveApprovals('pending');
        }

        // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
        async function checkAdminPermission() {
            const statusEl = document.getElementById('permissionStatus');
            
            try {
                console.log('ğŸ” é–‹å§‹æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™...');
                
                const initialized = await initializeLiff();
                console.log('ğŸ“± LIFF åˆå§‹åŒ–çµæœ:', initialized);
                
                if (!initialized) {
                    showStatus(statusEl, 'error', 'âŒ LIFF åˆå§‹åŒ–å¤±æ•—');
                    return;
                }

                console.log('ğŸ‘¤ LIFF Profile:', liffProfile);
                console.log('ğŸ”‘ LINE User ID:', liffProfile?.userId);

                const { data, error } = await sb.from('employees')
                    .select('*')
                    .eq('line_user_id', liffProfile.userId)
                    .eq('role', 'admin')
                    .eq('is_active', true)
                    .single();

                console.log('ğŸ“Š è³‡æ–™åº«æŸ¥è©¢çµæœ:', { data, error });

                if (error || !data) {
                    console.error('âŒ æ¬Šé™æª¢æŸ¥å¤±æ•—:', error);
                    showStatus(statusEl, 'error', 'âŒ æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™<br>éŒ¯èª¤: ' + (error?.message || 'æ‰¾ä¸åˆ°å“¡å·¥è³‡æ–™'));
                    
                    // é¡¯ç¤ºè©³ç´°è³‡è¨Š
                    setTimeout(() => {
                        showStatus(statusEl, 'info', 'ğŸ” è©³ç´°è³‡è¨Š:<br>LINE ID: ' + (liffProfile?.userId || 'æœªçŸ¥') + '<br>è«‹ç¢ºèªè³‡æ–™åº«ä¸­çš„ role æ¬„ä½ç‚º admin');
                    }, 2000);
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 5000);
                    return;
                }

                console.log('âœ… æ¬Šé™é©—è­‰é€šé:', data);
                currentAdminEmployee = data;
                updateAdminInfo(data);
                showStatus(statusEl, 'success', 'âœ… æ¬Šé™é©—è­‰é€šé');
                
                setTimeout(() => {
                    showPage('adminHomePage');
                }, 1000);

            } catch (err) {
                console.error('ğŸ’¥ æ¬Šé™æª¢æŸ¥ç•°å¸¸:', err);
                showStatus(statusEl, 'error', 'âŒ æ¬Šé™æª¢æŸ¥å¤±æ•—: ' + err.message);
            }
        }

        // æ›´æ–°ç®¡ç†å“¡è³‡è¨Š
        function updateAdminInfo(data) {
            document.getElementById('adminName').textContent = data.name;
            document.getElementById('adminDept').textContent = `ç³»çµ±ç®¡ç†`;
            document.getElementById('adminId').textContent = `ID: ${data.employee_number}`;
            
            const avatar = document.getElementById('adminAvatar');
            if(liffProfile.pictureUrl) {
                avatar.style.backgroundImage = `url(${liffProfile.pictureUrl})`;
                avatar.style.backgroundSize = 'cover'; 
                avatar.textContent = 'ğŸ‘‘';
            } else {
                avatar.textContent = 'ğŸ‘‘';
            }
        }

        // è¼‰å…¥æ‰€æœ‰å“¡å·¥çé‡‘çµ±è¨ˆ
        async function loadAllBonusStats() {
            const yearEl = document.getElementById('bonusYear');
            const listEl = document.getElementById('bonusList');
            if (!yearEl || !listEl) return;

            const year = parseInt(yearEl.value);
            listEl.innerHTML = '<p style="text-align:center;">è¼‰å…¥ä¸­...</p>';

            try {
                const { data, error } = await sb.rpc('get_all_year_end_stats', { p_year: year });
                
                if (error) throw error;
                
                allBonusStats = data || [];
                
                // è¨ˆç®—çµ±è¨ˆæ‘˜è¦
                const eligible = allBonusStats.filter(emp => emp.bonus_status === 'ç¬¦åˆè³‡æ ¼');
                const ineligible = allBonusStats.filter(emp => emp.bonus_status !== 'ç¬¦åˆè³‡æ ¼');
                const totalBudget = eligible.reduce((sum, emp) => sum + (emp.suggested_bonus || 0), 0);
                
                document.getElementById('eligibleCount').textContent = eligible.length;
                document.getElementById('ineligibleCount').textContent = ineligible.length;
                document.getElementById('totalBudget').textContent = `$${totalBudget.toLocaleString()}`;
                document.getElementById('avgBonus').textContent = eligible.length > 0 ? 
                    `$${Math.round(totalBudget / eligible.length).toLocaleString()}` : '$0';

                // æ¸²æŸ“è©³ç´°åˆ—è¡¨
                let html = '';
                allBonusStats.forEach(emp => {
                    const isEligible = emp.bonus_status === 'ç¬¦åˆè³‡æ ¼';
                    html += `
                        <div class="attendance-item ${isEligible ? 'normal' : 'late'}">
                            <div class="date">
                                ${emp.name} (${emp.employee_number})
                                <span class="badge ${isEligible ? 'badge-success' : 'badge-warning'}">
                                    ${isEligible ? 'ç¬¦åˆ' : 'æœªç¬¦åˆ'}
                                </span>
                            </div>
                            <div class="details">
                                <span>${emp.department || '-'}</span>
                                <span>$${(emp.suggested_bonus || 0).toLocaleString()}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                ${emp.bonus_status} | å‡ºå‹¤${emp.attendance_rate}% | é²åˆ°${emp.late_count}æ¬¡
                            </div>
                            <button class="btn-danger" onclick="adjustBonus('${emp.employee_id}', '${emp.name}', ${emp.suggested_bonus || 0})" style="margin-top:5px;font-size:12px;">
                                èª¿æ•´çé‡‘
                            </button>
                        </div>
                    `;
                });
                
                listEl.innerHTML = html || '<p style="text-align:center;">ç„¡è³‡æ–™</p>';

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:red;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // èª¿æ•´çé‡‘
        function adjustBonus(employeeId, employeeName, currentBonus) {
            const newBonus = prompt(`èª¿æ•´ ${employeeName} çš„çé‡‘é‡‘é¡\nç›®å‰: $${currentBonus.toLocaleString()}\nè«‹è¼¸å…¥æ–°é‡‘é¡ (0 è¡¨ç¤ºå–æ¶ˆ):`);
            
            if (newBonus === null) return;
            
            const bonusAmount = parseInt(newBonus);
            if (isNaN(bonusAmount) || bonusAmount < 0) {
                showToast('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
                return;
            }
            
            // é€™è£¡éœ€è¦å¯¦ä½œæ›´æ–°çé‡‘çš„é‚è¼¯
            showToast(`âœ… ${employeeName} çš„çé‡‘å·²èª¿æ•´ç‚º $${bonusAmount.toLocaleString()}`);
            loadAllBonusStats(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
        }

        // ç®¡ç†å“¡åœ°é»ç®¡ç†åŠŸèƒ½
        function getCurrentGPSForAdmin() {
            getCurrentGPSForSetting(); // ä½¿ç”¨ common.js ä¸­çš„å‡½æ•¸
        }

        function addNewLocationForAdmin() {
            addNewLocation(); // ä½¿ç”¨ common.js ä¸­çš„å‡½æ•¸
        }

        function renderAdminLocationList() {
            renderLocationList(); // ä½¿ç”¨ common.js ä¸­çš„å‡½æ•¸
        }

        // é¡¯ç¤ºæ–°å¢å“¡å·¥ Modal
        function showAddEmployeeModal() {
            const modal = document.getElementById('addEmployeeModal');
            modal.style.display = 'flex';
            
            // è¨­å®šä»Šå¤©ç‚ºé è¨­åˆ°è·æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newEmployeeHireDate').value = today;
        }

        // é—œé–‰æ–°å¢å“¡å·¥ Modal
        function closeAddEmployeeModal() {
            const modal = document.getElementById('addEmployeeModal');
            modal.style.display = 'none';
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('addEmployeeForm').reset();
        }

        // æ–°å¢å“¡å·¥è¡¨å–®æäº¤
        document.getElementById('addEmployeeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const employeeData = {
                name: document.getElementById('newEmployeeName').value,
                employee_number: document.getElementById('newEmployeeNumber').value,
                department: document.getElementById('newEmployeeDepartment').value,
                position: document.getElementById('newEmployeePosition').value || 'å“¡å·¥',
                id_card_last_4: document.getElementById('newEmployeeCode').value,
                hire_date: document.getElementById('newEmployeeHireDate').value,
                role: document.getElementById('newEmployeeRole').value,
                is_active: true,
                company_id: '8a669e2c-7521-43e9-9300-5c004c57e9db', // ä½¿ç”¨ç¾æœ‰çš„ company_id
                created_at: new Date().toISOString()
            };
            
            try {
                const { data, error } = await sb.from('employees').insert([employeeData]);
                
                if (error) throw error;
                
                showToast('âœ… å“¡å·¥æ–°å¢æˆåŠŸï¼');
                closeAddEmployeeModal();
                loadEmployeeList(); // é‡æ–°è¼‰å…¥å“¡å·¥åˆ—è¡¨
                
            } catch (err) {
                console.error('æ–°å¢å“¡å·¥å¤±æ•—:', err);
                showToast('âŒ æ–°å¢å“¡å·¥å¤±æ•—: ' + err.message);
            }
        });

        // é¡¯ç¤ºåŠ å…¥å…¬å¸çš„ QR Code
        function showJoinQRCode() {
            const modal = document.getElementById('qrModal');
            const qrcodeDiv = document.getElementById('qrcode');
            
            // æ¸…ç©ºä¹‹å‰çš„ QR Code
            qrcodeDiv.innerHTML = '';
            
            // ç”Ÿæˆ QR Code
            const liffUrl = `https://liff.line.me/2008962829-bnsS1bbB?type=bind&company=HR_SYSTEM_001`;
            
            new QRCode(qrcodeDiv, {
                text: liffUrl,
                width: 200,
                height: 200,
                colorDark: "#1f2937",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // é¡¯ç¤º Modal
            modal.style.display = 'flex';
        }

        // é—œé–‰ QR Code Modal
        function closeQRModal() {
            const modal = document.getElementById('qrModal');
            modal.style.display = 'none';
        }

        // é»æ“Š Modal èƒŒæ™¯é—œé–‰
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('qrModal');
            if (event.target === modal) {
                closeQRModal();
            }
        });

        // è¼‰å…¥å“¡å·¥åˆ—è¡¨
        async function loadEmployeeList() {
            const listEl = document.getElementById('employeeList');
            if (!listEl) return;

            try {
                const { data, error } = await sb.from('employees')
                    .select('*')
                    .eq('is_active', true)
                    .order('department', { ascending: true });

                if (error) throw error;

                let html = '';
                data.forEach(emp => {
                    const roleColors = {
                        'admin': '#ef4444',
                        'manager': '#f59e0b', 
                        'user': '#10b981'
                    };
                    const roleNames = {
                        'admin': 'ç®¡ç†å“¡',
                        'manager': 'ä¸»ç®¡',
                        'user': 'ä¸€èˆ¬å“¡å·¥'
                    };
                    
                    html += `
                        <div class="attendance-item">
                            <div class="date">
                                ${emp.name} - ${emp.employee_number}
                                <span style="background:${roleColors[emp.role]};color:white;padding:2px 8px;border-radius:12px;font-size:11px;margin-left:8px;">
                                    ${roleNames[emp.role]}
                                </span>
                            </div>
                            <div class="details">
                                <span>${emp.department} - ${emp.position}</span>
                                <span>é©—è­‰ç¢¼: ${emp.id_card_last_4 || 'æœªè¨­å®š'}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                åˆ°è·: ${emp.hire_date || 'æœªè¨­å®š'} | ${emp.line_user_id ? 'âœ… å·²ç¶å®š' : 'âŒ æœªç¶å®š'}
                            </div>
                            ${emp.line_user_id ? `
                                <div style="margin-top:5px;display:flex;gap:5px;">
                                    <button class="btn-success" onclick="updateEmployeeRole('${emp.id}', 'admin')" style="flex:1;font-size:11px;padding:3px 8px;">
                                        è¨­ç‚ºç®¡ç†å“¡
                                    </button>
                                    <button class="btn-warning" onclick="updateEmployeeRole('${emp.id}', 'manager')" style="flex:1;font-size:11px;padding:3px 8px;">
                                        è¨­ç‚ºä¸»ç®¡
                                    </button>
                                    <button class="btn-secondary" onclick="updateEmployeeRole('${emp.id}', 'user')" style="flex:1;font-size:11px;padding:3px 8px;">
                                        è¨­ç‚ºå“¡å·¥
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                listEl.innerHTML = html || '<p style="text-align:center;">ç„¡å“¡å·¥è³‡æ–™</p>';

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:red;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // è®Šæ›´å“¡å·¥è§’è‰²
        async function changeEmployeeRole(employeeId, employeeName, currentRole) {
            const newRole = currentRole === 'admin' ? 'user' : 'admin';
            const action = currentRole === 'admin' ? 'å–æ¶ˆç®¡ç†å“¡æ¬Šé™' : 'è¨­ç‚ºç®¡ç†å“¡';
            
            if (!confirm(`ç¢ºå®šè¦ ${action} çµ¦ ${employeeName} å—ï¼Ÿ`)) return;

            try {
                const { error } = await sb.from('employees')
                    .update({ role: newRole })
                    .eq('id', employeeId);

                if (error) throw error;

                showToast(`âœ… ${employeeName} çš„è§’è‰²å·²æ›´æ–°`);
                loadEmployeeList();

            } catch (err) {
                console.error(err);
                showToast('âŒ æ›´æ–°å¤±æ•—: ' + err.message);
            }
        }

        // æ›´æ–°å“¡å·¥è§’è‰²
        async function updateEmployeeRole(employeeId, newRole) {
            try {
                const { data, error } = await sb.from('employees')
                    .update({ role: newRole })
                    .eq('id', employeeId);
                
                if (error) throw error;
                
                const roleNames = {
                    'admin': 'ç®¡ç†å“¡',
                    'manager': 'ä¸»ç®¡',
                    'user': 'ä¸€èˆ¬å“¡å·¥'
                };
                
                showToast(`âœ… å·²å°‡å“¡å·¥è¨­ç‚º${roleNames[newRole]}`);
                loadEmployeeList(); // é‡æ–°è¼‰å…¥å“¡å·¥åˆ—è¡¨
                
            } catch (err) {
                console.error('æ›´æ–°å“¡å·¥è§’è‰²å¤±æ•—:', err);
                showToast('âŒ æ›´æ–°è§’è‰²å¤±æ•—: ' + err.message);
            }
        }

        // æœå°‹å“¡å·¥
        function searchEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            const items = document.querySelectorAll('#employeeList .attendance-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // è«‹å‡å¯©æ ¸åŠŸèƒ½
        function switchLeaveTab(status) {
            // æ›´æ–° tab æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('#leaveApprovalPage .tab-btn').forEach(btn => {
                btn.className = 'tab-btn inactive';
            });
            event.target.className = 'tab-btn active';
            
            loadLeaveApprovals(status);
        }

        async function loadLeaveApprovals(status) {
            const listEl = document.getElementById('leaveApprovalList');
            if (!listEl) return;

            try {
                const { data, error } = await sb.from('leave_requests')
                    .select(`
                        *,
                        employees!inner(name, employee_number, department)
                    `)
                    .eq('status', status)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                let html = '';
                data.forEach(request => {
                    const typeMap = { 'annual': 'ç‰¹ä¼‘', 'sick': 'ç—…å‡', 'personal': 'äº‹å‡', 'compensatory': 'è£œä¼‘' };
                    
                    html += `
                        <div class="attendance-item">
                            <div class="date">
                                ${request.employees.name} - ${typeMap[request.leave_type]}
                            </div>
                            <div class="details">
                                <span>${request.start_date} ~ ${request.end_date}</span>
                                <span>${request.created_at.split('T')[0]}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                ${request.reason}
                            </div>
                            ${status === 'pending' ? `
                                <div style="margin-top:5px;display:flex;gap:5px;">
                                    <button class="btn-success" onclick="approveLeave('${request.id}', 'approved')" style="flex:1;font-size:12px;padding:5px;">
                                        âœ… é€šé
                                    </button>
                                    <button class="btn-danger" onclick="approveLeave('${request.id}', 'rejected')" style="flex:1;font-size:12px;padding:5px;">
                                        âŒ æ‹’çµ•
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                // ç¢ºå®šç‹€æ…‹æ–‡å­—
                let statusText = 'å¾…å¯©æ ¸';
                if (status === 'approved') statusText = 'å·²é€šé';
                if (status === 'rejected') statusText = 'å·²æ‹’çµ•';
                
                listEl.innerHTML = html || `<p style="text-align:center;">ç„¡${statusText}çš„è«‹å‡ç”³è«‹</p>`;

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:red;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // å¯©æ ¸è«‹å‡
        async function approveLeave(requestId, newStatus) {
            try {
                const { error } = await sb.from('leave_requests')
                    .update({ 
                        status: newStatus,
                        approver_id: currentAdminEmployee.id,
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', requestId);

                if (error) throw error;

                showToast(`âœ… è«‹å‡ç”³è«‹å·²${newStatus === 'approved' ? 'é€šé' : 'æ‹’çµ•'}`);
                loadLeaveApprovals('pending');

            } catch (err) {
                console.error(err);
                showToast('âŒ å¯©æ ¸å¤±æ•—: ' + err.message);
            }
        }

        // åŒ¯å‡ºå ±è¡¨
        function exportReport(type) {
            showToast(`ğŸ“Š æ­£åœ¨æº–å‚™${type === 'attendance' ? 'å‡ºå‹¤' : type === 'leave' ? 'è«‹å‡' : type === 'bonus' ? 'çé‡‘' : 'ä¾¿ç•¶'}å ±è¡¨...`);
            // é€™è£¡å¯ä»¥å¯¦ä½œå¯¦éš›çš„å ±è¡¨åŒ¯å‡ºåŠŸèƒ½
            setTimeout(() => {
                showToast('âœ… å ±è¡¨åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…');
            }, 1000);
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œæª¢æŸ¥æ¬Šé™
        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') {
                console.error('initializeLiff å‡½æ•¸æœªå®šç¾©ï¼Œè«‹æª¢æŸ¥ common.js æ˜¯å¦æ­£ç¢ºè¼‰å…¥');
                return;
            }
            
            checkAdminPermission();
        });
    </script>
</body>
</html>
