<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‘‘ ç®¡ç†å¾Œå° - å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        #lcTable th, #lcTable td, #smTable th, #smTable td { border: 1px solid #F1F5F9; }
        #smTable td:hover { filter: brightness(0.92); }
        #lcTable th, #smTable th { position: sticky; top: 0; background: #fff; z-index: 1; }
    </style>
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <!-- æ¬Šé™æª¢æŸ¥é é¢ -->
        <div id="permissionPage" class="page active">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">ğŸ”</span>
                    <h2>ç®¡ç†å“¡æ¬Šé™æª¢æŸ¥</h2>
                    <p>æ­£åœ¨é©—è­‰æ‚¨çš„ç®¡ç†å“¡èº«ä»½...</p>
                </div>
                <div id="permissionStatus" class="status-box show info">
                    æª¢æŸ¥æ¬Šé™ä¸­...
                </div>
            </div>
        </div>

        <!-- ç®¡ç†å¾Œå°é¦–é  -->
        <div id="adminHomePage" class="page">
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="adminAvatar">ğŸ‘‘</div>
                    <div class="user-details">
                        <h2 id="adminName">ç®¡ç†å“¡</h2>
                        <p id="adminDept">ç³»çµ±ç®¡ç†</p>
                        <p id="adminId" style="font-size: 11px; opacity: 0.7;">ID: -</p>
                    </div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="showPage('bonusPage')">
                    <div class="icon">ğŸ</div><div class="label">å¹´çµ‚çé‡‘è©¦ç®—</div>
                </div>
                <div class="menu-item" onclick="showPage('locationPage')">
                    <div class="icon">ğŸ“</div><div class="label">åœ°é»ç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="showPage('employeePage')">
                    <div class="icon">ğŸ‘¥</div><div class="label">å“¡å·¥ç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="showPage('leaveApprovalPage')">
                    <div class="icon">âœ…</div><div class="label">è«‹å‡å¯©æ ¸</div>
                </div>
                <div class="menu-item" onclick="showPage('makeupApprovalPage')">
                    <div class="icon">ğŸ”§</div><div class="label">è£œæ‰“å¡å¯©æ ¸</div>
                </div>
                <div class="menu-item" onclick="showPage('announcementPage')">
                    <div class="icon">ğŸ“¢</div><div class="label">å…¬å‘Šç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="showPage('reportPage')">
                    <div class="icon">ğŸ“Š</div><div class="label">å ±è¡¨åŒ¯å‡º</div>
                </div>
                <div class="menu-item" onclick="showPage('staffMgrPage')">
                    <div class="icon">ğŸ“‹</div><div class="label">äººåŠ›ç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="showPage('featurePage')">
                    <div class="icon">ğŸ›ï¸</div><div class="label">åŠŸèƒ½ç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="window.location.href='index.html'">
                    <div class="icon">ğŸ </div><div class="label">è¿”å›é¦–é </div>
                </div>
            </div>
        </div>

        <!-- å¹´çµ‚çé‡‘è©¦ç®—é é¢ -->
        <div id="bonusPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ å¹´çµ‚çé‡‘è©¦ç®—</h2>
                <div class="form-group">
                    <label>è©¦ç®—å¹´åº¦</label>
                    <select id="bonusYear" onchange="loadAllBonusStats()">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:15px;">ğŸ“ˆ è©¦ç®—æ‘˜è¦</h3>
                    <div class="stat-row"><span>ç¬¦åˆè³‡æ ¼äººæ•¸</span><span id="eligibleCount">0</span></div>
                    <div class="stat-row"><span>æœªç¬¦åˆè³‡æ ¼äººæ•¸</span><span id="ineligibleCount">0</span></div>
                    <div class="stat-row"><span>ç¸½é ç®—</span><span id="totalBudget">$0</span></div>
                    <div class="stat-row"><span>å¹³å‡çé‡‘</span><span id="avgBonus">$0</span></div>
                </div>

                <div id="bonusList" style="margin-top:20px;">
                    <p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- åœ°é»ç®¡ç†é é¢ -->
        <div id="locationPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“ åœ°é»ç®¡ç†</h2>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:10px;">ğŸ“ ç›®å‰æ‰“å¡åœ°é»</h3>
                    <!-- [BUG FIX] ä½¿ç”¨èˆ‡ common.js ä¸€è‡´çš„ ID -->
                    <div id="locationList">
                        <p style="color:#666;text-align:center;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <div style="margin-top: 20px; background:#fff; border-radius:16px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                    <h3 style="margin-bottom:15px;">â• æ–°å¢åœ°é»</h3>
                    <div class="form-group">
                        <label>åœ°é»åç¨±</label>
                        <!-- [BUG FIX] ä½¿ç”¨èˆ‡ common.js ä¸€è‡´çš„ ID -->
                        <input type="text" id="newLocName" placeholder="ä¾‹å¦‚ï¼šå°åŒ—åˆ†åº—">
                    </div>
                    <div class="form-group">
                        <label>æ‰“å¡åŠå¾‘ (å…¬å°º)</label>
                        <input type="number" id="newLocRadius" value="300">
                    </div>
                    <div class="form-group">
                        <label>åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="newLocLat" placeholder="ç·¯åº¦" readonly>
                            <input type="text" id="newLocLng" placeholder="ç¶“åº¦" readonly>
                        </div>
                        <button class="btn btn-primary" onclick="getCurrentGPSForSetting()" style="margin-top:10px; font-size:14px; padding:10px;">
                            ğŸ“ æŠ“å–ç›®å‰ä½ç½®
                        </button>
                    </div>
                    <button class="btn btn-success" onclick="addNewLocation()">ğŸ’¾ å„²å­˜æ–°åœ°é»</button>
                </div>
            </div>
        </div>

        <!-- å“¡å·¥ç®¡ç†é é¢ -->
        <div id="employeePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h2 style="margin:0;">ğŸ‘¥ å“¡å·¥ç®¡ç†</h2>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-success" onclick="showAddEmployeeModal()" style="font-size:13px; padding:8px 14px; width:auto; margin:0;">
                            â• æ–°å¢
                        </button>
                        <button class="btn btn-primary" onclick="showJoinQRCode()" style="font-size:13px; padding:8px 14px; width:auto; margin:0;">
                            ğŸ“± QR Code
                        </button>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom:15px;">
                    <input type="text" id="employeeSearch" placeholder="ğŸ” æœå°‹å§“åæˆ–å·¥è™Ÿ" onkeyup="searchEmployees()">
                </div>
                <div id="employeeList">
                    <p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- æ–°å¢å“¡å·¥ Modal -->
        <div id="addEmployeeModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>â• æ–°å¢å“¡å·¥</h3>
                    <button class="modal-close" onclick="closeAddEmployeeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addEmployeeForm">
                        <div class="form-group">
                            <label>å§“å *</label>
                            <input type="text" id="newEmployeeName" required placeholder="è«‹è¼¸å…¥å“¡å·¥å§“å">
                        </div>
                        <div class="form-group">
                            <label>å·¥è™Ÿ *</label>
                            <input type="text" id="newEmployeeNumber" required placeholder="ä¾‹å¦‚ï¼šE001">
                        </div>
                        <div class="form-group">
                            <label>éƒ¨é–€</label>
                            <select id="newEmployeeDepartment">
                                <option value="ç®¡ç†éƒ¨">ç®¡ç†éƒ¨</option>
                                <option value="æ¥­å‹™éƒ¨">æ¥­å‹™éƒ¨</option>
                                <option value="æŠ€è¡“éƒ¨">æŠ€è¡“éƒ¨</option>
                                <option value="äººäº‹éƒ¨">äººäº‹éƒ¨</option>
                                <option value="è²¡å‹™éƒ¨">è²¡å‹™éƒ¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è·ä½</label>
                            <input type="text" id="newEmployeePosition" placeholder="ä¾‹å¦‚ï¼šå°ˆå“¡">
                        </div>
                        <div class="form-group">
                            <label>é©—è­‰ç¢¼ *</label>
                            <input type="text" id="newEmployeeCode" required placeholder="èº«åˆ†è­‰å¾Œ4ç¢¼æˆ–è‡ªè¨‚é©—è­‰ç¢¼">
                            <small style="color:#666; font-size:12px; display:block; margin-top:5px;">
                                ğŸ’¡ å»ºè­°ä½¿ç”¨èº«åˆ†è­‰å¾Œ4ç¢¼ï¼Œå“¡å·¥ç¶å®šæ™‚éœ€è¦è¼¸å…¥æ­¤é©—è­‰ç¢¼
                            </small>
                        </div>
                        <div class="form-group">
                            <label>åˆ°è·æ—¥æœŸ</label>
                            <input type="date" id="newEmployeeHireDate">
                        </div>
                        <div class="form-group">
                            <label>è§’è‰²æ¬Šé™</label>
                            <select id="newEmployeeRole">
                                <option value="user">ä¸€èˆ¬å“¡å·¥</option>
                                <option value="manager">ä¸»ç®¡</option>
                                <option value="admin">ç®¡ç†å“¡</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button type="submit" class="btn btn-success" style="flex:1;">ğŸ’¾ å„²å­˜å“¡å·¥</button>
                            <button type="button" class="btn btn-secondary" onclick="closeAddEmployeeModal()" style="flex:1;">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div id="qrModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ğŸ“± å“¡å·¥åŠ å…¥ QR Code</h3>
                    <button class="modal-close" onclick="closeQRModal()">&times;</button>
                </div>
                <div class="modal-body" style="text-align:center;">
                    <div id="qrcode" style="margin:20px auto; display:inline-block;"></div>
                    <div style="margin-top:20px; padding:15px; background:#f3f4f6; border-radius:12px;">
                        <p style="margin:0; font-size:14px; color:#666;">å…¬å¸ä»£ç¢¼</p>
                        <p style="margin:5px 0; font-size:18px; font-weight:bold; color:#1f2937;">HR_SYSTEM_001</p>
                        <p style="margin:5px 0; font-size:12px; color:#9ca3af;">ç„¡æ³•æƒç¢¼æ™‚è«‹æ‰‹å‹•è¼¸å…¥æ­¤ä»£ç¢¼</p>
                    </div>
                    <div style="margin-top:15px; padding:12px; background:#fef3c7; border-radius:8px; border-left:4px solid #f59e0b; text-align:left;">
                        <p style="margin:0; font-size:13px; color:#92400e;">
                            <strong>ä½¿ç”¨èªªæ˜ï¼š</strong><br>
                            1. å“¡å·¥æƒææ­¤ QR Code<br>
                            2. è¼¸å…¥å·¥è™Ÿå’Œé©—è­‰ç¢¼<br>
                            3. å®Œæˆç¶å®šå³å¯ä½¿ç”¨ç³»çµ±
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è«‹å‡å¯©æ ¸é é¢ -->
        <div id="leaveApprovalPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>âœ… è«‹å‡å¯©æ ¸</h2>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchLeaveTab('pending')">å¾…å¯©æ ¸</button>
                    <button class="tab-btn inactive" onclick="switchLeaveTab('approved')">å·²é€šé</button>
                    <button class="tab-btn inactive" onclick="switchLeaveTab('rejected')">å·²æ‹’çµ•</button>
                </div>
                <div id="leaveApprovalList">
                    <p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- ====== è£œæ‰“å¡å¯©æ ¸ ====== -->
        <div id="makeupApprovalPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ”§ è£œæ‰“å¡å¯©æ ¸</h2>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchMakeupTab('pending')">å¾…å¯©æ ¸</button>
                    <button class="tab-btn inactive" onclick="switchMakeupTab('approved')">å·²é€šé</button>
                    <button class="tab-btn inactive" onclick="switchMakeupTab('rejected')">å·²æ‹’çµ•</button>
                </div>
                <div id="makeupApprovalList"><p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p></div>
            </div>
        </div>

        <!-- ====== å…¬å‘Šç®¡ç† ====== -->
        <div id="announcementPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“¢ å…¬å‘Šç®¡ç†</h2>
                <p style="color:#94A3B8;font-size:12px;margin-bottom:16px;">ç™¼å¸ƒçš„å…¬å‘Šæœƒé¡¯ç¤ºåœ¨å“¡å·¥é¦–é ä¸Šæ–¹</p>

                <!-- æ–°å¢å…¬å‘Šè¡¨å–® -->
                <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:16px;">
                    <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">â• ç™¼å¸ƒæ–°å…¬å‘Š</div>
                    <div class="form-group">
                        <label>é¡å‹</label>
                        <select id="annType">
                            <option value="info">ğŸ“¢ ä¸€èˆ¬é€šçŸ¥</option>
                            <option value="warning">âš ï¸ æ³¨æ„äº‹é …</option>
                            <option value="urgent">ğŸš¨ ç·Šæ€¥é€šçŸ¥</option>
                            <option value="event">ğŸ‰ æ´»å‹•å…¬å‘Š</option>
                        </select>
                    </div>
                    <div class="form-group"><label>æ¨™é¡Œ</label><input type="text" id="annTitle" placeholder="ä¾‹ï¼šä¸‹é€±ä¸€åœé›»é€šçŸ¥"></div>
                    <div class="form-group"><label>å…§å®¹ (é¸å¡«)</label><textarea id="annContent" placeholder="å…¬å‘Šè©³ç´°å…§å®¹..."></textarea></div>
                    <div class="form-group">
                        <label>åˆ°æœŸæ—¥ (é¸å¡«ï¼Œç•™ç©ºæ°¸ä¹…é¡¯ç¤º)</label>
                        <input type="date" id="annExpire">
                    </div>
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="annPinned"> ğŸ“Œ ç½®é ‚</label>
                    </div>
                    <button class="btn btn-primary" onclick="publishAnnouncement()">ğŸ“¤ ç™¼å¸ƒå…¬å‘Š</button>
                </div>

                <!-- ç¾æœ‰å…¬å‘Šåˆ—è¡¨ -->
                <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">ğŸ“‹ ç¾æœ‰å…¬å‘Š</div>
                <div id="announcementList"><p style="text-align:center;color:#999;">è¼‰å…¥ä¸­...</p></div>
            </div>
        </div>

        <!-- å ±è¡¨åŒ¯å‡ºé é¢ -->
        <div id="reportPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“Š å ±è¡¨åŒ¯å‡º</h2>
                <div class="menu-grid">
                    <div class="menu-item" onclick="exportReport('attendance')">
                        <div class="icon">ğŸ“ˆ</div><div class="label">å‡ºå‹¤å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('leave')">
                        <div class="icon">ğŸ“</div><div class="label">è«‹å‡å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('bonus')">
                        <div class="icon">ğŸ</div><div class="label">çé‡‘å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('lunch')">
                        <div class="icon">ğŸ±</div><div class="label">ä¾¿ç•¶å ±è¡¨</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½ç®¡ç†é é¢ -->
        <div id="featurePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ›ï¸ åŠŸèƒ½ç®¡ç†</h2>
                <p style="color:#6b7280;font-size:13px;margin-bottom:16px;">æ§åˆ¶å“¡å·¥é¦–é <b>ä¸­é–“é¸å–®</b>é¡¯ç¤ºå“ªäº›åŠŸèƒ½</p>
                
                <div id="featureToggles" style="display:flex;flex-direction:column;gap:12px;">
                    <!-- è«‹å‡ -->
                    <div class="feature-toggle-card" id="ftCard_leave" onclick="toggleFeature('leave')" style="display:flex;align-items:center;gap:14px;padding:16px;background:#fff;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                        <span style="font-size:28px;">ğŸ“</span>
                        <div style="flex:1;">
                            <div style="font-weight:800;font-size:14px;color:#0F172A;">æˆ‘è¦è«‹å‡</div>
                            <div style="font-size:12px;color:#94A3B8;margin-top:2px;">è«‹å‡ç”³è«‹èˆ‡è¨˜éŒ„æŸ¥è©¢</div>
                        </div>
                        <div class="ft-indicator" style="width:44px;height:26px;border-radius:13px;background:#4F46E5;position:relative;transition:background 0.3s;">
                            <div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;right:3px;transition:all 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                    <!-- ä¾¿ç•¶ -->
                    <div class="feature-toggle-card" id="ftCard_lunch" onclick="toggleFeature('lunch')" style="display:flex;align-items:center;gap:14px;padding:16px;background:#fff;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                        <span style="font-size:28px;">ğŸ±</span>
                        <div style="flex:1;">
                            <div style="font-weight:800;font-size:14px;color:#0F172A;">ä¾¿ç•¶è¨‚è³¼</div>
                            <div style="font-size:12px;color:#94A3B8;margin-top:2px;">æ¯æ—¥åˆé¤è¨‚è³¼ç®¡ç†</div>
                        </div>
                        <div class="ft-indicator" style="width:44px;height:26px;border-radius:13px;background:#4F46E5;position:relative;transition:background 0.3s;">
                            <div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;right:3px;transition:all 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                    <!-- è€ƒå‹¤ -->
                    <div class="feature-toggle-card" id="ftCard_attendance" onclick="toggleFeature('attendance')" style="display:flex;align-items:center;gap:14px;padding:16px;background:#fff;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                        <span style="font-size:28px;">ğŸ“Š</span>
                        <div style="flex:1;">
                            <div style="font-weight:800;font-size:14px;color:#0F172A;">è€ƒå‹¤æŸ¥è©¢</div>
                            <div style="font-size:12px;color:#94A3B8;margin-top:2px;">å‡ºå‹¤æœˆæ›†èˆ‡è¨˜éŒ„æŸ¥è©¢</div>
                        </div>
                        <div class="ft-indicator" style="width:44px;height:26px;border-radius:13px;background:#4F46E5;position:relative;transition:background 0.3s;">
                            <div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;right:3px;transition:all 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                </div>
                <div id="featureSaveStatus" style="margin-top:12px;text-align:center;font-size:13px;color:#059669;display:none;">âœ… å·²å„²å­˜</div>
                <p style="color:#94A3B8;font-size:12px;margin-top:16px;text-align:center;">ğŸ’¡ åº•éƒ¨å°èˆªåˆ—ï¼ˆé¦–é /ç­è¡¨/æ‰“å¡/è–ªè³‡/ç®¡ç†ï¼‰ç‚ºç®¡ç†å“¡å°ˆå±¬ï¼Œä¸å—æ­¤è¨­å®šå½±éŸ¿</p>

                <!-- LINE Notify è¨­å®š -->
                <div style="margin-top:30px;padding-top:20px;border-top:2px dashed #e5e7eb;">
                    <h3 style="margin-bottom:12px;">ğŸ”” LINE Notify æ¨æ’­è¨­å®š</h3>
                    <p style="color:#94A3B8;font-size:12px;margin-bottom:12px;">è¨­å®šå¾Œï¼Œè«‹å‡/è£œæ‰“å¡ç”³è«‹æœƒè‡ªå‹•æ¨æ’­é€šçŸ¥ç®¡ç†å“¡ç¾¤çµ„</p>
                    <div class="form-group">
                        <label>LINE Notify Token</label>
                        <input type="text" id="lineNotifyToken" placeholder="è«‹è²¼ä¸Š LINE Notify Token">
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-primary" onclick="saveNotifyToken()" style="flex:1;">ğŸ’¾ å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="testNotify()" style="flex:1;">ğŸ”” æ¸¬è©¦æ¨æ’­</button>
                    </div>
                    <div id="notifyStatus" style="margin-top:8px;text-align:center;font-size:13px;display:none;"></div>
                    <div style="margin-top:12px;padding:10px;background:#FFF7ED;border-radius:10px;font-size:11px;color:#EA580C;line-height:1.6;">
                        ğŸ“Œ å¦‚ä½•å–å¾— Tokenï¼š<br>
                        1. å‰å¾€ <b>notify-bot.line.me</b><br>
                        2. ç™»å…¥ â†’ ç™¼è¡Œæ¬Šæ–<br>
                        3. é¸æ“‡è¦æ¥æ”¶é€šçŸ¥çš„ç¾¤çµ„<br>
                        4. è¤‡è£½ Token è²¼åˆ°ä¸Šæ–¹
                    </div>
                </div>
            </div>
        </div>

        <!-- ====== äººåŠ›ç®¡ç†ï¼ˆæ’ç­ + ä¼‘å‡ + è¨­å®šï¼‰ ====== -->
        <div id="staffMgrPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“‹ äººåŠ›ç®¡ç†</h2>

                <!-- ä¸‰é ç±¤ -->
                <div style="display:flex;gap:4px;margin-bottom:16px;background:#F1F5F9;border-radius:10px;padding:3px;">
                    <button class="smTab" onclick="switchStaffTab('shift')" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:#fff;color:#4F46E5;box-shadow:0 1px 4px rgba(0,0,0,0.08);">ğŸ“‹ æ’ç­è¡¨</button>
                    <button class="smTab" onclick="switchStaffTab('leave')" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:transparent;color:#94A3B8;">ğŸ—“ï¸ ä¼‘å‡æœˆè¡¨</button>
                    <button class="smTab" onclick="switchStaffTab('setting')" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;background:transparent;color:#94A3B8;">âš™ï¸ äººåŠ›è¨­å®š</button>
                </div>

                <!-- === æ’ç­è¡¨ TAB === -->
                <div id="tabShift" class="staffTabContent">
                    <p style="color:#6b7280;font-size:12px;margin-bottom:12px;">é»æ“Šæ ¼å­åˆ‡æ›ç­åˆ¥ï¼Œæ’å¥½å¾ŒæŒ‰å„²å­˜</p>
                    <div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:12px;">
                        <button onclick="changeShiftWeek(-1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">â—€</button>
                        <span id="smWeekLabel" style="font-size:14px;font-weight:700;min-width:180px;text-align:center;">-</span>
                        <button onclick="changeShiftWeek(1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">â–¶</button>
                    </div>
                    <div style="display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap;justify-content:center;">
                        <span style="font-size:10px;padding:3px 8px;background:#DBEAFE;color:#1E40AF;border-radius:6px;font-weight:700;">â˜€ï¸æ—©</span>
                        <span style="font-size:10px;padding:3px 8px;background:#FEF3C7;color:#92400E;border-radius:6px;font-weight:700;">ğŸŒ¤ï¸ä¸­</span>
                        <span style="font-size:10px;padding:3px 8px;background:#EDE9FE;color:#6D28D9;border-radius:6px;font-weight:700;">ğŸŒ™æ™š</span>
                        <span style="font-size:10px;padding:3px 8px;background:#ECFDF5;color:#059669;border-radius:6px;font-weight:700;">ğŸ–ï¸ä¼‘</span>
                        <span style="font-size:10px;padding:3px 8px;background:#F1F5F9;color:#64748B;border-radius:6px;font-weight:700;">â¬œæœªæ’</span>
                    </div>
                    <!-- äººåŠ›ä¸è¶³è­¦å‘Š -->
                    <div id="shiftStaffWarn" style="display:none;padding:10px 14px;background:#FEF2F2;border-radius:10px;margin-bottom:12px;font-size:12px;color:#DC2626;font-weight:700;"></div>
                    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
                        <table id="smTable" style="width:100%;border-collapse:collapse;font-size:12px;min-width:500px;"><thead id="smHead"></thead><tbody id="smBody"></tbody></table>
                    </div>
                    <!-- æ¯æ—¥äººåŠ›çµ±è¨ˆ -->
                    <div id="shiftDaySummary" style="display:flex;gap:4px;margin-top:10px;overflow-x:auto;padding-bottom:4px;"></div>
                    <div style="margin-top:14px;display:flex;gap:8px;">
                        <button onclick="saveSchedule()" style="flex:1;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ’¾ å„²å­˜æ’ç­</button>
                        <button onclick="copyLastWeek()" style="padding:14px 20px;border:2px solid #E5E7EB;border-radius:12px;background:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ“‹ è¤‡è£½ä¸Šé€±</button>
                    </div>
                    <div id="smSaveStatus" style="margin-top:10px;text-align:center;font-size:13px;display:none;"></div>
                </div>

                <!-- === ä¼‘å‡æœˆè¡¨ TAB === -->
                <div id="tabLeave" class="staffTabContent" style="display:none;">
                    <p style="color:#6b7280;font-size:12px;margin-bottom:12px;">ä¸€è¦½å…¨å“¡ä¼‘å‡ç‹€æ…‹ï¼Œæ–¹ä¾¿å®‰æ’å·¥ä½œ</p>
                    <div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:12px;">
                        <button onclick="changeLeaveCal(-1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">â—€</button>
                        <span id="lcMonthLabel" style="font-size:14px;font-weight:700;min-width:120px;text-align:center;">-</span>
                        <button onclick="changeLeaveCal(1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">â–¶</button>
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:12px;">
                        <div style="flex:1;text-align:center;padding:10px;background:#EFF6FF;border-radius:12px;">
                            <div style="font-size:20px;font-weight:900;color:#2563EB;" id="lcTotal">0</div>
                            <div style="font-size:10px;font-weight:600;color:#2563EB;">ç¸½è«‹å‡äººæ¬¡</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:10px;background:#ECFDF5;border-radius:12px;">
                            <div style="font-size:20px;font-weight:900;color:#059669;" id="lcAvail">0</div>
                            <div style="font-size:10px;font-weight:600;color:#059669;">ä»Šæ—¥å¯ç”¨äººåŠ›</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:10px;background:#FEF2F2;border-radius:12px;">
                            <div style="font-size:20px;font-weight:900;color:#DC2626;" id="lcMax">0</div>
                            <div style="font-size:10px;font-weight:600;color:#DC2626;">ä¸Šé™</div>
                        </div>
                    </div>
                    <!-- æ—¥æœŸæœ‰è¶…éä¸Šé™çš„é«˜äº® -->
                    <div id="lcOverWarn" style="display:none;padding:10px 14px;background:#FEF2F2;border-radius:10px;margin-bottom:12px;font-size:12px;color:#DC2626;font-weight:700;"></div>
                    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
                        <table id="lcTable" style="width:100%;border-collapse:collapse;font-size:11px;min-width:600px;"><thead id="lcHead"></thead><tbody id="lcBody"></tbody></table>
                    </div>
                    <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap;">
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#DBEAFE;border-radius:3px;display:inline-block;"></span>ç‰¹ä¼‘</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FEE2E2;border-radius:3px;display:inline-block;"></span>ç—…å‡</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FEF3C7;border-radius:3px;display:inline-block;"></span>äº‹å‡</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#E0E7FF;border-radius:3px;display:inline-block;"></span>è£œä¼‘</span>
                        <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FCA5A5;border-radius:3px;display:inline-block;border:2px solid #DC2626;"></span>è¶…é™</span>
                    </div>
                </div>

                <!-- === äººåŠ›è¨­å®š TAB === -->
                <div id="tabSetting" class="staffTabContent" style="display:none;">
                    <p style="color:#6b7280;font-size:12px;margin-bottom:16px;">è¨­å®šè«‹å‡é™åˆ¶èˆ‡äººåŠ›è¦å‰‡</p>

                    <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-bottom:16px;">
                        <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">ğŸš« åŒæ™‚è«‹å‡äººæ•¸ä¸Šé™</div>
                        <p style="font-size:12px;color:#94A3B8;margin-bottom:12px;">ç•¶æŸå¤©å·²æœ‰ N äººè«‹å‡ï¼Œç¬¬ N+1 äººæäº¤ç”³è«‹æ™‚æœƒè¢«<b style="color:#DC2626;">è‡ªå‹•é§å›</b></p>
                        <div style="display:flex;align-items:center;gap:12px;">
                            <button onclick="adjustMaxLeave(-1)" style="width:44px;height:44px;border:2px solid #E5E7EB;border-radius:12px;background:#fff;font-size:20px;cursor:pointer;font-weight:700;">âˆ’</button>
                            <div style="flex:1;text-align:center;">
                                <div id="maxLeaveNum" style="font-size:36px;font-weight:900;color:#4F46E5;">2</div>
                                <div style="font-size:11px;color:#94A3B8;">äºº</div>
                            </div>
                            <button onclick="adjustMaxLeave(1)" style="width:44px;height:44px;border:2px solid #E5E7EB;border-radius:12px;background:#fff;font-size:20px;cursor:pointer;font-weight:700;">+</button>
                        </div>
                        <button onclick="saveMaxLeave()" style="width:100%;margin-top:14px;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ’¾ å„²å­˜è¨­å®š</button>
                        <div id="maxLeaveSaveStatus" style="margin-top:8px;text-align:center;font-size:13px;display:none;"></div>
                    </div>

                    <div style="background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                        <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:12px;">ğŸ“Š ç›®å‰äººåŠ›æ¦‚æ³</div>
                        <div id="staffOverview" style="font-size:13px;color:#64748B;line-height:1.8;">è¼‰å…¥ä¸­...</div>
                    </div>

                    <div style="background:#FFF7ED;border-radius:14px;padding:14px;margin-top:16px;">
                        <div style="font-size:13px;color:#EA580C;line-height:1.6;">
                            <b>ğŸ’¡ è‡ªå‹•é§å›è¦å‰‡èªªæ˜</b><br>
                            â€¢ å“¡å·¥å¡«å…¥è«‹å‡æ—¥æœŸæ™‚ï¼Œç³»çµ±<b>å³æ™‚æª¢æŸ¥</b>è©²æ—¥å·²æœ‰å¹¾äººè«‹å‡<br>
                            â€¢ è‹¥åŠ ä¸Šç”³è«‹è€…æœƒè¶…éä¸Šé™ï¼Œ<b>è¡¨å–®ç›´æ¥é–å®š</b>ç„¡æ³•æäº¤<br>
                            â€¢ å·²æ ¸å‡† + å¾…å¯©æ ¸ çš„å‡éƒ½æœƒè¢«è¨ˆå…¥<br>
                            â€¢ é€±æœ«ä¸è¨ˆå…¥è¡çªæª¢æŸ¥
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <nav class="bottom-nav" id="bottomNav" style="display:none;">
        <a class="nav-item" onclick="window.location.href='index.html'">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-label">é¦–é </span>
        </a>
        <a class="nav-item" onclick="window.location.href='schedule.html'">
            <span class="nav-icon">ğŸ“…</span>
            <span class="nav-label">ç­è¡¨</span>
        </a>
        <a class="nav-item" onclick="window.location.href='checkin.html?type=in'">
            <span class="nav-icon">ğŸ“</span>
            <span class="nav-label">æ‰“å¡</span>
        </a>
        <a class="nav-item" onclick="window.location.href='salary.html'">
            <span class="nav-icon">ğŸ’°</span>
            <span class="nav-label">è–ªè³‡</span>
        </a>
        <a class="nav-item active">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-label">ç®¡ç†</span>
        </a>
    </nav>

    <script src="common.js"></script>
    <script>
        let currentAdminEmployee = null;
        let allBonusStats = [];

        // é é¢åˆ‡æ›
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if (id === 'bonusPage') loadAllBonusStats();
            if (id === 'locationPage') renderLocationList();
            if (id === 'employeePage') loadEmployeeList();
            if (id === 'leaveApprovalPage') loadLeaveApprovals('pending');
            if (id === 'makeupApprovalPage') loadMakeupApprovals('pending');
            if (id === 'announcementPage') loadAnnouncementList();
            if (id === 'featurePage') { loadFeatureSettings(); loadNotifyToken(); }
            if (id === 'staffMgrPage') { loadShiftMgr(); loadMaxLeaveSetting(); loadStaffOverview(); }
        }

        // ===== åŠŸèƒ½ç®¡ç† =====
        let featureState = { leave: true, lunch: true, attendance: true };

        // LINE Notify è¨­å®š
        async function loadNotifyToken() {
            try {
                const { data } = await sb.from('system_settings')
                    .select('value').eq('key', 'line_notify_token').maybeSingle();
                if (data?.value?.token) {
                    const el = document.getElementById('lineNotifyToken');
                    if (el) el.value = data.value.token;
                }
            } catch(e) {}
        }

        async function saveNotifyToken() {
            const token = document.getElementById('lineNotifyToken')?.value?.trim();
            if (!token) return showToast('âŒ è«‹è¼¸å…¥ Token');
            const status = document.getElementById('notifyStatus');
            try {
                const { data: existing } = await sb.from('system_settings')
                    .select('id').eq('key', 'line_notify_token').maybeSingle();
                if (existing) {
                    await sb.from('system_settings').update({ value: { token }, updated_at: new Date().toISOString() }).eq('key', 'line_notify_token');
                } else {
                    await sb.from('system_settings').insert({ key: 'line_notify_token', value: { token }, description: 'LINE Notify æ¨æ’­ Token' });
                }
                showToast('âœ… Token å·²å„²å­˜');
                if (status) { status.style.display = 'block'; status.style.color = '#059669'; status.textContent = 'âœ… å·²å„²å­˜'; }
            } catch(e) { showToast('âŒ å„²å­˜å¤±æ•—'); }
        }

        async function testNotify() {
            const status = document.getElementById('notifyStatus');
            if (status) { status.style.display = 'block'; status.style.color = '#6D28D9'; status.textContent = 'â³ ç™¼é€æ¸¬è©¦...'; }
            try {
                await sendAdminNotify('ğŸ”” HR ç³»çµ±æ¨æ’­æ¸¬è©¦\nå¦‚æœæ‚¨æ”¶åˆ°æ­¤è¨Šæ¯ï¼Œè¡¨ç¤º LINE Notify è¨­å®šæˆåŠŸï¼');
                showToast('âœ… æ¸¬è©¦æ¨æ’­å·²ç™¼é€');
                if (status) { status.style.color = '#059669'; status.textContent = 'âœ… æ¨æ’­æˆåŠŸï¼è«‹æŸ¥çœ‹ LINE ç¾¤çµ„'; }
            } catch(e) {
                showToast('âŒ æ¨æ’­å¤±æ•—');
                if (status) { status.style.color = '#DC2626'; status.textContent = 'âŒ æ¨æ’­å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token æˆ– Edge Function'; }
            }
        }

        async function loadFeatureSettings() {
            try {
                const { data } = await sb.from('system_settings')
                    .select('value')
                    .eq('key', 'feature_visibility')
                    .maybeSingle();
                
                if (data?.value) {
                    featureState = { ...featureState, ...data.value };
                }
            } catch(e) {}
            
            // æ›´æ–°å¡ç‰‡é¡¯ç¤º
            ['leave', 'lunch', 'attendance'].forEach(key => updateToggleCard(key));
        }

        function updateToggleCard(key) {
            const card = document.getElementById('ftCard_' + key);
            if (!card) return;
            const on = featureState[key] !== false;
            const indicator = card.querySelector('.ft-indicator');
            const dot = indicator?.querySelector('div');
            
            if (on) {
                card.style.borderColor = '#4F46E5';
                card.style.background = '#F5F3FF';
                indicator.style.background = '#4F46E5';
                if (dot) { dot.style.right = '3px'; dot.style.left = 'auto'; }
            } else {
                card.style.borderColor = '#E5E7EB';
                card.style.background = '#fff';
                indicator.style.background = '#CBD5E1';
                if (dot) { dot.style.left = '3px'; dot.style.right = 'auto'; }
            }
        }

        async function toggleFeature(key) {
            featureState[key] = !featureState[key];
            updateToggleCard(key);
            
            try {
                const { data: existing } = await sb.from('system_settings')
                    .select('id')
                    .eq('key', 'feature_visibility')
                    .maybeSingle();
                
                if (existing) {
                    await sb.from('system_settings')
                        .update({ value: featureState, updated_at: new Date().toISOString() })
                        .eq('key', 'feature_visibility');
                } else {
                    await sb.from('system_settings')
                        .insert({ key: 'feature_visibility', value: featureState, description: 'å“¡å·¥å¯è¦‹åŠŸèƒ½è¨­å®š' });
                }
                
                const el = document.getElementById('featureSaveStatus');
                el.style.display = 'block';
                el.textContent = featureState[key] ? 'âœ… å·²é–‹å•Ÿ' : 'â›” å·²é—œé–‰';
                el.style.color = featureState[key] ? '#059669' : '#DC2626';
                setTimeout(() => el.style.display = 'none', 1500);
            } catch(e) {
                console.error('å„²å­˜å¤±æ•—', e);
                showToast('âŒ å„²å­˜å¤±æ•—');
            }
        }

        // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
        async function checkAdminPermission() {
            const statusEl = document.getElementById('permissionStatus');
            const loadingPage = document.getElementById('loadingPage');
            
            try {
                const initialized = await initializeLiff();
                
                // [BUG FIX] ç„¡è«–æˆåŠŸå¤±æ•—éƒ½è¦éš±è— loading ç•«é¢
                if (loadingPage) loadingPage.style.display = 'none';
                
                if (!initialized) {
                    showStatus(statusEl, 'error', 'âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹å¾ LINE é–‹å•Ÿ');
                    return;
                }

                console.log('ğŸ”‘ LINE User ID:', liffProfile?.userId);

                const { data, error } = await sb.from('employees')
                    .select('*')
                    .eq('line_user_id', liffProfile.userId)
                    .eq('role', 'admin')
                    .eq('is_active', true)
                    .maybeSingle();

                if (error) {
                    console.error('âŒ è³‡æ–™åº«æŸ¥è©¢éŒ¯èª¤:', error);
                    showStatus(statusEl, 'error', 'âŒ è³‡æ–™åº«æŸ¥è©¢å¤±æ•—: ' + error.message);
                    return;
                }
                
                if (!data) {
                    console.log('âŒ æ‰¾ä¸åˆ°ç®¡ç†å“¡è³‡æ–™ï¼ŒLINE ID:', liffProfile?.userId);
                    showStatus(statusEl, 'error', 'âŒ æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™<br><small style="opacity:0.7">LINE ID: ' + (liffProfile?.userId || 'æœªçŸ¥') + '</small>');
                    setTimeout(() => { window.location.href = 'index.html'; }, 5000);
                    return;
                }

                currentAdminEmployee = data;
                updateAdminInfo(data);
                
                // è¼‰å…¥ç³»çµ±è¨­å®šï¼ˆåœ°é»ç­‰ï¼‰
                await loadSettings();
                
                showStatus(statusEl, 'success', 'âœ… æ¬Šé™é©—è­‰é€šé');
                setTimeout(() => { 
                    showPage('adminHomePage');
                    document.getElementById('bottomNav').style.display = 'flex';
                }, 800);

            } catch (err) {
                console.error('æ¬Šé™æª¢æŸ¥ç•°å¸¸:', err);
                if (loadingPage) loadingPage.style.display = 'none';
                showStatus(statusEl, 'error', 'âŒ æ¬Šé™æª¢æŸ¥å¤±æ•—: ' + (typeof friendlyError === 'function' ? friendlyError(err) : err.message));
            }
        }

        // [BUG FIX] ä¿®æ­£ç®¡ç†å“¡é ­åƒé¡¯ç¤º â€” æœ‰åœ–ç‰‡æ™‚ä¸æ‡‰é¡¯ç¤º emoji
        function updateAdminInfo(data) {
            document.getElementById('adminName').textContent = data.name;
            document.getElementById('adminDept').textContent = `${data.department || 'ç³»çµ±ç®¡ç†'} Â· ç®¡ç†å“¡`;
            document.getElementById('adminId').textContent = `ID: ${data.employee_number}`;
            
            const avatar = document.getElementById('adminAvatar');
            if (liffProfile?.pictureUrl) {
                avatar.style.backgroundImage = `url(${liffProfile.pictureUrl})`;
                avatar.style.backgroundSize = 'cover';
                avatar.textContent = '';
            } else {
                avatar.textContent = 'ğŸ‘‘';
            }
        }

        // è¼‰å…¥çé‡‘çµ±è¨ˆ
        async function loadAllBonusStats() {
            const yearEl = document.getElementById('bonusYear');
            const listEl = document.getElementById('bonusList');
            if (!yearEl || !listEl) return;

            const year = parseInt(yearEl.value);
            listEl.innerHTML = '<p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>';

            try {
                const { data, error } = await sb.rpc('get_all_year_end_stats', { p_year: year });
                if (error) throw error;
                
                allBonusStats = data || [];
                
                const eligible = allBonusStats.filter(emp => emp.bonus_status === 'ç¬¦åˆè³‡æ ¼');
                const ineligible = allBonusStats.filter(emp => emp.bonus_status !== 'ç¬¦åˆè³‡æ ¼');
                const totalBudget = allBonusStats.reduce((sum, emp) => sum + (emp.suggested_bonus || 0), 0);
                
                document.getElementById('eligibleCount').textContent = eligible.length;
                document.getElementById('ineligibleCount').textContent = ineligible.length;
                document.getElementById('totalBudget').textContent = `$${totalBudget.toLocaleString()}`;
                document.getElementById('avgBonus').textContent = eligible.length > 0 
                    ? `$${Math.round(totalBudget / eligible.length).toLocaleString()}` : '$0';

                let html = '';
                allBonusStats.forEach(emp => {
                    const isEligible = emp.bonus_status === 'ç¬¦åˆè³‡æ ¼';
                    html += `
                        <div class="attendance-item ${isEligible ? 'normal' : 'late'}">
                            <div class="date">
                                <span>${emp.name} (${emp.employee_number})</span>
                                <span class="badge ${isEligible ? 'badge-success' : 'badge-warning'}">
                                    ${isEligible ? 'âœ… ç¬¦åˆ' : 'âŒ æœªç¬¦åˆ'}
                                </span>
                            </div>
                            <div class="details">
                                <span>${emp.department || '-'}</span>
                                <span style="font-weight:bold;">$${(emp.suggested_bonus || 0).toLocaleString()}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                ${emp.bonus_status} Â· å‡ºå‹¤ ${emp.attendance_rate}% Â· é²åˆ° ${emp.late_count}æ¬¡
                            </div>
                            <button class="btn-danger" onclick="adjustBonus('${emp.employee_id}', '${emp.name}', ${emp.suggested_bonus || 0})" style="margin-top:8px;font-size:12px;padding:6px 12px;">
                                âœï¸ èª¿æ•´çé‡‘
                            </button>
                        </div>
                    `;
                });
                
                listEl.innerHTML = html || '<p style="text-align:center;color:#999;">ç„¡è³‡æ–™</p>';

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // èª¿æ•´çé‡‘
        function adjustBonus(employeeId, employeeName, currentBonus) {
            const newBonus = prompt(`èª¿æ•´ ${employeeName} çš„çé‡‘é‡‘é¡\nç›®å‰: $${currentBonus.toLocaleString()}\nè«‹è¼¸å…¥æ–°é‡‘é¡ï¼š`);
            
            if (newBonus === null) return;
            
            const bonusAmount = parseInt(newBonus);
            if (isNaN(bonusAmount) || bonusAmount < 0) {
                showToast('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
                return;
            }
            
            showToast(`âœ… ${employeeName} çš„çé‡‘å·²èª¿æ•´ç‚º $${bonusAmount.toLocaleString()}`);
            loadAllBonusStats();
        }

        // å“¡å·¥ Modal
        function showAddEmployeeModal() {
            document.getElementById('addEmployeeModal').style.display = 'flex';
            document.getElementById('newEmployeeHireDate').value = new Date().toISOString().split('T')[0];
        }

        function closeAddEmployeeModal() {
            document.getElementById('addEmployeeModal').style.display = 'none';
            document.getElementById('addEmployeeForm').reset();
        }

        // æ–°å¢å“¡å·¥
        document.getElementById('addEmployeeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const employeeData = {
                name: document.getElementById('newEmployeeName').value.trim(),
                employee_number: document.getElementById('newEmployeeNumber').value.trim(),
                department: document.getElementById('newEmployeeDepartment').value,
                position: document.getElementById('newEmployeePosition').value.trim() || 'å“¡å·¥',
                id_card_last_4: document.getElementById('newEmployeeCode').value.trim(),
                hire_date: document.getElementById('newEmployeeHireDate').value,
                role: document.getElementById('newEmployeeRole').value,
                is_active: true,
                company_id: '8a669e2c-7521-43e9-9300-5c004c57e9db',
                created_at: new Date().toISOString()
            };

            if (!employeeData.name || !employeeData.employee_number || !employeeData.id_card_last_4) {
                showToast('âš ï¸ è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }
            
            try {
                const { data, error } = await sb.from('employees').insert([employeeData]);
                if (error) throw error;
                
                showToast('âœ… å“¡å·¥æ–°å¢æˆåŠŸï¼');
                closeAddEmployeeModal();
                loadEmployeeList();
            } catch (err) {
                console.error('æ–°å¢å“¡å·¥å¤±æ•—:', err);
                showToast('âŒ æ–°å¢å¤±æ•—: ' + friendlyError(err));
            }
        });

        // QR Code
        function showJoinQRCode() {
            const modal = document.getElementById('qrModal');
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';
            
            const liffUrl = `https://liff.line.me/${CONFIG.LIFF_ID}?type=bind&company=HR_SYSTEM_001`;
            
            new QRCode(qrcodeDiv, {
                text: liffUrl, width: 200, height: 200,
                colorDark: "#1f2937", colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            modal.style.display = 'flex';
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰ Modal
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // è¼‰å…¥å“¡å·¥åˆ—è¡¨
        async function loadEmployeeList() {
            const listEl = document.getElementById('employeeList');
            if (!listEl) return;

            try {
                const { data, error } = await sb.from('employees')
                    .select('*')
                    .eq('is_active', true)
                    .order('department', { ascending: true });

                if (error) throw error;

                const roleNames = { 'admin': 'ç®¡ç†å“¡', 'manager': 'ä¸»ç®¡', 'user': 'ä¸€èˆ¬å“¡å·¥' };

                let html = '';
                data.forEach(emp => {
                    html += `
                        <div class="attendance-item">
                            <div class="date">
                                <div style="display:flex; align-items:center; flex-wrap:wrap; gap:4px;">
                                    <span>${emp.name} - ${emp.employee_number}</span>
                                    <span class="role-${emp.role || 'user'}" style="
                                        padding: 3px 10px; border-radius: 15px; font-size: 11px;
                                        display: inline-block; font-weight: bold;">
                                        ${roleNames[emp.role] || 'æœªçŸ¥'}
                                    </span>
                                </div>
                            </div>
                            <div class="details">
                                <span>${emp.department || '-'} Â· ${emp.position || '-'}</span>
                                <span style="font-size:12px;">é©—è­‰ç¢¼: ${emp.id_card_last_4 || 'æœªè¨­å®š'}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                åˆ°è·: ${emp.hire_date || 'æœªè¨­å®š'} Â· ${emp.line_user_id ? 'âœ… å·²ç¶å®š' : 'â³ æœªç¶å®š'}
                            </div>
                            ${emp.line_user_id ? `
                                <div style="margin-top:8px;display:flex;gap:8px;">
                                    <button class="btn-success-sm" onclick="updateEmployeeRoleAdmin('${emp.id}', 'admin', '${emp.name}')" style="flex:1;padding:8px 12px;border:none;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;${emp.role === 'admin' ? 'opacity:0.4;pointer-events:none;' : ''}">
                                        è¨­ç‚ºç®¡ç†å“¡
                                    </button>
                                    <button class="btn-danger" onclick="updateEmployeeRoleAdmin('${emp.id}', 'user', '${emp.name}')" style="flex:1;padding:8px 12px;border-radius:10px;font-size:12px;font-weight:700;${emp.role !== 'admin' ? 'opacity:0.4;pointer-events:none;' : ''}">
                                        å–æ¶ˆç®¡ç†å“¡
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                listEl.innerHTML = html || '<p style="text-align:center;color:#999;">ç„¡å“¡å·¥è³‡æ–™</p>';

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // [BUG FIX] æ•´åˆè§’è‰²æ›´æ–°å‡½æ•¸ï¼Œé¿å…é‡è¤‡å®šç¾©
        async function updateEmployeeRoleAdmin(employeeId, newRole, employeeName) {
            const roleNames = { 'admin': 'ç®¡ç†å“¡', 'manager': 'ä¸»ç®¡', 'user': 'ä¸€èˆ¬å“¡å·¥' };
            
            try {
                const { error } = await sb.from('employees')
                    .update({ role: newRole })
                    .eq('id', employeeId);
                
                if (error) throw error;
                showToast(`âœ… ${employeeName} â†’ ${roleNames[newRole]}`);
                loadEmployeeList();
            } catch (err) {
                console.error(err);
                showToast('âŒ æ›´æ–°å¤±æ•—: ' + friendlyError(err));
            }
        }

        // æœå°‹å“¡å·¥
        function searchEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            const items = document.querySelectorAll('#employeeList .attendance-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // è«‹å‡å¯©æ ¸
        function switchLeaveTab(status) {
            document.querySelectorAll('#leaveApprovalPage .tab-btn').forEach(btn => {
                btn.className = 'tab-btn inactive';
            });
            event.target.className = 'tab-btn active';
            loadLeaveApprovals(status);
        }

        async function loadLeaveApprovals(status) {
            const listEl = document.getElementById('leaveApprovalList');
            if (!listEl) return;

            try {
                const { data, error } = await sb.from('leave_requests')
                    .select(`*, employees!leave_requests_employee_id_fkey(name, employee_number, department)`)
                    .eq('status', status)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const typeMap = { 'annual': 'ç‰¹ä¼‘', 'sick': 'ç—…å‡', 'personal': 'äº‹å‡', 'compensatory': 'è£œä¼‘' };
                const statusText = { 'pending': 'å¾…å¯©æ ¸', 'approved': 'å·²é€šé', 'rejected': 'å·²æ‹’çµ•' };

                let html = '';
                (data || []).forEach(request => {
                    html += `
                        <div class="attendance-item">
                            <div class="date">
                                <span>${request.employees?.name || 'æœªçŸ¥'} - ${typeMap[request.leave_type] || request.leave_type}</span>
                                <span style="font-size:12px;color:#999;">${request.created_at?.split('T')[0] || ''}</span>
                            </div>
                            <div class="details">
                                <span>${request.start_date} ~ ${request.end_date}</span>
                                <span>${request.employees?.department || '-'}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                ${request.reason || 'ç„¡åŸå› '}
                            </div>
                            ${request.status === 'rejected' && request.rejection_reason ? `
                                <div style="font-size:12px;color:#DC2626;margin-top:6px;padding:8px 10px;background:#FEF2F2;border-radius:8px;">
                                    âŒ æ‹’çµ•åŸå› ï¼š${request.rejection_reason}
                                </div>
                            ` : ''}
                            ${status === 'pending' ? `
                                <div style="margin-top:8px;display:flex;gap:6px;">
                                    <button class="btn-success" onclick="approveLeave('${request.id}', 'approved')" style="flex:1;font-size:12px;padding:8px;border:none;border-radius:8px;cursor:pointer;">
                                        âœ… é€šé
                                    </button>
                                    <button class="btn-danger" onclick="approveLeave('${request.id}', 'rejected')" style="flex:1;font-size:12px;padding:8px;">
                                        âŒ æ‹’çµ•
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                listEl.innerHTML = html || `<p style="text-align:center;color:#999;">ç„¡${statusText[status] || ''}çš„è«‹å‡ç”³è«‹</p>`;

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        async function approveLeave(requestId, newStatus) {
            // æ‹’çµ•æ™‚è¦æ±‚å¡«åŸå› 
            let rejectionReason = null;
            if (newStatus === 'rejected') {
                rejectionReason = prompt('è«‹è¼¸å…¥æ‹’çµ•åŸå› ï¼ˆé¸å¡«ï¼‰ï¼š');
                if (rejectionReason === null) return; // æŒ‰å–æ¶ˆ = ä¸æ“ä½œ
            }

            try {
                const updateData = { 
                    status: newStatus,
                    approver_id: currentAdminEmployee.id,
                    approved_at: new Date().toISOString()
                };
                if (newStatus === 'rejected') {
                    updateData.rejection_reason = rejectionReason || 'ä¸ç¬¦åˆè¦å®š';
                }

                // å…ˆæŸ¥è«‹å‡è³‡è¨Šï¼ˆç”¨æ–¼é€šçŸ¥ï¼‰
                const { data: reqData } = await sb.from('leave_requests')
                    .select('*, employees(name, id)')
                    .eq('id', requestId).single();

                const { error } = await sb.from('leave_requests')
                    .update(updateData)
                    .eq('id', requestId);

                if (error) throw error;

                // LINE Notify é€šçŸ¥å“¡å·¥
                if (reqData?.employees?.id) {
                    const typeMap = { annual:'ç‰¹ä¼‘', sick:'ç—…å‡', personal:'äº‹å‡', compensatory:'è£œä¼‘' };
                    const typeName = typeMap[reqData.leave_type] || reqData.leave_type;
                    if (newStatus === 'approved') {
                        sendUserNotify(reqData.employees.id, `âœ… æ‚¨çš„${typeName}ç”³è«‹å·²é€šé\nğŸ“… ${reqData.start_date} ~ ${reqData.end_date}`);
                    } else {
                        sendUserNotify(reqData.employees.id, `âŒ æ‚¨çš„${typeName}ç”³è«‹å·²è¢«æ‹’çµ•\nğŸ“… ${reqData.start_date} ~ ${reqData.end_date}\nåŸå› ï¼š${updateData.rejection_reason}`);
                    }
                }

                showToast(`âœ… è«‹å‡ç”³è«‹å·²${newStatus === 'approved' ? 'é€šé' : 'æ‹’çµ•'}`);
                loadLeaveApprovals('pending');

            } catch (err) {
                console.error(err);
                showToast('âŒ å¯©æ ¸å¤±æ•—: ' + friendlyError(err));
            }
        }

        // ===== äººåŠ›ç®¡ç† â€” é ç±¤åˆ‡æ› =====
        function switchStaffTab(tab) {
            document.querySelectorAll('.staffTabContent').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.smTab').forEach(btn => {
                btn.style.background = 'transparent'; btn.style.color = '#94A3B8'; btn.style.boxShadow = 'none';
            });
            const tabEl = document.getElementById({ shift:'tabShift', leave:'tabLeave', setting:'tabSetting' }[tab]);
            if (tabEl) tabEl.style.display = 'block';
            const btns = document.querySelectorAll('.smTab');
            const idx = { shift:0, leave:1, setting:2 }[tab];
            if (btns[idx]) { btns[idx].style.background = '#fff'; btns[idx].style.color = '#4F46E5'; btns[idx].style.boxShadow = '0 1px 4px rgba(0,0,0,0.08)'; }
            if (tab === 'leave') loadLeaveCal();
            if (tab === 'shift') loadShiftMgr();
            if (tab === 'setting') { loadMaxLeaveSetting(); loadStaffOverview(); }
        }

        // ===== äººåŠ›è¨­å®š =====
        let maxLeaveValue = 2;

        function adjustMaxLeave(d) {
            maxLeaveValue = Math.max(1, Math.min(10, maxLeaveValue + d));
            document.getElementById('maxLeaveNum').textContent = maxLeaveValue;
        }

        async function loadMaxLeaveSetting() {
            try {
                const { data } = await sb.from('system_settings').select('value').eq('key', 'max_concurrent_leave').maybeSingle();
                if (data?.value?.max) { maxLeaveValue = data.value.max; }
            } catch(e) {}
            document.getElementById('maxLeaveNum').textContent = maxLeaveValue;
        }

        async function saveMaxLeave() {
            const statusEl = document.getElementById('maxLeaveSaveStatus');
            try {
                const { data: existing } = await sb.from('system_settings').select('id').eq('key', 'max_concurrent_leave').maybeSingle();
                const val = { max: maxLeaveValue };
                if (existing) {
                    await sb.from('system_settings').update({ value: val, updated_at: new Date().toISOString() }).eq('key', 'max_concurrent_leave');
                } else {
                    await sb.from('system_settings').insert({ key: 'max_concurrent_leave', value: val, description: 'åŒæ™‚è«‹å‡äººæ•¸ä¸Šé™' });
                }
                statusEl.style.display = 'block'; statusEl.style.color = '#059669'; statusEl.textContent = 'âœ… å·²å„²å­˜';
                setTimeout(() => { statusEl.style.display = 'none'; }, 2000);
            } catch(e) {
                statusEl.style.display = 'block'; statusEl.style.color = '#DC2626'; statusEl.textContent = 'âŒ å„²å­˜å¤±æ•—';
            }
        }

        async function loadStaffOverview() {
            const el = document.getElementById('staffOverview');
            if (!el) return;
            try {
                const { data: emps } = await sb.from('employees').select('id, status').eq('status', 'active');
                const total = emps?.length || 0;
                const todayStr = new Date().toISOString().split('T')[0];
                const { data: todayLeaves } = await sb.from('leave_requests').select('id')
                    .in('status', ['approved','pending'])
                    .lte('start_date', todayStr).gte('end_date', todayStr);
                const onLeave = todayLeaves?.length || 0;
                el.innerHTML = `
                    <div style="display:flex;gap:8px;margin-bottom:8px;">
                        <span style="padding:6px 12px;background:#ECFDF5;border-radius:8px;font-weight:700;color:#059669;">ğŸ‘¥ åœ¨è· ${total} äºº</span>
                        <span style="padding:6px 12px;background:#FFF7ED;border-radius:8px;font-weight:700;color:#EA580C;">ğŸ–ï¸ ä»Šæ—¥è«‹å‡ ${onLeave} äºº</span>
                        <span style="padding:6px 12px;background:#EFF6FF;border-radius:8px;font-weight:700;color:#2563EB;">ğŸ’ª ä»Šæ—¥å¯ç”¨ ${total - onLeave} äºº</span>
                    </div>
                    <div style="font-size:12px;color:#94A3B8;">ç›®å‰è¨­å®šï¼šåŒæ™‚æœ€å¤š <b style="color:#DC2626;">${maxLeaveValue}</b> äººè«‹å‡</div>
                `;
            } catch(e) { el.textContent = 'è¼‰å…¥å¤±æ•—'; }
        }

        // ===== ä¼‘å‡æœˆè¡¨ =====
        let lcYear, lcMonth;
        (function() { const n = new Date(); lcYear = n.getFullYear(); lcMonth = n.getMonth(); })();

        function changeLeaveCal(d) {
            lcMonth += d;
            if (lcMonth < 0) { lcMonth = 11; lcYear--; }
            if (lcMonth > 11) { lcMonth = 0; lcYear++; }
            loadLeaveCal();
        }

        async function loadLeaveCal() {
            document.getElementById('lcMonthLabel').textContent = `${lcYear}å¹´ ${lcMonth + 1}æœˆ`;
            const dim = new Date(lcYear, lcMonth + 1, 0).getDate();
            const ms = `${lcYear}-${String(lcMonth + 1).padStart(2, '0')}-01`;
            const me = `${lcYear}-${String(lcMonth + 1).padStart(2, '0')}-${dim}`;

            // è®€å–ä¸Šé™
            let maxC = maxLeaveValue || 2;
            try {
                const { data: s } = await sb.from('system_settings').select('value').eq('key', 'max_concurrent_leave').maybeSingle();
                if (s?.value?.max) maxC = s.value.max;
            } catch(e) {}
            document.getElementById('lcMax').textContent = maxC;

            let employees = [], leaves = [];
            try {
                const { data: emps } = await sb.from('employees').select('id, name, department').eq('status', 'active').order('department').order('name');
                employees = emps || [];
                const { data: lvs } = await sb.from('leave_requests').select('employee_id, start_date, end_date, leave_type, status')
                    .in('status', ['approved', 'pending']).or(`and(start_date.lte.${me},end_date.gte.${ms})`);
                leaves = lvs || [];
            } catch(e) { console.error(e); }

            const wd = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            // è¨ˆç®—æ¯å¤©è«‹å‡äººæ•¸
            const dayCount = {};
            for (let d = 1; d <= dim; d++) {
                const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                dayCount[ds] = 0;
                leaves.forEach(l => { if (ds >= l.start_date && ds <= (l.end_date || l.start_date)) dayCount[ds]++; });
            }

            // è¡¨é ­
            let headHtml = '<tr><th style="position:sticky;left:0;background:#fff;z-index:2;padding:6px 8px;min-width:60px;text-align:left;border-bottom:2px solid #E5E7EB;font-size:11px;">å§“å</th>';
            for (let d = 1; d <= dim; d++) {
                const dt = new Date(lcYear, lcMonth, d);
                const isW = dt.getDay()===0 || dt.getDay()===6;
                const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const over = dayCount[ds] >= maxC && !isW;
                const bg = over ? '#FEE2E2' : isW ? '#F1F5F9' : '#fff';
                headHtml += `<th style="padding:4px 2px;min-width:28px;text-align:center;border-bottom:2px solid ${over?'#FCA5A5':'#E5E7EB'};background:${bg};font-size:10px;">
                    <div style="${over?'color:#DC2626;font-weight:900;':''}">${d}</div><div style="color:#94A3B8;font-size:9px;">${wd[dt.getDay()]}</div>
                    ${over ? '<div style="font-size:8px;color:#DC2626;font-weight:900;">æ»¿</div>' : ''}
                </th>`;
            }
            headHtml += '</tr>';
            document.getElementById('lcHead').innerHTML = headHtml;

            // è¡¨èº«
            const typeColor = { annual:'#DBEAFE', sick:'#FEE2E2', personal:'#FEF3C7', compensatory:'#E0E7FF' };
            const typeEmoji = { annual:'ğŸ–', sick:'ğŸ¤’', personal:'ğŸ“‹', compensatory:'ğŸ’¤' };
            let totalLeaves = 0;
            const todayStr = new Date().toISOString().split('T')[0];
            let todayAvail = employees.length;
            let overDays = [];

            let bodyHtml = '';
            employees.forEach(emp => {
                const empLeaves = leaves.filter(l => l.employee_id === emp.id);
                bodyHtml += `<tr><td style="position:sticky;left:0;background:#fff;z-index:1;padding:6px 8px;font-weight:700;font-size:11px;white-space:nowrap;border-bottom:1px solid #F1F5F9;">${emp.name}</td>`;
                for (let d = 1; d <= dim; d++) {
                    const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const dt = new Date(lcYear, lcMonth, d);
                    const isW = dt.getDay()===0 || dt.getDay()===6;
                    const lv = empLeaves.find(l => ds >= l.start_date && ds <= (l.end_date || l.start_date));
                    const over = dayCount[ds] > maxC && !isW;
                    if (lv) {
                        totalLeaves++;
                        if (ds === todayStr) todayAvail--;
                        const bg = over ? '#FCA5A5' : (typeColor[lv.leave_type] || '#F1F5F9');
                        const emoji = typeEmoji[lv.leave_type] || 'ğŸ“';
                        const pending = lv.status === 'pending' ? 'opacity:0.6;' : '';
                        bodyHtml += `<td style="text-align:center;background:${bg};border-bottom:1px solid #F1F5F9;${pending}font-size:10px;cursor:default;" title="${emp.name} ${lv.leave_type}${lv.status==='pending'?' (å¾…å¯©)':''}${over?' âš è¶…é™':''}">${emoji}</td>`;
                    } else if (isW) {
                        bodyHtml += `<td style="background:#F8FAFC;border-bottom:1px solid #F1F5F9;"></td>`;
                    } else {
                        bodyHtml += `<td style="border-bottom:1px solid #F1F5F9;"></td>`;
                    }
                }
                bodyHtml += '</tr>';
            });

            // åº•éƒ¨çµ±è¨ˆåˆ— â€” æ¯æ—¥è«‹å‡äººæ•¸
            bodyHtml += '<tr style="background:#F8FAFC;"><td style="position:sticky;left:0;background:#F8FAFC;z-index:1;padding:6px 8px;font-weight:700;font-size:10px;color:#64748B;">è«‹å‡æ•¸</td>';
            for (let d = 1; d <= dim; d++) {
                const ds = `${lcYear}-${String(lcMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dt = new Date(lcYear, lcMonth, d);
                const isW = dt.getDay()===0 || dt.getDay()===6;
                const cnt = dayCount[ds] || 0;
                const over = cnt >= maxC && !isW;
                if (over && !isW) overDays.push(`${lcMonth+1}/${d}`);
                bodyHtml += `<td style="text-align:center;font-size:10px;font-weight:900;color:${over?'#DC2626':cnt>0?'#EA580C':'#CBD5E1'};border-bottom:1px solid #F1F5F9;background:${over?'#FEF2F2':'#F8FAFC'};">${cnt||'-'}</td>`;
            }
            bodyHtml += '</tr>';

            document.getElementById('lcBody').innerHTML = bodyHtml;
            document.getElementById('lcTotal').textContent = totalLeaves;
            document.getElementById('lcAvail').textContent = Math.max(0, todayAvail);

            // è¶…é™è­¦å‘Š
            const warnEl = document.getElementById('lcOverWarn');
            if (overDays.length > 0) {
                warnEl.style.display = 'block';
                warnEl.innerHTML = `ğŸš¨ ä»¥ä¸‹æ—¥æœŸè«‹å‡äººæ•¸å·²é”/è¶…éä¸Šé™ï¼ˆ${maxC}äººï¼‰ï¼š<br><b>${overDays.join('ã€')}</b><br><span style="font-size:11px;opacity:0.7;">å“¡å·¥åœ¨é€™äº›æ—¥æœŸæäº¤è«‹å‡å°‡è¢«è‡ªå‹•é§å›</span>`;
            } else {
                warnEl.style.display = 'none';
            }
        }

        // ===== æ’ç­ç®¡ç† =====
        let smWeekStart;
        (function() {
            const n = new Date(); const dow = n.getDay();
            smWeekStart = new Date(n);
            smWeekStart.setDate(n.getDate() - dow + 1);
            smWeekStart.setHours(0,0,0,0);
        })();

        let smEmployees = [];
        let smScheduleData = {};
        let smLeaveData = {};
        const SHIFT_TYPES = [null, 'morning', 'afternoon', 'night', 'off'];
        const SHIFT_DISPLAY = {
            null: { label:'â¬œ', bg:'#F8FAFC', color:'#94A3B8', name:'æœªæ’' },
            morning: { label:'â˜€ï¸', bg:'#DBEAFE', color:'#1E40AF', name:'æ—©ç­' },
            afternoon: { label:'ğŸŒ¤ï¸', bg:'#FEF3C7', color:'#92400E', name:'ä¸­ç­' },
            night: { label:'ğŸŒ™', bg:'#EDE9FE', color:'#6D28D9', name:'æ™šç­' },
            off: { label:'ğŸ–ï¸', bg:'#ECFDF5', color:'#059669', name:'ä¼‘å‡' }
        };

        function changeShiftWeek(d) { smWeekStart.setDate(smWeekStart.getDate() + d*7); loadShiftMgr(); }

        function getWeekDates() {
            const dates = [];
            for (let i = 0; i < 7; i++) { const d = new Date(smWeekStart); d.setDate(d.getDate()+i); dates.push(d); }
            return dates;
        }

        async function loadShiftMgr() {
            const dates = getWeekDates();
            const startStr = dates[0].toISOString().split('T')[0];
            const endStr = dates[6].toISOString().split('T')[0];
            document.getElementById('smWeekLabel').textContent = `${startStr} ~ ${endStr}`;

            try {
                const { data: emps } = await sb.from('employees').select('id, name, department').eq('status', 'active').order('name');
                smEmployees = emps || [];
                const { data: scheds } = await sb.from('schedules').select('employee_id, date, shift_type_id, shift_types(name, code)')
                    .gte('date', startStr).lte('date', endStr);
                smScheduleData = {};
                (scheds || []).forEach(s => {
                    const code = s.shift_types?.code || s.shift_types?.name || 'morning';
                    smScheduleData[`${s.employee_id}_${s.date}`] = code;
                });
                // è¼‰å…¥è©²é€±è«‹å‡
                const { data: lvs } = await sb.from('leave_requests').select('employee_id, start_date, end_date, status')
                    .in('status', ['approved']).or(`and(start_date.lte.${endStr},end_date.gte.${startStr})`);
                smLeaveData = {};
                (lvs || []).forEach(l => {
                    for (let d = new Date(Math.max(new Date(l.start_date), dates[0])); d <= Math.min(new Date(l.end_date), dates[6]); d.setDate(d.getDate()+1)) {
                        smLeaveData[`${l.employee_id}_${d.toISOString().split('T')[0]}`] = true;
                    }
                });
            } catch(e) { console.error(e); }

            renderShiftTable();
        }

        function renderShiftTable() {
            const dates = getWeekDates();
            const wd = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

            // è¡¨é ­
            let headHtml = '<tr><th style="position:sticky;left:0;background:#fff;z-index:2;padding:8px;min-width:60px;text-align:left;border-bottom:2px solid #E5E7EB;font-size:11px;">å§“å</th>';
            dates.forEach(d => {
                const isW = d.getDay()===0||d.getDay()===6;
                headHtml += `<th style="padding:6px 4px;min-width:46px;text-align:center;border-bottom:2px solid #E5E7EB;background:${isW?'#F1F5F9':'#fff'};">
                    <div style="font-size:12px;">${d.getDate()}</div><div style="font-size:10px;color:#94A3B8;">é€±${wd[d.getDay()]}</div>
                </th>`;
            });
            headHtml += '</tr>';
            document.getElementById('smHead').innerHTML = headHtml;

            // è¡¨èº«
            let bodyHtml = '';
            smEmployees.forEach(emp => {
                bodyHtml += `<tr><td style="position:sticky;left:0;background:#fff;z-index:1;padding:8px;font-weight:700;font-size:11px;white-space:nowrap;border-bottom:1px solid #F1F5F9;">${emp.name}</td>`;
                dates.forEach(d => {
                    const ds = d.toISOString().split('T')[0];
                    const key = `${emp.id}_${ds}`;
                    const onLeave = smLeaveData[key];
                    const shift = smScheduleData[key] || null;
                    const disp = SHIFT_DISPLAY[shift] || SHIFT_DISPLAY[null];
                    if (onLeave) {
                        bodyHtml += `<td style="text-align:center;padding:8px 4px;border-bottom:1px solid #F1F5F9;background:#FEE2E2;font-size:14px;cursor:not-allowed;opacity:0.7;" title="${emp.name} å·²è«‹å‡">ğŸ–ï¸</td>`;
                    } else {
                        bodyHtml += `<td onclick="cycleShift('${key}')" style="text-align:center;padding:8px 4px;cursor:pointer;border-bottom:1px solid #F1F5F9;background:${disp.bg};font-size:14px;transition:all 0.15s;user-select:none;" title="${emp.name} ${ds} ${disp.name}">${disp.label}</td>`;
                    }
                });
                bodyHtml += '</tr>';
            });

            // æ¯æ—¥äººåŠ›çµ±è¨ˆåˆ—
            bodyHtml += '<tr style="background:#F8FAFC;font-weight:700;"><td style="position:sticky;left:0;background:#F8FAFC;z-index:1;padding:6px 8px;font-size:10px;color:#64748B;">ä¸Šç­äººæ•¸</td>';
            let warnDays = [];
            dates.forEach(d => {
                const ds = d.toISOString().split('T')[0];
                const isW = d.getDay()===0||d.getDay()===6;
                let working = 0;
                smEmployees.forEach(emp => {
                    const key = `${emp.id}_${ds}`;
                    if (smLeaveData[key]) return;
                    const shift = smScheduleData[key];
                    if (shift && shift !== 'off') working++;
                });
                const low = working > 0 && working <= 2 && !isW;
                if (low) warnDays.push(`${d.getMonth()+1}/${d.getDate()}(${working}äºº)`);
                bodyHtml += `<td style="text-align:center;font-size:11px;color:${low?'#DC2626':working>0?'#059669':'#94A3B8'};background:${low?'#FEF2F2':'#F8FAFC'};border-bottom:1px solid #F1F5F9;">${working||'-'}</td>`;
            });
            bodyHtml += '</tr>';
            document.getElementById('smBody').innerHTML = bodyHtml;

            // æ¯æ—¥æ‘˜è¦å¡ç‰‡
            let sumHtml = '';
            dates.forEach(d => {
                const ds = d.toISOString().split('T')[0];
                const isW = d.getDay()===0||d.getDay()===6;
                const counts = { morning:0, afternoon:0, night:0, off:0, leave:0, unset:0 };
                smEmployees.forEach(emp => {
                    const key = `${emp.id}_${ds}`;
                    if (smLeaveData[key]) { counts.leave++; return; }
                    const s = smScheduleData[key];
                    if (s && counts.hasOwnProperty(s)) counts[s]++;
                    else counts.unset++;
                });
                const total = counts.morning + counts.afternoon + counts.night;
                const low = total > 0 && total <= 2 && !isW;
                sumHtml += `<div style="min-width:60px;padding:6px 8px;background:${low?'#FEF2F2':'#F8FAFC'};border-radius:8px;text-align:center;flex-shrink:0;${low?'border:2px solid #FCA5A5;':''}">
                    <div style="font-size:10px;font-weight:700;color:#64748B;">${d.getDate()}æ—¥</div>
                    <div style="font-size:14px;font-weight:900;color:${low?'#DC2626':'#0F172A'};">${total}äºº</div>
                    <div style="font-size:9px;color:#94A3B8;">â˜€${counts.morning} ğŸŒ¤${counts.afternoon} ğŸŒ™${counts.night}</div>
                    ${counts.leave>0?`<div style="font-size:9px;color:#EA580C;">å‡${counts.leave}</div>`:''}
                </div>`;
            });
            document.getElementById('shiftDaySummary').innerHTML = sumHtml;

            // äººæ‰‹ä¸è¶³è­¦å‘Š
            const warnEl = document.getElementById('shiftStaffWarn');
            if (warnDays.length > 0) {
                warnEl.style.display = 'block';
                warnEl.innerHTML = `âš ï¸ äººæ‰‹ä¸è¶³è­¦å‘Šï¼š${warnDays.join('ã€')}<br><span style="font-size:11px;opacity:0.7;">å»ºè­°èª¿æ•´æ’ç­æˆ–é™åˆ¶è«‹å‡</span>`;
            } else {
                warnEl.style.display = 'none';
            }
        }

        function cycleShift(key) {
            const current = smScheduleData[key] || null;
            const idx = SHIFT_TYPES.indexOf(current);
            smScheduleData[key] = SHIFT_TYPES[(idx+1) % SHIFT_TYPES.length];
            renderShiftTable();
        }

        async function saveSchedule() {
            const statusEl = document.getElementById('smSaveStatus');
            statusEl.style.display = 'block'; statusEl.style.color = '#F59E0B'; statusEl.textContent = 'â³ å„²å­˜ä¸­...';
            try {
                const { data: shiftTypes } = await sb.from('shift_types').select('id, code, name');
                const stMap = {};
                (shiftTypes || []).forEach(st => { stMap[st.code || st.name] = st.id; });
                const upserts = [];
                for (const [key, shift] of Object.entries(smScheduleData)) {
                    if (!shift) continue;
                    const parts = key.split('_');
                    const empId = parts[0];
                    const date = parts.slice(1).join('-');
                    const stId = stMap[shift];
                    if (!stId) continue;
                    upserts.push({ employee_id: empId, date, shift_type_id: stId });
                }
                if (upserts.length > 0) {
                    const { error } = await sb.from('schedules').upsert(upserts, { onConflict: 'employee_id,date' });
                    if (error) throw error;
                }
                statusEl.style.color = '#059669'; statusEl.textContent = `âœ… å·²å„²å­˜ ${upserts.length} ç­†æ’ç­`;
                setTimeout(() => { statusEl.style.display = 'none'; }, 2500);
            } catch(e) {
                console.error(e);
                statusEl.style.color = '#DC2626'; statusEl.textContent = 'âŒ å„²å­˜å¤±æ•—: ' + e.message;
            }
        }

        async function copyLastWeek() {
            if (!confirm('ç¢ºå®šè¦è¤‡è£½ä¸Šé€±æ’ç­åˆ°æœ¬é€±ï¼Ÿ\nï¼ˆå·²æœ‰æ’ç­ä¸æœƒè¢«è¦†è“‹ï¼‰')) return;
            const dates = getWeekDates();
            try {
                const lwStart = new Date(dates[0]); lwStart.setDate(lwStart.getDate()-7);
                const lwEnd = new Date(dates[6]); lwEnd.setDate(lwEnd.getDate()-7);
                const { data: lastScheds } = await sb.from('schedules').select('employee_id, date, shift_type_id, shift_types(code, name)')
                    .gte('date', lwStart.toISOString().split('T')[0]).lte('date', lwEnd.toISOString().split('T')[0]);
                let copied = 0;
                (lastScheds || []).forEach(s => {
                    const oldD = new Date(s.date + 'T00:00:00');
                    const newD = new Date(oldD); newD.setDate(newD.getDate()+7);
                    const key = `${s.employee_id}_${newD.toISOString().split('T')[0]}`;
                    if (!smScheduleData[key]) {
                        smScheduleData[key] = s.shift_types?.code || s.shift_types?.name || 'morning';
                        copied++;
                    }
                });
                renderShiftTable();
                showToast(`ğŸ“‹ å·²è¤‡è£½ä¸Šé€± ${copied} ç­†æ’ç­`);
            } catch(e) { console.error(e); showToast('âŒ è¤‡è£½å¤±æ•—'); }
        }


        // ===== è£œæ‰“å¡å¯©æ ¸ =====
        function switchMakeupTab(status) {
            document.querySelectorAll('#makeupApprovalPage .tab-btn').forEach(btn => {
                btn.className = 'tab-btn ' + (btn.textContent.includes(status === 'pending' ? 'å¾…å¯©' : status === 'approved' ? 'å·²é€šé' : 'å·²æ‹’çµ•') ? 'active' : 'inactive');
            });
            loadMakeupApprovals(status);
        }

        async function loadMakeupApprovals(status) {
            const listEl = document.getElementById('makeupApprovalList');
            if (!listEl) return;
            listEl.innerHTML = '<p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>';

            try {
                const { data } = await sb.from('makeup_punch_requests')
                    .select('*, employees(name, department, employee_number)')
                    .eq('status', status)
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (!data || data.length === 0) {
                    const labels = { pending:'å¾…å¯©æ ¸', approved:'å·²é€šé', rejected:'å·²æ‹’çµ•' };
                    listEl.innerHTML = `<p style="text-align:center;color:#999;">ç„¡${labels[status]}çš„è£œæ‰“å¡ç”³è«‹</p>`;
                    return;
                }

                const typeMap = { clock_in:'â˜€ï¸ ä¸Šç­', clock_out:'ğŸŒ™ ä¸‹ç­' };
                listEl.innerHTML = data.map(r => `
                    <div style="background:#fff;border-radius:14px;padding:14px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,0.06);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <span style="font-weight:800;font-size:14px;">${r.employees?.name || '?'}</span>
                            <span style="font-size:11px;color:#94A3B8;">${r.employees?.department || ''} Â· ${r.employees?.employee_number || ''}</span>
                        </div>
                        <div style="display:flex;gap:8px;margin-bottom:8px;font-size:13px;">
                            <span style="padding:4px 10px;background:#EFF6FF;border-radius:8px;color:#2563EB;font-weight:700;">ğŸ“… ${r.punch_date}</span>
                            <span style="padding:4px 10px;background:#F5F3FF;border-radius:8px;color:#7C3AED;font-weight:700;">${typeMap[r.punch_type] || r.punch_type} ${r.punch_time || ''}</span>
                        </div>
                        <div style="font-size:12px;color:#64748B;margin-bottom:8px;">${r.reason || ''}</div>
                        ${status === 'pending' ? `
                            <div style="display:flex;gap:8px;">
                                <button onclick="approveMakeupPunch('${r.id}','approved')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#ECFDF5;color:#059669;font-weight:700;font-size:13px;cursor:pointer;">âœ… é€šé</button>
                                <button onclick="rejectMakeupPunchPrompt('${r.id}')" style="flex:1;padding:10px;border:none;border-radius:10px;background:#FEF2F2;color:#DC2626;font-weight:700;font-size:13px;cursor:pointer;">âŒ æ‹’çµ•</button>
                            </div>
                        ` : ''}
                        ${r.status === 'approved' ? '<div style="font-size:11px;color:#059669;margin-top:4px;">âœ… å·²è‡ªå‹•å¯«å…¥å‡ºå‹¤è¨˜éŒ„</div>' : ''}
                        ${r.rejection_reason ? `<div style="font-size:11px;color:#DC2626;margin-top:4px;">âŒ ${r.rejection_reason}</div>` : ''}
                    </div>
                `).join('');
            } catch(e) {
                console.error(e);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        async function approveMakeupPunch(id, status) {
            try {
                const { data: req } = await sb.from('makeup_punch_requests').select('*').eq('id', id).single();
                
                await sb.from('makeup_punch_requests').update({
                    status: status,
                    approver_id: currentAdminEmployee?.id,
                    approved_at: new Date().toISOString()
                }).eq('id', id);

                // é€šéå¾Œè‡ªå‹•å¯«å…¥ attendance
                if (status === 'approved' && req) {
                    const col = req.punch_type === 'clock_in' ? 'check_in_time' : 'check_out_time';
                    const timeVal = `${req.punch_date}T${req.punch_time}:00`;
                    
                    // å…ˆæŸ¥æ˜¯å¦å·²æœ‰ç•¶å¤©è¨˜éŒ„
                    const { data: existing } = await sb.from('attendance')
                        .select('id')
                        .eq('employee_id', req.employee_id)
                        .eq('date', req.punch_date)
                        .maybeSingle();
                    
                    if (existing) {
                        await sb.from('attendance').update({
                            [col]: timeVal,
                            is_manual: true,
                            notes: `è£œæ‰“å¡ - ${req.reason || ''}`
                        }).eq('id', existing.id);
                    } else {
                        await sb.from('attendance').insert({
                            employee_id: req.employee_id,
                            date: req.punch_date,
                            [col]: timeVal,
                            is_manual: true,
                            status: 'present',
                            notes: `è£œæ‰“å¡ - ${req.reason || ''}`
                        });
                    }
                    
                    // é€šçŸ¥å“¡å·¥
                    sendUserNotify(req.employee_id, `âœ… æ‚¨çš„è£œæ‰“å¡ç”³è«‹å·²é€šé\nğŸ“… ${req.punch_date} ${req.punch_type === 'clock_in' ? 'ä¸Šç­' : 'ä¸‹ç­'} ${req.punch_time}`);
                }

                showToast(status === 'approved' ? 'âœ… å·²é€šéä¸¦å¯«å…¥å‡ºå‹¤' : 'âŒ å·²æ‹’çµ•');
                loadMakeupApprovals('pending');
            } catch(e) {
                console.error(e);
                showToast('âŒ å¯©æ ¸å¤±æ•—: ' + friendlyError(e));
            }
        }

        function rejectMakeupPunchPrompt(id) {
            const reason = prompt('è«‹è¼¸å…¥æ‹’çµ•åŸå› ï¼ˆé¸å¡«ï¼‰ï¼š');
            if (reason === null) return;
            rejectMakeupPunch(id, reason);
        }

        async function rejectMakeupPunch(id, reason) {
            try {
                await sb.from('makeup_punch_requests').update({
                    status: 'rejected',
                    rejection_reason: reason || 'ä¸ç¬¦åˆè¦å®š',
                    approver_id: currentAdminEmployee?.id,
                    approved_at: new Date().toISOString()
                }).eq('id', id);
                showToast('âŒ å·²æ‹’çµ•');
                loadMakeupApprovals('pending');
            } catch(e) { showToast('âŒ æ“ä½œå¤±æ•—'); }
        }

        // ===== å…¬å‘Šç®¡ç† =====
        async function publishAnnouncement() {
            const title = document.getElementById('annTitle')?.value;
            const content = document.getElementById('annContent')?.value;
            const type = document.getElementById('annType')?.value;
            const expire = document.getElementById('annExpire')?.value;
            const pinned = document.getElementById('annPinned')?.checked;
            
            if (!title) return showToast('âŒ è«‹è¼¸å…¥æ¨™é¡Œ');
            
            try {
                // è®€å–ç¾æœ‰å…¬å‘Š
                const { data: existing } = await sb.from('system_settings')
                    .select('value').eq('key', 'announcements').maybeSingle();
                
                const items = existing?.value?.items || [];
                items.unshift({
                    id: Date.now().toString(),
                    title, content, type, pinned,
                    expire_date: expire || null,
                    created_at: new Date().toISOString(),
                    created_by: currentAdminEmployee?.name || 'admin'
                });
                
                if (existing) {
                    await sb.from('system_settings').update({ value: { items }, updated_at: new Date().toISOString() }).eq('key', 'announcements');
                } else {
                    await sb.from('system_settings').insert({ key: 'announcements', value: { items }, description: 'å…¬å‘Šç³»çµ±' });
                }
                
                showToast('ğŸ“¢ å…¬å‘Šå·²ç™¼å¸ƒ');
                document.getElementById('annTitle').value = '';
                document.getElementById('annContent').value = '';
                document.getElementById('annExpire').value = '';
                document.getElementById('annPinned').checked = false;
                loadAnnouncementList();
            } catch(e) { showToast('âŒ ç™¼å¸ƒå¤±æ•—ï¼š' + friendlyError(e)); }
        }

        async function loadAnnouncementList() {
            const el = document.getElementById('announcementList');
            if (!el) return;
            
            try {
                const { data } = await sb.from('system_settings')
                    .select('value').eq('key', 'announcements').maybeSingle();
                
                const items = data?.value?.items || [];
                if (items.length === 0) { el.innerHTML = '<p style="text-align:center;color:#999;">å°šç„¡å…¬å‘Š</p>'; return; }
                
                const typeIcon = { info:'ğŸ“¢', warning:'âš ï¸', urgent:'ğŸš¨', event:'ğŸ‰' };
                const typeColor = { info:'#2563EB', warning:'#EA580C', urgent:'#DC2626', event:'#7C3AED' };
                const typeBg = { info:'#EFF6FF', warning:'#FFF7ED', urgent:'#FEF2F2', event:'#F5F3FF' };
                
                el.innerHTML = items.map(a => `
                    <div style="background:${typeBg[a.type] || '#F1F5F9'};border-radius:12px;padding:14px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <span style="font-weight:800;color:${typeColor[a.type] || '#64748B'};">${typeIcon[a.type] || 'ğŸ“Œ'} ${a.title}</span>
                            <button onclick="deleteAnnouncement('${a.id}')" style="background:none;border:none;font-size:14px;cursor:pointer;padding:4px;">ğŸ—‘ï¸</button>
                        </div>
                        ${a.content ? `<div style="font-size:12px;color:#64748B;margin-bottom:4px;">${a.content}</div>` : ''}
                        <div style="font-size:10px;color:#94A3B8;">
                            ${a.pinned ? 'ğŸ“Œ ç½®é ‚ Â· ' : ''}
                            ${a.expire_date ? 'åˆ°æœŸï¼š' + a.expire_date + ' Â· ' : 'æ°¸ä¹… Â· '}
                            ${a.created_by || ''} Â· ${a.created_at ? new Date(a.created_at).toLocaleDateString() : ''}
                        </div>
                    </div>
                `).join('');
            } catch(e) { el.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>'; }
        }

        async function deleteAnnouncement(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤å…¬å‘Šï¼Ÿ')) return;
            try {
                const { data } = await sb.from('system_settings')
                    .select('value').eq('key', 'announcements').maybeSingle();
                if (!data?.value?.items) return;
                
                const items = data.value.items.filter(a => a.id !== id);
                await sb.from('system_settings').update({ value: { items }, updated_at: new Date().toISOString() }).eq('key', 'announcements');
                showToast('ğŸ—‘ï¸ å·²åˆªé™¤');
                loadAnnouncementList();
            } catch(e) { showToast('âŒ åˆªé™¤å¤±æ•—'); }
        }

        // åŒ¯å‡ºå ±è¡¨
        function exportReport(type) {
            const names = { 'attendance': 'å‡ºå‹¤', 'leave': 'è«‹å‡', 'bonus': 'çé‡‘', 'lunch': 'ä¾¿ç•¶' };
            showToast(`ğŸ“Š æ­£åœ¨æº–å‚™${names[type] || ''}å ±è¡¨...`);
            setTimeout(() => { showToast('â³ å ±è¡¨åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…'); }, 1000);
        }

        // é é¢è¼‰å…¥
        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') {
                console.error('common.js æœªæ­£ç¢ºè¼‰å…¥');
                return;
            }
            checkAdminPermission();
        });
    </script>
</body>
</html>
