<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‘‘ ç®¡ç†å¾Œå° - å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        #lcTable th, #lcTable td, #smTable th, #smTable td { border: 1px solid #F1F5F9; }
        #smTable td:hover { filter: brightness(0.92); }
        #lcTable th, #smTable th { position: sticky; top: 0; background: #fff; z-index: 1; }
    </style>
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <!-- æ¬Šé™æª¢æŸ¥é é¢ -->
        <div id="permissionPage" class="page active">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">ğŸ”</span>
                    <h2>ç®¡ç†å“¡æ¬Šé™æª¢æŸ¥</h2>
                    <p>æ­£åœ¨é©—è­‰æ‚¨çš„ç®¡ç†å“¡èº«ä»½...</p>
                </div>
                <div id="permissionStatus" class="status-box show info">
                    æª¢æŸ¥æ¬Šé™ä¸­...
                </div>
            </div>
        </div>

        <!-- ç®¡ç†å¾Œå°é¦–é  -->
        <div id="adminHomePage" class="page">
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="adminAvatar">ğŸ‘‘</div>
                    <div class="user-details">
                        <h2 id="adminName">ç®¡ç†å“¡</h2>
                        <p id="adminDept">ç³»çµ±ç®¡ç†</p>
                        <p id="adminId" style="font-size: 11px; opacity: 0.7;">ID: -</p>
                    </div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="showPage('bonusPage')">
                    <div class="icon">ğŸ</div><div class="label">å¹´çµ‚çé‡‘è©¦ç®—</div>
                </div>
                <div class="menu-item" onclick="showPage('locationPage')">
                    <div class="icon">ğŸ“</div><div class="label">åœ°é»ç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="showPage('employeePage')">
                    <div class="icon">ğŸ‘¥</div><div class="label">å“¡å·¥ç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="showPage('leaveApprovalPage')">
                    <div class="icon">âœ…</div><div class="label">è«‹å‡å¯©æ ¸</div>
                </div>
                <div class="menu-item" onclick="showPage('reportPage')">
                    <div class="icon">ğŸ“Š</div><div class="label">å ±è¡¨åŒ¯å‡º</div>
                </div>
                <div class="menu-item" onclick="showPage('leaveCalPage')">
                    <div class="icon">ğŸ—“ï¸</div><div class="label">ä¼‘å‡ç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="showPage('shiftMgrPage')">
                    <div class="icon">ğŸ“‹</div><div class="label">æ’ç­ç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="showPage('featurePage')">
                    <div class="icon">ğŸ›ï¸</div><div class="label">åŠŸèƒ½ç®¡ç†</div>
                </div>
                <div class="menu-item" onclick="window.location.href='index.html'">
                    <div class="icon">ğŸ </div><div class="label">è¿”å›é¦–é </div>
                </div>
            </div>
        </div>

        <!-- å¹´çµ‚çé‡‘è©¦ç®—é é¢ -->
        <div id="bonusPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ å¹´çµ‚çé‡‘è©¦ç®—</h2>
                <div class="form-group">
                    <label>è©¦ç®—å¹´åº¦</label>
                    <select id="bonusYear" onchange="loadAllBonusStats()">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:15px;">ğŸ“ˆ è©¦ç®—æ‘˜è¦</h3>
                    <div class="stat-row"><span>ç¬¦åˆè³‡æ ¼äººæ•¸</span><span id="eligibleCount">0</span></div>
                    <div class="stat-row"><span>æœªç¬¦åˆè³‡æ ¼äººæ•¸</span><span id="ineligibleCount">0</span></div>
                    <div class="stat-row"><span>ç¸½é ç®—</span><span id="totalBudget">$0</span></div>
                    <div class="stat-row"><span>å¹³å‡çé‡‘</span><span id="avgBonus">$0</span></div>
                </div>

                <div id="bonusList" style="margin-top:20px;">
                    <p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- åœ°é»ç®¡ç†é é¢ -->
        <div id="locationPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“ åœ°é»ç®¡ç†</h2>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:10px;">ğŸ“ ç›®å‰æ‰“å¡åœ°é»</h3>
                    <!-- [BUG FIX] ä½¿ç”¨èˆ‡ common.js ä¸€è‡´çš„ ID -->
                    <div id="locationList">
                        <p style="color:#666;text-align:center;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <div style="margin-top: 20px; background:#fff; border-radius:16px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                    <h3 style="margin-bottom:15px;">â• æ–°å¢åœ°é»</h3>
                    <div class="form-group">
                        <label>åœ°é»åç¨±</label>
                        <!-- [BUG FIX] ä½¿ç”¨èˆ‡ common.js ä¸€è‡´çš„ ID -->
                        <input type="text" id="newLocName" placeholder="ä¾‹å¦‚ï¼šå°åŒ—åˆ†åº—">
                    </div>
                    <div class="form-group">
                        <label>æ‰“å¡åŠå¾‘ (å…¬å°º)</label>
                        <input type="number" id="newLocRadius" value="300">
                    </div>
                    <div class="form-group">
                        <label>åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="newLocLat" placeholder="ç·¯åº¦" readonly>
                            <input type="text" id="newLocLng" placeholder="ç¶“åº¦" readonly>
                        </div>
                        <button class="btn btn-primary" onclick="getCurrentGPSForSetting()" style="margin-top:10px; font-size:14px; padding:10px;">
                            ğŸ“ æŠ“å–ç›®å‰ä½ç½®
                        </button>
                    </div>
                    <button class="btn btn-success" onclick="addNewLocation()">ğŸ’¾ å„²å­˜æ–°åœ°é»</button>
                </div>
            </div>
        </div>

        <!-- å“¡å·¥ç®¡ç†é é¢ -->
        <div id="employeePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h2 style="margin:0;">ğŸ‘¥ å“¡å·¥ç®¡ç†</h2>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-success" onclick="showAddEmployeeModal()" style="font-size:13px; padding:8px 14px; width:auto; margin:0;">
                            â• æ–°å¢
                        </button>
                        <button class="btn btn-primary" onclick="showJoinQRCode()" style="font-size:13px; padding:8px 14px; width:auto; margin:0;">
                            ğŸ“± QR Code
                        </button>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom:15px;">
                    <input type="text" id="employeeSearch" placeholder="ğŸ” æœå°‹å§“åæˆ–å·¥è™Ÿ" onkeyup="searchEmployees()">
                </div>
                <div id="employeeList">
                    <p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- æ–°å¢å“¡å·¥ Modal -->
        <div id="addEmployeeModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>â• æ–°å¢å“¡å·¥</h3>
                    <button class="modal-close" onclick="closeAddEmployeeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addEmployeeForm">
                        <div class="form-group">
                            <label>å§“å *</label>
                            <input type="text" id="newEmployeeName" required placeholder="è«‹è¼¸å…¥å“¡å·¥å§“å">
                        </div>
                        <div class="form-group">
                            <label>å·¥è™Ÿ *</label>
                            <input type="text" id="newEmployeeNumber" required placeholder="ä¾‹å¦‚ï¼šE001">
                        </div>
                        <div class="form-group">
                            <label>éƒ¨é–€</label>
                            <select id="newEmployeeDepartment">
                                <option value="ç®¡ç†éƒ¨">ç®¡ç†éƒ¨</option>
                                <option value="æ¥­å‹™éƒ¨">æ¥­å‹™éƒ¨</option>
                                <option value="æŠ€è¡“éƒ¨">æŠ€è¡“éƒ¨</option>
                                <option value="äººäº‹éƒ¨">äººäº‹éƒ¨</option>
                                <option value="è²¡å‹™éƒ¨">è²¡å‹™éƒ¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è·ä½</label>
                            <input type="text" id="newEmployeePosition" placeholder="ä¾‹å¦‚ï¼šå°ˆå“¡">
                        </div>
                        <div class="form-group">
                            <label>é©—è­‰ç¢¼ *</label>
                            <input type="text" id="newEmployeeCode" required placeholder="èº«åˆ†è­‰å¾Œ4ç¢¼æˆ–è‡ªè¨‚é©—è­‰ç¢¼">
                            <small style="color:#666; font-size:12px; display:block; margin-top:5px;">
                                ğŸ’¡ å»ºè­°ä½¿ç”¨èº«åˆ†è­‰å¾Œ4ç¢¼ï¼Œå“¡å·¥ç¶å®šæ™‚éœ€è¦è¼¸å…¥æ­¤é©—è­‰ç¢¼
                            </small>
                        </div>
                        <div class="form-group">
                            <label>åˆ°è·æ—¥æœŸ</label>
                            <input type="date" id="newEmployeeHireDate">
                        </div>
                        <div class="form-group">
                            <label>è§’è‰²æ¬Šé™</label>
                            <select id="newEmployeeRole">
                                <option value="user">ä¸€èˆ¬å“¡å·¥</option>
                                <option value="manager">ä¸»ç®¡</option>
                                <option value="admin">ç®¡ç†å“¡</option>
                            </select>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button type="submit" class="btn btn-success" style="flex:1;">ğŸ’¾ å„²å­˜å“¡å·¥</button>
                            <button type="button" class="btn btn-secondary" onclick="closeAddEmployeeModal()" style="flex:1;">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div id="qrModal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ğŸ“± å“¡å·¥åŠ å…¥ QR Code</h3>
                    <button class="modal-close" onclick="closeQRModal()">&times;</button>
                </div>
                <div class="modal-body" style="text-align:center;">
                    <div id="qrcode" style="margin:20px auto; display:inline-block;"></div>
                    <div style="margin-top:20px; padding:15px; background:#f3f4f6; border-radius:12px;">
                        <p style="margin:0; font-size:14px; color:#666;">å…¬å¸ä»£ç¢¼</p>
                        <p style="margin:5px 0; font-size:18px; font-weight:bold; color:#1f2937;">HR_SYSTEM_001</p>
                        <p style="margin:5px 0; font-size:12px; color:#9ca3af;">ç„¡æ³•æƒç¢¼æ™‚è«‹æ‰‹å‹•è¼¸å…¥æ­¤ä»£ç¢¼</p>
                    </div>
                    <div style="margin-top:15px; padding:12px; background:#fef3c7; border-radius:8px; border-left:4px solid #f59e0b; text-align:left;">
                        <p style="margin:0; font-size:13px; color:#92400e;">
                            <strong>ä½¿ç”¨èªªæ˜ï¼š</strong><br>
                            1. å“¡å·¥æƒææ­¤ QR Code<br>
                            2. è¼¸å…¥å·¥è™Ÿå’Œé©—è­‰ç¢¼<br>
                            3. å®Œæˆç¶å®šå³å¯ä½¿ç”¨ç³»çµ±
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è«‹å‡å¯©æ ¸é é¢ -->
        <div id="leaveApprovalPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>âœ… è«‹å‡å¯©æ ¸</h2>
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchLeaveTab('pending')">å¾…å¯©æ ¸</button>
                    <button class="tab-btn inactive" onclick="switchLeaveTab('approved')">å·²é€šé</button>
                    <button class="tab-btn inactive" onclick="switchLeaveTab('rejected')">å·²æ‹’çµ•</button>
                </div>
                <div id="leaveApprovalList">
                    <p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- å ±è¡¨åŒ¯å‡ºé é¢ -->
        <div id="reportPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“Š å ±è¡¨åŒ¯å‡º</h2>
                <div class="menu-grid">
                    <div class="menu-item" onclick="exportReport('attendance')">
                        <div class="icon">ğŸ“ˆ</div><div class="label">å‡ºå‹¤å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('leave')">
                        <div class="icon">ğŸ“</div><div class="label">è«‹å‡å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('bonus')">
                        <div class="icon">ğŸ</div><div class="label">çé‡‘å ±è¡¨</div>
                    </div>
                    <div class="menu-item" onclick="exportReport('lunch')">
                        <div class="icon">ğŸ±</div><div class="label">ä¾¿ç•¶å ±è¡¨</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½ç®¡ç†é é¢ -->
        <div id="featurePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ›ï¸ åŠŸèƒ½ç®¡ç†</h2>
                <p style="color:#6b7280;font-size:13px;margin-bottom:16px;">æ§åˆ¶å“¡å·¥é¦–é <b>ä¸­é–“é¸å–®</b>é¡¯ç¤ºå“ªäº›åŠŸèƒ½</p>
                
                <div id="featureToggles" style="display:flex;flex-direction:column;gap:12px;">
                    <!-- è«‹å‡ -->
                    <div class="feature-toggle-card" id="ftCard_leave" onclick="toggleFeature('leave')" style="display:flex;align-items:center;gap:14px;padding:16px;background:#fff;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                        <span style="font-size:28px;">ğŸ“</span>
                        <div style="flex:1;">
                            <div style="font-weight:800;font-size:14px;color:#0F172A;">æˆ‘è¦è«‹å‡</div>
                            <div style="font-size:12px;color:#94A3B8;margin-top:2px;">è«‹å‡ç”³è«‹èˆ‡è¨˜éŒ„æŸ¥è©¢</div>
                        </div>
                        <div class="ft-indicator" style="width:44px;height:26px;border-radius:13px;background:#4F46E5;position:relative;transition:background 0.3s;">
                            <div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;right:3px;transition:all 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                    <!-- ä¾¿ç•¶ -->
                    <div class="feature-toggle-card" id="ftCard_lunch" onclick="toggleFeature('lunch')" style="display:flex;align-items:center;gap:14px;padding:16px;background:#fff;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                        <span style="font-size:28px;">ğŸ±</span>
                        <div style="flex:1;">
                            <div style="font-weight:800;font-size:14px;color:#0F172A;">ä¾¿ç•¶è¨‚è³¼</div>
                            <div style="font-size:12px;color:#94A3B8;margin-top:2px;">æ¯æ—¥åˆé¤è¨‚è³¼ç®¡ç†</div>
                        </div>
                        <div class="ft-indicator" style="width:44px;height:26px;border-radius:13px;background:#4F46E5;position:relative;transition:background 0.3s;">
                            <div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;right:3px;transition:all 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                    <!-- è€ƒå‹¤ -->
                    <div class="feature-toggle-card" id="ftCard_attendance" onclick="toggleFeature('attendance')" style="display:flex;align-items:center;gap:14px;padding:16px;background:#fff;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                        <span style="font-size:28px;">ğŸ“Š</span>
                        <div style="flex:1;">
                            <div style="font-weight:800;font-size:14px;color:#0F172A;">è€ƒå‹¤æŸ¥è©¢</div>
                            <div style="font-size:12px;color:#94A3B8;margin-top:2px;">å‡ºå‹¤æœˆæ›†èˆ‡è¨˜éŒ„æŸ¥è©¢</div>
                        </div>
                        <div class="ft-indicator" style="width:44px;height:26px;border-radius:13px;background:#4F46E5;position:relative;transition:background 0.3s;">
                            <div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;right:3px;transition:all 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                </div>
                <div id="featureSaveStatus" style="margin-top:12px;text-align:center;font-size:13px;color:#059669;display:none;">âœ… å·²å„²å­˜</div>
                <p style="color:#94A3B8;font-size:12px;margin-top:16px;text-align:center;">ğŸ’¡ åº•éƒ¨å°èˆªåˆ—ï¼ˆé¦–é /ç­è¡¨/æ‰“å¡/è–ªè³‡/ç®¡ç†ï¼‰ç‚ºç®¡ç†å“¡å°ˆå±¬ï¼Œä¸å—æ­¤è¨­å®šå½±éŸ¿</p>
            </div>
        </div>

        <!-- ====== â‘£ ä¼‘å‡ç®¡ç†æœˆè¡¨ ====== -->
        <div id="leaveCalPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ—“ï¸ å“¡å·¥ä¼‘å‡ç®¡ç†</h2>
                <p style="color:#6b7280;font-size:13px;margin-bottom:12px;">ä¸€è¦½å…¨å“¡ä¼‘å‡ç‹€æ…‹ï¼Œæ–¹ä¾¿å®‰æ’å·¥ä½œ</p>
                
                <div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:16px;">
                    <button onclick="changeLeaveCal(-1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">â—€</button>
                    <span id="lcMonthLabel" style="font-size:16px;font-weight:700;min-width:120px;text-align:center;">-</span>
                    <button onclick="changeLeaveCal(1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">â–¶</button>
                </div>

                <!-- çµ±è¨ˆ -->
                <div style="display:flex;gap:8px;margin-bottom:16px;">
                    <div style="flex:1;text-align:center;padding:10px;background:#EFF6FF;border-radius:12px;">
                        <div style="font-size:20px;font-weight:900;color:#2563EB;" id="lcTotal">0</div>
                        <div style="font-size:10px;font-weight:600;color:#2563EB;">ç¸½è«‹å‡äººæ¬¡</div>
                    </div>
                    <div style="flex:1;text-align:center;padding:10px;background:#ECFDF5;border-radius:12px;">
                        <div style="font-size:20px;font-weight:900;color:#059669;" id="lcAvail">0</div>
                        <div style="font-size:10px;font-weight:600;color:#059669;">ä»Šæ—¥å¯ç”¨äººåŠ›</div>
                    </div>
                </div>

                <!-- æœˆè¡¨æ ¼ -->
                <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
                    <table id="lcTable" style="width:100%;border-collapse:collapse;font-size:11px;min-width:600px;">
                        <thead id="lcHead"></thead>
                        <tbody id="lcBody"></tbody>
                    </table>
                </div>

                <!-- åœ–ä¾‹ -->
                <div style="display:flex;gap:12px;justify-content:center;margin-top:12px;flex-wrap:wrap;">
                    <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#DBEAFE;border-radius:3px;display:inline-block;"></span>ç‰¹ä¼‘</span>
                    <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FEE2E2;border-radius:3px;display:inline-block;"></span>ç—…å‡</span>
                    <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#FEF3C7;border-radius:3px;display:inline-block;"></span>äº‹å‡</span>
                    <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#E0E7FF;border-radius:3px;display:inline-block;"></span>è£œä¼‘</span>
                </div>
            </div>
        </div>

        <!-- ====== â‘¤ æ’ç­ç®¡ç† ====== -->
        <div id="shiftMgrPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('adminHomePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“‹ æ’ç­ç®¡ç†</h2>
                <p style="color:#6b7280;font-size:13px;margin-bottom:12px;">å®‰æ’å“¡å·¥ç­åˆ¥ï¼Œé»æ“Šæ ¼å­åˆ‡æ›ç­åˆ¥</p>
                
                <div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:12px;">
                    <button onclick="changeShiftWeek(-1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">â—€</button>
                    <span id="smWeekLabel" style="font-size:15px;font-weight:700;min-width:180px;text-align:center;">-</span>
                    <button onclick="changeShiftWeek(1)" style="background:none;border:none;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:8px;">â–¶</button>
                </div>

                <!-- ç­åˆ¥åœ–ä¾‹ -->
                <div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;justify-content:center;">
                    <span style="font-size:11px;padding:4px 10px;background:#DBEAFE;color:#1E40AF;border-radius:8px;font-weight:700;">â˜€ï¸ æ—©ç­</span>
                    <span style="font-size:11px;padding:4px 10px;background:#FEF3C7;color:#92400E;border-radius:8px;font-weight:700;">ğŸŒ¤ï¸ ä¸­ç­</span>
                    <span style="font-size:11px;padding:4px 10px;background:#EDE9FE;color:#6D28D9;border-radius:8px;font-weight:700;">ğŸŒ™ æ™šç­</span>
                    <span style="font-size:11px;padding:4px 10px;background:#ECFDF5;color:#059669;border-radius:8px;font-weight:700;">ğŸ–ï¸ ä¼‘å‡</span>
                    <span style="font-size:11px;padding:4px 10px;background:#F1F5F9;color:#64748B;border-radius:8px;font-weight:700;">â¬œ æœªæ’</span>
                </div>

                <!-- æ’ç­è¡¨æ ¼ -->
                <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
                    <table id="smTable" style="width:100%;border-collapse:collapse;font-size:12px;min-width:500px;">
                        <thead id="smHead"></thead>
                        <tbody id="smBody"></tbody>
                    </table>
                </div>

                <!-- å¿«é€Ÿæ“ä½œ -->
                <div style="margin-top:16px;display:flex;gap:8px;">
                    <button onclick="saveSchedule()" style="flex:1;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">
                        ğŸ’¾ å„²å­˜æ’ç­
                    </button>
                    <button onclick="copyLastWeek()" style="padding:14px 20px;border:2px solid #E5E7EB;border-radius:12px;background:#fff;font-weight:700;font-size:14px;cursor:pointer;">
                        ğŸ“‹ è¤‡è£½ä¸Šé€±
                    </button>
                </div>
                <div id="smSaveStatus" style="margin-top:10px;text-align:center;font-size:13px;display:none;"></div>
            </div>
        </div>
    </div>
    <nav class="bottom-nav" id="bottomNav" style="display:none;">
        <a class="nav-item" onclick="window.location.href='index.html'">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-label">é¦–é </span>
        </a>
        <a class="nav-item" onclick="window.location.href='schedule.html'">
            <span class="nav-icon">ğŸ“…</span>
            <span class="nav-label">ç­è¡¨</span>
        </a>
        <a class="nav-item" onclick="window.location.href='checkin.html?type=in'">
            <span class="nav-icon">ğŸ“</span>
            <span class="nav-label">æ‰“å¡</span>
        </a>
        <a class="nav-item" onclick="window.location.href='salary.html'">
            <span class="nav-icon">ğŸ’°</span>
            <span class="nav-label">è–ªè³‡</span>
        </a>
        <a class="nav-item active">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-label">ç®¡ç†</span>
        </a>
    </nav>

    <script src="common.js"></script>
    <script>
        let currentAdminEmployee = null;
        let allBonusStats = [];

        // é é¢åˆ‡æ›
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if (id === 'bonusPage') loadAllBonusStats();
            if (id === 'locationPage') renderLocationList();
            if (id === 'employeePage') loadEmployeeList();
            if (id === 'leaveApprovalPage') loadLeaveApprovals('pending');
            if (id === 'featurePage') loadFeatureSettings();
            if (id === 'leaveCalPage') loadLeaveCal();
            if (id === 'shiftMgrPage') loadShiftMgr();
        }

        // ===== åŠŸèƒ½ç®¡ç† =====
        let featureState = { leave: true, lunch: true, attendance: true };

        async function loadFeatureSettings() {
            try {
                const { data } = await sb.from('system_settings')
                    .select('value')
                    .eq('key', 'feature_visibility')
                    .maybeSingle();
                
                if (data?.value) {
                    featureState = { ...featureState, ...data.value };
                }
            } catch(e) {}
            
            // æ›´æ–°å¡ç‰‡é¡¯ç¤º
            ['leave', 'lunch', 'attendance'].forEach(key => updateToggleCard(key));
        }

        function updateToggleCard(key) {
            const card = document.getElementById('ftCard_' + key);
            if (!card) return;
            const on = featureState[key] !== false;
            const indicator = card.querySelector('.ft-indicator');
            const dot = indicator?.querySelector('div');
            
            if (on) {
                card.style.borderColor = '#4F46E5';
                card.style.background = '#F5F3FF';
                indicator.style.background = '#4F46E5';
                if (dot) { dot.style.right = '3px'; dot.style.left = 'auto'; }
            } else {
                card.style.borderColor = '#E5E7EB';
                card.style.background = '#fff';
                indicator.style.background = '#CBD5E1';
                if (dot) { dot.style.left = '3px'; dot.style.right = 'auto'; }
            }
        }

        async function toggleFeature(key) {
            featureState[key] = !featureState[key];
            updateToggleCard(key);
            
            try {
                const { data: existing } = await sb.from('system_settings')
                    .select('id')
                    .eq('key', 'feature_visibility')
                    .maybeSingle();
                
                if (existing) {
                    await sb.from('system_settings')
                        .update({ value: featureState, updated_at: new Date().toISOString() })
                        .eq('key', 'feature_visibility');
                } else {
                    await sb.from('system_settings')
                        .insert({ key: 'feature_visibility', value: featureState, description: 'å“¡å·¥å¯è¦‹åŠŸèƒ½è¨­å®š' });
                }
                
                const el = document.getElementById('featureSaveStatus');
                el.style.display = 'block';
                el.textContent = featureState[key] ? 'âœ… å·²é–‹å•Ÿ' : 'â›” å·²é—œé–‰';
                el.style.color = featureState[key] ? '#059669' : '#DC2626';
                setTimeout(() => el.style.display = 'none', 1500);
            } catch(e) {
                console.error('å„²å­˜å¤±æ•—', e);
                showToast('âŒ å„²å­˜å¤±æ•—');
            }
        }

        // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
        async function checkAdminPermission() {
            const statusEl = document.getElementById('permissionStatus');
            const loadingPage = document.getElementById('loadingPage');
            
            try {
                const initialized = await initializeLiff();
                
                // [BUG FIX] ç„¡è«–æˆåŠŸå¤±æ•—éƒ½è¦éš±è— loading ç•«é¢
                if (loadingPage) loadingPage.style.display = 'none';
                
                if (!initialized) {
                    showStatus(statusEl, 'error', 'âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹å¾ LINE é–‹å•Ÿ');
                    return;
                }

                console.log('ğŸ”‘ LINE User ID:', liffProfile?.userId);

                const { data, error } = await sb.from('employees')
                    .select('*')
                    .eq('line_user_id', liffProfile.userId)
                    .eq('role', 'admin')
                    .eq('is_active', true)
                    .maybeSingle();

                if (error) {
                    console.error('âŒ è³‡æ–™åº«æŸ¥è©¢éŒ¯èª¤:', error);
                    showStatus(statusEl, 'error', 'âŒ è³‡æ–™åº«æŸ¥è©¢å¤±æ•—: ' + error.message);
                    return;
                }
                
                if (!data) {
                    console.log('âŒ æ‰¾ä¸åˆ°ç®¡ç†å“¡è³‡æ–™ï¼ŒLINE ID:', liffProfile?.userId);
                    showStatus(statusEl, 'error', 'âŒ æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™<br><small style="opacity:0.7">LINE ID: ' + (liffProfile?.userId || 'æœªçŸ¥') + '</small>');
                    setTimeout(() => { window.location.href = 'index.html'; }, 5000);
                    return;
                }

                currentAdminEmployee = data;
                updateAdminInfo(data);
                
                // è¼‰å…¥ç³»çµ±è¨­å®šï¼ˆåœ°é»ç­‰ï¼‰
                await loadSettings();
                
                showStatus(statusEl, 'success', 'âœ… æ¬Šé™é©—è­‰é€šé');
                setTimeout(() => { 
                    showPage('adminHomePage');
                    document.getElementById('bottomNav').style.display = 'flex';
                }, 800);

            } catch (err) {
                console.error('æ¬Šé™æª¢æŸ¥ç•°å¸¸:', err);
                if (loadingPage) loadingPage.style.display = 'none';
                showStatus(statusEl, 'error', 'âŒ æ¬Šé™æª¢æŸ¥å¤±æ•—: ' + (typeof friendlyError === 'function' ? friendlyError(err) : err.message));
            }
        }

        // [BUG FIX] ä¿®æ­£ç®¡ç†å“¡é ­åƒé¡¯ç¤º â€” æœ‰åœ–ç‰‡æ™‚ä¸æ‡‰é¡¯ç¤º emoji
        function updateAdminInfo(data) {
            document.getElementById('adminName').textContent = data.name;
            document.getElementById('adminDept').textContent = `${data.department || 'ç³»çµ±ç®¡ç†'} Â· ç®¡ç†å“¡`;
            document.getElementById('adminId').textContent = `ID: ${data.employee_number}`;
            
            const avatar = document.getElementById('adminAvatar');
            if (liffProfile?.pictureUrl) {
                avatar.style.backgroundImage = `url(${liffProfile.pictureUrl})`;
                avatar.style.backgroundSize = 'cover';
                avatar.textContent = '';
            } else {
                avatar.textContent = 'ğŸ‘‘';
            }
        }

        // è¼‰å…¥çé‡‘çµ±è¨ˆ
        async function loadAllBonusStats() {
            const yearEl = document.getElementById('bonusYear');
            const listEl = document.getElementById('bonusList');
            if (!yearEl || !listEl) return;

            const year = parseInt(yearEl.value);
            listEl.innerHTML = '<p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>';

            try {
                const { data, error } = await sb.rpc('get_all_year_end_stats', { p_year: year });
                if (error) throw error;
                
                allBonusStats = data || [];
                
                const eligible = allBonusStats.filter(emp => emp.bonus_status === 'ç¬¦åˆè³‡æ ¼');
                const ineligible = allBonusStats.filter(emp => emp.bonus_status !== 'ç¬¦åˆè³‡æ ¼');
                const totalBudget = allBonusStats.reduce((sum, emp) => sum + (emp.suggested_bonus || 0), 0);
                
                document.getElementById('eligibleCount').textContent = eligible.length;
                document.getElementById('ineligibleCount').textContent = ineligible.length;
                document.getElementById('totalBudget').textContent = `$${totalBudget.toLocaleString()}`;
                document.getElementById('avgBonus').textContent = eligible.length > 0 
                    ? `$${Math.round(totalBudget / eligible.length).toLocaleString()}` : '$0';

                let html = '';
                allBonusStats.forEach(emp => {
                    const isEligible = emp.bonus_status === 'ç¬¦åˆè³‡æ ¼';
                    html += `
                        <div class="attendance-item ${isEligible ? 'normal' : 'late'}">
                            <div class="date">
                                <span>${emp.name} (${emp.employee_number})</span>
                                <span class="badge ${isEligible ? 'badge-success' : 'badge-warning'}">
                                    ${isEligible ? 'âœ… ç¬¦åˆ' : 'âŒ æœªç¬¦åˆ'}
                                </span>
                            </div>
                            <div class="details">
                                <span>${emp.department || '-'}</span>
                                <span style="font-weight:bold;">$${(emp.suggested_bonus || 0).toLocaleString()}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                ${emp.bonus_status} Â· å‡ºå‹¤ ${emp.attendance_rate}% Â· é²åˆ° ${emp.late_count}æ¬¡
                            </div>
                            <button class="btn-danger" onclick="adjustBonus('${emp.employee_id}', '${emp.name}', ${emp.suggested_bonus || 0})" style="margin-top:8px;font-size:12px;padding:6px 12px;">
                                âœï¸ èª¿æ•´çé‡‘
                            </button>
                        </div>
                    `;
                });
                
                listEl.innerHTML = html || '<p style="text-align:center;color:#999;">ç„¡è³‡æ–™</p>';

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // èª¿æ•´çé‡‘
        function adjustBonus(employeeId, employeeName, currentBonus) {
            const newBonus = prompt(`èª¿æ•´ ${employeeName} çš„çé‡‘é‡‘é¡\nç›®å‰: $${currentBonus.toLocaleString()}\nè«‹è¼¸å…¥æ–°é‡‘é¡ï¼š`);
            
            if (newBonus === null) return;
            
            const bonusAmount = parseInt(newBonus);
            if (isNaN(bonusAmount) || bonusAmount < 0) {
                showToast('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
                return;
            }
            
            showToast(`âœ… ${employeeName} çš„çé‡‘å·²èª¿æ•´ç‚º $${bonusAmount.toLocaleString()}`);
            loadAllBonusStats();
        }

        // å“¡å·¥ Modal
        function showAddEmployeeModal() {
            document.getElementById('addEmployeeModal').style.display = 'flex';
            document.getElementById('newEmployeeHireDate').value = new Date().toISOString().split('T')[0];
        }

        function closeAddEmployeeModal() {
            document.getElementById('addEmployeeModal').style.display = 'none';
            document.getElementById('addEmployeeForm').reset();
        }

        // æ–°å¢å“¡å·¥
        document.getElementById('addEmployeeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const employeeData = {
                name: document.getElementById('newEmployeeName').value.trim(),
                employee_number: document.getElementById('newEmployeeNumber').value.trim(),
                department: document.getElementById('newEmployeeDepartment').value,
                position: document.getElementById('newEmployeePosition').value.trim() || 'å“¡å·¥',
                id_card_last_4: document.getElementById('newEmployeeCode').value.trim(),
                hire_date: document.getElementById('newEmployeeHireDate').value,
                role: document.getElementById('newEmployeeRole').value,
                is_active: true,
                company_id: '8a669e2c-7521-43e9-9300-5c004c57e9db',
                created_at: new Date().toISOString()
            };

            if (!employeeData.name || !employeeData.employee_number || !employeeData.id_card_last_4) {
                showToast('âš ï¸ è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }
            
            try {
                const { data, error } = await sb.from('employees').insert([employeeData]);
                if (error) throw error;
                
                showToast('âœ… å“¡å·¥æ–°å¢æˆåŠŸï¼');
                closeAddEmployeeModal();
                loadEmployeeList();
            } catch (err) {
                console.error('æ–°å¢å“¡å·¥å¤±æ•—:', err);
                showToast('âŒ æ–°å¢å¤±æ•—: ' + friendlyError(err));
            }
        });

        // QR Code
        function showJoinQRCode() {
            const modal = document.getElementById('qrModal');
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';
            
            const liffUrl = `https://liff.line.me/${CONFIG.LIFF_ID}?type=bind&company=HR_SYSTEM_001`;
            
            new QRCode(qrcodeDiv, {
                text: liffUrl, width: 200, height: 200,
                colorDark: "#1f2937", colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            modal.style.display = 'flex';
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰ Modal
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // è¼‰å…¥å“¡å·¥åˆ—è¡¨
        async function loadEmployeeList() {
            const listEl = document.getElementById('employeeList');
            if (!listEl) return;

            try {
                const { data, error } = await sb.from('employees')
                    .select('*')
                    .eq('is_active', true)
                    .order('department', { ascending: true });

                if (error) throw error;

                const roleNames = { 'admin': 'ç®¡ç†å“¡', 'manager': 'ä¸»ç®¡', 'user': 'ä¸€èˆ¬å“¡å·¥' };

                let html = '';
                data.forEach(emp => {
                    html += `
                        <div class="attendance-item">
                            <div class="date">
                                <div style="display:flex; align-items:center; flex-wrap:wrap; gap:4px;">
                                    <span>${emp.name} - ${emp.employee_number}</span>
                                    <span class="role-${emp.role || 'user'}" style="
                                        padding: 3px 10px; border-radius: 15px; font-size: 11px;
                                        display: inline-block; font-weight: bold;">
                                        ${roleNames[emp.role] || 'æœªçŸ¥'}
                                    </span>
                                </div>
                            </div>
                            <div class="details">
                                <span>${emp.department || '-'} Â· ${emp.position || '-'}</span>
                                <span style="font-size:12px;">é©—è­‰ç¢¼: ${emp.id_card_last_4 || 'æœªè¨­å®š'}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                åˆ°è·: ${emp.hire_date || 'æœªè¨­å®š'} Â· ${emp.line_user_id ? 'âœ… å·²ç¶å®š' : 'â³ æœªç¶å®š'}
                            </div>
                            ${emp.line_user_id ? `
                                <div style="margin-top:8px;display:flex;gap:8px;">
                                    <button class="btn-success-sm" onclick="updateEmployeeRoleAdmin('${emp.id}', 'admin', '${emp.name}')" style="flex:1;padding:8px 12px;border:none;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;${emp.role === 'admin' ? 'opacity:0.4;pointer-events:none;' : ''}">
                                        è¨­ç‚ºç®¡ç†å“¡
                                    </button>
                                    <button class="btn-danger" onclick="updateEmployeeRoleAdmin('${emp.id}', 'user', '${emp.name}')" style="flex:1;padding:8px 12px;border-radius:10px;font-size:12px;font-weight:700;${emp.role !== 'admin' ? 'opacity:0.4;pointer-events:none;' : ''}">
                                        å–æ¶ˆç®¡ç†å“¡
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                listEl.innerHTML = html || '<p style="text-align:center;color:#999;">ç„¡å“¡å·¥è³‡æ–™</p>';

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // [BUG FIX] æ•´åˆè§’è‰²æ›´æ–°å‡½æ•¸ï¼Œé¿å…é‡è¤‡å®šç¾©
        async function updateEmployeeRoleAdmin(employeeId, newRole, employeeName) {
            const roleNames = { 'admin': 'ç®¡ç†å“¡', 'manager': 'ä¸»ç®¡', 'user': 'ä¸€èˆ¬å“¡å·¥' };
            
            try {
                const { error } = await sb.from('employees')
                    .update({ role: newRole })
                    .eq('id', employeeId);
                
                if (error) throw error;
                showToast(`âœ… ${employeeName} â†’ ${roleNames[newRole]}`);
                loadEmployeeList();
            } catch (err) {
                console.error(err);
                showToast('âŒ æ›´æ–°å¤±æ•—: ' + friendlyError(err));
            }
        }

        // æœå°‹å“¡å·¥
        function searchEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            const items = document.querySelectorAll('#employeeList .attendance-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // è«‹å‡å¯©æ ¸
        function switchLeaveTab(status) {
            document.querySelectorAll('#leaveApprovalPage .tab-btn').forEach(btn => {
                btn.className = 'tab-btn inactive';
            });
            event.target.className = 'tab-btn active';
            loadLeaveApprovals(status);
        }

        async function loadLeaveApprovals(status) {
            const listEl = document.getElementById('leaveApprovalList');
            if (!listEl) return;

            try {
                const { data, error } = await sb.from('leave_requests')
                    .select(`*, employees!leave_requests_employee_id_fkey(name, employee_number, department)`)
                    .eq('status', status)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const typeMap = { 'annual': 'ç‰¹ä¼‘', 'sick': 'ç—…å‡', 'personal': 'äº‹å‡', 'compensatory': 'è£œä¼‘' };
                const statusText = { 'pending': 'å¾…å¯©æ ¸', 'approved': 'å·²é€šé', 'rejected': 'å·²æ‹’çµ•' };

                let html = '';
                (data || []).forEach(request => {
                    html += `
                        <div class="attendance-item">
                            <div class="date">
                                <span>${request.employees?.name || 'æœªçŸ¥'} - ${typeMap[request.leave_type] || request.leave_type}</span>
                                <span style="font-size:12px;color:#999;">${request.created_at?.split('T')[0] || ''}</span>
                            </div>
                            <div class="details">
                                <span>${request.start_date} ~ ${request.end_date}</span>
                                <span>${request.employees?.department || '-'}</span>
                            </div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">
                                ${request.reason || 'ç„¡åŸå› '}
                            </div>
                            ${status === 'pending' ? `
                                <div style="margin-top:8px;display:flex;gap:6px;">
                                    <button class="btn-success" onclick="approveLeave('${request.id}', 'approved')" style="flex:1;font-size:12px;padding:8px;border:none;border-radius:8px;cursor:pointer;">
                                        âœ… é€šé
                                    </button>
                                    <button class="btn-danger" onclick="approveLeave('${request.id}', 'rejected')" style="flex:1;font-size:12px;padding:8px;">
                                        âŒ æ‹’çµ•
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                listEl.innerHTML = html || `<p style="text-align:center;color:#999;">ç„¡${statusText[status] || ''}çš„è«‹å‡ç”³è«‹</p>`;

            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<p style="text-align:center;color:#ef4444;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        async function approveLeave(requestId, newStatus) {
            try {
                const { error } = await sb.from('leave_requests')
                    .update({ 
                        status: newStatus,
                        approver_id: currentAdminEmployee.id,
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', requestId);

                if (error) throw error;

                showToast(`âœ… è«‹å‡ç”³è«‹å·²${newStatus === 'approved' ? 'é€šé' : 'æ‹’çµ•'}`);
                loadLeaveApprovals('pending');

            } catch (err) {
                console.error(err);
                showToast('âŒ å¯©æ ¸å¤±æ•—: ' + friendlyError(err));
            }
        }

        // ===== â‘£ ä¼‘å‡ç®¡ç†æœˆè¡¨ =====
        let lcYear, lcMonth;
        (function() { const n = new Date(); lcYear = n.getFullYear(); lcMonth = n.getMonth(); })();

        function changeLeaveCal(d) {
            lcMonth += d;
            if (lcMonth < 0) { lcMonth = 11; lcYear--; }
            if (lcMonth > 11) { lcMonth = 0; lcYear++; }
            loadLeaveCal();
        }

        async function loadLeaveCal() {
            document.getElementById('lcMonthLabel').textContent = `${lcYear}å¹´ ${lcMonth + 1}æœˆ`;
            const dim = new Date(lcYear, lcMonth + 1, 0).getDate();
            const ms = `${lcYear}-${String(lcMonth + 1).padStart(2, '0')}-01`;
            const me = `${lcYear}-${String(lcMonth + 1).padStart(2, '0')}-${dim}`;

            let employees = [], leaves = [];
            try {
                const { data: emps } = await sb.from('employees').select('id, name, department').eq('status', 'active').order('department').order('name');
                employees = emps || [];
                const { data: lvs } = await sb.from('leave_requests').select('employee_id, start_date, end_date, leave_type, status')
                    .in('status', ['approved', 'pending'])
                    .or(`start_date.lte.${me},end_date.gte.${ms}`);
                leaves = lvs || [];
            } catch (e) { console.error(e); }

            // Build date headers
            const wd = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            let headHtml = '<tr><th style="position:sticky;left:0;background:#fff;z-index:2;padding:6px 8px;min-width:70px;text-align:left;border-bottom:2px solid #E5E7EB;">å§“å</th>';
            for (let d = 1; d <= dim; d++) {
                const dt = new Date(lcYear, lcMonth, d);
                const isWeekend = dt.getDay() === 0 || dt.getDay() === 6;
                const bgc = isWeekend ? '#F1F5F9' : '#fff';
                headHtml += `<th style="padding:4px 2px;min-width:28px;text-align:center;border-bottom:2px solid #E5E7EB;background:${bgc};font-size:10px;">
                    <div>${d}</div><div style="color:#94A3B8;font-size:9px;">${wd[dt.getDay()]}</div>
                </th>`;
            }
            headHtml += '</tr>';
            document.getElementById('lcHead').innerHTML = headHtml;

            // Build rows
            const typeColor = { annual: '#DBEAFE', sick: '#FEE2E2', personal: '#FEF3C7', compensatory: '#E0E7FF' };
            const typeEmoji = { annual: 'ğŸ–', sick: 'ğŸ¤’', personal: 'ğŸ“‹', compensatory: 'ğŸ’¤' };
            let totalLeaves = 0;
            const todayStr = new Date().toISOString().split('T')[0];
            let todayAvail = employees.length;

            let bodyHtml = '';
            employees.forEach(emp => {
                const empLeaves = leaves.filter(l => l.employee_id === emp.id);
                bodyHtml += `<tr><td style="position:sticky;left:0;background:#fff;z-index:1;padding:6px 8px;font-weight:700;font-size:12px;white-space:nowrap;border-bottom:1px solid #F1F5F9;">${emp.name}</td>`;
                
                for (let d = 1; d <= dim; d++) {
                    const ds = `${lcYear}-${String(lcMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const dt = new Date(lcYear, lcMonth, d);
                    const isWeekend = dt.getDay() === 0 || dt.getDay() === 6;

                    // Find leave for this day
                    const lv = empLeaves.find(l => ds >= l.start_date && ds <= (l.end_date || l.start_date));

                    if (lv) {
                        totalLeaves++;
                        if (ds === todayStr) todayAvail--;
                        const bg = typeColor[lv.leave_type] || '#F1F5F9';
                        const emoji = typeEmoji[lv.leave_type] || 'ğŸ“';
                        const pending = lv.status === 'pending' ? 'opacity:0.5;' : '';
                        bodyHtml += `<td style="text-align:center;background:${bg};border-bottom:1px solid #F1F5F9;${pending}font-size:10px;cursor:default;" title="${emp.name} ${lv.leave_type}${lv.status === 'pending' ? ' (å¾…å¯©)' : ''}">${emoji}</td>`;
                    } else if (isWeekend) {
                        bodyHtml += `<td style="background:#F8FAFC;border-bottom:1px solid #F1F5F9;"></td>`;
                    } else {
                        bodyHtml += `<td style="border-bottom:1px solid #F1F5F9;"></td>`;
                    }
                }
                bodyHtml += '</tr>';
            });

            document.getElementById('lcBody').innerHTML = bodyHtml;
            document.getElementById('lcTotal').textContent = totalLeaves;
            document.getElementById('lcAvail').textContent = Math.max(0, todayAvail);
        }

        // ===== â‘¤ æ’ç­ç®¡ç† =====
        let smWeekStart;
        (function() {
            const n = new Date();
            const dow = n.getDay();
            smWeekStart = new Date(n);
            smWeekStart.setDate(n.getDate() - dow + 1); // Monday
            smWeekStart.setHours(0, 0, 0, 0);
        })();

        let smEmployees = [];
        let smScheduleData = {}; // { 'empId_YYYY-MM-DD': 'morning' | 'afternoon' | 'night' | 'off' | null }
        const SHIFT_TYPES = [null, 'morning', 'afternoon', 'night', 'off'];
        const SHIFT_DISPLAY = {
            null: { label: 'â¬œ', bg: '#F8FAFC', color: '#94A3B8' },
            morning: { label: 'â˜€ï¸', bg: '#DBEAFE', color: '#1E40AF' },
            afternoon: { label: 'ğŸŒ¤ï¸', bg: '#FEF3C7', color: '#92400E' },
            night: { label: 'ğŸŒ™', bg: '#EDE9FE', color: '#6D28D9' },
            off: { label: 'ğŸ–ï¸', bg: '#ECFDF5', color: '#059669' }
        };

        function changeShiftWeek(d) {
            smWeekStart.setDate(smWeekStart.getDate() + d * 7);
            loadShiftMgr();
        }

        function getWeekDates() {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(smWeekStart);
                d.setDate(d.getDate() + i);
                dates.push(d);
            }
            return dates;
        }

        async function loadShiftMgr() {
            const dates = getWeekDates();
            const startStr = dates[0].toISOString().split('T')[0];
            const endStr = dates[6].toISOString().split('T')[0];
            document.getElementById('smWeekLabel').textContent = `${startStr} ~ ${endStr}`;

            try {
                const { data: emps } = await sb.from('employees').select('id, name, department').eq('status', 'active').order('name');
                smEmployees = emps || [];
                
                const { data: scheds } = await sb.from('schedules').select('employee_id, date, shift_type_id, shift_types(name, code)')
                    .gte('date', startStr).lte('date', endStr);
                
                smScheduleData = {};
                (scheds || []).forEach(s => {
                    const code = s.shift_types?.code || s.shift_types?.name || 'morning';
                    smScheduleData[`${s.employee_id}_${s.date}`] = code;
                });
            } catch (e) { console.error(e); }

            renderShiftTable();
        }

        function renderShiftTable() {
            const dates = getWeekDates();
            const wd = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

            let headHtml = '<tr><th style="position:sticky;left:0;background:#fff;z-index:2;padding:8px;min-width:70px;text-align:left;border-bottom:2px solid #E5E7EB;">å§“å</th>';
            dates.forEach(d => {
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                headHtml += `<th style="padding:6px 4px;min-width:46px;text-align:center;border-bottom:2px solid #E5E7EB;background:${isWeekend ? '#F1F5F9' : '#fff'};">
                    <div style="font-size:12px;">${d.getDate()}</div>
                    <div style="font-size:10px;color:#94A3B8;">é€±${wd[d.getDay()]}</div>
                </th>`;
            });
            headHtml += '</tr>';
            document.getElementById('smHead').innerHTML = headHtml;

            let bodyHtml = '';
            smEmployees.forEach(emp => {
                bodyHtml += `<tr><td style="position:sticky;left:0;background:#fff;z-index:1;padding:8px;font-weight:700;font-size:12px;white-space:nowrap;border-bottom:1px solid #F1F5F9;">${emp.name}</td>`;
                
                dates.forEach(d => {
                    const ds = d.toISOString().split('T')[0];
                    const key = `${emp.id}_${ds}`;
                    const shift = smScheduleData[key] || null;
                    const disp = SHIFT_DISPLAY[shift] || SHIFT_DISPLAY[null];
                    
                    bodyHtml += `<td onclick="cycleShift('${key}')" style="text-align:center;padding:8px 4px;cursor:pointer;border-bottom:1px solid #F1F5F9;background:${disp.bg};font-size:16px;transition:all 0.15s;user-select:none;" title="${emp.name} ${ds}">${disp.label}</td>`;
                });
                bodyHtml += '</tr>';
            });
            document.getElementById('smBody').innerHTML = bodyHtml;
        }

        function cycleShift(key) {
            const current = smScheduleData[key] || null;
            const idx = SHIFT_TYPES.indexOf(current);
            const next = SHIFT_TYPES[(idx + 1) % SHIFT_TYPES.length];
            smScheduleData[key] = next;
            renderShiftTable();
        }

        async function saveSchedule() {
            const statusEl = document.getElementById('smSaveStatus');
            statusEl.style.display = 'block';
            statusEl.style.color = '#F59E0B';
            statusEl.textContent = 'â³ å„²å­˜ä¸­...';

            try {
                // Get shift_types mapping
                const { data: shiftTypes } = await sb.from('shift_types').select('id, code, name');
                const stMap = {};
                (shiftTypes || []).forEach(st => { stMap[st.code || st.name] = st.id; });

                const upserts = [];
                for (const [key, shift] of Object.entries(smScheduleData)) {
                    if (!shift) continue;
                    const [empId, date] = key.split('_');
                    const stId = stMap[shift];
                    if (!stId) continue;
                    upserts.push({ employee_id: empId, date: date, shift_type_id: stId });
                }

                if (upserts.length > 0) {
                    const { error } = await sb.from('schedules').upsert(upserts, { onConflict: 'employee_id,date' });
                    if (error) throw error;
                }

                statusEl.style.color = '#059669';
                statusEl.textContent = `âœ… å·²å„²å­˜ ${upserts.length} ç­†æ’ç­`;
                setTimeout(() => { statusEl.style.display = 'none'; }, 2500);
            } catch (e) {
                console.error(e);
                statusEl.style.color = '#DC2626';
                statusEl.textContent = 'âŒ å„²å­˜å¤±æ•—: ' + e.message;
            }
        }

        async function copyLastWeek() {
            if (!confirm('ç¢ºå®šè¦è¤‡è£½ä¸Šé€±æ’ç­åˆ°æœ¬é€±ï¼Ÿ\nï¼ˆå·²æœ‰æ’ç­ä¸æœƒè¢«è¦†è“‹ï¼‰')) return;
            
            const dates = getWeekDates();
            const lastWeekDates = dates.map(d => {
                const ld = new Date(d);
                ld.setDate(ld.getDate() - 7);
                return ld;
            });

            try {
                const startStr = lastWeekDates[0].toISOString().split('T')[0];
                const endStr = lastWeekDates[6].toISOString().split('T')[0];
                const { data: lastScheds } = await sb.from('schedules').select('employee_id, date, shift_type_id, shift_types(code, name)')
                    .gte('date', startStr).lte('date', endStr);

                let copied = 0;
                (lastScheds || []).forEach(s => {
                    const oldDate = new Date(s.date + 'T00:00:00');
                    const newDate = new Date(oldDate);
                    newDate.setDate(newDate.getDate() + 7);
                    const newDs = newDate.toISOString().split('T')[0];
                    const key = `${s.employee_id}_${newDs}`;
                    
                    if (!smScheduleData[key]) {
                        const code = s.shift_types?.code || s.shift_types?.name || 'morning';
                        smScheduleData[key] = code;
                        copied++;
                    }
                });

                renderShiftTable();
                showToast(`ğŸ“‹ å·²è¤‡è£½ä¸Šé€± ${copied} ç­†æ’ç­`);
            } catch (e) {
                console.error(e);
                showToast('âŒ è¤‡è£½å¤±æ•—');
            }
        }

        // åŒ¯å‡ºå ±è¡¨
        function exportReport(type) {
            const names = { 'attendance': 'å‡ºå‹¤', 'leave': 'è«‹å‡', 'bonus': 'çé‡‘', 'lunch': 'ä¾¿ç•¶' };
            showToast(`ğŸ“Š æ­£åœ¨æº–å‚™${names[type] || ''}å ±è¡¨...`);
            setTimeout(() => { showToast('â³ å ±è¡¨åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…'); }, 1000);
        }

        // é é¢è¼‰å…¥
        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') {
                console.error('common.js æœªæ­£ç¢ºè¼‰å…¥');
                return;
            }
            checkAdminPermission();
        });
    </script>
</body>
</html>
