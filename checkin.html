<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“ æ‰“å¡ - å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <div id="checkInPage" class="page active">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'" style="width:auto;margin-bottom:10px;margin-top:0;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2 id="checkInTitle" style="text-align:center;font-size:18px;font-weight:800;color:#0F172A;">ğŸ“ ä¸Šç­æ‰“å¡</h2>
                <div id="checkInStatus" class="status-box show info" style="margin-top:12px;">æº–å‚™é–‹å•Ÿç›¸æ©Ÿ...</div>
                
                <!-- ç­åˆ¥è³‡è¨Š -->
                <div id="shiftInfo" style="display:flex;justify-content:space-between;align-items:center;background:#DBEAFE;border-radius:12px;padding:14px;margin-bottom:16px;">
                    <div>
                        <div style="font-size:12px;color:#1E40AF;font-weight:600;">ä»Šæ—¥ç­åˆ¥ï¼šæ—©ç­</div>
                        <div style="font-size:13px;color:#1E40AF;margin-top:2px;">08:00 - 17:00</div>
                    </div>
                    <div id="currentTime" style="font-size:24px;font-weight:900;color:#1E40AF;">--:--</div>
                </div>

                <div class="camera-container" id="cameraContainer">
                    <video id="video" autoplay playsinline muted></video>
                    <canvas id="canvas" class="hidden"></canvas>
                    <div class="camera-overlay" id="cameraOverlay" style="display:none;">
                        <span id="overlayLocation">ğŸ“ å®šä½ä¸­...</span>
                        <span id="overlayStatus" style="color:#10B981;">-</span>
                    </div>
                </div>

                <button class="btn btn-primary" id="captureBtn" onclick="captureAndCheckIn()" disabled style="font-size:16px;padding:16px;border-radius:16px;">ğŸ“¸ æ‹ç…§ä¸¦æ‰“å¡</button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªåˆ— -->
    <nav class="bottom-nav" style="display:none;">
        <a class="nav-item" onclick="window.location.href='index.html'">
            <span class="nav-icon">ğŸ </span><span class="nav-label">é¦–é </span>
        </a>
        <a class="nav-item" onclick="window.location.href='schedule.html'">
            <span class="nav-icon">ğŸ“…</span><span class="nav-label">ç­è¡¨</span>
        </a>
        <a class="nav-item active">
            <span class="nav-icon">ğŸ“</span><span class="nav-label">æ‰“å¡</span>
        </a>
        <a class="nav-item" onclick="window.location.href='salary.html'">
            <span class="nav-icon">ğŸ’°</span><span class="nav-label">è–ªè³‡</span>
        </a>
        <a class="nav-item" onclick="window.location.href='admin.html'">
            <span class="nav-icon">âš™ï¸</span><span class="nav-label">ç®¡ç†</span>
        </a>
    </nav>

    <script src="common.js"></script>
    <script>
        let currentCheckInType = 'in';

        // æ›´æ–°æ™‚é˜
        function updateClock() {
            const now = new Date();
            const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            const el = document.getElementById('currentTime');
            if (el) el.textContent = timeStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        async function captureAndCheckIn() {
            if (!currentEmployee) { showToast('âŒ å“¡å·¥è³‡æ–™æœªè¼‰å…¥'); return; }

            const btn = document.getElementById('captureBtn');
            const statusBox = document.getElementById('checkInStatus');
            btn.disabled = true; btn.textContent = 'è™•ç†ä¸­...';
            
            try {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0);
                const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.7));

                showStatus(statusBox, 'info', 'â˜ï¸ ä¸Šå‚³ä¸­...');
                const fileName = `${currentEmployee.employee_number}_${Date.now()}.jpg`; 
                const { error: uploadError } = await sb.storage.from(CONFIG.BUCKET).upload(fileName, blob);
                if (uploadError) throw uploadError;

                const { data: urlData } = sb.storage.from(CONFIG.BUCKET).getPublicUrl(fileName);
                const publicUrl = urlData?.publicUrl || urlData?.publicURL;
                if (!publicUrl) throw new Error('ç„¡æ³•å–å¾—ç…§ç‰‡ç¶²å€');

                showStatus(statusBox, 'info', 'ğŸ“ å®šä½ä¸­...');
                let loc = cachedLocation || await getGPS();

                const { data: rpcData, error: rpcError } = await sb.rpc('quick_check_in', {
                    p_line_user_id: liffProfile.userId,
                    p_latitude: loc.latitude, p_longitude: loc.longitude,
                    p_photo_url: publicUrl, p_device_id: navigator.userAgent
                });

                if (rpcError) throw rpcError;
                if (!rpcData.success) throw new Error(rpcData.error);

                if (rpcData.location_name) localStorage.setItem('last_location', rpcData.location_name);

                const typeText = currentCheckInType === 'in' ? 'ä¸Šç­' : 'ä¸‹ç­';
                showToast(`âœ… ${typeText}æˆåŠŸï¼@${rpcData.location_name || 'å…¬å¸'}`);
                
                // ä¸Šç­æ‰“å¡ä¸”10é»å‰ â†’ å½ˆå‡ºä¾¿ç•¶è¨‚è³¼
                if (currentCheckInType === 'in' && new Date().getHours() < 10) {
                    showLunchPopup();
                } else {
                    setTimeout(() => { window.location.href = 'index.html'; }, 1500);
                }

            } catch (err) {
                console.error(err);
                showStatus(statusBox, 'error', `âŒ å¤±æ•—: ${friendlyError(err)}`);
                btn.disabled = false; btn.textContent = 'ğŸ“¸ é‡è©¦';
            }
        }

        async function openCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                const video = document.getElementById('video');
                video.srcObject = stream;
                videoStream = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    document.getElementById('cameraContainer').classList.add('show');
                    document.getElementById('captureBtn').disabled = false;
                    document.getElementById('checkInStatus').textContent = 'âœ… ç›¸æ©Ÿå°±ç·’';
                    
                    // é¡¯ç¤º overlay
                    const overlay = document.getElementById('cameraOverlay');
                    if (overlay) overlay.style.display = 'flex';
                    
                    const lastLoc = localStorage.getItem('last_location');
                    if (lastLoc) {
                        document.getElementById('overlayLocation').textContent = `ğŸ“ ${lastLoc}`;
                    }
                };
            } catch(e) { 
                console.error('ç›¸æ©ŸéŒ¯èª¤', e);
                let msg = 'ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ';
                if (e.name === 'NotAllowedError') msg = 'è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™';
                if (e.name === 'NotFoundError') msg = 'æ‰¾ä¸åˆ°ç›¸æ©Ÿè£ç½®';
                showStatus(document.getElementById('checkInStatus'), 'error', `âŒ ${msg}`);
            }
        }

        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') return;
            
            const urlParams = new URLSearchParams(window.location.search);
            currentCheckInType = urlParams.get('type') || 'in';
            
            const titleEl = document.getElementById('checkInTitle');
            if (titleEl) titleEl.textContent = currentCheckInType === 'in' ? 'ğŸ“ ä¸Šç­æ‰“å¡' : 'ğŸ‘‹ ä¸‹ç­æ‰“å¡';

            const initialized = await initializeLiff();
            if (initialized) {
                const isLoggedIn = await checkUserStatus();
                if (isLoggedIn) {
                    initBottomNav();
                    openCamera();
                } else {
                    window.location.href = 'index.html';
                }
            }
        });

        window.addEventListener('beforeunload', () => {
            if (videoStream) videoStream.getTracks().forEach(t => t.stop());
        });

        // ===== ä¾¿ç•¶è¨‚è³¼å½ˆçª— =====
        function showLunchPopup() {
            const overlay = document.createElement('div');
            overlay.id = 'lunchOverlay';
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.3s;';
            overlay.innerHTML = `
                <div style="background:#fff;border-radius:20px;padding:24px;width:100%;max-width:340px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <div style="text-align:center;margin-bottom:16px;">
                        <div style="font-size:40px;margin-bottom:8px;">ğŸ±</div>
                        <h3 style="font-size:16px;font-weight:800;color:#0F172A;">ä»Šæ—¥ä¾¿ç•¶è¨‚è³¼</h3>
                        <p style="font-size:12px;color:#94A3B8;margin-top:4px;">è«‹é¸æ“‡ä»Šæ—¥åˆé¤</p>
                    </div>
                    
                    <div id="lunchOptions" style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px;">
                        <div class="lunch-opt" onclick="selectLunch('regular')" style="display:flex;align-items:center;gap:12px;padding:14px;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                            <span style="font-size:28px;">ğŸ–</span>
                            <div style="flex:1;"><b style="font-size:14px;">è‘·é£Ÿä¾¿ç•¶</b><br><span style="font-size:11px;color:#94A3B8;">ä»Šæ—¥ä¸»èœç”±é¤å»³å®‰æ’</span></div>
                            <div id="checkRegular" style="width:22px;height:22px;border:2px solid #CBD5E1;border-radius:50%;transition:all 0.2s;"></div>
                        </div>
                        <div class="lunch-opt" onclick="selectLunch('vegetarian')" style="display:flex;align-items:center;gap:12px;padding:14px;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                            <span style="font-size:28px;">ğŸ¥—</span>
                            <div style="flex:1;"><b style="font-size:14px;">ç´ é£Ÿä¾¿ç•¶</b><br><span style="font-size:11px;color:#94A3B8;">è”¬é£Ÿæ–™ç†</span></div>
                            <div id="checkVeg" style="width:22px;height:22px;border:2px solid #CBD5E1;border-radius:50%;transition:all 0.2s;"></div>
                        </div>
                        <div class="lunch-opt" onclick="selectLunch('none')" style="display:flex;align-items:center;gap:12px;padding:14px;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                            <span style="font-size:28px;">ğŸ’°</span>
                            <div style="flex:1;"><b style="font-size:14px;">ä¸è¨‚è³¼</b><br><span style="font-size:11px;color:#059669;">è£œåŠ© NT$ 50</span></div>
                            <div id="checkNone" style="width:22px;height:22px;border:2px solid #CBD5E1;border-radius:50%;transition:all 0.2s;"></div>
                        </div>
                    </div>
                    
                    <button id="lunchConfirmBtn" onclick="confirmLunch()" disabled style="width:100%;padding:14px;border:none;border-radius:12px;background:#CBD5E1;color:#fff;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s;">
                        è«‹å…ˆé¸æ“‡
                    </button>
                    <button onclick="skipLunch()" style="width:100%;padding:10px;border:none;background:transparent;color:#94A3B8;font-size:12px;cursor:pointer;margin-top:8px;">
                        ç¨å¾Œå†æ±ºå®š
                    </button>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        let selectedLunch = null;
        function selectLunch(type) {
            selectedLunch = type;
            // é‡è¨­æ‰€æœ‰é¸é …
            document.querySelectorAll('.lunch-opt').forEach(opt => {
                opt.style.borderColor = '#E5E7EB';
                opt.style.background = '#fff';
            });
            ['checkRegular','checkVeg','checkNone'].forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.style.borderColor = '#CBD5E1'; el.style.background = 'transparent'; el.innerHTML = ''; }
            });
            
            // æ¨™è¨˜é¸ä¸­
            const opts = document.querySelectorAll('.lunch-opt');
            const idx = { regular: 0, vegetarian: 1, none: 2 }[type];
            if (opts[idx]) { opts[idx].style.borderColor = '#4F46E5'; opts[idx].style.background = '#F5F3FF'; }
            
            const checkId = { regular: 'checkRegular', vegetarian: 'checkVeg', none: 'checkNone' }[type];
            const checkEl = document.getElementById(checkId);
            if (checkEl) { checkEl.style.borderColor = '#4F46E5'; checkEl.style.background = '#4F46E5'; checkEl.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" style="margin:2px;"><path fill="white" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>'; }
            
            const btn = document.getElementById('lunchConfirmBtn');
            btn.disabled = false;
            btn.style.background = 'linear-gradient(135deg,#4F46E5,#7C3AED)';
            const labels = { regular: 'âœ… ç¢ºèªè¨‚è³¼è‘·é£Ÿä¾¿ç•¶', vegetarian: 'âœ… ç¢ºèªè¨‚è³¼ç´ é£Ÿä¾¿ç•¶', none: 'âœ… ç¢ºèªä¸è¨‚è³¼ï¼ˆè£œåŠ© $50ï¼‰' };
            btn.textContent = labels[type];
        }

        async function confirmLunch() {
            if (!selectedLunch) return;
            
            // äºŒæ¬¡ç¢ºèª
            const msgs = {
                regular: 'ç¢ºå®šè¨‚è³¼ã€Œè‘·é£Ÿä¾¿ç•¶ã€ï¼Ÿ',
                vegetarian: 'ç¢ºå®šè¨‚è³¼ã€Œç´ é£Ÿä¾¿ç•¶ã€ï¼Ÿ',
                none: 'ç¢ºå®šä¸è¨‚è³¼ä¾¿ç•¶ï¼Ÿ\nå°‡ç²å¾— NT$ 50 åˆé¤è£œåŠ©'
            };
            if (!confirm(msgs[selectedLunch])) return;
            
            const btn = document.getElementById('lunchConfirmBtn');
            btn.disabled = true; btn.textContent = 'â³ æäº¤ä¸­...';
            
            try {
                if (selectedLunch === 'none') {
                    // å–æ¶ˆè¨‚è³¼ï¼Œè¨˜éŒ„è£œåŠ©
                    if (typeof submitLunchOrder === 'function') {
                        // ä½¿ç”¨ common.js çš„å‡½æ•¸
                    }
                    await sb.from('lunch_orders').upsert({
                        employee_id: currentEmployee.id,
                        order_date: new Date().toISOString().split('T')[0],
                        is_vegetarian: false,
                        status: 'cancelled',
                        notes: 'ä¸è¨‚è³¼ï¼Œè£œåŠ©NT$50'
                    }, { onConflict: 'employee_id,order_date' });
                } else {
                    await sb.from('lunch_orders').upsert({
                        employee_id: currentEmployee.id,
                        order_date: new Date().toISOString().split('T')[0],
                        is_vegetarian: selectedLunch === 'vegetarian',
                        status: 'ordered',
                        notes: ''
                    }, { onConflict: 'employee_id,order_date' });
                }
                
                const emoji = { regular: 'ğŸ–', vegetarian: 'ğŸ¥—', none: 'ğŸ’°' };
                showToast(`${emoji[selectedLunch]} ${selectedLunch === 'none' ? 'å·²å–æ¶ˆè¨‚è³¼ï¼ˆè£œåŠ©$50ï¼‰' : 'ä¾¿ç•¶è¨‚è³¼æˆåŠŸï¼'}`);
            } catch(e) {
                console.error(e);
                showToast('âš ï¸ è¨‚è³¼å¤±æ•—ï¼Œè«‹åˆ°ä¾¿ç•¶è¨‚è³¼é é¢é‡è©¦');
            }
            
            document.getElementById('lunchOverlay')?.remove();
            setTimeout(() => { window.location.href = 'index.html'; }, 1200);
        }

        function skipLunch() {
            document.getElementById('lunchOverlay')?.remove();
            setTimeout(() => { window.location.href = 'index.html'; }, 500);
        }
    </script>
</body>
</html>
