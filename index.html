<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¢ å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <!-- ç¶å®šé é¢ -->
        <div id="bindPage" class="page active">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">ğŸ”</span>
                    <h2>å“¡å·¥èº«ä»½ç¶å®š</h2>
                    <p>åˆæ¬¡ä½¿ç”¨è«‹é©—è­‰èº«ä»½</p>
                </div>
                <div class="tabs">
                    <button class="tab-btn active" id="tabIdCard" onclick="switchBindMode('id_card')">èº«ä»½è­‰é©—è­‰</button>
                    <button class="tab-btn inactive" id="tabCode" onclick="switchBindMode('code')">é©—è­‰ç¢¼é©—è­‰</button>
                </div>
                <div class="form-group">
                    <label>å“¡å·¥å·¥è™Ÿ (ID) *</label>
                    <input type="text" id="bindEmpId" placeholder="ä¾‹å¦‚ï¼šEMP001" autocomplete="off">
                </div>
                <div id="modeIdCard" class="form-group">
                    <label>èº«ä»½è­‰å¾Œ 4 ç¢¼ *</label>
                    <input type="tel" id="bindIdLast4" maxlength="4" placeholder="ä¾‹å¦‚ï¼š1234" autocomplete="off">
                </div>
                <div id="modeCode" class="form-group hidden">
                    <label>ä¸€æ¬¡æ€§é©—è­‰ç¢¼ *</label>
                    <input type="text" id="bindCode" placeholder="è«‹è¼¸å…¥ HR æä¾›çš„é©—è­‰ç¢¼" autocomplete="off">
                </div>
                <button class="btn btn-primary" onclick="handleBind()">ğŸ”— ç«‹å³ç¶å®š</button>
                <div id="bindStatus" class="status-box"></div>
            </div>
        </div>

        <!-- é¦–é  -->
        <div id="homePage" class="page">
            <!-- ç”¨æˆ¶å¡ç‰‡ -->
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">?</div>
                    <div class="user-details">
                        <h2 id="userName">è¼‰å…¥ä¸­...</h2>
                        <p id="userDept">-</p>
                        <p id="userId" style="font-size: 11px; opacity: 0.7;">ID: -</p>
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
                        <span class="user-status-badge" id="userStatusBadge" style="background:#D1FAE5;color:#065F46;">-</span>
                        <span class="user-status-badge" id="userTypeBadge" style="background:#DBEAFE;color:#1E40AF;display:none;font-size:10px;">æ­£è·</span>
                    </div>
                </div>
                <div class="location-status loading" id="locationStatus">
                    <div class="dot"></div><span>æ­£åœ¨å–å¾—å®šä½...</span>
                </div>
            </div>

            <!-- ä»Šæ—¥è³‡è¨Šå¡ -->
            <div class="card" style="padding:16px;">
                <!-- å…¬å‘Šæ©«å¹… -->
                <div id="announcementBanner" style="display:none;margin-bottom:12px;"></div>

                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <span style="font-size:14px;font-weight:700;color:#0F172A;">ğŸ“‹ ä»Šæ—¥è³‡è¨Š</span>
                    <span id="todayDate" style="font-size:12px;color:#64748B;"></span>
                </div>
                <div class="today-info">
                    <div class="today-info-item" id="todayShiftCard" style="background:#DBEAFE;">
                        <div class="today-info-label" style="color:#1E40AF;">ä»Šæ—¥ç­åˆ¥</div>
                        <div class="today-info-value" id="todayShift" style="color:#1E40AF;">æ—©ç­</div>
                        <div class="today-info-sub" style="color:#1E40AF;">08:00 - 17:00</div>
                    </div>
                    <div class="today-info-item" id="todayCheckinCard" style="background:#D1FAE5;">
                        <div class="today-info-label" style="color:#065F46;">ä¸Šç­æ‰“å¡</div>
                        <div class="today-info-value" id="todayCheckinTime" style="color:#059669;">--:--</div>
                        <div class="today-info-sub" id="todayCheckinStatus" style="color:#065F46;">å°šæœªæ‰“å¡</div>
                    </div>
                    <div class="today-info-item" style="background:#F1F5F9;">
                        <div class="today-info-label" style="color:#64748B;">ä¸‹ç­æ‰“å¡</div>
                        <div class="today-info-value" id="todayCheckoutTime" style="color:#64748B;">--:--</div>
                        <div class="today-info-sub" id="todayCheckoutStatus" style="color:#64748B;">å°šæœªæ‰“å¡</div>
                    </div>
                </div>
            </div>

            <div id="checkInStatusBox" class="status-box info"></div>

            <!-- æ‰“å¡æŒ‰éˆ• -->
            <div class="primary-actions">
                <div class="primary-btn checkin" id="checkInBtn" onclick="startCheckIn()">
                    <div class="icon">â˜€ï¸</div>
                    <div class="label">ä¸Šç­æ‰“å¡</div>
                    <span class="badge-corner">AM</span>
                </div>
                <div class="primary-btn checkout" id="checkOutBtn" onclick="startCheckOut()">
                    <div class="icon">ğŸŒ™</div>
                    <div class="label">ä¸‹ç­æ‰“å¡</div>
                    <span class="badge-corner">PM</span>
                </div>
            </div>

            <!-- ç²¾ç°¡é¸å–®ï¼ˆç§»é™¤èˆ‡åº•éƒ¨å°èˆªé‡è¤‡çš„é …ç›®ï¼‰-->
            <div class="menu-grid">
                <div class="menu-item" onclick="window.location.href='records.html'">
                    <div class="icon">ğŸ“</div><div class="label">æˆ‘è¦è«‹å‡</div>
                </div>
                <div class="menu-item" onclick="window.location.href='services.html'">
                    <div class="icon">ğŸ±</div><div class="label">ä¾¿ç•¶è¨‚è³¼</div>
                </div>
                <div class="menu-item" onclick="window.location.href='records.html#attendance'">
                    <div class="icon">ğŸ“Š</div><div class="label">è€ƒå‹¤æŸ¥è©¢</div>
                </div>
                <!-- ç®¡ç†å“¡å°ˆç”¨ -->
                <div class="menu-item admin-only" id="adminEntry" style="display:none;" onclick="window.location.href='admin.html'">
                    <span class="menu-badge"></span>
                    <div class="icon">ğŸ‘‘</div><div class="label">ç®¡ç†å¾Œå°</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªåˆ—ï¼ˆç®¡ç†å“¡é™å®šï¼‰-->
    <nav class="bottom-nav" id="bottomNav" style="display:none;">
        <a class="nav-item active" onclick="goPage('index.html')">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-label">é¦–é </span>
        </a>
        <a class="nav-item" onclick="goPage('schedule.html')">
            <span class="nav-icon">ğŸ“…</span>
            <span class="nav-label">ç­è¡¨</span>
        </a>
        <a class="nav-item" onclick="startCheckIn()">
            <span class="nav-icon">ğŸ“</span>
            <span class="nav-label">æ‰“å¡</span>
        </a>
        <a class="nav-item" onclick="goPage('salary.html')">
            <span class="nav-icon">ğŸ’°</span>
            <span class="nav-label">è–ªè³‡</span>
        </a>
        <a class="nav-item" onclick="goPage('admin.html')">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-label">ç®¡ç†</span>
        </a>
    </nav>

    <script src="common.js"></script>
    <script>
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goPage(url) {
            window.location.href = url;
        }

        function startCheckIn() { 
            if (document.getElementById('checkInBtn')?.classList.contains('disabled')) return;
            if (isProcessing) return;
            isProcessing = true;
            window.location.href = 'checkin.html?type=in';
            setTimeout(() => isProcessing = false, 1000);
        }

        function startCheckOut() { 
            if (document.getElementById('checkOutBtn')?.classList.contains('disabled')) return;
            if (isProcessing) return;
            isProcessing = true;
            window.location.href = 'checkin.html?type=out';
            setTimeout(() => isProcessing = false, 1000);
        }

        // æ›´æ–°ä»Šæ—¥è³‡è¨Š
        function updateTodayInfo() {
            const now = new Date();
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} é€±${days[now.getDay()]}`;
            const el = document.getElementById('todayDate');
            if (el) el.textContent = dateStr;
        }

        // è¼‰å…¥ä»Šæ—¥æ‰“å¡ç‹€æ…‹
        async function loadTodayStatus() {
            if (!currentEmployee || !liffProfile) return;
            try {
                const today = fmtDate(new Date());
                const { data } = await sb.from('attendance')
                    .select('check_in_time, check_out_time, status')
                    .eq('employee_id', currentEmployee.id)
                    .eq('date', today)
                    .maybeSingle();

                const badgeEl = document.getElementById('userStatusBadge');

                if (data?.check_in_time) {
                    const inTime = new Date(data.check_in_time);
                    const timeStr = `${String(inTime.getHours()).padStart(2,'0')}:${String(inTime.getMinutes()).padStart(2,'0')}`;
                    document.getElementById('todayCheckinTime').textContent = timeStr;
                    
                    const isLate = data.status === 'late';
                    document.getElementById('todayCheckinStatus').textContent = isLate ? 'âš ï¸ é²åˆ°' : 'âœ… æº–æ™‚';
                    document.getElementById('todayCheckinCard').style.background = isLate ? '#FEE2E2' : '#D1FAE5';
                    document.getElementById('todayCheckinTime').style.color = isLate ? '#EF4444' : '#059669';
                    
                    if (badgeEl) {
                        badgeEl.textContent = 'âœ… å·²æ‰“å¡';
                        badgeEl.style.background = '#D1FAE5';
                        badgeEl.style.color = '#065F46';
                    }
                } else {
                    if (badgeEl) {
                        badgeEl.textContent = 'â³ æœªæ‰“å¡';
                        badgeEl.style.background = '#FEF3C7';
                        badgeEl.style.color = '#92400E';
                    }
                }

                if (data?.check_out_time) {
                    const outTime = new Date(data.check_out_time);
                    const timeStr = `${String(outTime.getHours()).padStart(2,'0')}:${String(outTime.getMinutes()).padStart(2,'0')}`;
                    document.getElementById('todayCheckoutTime').textContent = timeStr;
                    document.getElementById('todayCheckoutStatus').textContent = 'âœ… å·²ä¸‹ç­';
                }
            } catch(e) { console.error('è¼‰å…¥ä»Šæ—¥ç‹€æ…‹å¤±æ•—', e); }
        }

        // è¼‰å…¥å“¡å·¥é¡å‹ï¼ˆæ­£è·/å…¼è·ï¼‰
        async function loadEmployeeType() {
            if (!currentEmployee) return;
            try {
                const { data } = await sb.from('salary_settings')
                    .select('salary_type')
                    .eq('employee_id', currentEmployee.id)
                    .eq('is_current', true)
                    .maybeSingle();
                
                const badge = document.getElementById('userTypeBadge');
                if (badge && data) {
                    badge.style.display = 'inline-block';
                    if (data.salary_type === 'monthly') {
                        badge.textContent = 'æ­£è·';
                        badge.style.background = '#DBEAFE';
                        badge.style.color = '#1E40AF';
                    } else if (data.salary_type === 'hourly') {
                        badge.textContent = 'æ™‚è–ª';
                        badge.style.background = '#FEF3C7';
                        badge.style.color = '#92400E';
                    } else if (data.salary_type === 'daily') {
                        badge.textContent = 'æ—¥è–ª';
                        badge.style.background = '#FEF3C7';
                        badge.style.color = '#92400E';
                    }
                }
            } catch(e) { console.log('è¼‰å…¥å“¡å·¥é¡å‹å¤±æ•—', e); }
        }

        function checkLiffParams() {
            try {
                if (liff && liff.isInClient()) {
                    const liffParams = liff.getContext();
                    if (liffParams?.type === 'utim' && liffParams.utm) {
                        const urlParams = new URLSearchParams(liffParams.utm);
                        const company = urlParams.get('company');
                        if (company) sessionStorage.setItem('company_code', company);
                    }
                }
            } catch(e) {}
            const urlParams = new URLSearchParams(window.location.search);
            const company = urlParams.get('company');
            if (company) sessionStorage.setItem('company_code', company);
        }

        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') {
                console.error('common.js æœªæ­£ç¢ºè¼‰å…¥');
                return;
            }
            
            const initialized = await initializeLiff();
            if (initialized) {
                checkLiffParams();
                
                const isLoggedIn = await checkUserStatus();
                if (isLoggedIn) {
                    showPage('homePage');
                    updateTodayInfo();
                    preloadGPS();
                    loadTodayStatus();
                    loadEmployeeType();
                    initBottomNav();
                    applyFeatureVisibility();
                    loadAnnouncements();
                    checkForcedAnnouncements();
                    
                    const isAdmin = await checkIsAdmin();
                    if (isAdmin) {
                        const adminEntry = document.getElementById('adminEntry');
                        if (adminEntry) adminEntry.style.display = 'block';
                    }
                } else {
                    showPage('bindPage');
                }
            }
        });
    </script>
</body>
</html>
