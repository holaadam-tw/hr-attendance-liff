<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¢ å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    
    <style>
        /* ================= UI æ¨£å¼å€ ================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px; color: #333;
        }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* é é¢èˆ‡å¡ç‰‡ */
        .page { display: none; animation: fadeIn 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card, .user-card, .checkin-page {
            background: white; border-radius: 20px; padding: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px;
        }

        /* ç¶å®šé é¢ */
        .bind-header { text-align: center; margin-bottom: 20px; }
        .bind-header .logo { font-size: 50px; display: block; margin-bottom: 10px; }
        
        /* é ç±¤åˆ‡æ› */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .tab-btn.active { background: #667eea; color: white; }
        .tab-btn.inactive { background: #e0e0e0; color: #666; }

        /* é¦–é è³‡è¨Š */
        .user-info { display: flex; align-items: center; gap: 15px; }
        .avatar {
            width: 60px; height: 60px; border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; color: white;
        }
        .user-details h2 { font-size: 20px; margin-bottom: 5px; color: #333; }
        .user-details p { font-size: 13px; color: #666; }

        /* GPS å®šä½ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .location-status {
            display: flex; align-items: center; gap: 8px; margin-top: 12px;
            padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;
        }
        .location-status.loading {
            background: #fff3cd; color: #856404;
        }
        .location-status.ready {
            background: #d4edda; color: #155724;
        }
        .location-status .dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: currentColor; animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* æŒ‰éˆ•æ¨£å¼ */
        .primary-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .primary-btn {
            background: white; border-radius: 15px; padding: 25px 15px; text-align: center;
            cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            position: relative;
        }
        .primary-btn:active { transform: scale(0.98); }
        .primary-btn.checkin { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .primary-btn.checkout { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .primary-btn.disabled { opacity: 0.6; cursor: not-allowed; }
        .primary-btn .icon { font-size: 40px; margin-bottom: 10px; }
        .primary-btn .label { font-size: 16px; font-weight: 700; }

        /* åŠŸèƒ½é¸å–® */
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .menu-item {
            background: white; border-radius: 15px; padding: 20px 10px; text-align: center;
            cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .menu-item:active { transform: scale(0.95); }
        .menu-item .icon { font-size: 32px; margin-bottom: 8px; }
        .menu-item .label { font-size: 13px; font-weight: 600; color: #333; }

        /* è¡¨å–® */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: #667eea;
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        
        .btn { 
            width: 100%; padding: 15px; border: none; border-radius: 10px; 
            font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px;
            transition: all 0.3s ease;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; }
        .btn-secondary { background: #e0e0e0; color: #666; }

        /* ä¾¿ç•¶çµ±è¨ˆèˆ‡è¾²æ›†æç¤º */
        .lunch-summary { 
            background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 20px;
        }
        .lunch-summary h3 { margin-bottom: 10px; font-size: 16px; color: #333; }
        .stat-row { 
            display: flex; justify-content: space-between; padding: 10px 0; 
            border-bottom: 1px solid #e0e0e0;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-value { font-weight: bold; color: #667eea; }

        .lunar-notice {
            background: #fff3cd; border-left: 4px solid #ffc107;
            padding: 12px; margin-bottom: 15px; border-radius: 8px;
            font-size: 13px; color: #856404; display: none;
        }
        .lunar-notice.show { display: block; }

        /* ç‹€æ…‹èˆ‡ç›¸æ©Ÿ */
        .status-box { 
            background: #f8f9fa; border-radius: 10px; padding: 15px; 
            margin-bottom: 20px; text-align: center; display: none; 
        }
        .status-box.show { display: block; }
        .status-box.success { background: #d4edda; color: #155724; }
        .status-box.error { background: #f8d7da; color: #721c24; }
        .status-box.info { background: #d1ecf1; color: #0c5460; }
        
        .camera-container {
            position: relative; width: 100%; max-width: 400px; margin: 0 auto 20px;
            border-radius: 15px; overflow: hidden; background: #000; display: none;
        }
        .camera-container.show { display: block; }
        #video { width: 100%; display: block; transform: scaleX(-1); }
        
        /* è€ƒå‹¤è¨˜éŒ„æ¨£å¼ */
        .attendance-item {
            background: white; border-radius: 10px; padding: 15px;
            margin-bottom: 10px; border-left: 4px solid #667eea;
        }
        .attendance-item .date {
            font-weight: bold; color: #333; margin-bottom: 8px;
        }
        .attendance-item .details {
            font-size: 13px; color: #666; display: flex;
            justify-content: space-between; margin-top: 5px;
        }
        .badge {
            display: inline-block; padding: 3px 8px; border-radius: 4px;
            font-size: 11px; font-weight: 600;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 50px; color: white; }
        .spinner { 
            border: 4px solid rgba(255,255,255,0.3); 
            border-top: 4px solid white; border-radius: 50%; 
            width: 40px; height: 40px; 
            animation: spin 1s linear infinite; margin: 20px auto; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast é€šçŸ¥ */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: white; padding: 12px 24px;
            border-radius: 25px; font-size: 14px; z-index: 9999;
            animation: fadeInOut 3s ease; pointer-events: none;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- è¼‰å…¥é é¢ -->
        <div id="loadingPage" class="loading">
            <div class="spinner"></div>
            <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
        </div>

        <!-- ç¶å®šé é¢ -->
        <div id="bindPage" class="page">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">ğŸ”</span>
                    <h2>å“¡å·¥èº«åˆ†ç¶å®š</h2>
                    <p>åˆæ¬¡ä½¿ç”¨è«‹é©—è­‰èº«åˆ†</p>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" id="tabIdCard" onclick="switchBindMode('id_card')">èº«åˆ†è­‰é©—è­‰</button>
                    <button class="tab-btn inactive" id="tabCode" onclick="switchBindMode('code')">é©—è­‰ç¢¼é©—è­‰</button>
                </div>
                
                <div class="form-group">
                    <label>å“¡å·¥ç·¨è™Ÿ (ID) *</label>
                    <input type="text" id="bindEmpId" placeholder="ä¾‹å¦‚ï¼šADMIN001" autocomplete="off">
                </div>
                
                <div id="modeIdCard" class="form-group">
                    <label>èº«åˆ†è­‰å¾Œ 4 ç¢¼ *</label>
                    <input type="tel" id="bindIdLast4" maxlength="4" placeholder="ä¾‹å¦‚ï¼š1234" autocomplete="off">
                </div>

                <div id="modeCode" class="form-group hidden">
                    <label>ä¸€æ¬¡æ€§é©—è­‰ç¢¼ *</label>
                    <input type="text" id="bindCode" placeholder="è«‹è¼¸å…¥ HR æä¾›çš„é©—è­‰ç¢¼" autocomplete="off">
                </div>

                <button class="btn btn-primary" onclick="handleBind()">ğŸ”— ç«‹å³ç¶å®š</button>
                <div id="bindStatus" class="status-box"></div>
            </div>
        </div>

        <!-- é¦–é  -->
        <div id="homePage" class="page">
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <h2 id="userName">è¼‰å…¥ä¸­...</h2>
                        <p id="userDept">-</p>
                        <p id="userId" style="font-size: 11px; color: #999;">ID: -</p>
                    </div>
                </div>
                <!-- GPS å®šä½ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
                <div class="location-status loading" id="locationStatus">
                    <div class="dot"></div>
                    <span>æ­£åœ¨å–å¾—å®šä½...</span>
                </div>
            </div>

            <div class="primary-actions">
                <div class="primary-btn checkin" id="checkInBtn" onclick="startCheckIn()">
                    <div class="icon">ğŸ“¸</div><div class="label">ä¸Šç­æ‰“å¡</div>
                </div>
                <div class="primary-btn checkout" id="checkOutBtn" onclick="startCheckOut()">
                    <div class="icon">ğŸ‘‹</div><div class="label">ä¸‹ç­æ‰“å¡</div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="showPage('leavePage')">
                    <div class="icon">ğŸ“</div><div class="label">æˆ‘è¦è«‹å‡</div>
                </div>
                <div class="menu-item" onclick="showPage('attendancePage')">
                    <div class="icon">ğŸ“Š</div><div class="label">è€ƒå‹¤æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="showPage('lunchPage')">
                    <div class="icon">ğŸ±</div><div class="label">ä¾¿ç•¶è¨‚è³¼</div>
                </div>
                <div class="menu-item" onclick="showPage('salaryPage')">
                    <div class="icon">ğŸ’°</div><div class="label">è–ªè³‡æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="showToast('åŠŸèƒ½é–‹ç™¼ä¸­')">
                    <div class="icon">ğŸ“…</div><div class="label">ç­è¡¨æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="showPage('settingsPage')">
                    <div class="icon">âš™ï¸</div><div class="label">è¨­å®š</div>
                </div>
            </div>
        </div>

        <!-- æ‰“å¡é é¢ -->
        <div id="checkInPage" class="page">
            <button class="btn btn-secondary" onclick="cancelCheckIn()" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2 id="checkInTitle">ğŸ“ ä¸Šç­æ‰“å¡</h2>
                <div id="checkInStatus" class="status-box show info">æº–å‚™é–‹å•Ÿç›¸æ©Ÿ...</div>
                
                <div class="camera-container" id="cameraContainer">
                    <video id="video" autoplay playsinline muted></video>
                    <canvas id="canvas" class="hidden"></canvas>
                </div>

                <button class="btn btn-primary" id="captureBtn" onclick="captureAndCheckIn()" disabled>ğŸ“¸ æ‹ç…§æ‰“å¡</button>
            </div>
        </div>

        <!-- ä¾¿ç•¶è¨‚è³¼é é¢ -->
        <div id="lunchPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('homePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ± ä¾¿ç•¶è¨‚è³¼</h2>
                
                <!-- è¾²æ›†æç¤º -->
                <div class="lunar-notice" id="lunarNotice">
                    ğŸŒ™ ä»Šå¤©æ˜¯è¾²æ›†åˆä¸€/åäº”ï¼Œå»ºè­°è¨‚è³¼ç´ é£Ÿä¾¿ç•¶
                </div>
                
                <div class="lunch-summary">
                    <h3>ğŸ“Š æ˜æ—¥è¨‚è³¼çµ±è¨ˆ</h3>
                    <div class="stat-row">
                        <span>ç¸½è¨‚è³¼æ•¸</span>
                        <span class="stat-value" id="totalOrders">0</span>
                    </div>
                    <div class="stat-row">
                        <span>ğŸ¥— ç´ é£Ÿ</span>
                        <span class="stat-value" id="vegCount">0</span>
                    </div>
                    <div class="stat-row">
                        <span>ğŸ– è‘·é£Ÿ</span>
                        <span class="stat-value" id="regularCount">0</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>è¨‚è³¼æ—¥æœŸ</label>
                    <input type="date" id="lunchDate">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="lunchVegetarian" onchange="updateLunchType()"> ç´ é£Ÿä¾¿ç•¶
                    </label>
                </div>
                <div class="form-group">
                    <label>ç‰¹æ®Šéœ€æ±‚ï¼ˆé¸å¡«ï¼‰</label>
                    <input type="text" id="lunchNotes" placeholder="ä¾‹å¦‚ï¼šä¸è¦é£¯ã€ä¸åƒè¾£">
                </div>
                <button class="btn btn-success" onclick="submitLunchOrder()">âœ… ç¢ºèªè¨‚è³¼</button>
            </div>
        </div>

        <!-- è«‹å‡é é¢ -->
        <div id="leavePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('homePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“ è«‹å‡ç”³è«‹</h2>
                <div class="form-group">
                    <label>å‡åˆ¥</label>
                    <select id="leaveType">
                        <option value="annual">ç‰¹ä¼‘å‡</option>
                        <option value="sick">ç—…å‡</option>
                        <option value="personal">äº‹å‡</option>
                        <option value="compensatory">è£œä¼‘</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" id="leaveStartDate">
                </div>
                <div class="form-group">
                    <label>çµæŸæ—¥æœŸ</label>
                    <input type="date" id="leaveEndDate">
                </div>
                <div class="form-group">
                    <label>è«‹å‡åŸå› </label>
                    <textarea id="leaveReason" placeholder="è«‹è¼¸å…¥è«‹å‡åŸå› ..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="submitLeave()">ğŸ“¤ æäº¤ç”³è«‹</button>
                <div id="leaveStatus" class="status-box"></div>
            </div>
        </div>
        
        <!-- è€ƒå‹¤æŸ¥è©¢é é¢ -->
        <div id="attendancePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('homePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“Š è€ƒå‹¤è¨˜éŒ„</h2>
                <div id="attendanceList">
                    <div class="loading" style="color:#666;">
                        <div class="spinner" style="border-color:#ddd;border-top-color:#667eea;"></div>
                        <p>è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è–ªè³‡é é¢ -->
        <div id="salaryPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('homePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ’° è–ªè³‡æŸ¥è©¢</h2>
                <p style="text-align:center;color:#666;padding:40px;">åŠŸèƒ½é–‹ç™¼ä¸­...</p>
            </div>
        </div>
        
        <!-- è¨­å®šé é¢ -->
        <div id="settingsPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('homePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>âš™ï¸ è¨­å®š</h2>
                <p style="text-align:center;color:#666;padding:40px;">åŠŸèƒ½é–‹ç™¼ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        // ================= å…¨åŸŸè¨­å®š =================
        const CONFIG = {
            LIFF_ID: '2008962829-bnsS1bbB',
            SUPABASE_URL: 'https://nssuisyvlrqnqfxupklb.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3Vpc3l2bHJxbnFmeHVwa2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTAwMzUsImV4cCI6MjA4NDg2NjAzNX0.q_B6v3gf1TOCuAq7z0xIw10wDueCSJn0p37VzdMfmbc',
            BUCKET: 'selfies'
        };

        // åˆå§‹åŒ– Supabase èˆ‡ vConsole
        const sb = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        const vConsole = new window.VConsole();
        
        // å…¨åŸŸè®Šæ•¸
        let liffProfile = null;
        let currentEmployee = null;
        let videoStream = null;
        let currentCheckInType = 'in';
        let cachedLocation = null;
        let currentBindMode = 'id_card';

        // ================= â­ é—œéµä¿®æ­£ï¼šæ™‚å€è™•ç†å‡½æ•¸ =================
        /**
         * å–å¾—å°ç£æ™‚é–“çš„ YYYY-MM-DD æ ¼å¼æ—¥æœŸ
         * @param {number} offsetDays - æ—¥æœŸåç§»é‡ï¼ˆ0=ä»Šå¤©, 1=æ˜å¤©, -1=æ˜¨å¤©ï¼‰
         * @returns {string} YYYY-MM-DD æ ¼å¼çš„æ—¥æœŸå­—ä¸²
         */
        function getTaiwanDate(offsetDays = 0) {
            const date = new Date();
            date.setDate(date.getDate() + offsetDays);
            // ä½¿ç”¨ en-CA locale æœƒè¿”å› YYYY-MM-DD æ ¼å¼ï¼Œæ­é… Asia/Taipei æ™‚å€
            return date.toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });
        }

        // ================= åˆå§‹åŒ–æµç¨‹ =================
        window.addEventListener('load', async () => {
            try {
                console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ– LIFF...');
                await liff.init({ liffId: CONFIG.LIFF_ID });
                
                if (!liff.isLoggedIn()) { 
                    console.log('âŒ æœªç™»å…¥ï¼Œå°å‘ LINE ç™»å…¥');
                    liff.login(); 
                    return; 
                }
                
                liffProfile = await liff.getProfile();
                console.log('âœ… LINE ç”¨æˆ¶:', liffProfile);
                
                await checkUserStatus();

            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
                alert('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢: ' + error.message);
            }
        });

        // ================= æ ¸å¿ƒï¼šæª¢æŸ¥ç¶å®šç‹€æ…‹ =================
        async function checkUserStatus() {
            document.getElementById('loadingPage').style.display = 'block';
            
            try {
                const { data, error } = await sb
                    .from('employees')
                    .select('*')
                    .eq('line_user_id', liffProfile.userId)
                    .single();

                document.getElementById('loadingPage').style.display = 'none';

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (data) {
                    // âœ… å·²ç¶å®š
                    currentEmployee = data;
                    updateUserInfo(data);
                    showPage('homePage');
                    preloadGPS(); // é å…ˆæŠ“å–å®šä½
                    console.log('âœ… å“¡å·¥å·²ç¶å®š:', data);
                } else {
                    // âŒ æœªç¶å®š
                    showPage('bindPage');
                    console.log('âš ï¸ å“¡å·¥æœªç¶å®šï¼Œé¡¯ç¤ºç¶å®šé é¢');
                }
            } catch (error) {
                document.getElementById('loadingPage').style.display = 'none';
                console.error('âŒ æª¢æŸ¥ç‹€æ…‹å¤±æ•—:', error);
                showPage('bindPage');
            }
        }

        // æ›´æ–°é¦–é ç”¨æˆ¶è³‡è¨Š
        function updateUserInfo(data) {
            document.getElementById('userName').textContent = data.name || 'æœªçŸ¥';
            document.getElementById('userDept').textContent = `${data.department || '-'} Â· ${data.position || '-'}`;
            document.getElementById('userId').textContent = `ID: ${data.employee_number || data.employee_id}`;
            document.getElementById('userAvatar').textContent = (data.name || '?').charAt(0);
        }

        // ================= å“¡å·¥ç¶å®šé‚è¼¯ =================
        function switchBindMode(mode) {
            currentBindMode = mode;
            document.getElementById('modeIdCard').classList.toggle('hidden', mode !== 'id_card');
            document.getElementById('modeCode').classList.toggle('hidden', mode !== 'code');
            document.getElementById('tabIdCard').className = mode === 'id_card' ? 'tab-btn active' : 'tab-btn inactive';
            document.getElementById('tabCode').className = mode === 'code' ? 'tab-btn active' : 'tab-btn inactive';
        }

        async function handleBind() {
            const empId = document.getElementById('bindEmpId').value.trim();
            const idLast4 = document.getElementById('bindIdLast4').value.trim();
            const code = document.getElementById('bindCode').value.trim();
            const statusBox = document.getElementById('bindStatus');

            if (!empId) {
                return showStatus(statusBox, 'error', 'âš ï¸ è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿ');
            }

            if (currentBindMode === 'id_card' && (!idLast4 || idLast4.length !== 4)) {
                return showStatus(statusBox, 'error', 'âš ï¸ è«‹è¼¸å…¥å®Œæ•´èº«åˆ†è­‰å¾Œ 4 ç¢¼');
            }

            if (currentBindMode === 'code' && !code) {
                return showStatus(statusBox, 'error', 'âš ï¸ è«‹è¼¸å…¥é©—è­‰ç¢¼');
            }

            const params = {
                p_line_user_id: liffProfile.userId,
                p_employee_id: empId,
                p_device_info: navigator.userAgent,
                p_id_card_last_4: currentBindMode === 'id_card' ? idLast4 : null,
                p_verification_code: currentBindMode === 'code' ? code : null
            };

            showStatus(statusBox, 'info', 'ğŸ”„ é©—è­‰ä¸­ï¼Œè«‹ç¨å€™...');
            
            try {
                const { data, error } = await sb.rpc('bind_employee', params);
                
                if (error) {
                    console.error('âŒ RPC éŒ¯èª¤:', error);
                    throw new Error(error.message);
                }

                if (data && data.success) {
                    showStatus(statusBox, 'success', 'âœ… ' + data.message);
                    showToast('âœ… ç¶å®šæˆåŠŸï¼');
                    setTimeout(() => {
                        checkUserStatus();
                    }, 1500);
                } else {
                    showStatus(statusBox, 'error', 'âŒ ' + (data?.error || 'ç¶å®šå¤±æ•—'));
                }
            } catch (err) {
                console.error('âŒ ç¶å®šå¤±æ•—:', err);
                showStatus(statusBox, 'error', 'âŒ ' + err.message);
            }
        }

        // ================= é å…ˆæŠ“å–å®šä½ =================
        function preloadGPS() {
            const statusEl = document.getElementById('locationStatus');
            statusEl.className = 'location-status loading';
            statusEl.innerHTML = '<div class="dot"></div><span>æ­£åœ¨å–å¾—å®šä½...</span>';

            if (!navigator.geolocation) {
                statusEl.className = 'location-status';
                statusEl.innerHTML = '<span>âš ï¸ æ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½</span>';
                return;
            }

            console.log('ğŸ“ é–‹å§‹é å…ˆæŠ“å–å®šä½...');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    cachedLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    console.log('âœ… å®šä½å–å¾—æˆåŠŸ:', cachedLocation);
                    
                    statusEl.className = 'location-status ready';
                    statusEl.innerHTML = '<div class="dot"></div><span>âœ… å®šä½å·²å°±ç·’ï¼ˆå¿«é€Ÿæ‰“å¡ï¼‰</span>';
                },
                (error) => {
                    console.error('âŒ å®šä½å¤±æ•—:', error);
                    statusEl.className = 'location-status';
                    statusEl.innerHTML = '<span>âš ï¸ å®šä½å¤±æ•—ï¼Œæ‰“å¡æ™‚å°‡é‡è©¦</span>';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // ================= æ‰“å¡æµç¨‹ =================
        function startCheckIn() { 
            currentCheckInType = 'in'; 
            showCheckInPage('ğŸ“ ä¸Šç­æ‰“å¡'); 
        }
        
        function startCheckOut() { 
            currentCheckInType = 'out'; 
            showCheckInPage('ğŸ‘‹ ä¸‹ç­æ‰“å¡'); 
        }

        function showCheckInPage(title) {
            document.getElementById('checkInTitle').textContent = title;
            showPage('checkInPage');
            openCamera();
        }

        async function openCamera() {
            const video = document.getElementById('video');
            const statusBox = document.getElementById('checkInStatus');
            
            try {
                showStatus(statusBox, 'info', 'ğŸ“· æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                
                video.srcObject = stream;
                videoStream = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    document.getElementById('cameraContainer').classList.add('show');
                    document.getElementById('captureBtn').disabled = false;
                    showStatus(statusBox, 'success', 'âœ… ç›¸æ©Ÿå°±ç·’ï¼Œè«‹å¾®ç¬‘');
                };
            } catch (error) {
                console.error('âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—:', error);
                showStatus(statusBox, 'error', 'âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: ' + error.message);
                showToast('âŒ ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ');
            }
        }

        function cancelCheckIn() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            showPage('homePage');
        }

        async function captureAndCheckIn() {
            if (!currentEmployee) {
                showToast('âš ï¸ è«‹å…ˆå®Œæˆå“¡å·¥ç¶å®š');
                return;
            }

            const btn = document.getElementById('captureBtn');
            const statusBox = document.getElementById('checkInStatus');
            
            btn.disabled = true;
            btn.textContent = 'â³ è™•ç†ä¸­...';
            showStatus(statusBox, 'info', 'ğŸ“¸ æ­£åœ¨æ‹ç…§...');
            
            try {
                // 1. æ‹ç…§
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                
                // â­ ç¿»è½‰å›æ­£å¸¸æ–¹å‘ï¼ˆä¿®æ­£é¡åƒå•é¡Œï¼‰
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0);
                
                // è½‰æ›ç‚º JPEG blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
                
                showStatus(statusBox, 'info', 'â˜ï¸ æ­£åœ¨ä¸Šå‚³ç…§ç‰‡...');

                // 2. ä¸Šå‚³ç…§ç‰‡åˆ° Supabase Storage
                const fileName = `${currentEmployee.employee_id}_${Date.now()}.jpg`;
                const { data: uploadData, error: uploadError } = await sb.storage
                    .from(CONFIG.BUCKET)
                    .upload(fileName, blob, { upsert: false });

                if (uploadError) throw uploadError;

                // â­ é—œéµä¿®æ­£ï¼šå–å¾—å…¬é–‹ç¶²å€
                const { data: urlData } = sb.storage
                    .from(CONFIG.BUCKET)
                    .getPublicUrl(fileName);
                
                const publicUrl = urlData.publicUrl;
                console.log('âœ… ç…§ç‰‡å…¬é–‹ç¶²å€:', publicUrl);

                showStatus(statusBox, 'info', 'ğŸ“ æ­£åœ¨ç¢ºèªå®šä½...');

                // 3. å–å¾—å®šä½ï¼ˆå„ªå…ˆä½¿ç”¨é å…ˆæŠ“å–çš„ï¼‰
                let location = cachedLocation;
                if (!location) {
                    console.log('âš ï¸ é å…ˆå®šä½ä¸å¯ç”¨ï¼Œé‡æ–°å–å¾—...');
                    location = await getGPS();
                }

                showStatus(statusBox, 'info', 'âœ… æ­£åœ¨è¨˜éŒ„æ‰“å¡...');

                // 4. å‘¼å«æ‰“å¡ RPC
                const { data: checkData, error: checkError } = await sb.rpc('quick_check_in', {
                    p_line_user_id: liffProfile.userId,
                    p_latitude: location.latitude,
                    p_longitude: location.longitude,
                    p_photo_url: publicUrl,  // â­ ä½¿ç”¨å…¬é–‹ç¶²å€
                    p_device_id: navigator.userAgent
                });

                if (checkError) throw checkError;

                if (checkData && checkData.success) {
                    // â­ é—œéµä¿®æ­£ï¼šæ ¹æ“šå¾Œç«¯å›å‚³çš„ type é¡¯ç¤ºæ­£ç¢ºè¨Šæ¯
                    const typeText = checkData.type === 'check_in' ? 'ä¸Šç­' : 'ä¸‹ç­';
                    showStatus(statusBox, 'success', 'âœ… ' + checkData.message);
                    showToast(`âœ… ${typeText}æ‰“å¡æˆåŠŸï¼`);
                    
                    setTimeout(() => {
                        cancelCheckIn();
                    }, 1500);
                } else {
                    throw new Error(checkData?.error || 'æ‰“å¡å¤±æ•—');
                }

            } catch (error) {
                console.error('âŒ æ‰“å¡å¤±æ•—:', error);
                showStatus(statusBox, 'error', 'âŒ æ‰“å¡å¤±æ•—: ' + error.message);
                showToast('âŒ æ‰“å¡å¤±æ•—');
                btn.disabled = false;
                btn.textContent = 'ğŸ“¸ æ‹ç…§æ‰“å¡';
            }
        }

        // å–å¾— GPS å®šä½
        function getGPS() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    }),
                    (error) => reject(new Error('å®šä½å¤±æ•—: ' + error.message)),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        // ================= ä¾¿ç•¶è¨‚è³¼ç³»çµ± =================
        async function loadLunchSummary() {
            try {
                // â­ ä¿®æ­£ï¼šä½¿ç”¨å°ç£æ™‚é–“å–å¾—æ˜å¤©æ—¥æœŸ
                const dateStr = getTaiwanDate(1); // 1 = æ˜å¤©
                document.getElementById('lunchDate').value = dateStr;

                const { data, error } = await sb.rpc('get_lunch_summary', { p_date: dateStr });
                
                if (error) throw error;

                if (data) {
                    document.getElementById('totalOrders').textContent = data.total_orders || 0;
                    document.getElementById('vegCount').textContent = data.vegetarian_count || 0;
                    document.getElementById('regularCount').textContent = data.regular_count || 0;

                    // é¡¯ç¤ºè¾²æ›†æç¤ºï¼ˆå¦‚æœæœ‰è¾²æ›†æ—¥æœŸè¡¨ï¼‰
                    if (data.is_lunar_vegetarian_day) {
                        document.getElementById('lunarNotice').classList.add('show');
                        document.getElementById('lunchVegetarian').checked = true;
                    } else {
                        document.getElementById('lunarNotice').classList.remove('show');
                    }
                }
            } catch (error) {
                console.error('âŒ è¼‰å…¥ä¾¿ç•¶çµ±è¨ˆå¤±æ•—:', error);
            }
        }

        function updateLunchType() {
            // å¯æ“´å……ï¼šæ ¹æ“šå‹¾é¸ç‹€æ…‹æ›´æ–° UI
        }

        async function submitLunchOrder() {
            if (!currentEmployee) {
                showToast('âš ï¸ è«‹å…ˆå®Œæˆå“¡å·¥ç¶å®š');
                return;
            }

            const date = document.getElementById('lunchDate').value;
            const isVeg = document.getElementById('lunchVegetarian').checked;
            const notes = document.getElementById('lunchNotes').value.trim();

            if (!date) {
                showToast('âš ï¸ è«‹é¸æ“‡è¨‚è³¼æ—¥æœŸ');
                return;
            }

            try {
                const { data, error } = await sb.rpc('order_lunch', {
                    p_line_user_id: liffProfile.userId,
                    p_order_date: date,
                    p_is_vegetarian: isVeg,
                    p_special_requirements: notes || null
                });

                if (error) throw error;

                if (data && data.success) {
                    showToast('âœ… ä¾¿ç•¶è¨‚è³¼æˆåŠŸï¼');
                    loadLunchSummary(); // é‡æ–°è¼‰å…¥çµ±è¨ˆ
                } else {
                    throw new Error(data?.error || 'è¨‚è³¼å¤±æ•—');
                }
            } catch (error) {
                console.error('âŒ è¨‚è³¼å¤±æ•—:', error);
                showToast('âŒ è¨‚è³¼å¤±æ•—: ' + error.message);
            }
        }

        // ================= è«‹å‡ç³»çµ± =================
        async function submitLeave() {
            if (!currentEmployee) {
                showToast('âš ï¸ è«‹å…ˆå®Œæˆå“¡å·¥ç¶å®š');
                return;
            }

            const leaveType = document.getElementById('leaveType').value;
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const reason = document.getElementById('leaveReason').value.trim();
            const statusBox = document.getElementById('leaveStatus');

            if (!startDate || !endDate || !reason) {
                showStatus(statusBox, 'error', 'âš ï¸ è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
                return;
            }

            if (new Date(endDate) < new Date(startDate)) {
                showStatus(statusBox, 'error', 'âš ï¸ çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ');
                return;
            }

            showStatus(statusBox, 'info', 'ğŸ“¤ æäº¤ä¸­...');

            try {
                const { error } = await sb.from('leave_requests').insert([{
                    employee_id: currentEmployee.id,
                    leave_type: leaveType,
                    start_date: startDate,
                    end_date: endDate,
                    reason: reason,
                    status: 'pending'
                }]);

                if (error) throw error;

                showStatus(statusBox, 'success', 'âœ… è«‹å‡ç”³è«‹å·²æäº¤');
                showToast('âœ… è«‹å‡ç”³è«‹å·²æäº¤');
                
                setTimeout(() => {
                    showPage('homePage');
                }, 1500);

            } catch (error) {
                console.error('âŒ è«‹å‡å¤±æ•—:', error);
                showStatus(statusBox, 'error', 'âŒ æäº¤å¤±æ•—: ' + error.message);
            }
        }

        // ================= è€ƒå‹¤æŸ¥è©¢ =================
        async function loadAttendance() {
            if (!currentEmployee) return;

            const listEl = document.getElementById('attendanceList');
            
            try {
                const { data, error } = await sb
                    .from('attendance')
                    .select('*')
                    .eq('employee_id', currentEmployee.id)
                    .order('date', { ascending: false })
                    .limit(10);

                if (error) throw error;

                if (!data || data.length === 0) {
                    listEl.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">æš«ç„¡æ‰“å¡è¨˜éŒ„</p>';
                    return;
                }

                listEl.innerHTML = data.map(record => {
                    const checkInTime = record.check_in_time ? 
                        new Date(record.check_in_time).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }) : '--';
                    const checkOutTime = record.check_out_time ? 
                        new Date(record.check_out_time).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }) : '--';
                    const statusBadge = record.is_late ? 
                        '<span class="badge badge-warning">é²åˆ°</span>' : 
                        '<span class="badge badge-success">æ­£å¸¸</span>';
                    
                    return `
                        <div class="attendance-item">
                            <div class="date">${record.date} ${statusBadge}</div>
                            <div class="details">
                                <span>ä¸Šç­: ${checkInTime}</span>
                                <span>ä¸‹ç­: ${checkOutTime}</span>
                            </div>
                            <div class="details">
                                <span>å·¥æ™‚: ${record.total_work_hours || '--'} å°æ™‚</span>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('âŒ è¼‰å…¥è€ƒå‹¤å¤±æ•—:', error);
                listEl.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // ================= è¼”åŠ©åŠŸèƒ½ =================
        function showPage(id) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // é é¢è¼‰å…¥æ™‚è§¸ç™¼å°æ‡‰çš„åˆå§‹åŒ–
            if (id === 'lunchPage') loadLunchSummary();
            if (id === 'attendancePage') loadAttendance();
        }

        function showStatus(el, type, msg) {
            el.className = `status-box show ${type}`;
            el.innerHTML = msg;
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
