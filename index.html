<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¢ å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    
    <style>
        /* ================= UI æ¨£å¼å€ ================= */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --bg-color: #f3f4f6;
            --text-color: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh; padding: 20px; color: var(--text-color);
        }
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 40px; }
        
        /* é é¢åˆ‡æ›èˆ‡å‹•ç•« */
        .page { display: none; animation: fadeIn 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card, .user-card, .checkin-page {
            background: white; border-radius: 20px; padding: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-bottom: 20px;
        }

        /* ç¶å®šé é¢ */
        .bind-header { text-align: center; margin-bottom: 20px; }
        .bind-header .logo { font-size: 50px; display: block; margin-bottom: 10px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .tab-btn.active { background: var(--primary-color); color: white; box-shadow: 0 4px 6px rgba(102, 126, 234, 0.25); }
        .tab-btn.inactive { background: #e5e7eb; color: #6b7280; }

        /* é¦–é ç”¨æˆ¶è³‡è¨Š */
        .user-info { display: flex; align-items: center; gap: 15px; }
        .avatar {
            width: 64px; height: 64px; border-radius: 50%;
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; color: white; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .user-details h2 { font-size: 20px; margin-bottom: 4px; color: #1f2937; }
        .user-details p { font-size: 13px; color: #6b7280; }

        /* GPS ç‹€æ…‹åˆ— */
        .location-status {
            display: flex; align-items: center; gap: 8px; margin-top: 15px;
            padding: 10px 15px; border-radius: 12px; font-size: 13px; font-weight: 500;
            transition: all 0.3s;
        }
        .location-status.loading { background: #fffbeb; color: #92400e; }
        .location-status.ready { background: #d1fae5; color: #065f46; }
        .location-status .dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: currentColor; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }

        /* ä¸»è¦æ‰“å¡æŒ‰éˆ• */
        .primary-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .primary-btn {
            background: white; border-radius: 16px; padding: 20px 15px; text-align: center;
            cursor: pointer; transition: transform 0.1s, box-shadow 0.3s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; overflow: hidden;
        }
        .primary-btn:active { transform: scale(0.96); }
        .primary-btn.checkin { border-bottom: 4px solid var(--primary-color); }
        .primary-btn.checkout { border-bottom: 4px solid #f472b6; }
        .primary-btn.disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
        .primary-btn .icon { font-size: 36px; margin-bottom: 8px; display: block; }
        .primary-btn .label { font-size: 16px; font-weight: 700; color: #374151; }
        .primary-btn .badge-corner {
            position: absolute; top: 8px; right: 8px; font-size: 10px; 
            background: #f3f4f6; padding: 2px 6px; border-radius: 4px; color: #6b7280;
        }

        /* ä¹å®®æ ¼é¸å–® */
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .menu-item {
            background: rgba(255,255,255,0.9); border-radius: 16px; padding: 15px 5px; text-align: center;
            cursor: pointer; transition: all 0.2s; backdrop-filter: blur(5px);
        }
        .menu-item:active { background: rgba(255,255,255,1); transform: scale(0.95); }
        .menu-item .icon { font-size: 28px; margin-bottom: 5px; display: block; }
        .menu-item .label { font-size: 12px; font-weight: 600; color: #4b5563; }

        /* è¡¨å–®å…ƒç´  */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #4b5563; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px;
            transition: border-color 0.3s; background: #f9fafb;
        }
        .form-group input:focus { outline: none; border-color: var(--primary-color); background: white; }
        .form-group textarea { min-height: 100px; resize: vertical; }

        /* æŒ‰éˆ• */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn-success { background: linear-gradient(135deg, #34d399 0%, #059669 100%); color: white; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); }
        .btn-secondary { background: #e5e7eb; color: #4b5563; }

        /* ä¾¿ç•¶èˆ‡è¾²æ›† */
        .lunch-summary { background: #f0fdf4; border: 1px solid #d1fae5; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #a7f3d0; }
        .stat-row:last-child { border-bottom: none; }
        .lunar-notice { background: #fff7ed; border-left: 4px solid #f59e0b; padding: 12px; margin-bottom: 15px; border-radius: 8px; font-size: 13px; color: #92400e; display: none; }
        .lunar-notice.show { display: block; }

        /* ç‹€æ…‹è¨Šæ¯ */
        .status-box { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center; font-size: 14px; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .status-box.show { display: block; animation: fadeIn 0.3s; }
        .status-box.success { border-left: 5px solid #10b981; color: #065f46; }
        .status-box.error { border-left: 5px solid #ef4444; color: #7f1d1d; }
        .status-box.info { border-left: 5px solid #3b82f6; color: #1e3a8a; }

        /* ç›¸æ©Ÿ */
        .camera-container {
            position: relative; width: 100%; aspect-ratio: 3/4; margin: 0 auto 20px;
            border-radius: 16px; overflow: hidden; background: #000; display: none;
        }
        .camera-container.show { display: block; }
        #video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* è€ƒå‹¤åˆ—è¡¨ */
        .attendance-item {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #ddd;
        }
        .attendance-item.late { border-left-color: #ef4444; }
        .attendance-item.normal { border-left-color: #10b981; }
        .attendance-item .date { font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .attendance-item .details { font-size: 13px; color: #6b7280; display: flex; justify-content: space-between; }

        /* å·¥å…·é¡ */
        .hidden { display: none !important; }
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-color); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(17, 24, 39, 0.9); color: white; padding: 12px 24px;
            border-radius: 50px; font-size: 14px; z-index: 10000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            animation: fadeInOut 3s forwards;
        }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, -20px); } 10% { opacity: 1; transform: translate(-50%, 0); } 90% { opacity: 1; transform: translate(-50%, 0); } 100% { opacity: 0; transform: translate(-50%, -20px); } }
    </style>
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <div id="bindPage" class="page">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">ğŸ”</span>
                    <h2>å“¡å·¥èº«åˆ†ç¶å®š</h2>
                    <p>åˆæ¬¡ä½¿ç”¨è«‹é©—è­‰èº«åˆ†</p>
                </div>
                <div class="tabs">
                    <button class="tab-btn active" id="tabIdCard" onclick="switchBindMode('id_card')">èº«åˆ†è­‰é©—è­‰</button>
                    <button class="tab-btn inactive" id="tabCode" onclick="switchBindMode('code')">é©—è­‰ç¢¼é©—è­‰</button>
                </div>
                <div class="form-group">
                    <label>å“¡å·¥ç·¨è™Ÿ (ID) *</label>
                    <input type="text" id="bindEmpId" placeholder="ä¾‹å¦‚ï¼šEMP001" autocomplete="off">
                </div>
                <div id="modeIdCard" class="form-group">
                    <label>èº«åˆ†è­‰å¾Œ 4 ç¢¼ *</label>
                    <input type="tel" id="bindIdLast4" maxlength="4" placeholder="ä¾‹å¦‚ï¼š1234" autocomplete="off">
                </div>
                <div id="modeCode" class="form-group hidden">
                    <label>ä¸€æ¬¡æ€§é©—è­‰ç¢¼ *</label>
                    <input type="text" id="bindCode" placeholder="è«‹è¼¸å…¥ HR æä¾›çš„é©—è­‰ç¢¼" autocomplete="off">
                </div>
                <button class="btn btn-primary" onclick="handleBind()">ğŸ”— ç«‹å³ç¶å®š</button>
                <div id="bindStatus" class="status-box"></div>
            </div>
        </div>

        <div id="homePage" class="page">
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">?</div>
                    <div class="user-details">
                        <h2 id="userName">è¼‰å…¥ä¸­...</h2>
                        <p id="userDept">-</p>
                        <p id="userId" style="font-size: 11px; opacity: 0.7;">ID: -</p>
                    </div>
                </div>
                <div class="location-status loading" id="locationStatus">
                    <div class="dot"></div><span>æ­£åœ¨å–å¾—å®šä½...</span>
                </div>
            </div>

            <div id="checkInStatusBox" class="status-box info"></div>

            <div class="primary-actions">
                <div class="primary-btn checkin" id="checkInBtn" onclick="startCheckIn()">
                    <span class="badge-corner">AM</span>
                    <div class="icon">â˜€ï¸</div><div class="label">ä¸Šç­æ‰“å¡</div>
                </div>
                <div class="primary-btn checkout" id="checkOutBtn" onclick="startCheckOut()">
                    <span class="badge-corner">PM</span>
                    <div class="icon">ğŸŒ™</div><div class="label">ä¸‹ç­æ‰“å¡</div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="showPage('leavePage')">
                    <div class="icon">ğŸ“</div><div class="label">æˆ‘è¦è«‹å‡</div>
                </div>
                <div class="menu-item" onclick="showPage('attendancePage')">
                    <div class="icon">ğŸ“Š</div><div class="label">è€ƒå‹¤æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="showPage('lunchPage')">
                    <div class="icon">ğŸ±</div><div class="label">ä¾¿ç•¶è¨‚è³¼</div>
                </div>
                <div class="menu-item" onclick="showPage('salaryPage')">
                    <div class="icon">ğŸ’°</div><div class="label">è–ªè³‡æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="showToast('åŠŸèƒ½é–‹ç™¼ä¸­')">
                    <div class="icon">ğŸ“…</div><div class="label">ç­è¡¨æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="showPage('settingsPage')">
                    <div class="icon">âš™ï¸</div><div class="label">è¨­å®š</div>
                </div>
            </div>
        </div>

        <div id="checkInPage" class="page">
            <button class="btn btn-secondary" onclick="cancelCheckIn()" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2 id="checkInTitle" style="text-align: center;">ğŸ“ ä¸Šç­æ‰“å¡</h2>
                <div id="checkInStatus" class="status-box show info">æº–å‚™é–‹å•Ÿç›¸æ©Ÿ...</div>
                
                <div class="camera-container" id="cameraContainer">
                    <video id="video" autoplay playsinline muted></video>
                    <canvas id="canvas" class="hidden"></canvas>
                </div>

                <button class="btn btn-primary" id="captureBtn" onclick="captureAndCheckIn()" disabled>ğŸ“¸ æ‹ç…§ä¸¦æ‰“å¡</button>
            </div>
        </div>

        <div id="lunchPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('homePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ± ä¾¿ç•¶è¨‚è³¼</h2>
                <div class="lunar-notice" id="lunarNotice">ğŸŒ™ æ˜å¤©æ˜¯è¾²æ›†åˆä¸€/åäº”ï¼Œå»ºè­°è¨‚è³¼ç´ é£Ÿ</div>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:10px;">ğŸ“Š æ˜æ—¥çµ±è¨ˆ</h3>
                    <div class="stat-row"><span>ç¸½æ•¸</span><span id="totalOrders">0</span></div>
                    <div class="stat-row"><span>ğŸ¥— ç´ é£Ÿ</span><span id="vegCount">0</span></div>
                    <div class="stat-row"><span>ğŸ– è‘·é£Ÿ</span><span id="regularCount">0</span></div>
                </div>

                <div class="form-group"><label>è¨‚è³¼æ—¥æœŸ</label><input type="date" id="lunchDate"></div>
                <div class="form-group"><label><input type="checkbox" id="lunchVegetarian"> æˆ‘è¦è¨‚ç´ é£Ÿä¾¿ç•¶</label></div>
                <div class="form-group"><label>å‚™è¨» (é¸å¡«)</label><input type="text" id="lunchNotes" placeholder="ä¾‹ï¼šä¸è¦é£¯"></div>
                <button class="btn btn-success" onclick="submitLunchOrder()">âœ… ç¢ºèªè¨‚è³¼</button>
            </div>
        </div>

        <div id="leavePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('homePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“ è«‹å‡ç”³è«‹</h2>
                <div class="form-group">
                    <label>å‡åˆ¥</label>
                    <select id="leaveType">
                        <option value="annual">ç‰¹ä¼‘å‡</option>
                        <option value="sick">ç—…å‡</option>
                        <option value="personal">äº‹å‡</option>
                        <option value="compensatory">è£œä¼‘</option>
                    </select>
                </div>
                <div class="form-group"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="leaveStartDate"></div>
                <div class="form-group"><label>çµæŸæ—¥æœŸ</label><input type="date" id="leaveEndDate"></div>
                <div class="form-group"><label>åŸå› </label><textarea id="leaveReason"></textarea></div>
                <button class="btn btn-primary" onclick="submitLeave()">ğŸ“¤ æäº¤ç”³è«‹</button>
                <div id="leaveStatus" class="status-box"></div>
            </div>
        </div>

        <div id="attendancePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('homePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“Š è€ƒå‹¤è¨˜éŒ„</h2>
                <div id="attendanceList" style="margin-top:15px;"></div>
            </div>
        </div>

        <div id="salaryPage" class="page"><div class="checkin-page"><h2>ğŸ’° è–ªè³‡æŸ¥è©¢</h2><p class="status-box show info">åŠŸèƒ½é–‹ç™¼ä¸­...</p><button class="btn btn-secondary" onclick="showPage('homePage')">è¿”å›</button></div></div>
        <div id="settingsPage" class="page"><div class="checkin-page"><h2>âš™ï¸ è¨­å®š</h2><p class="status-box show info">åŠŸèƒ½é–‹ç™¼ä¸­...</p><button class="btn btn-secondary" onclick="showPage('homePage')">è¿”å›</button></div></div>
    </div>

    <script>
        // ================= è¨­å®šèˆ‡åˆå§‹åŒ– =================
        const CONFIG = {
            LIFF_ID: '2008962829-bnsS1bbB',
            SUPABASE_URL: 'https://nssuisyvlrqnqfxupklb.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3Vpc3l2bHJxbnFmeHVwa2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTAwMzUsImV4cCI6MjA4NDg2NjAzNX0.q_B6v3gf1TOCuAq7z0xIw10wDueCSJn0p37VzdMfmbc',
            BUCKET: 'selfies'
        };

        const sb = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        const vConsole = new window.VConsole();
        
        let liffProfile = null;
        let currentEmployee = null;
        let videoStream = null;
        let currentCheckInType = 'in';
        let cachedLocation = null;
        let currentBindMode = 'id_card';
        let todayAttendance = null;

        // âœ… æ ¸å¿ƒï¼šå–å¾—å°ç£æ™‚é–“ YYYY-MM-DD
        function getTaiwanDate(offsetDays = 0) {
            const date = new Date();
            date.setDate(date.getDate() + offsetDays);
            return date.toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });
        }

        window.addEventListener('load', async () => {
            try {
                console.log('ğŸš€ ç³»çµ±åˆå§‹åŒ–...');
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                
                liffProfile = await liff.getProfile();
                await checkUserStatus(); // æª¢æŸ¥ç¶å®š

            } catch (error) {
                alert('åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            }
        });

        // ================= æ ¸å¿ƒé‚è¼¯ =================
        async function checkUserStatus() {
            document.getElementById('loadingPage').style.display = 'flex';
            
            try {
                const { data, error } = await sb.from('employees').select('*').eq('line_user_id', liffProfile.userId).single();
                document.getElementById('loadingPage').style.display = 'none';

                if (data) {
                    currentEmployee = data;
                    updateUserInfo(data);
                    showPage('homePage');
                    preloadGPS();
                    checkTodayAttendance(); // æª¢æŸ¥æ‰“å¡ç‹€æ…‹
                } else {
                    showPage('bindPage');
                }
            } catch (err) {
                document.getElementById('loadingPage').style.display = 'none';
                showPage('bindPage');
            }
        }

        function updateUserInfo(data) {
            document.getElementById('userName').textContent = data.name;
            document.getElementById('userDept').textContent = `${data.department || '-'} ${data.position || ''}`;
            document.getElementById('userId').textContent = `ID: ${data.employee_number || data.employee_id}`;
            const avatar = document.getElementById('userAvatar');
            if(liffProfile.pictureUrl) {
                avatar.style.backgroundImage = `url(${liffProfile.pictureUrl})`;
                avatar.style.backgroundSize = 'cover'; avatar.textContent='';
            } else {
                avatar.textContent = data.name.charAt(0);
            }
        }

        // ================= ç¶å®šé‚è¼¯ =================
        function switchBindMode(mode) {
            currentBindMode = mode;
            document.getElementById('modeIdCard').classList.toggle('hidden', mode !== 'id_card');
            document.getElementById('modeCode').classList.toggle('hidden', mode !== 'code');
            document.getElementById('tabIdCard').className = mode === 'id_card' ? 'tab-btn active' : 'tab-btn inactive';
            document.getElementById('tabCode').className = mode === 'code' ? 'tab-btn active' : 'tab-btn inactive';
        }

        async function handleBind() {
            const empId = document.getElementById('bindEmpId').value.trim();
            const idLast4 = document.getElementById('bindIdLast4').value.trim();
            const code = document.getElementById('bindCode').value.trim();
            const statusBox = document.getElementById('bindStatus');

            if (!empId) return showStatus(statusBox, 'error', 'è«‹è¼¸å…¥å“¡ç·¨');

            const params = {
                p_line_user_id: liffProfile.userId,
                p_employee_id: empId,
                p_device_info: navigator.userAgent,
                p_id_card_last_4: currentBindMode === 'id_card' ? idLast4 : null,
                p_verification_code: currentBindMode === 'code' ? code : null
            };

            showStatus(statusBox, 'info', 'é©—è­‰ä¸­...');
            try {
                const { data, error } = await sb.rpc('bind_employee', params);
                if (error) throw error;
                if (data.success) {
                    showStatus(statusBox, 'success', 'âœ… ç¶å®šæˆåŠŸï¼');
                    setTimeout(checkUserStatus, 1500);
                } else {
                    showStatus(statusBox, 'error', data.error);
                }
            } catch (err) {
                showStatus(statusBox, 'error', err.message);
            }
        }

        // ================= æ‰“å¡é‚è¼¯ (å«å¤šåœ°é» & è¨˜æ†¶) =================
        async function checkTodayAttendance() {
            try {
                const today = getTaiwanDate(0); // âœ… ç¢ºä¿ä½¿ç”¨å°ç£æ—¥æœŸ
                const { data } = await sb.from('attendance')
                    .select('*')
                    .eq('employee_id', currentEmployee.id)
                    .eq('date', today)
                    .single();
                
                todayAttendance = data;
                updateCheckInButtons();
            } catch(e) { console.error(e); }
        }

        function updateCheckInButtons() {
            const btnIn = document.getElementById('checkInBtn');
            const btnOut = document.getElementById('checkOutBtn');
            const statusBox = document.getElementById('checkInStatusBox');
            
            // âœ… è®€å–ä¸Šæ¬¡åœ°é»è¨˜æ†¶
            const lastLoc = localStorage.getItem('last_location') || 'å…¬å¸';

            if (!todayAttendance) {
                // æœªæ‰“å¡
                btnIn.classList.remove('disabled');
                btnOut.classList.add('disabled');
                showStatus(statusBox, 'info', `ğŸ“ ä¸Šæ¬¡æ‰“å¡åœ°é»ï¼š${lastLoc}`);
            } else if (todayAttendance.check_out_time) {
                // å·²å®Œå·¥
                btnIn.classList.add('disabled');
                btnOut.classList.add('disabled');
                showStatus(statusBox, 'success', `âœ… ä»Šæ—¥å®Œå·¥ (å·¥æ™‚ ${todayAttendance.total_work_hours?.toFixed(1)}h)`);
            } else {
                // å·¥ä½œä¸­
                btnIn.classList.add('disabled');
                btnOut.classList.remove('disabled');
                const time = new Date(todayAttendance.check_in_time).toLocaleTimeString('zh-TW', {timeZone:'Asia/Taipei', hour:'2-digit', minute:'2-digit'});
                // å˜—è©¦è§£æåœ°é»åç¨±
                const locName = todayAttendance.check_in_location?.includes('(') ? todayAttendance.check_in_location.split('(')[0] : lastLoc;
                showStatus(statusBox, 'info', `ğŸ¢ ä¸Šç­ä¸­ @ ${locName} (${time})`);
            }
        }

        function startCheckIn() { currentCheckInType='in'; showCheckInPage('ğŸ“ ä¸Šç­æ‰“å¡'); }
        function startCheckOut() { currentCheckInType='out'; showCheckInPage('ğŸ‘‹ ä¸‹ç­æ‰“å¡'); }
        function showCheckInPage(title) { document.getElementById('checkInTitle').textContent=title; showPage('checkInPage'); openCamera(); }
        function cancelCheckIn() { if(videoStream) videoStream.getTracks().forEach(t=>t.stop()); showPage('homePage'); }

        async function openCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                const video = document.getElementById('video');
                video.srcObject = stream;
                videoStream = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    document.getElementById('cameraContainer').classList.add('show');
                    document.getElementById('captureBtn').disabled = false;
                    document.getElementById('checkInStatus').textContent = 'âœ… ç›¸æ©Ÿå°±ç·’';
                };
            } catch(e) { alert('ç›¸æ©Ÿå¤±æ•—'); }
        }

        async function captureAndCheckIn() {
            const btn = document.getElementById('captureBtn');
            const statusBox = document.getElementById('checkInStatus');
            btn.disabled = true; btn.textContent = 'è™•ç†ä¸­...';
            
            try {
                // 1. æ‹ç…§
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0);
                const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.7));

                // 2. ä¸Šå‚³
                showStatus(statusBox, 'info', 'â˜ï¸ ä¸Šå‚³ä¸­...');
                const fileName = `${currentEmployee.employee_id}_${Date.now()}.jpg`;
                await sb.storage.from(CONFIG.BUCKET).upload(fileName, blob);
                const { data: { publicUrl } } = sb.storage.from(CONFIG.BUCKET).getPublicUrl(fileName);

                // 3. å®šä½
                showStatus(statusBox, 'info', 'ğŸ“ å®šä½ä¸­...');
                let loc = cachedLocation || await getGPS();

                // 4. æ‰“å¡
                const { data, error } = await sb.rpc('quick_check_in', {
                    p_line_user_id: liffProfile.userId,
                    p_latitude: loc.latitude, p_longitude: loc.longitude,
                    p_photo_url: publicUrl, p_device_id: navigator.userAgent
                });

                if (error) throw error;
                if (!data.success) throw new Error(data.error);

                // âœ… æˆåŠŸï¼šå„²å­˜åœ°é»è¨˜æ†¶
                if (data.location_name) localStorage.setItem('last_location', data.location_name);

                const typeText = data.type === 'check_in' ? 'ä¸Šç­' : 'ä¸‹ç­';
                showToast(`âœ… ${typeText}æˆåŠŸï¼@${data.location_name || 'å…¬å¸'}`);
                
                setTimeout(() => { cancelCheckIn(); checkTodayAttendance(); }, 1500);

            } catch (err) {
                showStatus(statusBox, 'error', err.message);
                btn.disabled = false; btn.textContent = 'ğŸ“¸ é‡è©¦';
            }
        }

        // ================= ä¾¿ç•¶ & è«‹å‡ & æŸ¥è©¢ (ç°¡åŒ–é‚è¼¯) =================
        async function loadLunchSummary() {
            const dateStr = getTaiwanDate(1); // æ˜å¤©
            document.getElementById('lunchDate').value = dateStr;
            const { data } = await sb.rpc('get_lunch_summary', { p_date: dateStr });
            if(data) {
                document.getElementById('totalOrders').textContent = data.total_orders;
                document.getElementById('vegCount').textContent = data.vegetarian_count;
                document.getElementById('regularCount').textContent = data.regular_count;
                if(data.is_lunar_vegetarian_day) {
                    document.getElementById('lunarNotice').classList.add('show');
                    document.getElementById('lunchVegetarian').checked = true;
                }
            }
        }

        async function submitLunchOrder() {
            const date = document.getElementById('lunchDate').value;
            const isVeg = document.getElementById('lunchVegetarian').checked;
            const notes = document.getElementById('lunchNotes').value;
            try {
                const { data, error } = await sb.rpc('order_lunch', {
                    p_line_user_id: liffProfile.userId,
                    p_order_date: date, p_is_vegetarian: isVeg, p_special_requirements: notes
                });
                if(error) throw error;
                showToast('âœ… è¨‚è³¼æˆåŠŸ'); loadLunchSummary();
            } catch(e) { showToast('å¤±æ•—:'+e.message); }
        }

        async function submitLeave() {
            const type = document.getElementById('leaveType').value;
            const start = document.getElementById('leaveStartDate').value;
            const end = document.getElementById('leaveEndDate').value;
            const reason = document.getElementById('leaveReason').value;
            
            if(!start || !end || !reason) return showToast('è«‹å¡«å¯«å®Œæ•´');
            
            try {
                const { error } = await sb.from('leave_requests').insert({
                    employee_id: currentEmployee.id, leave_type: type, start_date: start, end_date: end, reason: reason
                });
                if(error) throw error;
                showToast('âœ… ç”³è«‹æˆåŠŸ'); setTimeout(() => showPage('homePage'), 1500);
            } catch(e) { showToast('å¤±æ•—:'+e.message); }
        }

        async function loadAttendanceRecords() {
            const list = document.getElementById('attendanceList');
            const { data } = await sb.from('attendance').select('*').eq('employee_id', currentEmployee.id).order('date', {ascending:false}).limit(10);
            if(!data || !data.length) { list.innerHTML = '<p style="text-align:center;padding:20px;color:#666">ç„¡è¨˜éŒ„</p>'; return; }
            list.innerHTML = data.map(r => `
                <div class="attendance-item ${r.is_late?'late':'normal'}">
                    <div class="date">${r.date} ${r.is_late?'<span class="badge badge-warning">é²åˆ°</span>':'<span class="badge badge-success">æ­£å¸¸</span>'}</div>
                    <div class="details"><span>ä¸Šç­: ${r.check_in_time?r.check_in_time.substr(11,5):'-'}</span><span>ä¸‹ç­: ${r.check_out_time?r.check_out_time.substr(11,5):'-'}</span></div>
                </div>
            `).join('');
        }

        // ================= å·¥å…· =================
        function preloadGPS() {
            const el = document.getElementById('locationStatus');
            navigator.geolocation.getCurrentPosition(
                p => { cachedLocation = {latitude:p.coords.latitude, longitude:p.coords.longitude}; el.className='location-status ready'; el.innerHTML='<div class="dot"></div><span>å®šä½å°±ç·’</span>'; },
                e => { el.innerHTML='<span>å®šä½å¤±æ•—</span>'; },
                {timeout:10000}
            );
        }
        function getGPS() { return new Promise((res, rej) => navigator.geolocation.getCurrentPosition(p=>res({latitude:p.coords.latitude, longitude:p.coords.longitude}), e=>rej(e))); }
        function showPage(id) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id==='lunchPage') loadLunchSummary(); if(id==='attendancePage') loadAttendanceRecords(); }
        function showStatus(el, type, msg) { el.className=`status-box show ${type}`; el.textContent=msg; }
        function showToast(msg) { const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(), 3000); }
    </script>
</body>
</html>
