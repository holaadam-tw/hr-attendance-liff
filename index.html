<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>🏢 員工服務中心</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>系統載入中...</p>
    </div>

    <div class="container">
        <div id="bindPage" class="page active">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">🔐</span>
                    <h2>員工身分綁定</h2>
                    <p>初次使用請驗證身分</p>
                </div>
                <div class="tabs">
                    <button class="tab-btn active" id="tabIdCard" onclick="switchBindMode('id_card')">身分證驗證</button>
                    <button class="tab-btn inactive" id="tabCode" onclick="switchBindMode('code')">驗證碼驗證</button>
                </div>
                <div class="form-group">
                    <label>員工工號 (ID) *</label>
                    <input type="text" id="bindEmpId" placeholder="例如：EMP001" autocomplete="off">
                </div>
                <div id="modeIdCard" class="form-group">
                    <label>身分證後 4 碼 *</label>
                    <input type="tel" id="bindIdLast4" maxlength="4" placeholder="例如：1234" autocomplete="off">
                </div>
                <div id="modeCode" class="form-group hidden">
                    <label>一次性驗證碼 *</label>
                    <input type="text" id="bindCode" placeholder="請輸入 HR 提供的驗證碼" autocomplete="off">
                </div>
                <button class="btn btn-primary" onclick="handleBind()">🔗 立即綁定</button>
                <div id="bindStatus" class="status-box"></div>
            </div>
        </div>

        <div id="homePage" class="page">
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">?</div>
                    <div class="user-details">
                        <h2 id="userName">載入中...</h2>
                        <p id="userDept">-</p>
                        <p id="userId" style="font-size: 11px; opacity: 0.7;">ID: -</p>
                    </div>
                </div>
                <div class="location-status loading" id="locationStatus">
                    <div class="dot"></div><span>正在取得定位...</span>
                </div>
            </div>

            <div id="checkInStatusBox" class="status-box info"></div>

            <div class="primary-actions">
                <div class="primary-btn checkin" id="checkInBtn" onclick="startCheckIn()">
                    <span class="badge-corner">AM</span>
                    <div class="icon">☀️</div><div class="label">上班打卡</div>
                </div>
                <div class="primary-btn checkout" id="checkOutBtn" onclick="startCheckOut()">
                    <span class="badge-corner">PM</span>
                    <div class="icon">🌙</div><div class="label">下班打卡</div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="window.location.href='records.html'">
                    <div class="icon">📝</div><div class="label">我要請假</div>
                </div>
                <div class="menu-item" onclick="window.location.href='records.html#attendance'">
                    <div class="icon">📊</div><div class="label">考勤查詢</div>
                </div>
                <div class="menu-item" onclick="window.location.href='services.html'">
                    <div class="icon">🍱</div><div class="label">便當訂購</div>
                </div>
                <div class="menu-item" onclick="window.location.href='records.html#salary'">
                    <div class="icon">💰</div><div class="label">薪資查詢</div>
                </div>
                <div class="menu-item" onclick="showToast('功能開發中')">
                    <div class="icon">📅</div><div class="label">班表查詢</div>
                </div>
                <div class="menu-item" onclick="window.location.href='services.html#settings'">
                    <div class="icon">⚙️</div><div class="label">系統設定</div>
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // 首頁專用邏輯
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startCheckIn() { 
            if (document.getElementById('checkInBtn').classList.contains('disabled')) return;
            if (isProcessing) return;
            isProcessing = true;
            window.location.href = 'checkin.html?type=in';
            setTimeout(() => isProcessing = false, 1000);
        }

        function startCheckOut() { 
            if (document.getElementById('checkOutBtn').classList.contains('disabled')) return;
            if (isProcessing) return;
            isProcessing = true;
            window.location.href = 'checkin.html?type=out';
            setTimeout(() => isProcessing = false, 1000);
        }

        // 頁面載入完成後檢查用戶狀態
        window.addEventListener('load', async () => {
            const initialized = await initializeLiff();
            if (initialized) {
                const isLoggedIn = await checkUserStatus();
                if (isLoggedIn) {
                    showPage('homePage');
                    preloadGPS();
                } else {
                    showPage('bindPage');
                }
            }
        });
    </script>
</body>
</html>
