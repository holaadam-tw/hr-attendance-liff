<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loading" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container fade-in">
        <div id="bindSection" class="hidden">
            <div class="card">
                <div id="companyBanner" class="status-box info" style="margin-bottom:20px;"></div>
                <h2 style="text-align:center; margin-bottom:20px;">ğŸ” å“¡å·¥ç¶å®š</h2>
                <div class="form-group">
                    <label>å“¡å·¥å·¥è™Ÿ (ID)</label>
                    <input type="text" id="bindEmpId" placeholder="ä¾‹å¦‚ï¼šEMP001">
                </div>
                <div class="form-group">
                    <label>èº«åˆ†è­‰å¾Œ 4 ç¢¼</label>
                    <input type="tel" id="bindIdCard" maxlength="4" placeholder="ä¾‹å¦‚ï¼š1234">
                </div>
                <button class="btn btn-primary" onclick="handleBind()">ğŸ”— ç«‹å³ç¶å®š</button>
                <div id="bindStatus" class="status-box" style="margin-top:15px;"></div>
            </div>
        </div>

        <div id="menuSection" class="hidden">
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="userAvatar" style="background-image: none;">ğŸ‘¤</div>
                    <div class="user-details">
                        <h2 id="userName">è¼‰å…¥ä¸­...</h2>
                        <p id="userCompany">...</p>
                        <p id="userId" style="font-size:11px; opacity:0.7;">ID: -</p>
                    </div>
                </div>
                <div id="gpsStatus" class="status-box info" style="margin-top:15px; margin-bottom:0; font-size:12px; padding:8px;">
                    ğŸ“ æ­£åœ¨å®šä½...
                </div>
            </div>

            <div id="todayStatus" class="status-box info" style="display:none;"></div>

            <a href="checkin.html" class="btn btn-primary" style="padding:25px; margin-bottom:25px; display:flex; align-items:center; justify-content:center; gap:10px;">
                <span style="font-size:32px;">ğŸ“¸</span>
                <span style="font-size:20px;">æ‰“å¡ä½œæ¥­</span>
            </a>

            <div class="menu-grid">
                <a href="records.html#leave" class="menu-item">
                    <div class="icon">ğŸ“</div><div class="label">æˆ‘è¦è«‹å‡</div>
                </a>
                <a href="records.html#attendance" class="menu-item">
                    <div class="icon">ğŸ“Š</div><div class="label">è€ƒå‹¤æŸ¥è©¢</div>
                </a>
                <a href="services.html#lunch" class="menu-item">
                    <div class="icon">ğŸ±</div><div class="label">ä¾¿ç•¶è¨‚è³¼</div>
                </a>
                <a href="records.html#salary" class="menu-item">
                    <div class="icon">ğŸ’°</div><div class="label">è–ªè³‡æŸ¥è©¢</div>
                </a>
                <a href="services.html#settings" class="menu-item">
                    <div class="icon">âš™ï¸</div><div class="label">ç³»çµ±è¨­å®š</div>
                </a>
                <div class="menu-item" onclick="showToast('æ•¬è«‹æœŸå¾…')">
                    <div class="icon">ğŸ“…</div><div class="label">ç­è¡¨æŸ¥è©¢</div>
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        window.onload = () => initApp(async () => {
            // 1. è™•ç†å…¬å¸ä»£ç¢¼
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('company');
            if (code) {
                const { data } = await sb.rpc('get_company_info', { p_company_code: code });
                if (data && data.success) {
                    sessionStorage.setItem('target_company', data.code);
                    sessionStorage.setItem('company_name', data.name);
                }
            }

            // 2. æª¢æŸ¥ç¶å®šç‹€æ…‹
            const { data, error } = await sb.rpc('check_user_status', { p_line_user_id: liffProfile.userId });
            document.getElementById('loading').style.display = 'none';

            if (data && data.bound) {
                // å·²ç¶å®š
                document.getElementById('menuSection').classList.remove('hidden');
                document.getElementById('userName').textContent = data.employee_name;
                document.getElementById('userCompany').textContent = data.company_name;
                // é€™è£¡æš«æ™‚ç„¡æ³•å–å¾— employee_numberï¼Œå¯ä»¥é€éå¦ä¸€å€‹ RPC è£œè¶³
                
                if (liffProfile.pictureUrl) {
                    const avatar = document.getElementById('userAvatar');
                    avatar.style.backgroundImage = `url(${liffProfile.pictureUrl})`;
                    avatar.textContent = '';
                }

                // é å…ˆå®šä½
                navigator.geolocation.getCurrentPosition(
                    p => document.getElementById('gpsStatus').innerHTML = 'âœ… GPS å®šä½å®Œæˆ',
                    e => document.getElementById('gpsStatus').innerHTML = 'âŒ ç„¡æ³•å–å¾— GPS'
                );

                // æª¢æŸ¥ä»Šæ—¥æ‰“å¡
                checkTodayStatus();

            } else {
                // æœªç¶å®š
                document.getElementById('bindSection').classList.remove('hidden');
                const name = sessionStorage.getItem('company_name') || 'é è¨­å…¬å¸';
                document.getElementById('companyBanner').innerHTML = `ğŸ¢ æ‚¨æ­£åœ¨ç¶å®šï¼š<b>${name}</b>`;
            }
        });

        async function handleBind() {
            const empId = document.getElementById('bindEmpId').value;
            const idCard = document.getElementById('bindIdCard').value;
            const code = sessionStorage.getItem('target_company') || 'DEFAULT';

            if (!empId || !idCard) return showToast('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');

            showStatus('bindStatus', 'info', 'é©—è­‰ä¸­...');
            
            const { data, error } = await sb.rpc('bind_employee_secure', {
                p_company_code: code,
                p_employee_number: empId,
                p_id_card_last_4: idCard,
                p_line_user_id: liffProfile.userId,
                p_device_info: navigator.userAgent
            });

            if (error || !data.success) {
                showStatus('bindStatus', 'error', data?.error || 'ç¶å®šå¤±æ•—');
            } else {
                showStatus('bindStatus', 'success', 'âœ… ç¶å®šæˆåŠŸï¼');
                setTimeout(() => location.reload(), 1500);
            }
        }

        async function checkTodayStatus() {
            const { data } = await sb.rpc('get_today_attendance', { p_line_user_id: liffProfile.userId });
            const box = document.getElementById('todayStatus');
            
            if (data && data.success && data.has_record) {
                box.style.display = 'block';
                if (data.check_out_time) {
                    box.className = 'status-box success';
                    box.innerHTML = `âœ… ä»Šæ—¥å®Œå·¥ (å·¥æ™‚ ${data.total_work_hours}h)`;
                } else {
                    box.className = 'status-box info';
                    box.innerHTML = `ğŸ¢ ä¸Šç­ä¸­ (${data.check_in_time})`;
                }
            } else {
                box.style.display = 'block';
                box.innerHTML = 'ğŸ“ ä»Šæ—¥å°šæœªæ‰“å¡';
            }
        }
    </script>
</body>
</html>
