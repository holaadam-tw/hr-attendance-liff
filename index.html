<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>🏢 員工服務中心</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>系統載入中...</p>
    </div>

    <div class="container">
        <!-- 綁定頁面 -->
        <div id="bindPage" class="page active">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">🔐</span>
                    <h2>員工身份綁定</h2>
                    <p>初次使用請驗證身份</p>
                </div>
                <div class="tabs">
                    <button class="tab-btn active" id="tabIdCard" onclick="switchBindMode('id_card')">身份證驗證</button>
                    <button class="tab-btn inactive" id="tabCode" onclick="switchBindMode('code')">驗證碼驗證</button>
                </div>
                <div class="form-group">
                    <label>員工工號 (ID) *</label>
                    <input type="text" id="bindEmpId" placeholder="例如：EMP001" autocomplete="off">
                </div>
                <div id="modeIdCard" class="form-group">
                    <label>身份證後 4 碼 *</label>
                    <input type="tel" id="bindIdLast4" maxlength="4" placeholder="例如：1234" autocomplete="off">
                </div>
                <div id="modeCode" class="form-group hidden">
                    <label>一次性驗證碼 *</label>
                    <input type="text" id="bindCode" placeholder="請輸入 HR 提供的驗證碼" autocomplete="off">
                </div>
                <button class="btn btn-primary" onclick="handleBind()">🔗 立即綁定</button>
                <div id="bindStatus" class="status-box"></div>
            </div>
        </div>

        <!-- 首頁 -->
        <div id="homePage" class="page">
            <!-- 用戶卡片 -->
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">?</div>
                    <div class="user-details">
                        <h2 id="userName">載入中...</h2>
                        <p id="userDept">-</p>
                        <p id="userId" style="font-size: 11px; opacity: 0.7;">ID: -</p>
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
                        <span class="user-status-badge" id="userStatusBadge" style="background:#D1FAE5;color:#065F46;">-</span>
                        <span class="user-status-badge" id="userTypeBadge" style="background:#DBEAFE;color:#1E40AF;display:none;font-size:10px;">正職</span>
                    </div>
                </div>
                <div class="location-status loading" id="locationStatus">
                    <div class="dot"></div><span>正在取得定位...</span>
                </div>
            </div>

            <!-- 今日資訊卡 -->
            <div class="card" style="padding:16px;">
                <!-- 公告橫幅 -->
                <div id="announcementBanner" style="display:none;margin-bottom:12px;"></div>

                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <span style="font-size:14px;font-weight:700;color:#0F172A;">📋 今日資訊</span>
                    <span id="todayDate" style="font-size:12px;color:#64748B;"></span>
                </div>
                <div class="today-info">
                    <div class="today-info-item" id="todayShiftCard" style="background:#DBEAFE;">
                        <div class="today-info-label" style="color:#1E40AF;">今日班別</div>
                        <div class="today-info-value" id="todayShift" style="color:#1E40AF;">早班</div>
                        <div class="today-info-sub" style="color:#1E40AF;">08:00 - 17:00</div>
                    </div>
                    <div class="today-info-item" id="todayCheckinCard" style="background:#D1FAE5;">
                        <div class="today-info-label" style="color:#065F46;">上班打卡</div>
                        <div class="today-info-value" id="todayCheckinTime" style="color:#059669;">--:--</div>
                        <div class="today-info-sub" id="todayCheckinStatus" style="color:#065F46;">尚未打卡</div>
                    </div>
                    <div class="today-info-item" style="background:#F1F5F9;">
                        <div class="today-info-label" style="color:#64748B;">下班打卡</div>
                        <div class="today-info-value" id="todayCheckoutTime" style="color:#64748B;">--:--</div>
                        <div class="today-info-sub" id="todayCheckoutStatus" style="color:#64748B;">尚未打卡</div>
                    </div>
                </div>
            </div>

            <div id="checkInStatusBox" class="status-box info"></div>

            <!-- 打卡按鈕 -->
            <div class="primary-actions">
                <div class="primary-btn checkin" id="checkInBtn" onclick="startCheckIn()">
                    <div class="icon">☀️</div>
                    <div class="label">上班打卡</div>
                    <span class="badge-corner">AM</span>
                </div>
                <div class="primary-btn checkout" id="checkOutBtn" onclick="startCheckOut()">
                    <div class="icon">🌙</div>
                    <div class="label">下班打卡</div>
                    <span class="badge-corner">PM</span>
                </div>
            </div>

            <!-- 精簡選單（移除與底部導航重複的項目）-->
            <div class="menu-grid">
                <div class="menu-item" onclick="window.location.href='records.html'">
                    <div class="icon">📝</div><div class="label">我要請假</div>
                </div>
                <div class="menu-item" onclick="window.location.href='services.html'">
                    <div class="icon">🍱</div><div class="label">便當訂購</div>
                </div>
                <div class="menu-item" onclick="window.location.href='records.html#attendance'">
                    <div class="icon">📊</div><div class="label">考勤查詢</div>
                </div>
                <!-- 管理員專用 -->
                <div class="menu-item admin-only" id="adminEntry" style="display:none;" onclick="window.location.href='admin.html'">
                    <span class="menu-badge"></span>
                    <div class="icon">👑</div><div class="label">管理後台</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部導航列由 common.js initBottomNav() 動態產生 -->

    <script src="config.js"></script>
    <script src="common.js"></script>
    <script>
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goPage(url) {
            window.location.href = url;
        }

        function startCheckIn() { 
            if (document.getElementById('checkInBtn')?.classList.contains('disabled')) return;
            if (isProcessing) return;
            isProcessing = true;
            window.location.href = 'checkin.html?type=in';
            setTimeout(() => isProcessing = false, 1000);
        }

        function startCheckOut() { 
            if (document.getElementById('checkOutBtn')?.classList.contains('disabled')) return;
            if (isProcessing) return;
            isProcessing = true;
            window.location.href = 'checkin.html?type=out';
            setTimeout(() => isProcessing = false, 1000);
        }

        // 更新今日資訊
        function updateTodayInfo() {
            const now = new Date();
            const days = ['日', '一', '二', '三', '四', '五', '六'];
            const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} 週${days[now.getDay()]}`;
            const el = document.getElementById('todayDate');
            if (el) el.textContent = dateStr;
        }

        // 載入今日打卡狀態（重用 checkTodayAttendance() 已取得的 todayAttendance，避免重複 API）
        function loadTodayStatus() {
            const data = todayAttendance;
            const badgeEl = document.getElementById('userStatusBadge');

            if (data?.check_in_time) {
                const inTime = new Date(data.check_in_time);
                const timeStr = `${String(inTime.getHours()).padStart(2,'0')}:${String(inTime.getMinutes()).padStart(2,'0')}`;
                document.getElementById('todayCheckinTime').textContent = timeStr;

                const isLate = data.is_late || data.status === 'late';
                document.getElementById('todayCheckinStatus').textContent = isLate ? '⚠️ 遲到' : '✅ 準時';
                document.getElementById('todayCheckinCard').style.background = isLate ? '#FEE2E2' : '#D1FAE5';
                document.getElementById('todayCheckinTime').style.color = isLate ? '#EF4444' : '#059669';

                if (badgeEl) {
                    badgeEl.textContent = '✅ 已打卡';
                    badgeEl.style.background = '#D1FAE5';
                    badgeEl.style.color = '#065F46';
                }
            } else {
                if (badgeEl) {
                    badgeEl.textContent = '⏳ 未打卡';
                    badgeEl.style.background = '#FEF3C7';
                    badgeEl.style.color = '#92400E';
                }
            }

            if (data?.check_out_time) {
                const outTime = new Date(data.check_out_time);
                const timeStr = `${String(outTime.getHours()).padStart(2,'0')}:${String(outTime.getMinutes()).padStart(2,'0')}`;
                document.getElementById('todayCheckoutTime').textContent = timeStr;
                document.getElementById('todayCheckoutStatus').textContent = '✅ 已下班';
            }
        }

        // 載入員工類型（正職/兼職）
        async function loadEmployeeType() {
            if (!currentEmployee) return;
            try {
                const { data } = await sb.from('salary_settings')
                    .select('salary_type')
                    .eq('employee_id', currentEmployee.id)
                    .eq('is_current', true)
                    .maybeSingle();
                
                const badge = document.getElementById('userTypeBadge');
                if (badge && data) {
                    badge.style.display = 'inline-block';
                    if (data.salary_type === 'monthly') {
                        badge.textContent = '正職';
                        badge.style.background = '#DBEAFE';
                        badge.style.color = '#1E40AF';
                    } else if (data.salary_type === 'hourly') {
                        badge.textContent = '時薪';
                        badge.style.background = '#FEF3C7';
                        badge.style.color = '#92400E';
                    } else if (data.salary_type === 'daily') {
                        badge.textContent = '日薪';
                        badge.style.background = '#FEF3C7';
                        badge.style.color = '#92400E';
                    }
                }
            } catch(e) { console.log('載入員工類型失敗', e); }
        }

        function checkLiffParams() {
            try {
                if (liff && liff.isInClient()) {
                    const liffParams = liff.getContext();
                    if (liffParams?.type === 'utim' && liffParams.utm) {
                        const urlParams = new URLSearchParams(liffParams.utm);
                        const company = urlParams.get('company');
                        if (company) sessionStorage.setItem('company_code', company);
                    }
                }
            } catch(e) {}
            const urlParams = new URLSearchParams(window.location.search);
            const company = urlParams.get('company');
            if (company) sessionStorage.setItem('company_code', company);
        }

        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') {
                console.error('common.js 未正確載入');
                return;
            }
            
            const initialized = await initializeLiff();
            if (initialized) {
                checkLiffParams();
                
                const isLoggedIn = await checkUserStatus();
                if (isLoggedIn) {
                    showPage('homePage');
                    updateTodayInfo();
                    initBottomNav();

                    // checkIsAdmin 現在是同步的，直接判斷
                    if (checkIsAdmin()) {
                        const adminEntry = document.getElementById('adminEntry');
                        if (adminEntry) adminEntry.style.display = 'block';
                    }

                    // [優化] loadTodayStatus 直接使用已取得的 todayAttendance，不再額外查詢
                    loadTodayStatus();

                    // [優化] 平行發送所有獨立的 API 請求
                    Promise.all([
                        loadEmployeeType(),
                        loadAnnouncements(),
                        checkForcedAnnouncements()
                    ].map(p => Promise.resolve(p).catch(e => console.error(e))));
                    applyFeatureVisibility();
                    preloadGPS();
                } else {
                    showPage('bindPage');
                }
            }
        });
    </script>
</body>
</html>
