<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¢ å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <!-- ç¶å®šé é¢ -->
        <div id="bindPage" class="page active">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">ğŸ”</span>
                    <h2>å“¡å·¥èº«ä»½ç¶å®š</h2>
                    <p>åˆæ¬¡ä½¿ç”¨è«‹é©—è­‰èº«ä»½</p>
                </div>
                <div class="tabs">
                    <button class="tab-btn active" id="tabIdCard" onclick="switchBindMode('id_card')">èº«ä»½è­‰é©—è­‰</button>
                    <button class="tab-btn inactive" id="tabCode" onclick="switchBindMode('code')">é©—è­‰ç¢¼é©—è­‰</button>
                </div>
                <div class="form-group">
                    <label>å“¡å·¥å·¥è™Ÿ (ID) *</label>
                    <input type="text" id="bindEmpId" placeholder="ä¾‹å¦‚ï¼šEMP001" autocomplete="off">
                </div>
                <div id="modeIdCard" class="form-group">
                    <label>èº«ä»½è­‰å¾Œ 4 ç¢¼ *</label>
                    <input type="tel" id="bindIdLast4" maxlength="4" placeholder="ä¾‹å¦‚ï¼š1234" autocomplete="off">
                </div>
                <div id="modeCode" class="form-group hidden">
                    <label>ä¸€æ¬¡æ€§é©—è­‰ç¢¼ *</label>
                    <input type="text" id="bindCode" placeholder="è«‹è¼¸å…¥ HR æä¾›çš„é©—è­‰ç¢¼" autocomplete="off">
                </div>
                <button class="btn btn-primary" onclick="handleBind()">ğŸ”— ç«‹å³ç¶å®š</button>
                <div id="bindStatus" class="status-box"></div>
            </div>
        </div>

        <!-- é¦–é  -->
        <div id="homePage" class="page">
            <!-- ç”¨æˆ¶å¡ç‰‡ -->
            <div class="user-card">
                <div id="homeCompanyName" style="font-size:13px;font-weight:700;color:#4F46E5;margin-bottom:8px;display:none;"></div>
                <div class="user-info">
                    <div class="avatar" id="userAvatar">?</div>
                    <div class="user-details">
                        <h2 id="userName">è¼‰å…¥ä¸­...</h2>
                        <p id="userDept">-</p>
                        <p id="userId" style="font-size: 11px; opacity: 0.7;">ID: -</p>
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
                        <span class="user-status-badge" id="userStatusBadge" style="background:#D1FAE5;color:#065F46;">-</span>
                        <span class="user-status-badge" id="userTypeBadge" style="background:#DBEAFE;color:#1E40AF;display:none;font-size:10px;">æ­£è·</span>
                    </div>
                </div>
                <div class="location-status loading" id="locationStatus">
                    <div class="dot"></div><span>æ­£åœ¨å–å¾—å®šä½...</span>
                </div>
            </div>

            <!-- ä»Šæ—¥è³‡è¨Šå¡ -->
            <div class="card" style="padding:16px;">
                <!-- å…¬å‘Šæ©«å¹… -->
                <div id="announcementBanner" style="display:none;margin-bottom:12px;"></div>

                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <span style="font-size:14px;font-weight:700;color:#0F172A;">ğŸ“‹ ä»Šæ—¥è³‡è¨Š</span>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span id="weatherInfo" style="font-size:12px;color:#64748B;display:none;"></span>
                        <span id="todayDate" style="font-size:12px;color:#64748B;"></span>
                    </div>
                </div>
                <div class="today-info">
                    <div class="today-info-item" id="todayShiftCard" style="background:#DBEAFE;">
                        <div class="today-info-label" style="color:#1E40AF;">ä»Šæ—¥ç­åˆ¥</div>
                        <div class="today-info-value" id="todayShift" style="color:#1E40AF;">æ—©ç­</div>
                        <div class="today-info-sub" style="color:#1E40AF;">08:00 - 17:00</div>
                    </div>
                    <div class="today-info-item" id="todayCheckinCard" style="background:#D1FAE5;">
                        <div class="today-info-label" style="color:#065F46;">ä¸Šç­æ‰“å¡</div>
                        <div class="today-info-value" id="todayCheckinTime" style="color:#059669;">--:--</div>
                        <div class="today-info-sub" id="todayCheckinStatus" style="color:#065F46;">å°šæœªæ‰“å¡</div>
                    </div>
                    <div class="today-info-item" style="background:#F1F5F9;">
                        <div class="today-info-label" style="color:#64748B;">ä¸‹ç­æ‰“å¡</div>
                        <div class="today-info-value" id="todayCheckoutTime" style="color:#64748B;">--:--</div>
                        <div class="today-info-sub" id="todayCheckoutStatus" style="color:#64748B;">å°šæœªæ‰“å¡</div>
                    </div>
                </div>
            </div>

            <div id="checkInStatusBox" class="status-box info"></div>

            <!-- æ‰“å¡æŒ‰éˆ• -->
            <div class="primary-actions">
                <div class="primary-btn checkin" id="checkInBtn" onclick="startCheckIn()">
                    <div class="icon">â˜€ï¸</div>
                    <div class="label">ä¸Šç­æ‰“å¡</div>
                    <span class="badge-corner">AM</span>
                </div>
                <div class="primary-btn checkout" id="checkOutBtn" onclick="startCheckOut()">
                    <div class="icon">ğŸŒ™</div>
                    <div class="label">ä¸‹ç­æ‰“å¡</div>
                    <span class="badge-corner">PM</span>
                </div>
            </div>

            <!-- ç›®å‰è¨‚å–® -->
            <div id="activeOrdersCard" class="card" style="padding:16px;display:none;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <span style="font-size:14px;font-weight:700;color:#0F172A;">ğŸ›’ ç›®å‰è¨‚å–®</span>
                    <span id="activeOrdersBadge" style="font-size:11px;padding:2px 10px;border-radius:10px;background:#FEF3C7;color:#92400E;font-weight:600;">0 ç­†å¾…è™•ç†</span>
                </div>
                <div id="activeOrdersList" style="display:flex;flex-direction:column;gap:8px;"></div>
                <button onclick="window.location.href='admin.html#restaurant'" style="width:100%;margin-top:12px;padding:10px;border:1.5px solid #E2E8F0;border-radius:10px;background:#fff;font-size:13px;font-weight:600;color:#4F46E5;cursor:pointer;font-family:inherit;">æŸ¥çœ‹å…¨éƒ¨è¨‚å–® â†’</button>
            </div>

            <!-- ç²¾ç°¡é¸å–®ï¼ˆç§»é™¤èˆ‡åº•éƒ¨å°èˆªé‡è¤‡çš„é …ç›®ï¼‰-->
            <div class="menu-grid">
                <div class="menu-item" data-feature="leave" onclick="window.location.href='records.html'">
                    <div class="icon">ğŸ“</div><div class="label">æˆ‘è¦è«‹å‡</div>
                </div>
                <div class="menu-item" data-feature="lunch" onclick="window.location.href='services.html'">
                    <div class="icon">ğŸ±</div><div class="label">ä¾¿ç•¶è¨‚è³¼</div>
                </div>
                <div class="menu-item" data-feature="attendance" onclick="window.location.href='records.html#attendance'">
                    <div class="icon">ğŸ“Š</div><div class="label">è€ƒå‹¤æŸ¥è©¢</div>
                </div>
                <div class="menu-item" data-feature="fieldwork,sales_target" onclick="window.location.href='services.html#fieldwork'">
                    <div class="icon">ğŸ“</div><div class="label">å¤–å‹¤/æ¥­å‹™</div>
                </div>
                <div class="menu-item" data-feature="store_ordering" onclick="window.location.href='order.html'">
                    <div class="icon">ğŸ›ï¸</div><div class="label">ç·šä¸Šé»é¤</div>
                </div>
                <!-- ç®¡ç†å“¡å°ˆç”¨ -->
                <div class="menu-item admin-only" id="adminEntry" style="display:none;" onclick="window.location.href='admin.html'">
                    <span class="menu-badge"></span>
                    <div class="icon">ğŸ‘‘</div><div class="label">ç®¡ç†å¾Œå°</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªåˆ—ç”± common.js initBottomNav() å‹•æ…‹ç”¢ç”Ÿ -->

    <script src="common.js"></script>
    <script>
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goPage(url) {
            window.location.href = url;
        }

        function startCheckIn() { 
            if (document.getElementById('checkInBtn')?.classList.contains('disabled')) return;
            if (isProcessing) return;
            isProcessing = true;
            window.location.href = 'checkin.html?type=in';
            setTimeout(() => isProcessing = false, 1000);
        }

        function startCheckOut() { 
            if (document.getElementById('checkOutBtn')?.classList.contains('disabled')) return;
            if (isProcessing) return;
            isProcessing = true;
            window.location.href = 'checkin.html?type=out';
            setTimeout(() => isProcessing = false, 1000);
        }

        // æ›´æ–°ä»Šæ—¥è³‡è¨Š
        function updateTodayInfo() {
            const now = new Date();
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} é€±${days[now.getDay()]}`;
            const el = document.getElementById('todayDate');
            if (el) el.textContent = dateStr;
        }

        // è¼‰å…¥ä»Šæ—¥æ‰“å¡ç‹€æ…‹ï¼ˆé‡ç”¨ checkTodayAttendance() å·²å–å¾—çš„ todayAttendanceï¼Œé¿å…é‡è¤‡ APIï¼‰
        function loadTodayStatus() {
            const data = todayAttendance;
            const badgeEl = document.getElementById('userStatusBadge');

            if (data?.check_in_time) {
                const inTime = new Date(data.check_in_time);
                const timeStr = `${String(inTime.getHours()).padStart(2,'0')}:${String(inTime.getMinutes()).padStart(2,'0')}`;
                document.getElementById('todayCheckinTime').textContent = timeStr;

                const isLate = data.is_late || data.status === 'late';
                document.getElementById('todayCheckinStatus').textContent = isLate ? 'âš ï¸ é²åˆ°' : 'âœ… æº–æ™‚';
                document.getElementById('todayCheckinCard').style.background = isLate ? '#FEE2E2' : '#D1FAE5';
                document.getElementById('todayCheckinTime').style.color = isLate ? '#EF4444' : '#059669';

                if (badgeEl) {
                    badgeEl.textContent = 'âœ… å·²æ‰“å¡';
                    badgeEl.style.background = '#D1FAE5';
                    badgeEl.style.color = '#065F46';
                }
            } else {
                if (badgeEl) {
                    badgeEl.textContent = 'â³ æœªæ‰“å¡';
                    badgeEl.style.background = '#FEF3C7';
                    badgeEl.style.color = '#92400E';
                }
            }

            if (data?.check_out_time) {
                const outTime = new Date(data.check_out_time);
                const timeStr = `${String(outTime.getHours()).padStart(2,'0')}:${String(outTime.getMinutes()).padStart(2,'0')}`;
                document.getElementById('todayCheckoutTime').textContent = timeStr;
                document.getElementById('todayCheckoutStatus').textContent = 'âœ… å·²ä¸‹ç­';
            }
        }

        // è¼‰å…¥å“¡å·¥é¡å‹ï¼ˆæ­£è·/å…¼è·ï¼‰
        async function loadEmployeeType() {
            if (!currentEmployee) return;
            try {
                const { data } = await sb.from('salary_settings')
                    .select('salary_type')
                    .eq('employee_id', currentEmployee.id)
                    .eq('is_current', true)
                    .maybeSingle();
                
                const badge = document.getElementById('userTypeBadge');
                if (badge && data) {
                    badge.style.display = 'inline-block';
                    if (data.salary_type === 'monthly') {
                        badge.textContent = 'æ­£è·';
                        badge.style.background = '#DBEAFE';
                        badge.style.color = '#1E40AF';
                    } else if (data.salary_type === 'hourly') {
                        badge.textContent = 'æ™‚è–ª';
                        badge.style.background = '#FEF3C7';
                        badge.style.color = '#92400E';
                    } else if (data.salary_type === 'daily') {
                        badge.textContent = 'æ—¥è–ª';
                        badge.style.background = '#FEF3C7';
                        badge.style.color = '#92400E';
                    }
                }
            } catch(e) { console.log('è¼‰å…¥å“¡å·¥é¡å‹å¤±æ•—', e); }
        }

        // å¤©æ°£
        const WMO_WEATHER = {
            0:'â˜€ï¸ æ™´', 1:'ğŸŒ¤ï¸ æ™´', 2:'â›… å¤šé›²', 3:'â˜ï¸ é™°',
            45:'ğŸŒ«ï¸ éœ§', 48:'ğŸŒ«ï¸ éœ§', 51:'ğŸŒ¦ï¸ å°é›¨', 53:'ğŸŒ§ï¸ é›¨',
            55:'ğŸŒ§ï¸ å¤§é›¨', 61:'ğŸŒ¦ï¸ å°é›¨', 63:'ğŸŒ§ï¸ é›¨', 65:'ğŸŒ§ï¸ å¤§é›¨',
            71:'ğŸŒ¨ï¸ å°é›ª', 73:'ğŸŒ¨ï¸ é›ª', 75:'ğŸŒ¨ï¸ å¤§é›ª', 80:'ğŸŒ¦ï¸ é™£é›¨',
            81:'ğŸŒ§ï¸ é™£é›¨', 82:'â›ˆï¸ æš´é›¨', 95:'â›ˆï¸ é›·é›¨', 96:'â›ˆï¸ é›·é›¨', 99:'â›ˆï¸ é›·é›¨'
        };
        async function loadWeather() {
            try {
                let lat = 25.033, lon = 121.565; // é è¨­å°åŒ—
                if (cachedLocation) {
                    lat = cachedLocation.latitude; lon = cachedLocation.longitude;
                } else {
                    try {
                        const loc = await getGPS();
                        lat = loc.latitude; lon = loc.longitude;
                    } catch(e) { /* GPS å¤±æ•—ï¼Œä½¿ç”¨é è¨­åº§æ¨™ */ }
                }
                // å¤©æ°£ + åœ°ååŒæ™‚å–å¾—
                const [weatherRes, geoRes] = await Promise.all([
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=Asia%2FTaipei`),
                    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&zoom=10&accept-language=zh-TW`).catch(() => null)
                ]);
                const weather = await weatherRes.json();
                const temp = Math.round(weather.current.temperature_2m);
                const code = weather.current.weather_code;
                const desc = WMO_WEATHER[code] || 'ğŸŒ¡ï¸';
                // å–åœ°åï¼ˆå¸‚/å€ï¼‰
                let city = '';
                try {
                    if (geoRes?.ok) {
                        const geo = await geoRes.json();
                        city = geo.address?.city || geo.address?.county || geo.address?.town || geo.address?.state || '';
                        city = city.replace(/å¸‚$|ç¸£$/, ''); // å°åŒ—å¸‚ â†’ å°åŒ—
                    }
                } catch(e) {}
                const el = document.getElementById('weatherInfo');
                if (el) {
                    el.textContent = `${city ? city + ' ' : ''}${desc} ${temp}Â°C`;
                    el.style.display = 'inline';
                }
            } catch(e) { console.log('å¤©æ°£è¼‰å…¥å¤±æ•—', e); }
        }

        // è¼‰å…¥ç›®å‰è¨‚å–®
        async function loadActiveOrders() {
            const card = document.getElementById('activeOrdersCard');
            const badge = document.getElementById('activeOrdersBadge');
            const list = document.getElementById('activeOrdersList');

            // ç®¡ç†å“¡ä¸€å¾‹é¡¯ç¤ºæ­¤å€å¡Š
            card.style.display = '';

            try {
                // å…ˆæŸ¥è©²å…¬å¸çš„å•†åº—
                let storeQ = sb.from('store_profiles').select('id, store_name');
                if (currentCompanyId) storeQ = storeQ.or('company_id.eq.' + currentCompanyId + ',company_id.is.null');
                const { data: stores } = await storeQ;

                if (!stores || stores.length === 0) {
                    badge.textContent = 'å°šç„¡å•†åº—';
                    badge.style.background = '#F1F5F9';
                    badge.style.color = '#94A3B8';
                    list.innerHTML = '<div style="text-align:center;padding:16px;color:#94A3B8;font-size:13px;">è«‹å…ˆè‡³ç®¡ç†å¾Œå°æ–°å¢å•†åº—</div>';
                    return;
                }

                const storeIds = stores.map(s => s.id);
                const storeMap = {};
                stores.forEach(s => storeMap[s.id] = s.store_name);

                // æŸ¥é€²è¡Œä¸­çš„è¨‚å–®ï¼ˆå¾…è™•ç† + å·²ç¢ºèª + æº–å‚™ä¸­ + å¯å–é¤ï¼‰
                const { data: orders } = await sb.from('orders')
                    .select('id, order_number, pickup_number, store_id, status, total, items, table_number, created_at')
                    .in('store_id', storeIds)
                    .in('status', ['pending', 'confirmed', 'preparing', 'ready'])
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (!orders || orders.length === 0) {
                    badge.textContent = 'ç›®å‰ç„¡è¨‚å–®';
                    badge.style.background = '#D1FAE5';
                    badge.style.color = '#059669';
                    list.innerHTML = '<div style="text-align:center;padding:16px;color:#94A3B8;font-size:13px;">ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„è¨‚å–®</div>';
                    return;
                }

                // çµ±è¨ˆ
                const pendingCount = orders.filter(o => o.status === 'pending').length;
                if (pendingCount > 0) {
                    badge.textContent = pendingCount + ' ç­†å¾…è™•ç†';
                    badge.style.background = '#FEE2E2';
                    badge.style.color = '#DC2626';
                } else {
                    badge.textContent = orders.length + ' ç­†é€²è¡Œä¸­';
                    badge.style.background = '#DBEAFE';
                    badge.style.color = '#1E40AF';
                }

                // æ¸²æŸ“è¨‚å–®åˆ—è¡¨
                const statusMap = {
                    pending:   { label: 'å¾…è™•ç†', color: '#92400E', bg: '#FEF3C7' },
                    confirmed: { label: 'å·²ç¢ºèª', color: '#1E40AF', bg: '#DBEAFE' },
                    preparing: { label: 'æº–å‚™ä¸­', color: '#7C3AED', bg: '#F5F3FF' },
                    ready:     { label: 'å¯å–é¤', color: '#059669', bg: '#D1FAE5' }
                };
                list.innerHTML = orders.map(o => {
                    const st = statusMap[o.status] || { label: o.status, color: '#64748B', bg: '#F1F5F9' };
                    const time = o.created_at ? new Date(o.created_at).toLocaleString('zh-TW', { hour: '2-digit', minute: '2-digit' }) : '';
                    const itemCount = (o.items || []).reduce((s, i) => s + (i.qty || 1), 0);
                    const pickup = o.pickup_number ? '#' + String(o.pickup_number).padStart(3, '0') : '';
                    const storeName = stores.length > 1 ? '<span style="font-size:11px;color:#94A3B8;">' + (storeMap[o.store_id] || '') + '</span>' : '';
                    return '<div style="background:#F8FAFC;border:1px solid #E2E8F0;border-radius:10px;padding:10px 12px;cursor:pointer;" onclick="window.location.href=\'admin.html#restaurant\'">' +
                        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">' +
                        '<span style="font-weight:700;font-size:13px;">' + pickup + ' #' + (o.order_number || '').slice(-4) + '</span>' +
                        '<span style="font-size:11px;font-weight:600;padding:2px 8px;border-radius:8px;background:' + st.bg + ';color:' + st.color + ';">' + st.label + '</span></div>' +
                        '<div style="font-size:12px;color:#64748B;">' +
                        (o.table_number ? 'æ¡Œ' + o.table_number + ' Â· ' : '') +
                        itemCount + 'å“ Â· $' + o.total + ' Â· ' + time +
                        '</div>' + storeName + '</div>';
                }).join('');
            } catch(e) {
                console.log('è¼‰å…¥è¨‚å–®å¤±æ•—', e);
                list.innerHTML = '<div style="text-align:center;padding:16px;color:#94A3B8;font-size:13px;">è¨‚å–®è¼‰å…¥å¤±æ•—</div>';
            }
        }

        function checkLiffParams() {
            try {
                if (liff && liff.isInClient()) {
                    const liffParams = liff.getContext();
                    if (liffParams?.type === 'utim' && liffParams.utm) {
                        const urlParams = new URLSearchParams(liffParams.utm);
                        const company = urlParams.get('company');
                        if (company) sessionStorage.setItem('company_code', company);
                    }
                }
            } catch(e) {}
            const urlParams = new URLSearchParams(window.location.search);
            const company = urlParams.get('company');
            if (company) sessionStorage.setItem('company_code', company);
        }

        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') {
                console.error('common.js æœªæ­£ç¢ºè¼‰å…¥');
                return;
            }
            
            const initialized = await initializeLiff();
            if (initialized) {
                checkLiffParams();
                
                const isLoggedIn = await checkUserStatus();
                if (isLoggedIn) {
                    showPage('homePage');
                    updateTodayInfo();
                    initBottomNav();

                    // é¡¯ç¤ºå…¬å¸åç¨±
                    if (currentCompanyName) {
                        const el = document.getElementById('homeCompanyName');
                        if (el) { el.textContent = currentCompanyName; el.style.display = 'block'; }
                    }

                    // admin å’Œ manager éƒ½å¯é€²ç®¡ç†å¾Œå°
                    if (currentEmployee && (currentEmployee.role === 'admin' || currentEmployee.role === 'manager')) {
                        const adminEntry = document.getElementById('adminEntry');
                        if (adminEntry) adminEntry.style.display = 'block';
                    }

                    // [å„ªåŒ–] loadTodayStatus ç›´æ¥ä½¿ç”¨å·²å–å¾—çš„ todayAttendanceï¼Œä¸å†é¡å¤–æŸ¥è©¢
                    loadTodayStatus();

                    // [å„ªåŒ–] å¹³è¡Œç™¼é€æ‰€æœ‰ç¨ç«‹çš„ API è«‹æ±‚
                    const tasks = [
                        loadEmployeeType(),
                        loadAnnouncements(),
                        checkForcedAnnouncements(),
                        loadWeather()
                    ];
                    // ç®¡ç†å“¡è¼‰å…¥ç›®å‰è¨‚å–®
                    if (currentEmployee.role === 'admin' || currentEmployee.role === 'manager') {
                        tasks.push(loadActiveOrders());
                    }
                    Promise.all(tasks.map(p => Promise.resolve(p).catch(e => console.error(e))));
                    applyFeatureVisibility();
                    preloadGPS();
                } else {
                    showPage('bindPage');
                }
            }
        });
    </script>
</body>
</html>
