<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¢ HR è€ƒå‹¤æ‰“å¡ç³»çµ±</title>
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    
    <style>
        /* ================= UI æ¨£å¼å€ ================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang TC", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }

        .container {
            background: white; border-radius: 25px; padding: 40px 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 450px; width: 100%; animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(30px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .header { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 28px; color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; font-size: 14px; }

        .user-info { 
            background: #f8f9fa; padding: 15px; border-radius: 12px; 
            margin-bottom: 25px; display: none; border-left: 5px solid #667eea;
        }
        .user-info.show { display: block; }
        .user-name { font-weight: bold; color: #333; font-size: 16px; margin-bottom: 5px; }
        .user-id { color: #666; font-size: 12px; font-family: monospace; }

        /* ç›¸æ©Ÿå€å¡Š */
        .camera-container {
            position: relative; width: 100%; height: 300px; background: #000;
            border-radius: 15px; overflow: hidden; margin-bottom: 20px; display: none;
        }
        .camera-container.show { display: block; }
        
        #videoPreview {
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);
        }
        
        .camera-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border: 3px solid rgba(255, 255, 255, 0.5); border-radius: 15px; pointer-events: none;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        #checkInBtn {
            width: 100%; padding: 18px; font-size: 18px; font-weight: bold; color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none; border-radius: 15px; cursor: pointer; transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        #checkInBtn:active { transform: scale(0.98); box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3); }
        #checkInBtn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        /* ç‹€æ…‹è¨Šæ¯ */
        .status {
            margin-top: 20px; padding: 15px; border-radius: 12px; text-align: center;
            font-weight: 500; display: none; animation: fadeIn 0.3s; font-size: 14px;
        }
        .status.show { display: block; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .loading-spinner {
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white;
            border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .details { margin-top: 10px; font-size: 12px; opacity: 0.9; text-align: left; line-height: 1.6; }
        .info-text { text-align: center; color: #999; font-size: 12px; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ è€ƒå‹¤æ‰“å¡ç³»çµ±</h1>
            <p class="subtitle">GPS å®šä½ + çœŸäººè‡ªæ‹é©—è­‰</p>
        </div>

        <div class="user-info" id="userInfo">
            <div class="user-name" id="userName">è¼‰å…¥ä¸­...</div>
            <div class="user-id" id="userId"></div>
        </div>

        <div class="camera-container" id="cameraContainer">
            <video id="videoPreview" autoplay playsinline muted></video>
            <div class="camera-overlay"></div>
        </div>

        <button id="checkInBtn">
            ğŸ“ ç«‹å³æ‰“å¡
        </button>

        <div class="status" id="statusMsg"></div>

        <div class="info-text">
            ç³»çµ±å°‡è‡ªå‹•åµæ¸¬ä½ç½®ä¸¦æ‹æ”ç…§ç‰‡
        </div>
    </div>

    <script>
        // ========================================
        // 1. åˆå§‹åŒ– vConsole (é™¤éŒ¯å·¥å…·)
        // ========================================
        const vConsole = new window.VConsole();
        console.log('âœ… vConsole å·²å•Ÿå‹•');

        // ========================================
        // 2. è¨­å®šå€åŸŸ (Configuration)
        // ========================================
        const CONFIG = {
            LIFF_ID: '2008962829-bnsS1bbB',
            SUPABASE_URL: 'https://nssuisyvlrqnqfxupklb.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3Vpc3l2bHJxbnFmeHVwa2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTAwMzUsImV4cCI6MjA4NDg2NjAzNX0.q_B6v3gf1TOCuAq7z0xIw10wDueCSJn0p37VzdMfmbc',
            STORAGE_BUCKET: 'selfies'
        };

        // ========================================
        // 3. åˆå§‹åŒ– Supabase
        // âš ï¸ ä½¿ç”¨ 'sb' ä½œç‚ºè®Šæ•¸åç¨±ï¼Œé¿å…èˆ‡ SDK è¡çª
        // ========================================
        const sb = window.supabase.createClient(
            CONFIG.SUPABASE_URL, 
            CONFIG.SUPABASE_ANON_KEY
        );
        console.log('âœ… Supabase åˆå§‹åŒ–å®Œæˆ');

        // å…¨åŸŸè®Šæ•¸
        let liffProfile = null;
        let videoStream = null;

        // ========================================
        // 4. åˆå§‹åŒ– LIFF
        // ========================================
        window.addEventListener('load', async () => {
            try {
                // è‡ªå‹•åŸ·è¡Œæ‰“å¡æŒ‰éˆ•ç¶å®š
                document.getElementById('checkInBtn').addEventListener('click', startCheckIn);

                showStatus('info', 'ç³»çµ±åˆå§‹åŒ–ä¸­...');
                
                await liff.init({ liffId: CONFIG.LIFF_ID });
                console.log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
                
                if (!liff.isLoggedIn()) {
                    console.log('âš ï¸ æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                    liff.login();
                    return;
                }

                liffProfile = await liff.getProfile();
                console.log('âœ… å–å¾—ç”¨æˆ¶è³‡æ–™:', liffProfile);
                
                // æ›´æ–° UI é¡¯ç¤ºç”¨æˆ¶è³‡æ–™
                document.getElementById('userName').textContent = liffProfile.displayName;
                document.getElementById('userId').textContent = `ID: ${liffProfile.userId.substring(0, 10)}...`;
                document.getElementById('userInfo').classList.add('show');

                hideStatus();

            } catch (error) {
                console.error('âŒ LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                showStatus('error', `åˆå§‹åŒ–å¤±æ•—: ${error.message}<br><small>LIFF ID: ${CONFIG.LIFF_ID}</small>`);
            }
        });

        // ========================================
        // 5. æ ¸å¿ƒæ‰“å¡æµç¨‹
        // ========================================
        async function startCheckIn() {
            const btn = document.getElementById('checkInBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>è™•ç†ä¸­...';
            hideStatus();

            try {
                if (!liffProfile) throw new Error('æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†é é¢');

                // Step 1: é–‹å•Ÿç›¸æ©Ÿ
                showStatus('info', 'ğŸ“· å•Ÿå‹•ç›¸æ©Ÿä¸­...');
                await openCamera();

                // Step 2: ç·©è¡æ™‚é–“ (è®“ç›¸æ©Ÿå°ç„¦)
                await new Promise(r => setTimeout(r, 1500));

                // Step 3: æ‹ç…§
                showStatus('info', 'ğŸ“¸ æ­£åœ¨æ‹ç…§...');
                const photoBlob = await capturePhoto();

                // Step 4: ä¸Šå‚³ç…§ç‰‡
                showStatus('info', 'â˜ï¸ ä¸Šå‚³ç…§ç‰‡ä¸­...');
                const photoUrl = await uploadPhoto(photoBlob);

                // Step 5: å–å¾— GPS
                showStatus('info', 'ğŸ“¡ æ­£åœ¨ç²¾æº–å®šä½...');
                const position = await getGPS();

                // Step 6: å¯«å…¥è³‡æ–™åº«
                showStatus('info', 'â³ æ­£åœ¨æ‰“å¡...');
                const result = await callCheckInAPI(position, photoUrl);

                // Step 7: æˆåŠŸè™•ç†
                if (result.success) {
                    showStatus('success', `
                        <strong>ğŸ‰ ${result.message}</strong><br>
                        <div class="details">
                            ğŸ“… æ™‚é–“ï¼š${new Date(result.time).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}<br>
                            ğŸ“ è·é›¢ï¼š${result.distance} å…¬å°º<br>
                            ${result.work_hours ? `â±ï¸ å·¥æ™‚ï¼š${result.work_hours} å°æ™‚` : ''}
                        </div>
                    `);
                    
                    // æˆåŠŸå¾Œ 3 ç§’é—œé–‰è¦–çª—
                    setTimeout(() => {
                        if (liff.isInClient()) liff.closeWindow();
                    }, 3000);
                } else {
                    // âœ… æ”¹é€²ï¼šæä¾›æ›´å¤šéŒ¯èª¤ä¾†æº
                    throw new Error(
                        result.error || 
                        result.message || 
                        'æ‰“å¡å¤±æ•—ï¼Œè«‹é‡è©¦æˆ–è¯çµ¡ç®¡ç†å“¡'
                    );
                }

            } catch (error) {
                console.error('æ‰“å¡å¤±æ•—:', error);
                let msg = error.message;
                
                // é‡å°å¸¸è¦‹éŒ¯èª¤æä¾›æ›´å‹å–„çš„æç¤º
                if (msg.includes('è·é›¢')) {
                    showStatus('error', `âŒ <strong>è·é›¢å¤ªé </strong><br>${msg}<br><small>è«‹ç§»å‹•åˆ°å…¬å¸ç¯„åœå…§</small>`);
                } else if (msg.includes('æ‰¾ä¸åˆ°å“¡å·¥')) {
                    showStatus('error', `âŒ <strong>æ‰¾ä¸åˆ°å“¡å·¥è³‡æ–™</strong><br>ç³»çµ±ç„¡æ­¤ LINE å¸³è™Ÿè³‡æ–™<br><small>è«‹è¯çµ¡ HR æˆ–ç®¡ç†å“¡</small>`);
                } else {
                    showStatus('error', `âŒ <strong>æ‰“å¡å¤±æ•—</strong><br>${msg}`);
                }
            } finally {
                // ç„¡è«–æˆåŠŸå¤±æ•—ï¼Œæœ€å¾Œéƒ½é—œé–‰ç›¸æ©Ÿä¸¦æ¢å¾©æŒ‰éˆ•
                closeCamera();
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“ ç«‹å³æ‰“å¡';
            }
        }

        // ========================================
        // 6. åŠŸèƒ½æ¨¡çµ„ (ç›¸æ©Ÿ / GPS / API)
        // ========================================
        
        // --- ç›¸æ©ŸåŠŸèƒ½ (âœ… æ”¹é€²ï¼šç²¾ç¢ºéŒ¯èª¤è¨Šæ¯) ---
        async function openCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false
                });
                const video = document.getElementById('videoPreview');
                video.srcObject = videoStream;
                document.getElementById('cameraContainer').classList.add('show');
                
                // ç¢ºä¿ iOS Safari èƒ½è‡ªå‹•æ’­æ”¾ (å«è¶…æ™‚ä¿è­·)
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => reject(new Error('ç›¸æ©Ÿå•Ÿå‹•é€¾æ™‚')), 8000);
                    
                    if (video.readyState >= 2) {
                        clearTimeout(timeout);
                        video.play().then(resolve).catch(reject);
                    } else {
                        video.onloadedmetadata = () => {
                            clearTimeout(timeout);
                            video.play().then(resolve).catch(reject);
                        };
                    }
                });
            } catch (error) {
                console.error('ç›¸æ©ŸéŒ¯èª¤:', error);
                
                // âœ… æ”¹é€²ï¼šæ ¹æ“šéŒ¯èª¤é¡å‹æä¾›ç²¾ç¢ºæç¤º
                if (error.name === 'NotAllowedError') {
                    throw new Error('è«‹å…è¨±å­˜å–ç›¸æ©Ÿæ¬Šé™');
                } else if (error.name === 'NotFoundError') {
                    throw new Error('æ‰¾ä¸åˆ°ç›¸æ©Ÿè£ç½®');
                } else if (error.name === 'NotReadableError') {
                    throw new Error('ç›¸æ©Ÿè¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½”ç”¨');
                } else if (error.name === 'OverconstrainedError') {
                    throw new Error('ç„¡æ³•æ»¿è¶³ç›¸æ©Ÿéœ€æ±‚');
                } else {
                    throw new Error(`ç›¸æ©ŸéŒ¯èª¤: ${error.message}`);
                }
            }
        }

        // --- æ‹ç…§åŠŸèƒ½ ---
        async function capturePhoto() {
            const video = document.getElementById('videoPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // æª¢æŸ¥ç›¸æ©Ÿæ˜¯å¦çœŸçš„æœ‰ç•«é¢
            if (canvas.width === 0 || canvas.height === 0) {
                throw new Error('ç›¸æ©Ÿå°šæœªæº–å‚™å¥½');
            }

            const ctx = canvas.getContext('2d');
            // è™•ç†é¡åƒç¿»è½‰
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);

            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => reject(new Error('ç…§ç‰‡è™•ç†é€¾æ™‚')), 5000);
                
                canvas.toBlob(blob => {
                    clearTimeout(timeout);
                    if (blob) resolve(blob);
                    else reject(new Error('ç…§ç‰‡è½‰æ›å¤±æ•—'));
                }, 'image/jpeg', 0.7);
            });
        }

        function closeCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            document.getElementById('cameraContainer').classList.remove('show');
        }

        // --- GPS åŠŸèƒ½ ---
        async function getGPS() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) return reject(new Error('è£ç½®ä¸æ”¯æ´ GPS'));

                navigator.geolocation.getCurrentPosition(
                    pos => resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude }),
                    err => {
                        let msg = 'å®šä½å¤±æ•—';
                        if (err.code === 1) msg = 'è«‹å…è¨±ç€è¦½å™¨å­˜å–ä½ç½®';
                        if (err.code === 2) msg = 'ç„¡æ³•åµæ¸¬ä½ç½®ï¼Œè«‹ç§»å‹•åˆ°æˆ¶å¤–';
                        if (err.code === 3) msg = 'å®šä½é€¾æ™‚ï¼Œè«‹é‡è©¦';
                        reject(new Error(msg));
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            });
        }

        // --- Supabase API ---
        async function uploadPhoto(photoBlob) {
            const fileName = `${liffProfile.userId}_${Date.now()}.jpg`;
            const { error } = await sb.storage
                .from(CONFIG.STORAGE_BUCKET)
                .upload(fileName, photoBlob, { contentType: 'image/jpeg', upsert: false });

            if (error) throw new Error('ç…§ç‰‡ä¸Šå‚³å¤±æ•—: ' + error.message);

            const { data } = sb.storage.from(CONFIG.STORAGE_BUCKET).getPublicUrl(fileName);
            return data.publicUrl;
        }

        async function callCheckInAPI(position, photoUrl) {
            const { data, error } = await sb.rpc('quick_check_in', {
                p_line_user_id: liffProfile.userId,
                p_latitude: position.latitude,
                p_longitude: position.longitude,
                p_photo_url: photoUrl,
                p_device_id: navigator.userAgent
            });

            if (error) throw new Error(error.message || 'API å‘¼å«å¤±æ•—');
            return data;
        }

        // --- UI è¼”åŠ© ---
        function showStatus(type, htmlContent) {
            const statusDiv = document.getElementById('statusMsg');
            statusDiv.className = `status ${type} show`;
            statusDiv.innerHTML = htmlContent;
        }

        function hideStatus() {
            document.getElementById('statusMsg').classList.remove('show');
        }
    </script>
</body>
</html>
