<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¢ HR è€ƒå‹¤æ‰“å¡ç³»çµ±</title>
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang TC", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .container {
            background: white; border-radius: 25px; padding: 40px 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 450px; width: 100%; animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .header { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 28px; color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; font-size: 14px; }
        .user-info { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 25px; display: none; }
        .user-info.show { display: block; }
        .user-name { font-weight: bold; color: #333; font-size: 16px; margin-bottom: 5px; }
        .user-id { color: #666; font-size: 12px; }
        
        /* ç›¸æ©Ÿé è¦½å€ */
        .camera-container {
            position: relative; width: 100%; height: 300px; background: #000;
            border-radius: 15px; overflow: hidden; margin-bottom: 20px; display: none;
        }
        .camera-container.show { display: block; }
        #videoPreview {
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); /* é¡åƒç¿»è½‰ */
        }
        .camera-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border: 3px solid rgba(255, 255, 255, 0.5); border-radius: 15px; pointer-events: none;
        }
        .camera-guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 200px; height: 250px; border: 2px dashed rgba(255, 255, 255, 0.7);
            border-radius: 100px; pointer-events: none;
        }
        .countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 100px; color: white; font-weight: bold;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.8); display: none; z-index: 10;
        }
        .countdown.show { display: block; animation: countdownPulse 1s ease-in-out; }
        @keyframes countdownPulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        #checkInBtn {
            width: 100%; padding: 18px; font-size: 18px; font-weight: bold; color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none; border-radius: 15px; cursor: pointer; transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        #checkInBtn:active { transform: scale(0.98); box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3); }
        #checkInBtn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        .status {
            margin-top: 20px; padding: 15px; border-radius: 12px; text-align: center;
            font-weight: 500; display: none; animation: fadeIn 0.3s;
        }
        .status.show { display: block; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .loading {
            display: inline-block; width: 20px; height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid white;
            border-radius: 50%; animation: spin 0.8s linear infinite;
            vertical-align: middle; margin-right: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .details { margin-top: 10px; font-size: 13px; opacity: 0.9; }
        .info-text { text-align: center; color: #999; font-size: 12px; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ è€ƒå‹¤æ‰“å¡ç³»çµ±</h1>
            <p class="subtitle">GPS å®šä½ + äººè‡‰è¾¨è­˜</p>
        </div>

        <div class="user-info" id="userInfo">
            <div class="user-name" id="userName">è¼‰å…¥ä¸­...</div>
            <div class="user-id" id="userId"></div>
        </div>

        <div class="camera-container" id="cameraContainer">
            <video id="videoPreview" autoplay playsinline muted></video> <div class="camera-overlay"></div>
            <div class="camera-guide"></div>
            <div class="countdown" id="countdown">3</div>
        </div>

        <button id="checkInBtn" onclick="startCheckIn()">
            ğŸ“ ç«‹å³æ‰“å¡
        </button>

        <div class="status" id="statusMsg"></div>
        <div class="info-text">
            é»æ“ŠæŒ‰éˆ•å¾Œç³»çµ±æœƒè‡ªå‹•åµæ¸¬ä½ç½®ä¸¦æ‹ç…§
        </div>
    </div>

    <script>
        // ========================================
        // è¨­å®šå€åŸŸ (å·²ä¿®æ­£ ID èˆ‡ URL)
        // ========================================
        const CONFIG = {
            // âœ… å·²ä¿®æ­£ï¼šä½¿ç”¨æ‚¨æœ€æ–°çš„æ­£ç¢º LIFF ID
            LIFF_ID: '2008962829-bnsS1bbB', 
            
            // âœ… å·²ä¿®æ­£ï¼šä¿®æ­£ URL æ‹¼å­—éŒ¯èª¤ (å»æ‰å¤šé¤˜çš„ 's')
            SUPABASE_URL: 'https://nssuisyvlrqnqfxupklb.supabase.co',
            
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3Vpc3l2bHJxbnFmeHVwa2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTAwMzUsImV4cCI6MjA4NDg2NjAzNX0.q_B6v3gf1TOCuAq7z0xIw10wDueCSJn0p37VzdMfmbc',
            
            STORAGE_BUCKET: 'selfies',
            ENABLE_COUNTDOWN: true,
            COUNTDOWN_SECONDS: 3
        };

        const supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        let liffProfile = null;
        let videoStream = null;

        // ========================================
        // åˆå§‹åŒ– LIFF
        // ========================================
        window.addEventListener('load', async () => {
            try {
                // å˜—è©¦åˆå§‹åŒ– LIFF
                await liff.init({ liffId: CONFIG.LIFF_ID });
                
                // è™•ç†ç™»å…¥é‚è¼¯
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                liffProfile = await liff.getProfile();
                document.getElementById('userName').textContent = liffProfile.displayName;
                document.getElementById('userId').textContent = `å“¡å·¥ ID: ${liffProfile.userId.substring(0, 10)}...`;
                document.getElementById('userInfo').classList.add('show');
                
            } catch (error) {
                console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                // é¡¯ç¤ºæ›´å‹å–„çš„éŒ¯èª¤è¨Šæ¯ï¼ŒåŒ…å« LIFF ID ä»¥ä¾¿é™¤éŒ¯
                showStatus('error', `ç³»çµ±åˆå§‹åŒ–å¤±æ•—<br><small>${error.message}</small><br><small>LIFF ID: ${CONFIG.LIFF_ID}</small>`);
            }
        });

        // ========================================
        // æ‰“å¡ä¸»æµç¨‹
        // ========================================
        async function startCheckIn() {
            const btn = document.getElementById('checkInBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>æº–å‚™ä¸­...';
            hideStatus();

            try {
                // 1. é–‹å•Ÿç›¸æ©Ÿ
                showStatus('info', 'ğŸ“· æ­£åœ¨é–‹å•Ÿç›¸æ©Ÿ...');
                await openCamera();

                // 2. å€’æ•¸
                if (CONFIG.ENABLE_COUNTDOWN) {
                    await showCountdown();
                }

                // 3. æ‹ç…§
                showStatus('info', 'ğŸ“¸ æ­£åœ¨æ‹ç…§...');
                const photoBlob = await capturePhoto();

                // 4. ä¸Šå‚³
                showStatus('info', 'â˜ï¸ æ­£åœ¨ä¸Šå‚³ç…§ç‰‡...');
                const photoUrl = await uploadPhoto(photoBlob);

                // 5. å®šä½
                showStatus('info', 'ğŸ“¡ æ­£åœ¨å–å¾— GPS ä½ç½®...');
                const position = await getGPS();

                // 6. æ‰“å¡
                showStatus('info', 'â³ æ­£åœ¨å¯«å…¥è€ƒå‹¤ç´€éŒ„...');
                const result = await callCheckInAPI(position, photoUrl);

                // 7. æˆåŠŸ
                if (result.success) {
                    showStatus('success', `
                        ${result.message}<br>
                        <div class="details">
                            æ™‚é–“ï¼š${new Date(result.time).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}<br>
                            è·é›¢ï¼š${result.distance} å…¬å°º
                            ${result.work_hours ? `<br>å·¥æ™‚ï¼š${result.work_hours} å°æ™‚` : ''}
                        </div>
                    `);
                    setTimeout(() => { if (liff.isInClient()) liff.closeWindow(); }, 3000);
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error(error);
                let errMsg = error.message || 'æ‰“å¡å¤±æ•—';
                // å¦‚æœæ˜¯è·é›¢éé ï¼Œçµ¦äºˆæ˜ç¢ºæç¤º
                if (errMsg.includes('è·é›¢å…¬å¸å¤ªé ')) {
                    showStatus('error', `âŒ æ‰“å¡å¤±æ•—<br>${errMsg}<br><small>è«‹ç§»å‹•åˆ°å…¬å¸ç¯„åœå…§å†è©¦</small>`);
                } else {
                    showStatus('error', `âŒ æ‰“å¡å¤±æ•—: ${errMsg}`);
                }
            } finally {
                closeCamera();
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“ ç«‹å³æ‰“å¡';
            }
        }

        // ========================================
        // ç›¸æ©ŸåŠŸèƒ½
        // ========================================
        async function openCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false
                });
                const video = document.getElementById('videoPreview');
                video.srcObject = videoStream;
                document.getElementById('cameraContainer').classList.add('show');
                
                // ç¢ºä¿å½±ç‰‡è¼‰å…¥ä¸¦æ’­æ”¾ (iOS Safari éœ€è¦)
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
            } catch (error) {
                throw new Error('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™ã€‚');
            }
        }

        async function showCountdown() {
            const countdownDiv = document.getElementById('countdown');
            for (let i = CONFIG.COUNTDOWN_SECONDS; i > 0; i--) {
                countdownDiv.textContent = i;
                countdownDiv.classList.add('show');
                countdownDiv.style.animation = 'none';
                void countdownDiv.offsetWidth; // Trigger reflow
                countdownDiv.style.animation = '';
                await new Promise(r => setTimeout(r, 1000));
            }
            countdownDiv.classList.remove('show');
        }

        async function capturePhoto() {
            const video = document.getElementById('videoPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
        }

        function closeCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            document.getElementById('cameraContainer').classList.remove('show');
        }

        // ========================================
        // GPS åŠŸèƒ½
        // ========================================
        async function getGPS() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('æ‚¨çš„è£ç½®ä¸æ”¯æ´ GPS å®šä½'));
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    pos => resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude }),
                    err => {
                        let msg = 'GPS å®šä½å¤±æ•—';
                        if (err.code === 1) msg = 'è«‹å…è¨±ç€è¦½å™¨å­˜å–æ‚¨çš„ä½ç½®'; // Permission Denied
                        if (err.code === 2) msg = 'ç„¡æ³•åµæ¸¬ä½ç½®ï¼Œè«‹ç§»å‹•åˆ°ç©ºæ› è™•'; // Position Unavailable
                        if (err.code === 3) msg = 'GPS å®šä½é€¾æ™‚ï¼Œè«‹é‡è©¦'; // Timeout
                        reject(new Error(msg));
                    },
                    { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 } // timeout æ”¹ç‚º 20ç§’
                );
            });
        }

        // ========================================
        // Supabase åŠŸèƒ½
        // ========================================
        async function uploadPhoto(photoBlob) {
            const fileName = `${liffProfile.userId}_${Date.now()}.jpg`;
            const { data, error } = await supabase.storage
                .from(CONFIG.STORAGE_BUCKET)
                .upload(fileName, photoBlob, { contentType: 'image/jpeg', upsert: false });

            if (error) throw new Error('ç…§ç‰‡ä¸Šå‚³å¤±æ•—');
            const { data: urlData } = supabase.storage.from(CONFIG.STORAGE_BUCKET).getPublicUrl(fileName);
            return urlData.publicUrl;
        }

        async function callCheckInAPI(position, photoUrl) {
            const { data, error } = await supabase.rpc('quick_check_in', {
                p_line_user_id: liffProfile.userId,
                p_latitude: position.latitude,
                p_longitude: position.longitude,
                p_photo_url: photoUrl,
                p_device_id: navigator.userAgent.substring(0, 100)
            });
            if (error) throw new Error(error.message || 'ç³»çµ±éŒ¯èª¤');
            return data;
        }

        function showStatus(type, message) {
            const statusDiv = document.getElementById('statusMsg');
            statusDiv.className = `status ${type} show`;
            statusDiv.innerHTML = message;
        }
        function hideStatus() {
            document.getElementById('statusMsg').classList.remove('show');
        }
    </script>
</body>
</html>
