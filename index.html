<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¢ å“¡å·¥æ‰“å¡ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #0284c7; --bg: #f0f9ff; }
        body { font-family: sans-serif; background: var(--bg); padding: 20px; color: #333; }
        .page { display: none; } .page.active { display: block; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn:disabled { opacity: 0.6; }
        input { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .company-banner { background: #e0f2fe; color: #075985; padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 20px; font-weight: bold; border: 1px solid #bae6fd; }
        .list-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <div id="loading" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); color:white; display:flex; justify-content:center; align-items:center; z-index:999;">è¼‰å…¥ä¸­...</div>

    <div class="container">
        <div id="bindPage" class="page">
            <div class="card">
                <div id="companyBanner"></div>
                <h2 style="text-align:center;">ğŸ” å“¡å·¥ç¶å®š</h2>
                <label>å·¥è™Ÿ</label><input type="text" id="bindEmpId" placeholder="ä¾‹å¦‚ï¼šEMP001">
                <label style="margin-top:10px; display:block;">èº«åˆ†è­‰å¾Œ4ç¢¼</label><input type="tel" id="bindIdCard" maxlength="4">
                <button class="btn" onclick="handleBind()">ç«‹å³ç¶å®š</button>
            </div>
        </div>

        <div id="homePage" class="page">
            <div class="card">
                <h2 id="userName">ä½ å¥½</h2>
                <p id="userCompany" style="color:#666;"></p>
            </div>
            <button class="btn" onclick="showPage('checkInPage')">ğŸ“¸ æ‰“å¡</button>
            <button class="btn" onclick="showPage('historyPage')" style="background:#64748b;">ğŸ“Š æŸ¥è©¢è€ƒå‹¤</button>
        </div>

        <div id="checkInPage" class="page">
            <div class="card">
                <h2 style="text-align:center;">ğŸ“ æ‰“å¡</h2>
                <video id="video" autoplay playsinline style="width:100%; background:black; border-radius:12px;"></video>
                <canvas id="canvas" style="display:none;"></canvas>
                <button id="captureBtn" class="btn" onclick="executeCheckIn()">æ‹ç…§ä¸¦æ‰“å¡</button>
                <button class="btn" onclick="showPage('homePage')" style="background:#94a3b8;">å–æ¶ˆ</button>
            </div>
        </div>

        <div id="historyPage" class="page">
            <div class="card">
                <h2>ğŸ“Š æœ¬æœˆè€ƒå‹¤</h2>
                <div id="historyList">è¼‰å…¥ä¸­...</div>
                <button class="btn" onclick="showPage('homePage')" style="background:#94a3b8;">è¿”å›</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            LIFF_ID: '2008962829-bnsS1bbB',
            SUPABASE_URL: 'https://nssuisyvlrqnqfxupklb.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3Vpc3l2bHJxbnFmeHVwa2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTAwMzUsImV4cCI6MjA4NDg2NjAzNX0.q_B6v3gf1TOCuAq7z0xIw10wDueCSJn0p37VzdMfmbc',
            BUCKET: 'selfies'
        };
        const sb = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        let liffProfile = null;

        window.onload = async () => {
            try {
                // 1. è™•ç†ç¶²å€åƒæ•¸èˆ‡å…¬å¸è³‡è¨Š
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('company');
                
                if (code) {
                    // å¦‚æœæœ‰ä»£ç¢¼ï¼Œå‘å¾Œç«¯æŸ¥è©¢å…¬å¸åç¨±
                    const { data } = await sb.rpc('get_company_info', { p_company_code: code });
                    if (data && data.success) {
                        localStorage.setItem('target_company', code);
                        localStorage.setItem('company_name', data.name);
                    }
                }

                // 2. LIFF åˆå§‹åŒ–
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                liffProfile = await liff.getProfile();
                
                // 3. æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                await checkLogin();
            } catch (e) {
                console.error(e);
                alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—');
            }
        };

        async function checkLogin() {
            const { data, error } = await sb.rpc('check_user_status', {
                p_line_user_id: liffProfile.userId
            });

            document.getElementById('loading').style.display = 'none';

            if (error) {
                alert('ç³»çµ±éŒ¯èª¤: ' + error.message);
                return;
            }

            if (data && data.bound) {
                document.getElementById('userName').textContent = `ä½ å¥½ï¼Œ${data.employee_name}`;
                document.getElementById('userCompany').textContent = data.company_name;
                showPage('homePage');
            } else {
                // æœªç¶å®šï¼Œé¡¯ç¤ºç¶å®šé 
                const code = localStorage.getItem('target_company') || 'DEFAULT';
                const name = localStorage.getItem('company_name') || 'é è¨­å…¬å¸';
                document.getElementById('companyBanner').innerHTML = `ğŸ¢ æ‚¨æ­£åœ¨ç¶å®šï¼š<br>${name}`;
                showPage('bindPage');
            }
        }

        async function handleBind() {
            const empId = document.getElementById('bindEmpId').value.trim();
            const idCard = document.getElementById('bindIdCard').value.trim();
            const code = localStorage.getItem('target_company') || 'DEFAULT';

            if(!empId || !idCard) return alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');

            const { data, error } = await sb.rpc('bind_employee_secure', {
                p_company_code: code,
                p_employee_number: empId,
                p_id_card_last_4: idCard,
                p_line_user_id: liffProfile.userId,
                p_device_info: navigator.userAgent
            });

            if(error || !data.success) alert('ç¶å®šå¤±æ•—: ' + (data?.error || error?.message || 'æœªçŸ¥éŒ¯èª¤'));
            else {
                alert(`âœ… ç¶å®šæˆåŠŸï¼æ­¡è¿ ${data.employee_name}`);
                location.reload();
            }
        }

        async function executeCheckIn() {
            const btn = document.getElementById('captureBtn');
            btn.disabled = true; btn.textContent = 'è™•ç†ä¸­...';
            
            try {
                // æ‹ç…§
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.5));

                // ä¸Šå‚³
                const fileName = `${liffProfile.userId}_${Date.now()}.jpg`;
                const { error: uploadError } = await sb.storage.from(CONFIG.BUCKET).upload(fileName, blob);
                if(uploadError) throw new Error('ç…§ç‰‡ä¸Šå‚³å¤±æ•—');

                const { data: urlData } = sb.storage.from(CONFIG.BUCKET).getPublicUrl(fileName);
                const photoUrl = urlData?.publicUrl || urlData?.publicURL;

                // å®šä½èˆ‡æ‰“å¡
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const { data, error } = await sb.rpc('quick_check_in_v2', {
                        p_line_user_id: liffProfile.userId,
                        p_latitude: pos.coords.latitude,
                        p_longitude: pos.coords.longitude,
                        p_photo_url: photoUrl,
                        p_device_id: navigator.userAgent
                    });

                    if(error || !data.success) alert('æ‰“å¡å¤±æ•—: ' + (data?.error || error?.message));
                    else {
                        alert('âœ… ' + data.message);
                        showPage('homePage');
                    }
                    btn.disabled = false; btn.textContent = 'æ‹ç…§ä¸¦æ‰“å¡';
                }, (err) => {
                    alert('ç„¡æ³•å–å¾—ä½ç½®: ' + err.message);
                    btn.disabled = false;
                }, { timeout: 10000 });

            } catch(e) {
                console.error(e);
                alert('éŒ¯èª¤: ' + e.message);
                btn.disabled = false; btn.textContent = 'æ‹ç…§ä¸¦æ‰“å¡';
            }
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                document.getElementById('video').srcObject = stream;
            } catch (err) {
                alert('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™');
                showPage('homePage');
            }
        }

        async function loadHistory() {
            const date = new Date();
            const { data } = await sb.rpc('get_monthly_attendance_v2', {
                p_line_user_id: liffProfile.userId,
                p_year: date.getFullYear(),
                p_month: date.getMonth() + 1
            });
            
            const list = document.getElementById('historyList');
            if(!data || data.length === 0) list.innerHTML = 'ç„¡è¨˜éŒ„';
            else {
                list.innerHTML = data.map(r => `
                    <div class="list-item">
                        <span>${r.date}</span>
                        <span>${r.check_in_time || '--'} - ${r.check_out_time || '--'}</span>
                    </div>
                `).join('');
            }
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'checkInPage') startCamera();
            if(id === 'historyPage') loadHistory();
        }
    </script>
</body>
</html>
