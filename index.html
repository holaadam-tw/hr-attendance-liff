<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¢ å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* ================= UI æ¨£å¼å€ ================= */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --bg-color: #f3f4f6;
            --text-color: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh; padding: 20px; color: var(--text-color);
            padding-bottom: 50px; 
        }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* é é¢åˆ‡æ›èˆ‡å‹•ç•« */
        .page { display: none; animation: fadeIn 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card, .user-card, .checkin-page {
            background: white; border-radius: 20px; padding: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-bottom: 20px;
        }

        /* ç¶å®šé é¢ */
        .bind-header { text-align: center; margin-bottom: 20px; }
        .bind-header .logo { font-size: 50px; display: block; margin-bottom: 10px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .tab-btn.active { background: var(--primary-color); color: white; box-shadow: 0 4px 6px rgba(102, 126, 234, 0.25); }
        .tab-btn.inactive { background: #e5e7eb; color: #6b7280; }

        /* é¦–é ç”¨æˆ¶è³‡è¨Š */
        .user-info { display: flex; align-items: center; gap: 15px; }
        .avatar {
            width: 64px; height: 64px; border-radius: 50%;
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; color: white; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .user-details h2 { font-size: 20px; margin-bottom: 4px; color: #1f2937; }
        .user-details p { font-size: 13px; color: #6b7280; }

        /* GPS ç‹€æ…‹åˆ— */
        .location-status {
            display: flex; align-items: center; gap: 8px; margin-top: 15px;
            padding: 10px 15px; border-radius: 12px; font-size: 13px; font-weight: 500;
            transition: all 0.3s;
        }
        .location-status.loading { background: #fffbeb; color: #92400e; }
        .location-status.ready { background: #d1fae5; color: #065f46; }
        .location-status .dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: currentColor; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }

        /* ä¸»è¦æ‰“å¡æŒ‰éˆ• */
        .primary-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .primary-btn {
            background: white; border-radius: 16px; padding: 20px 15px; text-align: center;
            cursor: pointer; transition: transform 0.1s, box-shadow 0.3s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; overflow: hidden;
        }
        .primary-btn:active { transform: scale(0.96); }
        .primary-btn.checkin { border-bottom: 4px solid var(--primary-color); }
        .primary-btn.checkout { border-bottom: 4px solid #f472b6; }
        .primary-btn.disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
        .primary-btn .icon { font-size: 36px; margin-bottom: 8px; display: block; }
        .primary-btn .label { font-size: 16px; font-weight: 700; color: #374151; }
        .primary-btn .badge-corner {
            position: absolute; top: 8px; right: 8px; font-size: 10px; 
            background: #f3f4f6; padding: 2px 6px; border-radius: 4px; color: #6b7280;
        }

        /* ä¹å®®æ ¼é¸å–® */
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .menu-item {
            background: rgba(255,255,255,0.9); border-radius: 16px; padding: 15px 5px; text-align: center;
            cursor: pointer; transition: all 0.2s; backdrop-filter: blur(5px);
        }
        .menu-item:active { background: rgba(255,255,255,1); transform: scale(0.95); }
        .menu-item .icon { font-size: 28px; margin-bottom: 5px; display: block; }
        .menu-item .label { font-size: 12px; font-weight: 600; color: #4b5563; }

        /* è¡¨å–®å…ƒç´  */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #4b5563; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px;
            transition: border-color 0.3s; background: #f9fafb;
        }
        .form-group input:focus { outline: none; border-color: var(--primary-color); background: white; }
        .form-group textarea { min-height: 100px; resize: vertical; }

        /* æŒ‰éˆ• */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn-success { background: linear-gradient(135deg, #34d399 0%, #059669 100%); color: white; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); }
        .btn-secondary { background: #e5e7eb; color: #4b5563; }
        .btn-danger { background: #ff4d4f; color: white; margin-top: 0; padding: 8px 15px; font-size: 14px; width: auto;}

        /* ä¾¿ç•¶èˆ‡è¾²æ›† */
        .lunch-summary { background: #f0fdf4; border: 1px solid #d1fae5; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #a7f3d0; }
        .stat-row:last-child { border-bottom: none; }
        .lunar-notice { background: #fff7ed; border-left: 4px solid #f59e0b; padding: 12px; margin-bottom: 15px; border-radius: 8px; font-size: 13px; color: #92400e; display: none; }
        .lunar-notice.show { display: block; }

        /* ç‹€æ…‹è¨Šæ¯ */
        .status-box { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center; font-size: 14px; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .status-box.show { display: block; animation: fadeIn 0.3s; }
        .status-box.success { border-left: 5px solid #10b981; color: #065f46; }
        .status-box.error { border-left: 5px solid #ef4444; color: #7f1d1d; }
        .status-box.info { border-left: 5px solid #3b82f6; color: #1e3a8a; }

        /* ç›¸æ©Ÿ */
        .camera-container {
            position: relative; width: 100%; aspect-ratio: 3/4; margin: 0 auto 20px;
            border-radius: 16px; overflow: hidden; background: #000; display: none;
        }
        .camera-container.show { display: block; }
        #video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* è€ƒå‹¤åˆ—è¡¨èˆ‡ Badge */
        .attendance-item {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #ddd;
        }
        .attendance-item.late { border-left-color: #ef4444; }
        .attendance-item.normal { border-left-color: #10b981; }
        .attendance-item .date { font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .attendance-item .details { font-size: 13px; color: #6b7280; display: flex; justify-content: space-between; }
        
        /* Badge æ¨£å¼ */
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-success { background: #d1fae5; color: #065f46; }

        /* å·¥å…·é¡ */
        .hidden { display: none !important; }
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-color); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(17, 24, 39, 0.9); color: white; padding: 12px 24px;
            border-radius: 50px; font-size: 14px; z-index: 10000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            animation: fadeInOut 3s forwards;
        }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, -20px); } 10% { opacity: 1; transform: translate(-50%, 0); } 90% { opacity: 1; transform: translate(-50%, 0); } 100% { opacity: 0; transform: translate(-50%, -20px); } }
    </style>
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <div id="bindPage" class="page">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">ğŸ”</span>
                    <h2>å“¡å·¥èº«åˆ†ç¶å®š</h2>
                    <p>åˆæ¬¡ä½¿ç”¨è«‹é©—è­‰èº«åˆ†</p>
                </div>
                <div class="tabs">
                    <button class="tab-btn active" id="tabIdCard" onclick="switchBindMode('id_card')">èº«åˆ†è­‰é©—è­‰</button>
                    <button class="tab-btn inactive" id="tabCode" onclick="switchBindMode('code')">é©—è­‰ç¢¼é©—è­‰</button>
                </div>
                <div class="form-group">
                    <label>å“¡å·¥å·¥è™Ÿ (ID) *</label>
                    <input type="text" id="bindEmpId" placeholder="ä¾‹å¦‚ï¼šEMP001" autocomplete="off">
                </div>
                <div id="modeIdCard" class="form-group">
                    <label>èº«åˆ†è­‰å¾Œ 4 ç¢¼ *</label>
                    <input type="tel" id="bindIdLast4" maxlength="4" placeholder="ä¾‹å¦‚ï¼š1234" autocomplete="off">
                </div>
                <div id="modeCode" class="form-group hidden">
                    <label>ä¸€æ¬¡æ€§é©—è­‰ç¢¼ *</label>
                    <input type="text" id="bindCode" placeholder="è«‹è¼¸å…¥ HR æä¾›çš„é©—è­‰ç¢¼" autocomplete="off">
                </div>
                <button class="btn btn-primary" onclick="handleBind()">ğŸ”— ç«‹å³ç¶å®š</button>
                <div id="bindStatus" class="status-box"></div>
            </div>
        </div>

        <div id="homePage" class="page">
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">?</div>
                    <div class="user-details">
                        <h2 id="userName">è¼‰å…¥ä¸­...</h2>
                        <p id="userDept">-</p>
                        <p id="userId" style="font-size: 11px; opacity: 0.7;">ID: -</p>
                    </div>
                </div>
                <div class="location-status loading" id="locationStatus">
                    <div class="dot"></div><span>æ­£åœ¨å–å¾—å®šä½...</span>
                </div>
            </div>

            <div id="checkInStatusBox" class="status-box info"></div>

            <div class="primary-actions">
                <div class="primary-btn checkin" id="checkInBtn" onclick="startCheckIn()">
                    <span class="badge-corner">AM</span>
                    <div class="icon">â˜€ï¸</div><div class="label">ä¸Šç­æ‰“å¡</div>
                </div>
                <div class="primary-btn checkout" id="checkOutBtn" onclick="startCheckOut()">
                    <span class="badge-corner">PM</span>
                    <div class="icon">ğŸŒ™</div><div class="label">ä¸‹ç­æ‰“å¡</div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="showPage('leavePage')">
                    <div class="icon">ğŸ“</div><div class="label">æˆ‘è¦è«‹å‡</div>
                </div>
                <div class="menu-item" onclick="showPage('attendancePage')">
                    <div class="icon">ğŸ“Š</div><div class="label">è€ƒå‹¤æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="showPage('lunchPage')">
                    <div class="icon">ğŸ±</div><div class="label">ä¾¿ç•¶è¨‚è³¼</div>
                </div>
                <div class="menu-item" onclick="showPage('salaryPage')">
                    <div class="icon">ğŸ’°</div><div class="label">è–ªè³‡æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="showToast('åŠŸèƒ½é–‹ç™¼ä¸­')">
                    <div class="icon">ğŸ“…</div><div class="label">ç­è¡¨æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="showPage('settingsPage')">
                    <div class="icon">âš™ï¸</div><div class="label">ç³»çµ±è¨­å®š</div>
                </div>
            </div>
        </div>

        <div id="checkInPage" class="page">
            <button class="btn btn-secondary" onclick="cancelCheckIn()" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2 id="checkInTitle" style="text-align: center;">ğŸ“ ä¸Šç­æ‰“å¡</h2>
                <div id="checkInStatus" class="status-box show info">æº–å‚™é–‹å•Ÿç›¸æ©Ÿ...</div>
                
                <div class="camera-container" id="cameraContainer">
                    <video id="video" autoplay playsinline muted></video>
                    <canvas id="canvas" class="hidden"></canvas>
                </div>

                <button class="btn btn-primary" id="captureBtn" onclick="captureAndCheckIn()" disabled>ğŸ“¸ æ‹ç…§ä¸¦æ‰“å¡</button>
            </div>
        </div>

        <div id="lunchPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('homePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ± ä¾¿ç•¶è¨‚è³¼</h2>
                <div class="lunar-notice" id="lunarNotice">ğŸŒ™ æ˜å¤©æ˜¯è¾²æ›†åˆä¸€/åäº”ï¼Œå»ºè­°è¨‚è³¼ç´ é£Ÿ</div>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:10px;">ğŸ“Š æ˜æ—¥çµ±è¨ˆ</h3>
                    <div class="stat-row"><span>ç¸½æ•¸</span><span id="totalOrders">0</span></div>
                    <div class="stat-row"><span>ğŸ¥— ç´ é£Ÿ</span><span id="vegCount">0</span></div>
                    <div class="stat-row"><span>ğŸ– è‘·é£Ÿ</span><span id="regularCount">0</span></div>
                </div>

                <div class="form-group"><label>è¨‚è³¼æ—¥æœŸ</label><input type="date" id="lunchDate"></div>
                <div class="form-group"><label><input type="checkbox" id="lunchVegetarian"> æˆ‘è¦è¨‚ç´ é£Ÿä¾¿ç•¶</label></div>
                <div class="form-group"><label>å‚™è¨» (é¸å¡«)</label><input type="text" id="lunchNotes" placeholder="ä¾‹ï¼šä¸è¦é£¯"></div>
                <button class="btn btn-success" onclick="submitLunchOrder()">âœ… ç¢ºèªè¨‚è³¼</button>
            </div>
        </div>

        <div id="leavePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('homePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“ è«‹å‡ç”³è«‹</h2>
                <div class="form-group">
                    <label>å‡åˆ¥</label>
                    <select id="leaveType">
                        <option value="annual">ç‰¹ä¼‘å‡</option>
                        <option value="sick">ç—…å‡</option>
                        <option value="personal">äº‹å‡</option>
                        <option value="compensatory">è£œä¼‘</option>
                    </select>
                </div>
                <div class="form-group"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="leaveStartDate"></div>
                <div class="form-group"><label>çµæŸæ—¥æœŸ</label><input type="date" id="leaveEndDate"></div>
                <div class="form-group"><label>åŸå› </label><textarea id="leaveReason"></textarea></div>
                <button class="btn btn-primary" onclick="submitLeave()">ğŸ“¤ æäº¤ç”³è«‹</button>
                <div id="leaveStatus" class="status-box"></div>
                
                <div style="margin-top:30px; padding-top:20px; border-top:2px dashed #e5e7eb;">
                    <h3 style="margin-bottom:15px;">ğŸ“‹ æˆ‘çš„è«‹å‡è¨˜éŒ„</h3>
                    <div id="leaveHistoryList">
                        <p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="attendancePage" class="page">
            <button class="btn btn-secondary" onclick="showPage('homePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“Š è€ƒå‹¤è¨˜éŒ„</h2>
                <div class="form-group">
                    <label>æŸ¥è©¢æœˆä»½</label>
                    <div style="display:flex; gap:10px;">
                        <select id="attendanceYear" onchange="loadMonthlyAttendance()" style="flex:1;">
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                        </select>
                        <select id="attendanceMonth" onchange="loadMonthlyAttendance()" style="flex:1;">
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                    </div>
                </div>
                <div id="attendanceList" style="margin-top:15px;"></div>
            </div>
        </div>

        <div id="salaryPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('homePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ’° è–ªè³‡æŸ¥è©¢</h2>
                <div class="form-group">
                    <label>æŸ¥è©¢å¹´åº¦</label>
                    <select id="salaryYear" onchange="loadAnnualSummary()">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                
                <div class="lunch-summary" id="bonusCard" style="display:none;">
                    <h3 style="margin-bottom:15px;">ğŸ å¹´çµ‚çé‡‘è³‡æ ¼</h3>
                    <div class="stat-row"><span>åˆ°è·æ—¥æœŸ</span><span id="bonusHireDate">-</span></div>
                    <div class="stat-row"><span>å¯¦éš›å·¥ä½œæœˆæ•¸</span><span id="bonusMonths">-</span></div>
                    <div class="stat-row"><span>ç¸½å‡ºå‹¤å¤©æ•¸</span><span id="bonusDays">-</span></div>
                    <div class="stat-row"><span>é²åˆ°æ¬¡æ•¸</span><span id="bonusLate">-</span></div>
                    <div class="stat-row"><span>ç´¯è¨ˆå·¥æ™‚</span><span id="bonusHours">-</span></div>
                    <div class="stat-row"><span>å¹³å‡æ¯æ—¥å·¥æ™‚</span><span id="bonusAvgHours">-</span></div>
                    <div class="stat-row" style="border-top:2px solid #d1fae5; margin-top:10px; padding-top:10px; font-weight:bold;">
                        <span>å¹´çµ‚ç™¼æ”¾æ¯”ä¾‹</span>
                        <span id="bonusRatio" style="color:#059669; font-size:18px;">-</span>
                    </div>
                </div>
                <div id="bonusMessage" class="status-box" style="display:none;"></div>
                <div style="margin-top:20px;">
                    <h3>ğŸ“„ è–ªè³‡å–®æŸ¥è©¢</h3>
                    <p class="status-box show info">åŠŸèƒ½é–‹ç™¼ä¸­...</p>
                </div>
            </div>
        </div>

        <div id="settingsPage" class="page">
            <button class="btn btn-secondary" onclick="showPage('homePage')" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:10px;">ğŸ“ ç›®å‰æ‰“å¡åœ°é»</h3>
                    <div id="locationList">
                        <p style="color:#666;text-align:center;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <div class="binding-card" style="margin-top: 20px;">
                    <h3 style="margin-bottom:15px;">â• æ–°å¢åœ°é»</h3>
                    <div class="form-group">
                        <label>åœ°é»åç¨±</label>
                        <input type="text" id="newLocName" placeholder="ä¾‹å¦‚ï¼šå°åŒ—åˆ†åº—">
                    </div>
                    <div class="form-group">
                        <label>æ‰“å¡åŠå¾‘ (å…¬å°º)</label>
                        <input type="number" id="newLocRadius" value="300">
                    </div>
                    <div class="form-group">
                        <label>åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="newLocLat" placeholder="ç·¯åº¦" readonly>
                            <input type="text" id="newLocLng" placeholder="ç¶“åº¦" readonly>
                        </div>
                        <button class="btn btn-primary" onclick="getCurrentGPSForSetting()" style="margin-top:10px; font-size:14px; padding:10px;">
                            ğŸ“ æŠ“å–ç›®å‰ä½ç½®
                        </button>
                    </div>
                    <button class="btn btn-success" onclick="addNewLocation()">ğŸ’¾ å„²å­˜æ–°åœ°é»</button>
                </div>

                <div class="form-group" style="margin-top:30px; text-align:center;">
                    <p style="color:#999; font-size:12px;">
                        ç³»çµ±ç‰ˆæœ¬ v9.4.1 (ä¿®å¾©ç‰ˆ)<br>
                        <span style="font-size:10px;">æœ€å¾Œæ›´æ–°ï¼š2026-01-27</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= è¨­å®šèˆ‡åˆå§‹åŒ– =================
        const CONFIG = {
            LIFF_ID: '2008962829-bnsS1bbB',
            SUPABASE_URL: 'https://nssuisyvlrqnqfxupklb.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3Vpc3l2bHJxbnFmeHVwa2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTAwMzUsImV4cCI6MjA4NDg2NjAzNX0.q_B6v3gf1TOCuAq7z0xIw10wDueCSJn0p37VzdMfmbc',
            BUCKET: 'selfies'
        };

        const sb = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        
        if(location.search.includes('debug=true')) {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/vconsole@latest/dist/vconsole.min.js';
            script.onload = () => new window.VConsole();
            document.head.appendChild(script);
        }
        
        let liffProfile = null;
        let currentEmployee = null;
        let videoStream = null;
        let currentCheckInType = 'in';
        let cachedLocation = null;
        let currentBindMode = 'id_card';
        let todayAttendance = null;
        let officeLocations = []; 
        let isProcessing = false;

        // æ ¸å¿ƒï¼šå–å¾—å°ç£æ™‚é–“ YYYY-MM-DD
        function getTaiwanDate(offsetDays = 0) {
            const date = new Date();
            date.setDate(date.getDate() + offsetDays);
            return date.toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });
        }

        // è¨ˆç®—è·é›¢å…¬å¼ (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // ================= é é¢è·¯ç”± =================
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if(id==='attendancePage') {
                const now = new Date();
                document.getElementById('attendanceYear').value = now.getFullYear();
                document.getElementById('attendanceMonth').value = now.getMonth() + 1;
                loadMonthlyAttendance();
            }
            if(id==='leavePage') loadLeaveHistory();
            if(id==='salaryPage') {
                document.getElementById('salaryYear').value = new Date().getFullYear();
                loadAnnualSummary();
            }
            if(id==='lunchPage') loadLunchSummary();
            if(id==='settingsPage') renderLocationList();
            if(id==='homePage') preloadGPS();
        }

        window.addEventListener('load', async () => {
            try {
                console.log('ğŸš€ ç³»çµ±åˆå§‹åŒ–...');
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                
                liffProfile = await liff.getProfile();
                await checkUserStatus(); 

            } catch (error) {
                alert('åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            }
        });

        // ================= æ ¸å¿ƒé‚è¼¯ =================
        async function checkUserStatus() {
            document.getElementById('loadingPage').style.display = 'flex';
            
            try {
                const { data, error } = await sb.from('employees').select('*').eq('line_user_id', liffProfile.userId).single();
                
                await loadSettings();

                document.getElementById('loadingPage').style.display = 'none';

                if (data) {
                    currentEmployee = data;
                    updateUserInfo(data);
                    showPage('homePage');
                    preloadGPS(); 
                    await checkTodayAttendance();
                } else {
                    showPage('bindPage');
                }
            } catch (err) {
                document.getElementById('loadingPage').style.display = 'none';
                showPage('bindPage');
            }
        }

        function updateUserInfo(data) {
            document.getElementById('userName').textContent = data.name;
            document.getElementById('userDept').textContent = `${data.department || '-'} ${data.position || ''}`;
            document.getElementById('userId').textContent = `ID: ${data.employee_number}`;
            const avatar = document.getElementById('userAvatar');
            if(liffProfile.pictureUrl) {
                avatar.style.backgroundImage = `url(${liffProfile.pictureUrl})`;
                avatar.style.backgroundSize = 'cover'; avatar.textContent='';
            } else {
                avatar.textContent = data.name.charAt(0);
            }
        }

        // ================= åœ°é»èˆ‡ GPS é‚è¼¯ =================
        async function loadSettings() {
            try {
                const { data, error } = await sb.from('system_settings').select('value').eq('key', 'office_locations').single();
                if (!error && data) {
                    officeLocations = data.value || [];
                    if(document.getElementById('settingsPage').classList.contains('active')) renderLocationList();
                }
            } catch (e) { console.error('è¼‰å…¥åœ°é»å¤±æ•—', e); }
        }

        function preloadGPS() {
            const el = document.getElementById('locationStatus');
            el.className = 'location-status loading';
            el.innerHTML = '<div class="dot"></div><span>æ­£åœ¨å®šä½...</span>';

            navigator.geolocation.getCurrentPosition(
                p => { 
                    cachedLocation = { latitude: p.coords.latitude, longitude: p.coords.longitude };
                    
                    let foundLocation = null;
                    let minDistance = Infinity;
                    
                    for (const loc of officeLocations) {
                        const dist = calculateDistance(
                            cachedLocation.latitude, 
                            cachedLocation.longitude, 
                            loc.lat, 
                            loc.lng
                        );
                        
                        if (dist <= loc.radius && dist < minDistance) {
                            minDistance = dist;
                            foundLocation = loc.name;
                        }
                    }

                    el.className = 'location-status ready';
                    if (foundLocation) {
                        el.innerHTML = `<div class="dot" style="background:#10b981;"></div><span>ğŸ“ æ‚¨åœ¨ï¼š${foundLocation}</span>`;
                    } else {
                        el.innerHTML = `<div class="dot" style="background:#f59e0b;"></div><span>âš ï¸ æœªåœ¨æ‰“å¡ç¯„åœå…§</span>`;
                    }
                },
                e => { 
                    el.className = 'location-status';
                    el.innerHTML = '<span>âŒ å®šä½å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™</span>'; 
                },
                { timeout: 10000, enableHighAccuracy: true }
            );
        }

        function getGPS() { 
            return new Promise((res, rej) => {
                navigator.geolocation.getCurrentPosition(
                    p => res({latitude:p.coords.latitude, longitude:p.coords.longitude}), 
                    e => rej(e), 
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        // ================= æ‰“å¡é‚è¼¯ =================
        async function captureAndCheckIn() {
            if (!currentEmployee) {
                showToast('âŒ å“¡å·¥è³‡æ–™æœªè¼‰å…¥ï¼Œè«‹é‡æ–°ç™»å…¥');
                return;
            }

            const btn = document.getElementById('captureBtn');
            const statusBox = document.getElementById('checkInStatus');
            btn.disabled = true; btn.textContent = 'è™•ç†ä¸­...';
            
            try {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0);
                const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.7));

                showStatus(statusBox, 'info', 'â˜ï¸ ä¸Šå‚³ä¸­...');
                const fileName = `${currentEmployee.employee_number}_${Date.now()}.jpg`; 
                const { error: uploadError } = await sb.storage.from(CONFIG.BUCKET).upload(fileName, blob);
                if (uploadError) throw uploadError;

                const { data: urlData } = sb.storage.from(CONFIG.BUCKET).getPublicUrl(fileName);
                const publicUrl = urlData?.publicUrl || urlData?.publicURL;

                if (!publicUrl) throw new Error('ç„¡æ³•å–å¾—ç…§ç‰‡ç¶²å€');

                showStatus(statusBox, 'info', 'ğŸ“ å®šä½ä¸­...');
                let loc = cachedLocation || await getGPS();

                const { data: rpcData, error: rpcError } = await sb.rpc('quick_check_in', {
                    p_line_user_id: liffProfile.userId,
                    p_latitude: loc.latitude, p_longitude: loc.longitude,
                    p_photo_url: publicUrl, p_device_id: navigator.userAgent
                });

                if (rpcError) throw rpcError;
                if (!rpcData.success) throw new Error(rpcData.error);

                if (rpcData.location_name) localStorage.setItem('last_location', rpcData.location_name);

                const typeText = rpcData.type === 'check_in' ? 'ä¸Šç­' : 'ä¸‹ç­';
                showToast(`âœ… ${typeText}æˆåŠŸï¼@${rpcData.location_name || 'å…¬å¸'}`);
                
                setTimeout(() => { cancelCheckIn(); checkTodayAttendance(); }, 1500);

            } catch (err) {
                console.error(err);
                showStatus(statusBox, 'error', `âŒ å¤±æ•—: ${err.message}`);
                btn.disabled = false; btn.textContent = 'ğŸ“¸ é‡è©¦';
            }
        }

        // ================= å…¶ä»–åŠŸèƒ½ =================
        function switchBindMode(mode) {
            currentBindMode = mode;
            document.getElementById('modeIdCard').classList.toggle('hidden', mode !== 'id_card');
            document.getElementById('modeCode').classList.toggle('hidden', mode !== 'code');
            document.getElementById('tabIdCard').className = mode === 'id_card' ? 'tab-btn active' : 'tab-btn inactive';
            document.getElementById('tabCode').className = mode === 'code' ? 'tab-btn active' : 'tab-btn inactive';
        }

        async function handleBind() {
            const empId = document.getElementById('bindEmpId').value.trim();
            const idLast4 = document.getElementById('bindIdLast4').value.trim();
            const code = document.getElementById('bindCode').value.trim();
            const statusBox = document.getElementById('bindStatus');

            if (!empId) return showStatus(statusBox, 'error', 'è«‹è¼¸å…¥å“¡ç·¨');

            const params = {
                p_line_user_id: liffProfile.userId,
                p_employee_number: empId, 
                p_device_info: navigator.userAgent,
                p_id_card_last_4: document.getElementById('modeIdCard').classList.contains('hidden') ? null : idLast4,
                p_verification_code: document.getElementById('modeCode').classList.contains('hidden') ? null : code
            };

            showStatus(statusBox, 'info', 'é©—è­‰ä¸­...');
            try {
                const { data, error } = await sb.rpc('bind_employee', params);
                if (error) throw error;
                if (data.success) {
                    showStatus(statusBox, 'success', 'âœ… ç¶å®šæˆåŠŸï¼');
                    setTimeout(checkUserStatus, 1500);
                } else {
                    showStatus(statusBox, 'error', data.error);
                }
            } catch (err) {
                showStatus(statusBox, 'error', err.message);
            }
        }

        async function checkTodayAttendance() {
            if (!currentEmployee) return;
            try {
                const today = getTaiwanDate(0);
                const { data, error } = await sb.from('attendance')
                    .select('*')
                    .eq('employee_id', currentEmployee.id)
                    .eq('date', today)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        todayAttendance = null; 
                    } else {
                        console.error('âŒ æª¢æŸ¥è€ƒå‹¤éŒ¯èª¤:', error);
                        todayAttendance = null;
                    }
                } else {
                    todayAttendance = data;
                }
                updateCheckInButtons();
            } catch(e) { console.error(e); }
        }

        function updateCheckInButtons() {
            const btnIn = document.getElementById('checkInBtn');
            const btnOut = document.getElementById('checkOutBtn');
            const statusBox = document.getElementById('checkInStatusBox');
            const lastLoc = localStorage.getItem('last_location') || 'å…¬å¸';

            if (!todayAttendance) {
                btnIn.classList.remove('disabled');
                btnOut.classList.add('disabled');
                showStatus(statusBox, 'info', `ğŸ“ ä¸Šæ¬¡æ‰“å¡åœ°é»ï¼š${lastLoc}`);
            } else if (todayAttendance.check_out_time) {
                btnIn.classList.add('disabled');
                btnOut.classList.add('disabled');
                showStatus(statusBox, 'success', `âœ… ä»Šæ—¥å®Œå·¥ (å·¥æ™‚ ${todayAttendance.total_work_hours?.toFixed(1)}h)`);
            } else {
                btnIn.classList.add('disabled');
                btnOut.classList.remove('disabled');
                const time = new Date(todayAttendance.check_in_time).toLocaleTimeString('zh-TW', {timeZone:'Asia/Taipei', hour:'2-digit', minute:'2-digit'});
                const locName = todayAttendance.check_in_location?.includes('(') ? todayAttendance.check_in_location.split('(')[0] : lastLoc;
                showStatus(statusBox, 'info', `ğŸ¢ ä¸Šç­ä¸­ @ ${locName} (${time})`);
            }
        }

        function startCheckIn() { 
            if (document.getElementById('checkInBtn').classList.contains('disabled')) return;
            if (isProcessing) return;
            isProcessing = true;
            currentCheckInType='in'; 
            showCheckInPage('ğŸ“ ä¸Šç­æ‰“å¡'); 
            setTimeout(() => isProcessing = false, 1000);
        }
        function startCheckOut() { 
            if (document.getElementById('checkOutBtn').classList.contains('disabled')) return;
            if (isProcessing) return;
            isProcessing = true;
            currentCheckInType='out'; 
            showCheckInPage('ğŸ‘‹ ä¸‹ç­æ‰“å¡'); 
            setTimeout(() => isProcessing = false, 1000);
        }
        function showCheckInPage(title) { document.getElementById('checkInTitle').textContent=title; showPage('checkInPage'); openCamera(); }
        function cancelCheckIn() { if(videoStream) videoStream.getTracks().forEach(t=>t.stop()); showPage('homePage'); }

        async function openCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                const video = document.getElementById('video');
                video.srcObject = stream;
                videoStream = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    document.getElementById('cameraContainer').classList.add('show');
                    document.getElementById('captureBtn').disabled = false;
                    document.getElementById('checkInStatus').textContent = 'âœ… ç›¸æ©Ÿå°±ç·’';
                };
            } catch(e) { 
                console.error('ç›¸æ©ŸéŒ¯èª¤', e);
                let msg = 'ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ';
                if(e.name === 'NotAllowedError') msg = 'è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™';
                if(e.name === 'NotFoundError') msg = 'æ‰¾ä¸åˆ°ç›¸æ©Ÿè£ç½®';
                const status = document.getElementById('checkInStatus');
                status.className = 'status-box show error';
                status.innerHTML = `âŒ ${msg}`;
            }
        }

        // ================= è¨­å®šé é¢åŠŸèƒ½ =================
        function renderLocationList() {
            const listEl = document.getElementById('locationList');
            if (officeLocations.length === 0) {
                listEl.innerHTML = '<p style="color:#666;text-align:center;">å°šæœªè¨­å®šåœ°é»</p>';
                return;
            }
            listEl.innerHTML = officeLocations.map((loc, index) => `
                <div class="stat-row" style="align-items:center;">
                    <div style="text-align:left;">
                        <div style="font-weight:bold;">${loc.name}</div>
                        <div style="font-size:11px;color:#999;">ç¯„åœ: ${loc.radius}m</div>
                    </div>
                    <button onclick="deleteLocation(${index})" class="btn-danger">åˆªé™¤</button>
                </div>
            `).join('');
        }

        function getCurrentGPSForSetting() {
            showToast('ğŸ“ å®šä½ä¸­...');
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    document.getElementById('newLocLat').value = pos.coords.latitude;
                    document.getElementById('newLocLng').value = pos.coords.longitude;
                    showToast('âœ… å·²å¡«å…¥åº§æ¨™');
                },
                (err) => showToast('å®šä½å¤±æ•—: ' + err.message),
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        async function addNewLocation() {
            const name = document.getElementById('newLocName').value.trim();
            const radius = parseInt(document.getElementById('newLocRadius').value);
            const lat = parseFloat(document.getElementById('newLocLat').value);
            const lng = parseFloat(document.getElementById('newLocLng').value);

            if (!name || !lat || !lng) return showToast('âš ï¸ è³‡æ–™ä¸å®Œæ•´');

            const newLocations = [...officeLocations, { name, lat, lng, radius }];
            await saveLocationsToDB(newLocations);
            
            document.getElementById('newLocName').value = '';
            document.getElementById('newLocLat').value = '';
            document.getElementById('newLocLng').value = '';
        }

        async function deleteLocation(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åœ°é»å—ï¼Ÿ')) return;
            const newLocations = officeLocations.filter((_, i) => i !== index);
            await saveLocationsToDB(newLocations);
        }

        async function saveLocationsToDB(newLocations) {
            try {
                const { data, error } = await sb.rpc('update_office_locations', {
                    p_locations: newLocations,
                    p_line_user_id: liffProfile.userId
                });

                if (error) throw error;
                if (!data.success) { showToast('âŒ ' + data.error); return; }
                
                officeLocations = newLocations;
                showToast('âœ… è¨­å®šå·²æ›´æ–°');
                renderLocationList();
                preloadGPS(); 
            } catch (err) {
                console.error(err);
                showToast('âŒ å„²å­˜å¤±æ•—');
            }
        }

        // ================= é€²éšæŸ¥è©¢èˆ‡è¼”åŠ©åŠŸèƒ½ (å®Œæ•´è£œé½Š) =================
        async function loadLunchSummary() {
            const dateStr = getTaiwanDate(1);
            document.getElementById('lunchDate').value = dateStr;
            try {
                const { data } = await sb.rpc('get_lunch_summary', { p_date: dateStr });
                if(data) {
                    document.getElementById('totalOrders').textContent = data.total_orders || 0;
                    document.getElementById('vegCount').textContent = data.vegetarian_count || 0;
                    document.getElementById('regularCount').textContent = data.regular_count || 0;
                    if(data.is_lunar_vegetarian_day) {
                        document.getElementById('lunarNotice').classList.add('show');
                        document.getElementById('lunchVegetarian').checked = true;
                    }
                }
            } catch(e) { console.error('ä¾¿ç•¶çµ±è¨ˆå¤±æ•—', e); }
        }

        async function submitLunchOrder() {
            if (!currentEmployee) return showToast('âŒ è«‹å…ˆç™»å…¥');
            const date = document.getElementById('lunchDate').value;
            const isVeg = document.getElementById('lunchVegetarian').checked;
            const notes = document.getElementById('lunchNotes').value;
            try {
                const { data, error } = await sb.rpc('order_lunch', {
                    p_line_user_id: liffProfile.userId,
                    p_order_date: date, p_is_vegetarian: isVeg, p_special_requirements: notes
                });
                if(error) throw error;
                showToast('âœ… è¨‚è³¼æˆåŠŸ'); loadLunchSummary();
            } catch(e) { showToast('å¤±æ•—:'+e.message); }
        }

        async function submitLeave() {
            if (!currentEmployee) return showToast('âŒ è«‹å…ˆç™»å…¥');
            const type = document.getElementById('leaveType').value;
            const start = document.getElementById('leaveStartDate').value;
            const end = document.getElementById('leaveEndDate').value;
            const reason = document.getElementById('leaveReason').value;
            if(!start || !end || !reason) return showToast('è«‹å¡«å¯«å®Œæ•´');
            
            try {
                const { error } = await sb.from('leave_requests').insert({
                    employee_id: currentEmployee.id, leave_type: type, start_date: start, end_date: end, reason: reason, status: 'pending'
                });
                if(error) throw error;
                showToast('âœ… ç”³è«‹æˆåŠŸ'); 
                loadLeaveHistory(); // åˆ·æ–°æ­·å²
                document.getElementById('leaveStatus').className = 'status-box show success';
                document.getElementById('leaveStatus').textContent = 'âœ… ç”³è«‹å·²æäº¤';
            } catch(e) { showToast('å¤±æ•—:'+e.message); }
        }

        // æœˆåº¦å‡ºå‹¤æŸ¥è©¢
        async function loadMonthlyAttendance() {
            const list = document.getElementById('attendanceList');
            const year = parseInt(document.getElementById('attendanceYear').value);
            const month = parseInt(document.getElementById('attendanceMonth').value);
            
            if (!currentEmployee) return;
            list.innerHTML = '<p style="text-align:center;">æŸ¥è©¢ä¸­...</p>';
            
            try {
                const { data, error } = await sb.rpc('get_monthly_attendance', {
                    p_line_user_id: liffProfile.userId,
                    p_year: year,
                    p_month: month
                });
                
                if (error) throw error;
                if (!data || data.length === 0) {
                    list.innerHTML = `<p style="text-align:center;">${year}å¹´${month}æœˆ ç„¡è¨˜éŒ„</p>`;
                    return;
                }
                
                // ç°¡æ˜“çµ±è¨ˆ
                const totalDays = data.length;
                const lateDays = data.filter(r => r.is_late).length;
                const totalHours = data.reduce((sum, r) => sum + (parseFloat(r.total_work_hours) || 0), 0);
                
                let html = `
                    <div class="lunch-summary" style="margin-bottom:15px;">
                        <div class="stat-row"><span>å‡ºå‹¤</span><span>${totalDays}å¤©</span></div>
                        <div class="stat-row"><span>é²åˆ°</span><span>${lateDays}æ¬¡</span></div>
                        <div class="stat-row"><span>å·¥æ™‚</span><span>${totalHours.toFixed(1)}h</span></div>
                    </div>
                `;
                
                html += data.map(r => {
                    const badge = r.is_late ? '<span class="badge badge-warning">é²åˆ°</span>' : '<span class="badge badge-success">æ­£å¸¸</span>';
                    const hours = r.total_work_hours ? `${parseFloat(r.total_work_hours).toFixed(1)}h` : '-';
                    return `
                        <div class="attendance-item ${r.is_late ? 'late' : 'normal'}">
                            <div class="date">${r.date} ${badge} <span style="font-size:12px;">${hours}</span></div>
                            <div class="details">
                                <span>ä¸Šç­: ${r.check_in_time ? r.check_in_time.split(' ')[1].substr(0,5) : '-'}</span>
                                <span>ä¸‹ç­: ${r.check_out_time ? r.check_out_time.split(' ')[1].substr(0,5) : '-'}</span>
                            </div>
                            ${r.photo_url ? `<div style="margin-top:5px;"><a href="${r.photo_url}" target="_blank" style="font-size:12px;">ğŸ“· ç…§ç‰‡</a></div>` : ''}
                        </div>
                    `;
                }).join('');
                list.innerHTML = html;
            } catch (err) { console.error(err); list.innerHTML = 'æŸ¥è©¢å¤±æ•—'; }
        }

        // è«‹å‡æ­·å²
        async function loadLeaveHistory() {
            const list = document.getElementById('leaveHistoryList');
            if (!currentEmployee) return;
            try {
                const { data } = await sb.rpc('get_leave_history', { p_line_user_id: liffProfile.userId, p_limit: 5 });
                if (!data || data.length === 0) { list.innerHTML = '<p style="text-align:center;">å°šç„¡è¨˜éŒ„</p>'; return; }
                
                const typeMap = { 'annual': 'ç‰¹ä¼‘', 'sick': 'ç—…å‡', 'personal': 'äº‹å‡', 'compensatory': 'è£œä¼‘' };
                const statusMap = { 'pending': 'â³', 'approved': 'âœ…', 'rejected': 'âŒ' };
                
                list.innerHTML = data.map(r => `
                    <div class="attendance-item">
                        <div class="date">${typeMap[r.leave_type]} ${statusMap[r.status]}</div>
                        <div class="details">
                            <div>${r.start_date} ~ ${r.end_date}</div>
                            <div style="color:#999;">${r.reason}</div>
                        </div>
                    </div>
                `).join('');
            } catch(e) { console.error(e); }
        }

        // å¹´çµ‚çµ±è¨ˆ
        async function loadAnnualSummary() {
            const year = parseInt(document.getElementById('salaryYear').value);
            const card = document.getElementById('bonusCard');
            const msg = document.getElementById('bonusMessage');
            if (!currentEmployee) return;

            card.style.display = 'block';
            msg.style.display = 'none';
            
            try {
                const { data, error } = await sb.rpc('get_annual_summary', { p_line_user_id: liffProfile.userId, p_year: year });
                if (error) throw error;
                
                document.getElementById('bonusHireDate').textContent = data.hire_date || '-';
                document.getElementById('bonusMonths').textContent = data.months_worked;
                document.getElementById('bonusDays').textContent = data.total_attendance_days;
                document.getElementById('bonusLate').textContent = data.late_count;
                document.getElementById('bonusHours').textContent = data.total_work_hours;
                document.getElementById('bonusAvgHours').textContent = data.avg_work_hours_per_day;
                
                const ratioEl = document.getElementById('bonusRatio');
                ratioEl.textContent = data.bonus_eligible ? `${data.bonus_ratio} å€‹æœˆ` : 'ä¸ç¬¦åˆ';
                ratioEl.style.color = data.bonus_eligible ? '#059669' : '#dc2626';
                
                msg.style.display = 'block';
                msg.className = data.bonus_eligible ? 'status-box show success' : 'status-box show error';
                msg.textContent = data.message;
            } catch (err) { console.error(err); }
        }

        function showStatus(el, type, msg) { el.className=`status-box show ${type}`; el.innerHTML=msg; }
        function showToast(msg) { const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(), 3000); }
    </script>
</body>
</html>
