<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¢ å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <div id="bindPage" class="page active">
            <div class="card">
                <div class="bind-header">
                    <span class="logo">ğŸ”</span>
                    <h2>å“¡å·¥èº«ä»½ç¶å®š</h2>
                    <p>åˆæ¬¡ä½¿ç”¨è«‹é©—è­‰èº«ä»½</p>
                </div>
                <div class="tabs">
                    <button class="tab-btn active" id="tabIdCard" onclick="switchBindMode('id_card')">èº«ä»½è­‰é©—è­‰</button>
                    <button class="tab-btn inactive" id="tabCode" onclick="switchBindMode('code')">é©—è­‰ç¢¼é©—è­‰</button>
                </div>
                <div class="form-group">
                    <label>å“¡å·¥å·¥è™Ÿ (ID) *</label>
                    <input type="text" id="bindEmpId" placeholder="ä¾‹å¦‚ï¼šEMP001" autocomplete="off">
                </div>
                <div id="modeIdCard" class="form-group">
                    <label>èº«ä»½è­‰å¾Œ 4 ç¢¼ *</label>
                    <input type="tel" id="bindIdLast4" maxlength="4" placeholder="ä¾‹å¦‚ï¼š1234" autocomplete="off">
                </div>
                <div id="modeCode" class="form-group hidden">
                    <label>ä¸€æ¬¡æ€§é©—è­‰ç¢¼ *</label>
                    <input type="text" id="bindCode" placeholder="è«‹è¼¸å…¥ HR æä¾›çš„é©—è­‰ç¢¼" autocomplete="off">
                </div>
                <button class="btn btn-primary" onclick="handleBind()">ğŸ”— ç«‹å³ç¶å®š</button>
                <div id="bindStatus" class="status-box"></div>
            </div>
        </div>

        <div id="homePage" class="page">
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">?</div>
                    <div class="user-details">
                        <h2 id="userName">è¼‰å…¥ä¸­...</h2>
                        <p id="userDept">-</p>
                        <p id="userId" style="font-size: 11px; opacity: 0.7;">ID: -</p>
                    </div>
                </div>
                <div class="location-status loading" id="locationStatus">
                    <div class="dot"></div><span>æ­£åœ¨å–å¾—å®šä½...</span>
                </div>
            </div>

            <div id="checkInStatusBox" class="status-box info"></div>

            <div class="primary-actions">
                <div class="primary-btn checkin" id="checkInBtn" onclick="startCheckIn()">
                    <span class="badge-corner">AM</span>
                    <div class="icon">â˜€ï¸</div><div class="label">ä¸Šç­æ‰“å¡</div>
                </div>
                <div class="primary-btn checkout" id="checkOutBtn" onclick="startCheckOut()">
                    <span class="badge-corner">PM</span>
                    <div class="icon">ğŸŒ™</div><div class="label">ä¸‹ç­æ‰“å¡</div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="window.location.href='records.html'">
                    <div class="icon">ğŸ“</div><div class="label">æˆ‘è¦è«‹å‡</div>
                </div>
                <div class="menu-item" onclick="window.location.href='records.html#attendance'">
                    <div class="icon">ğŸ“Š</div><div class="label">è€ƒå‹¤æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="window.location.href='services.html'">
                    <div class="icon">ğŸ±</div><div class="label">ä¾¿ç•¶è¨‚è³¼</div>
                </div>
                <div class="menu-item" onclick="window.location.href='records.html#salary'">
                    <div class="icon">ğŸ’°</div><div class="label">è–ªè³‡æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="showToast('åŠŸèƒ½é–‹ç™¼ä¸­')">
                    <div class="icon">ğŸ“…</div><div class="label">ç­è¡¨æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="window.location.href='services.html#settings'">
                    <div class="icon">âš™ï¸</div><div class="label">ç³»çµ±è¨­å®š</div>
                </div>
                <!-- ç®¡ç†å“¡å°ˆç”¨å…¥å£ -->
                <div class="menu-item admin-only" id="adminEntry" style="display:none;" onclick="window.location.href='admin.html'">
                    <div class="icon">ğŸ‘‘</div><div class="label">ç®¡ç†å¾Œå°</div>
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startCheckIn() { 
            if (document.getElementById('checkInBtn').classList.contains('disabled')) return;
            if (isProcessing) return;
            isProcessing = true;
            window.location.href = 'checkin.html?type=in';
            setTimeout(() => isProcessing = false, 1000);
        }

        function startCheckOut() { 
            if (document.getElementById('checkOutBtn').classList.contains('disabled')) return;
            if (isProcessing) return;
            isProcessing = true;
            window.location.href = 'checkin.html?type=out';
            setTimeout(() => isProcessing = false, 1000);
        }

        function checkLiffParams() {
            if (liff && liff.isInClient()) {
                try {
                    const liffParams = liff.getContext();
                    if (liffParams?.type === 'utim' && liffParams.utm) {
                        const urlParams = new URLSearchParams(liffParams.utm);
                        const company = urlParams.get('company');
                        if (company) sessionStorage.setItem('company_code', company);
                    }
                } catch(e) {}
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const company = urlParams.get('company');
            if (company) sessionStorage.setItem('company_code', company);
        }

        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') {
                console.error('common.js æœªæ­£ç¢ºè¼‰å…¥');
                return;
            }
            
            const initialized = await initializeLiff();
            if (initialized) {
                checkLiffParams();
                
                const isLoggedIn = await checkUserStatus();
                if (isLoggedIn) {
                    showPage('homePage');
                    preloadGPS();
                    
                    const isAdmin = await checkIsAdmin();
                    if (isAdmin) {
                        const adminEntry = document.getElementById('adminEntry');
                        if (adminEntry) adminEntry.style.display = 'block';
                    }
                } else {
                    showPage('bindPage');
                }
            }
        });
    </script>
</body>
</html>
