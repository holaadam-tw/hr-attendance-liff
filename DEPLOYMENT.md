# 🎁 年終獎金管理系統 - 部署說明

## 📋 系統概述

已完成年終獎金管理系統的重構，包含：
- ✅ 員工年度成績單查詢
- ✅ 管理員後台系統
- ✅ 安全的權限控制
- ✅ 自動獎金計算邏輯

## 🗂️ 新增檔案

```
hr-system/
├── 📄 schema_update.sql      # Supabase RPC 函數
├── 📄 role_update.sql        # 員工角色欄位更新
├── 👑 admin.html             # 管理員後台
├── 🎨 style.css              # 更新的樣式（含成績單樣式）
├── 🧠 common.js              # 更新的共用邏輯
├── 📊 records.html           # 更新的查詢頁面
└── 🏠 index.html             # 更新的首頁
```

## 🚀 部署步驟

### 第一步：更新 Supabase 資料庫

1. **執行 schema_update.sql**
   ```sql
   -- 在 Supabase SQL Editor 中執行
   -- 建立年終獎金計算的 RPC 函數
   ```

2. **執行 role_update.sql**
   ```sql
   -- 新增 role 欄位到 employees 表
   -- 記得將 'YOUR_LINE_USER_ID' 替換為您的實際 LINE User ID
   ```

3. **確認資料表結構**
   - `employees` 表應包含 `role` 欄位
   - `annual_bonus` 表應已存在（用於儲存獎金記錄）

### 第二步：設定管理員權限

1. **取得您的 LINE User ID**
   - 在 LINE App 中進入任何 LIFF 應用
   - 開啟開發者工具，查看 `liffProfile.userId`

2. **更新管理員角色**
   ```sql
   UPDATE employees 
   SET role = 'admin' 
   WHERE line_user_id = '您的_LINE_USER_ID';
   ```

### 第三步：部署檔案

1. **上傳所有檔案到 GitHub**
   ```bash
   git add .
   git commit -m "feat: 新增年終獎金管理系統"
   git push origin main
   ```

2. **確認 GitHub Pages 設定**
   - 確保 GitHub Pages 已啟用
   - 確認部署 URL 正確

### 第四步：測試功能

#### 員工端測試
1. **年度成績單查詢**
   - 進入 `records.html#salary`
   - 選擇年度查看個人成績單
   - 確認顯示 8 大數據和資格判定

#### 管理員端測試
1. **權限檢查**
   - 直接訪問 `admin.html`
   - 確認只有管理員能進入

2. **獎金試算功能**
   - 查看所有員工的獎金資格
   - 測試手動調整功能

3. **地點管理功能**
   - 確認地點設定功能正常

## 🎯 核心功能說明

### 員工年度成績單

**顯示的 8 大數據：**
1. 📅 到職日期
2. ⏳ 實際年資（月份）
3. 🏃 總出勤天數
4. 📈 出席率（百分比）
5. ⏰ 遲到次數
6. 📉 遲到率（百分比）
7. ⏱️ 累計工時
8. 📊 平均每日工時

**獎金資格判定邏輯：**
- ❌ 年資不足 6 個月
- ❌ 出席率低於 85%
- ❌ 遲到率高於 5%
- ✅ 符合所有條件

### 管理員後台功能

1. **🎁 年終獎金試算**
   - 查看所有員工的獎金資格
   - 系統自動計算建議金額
   - 支援手動調整

2. **📍 地點管理**
   - 新增/刪除打卡地點
   - 設定打卡範圍

3. **👥 員工管理**
   - 查看所有員工列表
   - 調整員工角色（管理員/一般員工）

4. **✅ 請假審核**
   - 待審核/已通過/已拒絕請假列表
   - 一鍵審核功能

5. **📊 報表匯出**
   - 各類報表匯出功能（預留介面）

## 🔒 安全性設計

1. **權限分離**
   - 員工只能看到自己的成績單
   - 管理員才能看到所有員工資料
   - 獎金金額只在管理員後台顯示

2. **資料保護**
   - 敏感計算在後端進行
   - 前端只顯示結果，不暴露計算邏輯

3. **訪問控制**
   - 管理員後台有獨立的權限檢查
   - 非管理員無法訪問

## 🐛 常見問題

### Q: 員工看不到年度成績單？
A: 檢查 `get_my_year_end_stats` RPC 函數是否正確建立

### Q: 管理員無法進入後台？
A: 確認 `employees` 表中的 `role` 欄位已正確設定為 'admin'

### Q: 獎金計算不正確？
A: 檢查 `get_all_year_end_stats` RPC 函數的計算邏輯

### Q: 地點管理功能異常？
A: 確認 `office_locations` 系統設定正確載入

## 📱 使用建議

1. **員工使用**
   - 定期查看個人成績單
   - 注意遲到率和出席率

2. **管理員使用**
   - 每月更新獎金試算
   - 及時審核請假申請
   - 定期檢查系統設定

3. **系統維護**
   - 定期備份資料庫
   - 監控系統運行狀況
   - 更新獎金計算規則時需同步更新 RPC 函數

---

🎉 **恭喜！您的年終獎金管理系統已經完成！**

現在您可以安全、透明地管理員工的年終獎金，同時讓員工清楚了解自己的考勤表現。
