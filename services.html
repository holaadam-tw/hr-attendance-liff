<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¶ä»–æœå‹™</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
    <style>.tab-content { display: none; } .tab-content.active { display: block; }</style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="btn btn-secondary" style="margin-bottom:15px;">â† è¿”å›é¦–é </a>
        
        <div style="display:flex; gap:5px; margin-bottom:20px;">
            <button class="btn btn-secondary" onclick="switchTab('lunch')">ğŸ± ä¾¿ç•¶</button>
            <button class="btn btn-secondary" onclick="switchTab('settings')">âš™ï¸ è¨­å®š</button>
        </div>

        <div id="lunch" class="tab-content">
            <div class="card">
                <h3>ğŸ± æ˜æ—¥åˆé¤</h3>
                <div class="lunch-summary">
                    <div class="stat-row"><span>è¨‚è³¼ç¸½æ•¸</span><span id="totalOrders">-</span></div>
                </div>
                <input type="date" id="lunchDate">
                <div style="margin:10px 0;"><label><input type="checkbox" id="isVeg"> ç´ é£Ÿ</label></div>
                <input type="text" id="lunchNotes" placeholder="å‚™è¨»">
                <button class="btn btn-success" onclick="orderLunch()">é€å‡ºè¨‚å–®</button>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <div class="card">
                <h3>ğŸ“ æ‰“å¡é»ç®¡ç†</h3>
                <div id="locList" style="margin-bottom:15px;">è¼‰å…¥ä¸­...</div>
                <input type="text" id="locName" placeholder="åç¨±">
                <button class="btn btn-primary" onclick="addLocation()">â• æ–°å¢ç›®å‰ä½ç½®</button>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        window.onload = () => initApp(() => {
            const hash = window.location.hash.substring(1) || 'lunch';
            switchTab(hash);
        });

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'lunch') loadLunch();
            if(id === 'settings') loadSettings();
        }

        async function loadLunch() {
            document.getElementById('lunchDate').value = getTaiwanDate(1);
            const { data } = await sb.rpc('get_lunch_summary', { p_date: getTaiwanDate(1) });
            if(data) document.getElementById('totalOrders').textContent = data.total_orders;
        }

        async function orderLunch() {
            const date = document.getElementById('lunchDate').value;
            const veg = document.getElementById('isVeg').checked;
            const note = document.getElementById('lunchNotes').value;
            const { data, error } = await sb.rpc('order_lunch', { p_line_user_id: liffProfile.userId, p_order_date: date, p_is_vegetarian: veg, p_special_requirements: note });
            if(data && data.success) alert('âœ… è¨‚è³¼æˆåŠŸ'); else alert('å¤±æ•—');
        }

        async function loadSettings() {
            const { data } = await sb.rpc('get_office_locations', { p_line_user_id: liffProfile.userId });
            const list = document.getElementById('locList');
            if(data && data.locations.length) list.innerHTML = data.locations.map(l => `<div>ğŸ“ ${l.name}</div>`).join('');
            else list.innerHTML = 'ç„¡åœ°é»';
        }

        function addLocation() {
            const name = document.getElementById('locName').value;
            if(!name) return alert('è«‹è¼¸å…¥åç¨±');
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { data } = await sb.rpc('add_office_location', {
                    p_line_user_id: liffProfile.userId, p_name: name,
                    p_latitude: pos.coords.latitude, p_longitude: pos.coords.longitude, p_radius: 300
                });
                if(data && data.success) { alert('âœ… æˆåŠŸ'); loadSettings(); }
            });
        }
    </script>
</body>
</html>
