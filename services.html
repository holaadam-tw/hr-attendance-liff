<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ± æœå‹™åŠŸèƒ½ - å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <!-- ä¾¿ç•¶è¨‚è³¼é é¢ -->
        <div id="lunchPage" class="page active">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ± ä¾¿ç•¶è¨‚è³¼</h2>
                <div class="lunar-notice" id="lunarNotice">ğŸŒ™ æ˜å¤©æ˜¯è¾²æ›†åˆä¸€/åäº”ï¼Œå»ºè­°è¨‚è³¼ç´ é£Ÿ</div>
                
                <!-- æˆªæ­¢æ™‚é–“æé†’ -->
                <div id="lunchDeadline" style="padding:10px 14px;border-radius:10px;margin-bottom:12px;font-size:13px;font-weight:700;"></div>

                <!-- æˆ‘çš„ä»Šæ—¥è¨‚å–® -->
                <div id="myOrderCard" style="display:none;background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:16px;">
                    <div style="font-size:14px;font-weight:800;color:#0F172A;margin-bottom:10px;">ğŸ“‹ æˆ‘çš„è¨‚å–®</div>
                    <div id="myOrderContent" style="font-size:13px;"></div>
                    <div id="myOrderActions" style="margin-top:12px;display:flex;gap:8px;"></div>
                </div>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:10px;">ğŸ“Š ä»Šæ—¥çµ±è¨ˆ</h3>
                    <div class="stat-row"><span>ç¸½æ•¸</span><span id="totalOrders">0</span></div>
                    <div class="stat-row"><span>ğŸ¥— ç´ é£Ÿ</span><span id="vegCount">0</span></div>
                    <div class="stat-row"><span>ğŸ– è‘·é£Ÿ</span><span id="regularCount">0</span></div>
                </div>

                <!-- è¨‚è³¼è¡¨å–® -->
                <div id="lunchForm">
                    <div class="form-group"><label>è¨‚è³¼æ—¥æœŸ</label><input type="date" id="lunchDate"></div>
                    
                    <!-- ä¾¿ç•¶é¸æ“‡å¡ç‰‡ -->
                    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px;">
                        <div class="lunch-choice" onclick="selectLunchType('regular')" style="display:flex;align-items:center;gap:12px;padding:14px;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                            <span style="font-size:28px;">ğŸ–</span>
                            <div style="flex:1;"><b style="font-size:14px;">è‘·é£Ÿä¾¿ç•¶</b><br><span style="font-size:11px;color:#94A3B8;">ä»Šæ—¥ä¸»èœç”±é¤å»³å®‰æ’</span></div>
                            <div class="lunch-check" id="lunchCheckRegular" style="width:22px;height:22px;border:2px solid #CBD5E1;border-radius:50%;transition:all 0.2s;"></div>
                        </div>
                        <div class="lunch-choice" onclick="selectLunchType('vegetarian')" style="display:flex;align-items:center;gap:12px;padding:14px;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                            <span style="font-size:28px;">ğŸ¥—</span>
                            <div style="flex:1;"><b style="font-size:14px;">ç´ é£Ÿä¾¿ç•¶</b><br><span style="font-size:11px;color:#94A3B8;">å¥åº·è”¬é£Ÿæ–™ç†</span></div>
                            <div class="lunch-check" id="lunchCheckVeg" style="width:22px;height:22px;border:2px solid #CBD5E1;border-radius:50%;transition:all 0.2s;"></div>
                        </div>
                        <div class="lunch-choice" onclick="selectLunchType('none')" style="display:flex;align-items:center;gap:12px;padding:14px;border:2px solid #E5E7EB;border-radius:14px;cursor:pointer;transition:all 0.2s;">
                            <span style="font-size:28px;">ğŸ’°</span>
                            <div style="flex:1;"><b style="font-size:14px;">ä¸è¨‚è³¼</b><br><span style="font-size:11px;color:#059669;">å¯ç²å¾— NT$ 50 åˆé¤è£œåŠ©</span></div>
                            <div class="lunch-check" id="lunchCheckNone" style="width:22px;height:22px;border:2px solid #CBD5E1;border-radius:50%;transition:all 0.2s;"></div>
                        </div>
                    </div>

                    <div class="form-group"><label>å‚™è¨» (é¸å¡«)</label><input type="text" id="lunchNotes" placeholder="ä¾‹ï¼šä¸è¦é£¯"></div>
                    <button class="btn btn-success" id="lunchSubmitBtn" onclick="submitLunchOrderNew()" disabled style="opacity:0.5;">è«‹å…ˆé¸æ“‡ä¾¿ç•¶é¡å‹</button>
                </div>
            </div>
        </div>

        <!-- ç³»çµ±è¨­å®šé é¢ -->
        <div id="settingsPage" class="page">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:10px;">ğŸ“ ç›®å‰æ‰“å¡åœ°é»</h3>
                    <div id="locationList">
                        <p style="color:#666;text-align:center;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <div class="binding-card" style="margin-top: 20px;">
                    <h3 style="margin-bottom:15px;">â• æ–°å¢åœ°é»</h3>
                    <div class="form-group">
                        <label>åœ°é»åç¨±</label>
                        <input type="text" id="newLocName" placeholder="ä¾‹å¦‚ï¼šå°åŒ—åˆ†åº—">
                    </div>
                    <div class="form-group">
                        <label>æ‰“å¡åŠå¾‘ (å…¬å°º)</label>
                        <input type="number" id="newLocRadius" value="300">
                    </div>
                    <div class="form-group">
                        <label>åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="newLocLat" placeholder="ç·¯åº¦" readonly>
                            <input type="text" id="newLocLng" placeholder="ç¶“åº¦" readonly>
                        </div>
                        <button class="btn btn-primary" onclick="getCurrentGPSForSetting()" style="margin-top:10px; font-size:14px; padding:10px;">
                            ğŸ“ æŠ“å–ç›®å‰ä½ç½®
                        </button>
                    </div>
                    <button class="btn btn-success" onclick="addNewLocation()">ğŸ’¾ å„²å­˜æ–°åœ°é»</button>
                </div>

                <div class="form-group" style="margin-top:30px; text-align:center;">
                    <p style="color:#999; font-size:12px;">
                        ç³»çµ±ç‰ˆæœ¬ v11.0<br>
                        <span style="font-size:10px;">æœ€å¾Œæ›´æ–°ï¼š2026-02-11</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // é é¢åˆ‡æ›åŠŸèƒ½
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if(id==='lunchPage') { loadLunchSummary(); checkMyOrder(); checkDeadline(); }
            if(id==='settingsPage') renderLocationList();
        }

        // ===== ä¾¿ç•¶è¨‚è³¼ =====
        let selectedLunchType = null;
        let myCurrentOrder = null;
        const LUNCH_DEADLINE_HOUR = 10; // 10:00 æˆªæ­¢

        function checkDeadline() {
            const el = document.getElementById('lunchDeadline');
            const now = new Date();
            const h = now.getHours();
            if (h >= LUNCH_DEADLINE_HOUR) {
                el.style.background = '#FEF2F2'; el.style.color = '#DC2626';
                el.innerHTML = `â° ä»Šæ—¥è¨‚è³¼å·²æˆªæ­¢ï¼ˆ${LUNCH_DEADLINE_HOUR}:00 å‰å¯è¨‚è³¼ï¼‰<br><span style="font-size:11px;opacity:0.7;">æ˜æ—¥è¨‚å–®è«‹æ˜å¤©å†ä¾†</span>`;
                // é–å®šè¡¨å–®
                document.getElementById('lunchForm').style.opacity = '0.4';
                document.getElementById('lunchForm').style.pointerEvents = 'none';
            } else {
                const remain = LUNCH_DEADLINE_HOUR - h - 1;
                const mins = 60 - now.getMinutes();
                el.style.background = '#ECFDF5'; el.style.color = '#059669';
                el.innerHTML = `âœ… è¨‚è³¼ä¸­ â€” æˆªæ­¢æ™‚é–“ ${LUNCH_DEADLINE_HOUR}:00ï¼ˆå‰© ${remain > 0 ? remain + 'å°æ™‚' : ''}${mins}åˆ†é˜ï¼‰`;
                document.getElementById('lunchForm').style.opacity = '1';
                document.getElementById('lunchForm').style.pointerEvents = 'auto';
            }
        }

        async function checkMyOrder() {
            const card = document.getElementById('myOrderCard');
            const content = document.getElementById('myOrderContent');
            const actions = document.getElementById('myOrderActions');
            if (!currentEmployee || !card) return;
            
            const todayStr = fmtDate(new Date());
            try {
                const { data } = await sb.from('lunch_orders')
                    .select('*')
                    .eq('employee_id', currentEmployee.id)
                    .eq('order_date', todayStr)
                    .maybeSingle();
                
                myCurrentOrder = data;
                if (!data) { card.style.display = 'none'; return; }
                
                card.style.display = 'block';
                const isVeg = data.is_vegetarian;
                const isCancelled = data.status === 'cancelled';
                const emoji = isCancelled ? 'ğŸ’°' : (isVeg ? 'ğŸ¥—' : 'ğŸ–');
                const label = isCancelled ? 'ä¸è¨‚è³¼ï¼ˆè£œåŠ© $50ï¼‰' : (isVeg ? 'ç´ é£Ÿä¾¿ç•¶' : 'è‘·é£Ÿä¾¿ç•¶');
                const statusColor = isCancelled ? '#EA580C' : '#059669';
                
                content.innerHTML = `
                    <div style="display:flex;align-items:center;gap:10px;padding:10px;background:#F8FAFC;border-radius:10px;">
                        <span style="font-size:28px;">${emoji}</span>
                        <div style="flex:1;">
                            <div style="font-weight:700;">${label}</div>
                            <div style="font-size:11px;color:#94A3B8;">è¨‚è³¼æ—¥æœŸï¼š${data.order_date}${data.notes ? ' Â· ' + data.notes : ''}</div>
                        </div>
                        <span style="font-size:11px;font-weight:700;color:${statusColor};">${isCancelled ? 'å·²å–æ¶ˆ' : 'å·²è¨‚è³¼'}</span>
                    </div>
                `;
                
                // æˆªæ­¢å‰å¯ä¿®æ”¹
                const now = new Date();
                if (now.getHours() < LUNCH_DEADLINE_HOUR) {
                    actions.innerHTML = `
                        <button onclick="modifyLunchOrder('vegetarian')" style="flex:1;padding:10px;border:2px solid #059669;border-radius:10px;background:#ECFDF5;color:#059669;font-weight:700;font-size:12px;cursor:pointer;">ğŸ¥— æ”¹ç´ é£Ÿ</button>
                        <button onclick="modifyLunchOrder('regular')" style="flex:1;padding:10px;border:2px solid #2563EB;border-radius:10px;background:#EFF6FF;color:#2563EB;font-weight:700;font-size:12px;cursor:pointer;">ğŸ– æ”¹è‘·é£Ÿ</button>
                        <button onclick="cancelLunchOrder()" style="flex:1;padding:10px;border:2px solid #DC2626;border-radius:10px;background:#FEF2F2;color:#DC2626;font-weight:700;font-size:12px;cursor:pointer;">âŒ å–æ¶ˆ</button>
                    `;
                } else {
                    actions.innerHTML = '<span style="font-size:12px;color:#94A3B8;">â° å·²éæˆªæ­¢æ™‚é–“ï¼Œç„¡æ³•ä¿®æ”¹</span>';
                }
            } catch(e) { console.error(e); }
        }

        function selectLunchType(type) {
            selectedLunchType = type;
            document.querySelectorAll('.lunch-choice').forEach(c => { c.style.borderColor = '#E5E7EB'; c.style.background = '#fff'; });
            document.querySelectorAll('.lunch-check').forEach(c => { c.style.borderColor = '#CBD5E1'; c.style.background = 'transparent'; c.innerHTML = ''; });
            
            const choices = document.querySelectorAll('.lunch-choice');
            const checks = { regular: 'lunchCheckRegular', vegetarian: 'lunchCheckVeg', none: 'lunchCheckNone' };
            const idx = { regular:0, vegetarian:1, none:2 }[type];
            
            if (choices[idx]) { choices[idx].style.borderColor = '#4F46E5'; choices[idx].style.background = '#F5F3FF'; }
            const ck = document.getElementById(checks[type]);
            if (ck) { ck.style.borderColor = '#4F46E5'; ck.style.background = '#4F46E5'; ck.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" style="margin:2px;"><path fill="white" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>'; }
            
            const btn = document.getElementById('lunchSubmitBtn');
            btn.disabled = false; btn.style.opacity = '1';
            const labels = { regular: 'âœ… ç¢ºèªè¨‚è³¼è‘·é£Ÿä¾¿ç•¶', vegetarian: 'âœ… ç¢ºèªè¨‚è³¼ç´ é£Ÿä¾¿ç•¶', none: 'âœ… ç¢ºèªä¸è¨‚è³¼ï¼ˆè£œåŠ© $50ï¼‰' };
            btn.textContent = labels[type];
        }

        async function submitLunchOrderNew() {
            if (!selectedLunchType || !currentEmployee) return;
            const dateEl = document.getElementById('lunchDate');
            if (!dateEl?.value) return showToast('è«‹é¸æ“‡æ—¥æœŸ');
            
            const msgs = { regular:'ç¢ºå®šè¨‚è³¼ã€Œè‘·é£Ÿä¾¿ç•¶ã€ï¼Ÿ', vegetarian:'ç¢ºå®šè¨‚è³¼ã€Œç´ é£Ÿä¾¿ç•¶ã€ï¼Ÿ', none:'ç¢ºå®šä¸è¨‚è³¼ä¾¿ç•¶ï¼Ÿ\nå°‡ç²å¾— NT$ 50 åˆé¤è£œåŠ©' };
            if (!confirm(msgs[selectedLunchType])) return;
            
            try {
                await sb.from('lunch_orders').upsert({
                    employee_id: currentEmployee.id,
                    order_date: dateEl.value,
                    is_vegetarian: selectedLunchType === 'vegetarian',
                    status: selectedLunchType === 'none' ? 'cancelled' : 'ordered',
                    notes: document.getElementById('lunchNotes')?.value || (selectedLunchType === 'none' ? 'ä¸è¨‚è³¼ï¼Œè£œåŠ©NT$50' : '')
                }, { onConflict: 'employee_id,order_date' });
                
                showToast(selectedLunchType === 'none' ? 'ğŸ’° å·²å–æ¶ˆè¨‚è³¼ï¼ˆè£œåŠ©$50ï¼‰' : 'âœ… è¨‚è³¼æˆåŠŸï¼');
                checkMyOrder();
                loadLunchSummary();
            } catch(e) { showToast('âŒ è¨‚è³¼å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        async function modifyLunchOrder(newType) {
            if (!myCurrentOrder) return;
            const label = newType === 'vegetarian' ? 'ç´ é£Ÿ' : 'è‘·é£Ÿ';
            if (!confirm(`ç¢ºå®šæ”¹ç‚ºã€Œ${label}ä¾¿ç•¶ã€ï¼Ÿ`)) return;
            
            try {
                await sb.from('lunch_orders').update({
                    is_vegetarian: newType === 'vegetarian',
                    status: 'ordered',
                    notes: ''
                }).eq('id', myCurrentOrder.id);
                
                showToast(`âœ… å·²æ”¹ç‚º${label}ä¾¿ç•¶`);
                checkMyOrder(); loadLunchSummary();
            } catch(e) { showToast('âŒ ä¿®æ”¹å¤±æ•—'); }
        }

        async function cancelLunchOrder() {
            if (!myCurrentOrder) return;
            if (!confirm('ç¢ºå®šå–æ¶ˆè¨‚è³¼ï¼Ÿ\nå°‡ç²å¾— NT$ 50 åˆé¤è£œåŠ©')) return;
            
            try {
                await sb.from('lunch_orders').update({
                    status: 'cancelled',
                    notes: 'å–æ¶ˆè¨‚è³¼ï¼Œè£œåŠ©NT$50'
                }).eq('id', myCurrentOrder.id);
                
                showToast('ğŸ’° å·²å–æ¶ˆï¼ˆè£œåŠ©$50ï¼‰');
                checkMyOrder(); loadLunchSummary();
            } catch(e) { showToast('âŒ å–æ¶ˆå¤±æ•—'); }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        window.addEventListener('load', async () => {
            // ç¢ºä¿ common.js ä¸­çš„å‡½æ•¸å·²è¼‰å…¥
            if (typeof initializeLiff === 'undefined') {
                console.error('initializeLiff å‡½æ•¸æœªå®šç¾©ï¼Œè«‹æª¢æŸ¥ common.js æ˜¯å¦æ­£ç¢ºè¼‰å…¥');
                return;
            }
            
            // æ ¹æ“š hash æ±ºå®šé¡¯ç¤ºå“ªå€‹é é¢
            const hash = window.location.hash || '#lunch';
            let pageId = 'lunchPage';
            
            if (hash === '#settings') pageId = 'settingsPage';

            const initialized = await initializeLiff();
            if (initialized) {
                const isLoggedIn = await checkUserStatus();
                if (isLoggedIn) {
                    initBottomNav();
                    showPage(pageId);
                } else {
                    window.location.href = 'index.html';
                }
            }
        });
    </script>
    <!-- åº•éƒ¨å°èˆªåˆ— -->
    <nav class="bottom-nav" style="display:none;">
        <a class="nav-item" onclick="window.location.href='index.html'">
            <span class="nav-icon">ğŸ </span><span class="nav-label">é¦–é </span>
        </a>
        <a class="nav-item" onclick="window.location.href='schedule.html'">
            <span class="nav-icon">ğŸ“…</span><span class="nav-label">ç­è¡¨</span>
        </a>
        <a class="nav-item" onclick="window.location.href='checkin.html?type=in'">
            <span class="nav-icon">ğŸ“</span><span class="nav-label">æ‰“å¡</span>
        </a>
        <a class="nav-item" onclick="window.location.href='salary.html'">
            <span class="nav-icon">ğŸ’°</span><span class="nav-label">è–ªè³‡</span>
        </a>
        <a class="nav-item" onclick="window.location.href='admin.html'">
            <span class="nav-icon">âš™ï¸</span><span class="nav-label">ç®¡ç†</span>
        </a>
    </nav>

</body>
</html>
