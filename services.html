<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ± æœå‹™åŠŸèƒ½ - å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <!-- ä¾¿ç•¶è¨‚è³¼é é¢ -->
        <div id="lunchPage" class="page active">
            <button class="btn btn-secondary btn-auto-mb" onclick="window.location.href='index.html'">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ± ä¾¿ç•¶è¨‚è³¼</h2>
                <div class="lunar-notice" id="lunarNotice">ğŸŒ™ æ˜å¤©æ˜¯è¾²æ›†åˆä¸€/åäº”ï¼Œå»ºè­°è¨‚è³¼ç´ é£Ÿ</div>
                
                <!-- æˆªæ­¢æ™‚é–“æé†’ -->
                <div id="lunchDeadline" style="padding:10px 14px;border-radius:10px;margin-bottom:12px;font-size:13px;font-weight:700;"></div>

                <!-- æˆ‘çš„ä»Šæ—¥è¨‚å–® -->
                <div id="myOrderCard" class="order-card hidden">
                    <div class="text-heading-sm">ğŸ“‹ æˆ‘çš„è¨‚å–®</div>
                    <div id="myOrderContent" style="font-size:13px;"></div>
                    <div id="myOrderActions" style="margin-top:12px;" class="flex-gap-8"></div>
                </div>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:10px;">ğŸ“Š ä»Šæ—¥çµ±è¨ˆ</h3>
                    <div class="stat-row"><span>ç¸½æ•¸</span><span id="totalOrders">0</span></div>
                    <div class="stat-row"><span>ğŸ¥— ç´ é£Ÿ</span><span id="vegCount">0</span></div>
                    <div class="stat-row"><span>ğŸ– è‘·é£Ÿ</span><span id="regularCount">0</span></div>
                </div>

                <!-- ä¾¿ç•¶ç®¡ç†å“¡å ±è¡¨ï¼ˆåƒ…æŒ‡å®šäººå“¡å¯è¦‹ï¼‰ -->
                <div id="lunchManagerReport" style="display:none;">
                    <div class="lunch-summary" style="margin-top:12px;">
                        <h3 style="margin-bottom:12px;">ğŸ“‹ è¨‚è³¼æ˜ç´°å ±è¡¨</h3>
                        <div style="display:flex;gap:6px;margin-bottom:12px;">
                            <div style="flex:1;text-align:center;padding:10px;background:#ECFDF5;border-radius:10px;">
                                <div style="font-size:20px;font-weight:900;color:#059669;" id="rptTotal">0</div>
                                <div style="font-size:10px;font-weight:600;color:#059669;">å·²è¨‚è³¼</div>
                            </div>
                            <div style="flex:1;text-align:center;padding:10px;background:#EFF6FF;border-radius:10px;">
                                <div style="font-size:20px;font-weight:900;color:#2563EB;" id="rptRegular">0</div>
                                <div style="font-size:10px;font-weight:600;color:#2563EB;">ğŸ– è‘·é£Ÿ</div>
                            </div>
                            <div style="flex:1;text-align:center;padding:10px;background:#F5F3FF;border-radius:10px;">
                                <div style="font-size:20px;font-weight:900;color:#7C3AED;" id="rptVeg">0</div>
                                <div style="font-size:10px;font-weight:600;color:#7C3AED;">ğŸ¥— ç´ é£Ÿ</div>
                            </div>
                            <div style="flex:1;text-align:center;padding:10px;background:#FEF2F2;border-radius:10px;">
                                <div style="font-size:20px;font-weight:900;color:#DC2626;" id="rptNone">0</div>
                                <div style="font-size:10px;font-weight:600;color:#DC2626;">ğŸš« ä¸è¨‚</div>
                            </div>
                        </div>
                        <div id="lunchReportList" style="max-height:400px;overflow-y:auto;"></div>
                        <button onclick="exportLunchCSV()" style="width:100%;margin-top:12px;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:13px;cursor:pointer;">ğŸ“¥ åŒ¯å‡ºä»Šæ—¥ä¾¿ç•¶ CSV</button>
                    </div>
                </div>

                <!-- è¨‚è³¼è¡¨å–® -->
                <div id="lunchForm">
                    <div class="form-group"><label>è¨‚è³¼æ—¥æœŸ</label><input type="date" id="lunchDate"></div>
                    
                    <!-- ä¾¿ç•¶é¸æ“‡å¡ç‰‡ -->
                    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px;">
                        <div class="lunch-choice choice-card" onclick="selectLunchType('regular')">
                            <span style="font-size:28px;">ğŸ–</span>
                            <div class="flex-1"><b>è‘·é£Ÿä¾¿ç•¶</b><br><span class="text-sm-secondary">ä»Šæ—¥ä¸»èœç”±é¤å»³å®‰æ’</span></div>
                            <div class="lunch-check choice-check" id="lunchCheckRegular"></div>
                        </div>
                        <div class="lunch-choice choice-card" onclick="selectLunchType('vegetarian')">
                            <span style="font-size:28px;">ğŸ¥—</span>
                            <div class="flex-1"><b>ç´ é£Ÿä¾¿ç•¶</b><br><span class="text-sm-secondary">å¥åº·è”¬é£Ÿæ–™ç†</span></div>
                            <div class="lunch-check choice-check" id="lunchCheckVeg"></div>
                        </div>
                        <div class="lunch-choice choice-card" onclick="selectLunchType('none')">
                            <span style="font-size:28px;">ğŸš«</span>
                            <div class="flex-1"><b>ä¸è¨‚è³¼</b><br><span style="font-size:11px;color:#94A3B8;">ä»Šæ—¥ä¸éœ€è¦ä¾¿ç•¶</span></div>
                            <div class="lunch-check choice-check" id="lunchCheckNone"></div>
                        </div>
                    </div>

                    <div class="form-group"><label>å‚™è¨» (é¸å¡«)</label><input type="text" id="lunchNotes" placeholder="ä¾‹ï¼šä¸è¦é£¯"></div>
                    <button class="btn btn-success" id="lunchSubmitBtn" onclick="submitLunchOrderNew()" disabled style="opacity:0.5;">è«‹å…ˆé¸æ“‡ä¾¿ç•¶é¡å‹</button>
                </div>
            </div>
        </div>

        <!-- å¤–å‹¤/æ¥­å‹™ åˆä½µé é¢ -->
        <div id="fieldWorkPage" class="page">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“ å¤–å‹¤/æ¥­å‹™</h2>
                <!-- å¤–å‹¤/æ¥­å‹™ tab åˆ‡æ› -->
                <div id="fieldSalesTabs" style="display:flex;gap:4px;margin-bottom:16px;background:#F1F5F9;border-radius:10px;padding:3px;">
                    <button class="fwsTab" onclick="switchFieldSalesTab('fieldwork',this)" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:13px;background:#fff;color:#4F46E5;box-shadow:0 1px 4px rgba(0,0,0,0.08);">ğŸ“ å¤–å‹¤æ‰“å¡</button>
                    <button class="fwsTab" onclick="switchFieldSalesTab('sales',this)" style="flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:13px;background:transparent;color:#94A3B8;">ğŸ“Š æ¥­å‹™é€±å ±</button>
                </div>
                <div id="fwTabFieldwork">

                <!-- ä»Šæ—¥æ‘˜è¦ -->
                <div class="lunch-summary" id="fwSummaryCard">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="font-weight:700;font-size:14px;">ä»Šæ—¥å¤–å‹¤</span>
                        <span id="fwSummaryDate" style="font-size:12px;color:#64748B;"></span>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <div style="flex:1;text-align:center;padding:10px;background:#DBEAFE;border-radius:10px;">
                            <div style="font-size:20px;font-weight:900;color:#1E40AF;" id="fwStationCount">0</div>
                            <div style="font-size:10px;font-weight:600;color:#1E40AF;">ç«™æ¬¡</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:10px;background:#D1FAE5;border-radius:10px;">
                            <div style="font-size:20px;font-weight:900;color:#059669;" id="fwTotalHours">0.0</div>
                            <div style="font-size:10px;font-weight:600;color:#059669;">å·¥æ™‚(h)</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:10px;background:#FEF3C7;border-radius:10px;">
                            <div style="font-size:20px;font-weight:900;color:#92400E;" id="fwTotalKm">0</div>
                            <div style="font-size:10px;font-weight:600;color:#92400E;">é‡Œç¨‹(km)</div>
                        </div>
                    </div>
                </div>

                <!-- å ±å·¥åˆ—è¡¨ -->
                <div id="fwLogList" style="margin-bottom:12px;"></div>

                <!-- æ–°å¢å ±å·¥æŒ‰éˆ• -->
                <button class="btn btn-primary" id="fwAddBtn" onclick="showFieldWorkForm()" style="font-size:15px;padding:14px;border-radius:14px;">+ æ–°å¢å¤–å‹¤æ‰“å¡</button>

                <!-- å ±å·¥è¡¨å–®ï¼ˆé è¨­éš±è—ï¼‰ -->
                <div id="fwFormArea" style="display:none;margin-top:16px;">
                    <div class="binding-card">
                        <h3 style="margin-bottom:12px;" id="fwFormTitle">æ–°å¢å¤–å‹¤æ‰“å¡</h3>

                        <!-- å®¢æˆ¶é¸æ“‡ -->
                        <div class="form-group">
                            <label>å®¢æˆ¶ *</label>
                            <div style="display:flex;gap:8px;">
                                <select id="fwClientSelect" style="flex:1;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                                    <option value="">-- é¸æ“‡å®¢æˆ¶ --</option>
                                </select>
                                <button type="button" onclick="showQuickAddClientModal()" style="padding:12px 16px;border:none;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;white-space:nowrap;">+ æ–°å¢</button>
                            </div>
                        </div>

                        <!-- æœå‹™é …ç›®ï¼ˆæ¯å­éšå±¤ï¼‰ -->
                        <div class="form-group">
                            <label>æœå‹™é …ç›®</label>
                            <div id="fwServiceHierarchy"></div>
                        </div>

                        <!-- åˆ°é”æ‰“å¡ -->
                        <div id="fwArriveSection">
                            <button class="btn btn-success" onclick="fwArriveCheckin()" id="fwArriveBtn" style="font-size:14px;padding:14px;">
                                ğŸ“ åˆ°é”æ‰“å¡
                            </button>
                            <div id="fwArriveInfo" style="display:none;padding:10px;background:#D1FAE5;border-radius:10px;margin-top:8px;font-size:13px;color:#065F46;"></div>
                        </div>

                        <!-- å·¥ä½œå…§å®¹ï¼ˆåˆ°é”å¾Œé¡¯ç¤ºï¼‰ -->
                        <div id="fwContentSection" style="display:none;margin-top:12px;">
                            <div class="form-group">
                                <label>å·¥ä½œå…§å®¹</label>
                                <textarea id="fwWorkContent" rows="3" placeholder="æè¿°ä»Šæ—¥å·¥ä½œå…§å®¹..." style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;resize:vertical;box-sizing:border-box;"></textarea>
                            </div>

                            <!-- æ‹ç…§ -->
                            <div class="form-group">
                                <label>æ‹ç…§ï¼ˆæœ€å¤š 3 å¼µï¼‰</label>
                                <div id="fwPhotoPreview" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;"></div>
                                <button class="btn btn-secondary" onclick="fwCapturePhoto()" id="fwPhotoBtn" style="font-size:13px;padding:10px;">
                                    ğŸ“· æ‹ç…§
                                </button>
                                <!-- éš±è— file input å‚™ç”¨ -->
                                <input type="file" id="fwFileInput" accept="image/*" capture="environment" style="display:none;" onchange="fwHandleFileSelect(event)">
                            </div>

                            <!-- é‡Œç¨‹ -->
                            <div class="form-group">
                                <label>é‡Œç¨‹ï¼ˆå…¬é‡Œï¼‰</label>
                                <input type="number" id="fwMileage" placeholder="0" min="0" step="0.1" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                            </div>

                            <!-- å®¢æˆ¶ç°½å -->
                            <div class="form-group">
                                <label>å®¢æˆ¶ç°½å</label>
                                <div id="fwSignatureArea" style="position:relative;">
                                    <canvas id="fwSignatureCanvas" width="320" height="160" style="border:2px dashed #CBD5E1;border-radius:10px;background:#fff;touch-action:none;width:100%;"></canvas>
                                    <div style="display:flex;gap:8px;margin-top:6px;">
                                        <button class="btn btn-secondary" onclick="fwClearSignature()" style="flex:1;font-size:12px;padding:8px;">æ¸…é™¤ç°½å</button>
                                    </div>
                                </div>
                                <div id="fwSignatureStatus" style="font-size:12px;color:#94A3B8;margin-top:4px;"></div>
                            </div>

                            <!-- å‚™è¨» -->
                            <div class="form-group">
                                <label>å‚™è¨»</label>
                                <input type="text" id="fwNotes" placeholder="é¸å¡«" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                            </div>

                            <!-- é›¢é–‹æ‰“å¡ -->
                            <button class="btn btn-primary" onclick="fwLeaveCheckin()" id="fwLeaveBtn" style="font-size:14px;padding:14px;margin-top:8px;">
                                ğŸ“ é›¢é–‹æ‰“å¡ & é€å‡º
                            </button>
                            <div id="fwLeaveInfo" style="display:none;padding:10px;background:#DBEAFE;border-radius:10px;margin-top:8px;font-size:13px;color:#1E40AF;"></div>
                        </div>

                        <button class="btn btn-secondary" onclick="cancelFieldWorkForm()" style="margin-top:12px;font-size:13px;">å–æ¶ˆ</button>
                    </div>
                </div>
                </div><!-- /fwTabFieldwork -->

                <!-- æ¥­å‹™é€±å ± tab -->
                <div id="fwTabSales" style="display:none;">
                    <!-- é€±åˆ‡æ› -->
                    <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:16px;">
                        <button onclick="salesChangeWeek(-1)" style="padding:8px 14px;border:1px solid #E2E8F0;border-radius:10px;background:#fff;cursor:pointer;font-size:16px;">â†</button>
                        <span id="salesWeekLabel" style="font-weight:700;font-size:14px;min-width:180px;text-align:center;"></span>
                        <button onclick="salesChangeWeek(1)" style="padding:8px 14px;border:1px solid #E2E8F0;border-radius:10px;background:#fff;cursor:pointer;font-size:16px;">â†’</button>
                    </div>

                    <!-- æœ¬é€±é€²åº¦ -->
                    <div class="lunch-summary" id="salesProgressCard">
                        <h3 style="margin-bottom:12px;font-size:14px;">ğŸ¯ æœ¬é€±é€²åº¦</h3>
                        <div style="margin-bottom:12px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                                <span style="font-size:13px;">ğŸ“ é›»è©±æ‹œè¨ª</span>
                                <span id="salesCallText" style="font-size:13px;font-weight:700;">0 / 0</span>
                            </div>
                            <div style="width:100%;height:8px;background:#E2E8F0;border-radius:4px;overflow:hidden;">
                                <div id="salesCallBar" style="height:100%;background:linear-gradient(90deg,#4F46E5,#7C3AED);border-radius:4px;transition:width 0.3s;width:0%;"></div>
                            </div>
                        </div>
                        <div>
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                                <span style="font-size:13px;">ğŸ¢ å¯¦åœ°æ‹œè¨ª</span>
                                <span id="salesVisitText" style="font-size:13px;font-weight:700;">0 / 0</span>
                            </div>
                            <div style="width:100%;height:8px;background:#E2E8F0;border-radius:4px;overflow:hidden;">
                                <div id="salesVisitBar" style="height:100%;background:linear-gradient(90deg,#059669,#10B981);border-radius:4px;transition:width 0.3s;width:0%;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- å¿«é€Ÿè¨˜éŒ„æŒ‰éˆ• -->
                    <div style="display:flex;gap:8px;margin-bottom:16px;">
                        <button onclick="showSalesActivityModal('call')" style="flex:1;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ“ è¨˜éŒ„é›»è©±</button>
                        <button onclick="showSalesActivityModal('visit')" style="flex:1;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#059669,#10B981);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ¢ è¨˜éŒ„æ‹œè¨ª</button>
                    </div>

                    <!-- æœ¬é€±æ´»å‹•åˆ—è¡¨ -->
                    <div id="salesActivityList"></div>
                </div><!-- /fwTabSales -->
            </div>
        </div>

        <!-- æ–°å¢æ¥­å‹™æ´»å‹• Modal -->
        <div id="salesActivityModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;padding:20px;">
            <div style="background:#fff;border-radius:16px;width:100%;max-width:400px;max-height:90vh;overflow-y:auto;padding:24px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h3 id="salesModalTitle" style="margin:0;font-size:18px;">ğŸ“ è¨˜éŒ„é›»è©±æ‹œè¨ª</h3>
                    <button onclick="closeSalesActivityModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#94A3B8;padding:0;line-height:1;">Ã—</button>
                </div>
                <input type="hidden" id="saType" value="call">
                <div class="form-group">
                    <label>å®¢æˆ¶ *</label>
                    <div style="display:flex;gap:8px;">
                        <select id="saClientSelect" style="flex:1;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                            <option value="">-- é¸æ“‡å®¢æˆ¶ --</option>
                        </select>
                        <button type="button" onclick="showQuickAddClientModal()" style="padding:12px 16px;border:none;border-radius:10px;background:linear-gradient(135deg,#4F46E5,#7C3AED);color:#fff;font-weight:700;font-size:14px;cursor:pointer;white-space:nowrap;">+ æ–°å¢</button>
                    </div>
                </div>
                <!-- æœå‹™é …ç›®ï¼ˆæ¯å­éšå±¤ï¼ŒåŒå¤–å‹¤æ‰“å¡ï¼‰ -->
                <div class="form-group" id="saProductGroup">
                    <label>æœå‹™é …ç›®</label>
                    <div id="saServiceHierarchy"></div>
                </div>
                <div class="form-group">
                    <label>èªªæ˜</label>
                    <textarea id="saDescription" rows="2" placeholder="é¸å¡«" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;resize:vertical;box-sizing:border-box;"></textarea>
                </div>
                <div class="form-group">
                    <label>æ™‚é•·ï¼ˆåˆ†é˜ï¼‰</label>
                    <input type="number" id="saDuration" placeholder="ä¾‹ï¼š30" min="0" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label>çµæœ</label>
                    <select id="saResult" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;">
                        <option value="">-- é¸æ“‡çµæœ --</option>
                        <option value="interested">ğŸŸ¢ æœ‰èˆˆè¶£</option>
                        <option value="follow-up">ğŸŸ¡ éœ€è¿½è¹¤</option>
                        <option value="closed">ğŸ‰ æˆäº¤</option>
                        <option value="rejected">ğŸ”´ æ‹’çµ•</option>
                        <option value="no-answer">âšª æœªæ¥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <input type="text" id="saNotes" placeholder="é¸å¡«" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div style="display:flex;gap:8px;margin-top:16px;">
                    <button onclick="closeSalesActivityModal()" style="flex:1;padding:14px;border:1px solid #E2E8F0;border-radius:10px;background:#fff;font-weight:600;font-size:14px;cursor:pointer;color:#64748B;">å–æ¶ˆ</button>
                    <button onclick="saveSalesActivity()" style="flex:1;padding:14px;border:none;border-radius:10px;background:linear-gradient(135deg,#059669,#10B981);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ’¾ å„²å­˜</button>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ–°å¢å®¢æˆ¶ Modal -->
        <div id="quickAddClientModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:none;align-items:center;justify-content:center;padding:20px;">
            <div style="background:#fff;border-radius:16px;width:100%;max-width:400px;max-height:90vh;overflow-y:auto;padding:24px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h3 style="margin:0;font-size:18px;">ğŸ¢ å¿«é€Ÿæ–°å¢å®¢æˆ¶</h3>
                    <button onclick="closeQuickAddClientModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#94A3B8;padding:0;line-height:1;">Ã—</button>
                </div>
                <div class="form-group">
                    <label>å…¬å¸åç¨± *</label>
                    <input type="text" id="qaClientName" placeholder="ä¾‹ï¼šå°åŒ—ç§‘æŠ€æœ‰é™å…¬å¸" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label>è¯çµ¡äºº</label>
                    <input type="text" id="qaClientContact" placeholder="ä¾‹ï¼šç‹å°æ˜" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label>é›»è©±</label>
                    <input type="tel" id="qaClientPhone" placeholder="ä¾‹ï¼š02-12345678" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label>åœ°å€ <span style="font-size:11px;color:#94A3B8;font-weight:400;">æˆ–ä½¿ç”¨å®šä½ï¼Œæ“‡ä¸€å³å¯</span></label>
                    <input type="text" id="qaClientAddress" placeholder="è¼¸å…¥åœ°å€" style="width:100%;padding:12px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;">
                    <input type="hidden" id="qaClientLat">
                    <input type="hidden" id="qaClientLng">
                    <button type="button" onclick="qaGetGPS()" style="width:100%;margin-top:8px;padding:10px;border:1px solid #4F46E5;border-radius:10px;background:#EEF2FF;color:#4F46E5;font-weight:600;font-size:13px;cursor:pointer;">ğŸ“ ç”¨ç›®å‰ä½ç½®å–ä»£åœ°å€</button>
                    <div id="qaGpsStatus" style="font-size:12px;color:#059669;margin-top:4px;display:none;"></div>
                </div>
                <div style="display:flex;gap:8px;margin-top:16px;">
                    <button onclick="closeQuickAddClientModal()" style="flex:1;padding:14px;border:1px solid #E2E8F0;border-radius:10px;background:#fff;font-weight:600;font-size:14px;cursor:pointer;color:#64748B;">å–æ¶ˆ</button>
                    <button onclick="saveQuickClient()" style="flex:1;padding:14px;border:none;border-radius:10px;background:linear-gradient(135deg,#059669,#10B981);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ’¾ å„²å­˜</button>
                </div>
            </div>
        </div>

        <!-- ç³»çµ±è¨­å®šé é¢ -->
        <div id="settingsPage" class="page">
            <button class="btn btn-secondary btn-auto-mb" onclick="window.location.href='index.html'">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
                
                <div class="lunch-summary">
                    <h3 style="margin-bottom:10px;">ğŸ“ ç›®å‰æ‰“å¡åœ°é»</h3>
                    <div id="locationList">
                        <p class="text-center-gray">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <div class="binding-card" style="margin-top: 20px;">
                    <h3 style="margin-bottom:15px;">â• æ–°å¢åœ°é»</h3>
                    <div class="form-group">
                        <label>åœ°é»åç¨±</label>
                        <input type="text" id="newLocName" placeholder="ä¾‹å¦‚ï¼šå°åŒ—åˆ†åº—">
                    </div>
                    <div class="form-group">
                        <label>æ‰“å¡åŠå¾‘ (å…¬å°º)</label>
                        <input type="number" id="newLocRadius" value="300">
                    </div>
                    <div class="form-group">
                        <label>åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="newLocLat" placeholder="ç·¯åº¦" readonly>
                            <input type="text" id="newLocLng" placeholder="ç¶“åº¦" readonly>
                        </div>
                        <button class="btn btn-primary" onclick="getCurrentGPSForSetting()" style="margin-top:10px; font-size:14px; padding:10px;">
                            ğŸ“ æŠ“å–ç›®å‰ä½ç½®
                        </button>
                    </div>
                    <button class="btn btn-success" onclick="addNewLocation()">ğŸ’¾ å„²å­˜æ–°åœ°é»</button>
                </div>

                <div class="form-group" style="margin-top:30px; text-align:center;">
                    <p style="color:#999; font-size:12px;">
                        ç³»çµ±ç‰ˆæœ¬ v11.0<br>
                        <span style="font-size:10px;">æœ€å¾Œæ›´æ–°ï¼š2026-02-11</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // é é¢åˆ‡æ›åŠŸèƒ½
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            document.getElementById(id).classList.add('active');

            if(id==='lunchPage') { loadLunchSummary(); checkMyOrder(); checkDeadline(); loadLunchManagerReport(); checkLunarNotice(); }
            if(id==='settingsPage') renderLocationList();
            if(id==='fieldWorkPage') initFieldWorkPage();
        }

        // å¤–å‹¤/æ¥­å‹™ tab åˆ‡æ›
        function switchFieldSalesTab(type, btn) {
            document.getElementById('fwTabFieldwork').style.display = type === 'fieldwork' ? 'block' : 'none';
            document.getElementById('fwTabSales').style.display = type === 'sales' ? 'block' : 'none';
            document.querySelectorAll('.fwsTab').forEach(t => {
                t.style.background = 'transparent';
                t.style.color = '#94A3B8';
                t.style.boxShadow = 'none';
            });
            if (btn) {
                btn.style.background = '#fff';
                btn.style.color = '#4F46E5';
                btn.style.boxShadow = '0 1px 4px rgba(0,0,0,0.08)';
            }
            if (type === 'sales') { loadClients().then(() => initSalesPage()); }
        }

        // ===== è¾²æ›†æ—¥æ›†ï¼ˆåˆä¸€/åäº”æé†’ï¼‰ =====
        // è¾²æ›†è³‡æ–™è¡¨ï¼ˆ1900~2100ï¼‰ï¼Œæ¯å€‹å€¼ç·¨ç¢¼è©²å¹´çš„æœˆå¤§å°ã€é–æœˆç­‰è³‡è¨Š
        const LUNAR_INFO = [
            0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,
            0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,
            0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,
            0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,
            0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,
            0x06ca0,0x0b550,0x15355,0x04da0,0x0a5b0,0x14573,0x052b0,0x0a9a8,0x0e950,0x06aa0,
            0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,
            0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b6a0,0x195a6,
            0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,
            0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x05ac0,0x0ab60,0x096d5,0x092e0,
            0x0c960,0x0d954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,
            0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0a930,
            0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,0x0ea65,0x0d530,
            0x05aa0,0x076a3,0x096d0,0x04afb,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,0x0d520,0x0dd45,
            0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,0x06d20,0x0ada0,
            0x14b63,0x09370,0x049f8,0x04970,0x064b0,0x168a6,0x0ea50,0x06aa0,0x1a6c4,0x0aae0,
            0x092e0,0x0d2e3,0x0c960,0x0d557,0x0d4a0,0x0da50,0x05d55,0x056a0,0x0a6d0,0x055d4,
            0x052d0,0x0a9b8,0x0a950,0x0b4a0,0x0b6a6,0x0ad50,0x055a0,0x0aba4,0x0a5b0,0x052b0,
            0x0b273,0x06930,0x07337,0x06aa0,0x0ad50,0x14b55,0x04b60,0x0a570,0x054e4,0x0d160,
            0x0e968,0x0d520,0x0daa0,0x16aa6,0x056d0,0x04ae0,0x0a9d4,0x0a4d0,0x0d150,0x0f252,
            0x0d520
        ];

        function lunarYearDays(y) {
            let sum = 348;
            for (let i = 0x8000; i > 0x8; i >>= 1) sum += (LUNAR_INFO[y - 1900] & i) ? 1 : 0;
            return sum + lunarLeapDays(y);
        }
        function lunarLeapMonth(y) { return LUNAR_INFO[y - 1900] & 0xf; }
        function lunarLeapDays(y) { return lunarLeapMonth(y) ? ((LUNAR_INFO[y - 1900] & 0x10000) ? 30 : 29) : 0; }
        function lunarMonthDays(y, m) { return (LUNAR_INFO[y - 1900] & (0x10000 >> m)) ? 30 : 29; }

        function solarToLunar(yy, mm, dd) {
            let offset = Math.floor((Date.UTC(yy, mm - 1, dd) - Date.UTC(1900, 0, 31)) / 86400000);
            let y = 1900;
            for (; y < 2101 && offset > 0; y++) offset -= lunarYearDays(y);
            if (offset < 0) { offset += lunarYearDays(--y); }

            const leap = lunarLeapMonth(y);
            let isLeap = false;
            let m = 1;
            for (; m < 13 && offset > 0; m++) {
                if (leap > 0 && m === (leap + 1) && !isLeap) { --m; isLeap = true; const d = lunarLeapDays(y); if (offset < d) break; offset -= d; isLeap = false; }
                const d = lunarMonthDays(y, m);
                if (offset < d) break;
                offset -= d;
            }
            if (leap > 0 && m === (leap + 1) && !isLeap) { --m; isLeap = true; }
            return { year: y, month: m, day: offset + 1, isLeap };
        }

        function checkLunarNotice() {
            const el = document.getElementById('lunarNotice');
            if (!el) return;
            try {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const lunar = solarToLunar(tomorrow.getFullYear(), tomorrow.getMonth() + 1, tomorrow.getDate());
                if (lunar.day === 1 || lunar.day === 15) {
                    el.textContent = `ğŸŒ™ æ˜å¤©æ˜¯è¾²æ›†${lunar.month}æœˆ${lunar.day === 1 ? 'åˆä¸€' : 'åäº”'}ï¼Œå»ºè­°è¨‚è³¼ç´ é£Ÿ`;
                    el.classList.add('show');
                } else {
                    // ä¹Ÿæª¢æŸ¥ä»Šå¤©
                    const today = new Date();
                    const lunarToday = solarToLunar(today.getFullYear(), today.getMonth() + 1, today.getDate());
                    if (lunarToday.day === 1 || lunarToday.day === 15) {
                        el.textContent = `ğŸŒ™ ä»Šå¤©æ˜¯è¾²æ›†${lunarToday.month}æœˆ${lunarToday.day === 1 ? 'åˆä¸€' : 'åäº”'}ï¼Œå»ºè­°è¨‚è³¼ç´ é£Ÿ`;
                        el.classList.add('show');
                    } else {
                        el.classList.remove('show');
                    }
                }
            } catch(e) { console.log('è¾²æ›†è¨ˆç®—éŒ¯èª¤', e); el.classList.remove('show'); }
        }

        // ===== ä¾¿ç•¶è¨‚è³¼ =====
        let selectedLunchType = null;
        let myCurrentOrder = null;
        const LUNCH_DEADLINE_HOUR = 9; // 9:00 æˆªæ­¢

        function checkDeadline() {
            const el = document.getElementById('lunchDeadline');
            const now = new Date();
            const h = now.getHours();
            if (h >= LUNCH_DEADLINE_HOUR) {
                el.style.background = '#FEF2F2'; el.style.color = '#DC2626';
                el.innerHTML = `â° ä»Šæ—¥è¨‚è³¼å·²æˆªæ­¢ï¼ˆ${LUNCH_DEADLINE_HOUR}:00 å‰å¯è¨‚è³¼ï¼‰<br><span style="font-size:11px;opacity:0.7;">æ˜æ—¥è¨‚å–®è«‹æ˜å¤©å†ä¾†</span>`;
                // é–å®šè¡¨å–®
                document.getElementById('lunchForm').style.opacity = '0.4';
                document.getElementById('lunchForm').style.pointerEvents = 'none';
            } else {
                const remain = LUNCH_DEADLINE_HOUR - h - 1;
                const mins = 60 - now.getMinutes();
                el.style.background = '#ECFDF5'; el.style.color = '#059669';
                el.innerHTML = `âœ… è¨‚è³¼ä¸­ â€” æˆªæ­¢æ™‚é–“ ${LUNCH_DEADLINE_HOUR}:00ï¼ˆå‰© ${remain > 0 ? remain + 'å°æ™‚' : ''}${mins}åˆ†é˜ï¼‰`;
                document.getElementById('lunchForm').style.opacity = '1';
                document.getElementById('lunchForm').style.pointerEvents = 'auto';
            }
        }

        async function checkMyOrder() {
            const card = document.getElementById('myOrderCard');
            const content = document.getElementById('myOrderContent');
            const actions = document.getElementById('myOrderActions');
            if (!currentEmployee || !card) return;
            
            const todayStr = getTaiwanDate();
            try {
                const { data } = await sb.from('lunch_orders')
                    .select('*')
                    .eq('employee_id', currentEmployee.id)
                    .eq('order_date', todayStr)
                    .maybeSingle();
                
                myCurrentOrder = data;
                if (!data) { card.classList.add('hidden'); return; }

                card.classList.remove('hidden');
                const isVeg = data.is_vegetarian;
                const isCancelled = data.status === 'cancelled';
                const emoji = isCancelled ? 'ğŸš«' : (isVeg ? 'ğŸ¥—' : 'ğŸ–');
                const label = isCancelled ? 'ä¸è¨‚è³¼' : (isVeg ? 'ç´ é£Ÿä¾¿ç•¶' : 'è‘·é£Ÿä¾¿ç•¶');
                const statusColor = isCancelled ? '#EA580C' : '#059669';
                
                content.innerHTML = `
                    <div class="flex-center-gap-8" style="padding:10px;background:#F8FAFC;border-radius:10px;">
                        <span style="font-size:28px;">${emoji}</span>
                        <div class="flex-1">
                            <div style="font-weight:700;">${label}</div>
                            <div class="text-sm-secondary">è¨‚è³¼æ—¥æœŸï¼š${data.order_date}${data.notes ? ' Â· ' + data.notes : ''}</div>
                        </div>
                        <span style="font-size:11px;font-weight:700;color:${statusColor};">${isCancelled ? 'å·²å–æ¶ˆ' : 'å·²è¨‚è³¼'}</span>
                    </div>
                `;
                
                // æˆªæ­¢å‰å¯ä¿®æ”¹
                const now = new Date();
                if (now.getHours() < LUNCH_DEADLINE_HOUR) {
                    actions.innerHTML = `
                        <button class="modify-btn" onclick="modifyLunchOrder('vegetarian')" style="border-color:#059669;background:#ECFDF5;color:#059669;">ğŸ¥— æ”¹ç´ é£Ÿ</button>
                        <button class="modify-btn" onclick="modifyLunchOrder('regular')" style="border-color:#2563EB;background:#EFF6FF;color:#2563EB;">ğŸ– æ”¹è‘·é£Ÿ</button>
                        <button class="modify-btn" onclick="cancelLunchOrder()" style="border-color:#DC2626;background:#FEF2F2;color:#DC2626;">âŒ å–æ¶ˆ</button>
                    `;
                } else {
                    actions.innerHTML = '<span style="font-size:12px;color:#94A3B8;">â° å·²éæˆªæ­¢æ™‚é–“ï¼Œç„¡æ³•ä¿®æ”¹</span>';
                }
            } catch(e) { console.error(e); }
        }

        function selectLunchType(type) {
            selectedLunchType = type;
            document.querySelectorAll('.lunch-choice').forEach(c => c.classList.remove('selected'));
            document.querySelectorAll('.lunch-check').forEach(c => { c.classList.remove('checked'); c.innerHTML = ''; });

            const choices = document.querySelectorAll('.lunch-choice');
            const checks = { regular: 'lunchCheckRegular', vegetarian: 'lunchCheckVeg', none: 'lunchCheckNone' };
            const idx = { regular:0, vegetarian:1, none:2 }[type];

            if (choices[idx]) choices[idx].classList.add('selected');
            const ck = document.getElementById(checks[type]);
            if (ck) { ck.classList.add('checked'); ck.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" style="margin:2px;"><path fill="white" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>'; }
            
            const btn = document.getElementById('lunchSubmitBtn');
            btn.disabled = false; btn.style.opacity = '1';
            const labels = { regular: 'âœ… ç¢ºèªè¨‚è³¼è‘·é£Ÿä¾¿ç•¶', vegetarian: 'âœ… ç¢ºèªè¨‚è³¼ç´ é£Ÿä¾¿ç•¶', none: 'âœ… ç¢ºèªä¸è¨‚è³¼' };
            btn.textContent = labels[type];
        }

        async function submitLunchOrderNew() {
            if (!selectedLunchType || !currentEmployee) return;
            const dateEl = document.getElementById('lunchDate');
            if (!dateEl?.value) return showToast('è«‹é¸æ“‡æ—¥æœŸ');
            
            const msgs = { regular:'ç¢ºå®šè¨‚è³¼ã€Œè‘·é£Ÿä¾¿ç•¶ã€ï¼Ÿ', vegetarian:'ç¢ºå®šè¨‚è³¼ã€Œç´ é£Ÿä¾¿ç•¶ã€ï¼Ÿ', none:'ç¢ºå®šä¸è¨‚è³¼ä¾¿ç•¶ï¼Ÿ' };
            if (!confirm(msgs[selectedLunchType])) return;
            
            try {
                await sb.from('lunch_orders').upsert({
                    employee_id: currentEmployee.id,
                    order_date: dateEl.value,
                    is_vegetarian: selectedLunchType === 'vegetarian',
                    status: selectedLunchType === 'none' ? 'cancelled' : 'ordered',
                    notes: document.getElementById('lunchNotes')?.value || (selectedLunchType === 'none' ? 'ä»Šæ—¥ä¸è¨‚è³¼' : '')
                }, { onConflict: 'employee_id,order_date' });
                
                showToast(selectedLunchType === 'none' ? 'ğŸš« å·²ç¢ºèªä¸è¨‚è³¼' : 'âœ… è¨‚è³¼æˆåŠŸï¼');
                checkMyOrder();
                loadLunchSummary();
            } catch(e) { showToast('âŒ è¨‚è³¼å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        async function modifyLunchOrder(newType) {
            if (!myCurrentOrder) return;
            const label = newType === 'vegetarian' ? 'ç´ é£Ÿ' : 'è‘·é£Ÿ';
            if (!confirm(`ç¢ºå®šæ”¹ç‚ºã€Œ${label}ä¾¿ç•¶ã€ï¼Ÿ`)) return;
            
            try {
                await sb.from('lunch_orders').update({
                    is_vegetarian: newType === 'vegetarian',
                    status: 'ordered',
                    notes: ''
                }).eq('id', myCurrentOrder.id);
                
                showToast(`âœ… å·²æ”¹ç‚º${label}ä¾¿ç•¶`);
                checkMyOrder(); loadLunchSummary();
            } catch(e) { showToast('âŒ ä¿®æ”¹å¤±æ•—'); }
        }

        async function cancelLunchOrder() {
            if (!myCurrentOrder) return;
            if (!confirm('ç¢ºå®šå–æ¶ˆè¨‚è³¼ï¼Ÿ')) return;
            
            try {
                await sb.from('lunch_orders').update({
                    status: 'cancelled',
                    notes: 'å–æ¶ˆè¨‚è³¼'
                }).eq('id', myCurrentOrder.id);
                
                showToast('ğŸš« å·²å–æ¶ˆè¨‚è³¼');
                checkMyOrder(); loadLunchSummary();
            } catch(e) { showToast('âŒ å–æ¶ˆå¤±æ•—'); }
        }

        // ===== ä¾¿ç•¶ç®¡ç†å“¡å ±è¡¨ =====
        let lunchReportData = [];

        function checkIsLunchManager() {
            if (!currentEmployee) return false;
            const setting = getCachedSetting('lunch_managers');
            if (!setting?.employee_ids) return false;
            return setting.employee_ids.includes(currentEmployee.id);
        }

        async function loadLunchManagerReport() {
            const reportEl = document.getElementById('lunchManagerReport');
            if (!reportEl) return;
            // ç®¡ç†å“¡ä¹Ÿå¯ä»¥çœ‹
            const isAdmin = currentEmployee?.role === 'admin';
            if (!checkIsLunchManager() && !isAdmin) { reportEl.style.display = 'none'; return; }

            reportEl.style.display = 'block';
            const todayStr = getTaiwanDate(0);

            try {
                const { data, error } = await sb.from('lunch_orders')
                    .select('*, employees(name, employee_number)')
                    .eq('order_date', todayStr);
                if (error) throw error;
                lunchReportData = data || [];

                const ordered = lunchReportData.filter(o => o.status === 'ordered');
                const cancelled = lunchReportData.filter(o => o.status === 'cancelled');
                const veg = ordered.filter(o => o.is_vegetarian);
                const regular = ordered.filter(o => !o.is_vegetarian);

                document.getElementById('rptTotal').textContent = ordered.length;
                document.getElementById('rptRegular').textContent = regular.length;
                document.getElementById('rptVeg').textContent = veg.length;
                document.getElementById('rptNone').textContent = cancelled.length;

                const listEl = document.getElementById('lunchReportList');
                if (lunchReportData.length === 0) {
                    listEl.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">ä»Šæ—¥å°šç„¡è¨‚è³¼è¨˜éŒ„</p>';
                    return;
                }

                const sorted = [...regular.sort((a,b) => (a.employees?.name||'').localeCompare(b.employees?.name||'')),
                                ...veg.sort((a,b) => (a.employees?.name||'').localeCompare(b.employees?.name||'')),
                                ...cancelled.sort((a,b) => (a.employees?.name||'').localeCompare(b.employees?.name||''))];

                listEl.innerHTML = sorted.map(o => {
                    const isCancelled = o.status === 'cancelled';
                    const emoji = isCancelled ? 'ğŸš«' : (o.is_vegetarian ? 'ğŸ¥—' : 'ğŸ–');
                    const label = isCancelled ? 'ä¸è¨‚è³¼' : (o.is_vegetarian ? 'ç´ é£Ÿ' : 'è‘·é£Ÿ');
                    const color = isCancelled ? '#94A3B8' : (o.is_vegetarian ? '#7C3AED' : '#2563EB');
                    return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #F1F5F9;">
                        <span style="font-size:20px;">${emoji}</span>
                        <div style="flex:1;">
                            <div style="font-weight:700;font-size:13px;">${escapeHTML(o.employees?.name || '?')}</div>
                            <div style="font-size:11px;color:#94A3B8;">${escapeHTML(o.employees?.employee_number || '')}</div>
                        </div>
                        <span style="font-size:12px;font-weight:700;color:${color};">${label}</span>
                    </div>`;
                }).join('');
            } catch(e) {
                console.error('ä¾¿ç•¶å ±è¡¨è¼‰å…¥å¤±æ•—', e);
                document.getElementById('lunchReportList').innerHTML = '<p style="color:#ef4444;text-align:center;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        function exportLunchCSV() {
            if (lunchReportData.length === 0) return showToast('ç„¡è³‡æ–™å¯åŒ¯å‡º');
            const todayStr = getTaiwanDate(0);
            const rows = [['æ—¥æœŸ','å·¥è™Ÿ','å§“å','é¡å‹','ç‹€æ…‹','å‚™è¨»']];
            lunchReportData.forEach(o => {
                rows.push([
                    o.order_date,
                    o.employees?.employee_number || '',
                    o.employees?.name || '',
                    o.is_vegetarian ? 'ç´ é£Ÿ' : 'è‘·é£Ÿ',
                    o.status === 'cancelled' ? 'ä¸è¨‚è³¼' : 'å·²è¨‚è³¼',
                    o.notes || o.special_requirements || ''
                ]);
            });
            const csv = '\uFEFF' + rows.map(r => r.map(c => `"${String(c??'').replace(/"/g,'""')}"`).join(',')).join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            a.download = `ä¾¿ç•¶è¨‚è³¼_${todayStr}.csv`;
            a.click();
            showToast(`âœ… å·²åŒ¯å‡º ä¾¿ç•¶è¨‚è³¼_${todayStr}.csv`);
        }

        // ===== å¤–å‹¤æ‰“å¡ =====
        let fwClients = [];
        let fwServiceItems = [];
        let fwLogs = [];
        let fwCurrentLogId = null;   // æ­£åœ¨ç·¨è¼¯çš„ draft
        let fwPhotoUrls = [];        // æœ¬æ¬¡æ‹ç…§ URL
        let fwSignatureCtx = null;
        let fwSigning = false;

        async function initFieldWorkPage() {
            const dateEl = document.getElementById('fwSummaryDate');
            if (dateEl) dateEl.textContent = getTaiwanDate();
            fwPhotoUrls = [];
            fwCurrentLogId = null;
            try {
                await Promise.all([loadClients(), loadServiceItems(), loadFieldWorkLogs()]);
            } catch(e) {
                console.error('å¤–å‹¤é é¢åˆå§‹åŒ–å¤±æ•—', e);
                showToast('âš ï¸ éƒ¨åˆ†è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†');
            }
        }

        async function loadClients() {
            try {
                const { data } = await sb.from('clients').select('*').eq('is_active', true).order('company_name');
                fwClients = data || [];
                const sel = document.getElementById('fwClientSelect');
                if (!sel) return;
                sel.innerHTML = '<option value="">-- é¸æ“‡å®¢æˆ¶ --</option>' +
                    fwClients.map(c => `<option value="${c.id}">${escapeHTML(c.company_name)}${c.category === 'vip' ? ' â­' : ''}</option>`).join('');
            } catch(e) { console.error('è¼‰å…¥å®¢æˆ¶å¤±æ•—', e); }
        }

        // ===== å¿«é€Ÿæ–°å¢å®¢æˆ¶ =====
        function showQuickAddClientModal() {
            const modal = document.getElementById('quickAddClientModal');
            modal.style.display = 'flex';
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('qaClientName').value = '';
            document.getElementById('qaClientContact').value = '';
            document.getElementById('qaClientPhone').value = '';
            document.getElementById('qaClientAddress').value = '';
            document.getElementById('qaClientLat').value = '';
            document.getElementById('qaClientLng').value = '';
            // è‡ªå‹•å–å¾— GPS
            qaGetGPS();
        }

        function closeQuickAddClientModal() {
            document.getElementById('quickAddClientModal').style.display = 'none';
        }

        async function qaGetGPS() {
            const statusEl = document.getElementById('qaGpsStatus');
            try {
                const loc = await getGPS();
                document.getElementById('qaClientLat').value = loc.latitude.toFixed(6);
                document.getElementById('qaClientLng').value = loc.longitude.toFixed(6);
                if (statusEl) { statusEl.textContent = 'âœ… å·²å–å¾—å®šä½'; statusEl.style.display = 'block'; }
                // åå‘åœ°ç†ç·¨ç¢¼å¡«å…¥åœ°å€
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${loc.latitude}&lon=${loc.longitude}&format=json&accept-language=zh-TW`);
                    const geo = await res.json();
                    if (geo.display_name) {
                        document.getElementById('qaClientAddress').value = geo.display_name.split(',').slice(0, 3).join('');
                        if (statusEl) statusEl.textContent = 'âœ… å·²å–å¾—å®šä½åŠåœ°å€';
                    }
                } catch(e) {}
            } catch(e) {
                console.warn('GPS å–å¾—å¤±æ•—', e);
                showToast('âš ï¸ ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åœ°å€');
            }
        }

        async function saveQuickClient() {
            const name = document.getElementById('qaClientName').value.trim();
            if (!name) return showToast('è«‹è¼¸å…¥å…¬å¸åç¨±');

            const record = {
                company_name: name,
                contact_person: document.getElementById('qaClientContact').value.trim() || null,
                phone: document.getElementById('qaClientPhone').value.trim() || null,
                address: document.getElementById('qaClientAddress').value.trim() || null,
                latitude: parseFloat(document.getElementById('qaClientLat').value) || null,
                longitude: parseFloat(document.getElementById('qaClientLng').value) || null,
                is_active: true
            };

            try {
                const { data, error } = await sb.from('clients').insert(record).select().single();
                if (error) throw error;

                showToast('âœ… å®¢æˆ¶å·²æ–°å¢');
                closeQuickAddClientModal();

                // åˆ·æ–°ä¸‹æ‹‰ä¸¦è‡ªå‹•é¸ä¸­
                await loadClients();
                // å¦‚æœå¤–å‹¤è¡¨å–®é–‹è‘—ï¼Œè‡ªå‹•é¸ä¸­æ–°å®¢æˆ¶
                const fwSel = document.getElementById('fwClientSelect');
                if (fwSel) fwSel.value = data.id;
                // å¦‚æœæ¥­å‹™æ´»å‹• Modal é–‹è‘—ï¼Œä¹Ÿæ›´æ–°ä¸¦é¸ä¸­
                const saSel = document.getElementById('saClientSelect');
                if (saSel && document.getElementById('salesActivityModal')?.style.display === 'flex') {
                    saSel.innerHTML = '<option value="">-- é¸æ“‡å®¢æˆ¶ --</option>' +
                        fwClients.map(c => `<option value="${c.id}">${escapeHTML(c.company_name)}${c.category === 'vip' ? ' â­' : ''}</option>`).join('');
                    saSel.value = data.id;
                }
            } catch(e) {
                console.error(e);
                showToast('âŒ æ–°å¢å¤±æ•—ï¼š' + friendlyError(e));
            }
        }

        async function loadServiceItems() {
            try {
                const { data } = await sb.from('service_items').select('*').eq('is_active', true).order('name');
                fwServiceItems = data || [];
                renderFwServiceHierarchy();
            } catch(e) { console.error('è¼‰å…¥æœå‹™é …ç›®å¤±æ•—', e); }
        }

        function isUUIDCode(str) {
            return str && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(str);
        }

        function renderFwItemCard(s, on) {
            return `<div class="fwItemCard" data-id="${s.id}" data-selected="${on ? 'true' : 'false'}" onclick="toggleProductCard(this)" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:${on ? '#F5F3FF' : '#fff'};border:2px solid ${on ? '#4F46E5' : '#E5E7EB'};border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;">
                <div style="width:22px;height:22px;border:2px solid ${on ? '#4F46E5' : '#CBD5E1'};border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;background:${on ? '#4F46E5' : '#fff'};color:#fff;font-size:14px;transition:all 0.2s;">${on ? 'âœ“' : ''}</div>
                <span style="flex:1;">${escapeHTML(s.name)}</span>
                <span onclick="event.stopPropagation();editFwItem('${s.id}')" style="font-size:14px;opacity:0.4;padding:2px;">âœï¸</span>
            </div>`;
        }

        function renderFwServiceHierarchy(selectedItems) {
            const el = document.getElementById('fwServiceHierarchy');
            if (!el) return;
            selectedItems = selectedItems || [];

            // åˆ†é¡ï¼šæ¯é¸é …(CAT)ã€å­é¸é …(UUID code)ã€æœªåˆ†é¡(å…¶ä»–)
            const categories = fwServiceItems.filter(s => s.code === 'CAT');
            const childrenMap = {};
            const uncategorized = [];
            fwServiceItems.forEach(s => {
                if (s.code === 'CAT') return;
                if (isUUIDCode(s.code)) {
                    if (!childrenMap[s.code]) childrenMap[s.code] = [];
                    childrenMap[s.code].push(s);
                } else {
                    uncategorized.push(s);
                }
            });

            let html = '';

            // å„æ¯é¸é …
            categories.forEach(cat => {
                const children = childrenMap[cat.id] || [];
                html += `<div style="margin-bottom:14px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <div style="display:flex;align-items:center;gap:6px;">
                            <span style="font-size:14px;font-weight:700;color:#0F172A;">${escapeHTML(cat.name)}</span>
                            <span onclick="editFwCategory('${cat.id}')" style="font-size:14px;cursor:pointer;opacity:0.4;">âœï¸</span>
                        </div>
                        <button type="button" onclick="toggleFwAddRow('fwProdAdd_${cat.id}','fwNewProd_${cat.id}')" style="padding:4px 12px;border:1px solid #059669;border-radius:8px;background:#ECFDF5;color:#059669;font-weight:700;font-size:12px;cursor:pointer;">+ æ–°å¢</button>
                    </div>
                    <div id="fwEditCat_${cat.id}" style="display:none;margin-bottom:8px;">
                        <div style="display:flex;gap:6px;">
                            <input id="fwEditCatName_${cat.id}" value="${escapeHTML(cat.name)}" style="flex:1;padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;">
                            <button onclick="saveFwCategoryEdit('${cat.id}')" style="padding:8px 12px;border:none;border-radius:8px;background:#4F46E5;color:#fff;font-weight:700;font-size:12px;cursor:pointer;">å„²å­˜</button>
                            <button onclick="deleteFwItem('${cat.id}')" style="padding:8px 12px;border:none;border-radius:8px;background:#DC2626;color:#fff;font-weight:700;font-size:12px;cursor:pointer;">åˆªé™¤</button>
                        </div>
                    </div>
                    <div id="fwProdAdd_${cat.id}" style="display:none;margin-bottom:8px;">
                        <div style="display:flex;gap:6px;">
                            <input id="fwNewProd_${cat.id}" placeholder="æ–°é …ç›®åç¨±" style="flex:1;padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;">
                            <button onclick="saveFwProduct('${cat.id}')" style="padding:8px 14px;border:none;border-radius:8px;background:#059669;color:#fff;font-weight:700;font-size:13px;cursor:pointer;">æ–°å¢</button>
                        </div>
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:8px;">
                        ${children.length > 0 ? children.map(s => renderFwItemCard(s, selectedItems.includes(s.id))).join('') : '<span style="color:#94A3B8;font-size:12px;">å°šç„¡é …ç›®ï¼Œè«‹é» +æ–°å¢</span>'}
                    </div>
                </div>`;
            });

            // æœªåˆ†é¡é …ç›®
            if (uncategorized.length > 0) {
                html += `<div style="margin-bottom:14px;">
                    <div style="font-size:14px;font-weight:700;color:#0F172A;margin-bottom:6px;">å…¶ä»–</div>
                    <div style="display:flex;flex-wrap:wrap;gap:8px;">
                        ${uncategorized.map(s => renderFwItemCard(s, selectedItems.includes(s.id))).join('')}
                    </div>
                </div>`;
            }

            // æ–°å¢æ¯é¸é …
            html += `<div id="fwCatAddRow" style="display:none;margin-bottom:8px;">
                <div style="display:flex;gap:6px;">
                    <input id="fwNewCatName" placeholder="æ–°æœå‹™é¡å‹åç¨±" style="flex:1;padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;">
                    <button onclick="saveFwCategory()" style="padding:8px 14px;border:none;border-radius:8px;background:#4F46E5;color:#fff;font-weight:700;font-size:13px;cursor:pointer;">æ–°å¢</button>
                </div>
            </div>
            <button type="button" onclick="toggleFwAddRow('fwCatAddRow','fwNewCatName')" style="padding:8px 14px;border:2px dashed #CBD5E1;border-radius:10px;background:#fff;color:#64748B;font-weight:700;font-size:13px;cursor:pointer;width:100%;">+ æ–°å¢æœå‹™é¡å‹</button>`;

            el.innerHTML = html;
        }

        function toggleFwAddRow(rowId, inputId) {
            const row = document.getElementById(rowId);
            if (!row) return;
            const show = row.style.display === 'none';
            row.style.display = show ? 'block' : 'none';
            if (show && inputId) document.getElementById(inputId)?.focus();
        }

        async function saveFwCategory() {
            const input = document.getElementById('fwNewCatName');
            const name = input?.value.trim();
            if (!name) return showToast('è«‹è¼¸å…¥æœå‹™é¡å‹åç¨±');
            try {
                const { data, error } = await sb.from('service_items').insert({ name, code: 'CAT', is_active: true }).select().single();
                if (error) throw error;
                input.value = '';
                document.getElementById('fwCatAddRow').style.display = 'none';
                fwServiceItems.push(data);
                renderFwServiceHierarchy();
                renderSaServiceHierarchy();
                showToast('âœ… å·²æ–°å¢æœå‹™é¡å‹ã€Œ' + name + 'ã€');
            } catch(e) { showToast('âŒ æ–°å¢å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        async function saveFwProduct(catId) {
            const input = document.getElementById('fwNewProd_' + catId);
            const name = input?.value.trim();
            if (!name) return showToast('è«‹è¼¸å…¥é …ç›®åç¨±');
            try {
                const { data, error } = await sb.from('service_items').insert({ name, code: catId, is_active: true }).select().single();
                if (error) throw error;
                input.value = '';
                document.getElementById('fwProdAdd_' + catId).style.display = 'none';
                fwServiceItems.push(data);
                renderFwServiceHierarchy();
                renderSaServiceHierarchy();
                showToast('âœ… å·²æ–°å¢ã€Œ' + name + 'ã€');
            } catch(e) { showToast('âŒ æ–°å¢å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        function editFwCategory(catId) {
            const row = document.getElementById('fwEditCat_' + catId);
            if (!row) return;
            const show = row.style.display === 'none';
            row.style.display = show ? 'block' : 'none';
            if (show) document.getElementById('fwEditCatName_' + catId)?.focus();
        }

        async function saveFwCategoryEdit(catId) {
            const input = document.getElementById('fwEditCatName_' + catId);
            const name = input?.value.trim();
            if (!name) return showToast('åç¨±ä¸å¯ç‚ºç©º');
            try {
                const { error } = await sb.from('service_items').update({ name }).eq('id', catId);
                if (error) throw error;
                const item = fwServiceItems.find(s => s.id === catId);
                if (item) item.name = name;
                renderFwServiceHierarchy();
                showToast('âœ… å·²æ›´æ–°');
            } catch(e) { showToast('âŒ æ›´æ–°å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        function editFwItem(itemId) {
            // é¡¯ç¤ºç·¨è¼¯ modalï¼ˆåº•éƒ¨å½ˆå‡ºï¼‰
            const item = fwServiceItems.find(s => s.id === itemId);
            if (!item) return;
            const existing = document.getElementById('fwItemEditOverlay');
            if (existing) existing.remove();
            const overlay = document.createElement('div');
            overlay.id = 'fwItemEditOverlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:flex-end;justify-content:center;';
            overlay.innerHTML = `<div style="background:#fff;border-radius:16px 16px 0 0;padding:20px;width:100%;max-width:500px;">
                <div style="font-size:15px;font-weight:800;margin-bottom:12px;">ç·¨è¼¯é …ç›®</div>
                <input id="fwEditItemName" value="${escapeHTML(item.name)}" style="width:100%;padding:10px;border:1px solid #E2E8F0;border-radius:10px;font-size:14px;box-sizing:border-box;margin-bottom:12px;">
                <div style="display:flex;gap:8px;">
                    <button onclick="saveFwItemEdit('${itemId}')" style="flex:1;padding:12px;border:none;border-radius:10px;background:#4F46E5;color:#fff;font-weight:700;font-size:14px;cursor:pointer;">å„²å­˜</button>
                    <button onclick="deleteFwItem('${itemId}')" style="padding:12px 16px;border:none;border-radius:10px;background:#DC2626;color:#fff;font-weight:700;font-size:14px;cursor:pointer;">ğŸ—‘ï¸</button>
                    <button onclick="document.getElementById('fwItemEditOverlay').remove()" style="padding:12px 16px;border:1px solid #E2E8F0;border-radius:10px;background:#fff;font-weight:700;font-size:14px;cursor:pointer;">å–æ¶ˆ</button>
                </div>
            </div>`;
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
            document.body.appendChild(overlay);
            document.getElementById('fwEditItemName')?.focus();
        }

        async function saveFwItemEdit(itemId) {
            const input = document.getElementById('fwEditItemName');
            const name = input?.value.trim();
            if (!name) return showToast('åç¨±ä¸å¯ç‚ºç©º');
            try {
                const { error } = await sb.from('service_items').update({ name }).eq('id', itemId);
                if (error) throw error;
                const item = fwServiceItems.find(s => s.id === itemId);
                if (item) item.name = name;
                document.getElementById('fwItemEditOverlay')?.remove();
                renderFwServiceHierarchy();
                renderSaServiceHierarchy();
                showToast('âœ… å·²æ›´æ–°');
            } catch(e) { showToast('âŒ æ›´æ–°å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        async function deleteFwItem(itemId) {
            const item = fwServiceItems.find(s => s.id === itemId);
            if (!item) return;
            const isCat = item.code === 'CAT';
            const msg = isCat ? `ç¢ºå®šåˆªé™¤ã€Œ${item.name}ã€åŠå…¶ä¸‹æ‰€æœ‰å­é …ç›®ï¼Ÿ` : `ç¢ºå®šåˆªé™¤ã€Œ${item.name}ã€ï¼Ÿ`;
            if (!confirm(msg)) return;
            try {
                // åœç”¨æ­¤é …ç›®
                await sb.from('service_items').update({ is_active: false }).eq('id', itemId);
                // è‹¥ç‚ºæ¯é¸é …ï¼ŒåŒæ™‚åœç”¨æ‰€æœ‰å­é …ç›®
                if (isCat) {
                    await sb.from('service_items').update({ is_active: false }).eq('code', itemId);
                    fwServiceItems = fwServiceItems.filter(s => s.id !== itemId && s.code !== itemId);
                } else {
                    fwServiceItems = fwServiceItems.filter(s => s.id !== itemId);
                }
                document.getElementById('fwItemEditOverlay')?.remove();
                renderFwServiceHierarchy();
                renderSaServiceHierarchy();
                showToast('âœ… å·²åˆªé™¤');
            } catch(e) { showToast('âŒ åˆªé™¤å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        function getSelectedFwItems() {
            const ids = [];
            document.querySelectorAll('.fwItemCard').forEach(card => {
                if (card.dataset.selected === 'true') ids.push(card.dataset.id);
            });
            return ids;
        }

        async function loadFieldWorkLogs() {
            if (!currentEmployee) return;
            try {
                const todayStr = getTaiwanDate();
                const { data } = await sb.from('field_work_logs')
                    .select('*, clients(company_name), service_items(name)')
                    .eq('employee_id', currentEmployee.id)
                    .eq('work_date', todayStr)
                    .order('created_at', { ascending: false });
                fwLogs = data || [];
                renderFieldWorkLogs();
                updateFieldWorkSummary();
            } catch(e) { console.error('è¼‰å…¥å ±å·¥ç´€éŒ„å¤±æ•—', e); }
        }

        function updateFieldWorkSummary() {
            const completed = fwLogs.filter(l => l.status !== 'draft');
            document.getElementById('fwStationCount').textContent = fwLogs.length;
            const totalH = fwLogs.reduce((s, l) => s + (l.work_hours || 0), 0);
            document.getElementById('fwTotalHours').textContent = totalH.toFixed(1);
            const totalKm = fwLogs.reduce((s, l) => s + (l.mileage || 0), 0);
            document.getElementById('fwTotalKm').textContent = Math.round(totalKm);
        }

        function renderFieldWorkLogs() {
            const el = document.getElementById('fwLogList');
            if (!el) return;
            if (fwLogs.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">ä»Šæ—¥å°šç„¡å¤–å‹¤ç´€éŒ„</p>';
                return;
            }
            el.innerHTML = fwLogs.map(log => {
                const statusMap = { draft:'ğŸŸ¡ é€²è¡Œä¸­', submitted:'ğŸ”µ å·²é€å‡º', approved:'ğŸŸ¢ å·²æ ¸å‡†', rejected:'ğŸ”´ é€€å›' };
                const statusLabel = statusMap[log.status] || log.status;
                const clientName = log.clients?.company_name || 'æœªé¸æ“‡å®¢æˆ¶';
                const serviceName = log.service_items?.name || '';
                const arriveT = log.arrive_time ? new Date(log.arrive_time).toLocaleTimeString('zh-TW', { hour:'2-digit', minute:'2-digit' }) : '--:--';
                const leaveT = log.leave_time ? new Date(log.leave_time).toLocaleTimeString('zh-TW', { hour:'2-digit', minute:'2-digit' }) : '--:--';
                const hours = log.work_hours ? log.work_hours.toFixed(1) + 'h' : '';
                return `<div style="background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:14px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <span style="font-weight:700;font-size:14px;">${escapeHTML(clientName)}</span>
                        <span style="font-size:12px;">${statusLabel}</span>
                    </div>
                    <div style="font-size:12px;color:#64748B;">
                        ${serviceName ? '<span style="background:#EFF6FF;color:#2563EB;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600;">' + escapeHTML(serviceName) + '</span> ' : ''}
                        ${arriveT} â†’ ${leaveT} ${hours ? '(' + hours + ')' : ''}
                        ${log.mileage ? ' Â· ' + log.mileage + 'km' : ''}
                    </div>
                    ${log.work_content ? '<div style="font-size:12px;color:#475569;margin-top:6px;white-space:pre-wrap;">' + escapeHTML(log.work_content).substring(0, 80) + '</div>' : ''}
                    ${log.status === 'draft' ? '<button class="btn btn-primary" onclick="resumeFieldWork(\'' + log.id + '\')" style="font-size:12px;padding:8px;margin-top:8px;">ç¹¼çºŒå¡«å¯«</button>' : ''}
                </div>`;
            }).join('');
        }

        function showFieldWorkForm() {
            fwCurrentLogId = null;
            fwPhotoUrls = [];
            document.getElementById('fwFormArea').style.display = 'block';
            document.getElementById('fwAddBtn').style.display = 'none';
            document.getElementById('fwFormTitle').textContent = 'æ–°å¢å¤–å‹¤æ‰“å¡';
            // Reset form
            document.getElementById('fwClientSelect').value = '';
            renderFwServiceHierarchy();
            document.getElementById('fwArriveBtn').style.display = 'block';
            document.getElementById('fwArriveInfo').style.display = 'none';
            document.getElementById('fwContentSection').style.display = 'none';
            document.getElementById('fwPhotoPreview').innerHTML = '';
            const mileageEl = document.getElementById('fwMileage');
            if (mileageEl) mileageEl.value = '';
            const contentEl = document.getElementById('fwWorkContent');
            if (contentEl) contentEl.value = '';
            const notesEl = document.getElementById('fwNotes');
            if (notesEl) notesEl.value = '';
            document.getElementById('fwLeaveInfo').style.display = 'none';
            initSignatureCanvas();
        }

        function cancelFieldWorkForm() {
            document.getElementById('fwFormArea').style.display = 'none';
            document.getElementById('fwAddBtn').style.display = 'block';
        }

        async function resumeFieldWork(logId) {
            const log = fwLogs.find(l => l.id === logId);
            if (!log) return;
            fwCurrentLogId = logId;
            fwPhotoUrls = log.photo_urls || [];
            showFieldWorkForm();
            document.getElementById('fwFormTitle').textContent = 'ç¹¼çºŒå¤–å‹¤æ‰“å¡';
            document.getElementById('fwClientSelect').value = log.client_id || '';
            renderFwServiceHierarchy(log.service_item_id ? [log.service_item_id] : []);
            // å·²åˆ°é”
            if (log.arrive_time) {
                document.getElementById('fwArriveBtn').style.display = 'none';
                const t = new Date(log.arrive_time).toLocaleTimeString('zh-TW', { hour:'2-digit', minute:'2-digit' });
                document.getElementById('fwArriveInfo').style.display = 'block';
                document.getElementById('fwArriveInfo').textContent = `âœ… å·²åˆ°é” ${t}`;
                document.getElementById('fwContentSection').style.display = 'block';
                const contentEl = document.getElementById('fwWorkContent');
                if (contentEl) contentEl.value = log.work_content || '';
                const mileageEl = document.getElementById('fwMileage');
                if (mileageEl) mileageEl.value = log.mileage || '';
                const notesEl = document.getElementById('fwNotes');
                if (notesEl) notesEl.value = log.notes || '';
                renderPhotoPreview();
            }
        }

        // ---- åˆ°é”æ‰“å¡ ----
        async function fwArriveCheckin() {
            const clientId = document.getElementById('fwClientSelect').value;
            if (!clientId) return showToast('è«‹å…ˆé¸æ“‡å®¢æˆ¶');
            const btn = document.getElementById('fwArriveBtn');
            btn.disabled = true; btn.textContent = 'ğŸ“ å®šä½ä¸­...';
            try {
                const loc = await getGPS();
                const now = new Date().toISOString();
                const selectedItems = getSelectedFwItems();
                const serviceId = selectedItems.length > 0 ? selectedItems[0] : null;

                const record = {
                    employee_id: currentEmployee.id,
                    client_id: clientId,
                    service_item_id: serviceId,
                    work_date: getTaiwanDate(),
                    arrive_time: now,
                    arrive_lat: loc.latitude,
                    arrive_lng: loc.longitude,
                    status: 'draft'
                };

                const { data, error } = await sb.from('field_work_logs').insert(record).select().single();
                if (error) throw error;
                fwCurrentLogId = data.id;

                btn.style.display = 'none';
                const infoEl = document.getElementById('fwArriveInfo');
                const t = new Date(now).toLocaleTimeString('zh-TW', { hour:'2-digit', minute:'2-digit' });
                infoEl.style.display = 'block';
                infoEl.textContent = `âœ… åˆ°é” ${t}ï¼ˆGPS: ${loc.latitude.toFixed(5)}, ${loc.longitude.toFixed(5)}ï¼‰`;
                document.getElementById('fwContentSection').style.display = 'block';
                showToast('ğŸ“ åˆ°é”æ‰“å¡æˆåŠŸ');
                loadFieldWorkLogs();
            } catch(e) {
                console.error(e);
                showToast('âŒ æ‰“å¡å¤±æ•—ï¼š' + friendlyError(e));
                btn.disabled = false; btn.textContent = 'ğŸ“ åˆ°é”æ‰“å¡';
            }
        }

        // ---- æ‹ç…§ ----
        async function fwCapturePhoto() {
            if (fwPhotoUrls.length >= 3) return showToast('æœ€å¤š 3 å¼µç…§ç‰‡');
            // ç”¨ file inputï¼ˆè¡Œå‹•è£ç½®æœƒé–‹å•Ÿç›¸æ©Ÿï¼‰
            document.getElementById('fwFileInput').click();
        }

        async function fwHandleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 20 * 1024 * 1024) {
                showToast('âš ï¸ æª”æ¡ˆéå¤§ï¼ˆä¸Šé™ 20MBï¼‰');
                event.target.value = '';
                return;
            }
            try {
                showToast('â˜ï¸ ä¸Šå‚³ä¸­...');
                // å£“ç¸®
                const bitmap = await createImageBitmap(file);
                const MAX_W = 800, MAX_H = 600;
                let cw = bitmap.width, ch = bitmap.height;
                if (cw > MAX_W) { ch = Math.round(ch * MAX_W / cw); cw = MAX_W; }
                if (ch > MAX_H) { cw = Math.round(cw * MAX_H / ch); ch = MAX_H; }
                const canvas = document.createElement('canvas');
                canvas.width = cw; canvas.height = ch;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(bitmap, 0, 0, cw, ch);
                const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.6));

                const fileName = `fieldwork/${currentEmployee.employee_number}_${Date.now()}.jpg`;
                const { error } = await sb.storage.from(CONFIG.BUCKET).upload(fileName, blob);
                if (error) throw error;
                const { data: urlData } = sb.storage.from(CONFIG.BUCKET).getPublicUrl(fileName);
                const url = urlData?.publicUrl || urlData?.publicURL;
                fwPhotoUrls.push(url);
                renderPhotoPreview();

                // æ›´æ–° DB
                if (fwCurrentLogId) {
                    await sb.from('field_work_logs').update({ photo_urls: fwPhotoUrls }).eq('id', fwCurrentLogId);
                }
                showToast('âœ… ç…§ç‰‡å·²ä¸Šå‚³');
            } catch(e) {
                console.error(e);
                showToast('âŒ ä¸Šå‚³å¤±æ•—ï¼š' + friendlyError(e));
            }
            event.target.value = '';
        }

        function renderPhotoPreview() {
            const el = document.getElementById('fwPhotoPreview');
            if (!el) return;
            el.innerHTML = fwPhotoUrls.map((url, i) =>
                `<div style="position:relative;width:80px;height:80px;">
                    <img src="${escapeHTML(url)}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #E2E8F0;">
                    <button onclick="fwRemovePhoto(${i})" style="position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:#EF4444;color:#fff;border:none;font-size:12px;cursor:pointer;line-height:20px;text-align:center;">Ã—</button>
                </div>`
            ).join('');
            const photoBtn = document.getElementById('fwPhotoBtn');
            if (photoBtn) photoBtn.style.display = fwPhotoUrls.length >= 3 ? 'none' : 'block';
        }

        function fwRemovePhoto(idx) {
            fwPhotoUrls.splice(idx, 1);
            renderPhotoPreview();
            if (fwCurrentLogId) {
                sb.from('field_work_logs').update({ photo_urls: fwPhotoUrls }).eq('id', fwCurrentLogId);
            }
        }

        // ---- ç°½åæ¿ ----
        function initSignatureCanvas() {
            const canvas = document.getElementById('fwSignatureCanvas');
            if (!canvas) return;
            fwSignatureCtx = canvas.getContext('2d');
            fwSignatureCtx.clearRect(0, 0, canvas.width, canvas.height);
            fwSignatureCtx.lineWidth = 2;
            fwSignatureCtx.lineCap = 'round';
            fwSignatureCtx.strokeStyle = '#0F172A';
            fwSigning = false;
            document.getElementById('fwSignatureStatus').textContent = 'è«‹åœ¨ä¸Šæ–¹å€åŸŸç°½å';

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const touch = e.touches ? e.touches[0] : e;
                return { x: (touch.clientX - rect.left) * scaleX, y: (touch.clientY - rect.top) * scaleY };
            };

            const start = (e) => { e.preventDefault(); fwSigning = true; const p = getPos(e); fwSignatureCtx.beginPath(); fwSignatureCtx.moveTo(p.x, p.y); };
            const move = (e) => { if (!fwSigning) return; e.preventDefault(); const p = getPos(e); fwSignatureCtx.lineTo(p.x, p.y); fwSignatureCtx.stroke(); };
            const end = () => { fwSigning = false; };

            canvas.onmousedown = start; canvas.onmousemove = move; canvas.onmouseup = end; canvas.onmouseleave = end;
            canvas.ontouchstart = start; canvas.ontouchmove = move; canvas.ontouchend = end;
        }

        function fwClearSignature() {
            const canvas = document.getElementById('fwSignatureCanvas');
            if (!canvas || !fwSignatureCtx) return;
            fwSignatureCtx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('fwSignatureStatus').textContent = 'å·²æ¸…é™¤ï¼Œè«‹é‡æ–°ç°½å';
        }

        async function fwUploadSignature() {
            const canvas = document.getElementById('fwSignatureCanvas');
            if (!canvas) return null;
            // æª¢æŸ¥æ˜¯å¦æœ‰ç•«é
            const blank = document.createElement('canvas');
            blank.width = canvas.width; blank.height = canvas.height;
            if (canvas.toDataURL() === blank.toDataURL()) return null; // ç©ºç™½

            const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
            const fileName = `signatures/${currentEmployee.employee_number}_${Date.now()}.png`;
            const { error } = await sb.storage.from(CONFIG.BUCKET).upload(fileName, blob);
            if (error) throw error;
            const { data: urlData } = sb.storage.from(CONFIG.BUCKET).getPublicUrl(fileName);
            return urlData?.publicUrl || urlData?.publicURL;
        }

        // ---- é›¢é–‹æ‰“å¡ ----
        async function fwLeaveCheckin() {
            if (!fwCurrentLogId) return showToast('è«‹å…ˆå®Œæˆåˆ°é”æ‰“å¡');
            const btn = document.getElementById('fwLeaveBtn');
            btn.disabled = true; btn.textContent = 'ğŸ“ å®šä½ä¸­...';
            try {
                const loc = await getGPS();
                const now = new Date().toISOString();

                // ä¸Šå‚³ç°½å
                let signatureUrl = null;
                try { signatureUrl = await fwUploadSignature(); } catch(e) { console.warn('ç°½åä¸Šå‚³å¤±æ•—', e); }

                // è¨ˆç®—å·¥æ™‚
                const logData = fwLogs.find(l => l.id === fwCurrentLogId);
                let workHours = 0;
                if (logData?.arrive_time) {
                    workHours = (new Date(now) - new Date(logData.arrive_time)) / 3600000;
                    workHours = Math.round(workHours * 10) / 10;
                }

                const updateData = {
                    leave_time: now,
                    leave_lat: loc.latitude,
                    leave_lng: loc.longitude,
                    work_hours: workHours,
                    work_content: document.getElementById('fwWorkContent')?.value || '',
                    mileage: parseFloat(document.getElementById('fwMileage')?.value) || 0,
                    notes: document.getElementById('fwNotes')?.value || '',
                    photo_urls: fwPhotoUrls,
                    status: 'submitted',
                    updated_at: now
                };
                if (signatureUrl) updateData.signature_url = signatureUrl;

                const { error } = await sb.from('field_work_logs').update(updateData).eq('id', fwCurrentLogId);
                if (error) throw error;

                // è‡ªå‹•å»ºç«‹ã€Œå¯¦åœ°æ‹œè¨ªã€æ¥­å‹™æ´»å‹•è¨˜éŒ„
                try {
                    const clientId = document.getElementById('fwClientSelect').value;
                    const selectedItems = getSelectedFwItems();
                    const productNames = selectedItems.map(pid => {
                        const item = fwServiceItems.find(s => s.id === pid);
                        return item ? item.name : '';
                    }).filter(Boolean);
                    let desc = updateData.work_content || '';
                    if (!desc && productNames.length) desc = 'ä»‹ç´¹ç”¢å“ï¼š' + productNames.join('ã€');
                    if (!desc) desc = 'å¯¦åœ°æ‹œè¨ª';
                    const saRecord = {
                        employee_id: currentEmployee.id,
                        activity_type: 'visit',
                        activity_date: getTaiwanDate(),
                        description: desc,
                        duration_minutes: Math.round((workHours || 0) * 60),
                        notes: updateData.notes || null,
                        client_id: clientId || null
                    };
                    if (currentCompanyId) saRecord.company_id = currentCompanyId;
                    await sb.from('sales_activities').insert(saRecord);
                } catch(e2) { console.warn('è‡ªå‹•å»ºç«‹æ‹œè¨ªè¨˜éŒ„å¤±æ•—', e2); }

                const infoEl = document.getElementById('fwLeaveInfo');
                const t = new Date(now).toLocaleTimeString('zh-TW', { hour:'2-digit', minute:'2-digit' });
                infoEl.style.display = 'block';
                infoEl.textContent = `âœ… é›¢é–‹ ${t} Â· å·¥æ™‚ ${workHours.toFixed(1)}h`;
                showToast(`ğŸ“ é›¢é–‹æ‰“å¡å®Œæˆï¼Œå·¥æ™‚ ${workHours.toFixed(1)} å°æ™‚`);

                btn.style.display = 'none';
                setTimeout(() => {
                    cancelFieldWorkForm();
                    loadFieldWorkLogs();
                }, 1500);
            } catch(e) {
                console.error(e);
                showToast('âŒ é›¢é–‹æ‰“å¡å¤±æ•—ï¼š' + friendlyError(e));
                btn.disabled = false; btn.textContent = 'ğŸ“ é›¢é–‹æ‰“å¡ & é€å‡º';
            }
        }

        // ===== æ¥­å‹™é€±å ± =====
        let salesCurrentWeekStart = null; // Date object for Monday
        let salesTarget = { call_target: 0, visit_target: 0 };
        let salesActivities = [];

        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            date.setDate(diff);
            date.setHours(0, 0, 0, 0);
            return date;
        }

        function formatDate(d) {
            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        }

        function getSunday(monday) {
            const sun = new Date(monday);
            sun.setDate(sun.getDate() + 6);
            return sun;
        }

        async function initSalesPage() {
            salesCurrentWeekStart = getMonday(new Date());
            await loadSalesWeekData();
        }

        function salesChangeWeek(offset) {
            salesCurrentWeekStart.setDate(salesCurrentWeekStart.getDate() + offset * 7);
            loadSalesWeekData();
        }

        async function loadSalesWeekData() {
            if (!currentEmployee) return;
            const monday = formatDate(salesCurrentWeekStart);
            const sunday = formatDate(getSunday(salesCurrentWeekStart));

            // æ›´æ–°é€±æ¨™ç±¤
            document.getElementById('salesWeekLabel').textContent =
                `${monday.substring(5).replace('-','/')} ~ ${sunday.substring(5).replace('-','/')}`;

            // è¼‰å…¥ç›®æ¨™ï¼ˆå…ˆæ‰¾å€‹äººï¼Œå†æ‰¾å…¨å“¡é è¨­ï¼‰
            try {
                let { data: target } = await sb.from('sales_targets')
                    .select('*')
                    .eq('employee_id', currentEmployee.id)
                    .eq('week_start', monday)
                    .maybeSingle();

                if (!target) {
                    // æ‰¾å…¨å“¡é è¨­ï¼ˆemployee_id IS NULLï¼‰
                    const { data: defaultTarget } = await sb.from('sales_targets')
                        .select('*')
                        .is('employee_id', null)
                        .eq('week_start', monday)
                        .maybeSingle();
                    target = defaultTarget;
                }
                salesTarget = target || { call_target: 0, visit_target: 0 };
            } catch(e) { console.error('è¼‰å…¥ç›®æ¨™å¤±æ•—', e); }

            // è¼‰å…¥æœ¬é€±æ´»å‹•
            try {
                const { data } = await sb.from('sales_activities')
                    .select('*, clients(company_name)')
                    .eq('employee_id', currentEmployee.id)
                    .gte('activity_date', monday)
                    .lte('activity_date', sunday)
                    .order('created_at', { ascending: false });
                salesActivities = data || [];
            } catch(e) { console.error('è¼‰å…¥æ´»å‹•å¤±æ•—', e); }

            renderSalesProgress();
            renderSalesActivityList();
            // å¡«å……å®¢æˆ¶ä¸‹æ‹‰
            const sel = document.getElementById('saClientSelect');
            if (sel) {
                sel.innerHTML = '<option value="">-- ä¸æŒ‡å®š --</option>' +
                    fwClients.map(c => `<option value="${c.id}">${escapeHTML(c.company_name)}</option>`).join('');
            }
        }

        function renderSalesProgress() {
            const callDone = salesActivities.filter(a => a.activity_type === 'call').length;
            const visitDone = salesActivities.filter(a => a.activity_type === 'visit').length;
            const callTarget = salesTarget.call_target || 0;
            const visitTarget = salesTarget.visit_target || 0;

            document.getElementById('salesCallText').textContent = `${callDone} / ${callTarget}`;
            document.getElementById('salesVisitText').textContent = `${visitDone} / ${visitTarget}`;

            const callPct = callTarget > 0 ? Math.min(100, Math.round(callDone / callTarget * 100)) : 0;
            const visitPct = visitTarget > 0 ? Math.min(100, Math.round(visitDone / visitTarget * 100)) : 0;
            document.getElementById('salesCallBar').style.width = callPct + '%';
            document.getElementById('salesVisitBar').style.width = visitPct + '%';
        }

        function renderSalesActivityList() {
            const el = document.getElementById('salesActivityList');
            if (!el) return;
            if (salesActivities.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;font-size:13px;padding:16px;">æœ¬é€±å°šç„¡æ´»å‹•ç´€éŒ„</p>';
                return;
            }
            const resultMap = { 'interested':'ğŸŸ¢ æœ‰èˆˆè¶£', 'follow-up':'ğŸŸ¡ éœ€è¿½è¹¤', 'closed':'ğŸ‰ æˆäº¤', 'rejected':'ğŸ”´ æ‹’çµ•', 'no-answer':'âšª æœªæ¥' };
            const typeIcon = { 'call':'ğŸ“', 'visit':'ğŸ¢', 'other':'ğŸ“' };
            el.innerHTML = salesActivities.map(a => {
                const icon = typeIcon[a.activity_type] || 'ğŸ“';
                const clientName = a.clients?.company_name || '';
                const resultLabel = a.result ? (resultMap[a.result] || a.result) : '';
                const dateStr = a.activity_date ? a.activity_date.substring(5).replace('-', '/') : '';
                return `<div style="background:#fff;border:1px solid #E2E8F0;border-radius:12px;padding:14px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                        <span style="font-size:14px;">${icon} <b>${escapeHTML(a.description || '')}</b></span>
                        <span style="font-size:12px;color:#64748B;">${dateStr}</span>
                    </div>
                    <div style="font-size:12px;color:#64748B;">
                        ${clientName ? '<span style="background:#EFF6FF;color:#2563EB;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600;">' + escapeHTML(clientName) + '</span> ' : ''}
                        ${a.duration_minutes ? a.duration_minutes + 'åˆ†é˜ ' : ''}
                        ${resultLabel ? '<span style="font-size:11px;">' + resultLabel + '</span>' : ''}
                    </div>
                    ${a.notes ? '<div style="font-size:12px;color:#94A3B8;margin-top:4px;">' + escapeHTML(a.notes) + '</div>' : ''}
                </div>`;
            }).join('');
        }

        function showSalesActivityModal(type) {
            document.getElementById('saType').value = type;
            document.getElementById('salesModalTitle').textContent = type === 'call' ? 'ğŸ“ è¨˜éŒ„é›»è©±æ‹œè¨ª' : 'ğŸ¢ è¨˜éŒ„å¯¦åœ°æ‹œè¨ª';
            document.getElementById('saDescription').value = '';
            document.getElementById('saDuration').value = '';
            document.getElementById('saResult').value = '';
            document.getElementById('saNotes').value = '';
            document.getElementById('saClientSelect').value = '';
            renderSaServiceHierarchy();
            // ä¹Ÿé‡æ–°å¡«å……å®¢æˆ¶ä¸‹æ‹‰
            const sel = document.getElementById('saClientSelect');
            if (sel) {
                sel.innerHTML = '<option value="">-- é¸æ“‡å®¢æˆ¶ --</option>' +
                    fwClients.map(c => `<option value="${c.id}">${escapeHTML(c.company_name)}${c.category === 'vip' ? ' â­' : ''}</option>`).join('');
            }
            document.getElementById('salesActivityModal').style.display = 'flex';
        }

        // éŠ·å”®æ´»å‹•ç”¨ï¼šæ¯å­éšå±¤ï¼ˆåŒå¤–å‹¤æ‰“å¡çµæ§‹ï¼‰
        function renderSaServiceHierarchy() {
            const el = document.getElementById('saServiceHierarchy');
            if (!el) return;
            let lastProducts = [];
            try { lastProducts = JSON.parse(localStorage.getItem('sa_last_products') || '[]'); } catch(e) {}

            const categories = fwServiceItems.filter(s => s.code === 'CAT');
            const childrenMap = {};
            const uncategorized = [];
            fwServiceItems.forEach(s => {
                if (s.code === 'CAT') return;
                if (isUUIDCode(s.code)) {
                    if (!childrenMap[s.code]) childrenMap[s.code] = [];
                    childrenMap[s.code].push(s);
                } else {
                    uncategorized.push(s);
                }
            });

            let html = '';
            categories.forEach(cat => {
                const children = childrenMap[cat.id] || [];
                html += `<div style="margin-bottom:14px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <div style="display:flex;align-items:center;gap:6px;">
                            <span style="font-size:14px;font-weight:700;color:#0F172A;">${escapeHTML(cat.name)}</span>
                            <span onclick="editFwCategory('${cat.id}')" style="font-size:14px;cursor:pointer;opacity:0.4;">âœï¸</span>
                        </div>
                        <button type="button" onclick="toggleFwAddRow('saProdAdd_${cat.id}','saNewProd_${cat.id}')" style="padding:4px 12px;border:1px solid #059669;border-radius:8px;background:#ECFDF5;color:#059669;font-weight:700;font-size:12px;cursor:pointer;">+ æ–°å¢</button>
                    </div>
                    <div id="saProdAdd_${cat.id}" style="display:none;margin-bottom:8px;">
                        <div style="display:flex;gap:6px;">
                            <input id="saNewProd_${cat.id}" placeholder="æ–°é …ç›®åç¨±" style="flex:1;padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;">
                            <button onclick="saveSaProduct('${cat.id}')" style="padding:8px 14px;border:none;border-radius:8px;background:#059669;color:#fff;font-weight:700;font-size:13px;cursor:pointer;">æ–°å¢</button>
                        </div>
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:8px;">
                        ${children.length > 0 ? children.map(s => renderSaItemCard(s, lastProducts.includes(s.id))).join('') : '<span style="color:#94A3B8;font-size:12px;">å°šç„¡é …ç›®ï¼Œè«‹é» +æ–°å¢</span>'}
                    </div>
                </div>`;
            });
            if (uncategorized.length > 0) {
                html += `<div style="margin-bottom:14px;">
                    <div style="font-size:14px;font-weight:700;color:#0F172A;margin-bottom:6px;">å…¶ä»–</div>
                    <div style="display:flex;flex-wrap:wrap;gap:8px;">
                        ${uncategorized.map(s => renderSaItemCard(s, lastProducts.includes(s.id))).join('')}
                    </div>
                </div>`;
            }
            html += `<div id="saCatAddRow" style="display:none;margin-bottom:8px;">
                <div style="display:flex;gap:6px;">
                    <input id="saNewCatName" placeholder="æ–°æœå‹™é¡å‹åç¨±" style="flex:1;padding:8px;border:1px solid #E2E8F0;border-radius:8px;font-size:13px;">
                    <button onclick="saveSaCategory()" style="padding:8px 14px;border:none;border-radius:8px;background:#4F46E5;color:#fff;font-weight:700;font-size:13px;cursor:pointer;">æ–°å¢</button>
                </div>
            </div>
            <button type="button" onclick="toggleFwAddRow('saCatAddRow','saNewCatName')" style="padding:8px 14px;border:2px dashed #CBD5E1;border-radius:10px;background:#fff;color:#64748B;font-weight:700;font-size:13px;cursor:pointer;width:100%;">+ æ–°å¢æœå‹™é¡å‹</button>`;
            el.innerHTML = html;
        }

        function renderSaItemCard(s, on) {
            return `<div class="saProductCard" data-id="${s.id}" data-selected="${on ? 'true' : 'false'}" onclick="toggleProductCard(this)" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:${on ? '#F5F3FF' : '#fff'};border:2px solid ${on ? '#4F46E5' : '#E5E7EB'};border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;">
                <div style="width:22px;height:22px;border:2px solid ${on ? '#4F46E5' : '#CBD5E1'};border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;background:${on ? '#4F46E5' : '#fff'};color:#fff;font-size:14px;transition:all 0.2s;">${on ? 'âœ“' : ''}</div>
                <span style="flex:1;">${escapeHTML(s.name)}</span>
                <span onclick="event.stopPropagation();editFwItem('${s.id}')" style="font-size:14px;opacity:0.4;padding:2px;">âœï¸</span>
            </div>`;
        }

        function toggleProductCard(card) {
            const box = card.querySelector('div');
            const isOn = card.dataset.selected === 'true';
            if (isOn) {
                card.dataset.selected = 'false';
                card.style.borderColor = '#E5E7EB'; card.style.background = '#fff';
                box.style.borderColor = '#CBD5E1'; box.style.background = '#fff'; box.textContent = '';
            } else {
                card.dataset.selected = 'true';
                card.style.borderColor = '#4F46E5'; card.style.background = '#F5F3FF';
                box.style.borderColor = '#4F46E5'; box.style.background = '#4F46E5'; box.textContent = 'âœ“';
            }
        }

        async function saveSaCategory() {
            const input = document.getElementById('saNewCatName');
            const name = input?.value.trim();
            if (!name) return showToast('è«‹è¼¸å…¥æœå‹™é¡å‹åç¨±');
            try {
                const { data, error } = await sb.from('service_items').insert({ name, code: 'CAT', is_active: true }).select().single();
                if (error) throw error;
                input.value = '';
                document.getElementById('saCatAddRow').style.display = 'none';
                fwServiceItems.push(data);
                renderSaServiceHierarchy();
                showToast('âœ… å·²æ–°å¢æœå‹™é¡å‹ã€Œ' + name + 'ã€');
            } catch(e) { showToast('âŒ æ–°å¢å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        async function saveSaProduct(catId) {
            const input = document.getElementById('saNewProd_' + catId);
            const name = input?.value.trim();
            if (!name) return showToast('è«‹è¼¸å…¥é …ç›®åç¨±');
            try {
                const { data, error } = await sb.from('service_items').insert({ name, code: catId, is_active: true }).select().single();
                if (error) throw error;
                input.value = '';
                document.getElementById('saProdAdd_' + catId).style.display = 'none';
                fwServiceItems.push(data);
                // è‡ªå‹•å‹¾é¸æ–°é …ç›®
                let lastProducts = [];
                try { lastProducts = JSON.parse(localStorage.getItem('sa_last_products') || '[]'); } catch(e) {}
                lastProducts.push(data.id);
                localStorage.setItem('sa_last_products', JSON.stringify(lastProducts));
                renderSaServiceHierarchy();
                showToast('âœ… å·²æ–°å¢ã€Œ' + name + 'ã€');
            } catch(e) { showToast('âŒ æ–°å¢å¤±æ•—ï¼š' + friendlyError(e)); }
        }

        function closeSalesActivityModal() {
            document.getElementById('salesActivityModal').style.display = 'none';
        }

        async function saveSalesActivity() {
            const clientId = document.getElementById('saClientSelect').value;
            if (!clientId) return showToast('è«‹é¸æ“‡å®¢æˆ¶');

            // æ”¶é›†å‹¾é¸çš„ç”¢å“
            const checkedProducts = [];
            document.querySelectorAll('.saProductCard').forEach(card => {
                if (card.dataset.selected === 'true') checkedProducts.push(card.dataset.id);
            });
            // å„²å­˜æœ¬æ¬¡å‹¾é¸ï¼Œä¾›ä¸‹æ¬¡é è¨­
            localStorage.setItem('sa_last_products', JSON.stringify(checkedProducts));

            // ç”¢å“åç¨±
            const productNames = checkedProducts.map(pid => {
                const item = fwServiceItems.find(s => s.id === pid);
                return item ? item.name : '';
            }).filter(Boolean);

            // descriptionï¼šè‹¥ä½¿ç”¨è€…æœ‰å¡«å°±ç”¨ï¼Œå¦å‰‡è‡ªå‹•ç”¢ç”Ÿ
            let desc = document.getElementById('saDescription').value.trim();
            if (!desc && productNames.length) {
                desc = 'ä»‹ç´¹ç”¢å“ï¼š' + productNames.join('ã€');
            }
            if (!desc) desc = document.getElementById('saType').value === 'call' ? 'é›»è©±æ‹œè¨ª' : 'å¯¦åœ°æ‹œè¨ª';

            // å‚™è¨»ï¼šç”¢å“è³‡è¨Šé™„åŠ 
            let notes = document.getElementById('saNotes').value.trim() || '';
            if (productNames.length) {
                const productStr = 'ä»‹ç´¹ç”¢å“ï¼š' + productNames.join('ã€');
                if (!notes) notes = productStr;
                else if (!notes.includes('ä»‹ç´¹ç”¢å“')) notes = notes + ' | ' + productStr;
            }

            const record = {
                employee_id: currentEmployee.id,
                activity_type: document.getElementById('saType').value,
                activity_date: formatDate(new Date()),
                description: desc,
                duration_minutes: parseInt(document.getElementById('saDuration').value) || 0,
                result: document.getElementById('saResult').value || null,
                notes: notes || null,
                client_id: clientId || null
            };
            if (currentCompanyId) record.company_id = currentCompanyId;

            try {
                const { error } = await sb.from('sales_activities').insert(record);
                if (error) throw error;
                showToast('âœ… æ´»å‹•å·²è¨˜éŒ„');
                closeSalesActivityModal();
                await loadSalesWeekData();
            } catch(e) {
                console.error(e);
                showToast('âŒ å„²å­˜å¤±æ•—ï¼š' + friendlyError(e));
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        window.addEventListener('load', async () => {
            // ç¢ºä¿ common.js ä¸­çš„å‡½æ•¸å·²è¼‰å…¥
            if (typeof initializeLiff === 'undefined') {
                console.error('initializeLiff å‡½æ•¸æœªå®šç¾©ï¼Œè«‹æª¢æŸ¥ common.js æ˜¯å¦æ­£ç¢ºè¼‰å…¥');
                return;
            }
            
            // æ ¹æ“š hash æ±ºå®šé¡¯ç¤ºå“ªå€‹é é¢
            const hash = window.location.hash || '#lunch';
            let pageId = 'lunchPage';

            if (hash === '#settings') pageId = 'settingsPage';
            if (hash === '#fieldwork' || hash === '#sales') pageId = 'fieldWorkPage';

            const initialized = await initializeLiff();
            if (initialized) {
                const isLoggedIn = await checkUserStatus();
                if (isLoggedIn) {
                    initBottomNav();
                    showPage(pageId);
                    // è‹¥ hash æ˜¯ #salesï¼Œè‡ªå‹•åˆ‡åˆ°æ¥­å‹™é€±å ± tab
                    if (hash === '#sales') {
                        const salesBtn = document.querySelectorAll('.fwsTab')[1];
                        if (salesBtn) switchFieldSalesTab('sales', salesBtn);
                    }
                } else {
                    window.location.href = 'index.html';
                }
            }
        });
    </script>

</body>
</html>
