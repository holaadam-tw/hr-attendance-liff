<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¢ å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* ç”¨æˆ¶å¡ç‰‡ */
        .user-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideDown 0.5s ease-out;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
        }

        .user-details h2 {
            font-size: 20px;
            margin-bottom: 5px;
            color: #333;
        }

        .user-details p {
            font-size: 13px;
            color: #666;
        }

        /* ä¸»è¦æ‰“å¡æŒ‰éˆ• */
        .primary-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .primary-btn {
            background: white;
            border-radius: 15px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }

        .primary-btn.checkin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .primary-btn.checkout {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .primary-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .primary-btn .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .primary-btn .label {
            font-size: 16px;
            font-weight: 700;
        }

        .primary-btn .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        /* åŠŸèƒ½é¸å–® */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .menu-item {
            background: white;
            border-radius: 15px;
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease-out;
        }

        .menu-item:active {
            transform: scale(0.95);
        }

        .menu-item .icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .menu-item .label {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }

        /* é é¢å®¹å™¨ */
        .page {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .page.active {
            display: block;
        }

        /* è¿”å›æŒ‰éˆ• */
        .back-btn {
            background: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-size: 24px;
        }

        /* æ‰“å¡é é¢ */
        .checkin-page {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .checkin-page h2 {
            font-size: 22px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* ç›¸æ©Ÿå®¹å™¨ */
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
        }

        #video {
            width: 100%;
            display: block;
            transform: scaleX(-1);
        }

        #canvas {
            display: none;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        /* ç‹€æ…‹æç¤º */
        .status-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-box.success {
            background: #d4edda;
            color: #155724;
        }

        .status-box.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-box.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* æŒ‰éˆ• */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        /* è«‹å‡è¡¨å–® */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: border 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        /* è€ƒå‹¤è¨˜éŒ„ */
        .attendance-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .attendance-item .date {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .attendance-item .details {
            font-size: 13px;
            color: #666;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.success {
            background: #d4edda;
            color: #155724;
        }

        .badge.danger {
            background: #f8d7da;
            color: #721c24;
        }

        /* å‹•ç•« */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* éš±è—é¡ */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading ç•«é¢ -->
        <div id="loadingScreen" class="loading">
            <div class="spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
        </div>

        <!-- é¦–é  -->
        <div id="homePage" class="page">
            <!-- ç”¨æˆ¶å¡ç‰‡ -->
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <h2 id="userName">è¼‰å…¥ä¸­...</h2>
                        <p id="userDept">-</p>
                        <p id="userId" style="font-size: 11px; color: #999;">ID: -</p>
                    </div>
                </div>
            </div>

            <!-- æ‰“å¡ç‹€æ…‹æç¤º -->
            <div id="checkInStatusBox" class="status-box hidden"></div>

            <!-- ä¸»è¦æ‰“å¡æŒ‰éˆ• -->
            <div class="primary-actions">
                <div class="primary-btn checkin" id="checkInBtn" onclick="startCheckIn()">
                    <div class="status-badge" id="checkInBadge">å¯ç”¨</div>
                    <div class="icon">ğŸ•</div>
                    <div class="label">ä¸Šç­æ‰“å¡</div>
                </div>
                <div class="primary-btn checkout disabled" id="checkOutBtn" onclick="startCheckOut()">
                    <div class="status-badge" id="checkOutBadge">ä¸å¯ç”¨</div>
                    <div class="icon">ğŸ </div>
                    <div class="label">ä¸‹ç­æ‰“å¡</div>
                </div>
            </div>

            <!-- åŠŸèƒ½é¸å–® -->
            <div class="menu-grid">
                <div class="menu-item" onclick="showPage('leavePage')">
                    <div class="icon">ğŸ“</div>
                    <div class="label">æˆ‘è¦è«‹å‡</div>
                </div>
                <div class="menu-item" onclick="showPage('attendancePage')">
                    <div class="icon">ğŸ“Š</div>
                    <div class="label">è€ƒå‹¤æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="showPage('salaryPage')">
                    <div class="icon">ğŸ’°</div>
                    <div class="label">è–ªè³‡æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="alert('åŠŸèƒ½é–‹ç™¼ä¸­')">
                    <div class="icon">ğŸ“…</div>
                    <div class="label">ç­è¡¨æŸ¥è©¢</div>
                </div>
                <div class="menu-item" onclick="alert('åŠŸèƒ½é–‹ç™¼ä¸­')">
                    <div class="icon">ğŸ“¢</div>
                    <div class="label">æœ€æ–°å…¬å‘Š</div>
                </div>
                <div class="menu-item" onclick="showPage('settingsPage')">
                    <div class="icon">âš™ï¸</div>
                    <div class="label">è¨­å®š</div>
                </div>
            </div>
        </div>

        <!-- æ‰“å¡é é¢ -->
        <div id="checkInPage" class="page">
            <div class="back-btn" onclick="cancelCheckIn()">â†</div>
            <div class="checkin-page">
                <h2 id="checkInTitle">ğŸ“ ä¸Šç­æ‰“å¡</h2>
                
                <div id="checkInStatus" class="status-box">
                    æº–å‚™é–‹å•Ÿç›¸æ©Ÿ...
                </div>

                <div class="camera-container" id="cameraContainer">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                    <div class="camera-overlay" id="cameraOverlay">
                        <span>æ­£åœ¨é–‹å•Ÿç›¸æ©Ÿ...</span>
                    </div>
                </div>

                <button class="btn btn-primary" id="captureBtn" onclick="captureAndCheckIn()" disabled>
                    ğŸ“¸ æ‹ç…§æ‰“å¡
                </button>
                <button class="btn btn-secondary" onclick="cancelCheckIn()">
                    å–æ¶ˆ
                </button>
            </div>
        </div>

        <!-- è«‹å‡é é¢ -->
        <div id="leavePage" class="page">
            <div class="back-btn" onclick="showPage('homePage')">â†</div>
            <div class="checkin-page">
                <h2>ğŸ“ è«‹å‡ç”³è«‹</h2>
                
                <div class="form-group">
                    <label>å‡åˆ¥ *</label>
                    <select id="leaveType">
                        <option value="">è«‹é¸æ“‡å‡åˆ¥</option>
                        <option value="annual">å¹´å‡</option>
                        <option value="sick">ç—…å‡</option>
                        <option value="personal">äº‹å‡</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>é–‹å§‹æ—¥æœŸ *</label>
                    <input type="date" id="leaveStartDate">
                </div>

                <div class="form-group">
                    <label>çµæŸæ—¥æœŸ *</label>
                    <input type="date" id="leaveEndDate">
                </div>

                <div class="form-group">
                    <label>è«‹å‡åŸå›  *</label>
                    <textarea id="leaveReason" placeholder="è«‹è¼¸å…¥è«‹å‡åŸå› ..."></textarea>
                </div>

                <button class="btn btn-primary" onclick="submitLeave()">é€å‡ºç”³è«‹</button>
                <button class="btn btn-secondary" onclick="showPage('homePage')">å–æ¶ˆ</button>

                <div id="leaveStatus"></div>
            </div>
        </div>

        <!-- è€ƒå‹¤æŸ¥è©¢é é¢ -->
        <div id="attendancePage" class="page">
            <div class="back-btn" onclick="showPage('homePage')">â†</div>
            <div class="checkin-page">
                <h2>ğŸ“Š è€ƒå‹¤è¨˜éŒ„</h2>
                <div id="attendanceList">
                    <div class="spinner" style="border-color: #667eea; border-top-color: transparent;"></div>
                </div>
            </div>
        </div>

        <!-- è–ªè³‡æŸ¥è©¢é é¢ -->
        <div id="salaryPage" class="page">
            <div class="back-btn" onclick="showPage('homePage')">â†</div>
            <div class="checkin-page">
                <h2>ğŸ’° è–ªè³‡æŸ¥è©¢</h2>
                <div class="status-box info">åŠŸèƒ½é–‹ç™¼ä¸­...</div>
            </div>
        </div>

        <!-- è¨­å®šé é¢ -->
        <div id="settingsPage" class="page">
            <div class="back-btn" onclick="showPage('homePage')">â†</div>
            <div class="checkin-page">
                <h2>âš™ï¸ è¨­å®š</h2>
                <div class="status-box info">åŠŸèƒ½é–‹ç™¼ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ– vConsole
        const vConsole = new window.VConsole();
        console.log('âœ… vConsole å·²å•Ÿå‹•');

        // Supabase è¨­å®š
        const SUPABASE_URL = 'https://nssuisyvlrqnqfxupklb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3Vpc3l2bHJxbnFmeHVwa2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTAwMzUsImV4cCI6MjA4NDg2NjAzNX0.q_B6v3gf1TOCuAq7z0xIw10wDueCSJn0p37VzdMfmbc';
        const STORAGE_BUCKET = 'selfies';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // LIFF è¨­å®š
        const LIFF_ID = '2008962829-bnsS1bbB';

        // å…¨åŸŸè®Šæ•¸
        let liffProfile = null;
        let videoStream = null;
        let currentCheckInType = null; // 'in' or 'out'
        let todayAttendance = null; // ä»Šæ—¥æ‰“å¡è¨˜éŒ„

        // ============================================
        // åˆå§‹åŒ–
        // ============================================
        window.addEventListener('load', async () => {
            try {
                console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ– LIFF...');
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    console.log('âŒ æœªç™»å…¥ï¼Œè·³è½‰ç™»å…¥é é¢');
                    liff.login();
                    return;
                }

                console.log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
                liffProfile = await liff.getProfile();
                console.log('âœ… å–å¾—ç”¨æˆ¶è³‡æ–™:', liffProfile);

                // æ›´æ–° UI
                updateUserInfo();

                // æª¢æŸ¥ä»Šæ—¥æ‰“å¡ç‹€æ…‹
                await checkTodayAttendance();

                // éš±è— Loadingï¼Œé¡¯ç¤ºé¦–é 
                document.getElementById('loadingScreen').style.display = 'none';
                showPage('homePage');

                console.log('âœ… åˆå§‹åŒ–å®Œæˆï¼');
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
                alert('åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            }
        });

        // æ›´æ–°ç”¨æˆ¶è³‡è¨Š
        function updateUserInfo() {
            document.getElementById('userName').textContent = liffProfile.displayName;
            document.getElementById('userId').textContent = `ID: ${liffProfile.userId.substring(0, 10)}...`;
            
            // è¨­å®šé ­åƒï¼ˆä½¿ç”¨ LINE å¤§é ­è²¼æˆ–é¦–å­—ï¼‰
            const avatarDiv = document.getElementById('userAvatar');
            if (liffProfile.pictureUrl) {
                avatarDiv.style.backgroundImage = `url(${liffProfile.pictureUrl})`;
                avatarDiv.style.backgroundSize = 'cover';
                avatarDiv.textContent = '';
            } else {
                avatarDiv.textContent = liffProfile.displayName.substring(0, 1);
            }
        }

        // ============================================
        // æª¢æŸ¥ä»Šæ—¥æ‰“å¡ç‹€æ…‹
        // ============================================
        async function checkTodayAttendance() {
            try {
                console.log('ğŸ” æª¢æŸ¥ä»Šæ—¥æ‰“å¡ç‹€æ…‹...');
                
                const { data, error } = await sb
                    .from('attendance')
                    .select('*, employees!inner(line_user_id)')
                    .eq('employees.line_user_id', liffProfile.userId)
                    .eq('date', new Date().toISOString().split('T')[0])
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 = æ‰¾ä¸åˆ°è¨˜éŒ„
                    throw error;
                }

                todayAttendance = data;
                updateCheckInButtons();
                
                console.log('âœ… ä»Šæ—¥æ‰“å¡ç‹€æ…‹:', todayAttendance);
            } catch (error) {
                console.error('âŒ æª¢æŸ¥æ‰“å¡ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // æ›´æ–°æ‰“å¡æŒ‰éˆ•ç‹€æ…‹
        function updateCheckInButtons() {
            const checkInBtn = document.getElementById('checkInBtn');
            const checkOutBtn = document.getElementById('checkOutBtn');
            const checkInBadge = document.getElementById('checkInBadge');
            const checkOutBadge = document.getElementById('checkOutBadge');
            const statusBox = document.getElementById('checkInStatusBox');

            if (!todayAttendance) {
                // å°šæœªä¸Šç­æ‰“å¡
                checkInBtn.classList.remove('disabled');
                checkOutBtn.classList.add('disabled');
                checkInBadge.textContent = 'å¯ç”¨';
                checkOutBadge.textContent = 'ä¸å¯ç”¨';
                statusBox.classList.add('hidden');
            } else if (todayAttendance.check_out_time) {
                // å·²ç¶“ä¸‹ç­æ‰“å¡
                checkInBtn.classList.add('disabled');
                checkOutBtn.classList.add('disabled');
                checkInBadge.textContent = 'å·²æ‰“å¡';
                checkOutBadge.textContent = 'å·²æ‰“å¡';
                statusBox.className = 'status-box success';
                statusBox.textContent = `âœ… ä»Šæ—¥å·²å®Œæˆæ‰“å¡ï¼ˆå·¥æ™‚ï¼š${todayAttendance.work_hours?.toFixed(2) || 0} å°æ™‚ï¼‰`;
                statusBox.classList.remove('hidden');
            } else {
                // å·²ä¸Šç­æ‰“å¡ï¼Œç­‰å¾…ä¸‹ç­æ‰“å¡
                checkInBtn.classList.add('disabled');
                checkOutBtn.classList.remove('disabled');
                checkInBadge.textContent = 'å·²æ‰“å¡';
                checkOutBadge.textContent = 'å¯ç”¨';
                statusBox.className = 'status-box info';
                statusBox.textContent = `â„¹ï¸ ä¸Šç­æ‰“å¡æ™‚é–“ï¼š${new Date(todayAttendance.check_in_time).toLocaleTimeString('zh-TW', { timeZone: 'Asia/Taipei' })}`;
                statusBox.classList.remove('hidden');
            }
        }

        // ============================================
        // é é¢åˆ‡æ›
        // ============================================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            // ç‰¹å®šé é¢çš„è¼‰å…¥é‚è¼¯
            if (pageId === 'attendancePage') {
                loadAttendanceRecords();
            }
        }

        // ============================================
        // æ‰“å¡æµç¨‹
        // ============================================
        
        // é–‹å§‹ä¸Šç­æ‰“å¡
        function startCheckIn() {
            if (todayAttendance && !todayAttendance.check_out_time) {
                alert('æ‚¨ä»Šå¤©å·²ç¶“ä¸Šç­æ‰“å¡äº†ï¼');
                return;
            }
            currentCheckInType = 'in';
            document.getElementById('checkInTitle').textContent = 'ğŸ• ä¸Šç­æ‰“å¡';
            showPage('checkInPage');
            openCamera();
        }

        // é–‹å§‹ä¸‹ç­æ‰“å¡
        function startCheckOut() {
            if (!todayAttendance || todayAttendance.check_out_time) {
                alert('ç„¡æ³•ä¸‹ç­æ‰“å¡');
                return;
            }
            currentCheckInType = 'out';
            document.getElementById('checkInTitle').textContent = 'ğŸ  ä¸‹ç­æ‰“å¡';
            showPage('checkInPage');
            openCamera();
        }

        // å–æ¶ˆæ‰“å¡
        function cancelCheckIn() {
            closeCamera();
            showPage('homePage');
        }

        // ============================================
        // ç›¸æ©ŸåŠŸèƒ½
        // ============================================
        async function openCamera() {
            const video = document.getElementById('video');
            const overlay = document.getElementById('cameraOverlay');
            const statusDiv = document.getElementById('checkInStatus');
            const captureBtn = document.getElementById('captureBtn');

            try {
                statusDiv.className = 'status-box info';
                statusDiv.textContent = 'æ­£åœ¨é–‹å•Ÿç›¸æ©Ÿ...';

                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                video.srcObject = videoStream;
                
                // ç­‰å¾…è¦–è¨Šè¼‰å…¥
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                    video.onerror = reject;
                    
                    // è¶…æ™‚ä¿è­·
                    setTimeout(() => {
                        if (video.readyState >= 2) {
                            resolve();
                        }
                    }, 3000);
                });

                overlay.classList.add('hidden');
                captureBtn.disabled = false;
                statusDiv.className = 'status-box success';
                statusDiv.textContent = 'âœ… ç›¸æ©Ÿå·²å°±ç·’ï¼Œè«‹å°æº–è‡‰éƒ¨æ‹ç…§';

                console.log('âœ… ç›¸æ©Ÿé–‹å•ŸæˆåŠŸ');
            } catch (error) {
                console.error('âŒ ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—:', error);
                statusDiv.className = 'status-box error';
                
                if (error.name === 'NotAllowedError') {
                    statusDiv.textContent = 'âŒ è«‹å…è¨±å­˜å–ç›¸æ©Ÿæ¬Šé™';
                } else if (error.name === 'NotFoundError') {
                    statusDiv.textContent = 'âŒ æ‰¾ä¸åˆ°ç›¸æ©Ÿè£ç½®';
                } else {
                    statusDiv.textContent = 'âŒ ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—: ' + error.message;
                }
            }
        }

        function closeCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                console.log('âœ… ç›¸æ©Ÿå·²é—œé–‰');
            }
        }

        // ============================================
        // æ‹ç…§ä¸¦æ‰“å¡
        // ============================================
        async function captureAndCheckIn() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const statusDiv = document.getElementById('checkInStatus');
            const captureBtn = document.getElementById('captureBtn');

            try {
                captureBtn.disabled = true;
                statusDiv.className = 'status-box info';
                statusDiv.textContent = 'ğŸ“¸ æ­£åœ¨æ‹ç…§...';

                // è¨­å®š canvas å°ºå¯¸
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                if (canvas.width === 0 || canvas.height === 0) {
                    throw new Error('ç„¡æ³•å–å¾—å½±åƒå°ºå¯¸');
                }

                // ç¹ªè£½é¡åƒç¿»è½‰çš„å½±åƒ
                const ctx = canvas.getContext('2d');
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0);

                // è½‰æ›æˆ Blob
                const blob = await new Promise((resolve, reject) => {
                    canvas.toBlob(
                        blob => {
                            if (blob) resolve(blob);
                            else reject(new Error('ç…§ç‰‡è½‰æ›å¤±æ•—'));
                        },
                        'image/jpeg',
                        0.7
                    );
                });

                console.log('âœ… ç…§ç‰‡æ‹æ”æˆåŠŸï¼Œå¤§å°:', blob.size);

                // ä¸Šå‚³ç…§ç‰‡
                statusDiv.textContent = 'â˜ï¸ æ­£åœ¨ä¸Šå‚³ç…§ç‰‡...';
                const photoUrl = await uploadPhoto(blob);

                // å–å¾— GPS
                statusDiv.textContent = 'ğŸ“ æ­£åœ¨å–å¾—ä½ç½®...';
                const { latitude, longitude } = await getGPS();

                // å‘¼å«æ‰“å¡ API
                statusDiv.textContent = 'ğŸ’¾ æ­£åœ¨å„²å­˜æ‰“å¡è¨˜éŒ„...';
                await callCheckInAPI(latitude, longitude, photoUrl);

                // æˆåŠŸ
                statusDiv.className = 'status-box success';
                statusDiv.textContent = currentCheckInType === 'in' 
                    ? 'âœ… ä¸Šç­æ‰“å¡æˆåŠŸï¼' 
                    : 'âœ… ä¸‹ç­æ‰“å¡æˆåŠŸï¼';

                closeCamera();

                // 3 ç§’å¾Œè¿”å›é¦–é 
                setTimeout(async () => {
                    await checkTodayAttendance(); // é‡æ–°æª¢æŸ¥ç‹€æ…‹
                    showPage('homePage');
                }, 3000);

            } catch (error) {
                console.error('âŒ æ‰“å¡å¤±æ•—:', error);
                statusDiv.className = 'status-box error';
                statusDiv.textContent = 'âŒ æ‰“å¡å¤±æ•—: ' + error.message;
                captureBtn.disabled = false;
            }
        }

        // ä¸Šå‚³ç…§ç‰‡åˆ° Supabase Storage
        async function uploadPhoto(blob) {
            const fileName = `${liffProfile.userId}_${Date.now()}.jpg`;
            const filePath = `${fileName}`;

            const { data, error } = await sb.storage
                .from(STORAGE_BUCKET)
                .upload(filePath, blob, {
                    contentType: 'image/jpeg',
                    upsert: false
                });

            if (error) throw error;

            const { data: urlData } = sb.storage
                .from(STORAGE_BUCKET)
                .getPublicUrl(filePath);

            console.log('âœ… ç…§ç‰‡ä¸Šå‚³æˆåŠŸ:', urlData.publicUrl);
            return urlData.publicUrl;
        }

        // å–å¾— GPS ä½ç½®
        function getGPS() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('æ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½'));
                    return;
                }

                const timeout = setTimeout(() => {
                    reject(new Error('å®šä½é€¾æ™‚ï¼Œè«‹ç¢ºèªå·²é–‹å•Ÿå®šä½æ¬Šé™'));
                }, 15000);

                navigator.geolocation.getCurrentPosition(
                    position => {
                        clearTimeout(timeout);
                        console.log('âœ… GPS å®šä½æˆåŠŸ:', position.coords);
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        });
                    },
                    error => {
                        clearTimeout(timeout);
                        let message = 'å®šä½å¤±æ•—';
                        if (error.code === 1) message = 'è«‹å…è¨±å­˜å–ä½ç½®æ¬Šé™';
                        else if (error.code === 2) message = 'ç„¡æ³•å–å¾—ä½ç½®è³‡è¨Š';
                        else if (error.code === 3) message = 'å®šä½é€¾æ™‚';
                        reject(new Error(message));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            });
        }

        // å‘¼å«æ‰“å¡ API
        async function callCheckInAPI(latitude, longitude, photoUrl) {
            const deviceId = navigator.userAgent;

            const { data, error } = await sb.rpc('quick_check_in', {
                p_line_user_id: liffProfile.userId,
                p_latitude: latitude,
                p_longitude: longitude,
                p_photo_url: photoUrl,
                p_device_id: deviceId
            });

            if (error) throw error;

            console.log('âœ… æ‰“å¡ API å›æ‡‰:', data);

            if (!data.success) {
                throw new Error(data.message || 'æ‰“å¡å¤±æ•—');
            }

            return data;
        }

        // ============================================
        // è€ƒå‹¤è¨˜éŒ„æŸ¥è©¢
        // ============================================
        async function loadAttendanceRecords() {
            const listDiv = document.getElementById('attendanceList');
            listDiv.innerHTML = '<div class="spinner" style="border-color: #667eea; border-top-color: transparent;"></div>';

            try {
                const { data, error } = await sb
                    .from('attendance')
                    .select('*, employees!inner(line_user_id, name)')
                    .eq('employees.line_user_id', liffProfile.userId)
                    .order('date', { ascending: false })
                    .limit(10);

                if (error) throw error;

                if (!data || data.length === 0) {
                    listDiv.innerHTML = '<div class="status-box info">å°šç„¡æ‰“å¡è¨˜éŒ„</div>';
                    return;
                }

                let html = '';
                data.forEach(record => {
                    const date = new Date(record.date).toLocaleDateString('zh-TW');
                    const checkIn = record.check_in_time 
                        ? new Date(record.check_in_time).toLocaleTimeString('zh-TW', { 
                            timeZone: 'Asia/Taipei',
                            hour: '2-digit',
                            minute: '2-digit'
                          })
                        : '-';
                    const checkOut = record.check_out_time
                        ? new Date(record.check_out_time).toLocaleTimeString('zh-TW', { 
                            timeZone: 'Asia/Taipei',
                            hour: '2-digit',
                            minute: '2-digit'
                          })
                        : '-';
                    const workHours = record.work_hours ? record.work_hours.toFixed(2) : '-';
                    const status = record.is_late 
                        ? `<span class="badge danger">é²åˆ° ${record.late_minutes} åˆ†</span>`
                        : `<span class="badge success">æº–æ™‚</span>`;

                    html += `
                        <div class="attendance-item">
                            <div class="date">
                                <span>${date}</span>
                                ${status}
                            </div>
                            <div class="details">
                                ä¸Šç­: ${checkIn} | ä¸‹ç­: ${checkOut} | å·¥æ™‚: ${workHours}h
                            </div>
                        </div>
                    `;
                });

                listDiv.innerHTML = html;

            } catch (error) {
                console.error('âŒ è¼‰å…¥è€ƒå‹¤è¨˜éŒ„å¤±æ•—:', error);
                listDiv.innerHTML = '<div class="status-box error">è¼‰å…¥å¤±æ•—: ' + error.message + '</div>';
            }
        }

        // ============================================
        // è«‹å‡ç”³è«‹
        // ============================================
        async function submitLeave() {
            const type = document.getElementById('leaveType').value;
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const reason = document.getElementById('leaveReason').value;

            if (!type || !startDate || !endDate || !reason) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }

            const statusDiv = document.getElementById('leaveStatus');
            statusDiv.innerHTML = '<div class="status-box info">é€å‡ºä¸­...</div>';

            // TODO: å¯¦ä½œè«‹å‡ API
            setTimeout(() => {
                statusDiv.innerHTML = '<div class="status-box success">âœ… è«‹å‡ç”³è«‹å·²é€å‡ºï¼</div>';
                setTimeout(() => {
                    showPage('homePage');
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('leaveType').value = '';
                    document.getElementById('leaveStartDate').value = '';
                    document.getElementById('leaveEndDate').value = '';
                    document.getElementById('leaveReason').value = '';
                    statusDiv.innerHTML = '';
                }, 2000);
            }, 1500);
        }
    </script>
</body>
</html>
