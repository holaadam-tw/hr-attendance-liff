<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Á∑ö‰∏äÈªûÈ§ê</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#F8FAFC; color:#0F172A; min-height:100vh; }

        .store-header {
            background:linear-gradient(135deg, var(--theme, #4F46E5), var(--theme-dark, #3730A3));
            color:#fff; padding:24px 16px; text-align:center;
        }
        .store-header .store-logo { width:60px; height:60px; border-radius:50%; border:3px solid rgba(255,255,255,0.3); object-fit:cover; margin-bottom:8px; }
        .store-header h1 { font-size:20px; margin-bottom:4px; }
        .store-header .store-desc { font-size:13px; opacity:0.85; }
        .store-header .store-info { font-size:12px; opacity:0.7; margin-top:8px; }

        .category-tabs {
            display:flex; overflow-x:auto; gap:8px; padding:12px 16px; background:#fff;
            border-bottom:1px solid #E2E8F0; position:sticky; top:0; z-index:10;
            -webkit-overflow-scrolling:touch; scrollbar-width:none;
        }
        .category-tabs::-webkit-scrollbar { display:none; }
        .cat-tab {
            padding:8px 18px; border-radius:20px; border:1px solid #E2E8F0; background:#fff;
            font-size:13px; font-weight:600; white-space:nowrap; cursor:pointer; transition:all 0.2s;
        }
        .cat-tab.active { background:var(--theme, #4F46E5); color:#fff; border-color:var(--theme, #4F46E5); }

        .menu-list { padding:12px 16px; }
        .menu-card {
            display:flex; gap:12px; background:#fff; border-radius:14px; padding:12px;
            margin-bottom:10px; box-shadow:0 1px 4px rgba(0,0,0,0.06); align-items:center;
        }
        .menu-card img { width:80px; height:80px; border-radius:10px; object-fit:cover; flex-shrink:0; }
        .menu-card .no-img { width:80px; height:80px; border-radius:10px; background:#E2E8F0; display:flex; align-items:center; justify-content:center; font-size:28px; flex-shrink:0; }
        .menu-card .info { flex:1; min-width:0; }
        .menu-card .name { font-weight:700; font-size:14px; margin-bottom:2px; }
        .menu-card .desc { font-size:12px; color:#64748B; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .menu-card .price { font-size:16px; font-weight:800; color:var(--theme, #4F46E5); }
        .menu-card .tags { display:flex; gap:4px; margin-bottom:4px; }
        .menu-card .tag { font-size:10px; padding:2px 6px; border-radius:4px; background:#EEF2FF; color:#4F46E5; font-weight:600; }
        .add-btn {
            width:36px; height:36px; border-radius:50%; border:none; background:var(--theme, #4F46E5);
            color:#fff; font-size:20px; font-weight:700; cursor:pointer; flex-shrink:0; line-height:36px; text-align:center;
        }
        .unavailable { opacity:0.5; pointer-events:none; }

        .cart-fab {
            position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%;
            background:var(--theme, #4F46E5); color:#fff; border:none; font-size:28px;
            box-shadow:0 4px 16px rgba(0,0,0,0.2); cursor:pointer; z-index:100; display:none;
        }
        .cart-fab .badge {
            position:absolute; top:-4px; right:-4px; background:#EF4444; color:#fff;
            width:22px; height:22px; border-radius:50%; font-size:12px; font-weight:700;
            display:flex; align-items:center; justify-content:center;
        }

        .modal-overlay {
            display:none; position:fixed; top:0; left:0; right:0; bottom:0;
            background:rgba(0,0,0,0.5); z-index:200; align-items:flex-end; justify-content:center;
        }
        .modal-overlay.open { display:flex; }
        .modal-sheet {
            background:#fff; border-radius:20px 20px 0 0; width:100%; max-width:500px;
            max-height:85vh; overflow-y:auto; padding:24px 16px 32px;
        }
        .modal-sheet h2 { font-size:18px; margin-bottom:16px; }

        .cart-item {
            display:flex; align-items:center; gap:12px; padding:10px 0; border-bottom:1px solid #F1F5F9;
        }
        .cart-item .ci-name { flex:1; font-weight:600; font-size:14px; }
        .cart-item .ci-price { font-weight:700; color:var(--theme, #4F46E5); min-width:60px; text-align:right; }
        .qty-ctrl { display:flex; align-items:center; gap:8px; }
        .qty-btn {
            width:28px; height:28px; border-radius:50%; border:1px solid #E2E8F0;
            background:#fff; font-size:16px; cursor:pointer; text-align:center; line-height:26px;
        }
        .qty-num { font-weight:700; font-size:14px; min-width:20px; text-align:center; }

        .cart-total { display:flex; justify-content:space-between; padding:14px 0; font-size:16px; font-weight:800; border-top:2px solid #0F172A; margin-top:8px; }

        .form-group { margin-bottom:12px; }
        .form-group label { display:block; font-size:13px; font-weight:600; color:#374151; margin-bottom:4px; }
        .form-group input, .form-group select, .form-group textarea {
            width:100%; padding:12px; border:1px solid #E2E8F0; border-radius:10px; font-size:14px; box-sizing:border-box;
        }

        .submit-btn {
            width:100%; padding:16px; border:none; border-radius:14px; font-size:16px; font-weight:700;
            color:#fff; background:var(--theme, #4F46E5); cursor:pointer; margin-top:12px;
        }
        .submit-btn:disabled { opacity:0.5; cursor:not-allowed; }

        /* Ë®ÇÂñÆÁ¢∫Ë™ç */
        .order-confirm { padding:24px 16px; text-align:center; }
        .order-confirm .check-icon { font-size:60px; margin-bottom:12px; }
        .order-confirm .order-no { font-size:24px; font-weight:900; color:var(--theme, #4F46E5); }
        .order-confirm .status-badge { display:inline-block; padding:6px 16px; border-radius:20px; font-size:13px; font-weight:700; margin-top:12px; }

        .loading { text-align:center; padding:60px 20px; color:#94A3B8; }
        .error-page { text-align:center; padding:60px 20px; color:#EF4444; }

        .toast {
            position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:#0F172A;
            color:#fff; padding:10px 24px; border-radius:20px; font-size:13px; font-weight:600;
            z-index:9999; opacity:0; transition:opacity 0.3s; pointer-events:none;
        }
        .toast.show { opacity:1; }
    </style>
</head>
<body>
    <div id="loadingView" class="loading">
        <p style="font-size:24px;">üçΩÔ∏è</p>
        <p>ËºâÂÖ•‰∏≠...</p>
    </div>

    <div id="errorView" class="error-page" style="display:none;">
        <p style="font-size:48px;">üò•</p>
        <p style="font-size:16px;font-weight:700;margin-top:12px;">Êâæ‰∏çÂà∞ÂïÜÂ∫ó</p>
        <p style="font-size:13px;color:#94A3B8;margin-top:8px;">Ë´ãÁ¢∫Ë™ç QR Code ÊàñÁ∂≤ÂùÄÊòØÂê¶Ê≠£Á¢∫</p>
    </div>

    <div id="mainView" style="display:none;">
        <!-- ÂïÜÂ∫ó Header -->
        <div class="store-header" id="storeHeader">
            <img id="storeLogo" class="store-logo" src="" style="display:none;">
            <h1 id="storeName"></h1>
            <div id="storeDesc" class="store-desc"></div>
            <div id="storeInfo" class="store-info"></div>
        </div>

        <!-- ÂàÜÈ°û Tab -->
        <div class="category-tabs" id="categoryTabs"></div>

        <!-- ËèúÂñÆÂàóË°® -->
        <div class="menu-list" id="menuList"></div>

        <!-- Ë≥ºÁâ©ËªäÊµÆÂãïÊåâÈàï -->
        <button class="cart-fab" id="cartFab" onclick="openCart()">
            üõí
            <span class="badge" id="cartBadge">0</span>
        </button>
    </div>

    <!-- Ë≥ºÁâ©Ëªä Modal -->
    <div class="modal-overlay" id="cartModal">
        <div class="modal-sheet">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h2 style="margin:0;">üõí Ë≥ºÁâ©Ëªä</h2>
                <button onclick="closeCart()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#94A3B8;">√ó</button>
            </div>
            <div id="cartItems"></div>
            <div class="cart-total">
                <span>ÂêàË®à</span>
                <span id="cartTotal">$0</span>
            </div>

            <hr style="border:none;border-top:1px solid #E2E8F0;margin:16px 0;">
            <div class="form-group">
                <label>ÂßìÂêç *</label>
                <input type="text" id="custName" placeholder="Ë´ãËº∏ÂÖ•ÂßìÂêç">
            </div>
            <div class="form-group">
                <label>ÈõªË©±</label>
                <input type="tel" id="custPhone" placeholder="ÈÅ∏Â°´">
            </div>
            <div class="form-group">
                <label>Áî®È§êÊñπÂºè</label>
                <select id="orderType">
                    <option value="dine_in">ÂÖßÁî®</option>
                    <option value="takeout">Â§ñÂ∏∂</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ê°åËôü</label>
                <input type="text" id="tableNumber" placeholder="ÈÅ∏Â°´ÔºåÂÖßÁî®Ë´ãÂ°´ÂØ´">
            </div>
            <div class="form-group">
                <label>ÂÇôË®ª</label>
                <textarea id="orderNotes" rows="2" placeholder="ÈÅ∏Â°´"></textarea>
            </div>
            <button class="submit-btn" id="submitOrderBtn" onclick="submitOrder()">ÈÄÅÂá∫Ë®ÇÂñÆ</button>
        </div>
    </div>

    <!-- Ë®ÇÂñÆÁ¢∫Ë™çÈ†Å -->
    <div id="orderConfirmView" style="display:none;">
        <div class="store-header" id="confirmHeader">
            <h1 id="confirmStoreName"></h1>
        </div>
        <div class="order-confirm">
            <div class="check-icon">‚úÖ</div>
            <p style="font-size:14px;color:#64748B;">Ë®ÇÂñÆÂ∑≤ÈÄÅÂá∫</p>
            <div class="order-no" id="confirmOrderNo"></div>
            <div class="status-badge" id="confirmStatus" style="background:#ECFDF5;color:#059669;">Á≠âÂæÖÁ¢∫Ë™ç</div>
            <div id="confirmDetail" style="text-align:left;margin-top:20px;background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,0.06);"></div>
            <button onclick="resetOrder()" style="margin-top:20px;padding:14px 32px;border:1px solid #E2E8F0;border-radius:12px;background:#fff;font-size:14px;font-weight:600;cursor:pointer;">ÁπºÁ∫åÈªûÈ§ê</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Supabase (anon key only, no LIFF needed)
        const SUPABASE_URL = 'https://nssuisyvlrqnqfxupklb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3Vpc3l2bHJxbnFmeHVwa2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTAwMzUsImV4cCI6MjA4NDg2NjAzNX0.q_B6v3gf1TOCuAq7z0xIw10wDueCSJn0p37VzdMfmbc';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let store = null;
        let categories = [];
        let menuItems = [];
        let cart = []; // [{item, qty}]
        let activeCategoryId = null;

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function escapeHTML(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

        // ===== ÂàùÂßãÂåñ =====
        async function init() {
            const params = new URLSearchParams(location.search);
            const slug = params.get('store');
            const sid = params.get('sid');

            try {
                let query = sb.from('store_profiles').select('*').eq('is_active', true);
                if (slug) query = query.eq('store_slug', slug);
                else if (sid) query = query.eq('id', sid);
                else throw new Error('no store param');

                const { data, error } = await query.maybeSingle();
                if (error) throw error;
                if (!data) throw new Error('store not found');

                store = data;
                applyTheme(store.theme_color);
                renderStoreHeader();
                await loadMenu();
                document.getElementById('loadingView').style.display = 'none';
                document.getElementById('mainView').style.display = 'block';
            } catch(e) {
                console.error(e);
                document.getElementById('loadingView').style.display = 'none';
                document.getElementById('errorView').style.display = 'block';
            }
        }

        function applyTheme(color) {
            if (!color) return;
            document.documentElement.style.setProperty('--theme', color);
            // Darker variant
            const r = parseInt(color.slice(1,3),16), g = parseInt(color.slice(3,5),16), b = parseInt(color.slice(5,7),16);
            const darker = '#' + [r,g,b].map(c => Math.max(0, c - 40).toString(16).padStart(2,'0')).join('');
            document.documentElement.style.setProperty('--theme-dark', darker);
        }

        function renderStoreHeader() {
            document.getElementById('storeName').textContent = store.store_name;
            document.getElementById('storeDesc').textContent = store.description || '';
            const info = [];
            if (store.phone) info.push('üìû ' + store.phone);
            if (store.address) info.push('üìç ' + store.address);
            document.getElementById('storeInfo').textContent = info.join('  |  ');
            if (store.logo_url) {
                const logo = document.getElementById('storeLogo');
                logo.src = store.logo_url;
                logo.style.display = 'block';
            }
            document.title = store.store_name + ' - Á∑ö‰∏äÈªûÈ§ê';
        }

        async function loadMenu() {
            // ËºâÂÖ•ÂàÜÈ°û
            const { data: cats } = await sb.from('menu_categories')
                .select('*')
                .eq('store_id', store.id)
                .eq('is_active', true)
                .order('sort_order');
            categories = cats || [];

            // ËºâÂÖ•ÂìÅÈ†Ö
            const { data: items } = await sb.from('menu_items')
                .select('*')
                .eq('store_id', store.id)
                .order('sort_order');
            menuItems = items || [];

            renderCategoryTabs();
            renderMenuItems();
        }

        function renderCategoryTabs() {
            const el = document.getElementById('categoryTabs');
            if (categories.length === 0) { el.style.display = 'none'; return; }

            activeCategoryId = null; // show all
            el.innerHTML = `<div class="cat-tab active" onclick="filterCategory(null)">ÂÖ®ÈÉ®</div>` +
                categories.map(c =>
                    `<div class="cat-tab" onclick="filterCategory('${c.id}')">${escapeHTML(c.name)}</div>`
                ).join('');
        }

        function filterCategory(catId) {
            activeCategoryId = catId;
            document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderMenuItems();
        }

        function renderMenuItems() {
            const el = document.getElementById('menuList');
            let items = menuItems;
            if (activeCategoryId) items = items.filter(i => i.category_id === activeCategoryId);

            if (items.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;padding:40px;">Â∞öÁÑ°È§êÈªû</p>';
                return;
            }

            el.innerHTML = items.map(item => {
                const avail = item.is_available !== false;
                const tags = (item.tags || []).map(t => `<span class="tag">${escapeHTML(t)}</span>`).join('');
                return `<div class="menu-card ${avail ? '' : 'unavailable'}">
                    ${item.image_url
                        ? `<img src="${item.image_url}" alt="${escapeHTML(item.name)}">`
                        : `<div class="no-img">üçΩÔ∏è</div>`}
                    <div class="info">
                        ${tags ? '<div class="tags">' + tags + '</div>' : ''}
                        <div class="name">${escapeHTML(item.name)}</div>
                        <div class="desc">${escapeHTML(item.description || '')}</div>
                        <div class="price">$${item.price}</div>
                    </div>
                    ${avail ? `<button class="add-btn" onclick="addToCart('${item.id}')">+</button>` : '<span style="font-size:12px;color:#94A3B8;">ÂîÆÂÆå</span>'}
                </div>`;
            }).join('');
        }

        // ===== Ë≥ºÁâ©Ëªä =====
        function addToCart(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            const existing = cart.find(c => c.item.id === itemId);
            if (existing) { existing.qty++; }
            else { cart.push({ item, qty: 1 }); }
            updateCartUI();
            showToast(`Â∑≤Âä†ÂÖ• ${item.name}`);
        }

        function updateCartQty(itemId, delta) {
            const idx = cart.findIndex(c => c.item.id === itemId);
            if (idx < 0) return;
            cart[idx].qty += delta;
            if (cart[idx].qty <= 0) cart.splice(idx, 1);
            updateCartUI();
            renderCartItems();
        }

        function updateCartUI() {
            const total = cart.reduce((s, c) => s + c.qty, 0);
            const fab = document.getElementById('cartFab');
            fab.style.display = total > 0 ? 'block' : 'none';
            document.getElementById('cartBadge').textContent = total;
        }

        function openCart() {
            if (cart.length === 0) return showToast('Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ');
            renderCartItems();
            document.getElementById('cartModal').classList.add('open');
        }

        function closeCart() {
            document.getElementById('cartModal').classList.remove('open');
        }

        function renderCartItems() {
            const el = document.getElementById('cartItems');
            el.innerHTML = cart.map(c => `
                <div class="cart-item">
                    <div class="ci-name">${escapeHTML(c.item.name)}</div>
                    <div class="qty-ctrl">
                        <button class="qty-btn" onclick="updateCartQty('${c.item.id}', -1)">‚àí</button>
                        <span class="qty-num">${c.qty}</span>
                        <button class="qty-btn" onclick="updateCartQty('${c.item.id}', 1)">+</button>
                    </div>
                    <div class="ci-price">$${c.item.price * c.qty}</div>
                </div>
            `).join('');
            const total = cart.reduce((s, c) => s + c.item.price * c.qty, 0);
            document.getElementById('cartTotal').textContent = '$' + total;
        }

        // ===== ÈÄÅÂá∫Ë®ÇÂñÆ =====
        async function submitOrder() {
            const name = document.getElementById('custName').value.trim();
            if (!name) return showToast('Ë´ãËº∏ÂÖ•ÂßìÂêç');
            if (cart.length === 0) return showToast('Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ');

            const btn = document.getElementById('submitOrderBtn');
            btn.disabled = true; btn.textContent = 'ÈÄÅÂá∫‰∏≠...';

            try {
                const items = cart.map(c => ({
                    name: c.item.name,
                    qty: c.qty,
                    price: c.item.price,
                    subtotal: c.item.price * c.qty
                }));
                const total = items.reduce((s, i) => s + i.subtotal, 0);
                const orderNumber = 'O' + Date.now().toString(36).toUpperCase();

                const record = {
                    store_id: store.id,
                    order_number: orderNumber,
                    customer_name: name,
                    customer_phone: document.getElementById('custPhone').value.trim() || null,
                    order_type: document.getElementById('orderType').value,
                    table_number: document.getElementById('tableNumber').value.trim() || null,
                    items: items,
                    total: total,
                    notes: document.getElementById('orderNotes').value.trim() || null,
                    status: 'pending'
                };

                const { data, error } = await sb.from('orders').insert(record).select().single();
                if (error) throw error;

                // È°ØÁ§∫Á¢∫Ë™çÈ†Å
                showOrderConfirmation(data, items);
                cart = [];
                updateCartUI();
                closeCart();
            } catch(e) {
                console.error(e);
                showToast('Ë®ÇÂñÆÈÄÅÂá∫Â§±ÊïóÔºåË´ãÈáçË©¶');
            }
            btn.disabled = false; btn.textContent = 'ÈÄÅÂá∫Ë®ÇÂñÆ';
        }

        function showOrderConfirmation(order, items) {
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('orderConfirmView').style.display = 'block';
            document.getElementById('confirmStoreName').textContent = store.store_name;
            document.getElementById('confirmOrderNo').textContent = '#' + order.order_number;

            const typeLabel = { dine_in:'ÂÖßÁî®', takeout:'Â§ñÂ∏∂', delivery:'Â§ñÈÄÅ' };
            document.getElementById('confirmDetail').innerHTML = `
                <div style="margin-bottom:12px;">
                    <div style="font-size:13px;color:#64748B;margin-bottom:4px;">È°ßÂÆ¢</div>
                    <div style="font-weight:600;">${escapeHTML(order.customer_name)} ${order.table_number ? '¬∑ Ê°åËôü ' + escapeHTML(order.table_number) : ''}</div>
                    <div style="font-size:13px;color:#64748B;">${typeLabel[order.order_type] || order.order_type}</div>
                </div>
                <div style="border-top:1px solid #F1F5F9;padding-top:8px;">
                    ${items.map(i => `
                        <div style="display:flex;justify-content:space-between;padding:4px 0;font-size:14px;">
                            <span>${escapeHTML(i.name)} x${i.qty}</span>
                            <span style="font-weight:600;">$${i.subtotal}</span>
                        </div>
                    `).join('')}
                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-top:1px solid #E2E8F0;margin-top:8px;font-weight:800;font-size:16px;">
                        <span>ÂêàË®à</span>
                        <span style="color:var(--theme, #4F46E5);">$${order.total}</span>
                    </div>
                </div>
                ${order.notes ? '<div style="margin-top:8px;font-size:13px;color:#64748B;">ÂÇôË®ªÔºö' + escapeHTML(order.notes) + '</div>' : ''}
            `;
        }

        function resetOrder() {
            document.getElementById('orderConfirmView').style.display = 'none';
            document.getElementById('mainView').style.display = 'block';
            document.getElementById('custName').value = '';
            document.getElementById('custPhone').value = '';
            document.getElementById('tableNumber').value = '';
            document.getElementById('orderNotes').value = '';
        }

        // ===== ÂïüÂãï =====
        init();
    </script>
</body>
</html>
