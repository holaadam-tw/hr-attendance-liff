<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#E8430A">
<title>ÊéÉÁ¢ºÈªûÈ§ê</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
<style>
/* ===== CSS VARIABLES ===== */
:root {
  --primary: #E8430A;
  --primary-light: #FF6B35;
  --primary-dark: #C23508;
  --accent: #FFB800;
  --accent-light: #FFD466;
  --bg: #F5F0EB;
  --bg-card: #FFFFFF;
  --bg-sidebar: #FAFAFA;
  --text-primary: #1A1A1A;
  --text-secondary: #666666;
  --text-muted: #999999;
  --border: #E8E8E8;
  --border-light: #F0F0F0;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
  --shadow-xl: 0 12px 40px rgba(0,0,0,0.16);
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

/* ===== RESET & BASE ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; -webkit-tap-highlight-color: transparent; }
body {
  font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text-primary);
  line-height: 1.6;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ===== LOADING SCREEN ===== */
.loading-screen {
  position: fixed; inset: 0; z-index: 9999;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  transition: opacity 0.5s, visibility 0.5s;
}
.loading-screen.hide { opacity: 0; visibility: hidden; pointer-events: none; }
.loading-logo {
  width: 80px; height: 80px; border-radius: 20px;
  background: rgba(255,255,255,0.15); backdrop-filter: blur(10px);
  display: flex; align-items: center; justify-content: center;
  font-size: 32px; margin-bottom: 20px; color: white; font-weight: 900;
  animation: logoPulse 1.5s ease-in-out infinite;
}
@keyframes logoPulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.08); } }
.loading-text { color: white; font-size: 15px; font-weight: 500; letter-spacing: 1px; }
.loading-dots::after {
  content: ''; animation: dots 1.2s steps(4) infinite;
}
@keyframes dots {
  0% { content: ''; } 25% { content: '.'; } 50% { content: '..'; } 75% { content: '...'; }
}

/* ===== BRAND HERO ===== */
.brand-hero {
  display: none; background: #FFF;
}
.brand-hero.show { display: block; }
.brand-hero-img {
  width: 100%; display: block; object-fit: contain;
  background: #F8F8F8;
}
/* ===== SHARE BTN ===== */
.share-btn {
  background: rgba(255,255,255,0.2); padding: 3px 10px;
  border-radius: 20px; font-size: 11px; font-weight: 600;
  color: #FFF; cursor: pointer; backdrop-filter: blur(5px);
  text-decoration: none; white-space: nowrap;
}

/* ===== SHOP HEADER ===== */
.shop-header {
  background: var(--header-gradient, linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 60%, var(--primary-dark) 100%));
  color: white; padding: 0 0 16px; position: relative; overflow: hidden;
}
.shop-header::before {
  content: ''; position: absolute; top: -40%; right: -20%;
  width: 200px; height: 200px; border-radius: 50%;
  background: rgba(255,255,255,0.06);
}
.shop-header::after {
  content: ''; position: absolute; bottom: -30%; left: -10%;
  width: 150px; height: 150px; border-radius: 50%;
  background: rgba(255,255,255,0.04);
}
.header-status-bar {
  padding: 12px 16px 8px; font-size: 12px;
  display: flex; justify-content: space-between; align-items: center;
  position: relative; z-index: 1;
}
.header-status-bar .badge {
  background: rgba(255,255,255,0.2); padding: 3px 10px;
  border-radius: 20px; font-size: 11px; backdrop-filter: blur(5px);
}
.badge.open { background: rgba(76,175,80,0.3); }
.badge.closed { background: rgba(244,67,54,0.3); }
.shop-info {
  padding: 0 20px; position: relative; z-index: 1;
}
.shop-name-row {
  display: flex; align-items: center; gap: 12px; margin-bottom: 8px;
}
.shop-logo {
  width: 56px; height: 56px; border-radius: var(--radius-md);
  background: rgba(255,255,255,0.15); backdrop-filter: blur(10px);
  display: flex; align-items: center; justify-content: center;
  font-size: 28px; flex-shrink: 0;
  border: 2px solid rgba(255,255,255,0.2);
}
.shop-name {
  font-size: 22px; font-weight: 900; letter-spacing: 1px;
  text-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.shop-subtitle { font-size: 12px; opacity: 0.85; margin-top: 2px; }
.shop-details {
  display: flex; flex-direction: column; gap: 6px;
  font-size: 12.5px; opacity: 0.9;
}
.shop-details .detail-row {
  display: flex; align-items: center; gap: 6px;
}
.shop-details .icon { width: 14px; text-align: center; flex-shrink: 0; opacity: 0.8; }

/* ===== TABLE / GUEST SELECTOR ===== */
.table-selector {
  background: white; margin: -8px 12px 0; border-radius: var(--radius-lg);
  padding: 16px 18px; position: relative; z-index: 2;
  box-shadow: var(--shadow-lg);
}
.table-selector h3 {
  font-size: 14px; font-weight: 600; color: var(--text-secondary);
  margin-bottom: 10px; display: flex; align-items: center; gap: 6px;
}
.table-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.table-label { font-size: 13px; color: var(--text-secondary); min-width: 48px; }
.table-input {
  flex: 1; height: 40px; border: 1.5px solid var(--border);
  border-radius: var(--radius-sm); padding: 0 12px;
  font-size: 15px; font-weight: 600; text-align: center;
  font-family: inherit; outline: none; transition: border-color 0.2s;
}
.table-input:focus { border-color: var(--primary); }
.guest-selector { display: flex; gap: 8px; flex-wrap: wrap; }
.guest-btn {
  width: 44px; height: 44px; border-radius: 50%;
  border: 1.5px solid var(--border); background: white;
  font-size: 15px; font-weight: 600; cursor: pointer;
  transition: all 0.2s; display: flex; align-items: center; justify-content: center;
  font-family: inherit;
}
.guest-btn:hover { border-color: var(--primary); color: var(--primary); }
.guest-btn.active {
  background: var(--primary); color: white;
  border-color: var(--primary); transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.guest-btn-more {
  width: 44px; height: 44px; border-radius: 50%;
  border: 1.5px dashed var(--border); background: white;
  font-size: 18px; color: var(--text-muted); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s; font-family: inherit;
}
.guest-btn-more:hover { border-color: var(--primary); color: var(--primary); }

/* ===== MAIN LAYOUT ===== */
.menu-container {
  display: flex; height: calc(100vh - 280px); height: calc(100dvh - 280px);
  margin-top: 12px; position: relative;
}

/* ===== LEFT SIDEBAR CATEGORIES ===== */
.category-sidebar {
  width: 82px; flex-shrink: 0;
  background: var(--bg-sidebar);
  overflow-y: auto; overflow-x: hidden;
  scrollbar-width: none; -ms-overflow-style: none;
  border-right: 1px solid var(--border-light);
}
.category-sidebar::-webkit-scrollbar { display: none; }
.cat-item {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 14px 6px; cursor: pointer;
  position: relative; transition: all 0.2s;
  border-left: 3px solid transparent;
  min-height: 60px;
}
.cat-item:hover { background: rgba(0,0,0,0.03); }
.cat-item.active {
  background: white;
  border-left-color: var(--primary);
}
.cat-item.active .cat-name { color: var(--primary); font-weight: 700; }
.cat-icon { font-size: 20px; margin-bottom: 4px; }
.cat-name {
  font-size: 12px; font-weight: 500; text-align: center;
  color: var(--text-secondary); line-height: 1.3;
  word-break: keep-all;
}
.cat-badge {
  position: absolute; top: 6px; right: 8px;
  background: var(--primary); color: white;
  font-size: 10px; font-weight: 700;
  min-width: 16px; height: 16px; line-height: 16px;
  border-radius: 8px; text-align: center; padding: 0 4px;
  display: none;
}
.cat-badge.show { display: block; }

/* ===== RIGHT MENU CONTENT ===== */
.menu-content {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  scroll-behavior: smooth; padding-bottom: 100px;
  scrollbar-width: none; -ms-overflow-style: none;
}
.menu-content::-webkit-scrollbar { display: none; }

/* ===== FEATURED / RECOMMENDED ===== */
.featured-section { padding: 16px 14px 8px; }
.section-title {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 12px;
}
.section-title .fire { font-size: 18px; }
.section-title h2 { font-size: 16px; font-weight: 800; color: var(--text-primary); }
.section-title .subtitle { font-size: 11px; color: var(--text-muted); margin-left: auto; }
.featured-scroll {
  display: flex; gap: 10px; overflow-x: auto;
  padding-bottom: 8px; scrollbar-width: none;
  -ms-overflow-style: none; scroll-snap-type: x mandatory;
}
.featured-scroll::-webkit-scrollbar { display: none; }
.featured-card {
  flex-shrink: 0; width: 140px; scroll-snap-align: start;
  background: white; border-radius: var(--radius-md);
  overflow: hidden; box-shadow: var(--shadow-sm);
  cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
  position: relative;
}
.featured-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
.featured-card:active { transform: scale(0.97); }
.featured-img { width: 100%; height: 105px; object-fit: cover; background: #f0ece7; }
.featured-badge {
  position: absolute; top: 8px; left: 8px;
  background: var(--primary); color: white;
  font-size: 10px; font-weight: 700; padding: 2px 8px;
  border-radius: 10px;
}
.featured-info { padding: 8px 10px 10px; }
.featured-name {
  font-size: 13px; font-weight: 600;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  margin-bottom: 4px;
}
.featured-price { font-size: 15px; font-weight: 800; color: var(--primary); }
.featured-price .currency { font-size: 11px; font-weight: 600; }
.featured-add {
  position: absolute; bottom: 8px; right: 8px;
  width: 28px; height: 28px; border-radius: 50%;
  background: var(--primary); color: white;
  border: none; font-size: 18px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.featured-add:hover { transform: scale(1.1); }
.featured-add:active { transform: scale(0.9); }

/* ===== CATEGORY SECTION ===== */
.category-section { padding: 12px 14px 4px; }
.category-header {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 0 10px; border-bottom: 1px solid var(--border-light);
  margin-bottom: 8px; position: sticky; top: 0;
  background: var(--bg); z-index: 5;
}
.category-header .cat-emoji { font-size: 18px; }
.category-header h3 { font-size: 15px; font-weight: 700; }
.category-header .count {
  font-size: 11px; color: var(--text-muted); margin-left: auto;
  background: var(--border-light); padding: 2px 8px; border-radius: 10px;
}

/* ===== MENU ITEM CARD ===== */
.menu-item {
  display: flex; gap: 12px; padding: 12px 0;
  border-bottom: 1px solid var(--border-light);
  position: relative; cursor: pointer; transition: background 0.15s;
}
.menu-item:last-child { border-bottom: none; }
.menu-item:active { background: rgba(0,0,0,0.02); }
.item-img-wrap {
  width: 100px; height: 100px; flex-shrink: 0;
  border-radius: var(--radius-md); overflow: hidden; position: relative;
}
.item-img {
  width: 100%; height: 100%; object-fit: cover;
  background: #f0ece7; transition: transform 0.3s;
}
.menu-item:hover .item-img { transform: scale(1.05); }
.item-sold-tag {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: rgba(0,0,0,0.55); color: white;
  font-size: 10px; text-align: center; padding: 2px 0;
  backdrop-filter: blur(4px);
}
.item-spicy {
  position: absolute; top: 6px; right: 6px;
  font-size: 14px; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
}
.item-info { flex: 1; min-width: 0; display: flex; flex-direction: column; }
.item-name {
  font-size: 14.5px; font-weight: 700; margin-bottom: 3px;
  display: -webkit-box; -webkit-line-clamp: 2;
  -webkit-box-orient: vertical; overflow: hidden;
}
.item-desc {
  font-size: 11.5px; color: var(--text-muted); margin-bottom: auto;
  display: -webkit-box; -webkit-line-clamp: 2;
  -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5;
}
.item-tags { display: flex; gap: 4px; margin: 6px 0 4px; flex-wrap: wrap; }
.item-tag { font-size: 10px; padding: 1px 6px; border-radius: 4px; font-weight: 500; }
.item-tag.hot { background: #FFF3E0; color: #E65100; }
.item-tag.new { background: #E8F5E9; color: #2E7D32; }
.item-tag.chef { background: #FFF8E1; color: #F57F17; }
.item-bottom {
  display: flex; align-items: flex-end; justify-content: space-between; margin-top: auto;
}
.item-price { font-size: 18px; font-weight: 800; color: var(--primary); }
.item-price .currency { font-size: 12px; font-weight: 600; }
.item-sizes { display: flex; gap: 8px; margin-top: 2px; }
.size-option {
  font-size: 11px; color: var(--text-muted);
  cursor: pointer; padding: 2px 8px; border-radius: 4px;
  border: 1px solid var(--border); transition: all 0.15s;
}
.size-option:hover, .size-option.active {
  border-color: var(--primary); color: var(--primary);
  background: rgba(0,0,0,0.02);
}
.item-actions { display: flex; align-items: center; gap: 0; }
.qty-control {
  display: flex; align-items: center; gap: 0;
  background: white; border-radius: 20px; overflow: hidden;
  box-shadow: var(--shadow-sm); border: 1px solid var(--border);
}
.qty-btn {
  width: 30px; height: 30px; border: none;
  background: transparent; font-size: 16px; font-weight: 700;
  cursor: pointer; display: flex; align-items: center;
  justify-content: center; transition: all 0.15s;
  color: var(--text-secondary); font-family: inherit;
}
.qty-btn:hover { background: rgba(0,0,0,0.05); color: var(--primary); }
.qty-btn:active { transform: scale(0.9); }
.qty-btn.minus { color: var(--text-muted); }
.qty-num {
  width: 28px; text-align: center; font-size: 14px;
  font-weight: 700; color: var(--text-primary);
}
.add-btn {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--primary); color: white; border: none;
  font-size: 20px; cursor: pointer; display: flex;
  align-items: center; justify-content: center;
  transition: all 0.15s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  font-family: inherit;
}
.add-btn:hover { transform: scale(1.1); }
.add-btn:active { transform: scale(0.85); }

/* ===== BOTTOM CART BAR ===== */
.cart-bar {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
  padding: 0 12px calc(10px + var(--safe-bottom));
  pointer-events: none; transition: transform 0.3s;
}
.cart-bar.hidden { transform: translateY(100%); }
.cart-inner {
  background: linear-gradient(135deg, #2D2D2D, #1A1A1A);
  border-radius: var(--radius-xl);
  display: flex; align-items: center;
  padding: 10px 10px 10px 16px;
  box-shadow: var(--shadow-xl);
  pointer-events: auto; position: relative; overflow: hidden;
}
.cart-inner::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(232,67,10,0.08), transparent);
  pointer-events: none;
}
.cart-icon-wrap { position: relative; margin-right: 12px; cursor: pointer; }
.cart-icon {
  width: 44px; height: 44px; border-radius: 50%;
  background: var(--primary);
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  transition: transform 0.2s;
}
.cart-icon:active { transform: scale(0.9); }
.cart-count {
  position: absolute; top: -4px; right: -4px;
  background: var(--accent); color: #1A1A1A;
  font-size: 11px; font-weight: 800;
  min-width: 20px; height: 20px; line-height: 20px;
  border-radius: 10px; text-align: center;
  padding: 0 5px; border: 2px solid #2D2D2D;
}
.cart-info { flex: 1; }
.cart-items-text { color: rgba(255,255,255,0.7); font-size: 12px; }
.cart-total { color: white; font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
.cart-total .currency { font-size: 13px; font-weight: 600; }
.cart-submit {
  background: var(--primary); color: white; border: none;
  height: 48px; padding: 0 24px; border-radius: 14px;
  font-size: 15px; font-weight: 700; cursor: pointer;
  font-family: inherit; transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  display: flex; align-items: center; gap: 6px; white-space: nowrap;
}
.cart-submit:hover { filter: brightness(1.1); }
.cart-submit:active { transform: scale(0.96); }
.cart-submit:disabled { background: #555; cursor: not-allowed; box-shadow: none; }

/* ===== CART DRAWER ===== */
.cart-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
  opacity: 0; visibility: hidden; transition: all 0.3s;
}
.cart-overlay.show { opacity: 1; visibility: visible; }
.cart-drawer {
  position: fixed; bottom: 0; left: 0; right: 0;
  z-index: 201; background: white;
  border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  max-height: 70vh; overflow: hidden;
  transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32,0.72,0,1);
  display: flex; flex-direction: column;
}
.cart-drawer.show { transform: translateY(0); }
.drawer-handle {
  width: 36px; height: 4px; background: #DDD;
  border-radius: 2px; margin: 10px auto;
}
.drawer-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px 14px; border-bottom: 1px solid var(--border-light);
}
.drawer-header h3 { font-size: 17px; font-weight: 700; }
.drawer-clear {
  font-size: 13px; color: var(--text-muted); cursor: pointer;
  background: none; border: none; font-family: inherit;
  padding: 4px 8px; border-radius: 6px; transition: all 0.15s;
}
.drawer-clear:hover { background: #f5f5f5; color: var(--primary); }
.drawer-items { flex: 1; overflow-y: auto; padding: 10px 20px; }
.drawer-item {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 0; border-bottom: 1px solid var(--border-light);
}
.drawer-item:last-child { border-bottom: none; }
.drawer-item-img {
  width: 56px; height: 56px; border-radius: var(--radius-sm);
  object-fit: cover; background: #f0ece7;
}
.drawer-item-info { flex: 1; }
.drawer-item-name { font-size: 14px; font-weight: 600; }
.drawer-item-size { font-size: 11px; color: var(--text-muted); }
.drawer-item-price { font-size: 15px; font-weight: 700; color: var(--primary); }
.drawer-item-qty {
  display: flex; align-items: center; gap: 0;
  border: 1px solid var(--border); border-radius: 20px; overflow: hidden;
}
.drawer-qty-btn {
  width: 28px; height: 28px; border: none;
  background: transparent; font-size: 14px; font-weight: 700;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: background 0.15s; font-family: inherit;
}
.drawer-qty-btn:hover { background: rgba(0,0,0,0.05); }
.drawer-qty-num { width: 24px; text-align: center; font-size: 13px; font-weight: 700; }
.drawer-footer {
  padding: 14px 20px calc(14px + var(--safe-bottom));
  border-top: 1px solid var(--border-light); background: white;
}
.drawer-total-row {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
}
.drawer-total-label { font-size: 14px; color: var(--text-secondary); }
.drawer-total-price { font-size: 22px; font-weight: 800; color: var(--primary); }
.drawer-submit {
  width: 100%; height: 50px; border: none; border-radius: var(--radius-md);
  background: var(--primary); color: white;
  font-size: 16px; font-weight: 700; cursor: pointer;
  font-family: inherit; transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.drawer-submit:active { transform: scale(0.98); }

/* ===== ITEM DETAIL MODAL ===== */
.item-modal-overlay {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
  opacity: 0; visibility: hidden; transition: all 0.3s;
  display: flex; align-items: flex-end; justify-content: center;
}
.item-modal-overlay.show { opacity: 1; visibility: visible; }
.item-modal {
  background: white; border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  width: 100%; max-height: 85vh; overflow: hidden;
  transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32,0.72,0,1);
  display: flex; flex-direction: column;
}
.item-modal-overlay.show .item-modal { transform: translateY(0); }
.modal-img { width: 100%; height: 240px; object-fit: cover; background: #f0ece7; }
.modal-close {
  position: absolute; top: 16px; right: 16px;
  width: 32px; height: 32px; border-radius: 50%;
  background: rgba(0,0,0,0.4); color: white; border: none;
  font-size: 18px; cursor: pointer; backdrop-filter: blur(4px);
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.modal-close:hover { background: rgba(0,0,0,0.6); }
.modal-body { padding: 20px; overflow-y: auto; flex: 1; }
.modal-name { font-size: 20px; font-weight: 800; margin-bottom: 6px; }
.modal-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 16px; }
.modal-option-group { margin-bottom: 16px; }
.modal-option-title {
  font-size: 14px; font-weight: 700; margin-bottom: 8px;
  display: flex; align-items: center; gap: 6px;
}
.modal-option-title .required {
  font-size: 10px; background: var(--primary); color: white;
  padding: 1px 6px; border-radius: 4px; font-weight: 600;
}
.modal-options { display: flex; flex-wrap: wrap; gap: 8px; }
.modal-opt-btn {
  padding: 8px 16px; border: 1.5px solid var(--border);
  border-radius: var(--radius-sm); background: white;
  font-size: 13px; cursor: pointer; transition: all 0.15s;
  font-family: inherit; font-weight: 500;
}
.modal-opt-btn:hover { border-color: var(--primary); }
.modal-opt-btn.active {
  border-color: var(--primary); color: var(--primary);
  background: rgba(0,0,0,0.02);
}
.modal-footer {
  padding: 14px 20px calc(14px + var(--safe-bottom));
  border-top: 1px solid var(--border-light);
  display: flex; align-items: center; gap: 16px;
}
.modal-price { font-size: 24px; font-weight: 800; color: var(--primary); }
.modal-price .currency { font-size: 14px; }
.modal-qty-area { display: flex; align-items: center; gap: 0; }
.modal-add-cart {
  flex: 1; height: 48px; border: none; border-radius: var(--radius-md);
  background: var(--primary); color: white;
  font-size: 15px; font-weight: 700; cursor: pointer;
  font-family: inherit; transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.modal-add-cart:active { transform: scale(0.97); }

/* ===== EMPTY STATE ===== */
.empty-state {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 60px 30px; text-align: center;
}
.empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
.empty-title { font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
.empty-desc { font-size: 13px; color: var(--text-muted); }

/* ===== FLY DOT ANIMATION ===== */
.fly-dot {
  position: fixed; z-index: 999;
  width: 14px; height: 14px; border-radius: 50%;
  background: var(--primary); pointer-events: none;
  transition: all 0.55s cubic-bezier(0.2, 0.8, 0.2, 1);
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

/* ===== TOAST ===== */
.toast {
  position: fixed; top: 60px; left: 50%; transform: translateX(-50%) translateY(-20px);
  z-index: 500; background: #333; color: white;
  padding: 10px 20px; border-radius: var(--radius-sm);
  font-size: 13px; font-weight: 500;
  opacity: 0; visibility: hidden; transition: all 0.3s;
  box-shadow: var(--shadow-lg); white-space: nowrap;
}
.toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }

/* ===== SEARCH BAR ===== */
.search-bar { padding: 10px 14px 6px; background: var(--bg); }
.search-input-wrap {
  display: flex; align-items: center; gap: 8px;
  background: white; border-radius: var(--radius-sm);
  padding: 0 12px; height: 38px; border: 1px solid var(--border);
  transition: border-color 0.2s;
}
.search-input-wrap:focus-within { border-color: var(--primary); }
.search-input-wrap .icon { color: var(--text-muted); font-size: 14px; flex-shrink: 0; }
.search-input {
  flex: 1; border: none; outline: none; font-size: 13px;
  font-family: inherit; background: transparent;
}
.search-input::placeholder { color: var(--text-muted); }
.search-clear {
  width: 20px; height: 20px; border-radius: 50%;
  background: #eee; border: none; font-size: 12px;
  cursor: pointer; display: none; align-items: center; justify-content: center;
  color: var(--text-muted);
}
.search-clear.show { display: flex; }

/* ===== THEME PICKER ===== */
.theme-fab {
  position: fixed; top: 12px; right: 12px; z-index: 150;
  height: 40px; border-radius: 20px;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  border: none; padding: 0 16px 0 12px;
  display: flex; align-items: center; gap: 6px;
  cursor: pointer; font-size: 14px; transition: all 0.25s;
  box-shadow: 0 3px 12px rgba(0,0,0,0.2);
  color: #fff; font-weight: 600;
}
.theme-fab:hover { transform: scale(1.05); box-shadow: 0 4px 16px rgba(0,0,0,0.25); }
.theme-fab:active { transform: scale(0.97); }
.theme-fab-icon { font-size: 18px; display: flex; }
.theme-fab-label { font-size: 13px; font-weight: 700; letter-spacing: 0.3px; }
.theme-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.5);
  display: none; align-items: flex-end; justify-content: center;
}
.theme-overlay.show { display: flex; }
.theme-panel {
  background: white; border-radius: 20px 20px 0 0;
  padding: 24px 20px calc(24px + env(safe-area-inset-bottom, 0px));
  width: 100%; max-width: 480px; max-height: 75vh; overflow-y: auto;
  box-shadow: 0 -4px 24px rgba(0,0,0,0.15);
  animation: slideUpPanel 0.3s ease-out;
}
@keyframes slideUpPanel { from { transform: translateY(100%); } to { transform: translateY(0); } }
.theme-panel-handle { width: 40px; height: 4px; border-radius: 2px; background: #D1D5DB; margin: 0 auto 16px; }
.theme-panel h4 { font-size: 18px; font-weight: 800; margin-bottom: 4px; color: var(--text-primary); text-align: center; }
.theme-panel-sub { font-size: 12px; color: var(--text-muted); text-align: center; margin-bottom: 16px; }
.theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.theme-card {
  position: relative; border-radius: 16px; padding: 16px 10px 12px;
  cursor: pointer; transition: all 0.2s; text-align: center;
  border: 2.5px solid transparent;
}
.theme-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.theme-card.active { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary); }
.theme-card.active::after {
  content: '\2713'; position: absolute; top: 8px; right: 8px;
  width: 22px; height: 22px; border-radius: 50%;
  background: var(--primary); color: #fff;
  font-size: 13px; font-weight: 700; line-height: 22px; text-align: center;
}
.theme-card-dots { display: flex; gap: 6px; justify-content: center; margin-bottom: 10px; }
.theme-card-dot { width: 24px; height: 24px; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
.theme-card-name { font-size: 13px; font-weight: 700; color: #333; }
.theme-card-dark .theme-card-name { color: #eee; }

/* ===== RESPONSIVE ===== */
@media (min-width: 480px) {
  body { max-width: 480px; margin: 0 auto; box-shadow: -1px 0 0 #eee, 1px 0 0 #eee; min-height: 100vh; }
}

/* ===== ANIMATIONS ===== */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-in { animation: fadeInUp 0.35s ease-out both; }
.menu-item { animation: fadeInUp 0.3s ease-out both; }
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-logo">&#x1F37D;&#xFE0F;</div>
  <div class="loading-text">ËºâÂÖ•ËèúÂñÆ‰∏≠<span class="loading-dots"></span></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- THEME PICKER -->
<div class="theme-fab" id="themeFab" onclick="toggleThemePanel()">
  <span class="theme-fab-icon">&#x1F3A8;</span>
  <span class="theme-fab-label">È¢®Ê†º</span>
</div>
<div class="theme-overlay" id="themeOverlay" onclick="if(event.target===this)closeThemePanel()">
  <div class="theme-panel" id="themePanel"></div>
</div>

<!-- ===== BRAND HERO (DM) ===== -->
<div class="brand-hero" id="brandHero">
  <img class="brand-hero-img" id="brandHeroImg" src="" alt="">
</div>

<!-- ===== SHOP HEADER ===== -->
<header class="shop-header" id="shopHeader">
  <div class="header-status-bar">
    <span>ÊéÉÁ¢ºÈªûÈ§ê</span>
    <div style="display:flex;align-items:center;gap:8px;">
      <span class="badge open" id="shopStatus">ÁáüÊ•≠‰∏≠</span>
      <a class="share-btn" id="shareBtn" onclick="shareOrder()" style="display:none;">&#x1F4E4; ÂàÜ‰∫´Ë®ÇÂñÆ</a>
    </div>
  </div>
  <div class="shop-info">
    <div class="shop-name-row">
      <div class="shop-logo" id="shopLogo">&#x1F37D;&#xFE0F;</div>
      <div>
        <div class="shop-name" id="shopName">ÊùæËæ£Ê§í</div>
        <div class="shop-subtitle" id="shopSubtitle">ÂÇ≥Áµ±Á∂ìÂÖ∏Âè∞ÂºèÁÜ±ÁÇíÁæéÈ£ü</div>
      </div>
    </div>
    <div class="shop-details">
      <div class="detail-row"><span class="icon">&#x1F4CD;</span><span id="shopAddress">Âè∞‰∏≠Â∏ÇË•øÂçÄÁ≤æË™†Ë∑Ø 88 Ëôü</span></div>
      <div class="detail-row"><span class="icon">&#x1F4DE;</span><span id="shopPhone">04-2310-8888</span></div>
      <div class="detail-row"><span class="icon">&#x1F550;</span><span id="shopHours">11:00 - 22:00</span></div>
    </div>
  </div>
</header>

<!-- ===== TABLE / GUEST SELECTOR ===== -->
<div class="table-selector" id="tableSelector">
  <h3>&#9745; ÈÅ∏ÊìáÊ°åËôü / Áî®È§ê‰∫∫Êï∏</h3>
  <div class="table-row">
    <span class="table-label">Ê°åËôü</span>
    <input type="text" class="table-input" id="tableNumber" placeholder="Ëº∏ÂÖ•Ê°åËôü" maxlength="10">
  </div>
  <div class="table-row">
    <span class="table-label">‰∫∫Êï∏</span>
    <div class="guest-selector" id="guestSelector">
      <button class="guest-btn" data-num="1">1</button>
      <button class="guest-btn" data-num="2">2</button>
      <button class="guest-btn active" data-num="3">3</button>
      <button class="guest-btn" data-num="4">4</button>
      <button class="guest-btn" data-num="5">5</button>
      <button class="guest-btn" data-num="6">6</button>
      <button class="guest-btn-more" onclick="promptGuestCount()">&#8943;</button>
    </div>
  </div>
</div>

<!-- ===== MEMBERSHIP / PHONE ===== -->
<div id="memberSection" style="display:none;margin:0 16px 8px;background:var(--bg-card);border-radius:12px;padding:12px 14px;box-shadow:var(--shadow-sm);">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
    <span style="font-size:18px;">üéØ</span>
    <span style="font-weight:700;font-size:14px;">ÊúÉÂì°ÈõÜÈªû</span>
    <span id="memberPoints" style="margin-left:auto;font-size:13px;color:var(--text-secondary);"></span>
  </div>
  <div style="display:flex;gap:8px;">
    <input type="tel" id="memberPhone" placeholder="ÊâãÊ©üËôüÁ¢ºÔºàÈõÜÈªûÁî®Ôºâ" maxlength="10" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px;">
    <button onclick="checkMemberPoints()" style="padding:8px 14px;border:none;border-radius:10px;background:var(--primary);color:#fff;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;">Êü•ÈªûÊï∏</button>
  </div>
  <div id="memberInfo" style="display:none;margin-top:8px;padding:8px;background:rgba(0,0,0,0.03);border-radius:8px;font-size:12px;color:var(--text-secondary);"></div>
</div>

<!-- ===== SEARCH BAR ===== -->
<div class="search-bar">
  <div class="search-input-wrap">
    <span class="icon">&#9740;</span>
    <input type="text" class="search-input" id="searchInput" placeholder="ÊêúÂ∞ãËèúÂìÅÂêçÁ®±...">
    <button class="search-clear" id="searchClear" onclick="clearSearch()">&#10005;</button>
  </div>
</div>

<!-- ===== MAIN LAYOUT ===== -->
<div class="menu-container" id="menuContainer">
  <nav class="category-sidebar" id="categorySidebar"></nav>
  <main class="menu-content" id="menuContent"></main>
</div>

<!-- ===== BOTTOM CART BAR ===== -->
<div class="cart-bar hidden" id="cartBar">
  <div class="cart-inner">
    <div class="cart-icon-wrap" onclick="toggleCartDrawer()">
      <div class="cart-icon">&#9635;</div>
      <span class="cart-count" id="cartCount">0</span>
    </div>
    <div class="cart-info">
      <div class="cart-items-text" id="cartItemsText">Â∑≤ÈÅ∏ 0 ‰ª∂</div>
      <div class="cart-total"><span class="currency">$</span><span id="cartTotal">0</span></div>
    </div>
    <button class="cart-submit" id="cartSubmit" onclick="submitOrder()">ÈÄÅÂá∫Ë®ÇÂñÆ &#8594;</button>
  </div>
</div>

<!-- ===== CART DRAWER ===== -->
<div class="cart-overlay" id="cartOverlay" onclick="toggleCartDrawer()"></div>
<div class="cart-drawer" id="cartDrawer">
  <div class="drawer-handle"></div>
  <div class="drawer-header">
    <h3>&#9635; Â∑≤ÈÅ∏ËèúÂìÅ</h3>
    <button class="drawer-clear" onclick="clearCart()">Ê∏ÖÁ©∫</button>
  </div>
  <div class="drawer-items" id="drawerItems"></div>
  <div class="drawer-footer">
    <div class="drawer-total-row">
      <span class="drawer-total-label">ÂêàË®à</span>
      <span class="drawer-total-price"><span class="currency">$</span><span id="drawerTotal">0</span></span>
    </div>
    <button class="drawer-submit" onclick="submitOrder()">ÈÄÅÂá∫Ë®ÇÂñÆÔºà<span id="drawerCount">0</span> ‰ª∂Ôºâ</button>
  </div>
</div>

<!-- ===== ITEM DETAIL MODAL ===== -->
<div class="item-modal-overlay" id="itemModalOverlay" onclick="closeItemModal(event)">
  <div class="item-modal" onclick="event.stopPropagation()">
    <img class="modal-img" id="modalImg" src="" alt="">
    <button class="modal-close" onclick="closeItemModal()">&#10005;</button>
    <div class="modal-body">
      <div class="modal-name" id="modalName"></div>
      <div class="modal-desc" id="modalDesc"></div>
      <div id="modalOptions"></div>
    </div>
    <div class="modal-footer">
      <div class="modal-price"><span class="currency">$</span><span id="modalPrice">0</span></div>
      <div class="modal-qty-area">
        <div class="qty-control">
          <button class="qty-btn minus" onclick="modalQtyChange(-1)">&#8722;</button>
          <span class="qty-num" id="modalQty">1</span>
          <button class="qty-btn" onclick="modalQtyChange(1)">+</button>
        </div>
      </div>
      <button class="modal-add-cart" onclick="modalAddToCart()">Âä†ÂÖ•Ë≥ºÁâ©Ëªä</button>
    </div>
  </div>
</div>

<script>
// ===== CONFIG =====
const SUPABASE_URL = 'https://nssuisyvlrqnqfxupklb.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3Vpc3l2bHJxbnFmeHVwa2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTAwMzUsImV4cCI6MjA4NDg2NjAzNX0.q_B6v3gf1TOCuAq7z0xIw10wDueCSJn0p37VzdMfmbc';

// ===== THEME SYSTEM =====
const THEMES = {
  // --- ÊöñËâ≤Á≥ª ---
  fire:    { name: 'ÁÜ±ÊÉÖÊ©òÁ¥Ö', group: 'warm', primary: '#E8430A', primaryLight: '#FF6B35', primaryDark: '#C23508', accent: '#FFB800', accentLight: '#FFD466', bg: '#F5F0EB', bgCard: '#FFFFFF', bgSidebar: '#FAFAFA', textPrimary: '#1A1A1A', textSecondary: '#666666', textMuted: '#999999', border: '#E8E8E8', borderLight: '#F0F0F0', headerGrad: 'linear-gradient(135deg,#E8430A 0%,#C23508 50%,#8B1A00 100%)' },
  rose:    { name: 'Áé´Áë∞ÂÖ∏ÈõÖ', group: 'warm', primary: '#E11D48', primaryLight: '#FB7185', primaryDark: '#BE123C', accent: '#F59E0B', accentLight: '#FCD34D', bg: '#FFF5F7', bgCard: '#FFF0F3', bgSidebar: '#FFF8FA', textPrimary: '#2E1A1E', textSecondary: '#7A5060', textMuted: '#B08090', border: '#F0D8DF', borderLight: '#F8E8EE', headerGrad: 'linear-gradient(135deg,#E11D48 0%,#9F1239 50%,#7F1D3A 100%)' },
  coral:   { name: 'ÁèäÁëöÁîúÊ©ô', group: 'warm', primary: '#F97066', primaryLight: '#FCA5A5', primaryDark: '#DC2626', accent: '#FBBF24', accentLight: '#FDE68A', bg: '#FFF7F5', bgCard: '#FFF3F0', bgSidebar: '#FFFAF9', textPrimary: '#1F1717', textSecondary: '#7A5A5A', textMuted: '#B09090', border: '#F0E0DD', borderLight: '#F8EEEC', headerGrad: 'linear-gradient(135deg,#F97066 0%,#E74C3C 50%,#C0392B 100%)' },
  amber:   { name: 'Áê•ÁèÄÈáëÈªÉ', group: 'warm', primary: '#D97706', primaryLight: '#F59E0B', primaryDark: '#B45309', accent: '#EF4444', accentLight: '#FCA5A5', bg: '#FFFBEB', bgCard: '#FFF8E0', bgSidebar: '#FFFDF5', textPrimary: '#1C1408', textSecondary: '#78600A', textMuted: '#A09060', border: '#F0E6C8', borderLight: '#F8F0DD', headerGrad: 'linear-gradient(135deg,#D97706 0%,#B45309 50%,#8B4000 100%)' },
  cherry:  { name: 'Ê´ªËä±Á≤âÂ´©', group: 'warm', primary: '#EC4899', primaryLight: '#F472B6', primaryDark: '#DB2777', accent: '#A855F7', accentLight: '#C084FC', bg: '#FDF2F8', bgCard: '#FFF0F6', bgSidebar: '#FFF5F9', textPrimary: '#2E1A28', textSecondary: '#8A5070', textMuted: '#C090A8', border: '#F5D0E0', borderLight: '#FAE8F0', headerGrad: 'linear-gradient(135deg,#EC4899 0%,#DB2777 40%,#BE185D 100%)' },
  // --- ÂÜ∑Ëâ≤Á≥ª ---
  indigo:  { name: 'ÈùõËóçÁ∂ìÂÖ∏', group: 'cool', primary: '#4F46E5', primaryLight: '#6366F1', primaryDark: '#3730A3', accent: '#F59E0B', accentLight: '#FCD34D', bg: '#F0F0FF', bgCard: '#EEEEFF', bgSidebar: '#F8F8FF', textPrimary: '#1A1A2E', textSecondary: '#5B5B7A', textMuted: '#9090A8', border: '#E0E0F0', borderLight: '#F0F0F8', headerGrad: 'linear-gradient(135deg,#4F46E5 0%,#3730A3 50%,#2E1E80 100%)' },
  ocean:   { name: 'Êµ∑Ê¥ãÊ∏ÖÊñ∞', group: 'cool', primary: '#0891B2', primaryLight: '#22D3EE', primaryDark: '#0E7490', accent: '#F59E0B', accentLight: '#FCD34D', bg: '#F0F9FF', bgCard: '#E8F4FA', bgSidebar: '#F5FBFF', textPrimary: '#1A2530', textSecondary: '#506A7A', textMuted: '#90B0C0', border: '#D0E8F0', borderLight: '#E8F4F8', headerGrad: 'linear-gradient(135deg,#0891B2 0%,#0E7490 40%,#164E63 100%)' },
  sky:     { name: 'Â§©Á©∫ËîöËóç', group: 'cool', primary: '#2563EB', primaryLight: '#3B82F6', primaryDark: '#1D4ED8', accent: '#F59E0B', accentLight: '#FCD34D', bg: '#F0F5FF', bgCard: '#E8F0FF', bgSidebar: '#F5F8FF', textPrimary: '#1A2040', textSecondary: '#506080', textMuted: '#90A0B8', border: '#D0DCF0', borderLight: '#E8EEF8', headerGrad: 'linear-gradient(135deg,#2563EB 0%,#1D4ED8 50%,#1E3A8A 100%)' },
  violet:  { name: 'Â§¢ÂπªÁ¥´ÁæÖ', group: 'cool', primary: '#7C3AED', primaryLight: '#A78BFA', primaryDark: '#6D28D9', accent: '#F472B6', accentLight: '#FBCFE8', bg: '#F5F0FF', bgCard: '#F0EAFF', bgSidebar: '#FAF5FF', textPrimary: '#1A1030', textSecondary: '#6A5080', textMuted: '#A090B8', border: '#E0D0F0', borderLight: '#F0E8F8', headerGrad: 'linear-gradient(135deg,#7C3AED 0%,#6D28D9 40%,#4C1D95 100%)' },
  teal:    { name: 'ÈùíÁ¢ßÈõÖËá¥', group: 'cool', primary: '#0D9488', primaryLight: '#14B8A6', primaryDark: '#0F766E', accent: '#F59E0B', accentLight: '#FCD34D', bg: '#F0FDFA', bgCard: '#E6FAF5', bgSidebar: '#F5FEFC', textPrimary: '#1A2E2A', textSecondary: '#4A706A', textMuted: '#80AAA0', border: '#C8E8E4', borderLight: '#E0F5F0', headerGrad: 'linear-gradient(135deg,#0D9488 0%,#0F766E 50%,#115E59 100%)' },
  // --- Ëá™ÁÑ∂Á≥ª ---
  forest:  { name: 'Ê£ÆÁ∂†Ëá™ÁÑ∂', group: 'nature', primary: '#059669', primaryLight: '#10B981', primaryDark: '#047857', accent: '#F59E0B', accentLight: '#FCD34D', bg: '#F0FAF4', bgCard: '#E8F5EE', bgSidebar: '#F5FBF8', textPrimary: '#1A2E1A', textSecondary: '#4A6A4A', textMuted: '#8AAA8A', border: '#D0E8D0', borderLight: '#E8F5E8', headerGrad: 'linear-gradient(135deg,#059669 0%,#047857 50%,#064E3B 100%)' },
  earth:   { name: 'Â§ßÂú∞Ê£ïË™ø', group: 'nature', primary: '#92400E', primaryLight: '#B45309', primaryDark: '#78350F', accent: '#059669', accentLight: '#34D399', bg: '#FAF5F0', bgCard: '#F5EDE4', bgSidebar: '#FBF8F5', textPrimary: '#1C1510', textSecondary: '#6A5A48', textMuted: '#A09080', border: '#E8DDD0', borderLight: '#F0EAE0', headerGrad: 'linear-gradient(135deg,#92400E 0%,#78350F 50%,#5C2A0A 100%)' },
  olive:   { name: 'Ê©ÑÊ¨ñÁî∞Âúí', group: 'nature', primary: '#65A30D', primaryLight: '#84CC16', primaryDark: '#4D7C0F', accent: '#EAB308', accentLight: '#FDE047', bg: '#F7FEE7', bgCard: '#F0FADB', bgSidebar: '#FBFFF0', textPrimary: '#1A2E10', textSecondary: '#4A6A30', textMuted: '#88AA68', border: '#D4E8B8', borderLight: '#E8F5D8', headerGrad: 'linear-gradient(135deg,#65A30D 0%,#4D7C0F 50%,#365314 100%)' },
  sand:    { name: 'Ê≤ôÊº†ÊöñÈôΩ', group: 'nature', primary: '#CA8A04', primaryLight: '#EAB308', primaryDark: '#A16207', accent: '#DC2626', accentLight: '#F87171', bg: '#FEFCE8', bgCard: '#FEF9C3', bgSidebar: '#FFFDE6', textPrimary: '#1C1A08', textSecondary: '#78720A', textMuted: '#A0980A', border: '#F0E8A0', borderLight: '#F8F0C8', headerGrad: 'linear-gradient(135deg,#CA8A04 0%,#A16207 50%,#854D0E 100%)' },
  // --- ÁâπËâ≤Á≥ª ---
  sunset:  { name: 'Â§ïÈôΩÊôöÈúû', group: 'special', primary: '#E44D26', primaryLight: '#F97316', primaryDark: '#C2410C', accent: '#A855F7', accentLight: '#C084FC', bg: '#FEF3EC', bgCard: '#FFEDE0', bgSidebar: '#FFF8F3', textPrimary: '#2A1510', textSecondary: '#7A5040', textMuted: '#B08878', border: '#F0D8C8', borderLight: '#F8EAE0', headerGrad: 'linear-gradient(135deg,#F97316 0%,#E44D26 30%,#9333EA 100%)' },
  candy:   { name: 'Á≥ñÊûúÁπΩÁ¥õ', group: 'special', primary: '#D946EF', primaryLight: '#E879F9', primaryDark: '#C026D3', accent: '#06B6D4', accentLight: '#67E8F9', bg: '#FDF4FF', bgCard: '#FAE8FF', bgSidebar: '#FEF5FF', textPrimary: '#2A1030', textSecondary: '#7A4890', textMuted: '#A878C0', border: '#E8D0F8', borderLight: '#F5E8FC', headerGrad: 'linear-gradient(135deg,#D946EF 0%,#C026D3 40%,#7C3AED 100%)' },
  matcha:  { name: 'ÊäπËå∂ÊãøÈêµ', group: 'special', primary: '#4D7C0F', primaryLight: '#65A30D', primaryDark: '#3F6212', accent: '#92400E', accentLight: '#B45309', bg: '#F5F5DC', bgCard: '#FAFAE0', bgSidebar: '#F8F8E0', textPrimary: '#1A1A10', textSecondary: '#5A5A30', textMuted: '#8A8A60', border: '#E0E0B8', borderLight: '#ECECD0', headerGrad: 'linear-gradient(135deg,#4D7C0F 0%,#3F6212 40%,#365314 100%)' },
  cafe:    { name: 'ÂíñÂï°ÊôÇÂÖâ', group: 'special', primary: '#78350F', primaryLight: '#92400E', primaryDark: '#5C2A0A', accent: '#D97706', accentLight: '#F59E0B', bg: '#FAF5F0', bgCard: '#F5EBE0', bgSidebar: '#FBF6F0', textPrimary: '#1A1210', textSecondary: '#6A5848', textMuted: '#9A8878', border: '#E0D4C4', borderLight: '#F0E8D8', headerGrad: 'linear-gradient(135deg,#78350F 0%,#5C2A0A 40%,#451A03 100%)' },
};

function applyTheme(name) {
  const t = THEMES[name];
  if (!t) return;
  const r = document.documentElement.style;
  r.setProperty('--primary', t.primary);
  r.setProperty('--primary-light', t.primaryLight);
  r.setProperty('--primary-dark', t.primaryDark);
  r.setProperty('--accent', t.accent);
  r.setProperty('--accent-light', t.accentLight);
  r.setProperty('--bg', t.bg);
  r.setProperty('--bg-card', t.bgCard);
  r.setProperty('--bg-sidebar', t.bgSidebar);
  r.setProperty('--text-primary', t.textPrimary);
  r.setProperty('--text-secondary', t.textSecondary);
  r.setProperty('--text-muted', t.textMuted);
  r.setProperty('--border', t.border);
  r.setProperty('--border-light', t.borderLight);
  // Header gradient
  if (t.headerGrad) {
    r.setProperty('--header-gradient', t.headerGrad);
  }
  // Menu cards use theme bg
  document.querySelectorAll('.menu-card, .featured-card').forEach(function(el) {
    el.style.background = t.bgCard;
    if (t.dark) el.style.borderColor = t.border;
  });
  document.querySelector('meta[name="theme-color"]')?.setAttribute('content', t.primary);
  currentTheme = name;
  try { localStorage.setItem('selectedTheme', name); } catch(e) {}
  // Update theme panel active state if open
  document.querySelectorAll('.theme-card').forEach(function(c) {
    c.classList.toggle('active', c.getAttribute('onclick')?.includes("'" + name + "'"));
  });
}

let currentTheme = 'fire';

function toggleThemePanel() {
  var overlay = document.getElementById('themeOverlay');
  if (!overlay.classList.contains('show')) renderThemePanel();
  overlay.classList.toggle('show');
}
function closeThemePanel() {
  document.getElementById('themeOverlay').classList.remove('show');
}

function renderThemePanel() {
  var groups = [
    { key: 'warm',    label: '\u{2600}\u{FE0F} \u6EAB\u6696\u7CFB' },
    { key: 'cool',    label: '\u{2744}\u{FE0F} \u6E05\u6DBC\u7CFB' },
    { key: 'nature',  label: '\u{1F33F} \u81EA\u7136\u7CFB' },
    { key: 'special', label: '\u{2728} \u7279\u8272\u7CFB' }
  ];
  var html = '<div class="theme-panel-handle"></div>' +
    '<h4>\u{1F3A8} \u9078\u64C7\u98A8\u683C</h4>' +
    '<div class="theme-panel-sub">\u9078\u64C7\u559C\u6B61\u7684\u914D\u8272\uFF0C\u81EA\u52D5\u5132\u5B58</div>';
  groups.forEach(function(g) {
    html += '<div style="font-size:12px;font-weight:700;color:var(--text-secondary);margin:12px 0 6px;padding-left:4px;">' + g.label + '</div><div class="theme-grid">';
    Object.entries(THEMES).forEach(function(entry) {
      var key = entry[0], t = entry[1];
      if (t.group !== g.key) return;
      var cardBg = t.dark ? t.bgCard : t.bg;
      var isDark = t.dark ? ' theme-card-dark' : '';
      html += '<div class="theme-card' + (key === currentTheme ? ' active' : '') + isDark + '" ' +
        'style="background:' + cardBg + ';" onclick="applyTheme(\'' + key + '\')">' +
        '<div style="height:28px;border-radius:8px;margin-bottom:8px;' + (t.headerGrad ? 'background:' + t.headerGrad : 'background:' + t.primary) + ';"></div>' +
        '<div class="theme-card-dots">' +
          '<div class="theme-card-dot" style="background:' + t.primary + ';"></div>' +
          '<div class="theme-card-dot" style="background:' + t.primaryLight + ';"></div>' +
          '<div class="theme-card-dot" style="background:' + t.accent + ';"></div>' +
        '</div>' +
        '<div class="theme-card-name">' + t.name + '</div></div>';
    });
    html += '</div>';
  });
  // È†êË¶ΩÊ®°ÂºèÊâçÈ°ØÁ§∫ÂÑ≤Â≠òÊåâÈàï
  if (!window._orderMode) {
    html += '<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);">' +
      '<button onclick="saveThemeToStore()" style="width:100%;padding:12px;border:none;border-radius:12px;background:var(--primary);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">üíæ ÂÑ≤Â≠òÁÇ∫ÂïÜÂ∫óÈ¢®Ê†º</button>' +
      '<div style="font-size:11px;color:var(--text-muted);text-align:center;margin-top:6px;">ÂÑ≤Â≠òÂæåÊâÄÊúâÊ∂àË≤ªËÄÖÈÉΩÊúÉÁúãÂà∞Ê≠§È¢®Ê†º</div></div>';
  }
  document.getElementById('themePanel').innerHTML = html;
}

// Apply store theme ‚Äî ÊîØÊè¥‰∏ªÈ°å keyÔºàÂ¶Ç "fire"ÔºâÊàñ hex Ëâ≤Á¢ºÔºàÂ¶Ç "#E8430A"Ôºâ
function applyStoreThemeColor(val) {
  // Ê∞∏ÈÅ†Â•óÁî® DB ÂÑ≤Â≠òÁöÑÈ¢®Ê†ºÔºåÁ¢∫‰øùÈ†êË¶ΩÂíåÊ∂àË≤ªËÄÖÁúãÂà∞‰∏ÄËá¥ÁöÑÁµêÊûú
  // Â¶ÇÊûúÂÄºÊòØ‰∏ªÈ°å keyÔºåÁõ¥Êé•Â•óÁî®
  if (THEMES[val]) { applyTheme(val); return; }
  // 3. Hex Ëâ≤Á¢ºÔºöÊâæÊúÄÊé•ËøëÁöÑÂÖßÂª∫‰∏ªÈ°å
  var bestKey = null, bestDist = Infinity;
  Object.entries(THEMES).forEach(function(entry) {
    var d = colorDistance(val, entry[1].primary);
    if (d < bestDist) { bestDist = d; bestKey = entry[0]; }
  });
  if (bestDist < 80) { applyTheme(bestKey); return; }
  // 4. ÁÑ°ÂåπÈÖçÔºöÁõ¥Êé•Â•óÁî®Ëâ≤Á¢º
  var r = document.documentElement.style;
  r.setProperty('--primary', val);
  r.setProperty('--primary-light', adjustBrightness(val, 30));
  r.setProperty('--primary-dark', adjustBrightness(val, -30));
}
function colorDistance(a, b) {
  var ra = parseInt(a.slice(1,3),16), ga = parseInt(a.slice(3,5),16), ba = parseInt(a.slice(5,7),16);
  var rb = parseInt(b.slice(1,3),16), gb = parseInt(b.slice(3,5),16), bb = parseInt(b.slice(5,7),16);
  return Math.sqrt((ra-rb)*(ra-rb)+(ga-gb)*(ga-gb)+(ba-bb)*(ba-bb));
}
function adjustBrightness(hex, amount) {
  var r = Math.max(0,Math.min(255,parseInt(hex.slice(1,3),16)+amount));
  var g = Math.max(0,Math.min(255,parseInt(hex.slice(3,5),16)+amount));
  var b = Math.max(0,Math.min(255,parseInt(hex.slice(5,7),16)+amount));
  return '#' + [r,g,b].map(function(c){return c.toString(16).padStart(2,'0');}).join('');
}

// Save theme to store (Supabase) ‚Äî Â≠ò‰∏ªÈ°å keyÔºåÁ¢∫‰øùÊâÄÊúâ‰∫∫ÁúãÂà∞ÂêåÊ®£È¢®Ê†º
async function saveThemeToStore() {
  var t = THEMES[currentTheme];
  if (!t || !currentStoreId) { showToast('ÁÑ°Ê≥ïÂÑ≤Â≠òÔºöÊú™ÈÄ£Êé•ÂïÜÂ∫ó'); return; }
  try {
    var res = await fetch(SUPABASE_URL + '/rest/v1/store_profiles?id=eq.' + currentStoreId, {
      method: 'PATCH',
      headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
      body: JSON.stringify({ theme_color: currentTheme })
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    showToast('‚úÖ È¢®Ê†ºÂ∑≤ÂÑ≤Â≠òÔºÅÊâÄÊúâÊ∂àË≤ªËÄÖÂ∞áÁúãÂà∞„Äå' + t.name + '„Äç');
    closeThemePanel();
  } catch(e) {
    showToast('‚ùå ÂÑ≤Â≠òÂ§±Êïó: ' + e.message);
  }
}

// Close theme panel on ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeThemePanel();
});

// ===== STATE =====
let currentStoreId = null;
let shopInfo = {};
let categories = [];
let menuItems = [];
let cart = [];
let activeCategory = null;
let modalItem = null;
let modalQtyVal = 1;
let modalSelectedSize = null;
let guestCount = 3;
let isScrollingByClick = false;
let loyaltyConfig = null;
let memberPointsData = null;

// ===== EMOJI ICONS (ES6 \u{} safe encoding) =====
const ICONS = {
  restaurant: '\u{1F37D}\u{FE0F}',  // üçΩÔ∏è
  search:     '\u{1F50D}',           // üîç
  phone:      '\u{1F4DE}',           // üìû
  pin:        '\u{1F4CD}',           // üìç
  clock:      '\u{1F550}',           // üïê
  fire:       '\u{1F525}',           // üî•
  cart:       '\u{1F6D2}',           // üõí
  trash:      '\u{1F5D1}',           // üóë
  bell:       '\u{1F514}',           // üîî
  chili:      '\u{1F336}\u{FE0F}',  // üå∂Ô∏è
  star:       '\u{2B50}',            // ‚≠ê
  noodle:     '\u{1F35C}',           // üçú
  salad:      '\u{1F957}',           // ü•ó
  curry:      '\u{1F35B}',           // üçõ
  chicken:    '\u{1F357}',           // üçó
  pig:        '\u{1F969}',           // ü•©
  beef:       '\u{1F404}',           // üêÑ
  fish:       '\u{1F41F}',           // üêü
  soup:       '\u{1F372}',           // üç≤
  leaf:       '\u{1F96C}',           // ü•¨
  rice:       '\u{1F35A}',           // üçö
  drink:      '\u{1F964}',           // ü•§
  empty:      '\u{1F371}',           // üç±
  check:      '\u{2705}',            // ‚úÖ
};

// ===== DEMO DATA (Êú¨Á±≥ Benmi ËèúÂñÆ) =====
const DEMO_CATEGORIES = [
  { id: 'bread',  name: 'È∫µÂåÖÂñÆÈªû', icon: '\u{1F956}', sort: 1 },
  { id: 'setL',   name: 'Â§ßÂ•óÈ§ê',   icon: '\u{1F371}', sort: 2 },
  { id: 'setM',   name: 'Â∞èÂ•óÈ§ê',   icon: '\u{1F371}', sort: 3 },
  { id: 'drink',  name: 'È£≤Êñô',     icon: '\u{1F964}', sort: 4 },
  { id: 'addon',  name: 'Âä†Êñô',     icon: '\u{2795}',  sort: 5 },
];

const DEMO_ITEMS = [
  // È∫µÂåÖÂñÆÈªû
  { id: 1, name: 'ÁáíËÇâÈ∫µÂåÖ', desc: 'Braised pork / Th·ªãt ngu·ªôi', price: 80, category: 'bread', image: '', tags: ['Êé®Ëñ¶'], featured: true, sizes: [{name:'Mini',price:56},{name:'L-SIZE',price:80}] },
  { id: 2, name: 'ÁÅ´ËÖøÈ∫µÂåÖ', desc: 'Ham / Ch·∫£', price: 80, category: 'bread', image: '', tags: [], sizes: [{name:'Mini',price:56},{name:'L-SIZE',price:80}] },
  { id: 3, name: 'ÈõûËÇâÈ∫µÂåÖ', desc: 'Chicken / Th·ªãt g√†', price: 100, category: 'bread', image: '', tags: [], sizes: [{name:'Mini',price:68},{name:'L-SIZE',price:100}] },
  { id: 4, name: 'ÁÉ§ËÇâÈ∫µÂåÖ', desc: 'Grilled Meat / Th·ªãt n∆∞·ªõng', price: 105, category: 'bread', image: '', tags: [], sizes: [{name:'Mini',price:72},{name:'L-SIZE',price:105}] },
  { id: 5, name: 'ÈõôÂ±§ÁÉ§ËÇâÈ∫µÂåÖ', desc: 'Double Cheesebanhmi / Th·ªãt n∆∞·ªõng ph√¥ mai', price: 115, category: 'bread', image: '', tags: ['Êé®Ëñ¶'], featured: true, sizes: [{name:'Mini',price:78},{name:'L-SIZE',price:115}] },
  { id: 6, name: 'Á∂úÂêàÈ∫µÂåÖ', desc: 'Mixed / Th·∫≠p c·∫©m', price: 130, category: 'bread', image: '', tags: [], sizes: [{name:'Mini',price:79},{name:'L-SIZE',price:130}] },
  // Â§ßÂ•óÈ§ê SET L-SIZE
  { id: 7,  name: 'Set 1 ÁáíËÇâ+È£≤Êñô', desc: 'L-SIZE ÁáíËÇâÈ∫µÂåÖ+È£≤Êñô', price: 90, category: 'setL', image: '', tags: ['Â•óÈ§ê'] },
  { id: 8,  name: 'Set 2 ÁÅ´ËÖø+È£≤Êñô', desc: 'L-SIZE ÁÅ´ËÖøÈ∫µÂåÖ+È£≤Êñô', price: 90, category: 'setL', image: '', tags: ['Â•óÈ§ê'] },
  { id: 9,  name: 'Set 3 ÈõûËÇâ+È£≤Êñô', desc: 'L-SIZE ÈõûËÇâÈ∫µÂåÖ+È£≤Êñô', price: 118, category: 'setL', image: '', tags: ['Â•óÈ§ê'] },
  { id: 10, name: 'Set 4 ÁÉ§ËÇâ+È£≤Êñô', desc: 'L-SIZE ÁÉ§ËÇâÈ∫µÂåÖ+È£≤Êñô', price: 128, category: 'setL', image: '', tags: ['Â•óÈ§ê'] },
  { id: 11, name: 'Set 5 ÈõôÂ±§ÁÉ§ËÇâ+È£≤Êñô', desc: 'L-SIZE ÈõôÂ±§ÁÉ§ËÇâÈ∫µÂåÖ+È£≤Êñô', price: 135, category: 'setL', image: '', tags: ['Â•óÈ§ê'] },
  { id: 12, name: 'Set 6 Á∂úÂêà+È£≤Êñô', desc: 'L-SIZE Á∂úÂêàÈ∫µÂåÖ+È£≤Êñô', price: 142, category: 'setL', image: '', tags: ['Â•óÈ§ê'] },
  // Â∞èÂ•óÈ§ê SET Mini
  { id: 13, name: 'Set 7 ÁáíËÇâ/ÁÅ´ËÖø+È£≤Êñô', desc: 'Mini ÁáíËÇâÊàñÁÅ´ËÖøÈ∫µÂåÖ+È£≤Êñô', price: 77, category: 'setM', image: '', tags: ['Â•óÈ§ê'] },
  { id: 14, name: 'Set 8 ÈõûËÇâ+È£≤Êñô', desc: 'Mini ÈõûËÇâÈ∫µÂåÖ+È£≤Êñô', price: 88, category: 'setM', image: '', tags: ['Â•óÈ§ê'] },
  { id: 15, name: 'Set 9 ÁÉ§ËÇâ+È£≤Êñô', desc: 'Mini ÁÉ§ËÇâÈ∫µÂåÖ+È£≤Êñô', price: 95, category: 'setM', image: '', tags: ['Â•óÈ§ê'] },
  { id: 16, name: 'Set 10 ÈõôÂ±§ÁÉ§ËÇâ+È£≤Êñô', desc: 'Mini ÈõôÂ±§ÁÉ§ËÇâÈ∫µÂåÖ+È£≤Êñô', price: 99, category: 'setM', image: '', tags: ['Â•óÈ§ê'] },
  { id: 17, name: 'Set 11 Á∂úÂêà+È£≤Êñô', desc: 'Mini Á∂úÂêàÈ∫µÂåÖ+È£≤Êñô', price: 100, category: 'setM', image: '', tags: ['Â•óÈ§ê'] },
  // È£≤Êñô
  { id: 18, name: 'Ë∂äÂçóÂíñÂï°', desc: 'C√† ph√™ s·ªØa / Coffee with Condensed Milk', price: 48, category: 'drink', image: '', tags: ['Êé®Ëñ¶'], featured: true },
  { id: 19, name: 'Ë±ÜÊºø', desc: 'S·ªØa ƒë·∫≠u n√†nh / Soy Milk', price: 37, category: 'drink', image: '', tags: [] },
  { id: 20, name: 'Á¥ÖËå∂', desc: 'H·ªìng tr√† / Black Tea', price: 37, category: 'drink', image: '', tags: [] },
  { id: 21, name: 'ÂèØÊ®Ç/Èõ™Á¢ß', desc: 'Cocacola / Sprite', price: 37, category: 'drink', image: '', tags: [] },
  // Âä†Êñô
  { id: 22, name: 'Âä†Ëµ∑Âè∏', desc: 'Cheese / Ph√¥ mai', price: 15, category: 'addon', image: '', tags: [] },
  { id: 23, name: 'Âä†ÁÅ´ËÖø', desc: 'Ham / Ch·∫£ l·ª•a', price: 20, category: 'addon', image: '', tags: [] },
  { id: 24, name: 'Âä†ÁáíËÇâ', desc: 'Braised Meat / Th·ªãt ngu·ªôi', price: 20, category: 'addon', image: '', tags: [] },
  { id: 25, name: 'Âä†ÁÉ§ËÇâ', desc: 'Grilled Meat / Th·ªãt n∆∞·ªõng', price: 25, category: 'addon', image: '', tags: [] },
  { id: 26, name: 'Âä†ÈõûËÇâ', desc: 'Chicken / Th·ªãt g√†', price: 25, category: 'addon', image: '', tags: [] },
];

// ===== INITIALIZE =====
document.addEventListener('DOMContentLoaded', () => { initApp(); });

async function initApp() {
  const params = new URLSearchParams(window.location.search);
  const storeSlug = params.get('store');

  // ÂÖàË®≠ÂÆöÊ®°ÂºèÔºåËÆì applyStoreThemeColor Áü•ÈÅìÊòØÂê¶ÁÇ∫Ê∂àË≤ªËÄÖÊ®°Âºè
  const mode = params.get('mode');   // 'dine-in' | 'takeout'
  const tbl = params.get('table');
  window._orderMode = mode || (tbl ? 'dine-in' : null);

  // Apply theme (URL param > localStorage > default) ‚Äî Âø´ÈÄüÈ°ØÁ§∫ÔºåÁ≠â DB ËºâÂÖ•ÂæåÂÜçË¶ÜËìã
  const urlTheme = params.get('theme');
  const savedTheme = localStorage.getItem('selectedTheme');
  applyTheme(urlTheme || savedTheme || 'fire');

  try {
    if (storeSlug) {
      await loadStoreFromSupabase(storeSlug);
    } else {
      loadDemoData();
    }
  } catch (e) {
    console.warn('Supabase load failed, using demo data:', e);
    loadDemoData();
  }

  renderSidebar();
  renderMenuContent();
  setupScrollSpy();
  setupSearch();
  setupGuestSelector();

  // Ê∂àË≤ªËÄÖÊ®°ÂºèÔºàÊúâ mode ÂèÉÊï∏ÔºâÈö±ËóèÈ¢®Ê†ºÈÅ∏ÊìáÊåâÈàïÔºõÈ†êË¶ΩÊ®°ÂºèÈ°ØÁ§∫
  if (mode) {
    document.getElementById('themeFab').style.display = 'none';
  }

  if (mode === 'takeout') {
    // Â§ñÂ∏∂ÔºöÈö±ËóèÊ°åËôü/‰∫∫Êï∏ÂçÄÂ°ä
    document.getElementById('tableSelector').style.display = 'none';
    // Â§ñÂ∏∂Ê®°ÂºèËèúÂñÆÂçÄÂüüÂä†È´òÔºàÊ°åËôüÂçÄÂ°äÈö±ËóèÂæåÁ©∫ÈñìÂõûÊî∂Ôºâ
    document.getElementById('menuContainer').style.height = 'calc(100dvh - 170px)';
    // È°ØÁ§∫Â§ñÂ∏∂Ê®ôÁ±§
    var badge = document.createElement('div');
    badge.style.cssText = 'text-align:center;padding:8px;margin:8px 16px;background:#FEF3C7;border-radius:10px;font-size:13px;font-weight:700;color:#B45309;';
    badge.textContent = '\u{1F6CD}\u{FE0F} Â§ñÂ∏∂ÈªûÈ§ê';
    document.getElementById('tableSelector').parentNode.insertBefore(badge, document.getElementById('tableSelector'));
  } else if (tbl) {
    // ÂÖßÁî®ÔºöËá™ÂãïÂ∏∂ÂÖ•Ê°åËôüÔºåÈéñÂÆö
    document.getElementById('tableNumber').value = tbl;
    document.getElementById('tableNumber').readOnly = true;
    document.getElementById('tableNumber').style.background = '#F1F5F9';
    // È°ØÁ§∫ÂÖßÁî®Ê®ôÁ±§
    var h3 = document.querySelector('#tableSelector h3');
    if (h3) h3.innerHTML = '\u{1F37D}\u{FE0F} ÂÖßÁî® \u2014 Ê°åËôü ' + tbl;
  }

  setTimeout(() => { document.getElementById('loadingScreen').classList.add('hide'); }, 600);
}

async function loadStoreFromSupabase(slug) {
  const headers = { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' };

  // 1. Êü•ÊâæÂïÜÂ∫ó
  const storeRes = await fetch(SUPABASE_URL + '/rest/v1/store_profiles?store_slug=eq.' + encodeURIComponent(slug) + '&limit=1', { headers });
  const storeData = await storeRes.json();
  if (!storeData || storeData.length === 0) throw new Error('Store not found: ' + slug);

  const store = storeData[0];
  currentStoreId = store.id;

  // Êõ¥Êñ∞ÂïÜÂ∫ó header
  shopInfo = {
    name: store.store_name || '',
    subtitle: store.description || '',
    address: store.address || '',
    phone: store.phone || '',
    hours: '',
    logo: store.logo_url || ''
  };
  // Ëß£ÊûêÁáüÊ•≠ÊôÇÈñì
  if (store.business_hours && typeof store.business_hours === 'object') {
    const bh = store.business_hours;
    const dayNames = { mon:'ÈÄ±‰∏Ä', tue:'ÈÄ±‰∫å', wed:'ÈÄ±‰∏â', thu:'ÈÄ±Âõõ', fri:'ÈÄ±‰∫î', sat:'ÈÄ±ÂÖ≠', sun:'ÈÄ±Êó•' };
    const parts = [];
    Object.keys(dayNames).forEach(function(d) {
      if (bh[d] && bh[d].open !== false && (bh[d].start || bh[d].close)) {
        var st = bh[d].start || bh[d].open || '';
        var en = bh[d].end || bh[d].close || '';
        if (st && en) parts.push(dayNames[d] + ' ' + st + '-' + en);
      }
    });
    if (parts.length > 0) shopInfo.hours = parts.join(' / ');
  }
  updateShopHeader(shopInfo);

  // ÂìÅÁâåÂΩ¢Ë±° DM
  renderBrandHero(store);

  // Â•óÁî®ÂïÜÂ∫ó‰∏ªÈ°åËâ≤
  if (store.theme_color) {
    applyStoreThemeColor(store.theme_color);
  }

  // ‰∏çÊé•ÂèóË®ÇÂñÆÊôÇÈ°ØÁ§∫ÊèêÁ§∫
  if (store.accept_orders === false) {
    document.getElementById('shopSubtitle').textContent = '\u{1F534} ÁõÆÂâçÊö´ÂÅúÊé•ÂñÆ';
  }

  // ÊúÉÂì°ÈõÜÈªûË®≠ÂÆö
  loyaltyConfig = store.loyalty_config || null;
  if (loyaltyConfig && loyaltyConfig.spend_per_point) {
    document.getElementById('memberSection').style.display = '';
    // Âæû localStorage ÂõûÂ°´ÊâãÊ©ü
    const savedPhone = localStorage.getItem('member_phone_' + currentStoreId);
    if (savedPhone) {
      document.getElementById('memberPhone').value = savedPhone;
      checkMemberPoints();
    }
  }

  // 2. ËºâÂÖ•ÂàÜÈ°û
  const catRes = await fetch(SUPABASE_URL + '/rest/v1/menu_categories?store_id=eq.' + currentStoreId + '&is_active=eq.true&order=sort_order', { headers });
  const catData = await catRes.json();

  // ÂæûÂàÜÈ°ûÂêçÁ®±ÊèêÂèñ emoji ‰ΩúÁÇ∫ iconÔºå‰∏¶ÈÅéÊøæÊôÇÊÆµ
  var nowHHMM = new Date().toTimeString().slice(0, 5); // "HH:MM"
  categories = (catData || []).filter(function(c) {
    // Ëã•ÁÑ°Ë®≠ÂÆöÊôÇÊÆµÔºåÂÖ®Â§©È°ØÁ§∫
    if (!c.time_periods || !Array.isArray(c.time_periods) || c.time_periods.length === 0) return true;
    // Ê™¢Êü•ÊòØÂê¶Âú®‰ªª‰∏ÄÊôÇÊÆµÂÖß
    return c.time_periods.some(function(p) { return nowHHMM >= p.from && nowHHMM <= p.to; });
  }).map(function(c) {
    var icon = ICONS.star;
    var name = c.name;
    var emojiMatch = name.match(/^([\u{1F000}-\u{1FFFF}][\u{FE00}-\u{FE0F}]?|[\u{2600}-\u{27BF}]|[\u{2B00}-\u{2BFF}]|[\u{E000}-\u{F8FF}]|[\u2702-\u27B0]|‚ûï)\s*/u);
    if (emojiMatch) {
      icon = emojiMatch[1];
      name = name.substring(emojiMatch[0].length);
    }
    return { id: c.id, name: name, icon: icon, sort: c.sort_order };
  });

  // 3. ËºâÂÖ•ÂìÅÈ†Ö
  const itemRes = await fetch(SUPABASE_URL + '/rest/v1/menu_items?store_id=eq.' + currentStoreId + '&is_available=eq.true&order=sort_order', { headers });
  const itemData = await itemRes.json();

  menuItems = (itemData || []).map(function(i) {
    // Â∞á options ‰∏≠ÁöÑ„ÄåÂ∞∫ÂØ∏„Äçgroup ËΩâÁÇ∫ sizes Ê†ºÂºè
    var sizes = null;
    var opts = i.options || [];
    if (Array.isArray(opts)) {
      for (var g = 0; g < opts.length; g++) {
        if (opts[g].group === 'Â∞∫ÂØ∏' && Array.isArray(opts[g].items)) {
          sizes = opts[g].items.map(function(s) { return { name: s.name, price: s.price }; });
        }
      }
    }
    // Âà§Êñ∑ÊòØÂê¶ÁÇ∫Êé®Ëñ¶
    var tags = i.tags || [];
    var featured = tags.indexOf('Êé®Ëñ¶') >= 0;

    return {
      id: i.id, name: i.name, desc: i.description || '',
      price: i.price, category: i.category_id,
      image: i.image_url || '', tags: tags,
      spicy: 0, featured: featured, sizes: sizes,
      options: opts  // ‰øùÁïôÂÆåÊï¥ options ‰æõ modal ‰ΩøÁî®
    };
  });
}

function loadDemoData() {
  categories = DEMO_CATEGORIES.map(function(c) { return Object.assign({}, c, { id: String(c.id) }); });
  menuItems = DEMO_ITEMS.map(function(i) { return Object.assign({}, i, { id: String(i.id), category: String(i.category) }); });
}

function updateShopHeader(shop) {
  if (shop.name) document.getElementById('shopName').textContent = shop.name;
  if (shop.subtitle) document.getElementById('shopSubtitle').textContent = shop.subtitle;
  if (shop.address) document.getElementById('shopAddress').textContent = shop.address;
  if (shop.phone) document.getElementById('shopPhone').textContent = shop.phone;
  if (shop.hours) document.getElementById('shopHours').textContent = shop.hours;
  if (shop.logo) {
    var logoEl = document.getElementById('shopLogo');
    logoEl.innerHTML = '<img src="' + shop.logo + '" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">';
  }
}

function renderBrandHero(store) {
  var hero = document.getElementById('brandHero');
  var hasBanner = store.banner_url && store.banner_url.trim();
  var hasLogo = store.logo_url && store.logo_url.trim();
  if (!hasBanner && !hasLogo) return;

  var img = document.getElementById('brandHeroImg');
  if (hasBanner) {
    img.src = store.banner_url;
    img.alt = store.store_name || '';
  } else if (hasLogo) {
    img.src = store.logo_url;
    img.alt = store.store_name || '';
    img.style.maxHeight = '180px';
    img.style.padding = '20px';
    img.style.margin = '0 auto';
  }
  hero.classList.add('show');

  // È°ØÁ§∫ÂàÜ‰∫´ÊåâÈàïÔºàÊîØÊè¥ Web Share API ÁöÑË£ùÁΩÆÔºâ
  if (navigator.share) {
    document.getElementById('shareBtn').style.display = 'inline-block';
  }
}

function shareOrder() {
  var name = document.getElementById('shopName').textContent;
  navigator.share({
    title: name + ' ‚Äî Á∑ö‰∏äÈªûÈ§ê',
    text: '‰∏ÄËµ∑‰æÜ ' + name + ' ÈªûÈ§êÂêßÔºÅ',
    url: window.location.href
  }).catch(function() {});
}

// ===== RENDER SIDEBAR =====
function renderSidebar() {
  const sidebar = document.getElementById('categorySidebar');
  sidebar.innerHTML = categories.map((cat, i) =>
    '<div class="cat-item ' + (i === 0 ? 'active' : '') + '" data-cat="' + cat.id + '" onclick="scrollToCategory(\'' + cat.id + '\')">' +
      '<span class="cat-icon">' + cat.icon + '</span>' +
      '<span class="cat-name">' + cat.name + '</span>' +
      '<span class="cat-badge" id="catBadge_' + cat.id + '">0</span>' +
    '</div>'
  ).join('');
  activeCategory = categories[0]?.id;
}

// ===== RENDER MENU CONTENT =====
function renderMenuContent(filter) {
  filter = filter || '';
  const content = document.getElementById('menuContent');
  let html = '';

  const featured = menuItems.filter(i => i.featured);
  if (featured.length > 0 && !filter) {
    html += '<div class="featured-section">' +
      '<div class="section-title"><span class="fire">' + ICONS.fire + '</span><h2>Êú¨Â∫óÂøÖÈªûÊé®Ëñ¶</h2><span class="subtitle">‰∫∫Ê∞£Á≤æÈÅ∏ &#8594;</span></div>' +
      '<div class="featured-scroll">' + featured.map(item => renderFeaturedCard(item)).join('') + '</div></div>';
  }

  categories.forEach(cat => {
    let items = menuItems.filter(i => i.category === cat.id);
    if (filter) { var q = filter.toLowerCase(); items = items.filter(i => i.name.toLowerCase().includes(q) || (i.desc && i.desc.toLowerCase().includes(q))); }
    if (items.length === 0 && filter) return;

    html += '<div class="category-section" id="catSection_' + cat.id + '" data-cat="' + cat.id + '">' +
      '<div class="category-header"><span class="cat-emoji">' + cat.icon + '</span><h3>' + cat.name + '</h3><span class="count">' + items.length + ' ÈÅì</span></div>' +
      (items.length === 0
        ? '<div class="empty-state"><div class="empty-icon">' + ICONS.empty + '</div><div class="empty-title">Âç≥Â∞áÊé®Âá∫</div><div class="empty-desc">Ê≠§È°ûÂà•Êö´ÁÑ°ËèúÂìÅ</div></div>'
        : items.map((item, idx) => renderMenuItem(item, idx)).join('')) +
    '</div>';
  });

  content.innerHTML = html;
  content.querySelectorAll('.menu-item').forEach((el, i) => { el.style.animationDelay = Math.min(i * 0.04, 0.4) + 's'; });
}

// ÂÆâÂÖ®ÂºïÁî® IDÔºàÊîØÊè¥ UUID Â≠ó‰∏≤ÂíåÊï∏Â≠óÔºâ
function qid(id) { return "'" + id + "'"; }

function renderFeaturedCard(item) {
  const imgSrc = item.image || generatePlaceholder(item.name);
  return '<div class="featured-card" onclick="openItemModal(' + qid(item.id) + ')">' +
    '<img class="featured-img" src="' + imgSrc + '" alt="' + item.name + '" onerror="this.src=\'' + generatePlaceholder(item.name) + '\'">' +
    '<span class="featured-badge">ÂøÖÈªû</span>' +
    '<div class="featured-info"><div class="featured-name">' + item.name + '</div>' +
    '<div class="featured-price"><span class="currency">$</span>' + item.price + '</div></div>' +
    '<button class="featured-add" onclick="event.stopPropagation(); addToCart(' + qid(item.id) + ', event)">+</button></div>';
}

function renderMenuItem(item) {
  const imgSrc = item.image || generatePlaceholder(item.name);
  const cartQty = getCartQty(item.id);
  const tagHtml = (item.tags || []).map(t => {
    const labels = { hot: 'ÁÜ±Èä∑', new: 'Êñ∞ÂìÅ', chef: '‰∏ªÂªöÊé®Ëñ¶', 'Êé®Ëñ¶': 'Êé®Ëñ¶', 'Â•óÈ§ê': 'Â•óÈ§ê' };
    return '<span class="item-tag ' + t + '">' + (labels[t] || t) + '</span>';
  }).join('');
  const spicyIcons = item.spicy > 0 ? ICONS.chili.repeat(Math.min(item.spicy, 3)) : '';
  let sizeHtml = '';
  if (item.sizes && item.sizes.length > 0) {
    sizeHtml = '<div class="item-sizes">' + item.sizes.map((s, i) =>
      '<span class="size-option ' + (i === item.sizes.length - 1 ? 'active' : '') + '" onclick="event.stopPropagation(); selectSize(' + qid(item.id) + ', ' + i + ')">' + s.name + ' $' + s.price + '</span>'
    ).join('') + '</div>';
  }
  return '<div class="menu-item" data-id="' + item.id + '" onclick="openItemModal(' + qid(item.id) + ')">' +
    '<div class="item-img-wrap"><img class="item-img" src="' + imgSrc + '" alt="' + item.name + '" loading="lazy" onerror="this.src=\'' + generatePlaceholder(item.name) + '\'">' +
    (spicyIcons ? '<span class="item-spicy">' + spicyIcons + '</span>' : '') + '</div>' +
    '<div class="item-info"><div class="item-name">' + item.name + '</div>' +
    '<div class="item-desc">' + (item.desc || '') + '</div>' +
    (tagHtml ? '<div class="item-tags">' + tagHtml + '</div>' : '') +
    '<div class="item-bottom"><div class="item-price-area">' +
    '<div class="item-price"><span class="currency">$</span>' + getItemDisplayPrice(item) + '</div>' + sizeHtml + '</div>' +
    '<div class="item-actions" onclick="event.stopPropagation()">' +
    (cartQty > 0
      ? '<div class="qty-control"><button class="qty-btn minus" onclick="changeQty(' + qid(item.id) + ', -1, event)">&#8722;</button><span class="qty-num">' + cartQty + '</span><button class="qty-btn" onclick="changeQty(' + qid(item.id) + ', 1, event)">+</button></div>'
      : '<button class="add-btn" onclick="addToCart(' + qid(item.id) + ', event)">+</button>') +
    '</div></div></div></div>';
}

function getItemDisplayPrice(item) {
  return (item.sizes && item.sizes.length > 0) ? item.sizes[item.sizes.length - 1].price : item.price;
}

function generatePlaceholder(name) {
  const colors = ['#FFE0B2','#FFCCBC','#C8E6C9','#B3E5FC','#F0F4C3','#D1C4E9','#FFCDD2','#B2DFDB'];
  const hash = name.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
  const bg = colors[hash % colors.length];
  const ch = name.charAt(0);
  return 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="' + bg + '" width="200" height="200"/><text x="100" y="115" font-size="56" text-anchor="middle" fill="#555">' + ch + '</text></svg>');
}

// ===== SCROLL SPY =====
function setupScrollSpy() {
  const content = document.getElementById('menuContent');
  content.addEventListener('scroll', function() {
    if (isScrollingByClick) return;
    const sections = content.querySelectorAll('.category-section');
    let current = null;
    sections.forEach(sec => {
      const rect = sec.getBoundingClientRect();
      const contentRect = content.getBoundingClientRect();
      if (rect.top <= contentRect.top + 80) current = sec.dataset.cat;
    });
    if (current && current !== activeCategory) setActiveCategory(current);
  }, { passive: true });
}

function scrollToCategory(catId) {
  const section = document.getElementById('catSection_' + catId);
  if (!section) return;
  isScrollingByClick = true;
  setActiveCategory(catId);
  const content = document.getElementById('menuContent');
  const contentRect = content.getBoundingClientRect();
  const sectionRect = section.getBoundingClientRect();
  content.scrollTo({ top: content.scrollTop + sectionRect.top - contentRect.top - 8, behavior: 'smooth' });
  setTimeout(function() { isScrollingByClick = false; }, 600);
}

function setActiveCategory(catId) {
  activeCategory = catId;
  document.querySelectorAll('.cat-item').forEach(el => { el.classList.toggle('active', el.dataset.cat === catId); });
  const activeEl = document.querySelector('.cat-item[data-cat="' + catId + '"]');
  if (activeEl) activeEl.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
}

// ===== SEARCH =====
function setupSearch() {
  const input = document.getElementById('searchInput');
  const clear = document.getElementById('searchClear');
  let timer;
  input.addEventListener('input', function() {
    clearTimeout(timer);
    clear.classList.toggle('show', input.value.length > 0);
    timer = setTimeout(function() { renderMenuContent(input.value.trim()); }, 200);
  });
}
function clearSearch() {
  const input = document.getElementById('searchInput');
  input.value = '';
  document.getElementById('searchClear').classList.remove('show');
  renderMenuContent();
  input.focus();
}

// ===== GUEST SELECTOR =====
function setupGuestSelector() {
  document.querySelectorAll('.guest-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.guest-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      guestCount = parseInt(btn.dataset.num);
    });
  });
}
function promptGuestCount() {
  const num = prompt('Ë´ãËº∏ÂÖ•Áî®È§ê‰∫∫Êï∏Ôºö', '7');
  if (num && parseInt(num) > 0) {
    guestCount = parseInt(num);
    document.querySelectorAll('.guest-btn').forEach(b => b.classList.remove('active'));
    showToast('Â∑≤ÈÅ∏Êìá ' + guestCount + ' ‰∫∫Áî®È§ê');
  }
}

// ===== CART LOGIC =====
function addToCart(itemId, event) {
  const item = menuItems.find(i => i.id === itemId);
  if (!item) return;
  const existing = cart.find(c => c.id === itemId && !c.sizeIdx);
  if (existing) { existing.qty += 1; }
  else {
    const price = item.sizes ? item.sizes[item.sizes.length - 1].price : item.price;
    const sizeName = item.sizes ? item.sizes[item.sizes.length - 1].name : null;
    cart.push({ id: itemId, qty: 1, price: price, sizeName: sizeName });
  }
  updateCartUI();
  animateAddToCart(event);
  refreshItemDisplay(itemId);
}

function changeQty(itemId, delta, event) {
  if (event) event.stopPropagation();
  const idx = cart.findIndex(c => c.id === itemId);
  if (idx === -1) return;
  cart[idx].qty += delta;
  if (cart[idx].qty <= 0) cart.splice(idx, 1);
  updateCartUI();
  refreshItemDisplay(itemId);
}
function changeCartIdx(idx, delta) {
  if (idx < 0 || idx >= cart.length) return;
  var itemId = cart[idx].id;
  cart[idx].qty += delta;
  if (cart[idx].qty <= 0) cart.splice(idx, 1);
  updateCartUI();
  refreshItemDisplay(itemId);
}

function getCartQty(itemId) {
  return cart.filter(c => c.id === itemId).reduce((sum, c) => sum + c.qty, 0);
}

function refreshItemDisplay(itemId) {
  const itemEl = document.querySelector('.menu-item[data-id="' + itemId + '"]');
  if (!itemEl) return;
  const item = menuItems.find(i => i.id === itemId);
  if (!item) return;
  const actionsEl = itemEl.querySelector('.item-actions');
  const cartQty = getCartQty(itemId);
  actionsEl.innerHTML = cartQty > 0
    ? '<div class="qty-control"><button class="qty-btn minus" onclick="changeQty(' + qid(itemId) + ', -1, event)">&#8722;</button><span class="qty-num">' + cartQty + '</span><button class="qty-btn" onclick="changeQty(' + qid(itemId) + ', 1, event)">+</button></div>'
    : '<button class="add-btn" onclick="addToCart(' + qid(itemId) + ', event)">+</button>';
}

function updateCartUI() {
  const totalQty = cart.reduce((s, c) => s + c.qty, 0);
  const totalPrice = cart.reduce((s, c) => s + c.price * c.qty, 0);
  document.getElementById('cartBar').classList.toggle('hidden', totalQty === 0);
  document.getElementById('cartCount').textContent = totalQty;
  document.getElementById('cartItemsText').textContent = 'Â∑≤ÈÅ∏ ' + totalQty + ' ‰ª∂';
  document.getElementById('cartTotal').textContent = totalPrice;
  document.getElementById('drawerTotal').textContent = totalPrice;
  document.getElementById('drawerCount').textContent = totalQty;

  categories.forEach(cat => {
    const badge = document.getElementById('catBadge_' + cat.id);
    if (!badge) return;
    const catQty = cart.filter(c => { const item = menuItems.find(i => i.id === c.id); return item && item.category === cat.id; }).reduce((s, c) => s + c.qty, 0);
    badge.textContent = catQty;
    badge.classList.toggle('show', catQty > 0);
  });
  renderDrawerItems();
}

function renderDrawerItems() {
  const container = document.getElementById('drawerItems');
  if (cart.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">' + ICONS.cart + '</div><div class="empty-title">Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ</div><div class="empty-desc">Âø´ÂéªÈÅ∏ÂπæÈÅìÂ•ΩËèúÂêßÔºÅ</div></div>';
    return;
  }
  container.innerHTML = cart.map(function(c, idx) {
    const item = menuItems.find(i => i.id === c.id);
    if (!item) return '';
    const imgSrc = item.image || generatePlaceholder(item.name);
    return '<div class="drawer-item">' +
      '<img class="drawer-item-img" src="' + imgSrc + '" alt="' + item.name + '" onerror="this.src=\'' + generatePlaceholder(item.name) + '\'">' +
      '<div class="drawer-item-info"><div class="drawer-item-name">' + item.name + '</div>' +
      (c.optKey ? '<div class="drawer-item-size">' + c.optKey + '</div>' : '') +
      '<div class="drawer-item-price"><span class="currency">$</span>' + (c.price * c.qty) + '</div></div>' +
      '<div class="drawer-item-qty"><button class="drawer-qty-btn" onclick="changeCartIdx(' + idx + ', -1)">&#8722;</button>' +
      '<span class="drawer-qty-num">' + c.qty + '</span>' +
      '<button class="drawer-qty-btn" onclick="changeCartIdx(' + idx + ', 1)">+</button></div></div>';
  }).join('');
}

function clearCart() {
  if (!confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫Ë≥ºÁâ©ËªäÂóéÔºü')) return;
  const ids = cart.map(c => c.id);
  cart = [];
  updateCartUI();
  ids.forEach(id => refreshItemDisplay(id));
  toggleCartDrawer();
  showToast('Ë≥ºÁâ©ËªäÂ∑≤Ê∏ÖÁ©∫');
}

function toggleCartDrawer() {
  const overlay = document.getElementById('cartOverlay');
  const drawer = document.getElementById('cartDrawer');
  const isOpen = drawer.classList.contains('show');
  if (isOpen) { overlay.classList.remove('show'); drawer.classList.remove('show'); }
  else { renderDrawerItems(); overlay.classList.add('show'); drawer.classList.add('show'); }
}

// ===== ITEM DETAIL MODAL =====
function openItemModal(itemId) {
  const item = menuItems.find(i => i.id === itemId);
  if (!item) return;
  modalItem = item;
  modalQtyVal = 1;
  modalSelectedSize = item.sizes ? item.sizes.length - 1 : null;
  const imgSrc = item.image || generatePlaceholder(item.name);
  document.getElementById('modalImg').src = imgSrc;
  document.getElementById('modalImg').onerror = function() { this.src = generatePlaceholder(item.name); };
  document.getElementById('modalName').textContent = item.name;
  document.getElementById('modalDesc').textContent = item.desc || 'Êö´ÁÑ°ÊèèËø∞';
  document.getElementById('modalQty').textContent = modalQtyVal;
  let optHtml = '';
  if (item.sizes && item.sizes.length > 0) {
    optHtml += '<div class="modal-option-group"><div class="modal-option-title">‰ªΩÈáè <span class="required">ÂøÖÈÅ∏</span></div><div class="modal-options">' +
      item.sizes.map((s, i) => '<button class="modal-opt-btn ' + (i === modalSelectedSize ? 'active' : '') + '" onclick="selectModalSize(' + i + ')">' + s.name + ' - $' + s.price + '</button>').join('') +
    '</div></div>';
  }
  // È°ØÁ§∫ÈùûÂ∞∫ÂØ∏ÁöÑ optionsÔºàÂ¶ÇÈ£≤ÊñôÈÅ∏Êìá„ÄÅÂèØÊ®Ç/Èõ™Á¢ßÔºâ
  if (item.options && Array.isArray(item.options)) {
    item.options.forEach(function(grp, gi) {
      if (grp.group === 'Â∞∫ÂØ∏') return; // Â∑≤ËôïÁêÜÁÇ∫ sizes
      var reqHtml = grp.required ? ' <span class="required">ÂøÖÈÅ∏</span>' : '';
      optHtml += '<div class="modal-option-group" data-optgrp="' + gi + '"><div class="modal-option-title">' + grp.group + reqHtml + '</div><div class="modal-options">' +
        (grp.items || []).map(function(opt, oi) {
          return '<button class="modal-opt-btn' + (oi === 0 ? ' active' : '') + '" onclick="selectOption(this, ' + gi + ', ' + oi + ')">' + opt.name + (opt.price ? ' +$' + opt.price : '') + '</button>';
        }).join('') +
      '</div></div>';
    });
  }
  if (item.spicy > 0) {
    optHtml += '<div class="modal-option-group"><div class="modal-option-title">Ëæ£Â∫¶</div><div class="modal-options">' +
      '<button class="modal-opt-btn" onclick="selectSpicy(this, 0)">‰∏çËæ£</button>' +
      '<button class="modal-opt-btn active" onclick="selectSpicy(this, 1)">Â∞èËæ£</button>' +
      '<button class="modal-opt-btn" onclick="selectSpicy(this, 2)">‰∏≠Ëæ£</button>' +
      '<button class="modal-opt-btn" onclick="selectSpicy(this, 3)">Â§ßËæ£</button></div></div>';
  }
  document.getElementById('modalOptions').innerHTML = optHtml;
  updateModalPrice();
  document.getElementById('itemModalOverlay').classList.add('show');
}

function closeItemModal(event) {
  if (event && event.target !== document.getElementById('itemModalOverlay') && !event.target.classList.contains('modal-close')) return;
  document.getElementById('itemModalOverlay').classList.remove('show');
  modalItem = null;
}

function selectModalSize(idx) {
  modalSelectedSize = idx;
  document.querySelectorAll('#modalOptions .modal-option-group:first-child .modal-opt-btn').forEach((btn, i) => { btn.classList.toggle('active', i === idx); });
  updateModalPrice();
}

function selectSpicy(btn, level) {
  btn.closest('.modal-options').querySelectorAll('.modal-opt-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function selectOption(btn, grpIdx, optIdx) {
  btn.closest('.modal-options').querySelectorAll('.modal-opt-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function updateModalPrice() {
  if (!modalItem) return;
  let price = modalItem.price;
  if (modalItem.sizes && modalSelectedSize !== null) price = modalItem.sizes[modalSelectedSize].price;
  document.getElementById('modalPrice').textContent = price * modalQtyVal;
}

function modalQtyChange(delta) {
  modalQtyVal = Math.max(1, modalQtyVal + delta);
  document.getElementById('modalQty').textContent = modalQtyVal;
  updateModalPrice();
}

function modalAddToCart() {
  if (!modalItem) return;
  let price = modalItem.price;
  let sizeName = null;
  if (modalItem.sizes && modalSelectedSize !== null) {
    price = modalItem.sizes[modalSelectedSize].price;
    sizeName = modalItem.sizes[modalSelectedSize].name;
  }
  // Êî∂ÈõÜÈÅ∏ÊìáÁöÑ options
  var selectedOpts = [];
  document.querySelectorAll('#modalOptions [data-optgrp]').forEach(function(grpEl) {
    var activeBtn = grpEl.querySelector('.modal-opt-btn.active');
    if (activeBtn) selectedOpts.push(activeBtn.textContent.trim());
  });
  var optKey = sizeName ? sizeName : '';
  if (selectedOpts.length > 0) optKey += (optKey ? '/' : '') + selectedOpts.join('/');

  const existing = cart.find(c => c.id === modalItem.id && c.sizeName === sizeName && c.optKey === optKey);
  if (existing) { existing.qty += modalQtyVal; }
  else { cart.push({ id: modalItem.id, qty: modalQtyVal, price: price, sizeName: sizeName, optKey: optKey, selectedOpts: selectedOpts }); }
  updateCartUI();
  refreshItemDisplay(modalItem.id);
  closeItemModal({ target: document.getElementById('itemModalOverlay') });
  showToast('Â∑≤Âä†ÂÖ• ' + modalItem.name + ' x ' + modalQtyVal);
}

function selectSize(itemId, sizeIdx) {
  const itemEl = document.querySelector('.menu-item[data-id="' + itemId + '"]');
  if (!itemEl) return;
  itemEl.querySelectorAll('.size-option').forEach((el, i) => { el.classList.toggle('active', i === sizeIdx); });
}

function animateAddToCart(event) {
  if (!event) return;
  const btn = event.target || event.currentTarget;
  const rect = btn.getBoundingClientRect();
  const cartIcon = document.querySelector('.cart-icon-wrap');
  if (!cartIcon) return;
  const cartRect = cartIcon.getBoundingClientRect();
  const dot = document.createElement('div');
  dot.className = 'fly-dot';
  dot.style.left = (rect.left + rect.width / 2 - 7) + 'px';
  dot.style.top = (rect.top + rect.height / 2 - 7) + 'px';
  document.body.appendChild(dot);
  requestAnimationFrame(function() {
    dot.style.left = (cartRect.left + cartRect.width / 2 - 7) + 'px';
    dot.style.top = (cartRect.top + cartRect.height / 2 - 7) + 'px';
    dot.style.transform = 'scale(0.3)';
    dot.style.opacity = '0.5';
  });
  setTimeout(function() { dot.remove(); }, 600);
}

// ===== SUBMIT ORDER =====
function submitOrder() {
  if (cart.length === 0) { showToast('Ë´ãÂÖàÈÅ∏ÊìáËèúÂìÅ'); return; }
  const isTakeout = window._orderMode === 'takeout';
  const tableNum = isTakeout ? 'Â§ñÂ∏∂' : document.getElementById('tableNumber').value.trim();
  if (!isTakeout && !tableNum) { showToast('Ë´ãËº∏ÂÖ•Ê°åËôü'); document.getElementById('tableNumber').focus(); return; }
  const totalQty = cart.reduce((s, c) => s + c.qty, 0);
  const totalPrice = cart.reduce((s, c) => s + c.price * c.qty, 0);

  // ÁµÑÂêàÁ¢∫Ë™çÊ∏ÖÂñÆ HTML
  var listHtml = '';
  cart.forEach(function(c) {
    var item = menuItems.find(function(i) { return i.id === c.id; });
    var name = item ? item.name : 'Unknown';
    var detail = '';
    if (c.sizeName) detail += c.sizeName;
    if (c.selectedOpts && c.selectedOpts.length > 0) {
      var optNames = c.selectedOpts.map(function(o) { return typeof o === 'string' ? o : (o.name || ''); }).filter(Boolean).join(', ');
      detail += (detail ? ' / ' : '') + optNames;
    }
    listHtml += '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #F0F0F0;">' +
      '<div style="flex:1;min-width:0;">' +
        '<div style="font-weight:700;font-size:15px;color:#1A1A2E;">' + name + '</div>' +
        (detail ? '<div style="font-size:12px;color:#888;margin-top:2px;">' + detail + '</div>' : '') +
      '</div>' +
      '<div style="text-align:right;white-space:nowrap;margin-left:12px;">' +
        '<span style="font-size:13px;color:#666;">x' + c.qty + '</span>' +
        '<div style="font-weight:800;font-size:15px;color:var(--primary);">$' + (c.price * c.qty) + '</div>' +
      '</div></div>';
  });

  var overlay = document.getElementById('itemModalOverlay');
  overlay.innerHTML = '<div class="item-modal" onclick="event.stopPropagation()" style="padding:24px 20px;max-height:85vh;overflow-y:auto;">' +
    '<h2 style="text-align:center;font-size:20px;font-weight:800;margin:0 0 4px;">Á¢∫Ë™çË®ÇÂñÆ</h2>' +
    '<div style="text-align:center;font-size:13px;color:#888;margin-bottom:16px;">' +
      (isTakeout ? 'Â§ñÂ∏∂ÈªûÈ§ê' : 'ÂÖßÁî® ‚Äî Ê°åËôü ' + tableNum + '„Éª' + guestCount + ' ‰∫∫') +
    '</div>' +
    '<div style="margin-bottom:16px;">' + listHtml + '</div>' +
    '<div style="display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-top:2px solid #E5E5E5;">' +
      '<span style="font-size:15px;font-weight:700;">ÂêàË®à (' + totalQty + ' ‰ª∂)</span>' +
      '<span style="font-size:22px;font-weight:900;color:var(--primary);">$' + totalPrice + '</span>' +
    '</div>' +
    '<div style="display:flex;gap:10px;margin-top:16px;">' +
      '<button onclick="closeConfirmOrder()" style="flex:1;padding:14px;border:2px solid #DDD;border-radius:12px;background:#FFF;font-size:15px;font-weight:700;color:#666;cursor:pointer;">ËøîÂõû‰øÆÊîπ</button>' +
      '<button onclick="confirmAndSubmitOrder()" id="confirmSubmitBtn" style="flex:2;padding:14px;border:none;border-radius:12px;background:var(--primary);color:#FFF;font-size:15px;font-weight:700;cursor:pointer;">Á¢∫Ë™çÈÄÅÂá∫</button>' +
    '</div>' +
  '</div>';
  overlay.classList.add('show');
}

function closeConfirmOrder() {
  document.getElementById('itemModalOverlay').classList.remove('show');
}

async function confirmAndSubmitOrder() {
  var btn = document.getElementById('confirmSubmitBtn');
  btn.disabled = true;
  btn.textContent = 'ÈÄÅÂá∫‰∏≠...';

  const isTakeout = window._orderMode === 'takeout';
  const tableNum = isTakeout ? 'Â§ñÂ∏∂' : document.getElementById('tableNumber').value.trim();
  const totalQty = cart.reduce((s, c) => s + c.qty, 0);
  const totalPrice = cart.reduce((s, c) => s + c.price * c.qty, 0);
  const orderItems = cart.map(c => {
    const item = menuItems.find(i => i.id === c.id);
    return { item_id: c.id, name: item ? item.name : 'Unknown', size: c.sizeName || null, options: c.selectedOpts || [], qty: c.qty, unit_price: c.price, subtotal: c.price * c.qty };
  });

  var orderNum = '';
  const memberPhone = document.getElementById('memberPhone')?.value?.trim() || '';
  const order = {
    store_id: currentStoreId,
    table_number: tableNum,
    items: orderItems,
    total: totalPrice,
    status: 'pending',
    order_type: isTakeout ? 'takeout' : 'dine_in',
    customer_phone: memberPhone || null,
    notes: isTakeout ? '' : 'Áî®È§ê‰∫∫Êï∏: ' + guestCount
  };
  try {
    if (currentStoreId) {
      const res = await fetch(SUPABASE_URL + '/rest/v1/orders', {
        method: 'POST', headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
        body: JSON.stringify(order)
      });
      if (!res.ok) {
        const errText = await res.text();
        console.error('Order API error:', res.status, errText, JSON.stringify(order));
        showToast('Ë®ÇÂñÆÈÄÅÂá∫Â§±Êïó: ' + res.status + ' ' + (errText || '').substring(0, 80));
        btn.disabled = false;
        btn.textContent = 'Á¢∫Ë™çÈÄÅÂá∫';
        return;
      }
      const resData = await res.json();
      if (resData && resData[0] && resData[0].order_number) orderNum = resData[0].order_number;
    }
  } catch (e) {
    console.error('Order submit error:', e);
    showToast('Ë®ÇÂñÆÈÄÅÂá∫Â§±Êïó: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'Á¢∫Ë™çÈÄÅÂá∫';
    return;
  }
  // ÊúÉÂì°ÈõÜÈªû
  let earnedPts = 0;
  if (loyaltyConfig) {
    earnedPts = await awardLoyaltyPoints(totalPrice) || 0;
  }
  showOrderSuccess(totalQty, totalPrice, tableNum, orderNum, earnedPts);
}

function showOrderSuccess(qty, price, table, orderNum, earnedPts) {
  const isTakeout = table === 'Â§ñÂ∏∂';
  const pointsHtml = earnedPts > 0 ? '<div style="background:#FEF3C7;border-radius:10px;padding:8px 16px;margin-bottom:16px;display:inline-block;font-size:13px;color:#92400E;">üéØ Êú¨Ê¨°Áç≤Âæó <b>' + earnedPts + '</b> Èªû</div>' : '';
  const overlay = document.getElementById('itemModalOverlay');
  overlay.innerHTML = '<div class="item-modal" onclick="event.stopPropagation()" style="text-align:center; padding: 40px 20px;">' +
    '<div style="font-size:64px; margin-bottom:16px; color:#4CAF50;">&#10003;</div>' +
    '<h2 style="font-size:22px; font-weight:800; margin-bottom:8px;">Ë®ÇÂñÆÂ∑≤ÈÄÅÂá∫ÔºÅ</h2>' +
    (orderNum ? '<div style="background:#F0FDF4;border:2px solid #86EFAC;border-radius:12px;padding:12px 20px;margin-bottom:16px;display:inline-block;"><div style="font-size:11px;color:#16A34A;margin-bottom:2px;">' + (isTakeout ? 'ÂèñÈ§êËôüÁ¢º' : 'Ë®ÇÂñÆËôüÁ¢º') + '</div><div style="font-size:36px;font-weight:900;color:#15803D;letter-spacing:4px;">' + orderNum + '</div></div>' : '') +
    '<p style="color:#666; font-size:14px; margin-bottom:20px;">' + (isTakeout ? 'Â§ñÂ∏∂' : 'Ê°åËôü ' + table) + '&#12288;' + qty + ' ÈÅìËèúÂìÅ&#12288;ÂêàË®à $' + price + '</p>' +
    pointsHtml +
    '<p style="color:#999; font-size:12px; margin-bottom:24px;">' + (isTakeout ? 'Ë´ãËá≥Ê´ÉÊ™ØÁ≠âÂÄôÂè´ËôüÂèñÈ§ê' : 'ÂªöÊàøÊ≠£Âú®Ê∫ñÂÇôÊÇ®ÁöÑÈ§êÈªûÔºåË´ãÁ®çÂÄô') + '</p>' +
    '<button onclick="resetOrder()" style="background: var(--primary); color: white; border: none; padding: 14px 40px; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; font-family: inherit;">ÁπºÁ∫åÈªûÈ§ê</button></div>';
  overlay.classList.add('show');
  document.getElementById('cartOverlay').classList.remove('show');
  document.getElementById('cartDrawer').classList.remove('show');
}

function resetOrder() {
  cart = [];
  updateCartUI();
  renderMenuContent();
  document.getElementById('itemModalOverlay').classList.remove('show');
  setTimeout(function() {
    document.getElementById('itemModalOverlay').innerHTML =
      '<div class="item-modal" onclick="event.stopPropagation()">' +
      '<img class="modal-img" id="modalImg" src="" alt="">' +
      '<button class="modal-close" onclick="closeItemModal()">&#10005;</button>' +
      '<div class="modal-body"><div class="modal-name" id="modalName"></div><div class="modal-desc" id="modalDesc"></div><div id="modalOptions"></div></div>' +
      '<div class="modal-footer"><div class="modal-price"><span class="currency">$</span><span id="modalPrice">0</span></div>' +
      '<div class="modal-qty-area"><div class="qty-control"><button class="qty-btn minus" onclick="modalQtyChange(-1)">&#8722;</button><span class="qty-num" id="modalQty">1</span><button class="qty-btn" onclick="modalQtyChange(1)">+</button></div></div>' +
      '<button class="modal-add-cart" onclick="modalAddToCart()">Âä†ÂÖ•Ë≥ºÁâ©Ëªä</button></div></div>';
  }, 400);
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(function() { toast.classList.remove('show'); }, 2000);
}

// ===== ÊúÉÂì°ÈõÜÈªû =====
async function checkMemberPoints() {
  const phone = document.getElementById('memberPhone').value.trim();
  if (!phone || phone.length < 9) { showToast('Ë´ãËº∏ÂÖ•Ê≠£Á¢∫ÊâãÊ©üËôüÁ¢º'); return; }
  localStorage.setItem('member_phone_' + currentStoreId, phone);
  try {
    const res = await fetch(SUPABASE_URL + '/rest/v1/loyalty_points?store_id=eq.' + currentStoreId + '&customer_line_id=eq.' + encodeURIComponent(phone) + '&limit=1', {
      headers: { 'apikey': SUPABASE_KEY }
    });
    const data = await res.json();
    const info = document.getElementById('memberInfo');
    if (data && data.length > 0) {
      memberPointsData = data[0];
      const pts = memberPointsData.points || 0;
      const cfg = loyaltyConfig || {};
      const needed = cfg.points_per_reward || 10;
      const discount = cfg.reward_discount || 50;
      document.getElementById('memberPoints').textContent = 'üéØ ' + pts + ' Èªû';
      info.style.display = '';
      if (pts >= needed) {
        info.innerHTML = 'üéâ ÊÇ®Êúâ <b>' + pts + '</b> ÈªûÔºåÂèØÂÖåÊèõ <b>$' + discount + '</b> ÊäòÊâ£ÔºÅ<br><span style="font-size:11px;color:#94A3B8;">‰∏ãÊ¨°ÁµêÂ∏≥ÊôÇËá™ÂãïÊäòÊäµ</span>';
      } else {
        info.innerHTML = 'ÁõÆÂâç <b>' + pts + '</b> ÈªûÔºåÂÜçÈõÜ <b>' + (needed - pts) + '</b> ÈªûÂèØÂÖåÊèõ $' + discount + ' ÊäòÊâ£';
      }
    } else {
      memberPointsData = null;
      document.getElementById('memberPoints').textContent = 'Êñ∞ÊúÉÂì°';
      info.style.display = '';
      info.innerHTML = 'Ê≠°ËøéÂä†ÂÖ•ÔºÅÊ∂àË≤ªÂç≥ÂèØÈñãÂßãÈõÜÈªû';
    }
  } catch(e) { console.warn('Check points error:', e); }
}

async function awardLoyaltyPoints(orderTotal) {
  const phone = document.getElementById('memberPhone')?.value?.trim();
  if (!phone || phone.length < 9 || !loyaltyConfig) return;
  const spendPer = loyaltyConfig.spend_per_point || 50;
  const earnedPoints = Math.floor(orderTotal / spendPer);
  if (earnedPoints <= 0) return;
  try {
    if (memberPointsData) {
      // Update existing
      await fetch(SUPABASE_URL + '/rest/v1/loyalty_points?id=eq.' + memberPointsData.id, {
        method: 'PATCH',
        headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
        body: JSON.stringify({
          points: (memberPointsData.points || 0) + earnedPoints,
          total_earned: (memberPointsData.total_earned || 0) + earnedPoints,
          updated_at: new Date().toISOString()
        })
      });
    } else {
      // Insert new
      await fetch(SUPABASE_URL + '/rest/v1/loyalty_points', {
        method: 'POST',
        headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
        body: JSON.stringify({
          store_id: currentStoreId,
          customer_line_id: phone,
          points: earnedPoints,
          total_earned: earnedPoints
        })
      });
    }
    return earnedPoints;
  } catch(e) { console.warn('Award points error:', e); return 0; }
}
</script>
</body>
</html>
