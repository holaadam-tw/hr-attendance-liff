<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4F46E5">
    <title>ç·šä¸Šé»é¤</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
    <style>
        :root { --theme: #4F46E5; --theme-dark: #3730A3; --theme-light: #EEF2FF; }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; background:#f5f5f5; color:#1a1a2e; min-height:100vh; padding-bottom:90px; }

        /* ===== Loading & Error ===== */
        .loading-view { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; gap:16px; }
        .loading-spinner { width:40px; height:40px; border:3px solid #e0e0e0; border-top-color:var(--theme); border-radius:50%; animation:spin 0.8s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }
        .error-view { display:none; text-align:center; padding:80px 24px; }

        /* ===== Store Banner ===== */
        .store-banner { position:relative; height:200px; background:linear-gradient(135deg, var(--theme), var(--theme-dark)); overflow:hidden; }
        .store-banner img { width:100%; height:100%; object-fit:cover; }
        .store-banner .overlay { position:absolute; bottom:0; left:0; right:0; padding:20px 16px 16px; background:linear-gradient(transparent, rgba(0,0,0,0.7)); color:#fff; }
        .store-banner .store-logo { width:52px; height:52px; border-radius:12px; border:2px solid #fff; object-fit:cover; margin-bottom:8px; background:#fff; }
        .store-banner h1 { font-size:22px; font-weight:800; margin-bottom:2px; text-shadow:0 1px 3px rgba(0,0,0,0.3); }
        .store-banner .store-meta { font-size:13px; opacity:0.9; }

        /* ===== Status Bars ===== */
        .closed-banner { background:#FEE2E2; color:#DC2626; text-align:center; padding:12px 16px; font-weight:700; font-size:14px; }
        .hours-bar { background:#fff; color:#6B7280; padding:10px 16px; font-size:12px; border-bottom:1px solid #f0f0f0; display:flex; align-items:center; gap:6px; overflow-x:auto; white-space:nowrap; }
        .loyalty-bar { background:var(--theme-light); padding:10px 16px; display:flex; justify-content:space-between; align-items:center; font-size:13px; font-weight:500; }

        /* ===== Search ===== */
        .search-bar { padding:12px 16px; background:#fff; border-bottom:1px solid #f0f0f0; position:sticky; top:0; z-index:50; }
        .search-input { width:100%; padding:10px 16px 10px 40px; border:none; border-radius:24px; background:#f5f5f5; font-size:14px; outline:none; }
        .search-bar .icon { position:absolute; left:28px; top:50%; transform:translateY(-50%); color:#9CA3AF; font-size:18px; }

        /* ===== Category Nav ===== */
        .category-nav { position:sticky; top:0; z-index:40; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,0.06); overflow-x:auto; white-space:nowrap; scrollbar-width:none; -webkit-overflow-scrolling:touch; transition:top 0.2s; }
        .category-nav::-webkit-scrollbar { display:none; }
        .category-nav .tabs { display:flex; padding:0 12px; }
        .cat-tab { padding:14px 16px; font-size:14px; font-weight:600; color:#9CA3AF; cursor:pointer; position:relative; transition:color 0.2s; flex-shrink:0; }
        .cat-tab.active { color:var(--theme); }
        .cat-tab.active::after { content:''; position:absolute; bottom:0; left:12px; right:12px; height:3px; background:var(--theme); border-radius:3px 3px 0 0; }

        /* ===== Menu Sections ===== */
        .menu-container { padding:8px 0; }
        .menu-section { background:#fff; margin-bottom:8px; padding:16px; }
        .section-title { font-size:18px; font-weight:800; margin-bottom:16px; color:#1a1a2e; }
        .menu-item { display:flex; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px solid #f5f5f5; cursor:pointer; }
        .menu-item:last-child { border-bottom:none; }
        .item-info { flex:1; min-width:0; display:flex; flex-direction:column; justify-content:center; }
        .item-name { font-size:15px; font-weight:700; margin-bottom:3px; display:flex; align-items:center; gap:6px; }
        .item-desc { font-size:13px; color:#6B7280; margin-bottom:6px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
        .item-price { font-size:16px; font-weight:800; color:var(--theme); }
        .item-photo { width:100px; height:100px; border-radius:12px; overflow:hidden; position:relative; flex-shrink:0; }
        .item-photo img { width:100%; height:100%; object-fit:cover; }
        .item-photo .no-img { width:100%; height:100%; background:#f0f0f0; display:flex; align-items:center; justify-content:center; font-size:32px; }
        .item-photo .add-btn { position:absolute; bottom:-1px; right:-1px; width:32px; height:32px; border-radius:50%; border:none; background:var(--theme); color:#fff; font-size:22px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(0,0,0,0.15); line-height:1; }
        .tag { font-size:10px; padding:2px 8px; border-radius:4px; font-weight:600; display:inline-block; }
        .tag-combo { background:#FEF3C7; color:#D97706; }
        .tag-sold { background:#FEE2E2; color:#DC2626; }
        .item-unavailable { opacity:0.45; pointer-events:none; }

        /* ===== Floating Cart Bar ===== */
        .floating-cart { position:fixed; bottom:20px; left:16px; right:16px; max-width:500px; margin:0 auto; background:#1a1a2e; color:#fff; border-radius:50px; padding:12px 12px 12px 20px; display:none; align-items:center; justify-content:space-between; box-shadow:0 8px 30px rgba(0,0,0,0.25); z-index:100; animation:slideUp 0.3s ease; }
        @keyframes slideUp { from { transform:translateY(100px); opacity:0; } to { transform:translateY(0); opacity:1; } }
        .floating-cart .cart-info { display:flex; align-items:center; gap:10px; }
        .floating-cart .cart-total-price { font-size:16px; font-weight:700; }
        .floating-cart .checkout-btn { background:var(--theme); color:#fff; border:none; border-radius:50px; padding:12px 24px; font-size:14px; font-weight:700; cursor:pointer; }

        /* ===== Modal (Bottom Sheet) ===== */
        .modal-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:200; }
        .modal-overlay.open { display:flex; align-items:flex-end; justify-content:center; }
        body.modal-open { overflow:hidden; position:fixed; width:100%; }
        .modal-sheet { background:#fff; border-radius:20px 20px 0 0; width:100%; max-width:500px; max-height:90vh; overflow-y:auto; padding:0; transform:translateY(0); animation:sheetUp 0.3s ease; }
        @keyframes sheetUp { from { transform:translateY(100%); } to { transform:translateY(0); } }
        .sheet-header { display:flex; justify-content:space-between; align-items:center; padding:20px 20px 12px; position:sticky; top:0; background:#fff; z-index:1; border-bottom:1px solid #f5f5f5; }
        .sheet-header h2 { font-size:18px; font-weight:800; margin:0; }
        .sheet-close { background:none; border:none; width:32px; height:32px; border-radius:50%; background:#f5f5f5; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#6B7280; }
        .sheet-body { padding:16px 20px; }
        .sheet-footer { padding:16px 20px 24px; border-top:1px solid #f0f0f0; background:#fff; position:sticky; bottom:0; }

        /* ===== Option Groups ===== */
        .opt-group { margin-bottom:20px; }
        .opt-group-title { font-size:15px; font-weight:700; margin-bottom:8px; display:flex; align-items:center; gap:6px; }
        .opt-group-req { font-size:11px; color:#fff; background:#EF4444; padding:1px 8px; border-radius:10px; }
        .opt-choice { display:flex; align-items:center; gap:10px; padding:12px 0; border-bottom:1px solid #f8f8f8; cursor:pointer; }
        .opt-choice input[type="radio"], .opt-choice input[type="checkbox"] { width:20px; height:20px; accent-color:var(--theme); flex-shrink:0; }
        .opt-choice-label { flex:1; font-size:15px; }
        .opt-choice-price { font-size:14px; color:#6B7280; font-weight:500; }

        /* ===== Cart Items ===== */
        .cart-item { display:flex; align-items:center; gap:12px; padding:14px 0; border-bottom:1px solid #f5f5f5; }
        .ci-info { flex:1; }
        .ci-name { font-weight:700; font-size:15px; }
        .ci-opts { font-size:12px; color:#9CA3AF; margin-top:2px; }
        .ci-price { font-weight:800; color:var(--theme); font-size:15px; min-width:60px; text-align:right; }
        .qty-ctrl { display:flex; align-items:center; gap:6px; }
        .qty-btn { width:30px; height:30px; border-radius:50%; border:1.5px solid #e0e0e0; background:#fff; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#1a1a2e; font-weight:600; transition:all 0.15s; }
        .qty-btn:active { transform:scale(0.9); }
        .cart-badge { background:#EF4444; width:24px; height:24px; border-radius:50%; font-size:12px; font-weight:700; display:flex; align-items:center; justify-content:center; transition:transform 0.2s; }
        .cart-badge.bounce { animation:badgeBounce 0.3s ease; }
        @keyframes badgeBounce { 0% { transform:scale(1); } 50% { transform:scale(1.4); } 100% { transform:scale(1); } }
        .qty-num { font-weight:800; font-size:15px; min-width:24px; text-align:center; }
        .cart-total-row { display:flex; justify-content:space-between; padding:16px 0 8px; font-size:18px; font-weight:800; border-top:2px solid #1a1a2e; margin-top:8px; }

        /* ===== Form ===== */
        .form-section { padding:16px 0; }
        .form-section-title { font-size:15px; font-weight:700; margin-bottom:12px; color:#1a1a2e; }
        .form-group { margin-bottom:14px; }
        .form-group label { display:block; font-size:13px; font-weight:600; color:#374151; margin-bottom:5px; }
        .form-group input, .form-group select, .form-group textarea { width:100%; padding:12px 14px; border:1.5px solid #e0e0e0; border-radius:12px; font-size:15px; box-sizing:border-box; outline:none; transition:border-color 0.2s; background:#fff; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color:var(--theme); }

        .submit-btn { width:100%; padding:16px; border:none; border-radius:14px; font-size:16px; font-weight:800; color:#fff; background:var(--theme); cursor:pointer; transition:opacity 0.2s; }
        .submit-btn:active { opacity:0.85; }
        .submit-btn:disabled { opacity:0.4; cursor:not-allowed; }

        .subtotal-bar { display:flex; justify-content:space-between; align-items:center; padding:12px 0; font-size:17px; font-weight:800; color:var(--theme); }

        /* ===== Order Confirmation ===== */
        .confirm-view { display:none; min-height:100vh; background:#fff; }
        .confirm-hero { background:linear-gradient(135deg, var(--theme), var(--theme-dark)); color:#fff; padding:40px 24px; text-align:center; }
        .confirm-hero .check { font-size:56px; margin-bottom:8px; }
        .confirm-hero .pickup-num { font-size:48px; font-weight:900; margin:8px 0; letter-spacing:2px; }
        .confirm-hero .order-num { font-size:14px; opacity:0.8; }
        .confirm-body { padding:20px 16px; }
        .confirm-card { background:#f9fafb; border-radius:16px; padding:16px; margin-bottom:12px; }
        .confirm-card h4 { font-size:14px; color:#6B7280; margin-bottom:8px; }

        /* ===== Toast ===== */
        .toast { position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:#1a1a2e; color:#fff; padding:12px 28px; border-radius:50px; font-size:14px; font-weight:600; z-index:9999; opacity:0; transition:opacity 0.3s; pointer-events:none; white-space:nowrap; }
        .toast.show { opacity:1; }
    </style>
</head>
<body>
    <!-- Loading -->
    <div id="loadingView" class="loading-view">
        <div class="loading-spinner"></div>
        <p style="color:#9CA3AF;font-size:14px;">è¼‰å…¥èœå–®ä¸­...</p>
    </div>

    <!-- Error -->
    <div id="errorView" class="error-view">
        <div style="font-size:64px;margin-bottom:16px;">ğŸ½ï¸</div>
        <h2 style="font-size:20px;font-weight:800;margin-bottom:8px;">æ‰¾ä¸åˆ°å•†åº—</h2>
        <p style="color:#9CA3AF;font-size:14px;">è«‹ç¢ºèª QR Code æˆ–ç¶²å€æ˜¯å¦æ­£ç¢º</p>
    </div>

    <!-- Main View -->
    <div id="mainView" style="display:none;">
        <!-- Store Banner -->
        <div class="store-banner" id="storeBanner">
            <div class="overlay">
                <img id="storeLogo" class="store-logo" src="" style="display:none;">
                <h1 id="storeName"></h1>
                <div class="store-meta" id="storeMeta"></div>
            </div>
        </div>

        <!-- Status Bars -->
        <div id="loyaltyBar" class="loyalty-bar" style="display:none;"></div>
        <div id="closedBanner" class="closed-banner" style="display:none;"></div>
        <div id="hoursBar" class="hours-bar" style="display:none;"></div>

        <!-- Search -->
        <div class="search-bar" id="searchBar" style="display:none;">
            <span class="icon">ğŸ”</span>
            <input class="search-input" id="searchInput" type="text" placeholder="æœå°‹é¤é»..." oninput="handleSearch(this.value)">
        </div>

        <!-- Category Nav -->
        <div class="category-nav" id="categoryNav" style="display:none;">
            <div class="tabs" id="categoryTabs"></div>
        </div>

        <!-- Menu Sections -->
        <div class="menu-container" id="menuContainer"></div>
    </div>

    <!-- Floating Cart Bar -->
    <div class="floating-cart" id="floatingCart" onclick="openCart()">
        <div class="cart-info">
            <div class="cart-badge" id="cartBadge">0</div>
            <div class="cart-total-price" id="cartTotalPrice">$0</div>
        </div>
        <button class="checkout-btn" id="checkoutBtn">å»çµå¸³ â†’</button>
    </div>

    <!-- Options Modal -->
    <div class="modal-overlay" id="optionsModal" onclick="if(event.target===this)closeOptionsModal()">
        <div class="modal-sheet">
            <div class="sheet-header">
                <h2 id="optItemName"></h2>
                <button class="sheet-close" onclick="closeOptionsModal()">âœ•</button>
            </div>
            <div class="sheet-body" id="optGroupsContainer"></div>
            <div class="sheet-footer">
                <div class="subtotal-bar">å°è¨ˆ <span id="optSubtotal">$0</span></div>
                <div class="qty-selector" style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:12px;">
                    <button class="qty-btn" onclick="adjustModalQty(-1)" style="width:36px;height:36px;">âˆ’</button>
                    <span id="optQty" style="font-size:18px;font-weight:800;min-width:32px;text-align:center;">1</span>
                    <button class="qty-btn" onclick="adjustModalQty(1)" style="width:36px;height:36px;">+</button>
                </div>
                <button class="submit-btn" onclick="confirmAddToCart()">åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
        </div>
    </div>

    <!-- Combo Modal -->
    <div class="modal-overlay" id="comboModal" onclick="if(event.target===this)closeComboModal()">
        <div class="modal-sheet">
            <div class="sheet-header">
                <h2 id="comboItemName"></h2>
                <button class="sheet-close" onclick="closeComboModal()">âœ•</button>
            </div>
            <div class="sheet-body" id="comboGroupsContainer"></div>
            <div class="sheet-footer">
                <div class="subtotal-bar">å¥—é¤åƒ¹ <span id="comboSubtotal">$0</span></div>
                <button class="submit-btn" onclick="confirmAddCombo()">åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div class="modal-overlay" id="cartModal" onclick="if(event.target===this)closeCart()">
        <div class="modal-sheet">
            <div class="sheet-header">
                <h2>è³¼ç‰©è»Š</h2>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button onclick="clearCart()" style="border:none;background:none;color:#EF4444;font-size:13px;font-weight:600;cursor:pointer;padding:4px 8px;">æ¸…ç©º</button>
                    <button class="sheet-close" onclick="closeCart()">âœ•</button>
                </div>
            </div>
            <div class="sheet-body">
                <div id="cartItems"></div>
                <div class="cart-total-row"><span>åˆè¨ˆ</span><span id="cartTotal">$0</span></div>
                <div class="form-section">
                    <div class="form-section-title">å–é¤è³‡è¨Š</div>
                    <div class="form-group">
                        <label>å§“å *</label>
                        <input type="text" id="custName" placeholder="è«‹è¼¸å…¥å§“å">
                    </div>
                    <div class="form-group">
                        <label>é›»è©±</label>
                        <input type="tel" id="custPhone" placeholder="é¸å¡«ï¼Œæ–¹ä¾¿åº—å®¶è¯ç¹«">
                    </div>
                    <div style="display:flex;gap:10px;">
                        <div class="form-group" style="flex:1;">
                            <label>ç”¨é¤æ–¹å¼</label>
                            <select id="orderType" onchange="toggleTableNumber()">
                                <option value="dine_in">å…§ç”¨</option>
                                <option value="takeout">å¤–å¸¶</option>
                            </select>
                        </div>
                        <div class="form-group" id="tableNumberGroup" style="flex:1;">
                            <label>æ¡Œè™Ÿ</label>
                            <input type="text" id="tableNumber" placeholder="å…§ç”¨å¡«å¯«">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å–é¤æ™‚é–“</label>
                        <select id="pickupTime">
                            <option value="">ç›¡å¿«</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨»</label>
                        <textarea id="orderNotes" rows="2" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚è«‹å¡«å¯«"></textarea>
                    </div>
                </div>
            </div>
            <div class="sheet-footer">
                <button class="submit-btn" id="submitOrderBtn" onclick="submitOrder()">é€å‡ºè¨‚å–®</button>
            </div>
        </div>
    </div>

    <!-- Order Confirmation -->
    <div id="orderConfirmView" class="confirm-view">
        <div class="confirm-hero">
            <div class="check">âœ…</div>
            <p style="font-size:15px;opacity:0.9;">è¨‚å–®å·²é€å‡ºï¼</p>
            <div class="pickup-num" id="confirmPickup"></div>
            <div class="order-num" id="confirmOrderNo"></div>
        </div>
        <div class="confirm-body">
            <div style="text-align:center;margin-bottom:16px;">
                <span style="display:inline-block;padding:6px 20px;border-radius:20px;background:#ECFDF5;color:#059669;font-weight:700;font-size:13px;">ç­‰å¾…ç¢ºèª</span>
            </div>
            <div id="confirmDetail"></div>
            <button onclick="resetOrder()" style="width:100%;margin-top:16px;padding:16px;border:1.5px solid #e0e0e0;border-radius:14px;background:#fff;font-size:15px;font-weight:700;cursor:pointer;">ç¹¼çºŒé»é¤</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const SUPABASE_URL = 'https://nssuisyvlrqnqfxupklb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3Vpc3l2bHJxbnFmeHVwa2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTAwMzUsImV4cCI6MjA4NDg2NjAzNX0.q_B6v3gf1TOCuAq7z0xIw10wDueCSJn0p37VzdMfmbc';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const LIFF_ID = '2008962829-bnsS1bbB';

        let store = null;
        let categories = [];
        let menuItems = [];
        let cart = [];
        let lineUserId = null;
        let lineDisplayName = '';
        let customerLoyalty = null;
        let pendingItem = null;
        let pendingComboItem = null;
        let isStoreClosed = false;
        let searchQuery = '';

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2200);
        }
        function escapeHTML(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

        // Fix #11: Modal èƒŒæ™¯æ»¾å‹•é–å®š
        let scrollY = 0;
        function lockScroll() { scrollY = window.scrollY; document.body.classList.add('modal-open'); document.body.style.top = '-' + scrollY + 'px'; }
        function unlockScroll() { document.body.classList.remove('modal-open'); document.body.style.top = ''; window.scrollTo(0, scrollY); }

        // Fix #3: è³¼ç‰©è»Šä¾å•†åº—åˆ†é–‹
        function getCartKey() { return store ? '_cart_' + store.id : '_cart'; }
        function saveCart() { localStorage.setItem(getCartKey(), JSON.stringify(cart.map(c => ({ itemId: c.item.id, qty: c.qty, optionsLabel: c.optionsLabel, optionsPrice: c.optionsPrice, selectedOptions: c.selectedOptions })))); }
        function restoreCart() {
            const saved = JSON.parse(localStorage.getItem(getCartKey()) || '[]');
            cart = [];
            saved.forEach(s => {
                const item = menuItems.find(i => i.id === s.itemId);
                if (item) cart.push({ item, qty: s.qty, optionsLabel: s.optionsLabel || '', optionsPrice: s.optionsPrice || 0, selectedOptions: s.selectedOptions || null });
            });
            updateCartUI();
        }

        // ===== Init =====
        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const p = await liff.getProfile();
                    lineUserId = p.userId;
                    // Fix #10: è‡ªå‹•å¸¶å…¥ LINE é¡¯ç¤ºåç¨±
                    lineDisplayName = p.displayName || '';
                }
            } catch(e) { console.log('LIFF init skipped', e); }

            const params = new URLSearchParams(location.search);
            const slug = params.get('store');
            const sid = params.get('sid');
            try {
                let q = sb.from('store_profiles').select('*').eq('is_active', true);
                if (slug) q = q.eq('store_slug', slug);
                else if (sid) q = q.eq('id', sid);
                else throw new Error('no store param');
                const { data, error } = await q.maybeSingle();
                if (error) throw error;
                if (!data) throw new Error('store not found');

                store = data;
                applyTheme(store.theme_color);
                renderStoreBanner();
                checkStoreAvailability();
                await loadMenu();
                restoreCart();
                populatePickupTimes();
                // Fix #10: è‡ªå‹•å¸¶å…¥åç¨±
                if (lineDisplayName) {
                    const nameEl = document.getElementById('custName');
                    if (nameEl && !nameEl.value) nameEl.value = lineDisplayName;
                }
                if (lineUserId) loadLoyalty();
                document.getElementById('loadingView').style.display = 'none';
                document.getElementById('mainView').style.display = 'block';
            } catch(e) {
                console.error(e);
                document.getElementById('loadingView').style.display = 'none';
                document.getElementById('errorView').style.display = 'block';
            }
        }

        function applyTheme(color) {
            if (!color) return;
            document.documentElement.style.setProperty('--theme', color);
            document.querySelector('meta[name="theme-color"]').content = color;
            const r = parseInt(color.slice(1,3),16), g = parseInt(color.slice(3,5),16), b = parseInt(color.slice(5,7),16);
            document.documentElement.style.setProperty('--theme-dark', '#' + [r,g,b].map(c => Math.max(0,c-40).toString(16).padStart(2,'0')).join(''));
            document.documentElement.style.setProperty('--theme-light', '#' + [r,g,b].map(c => Math.min(255,c+60).toString(16).padStart(2,'0')).join('') + '22');
        }

        function renderStoreBanner() {
            const banner = document.getElementById('storeBanner');
            if (store.banner_url) {
                banner.innerHTML = `<img src="${store.banner_url}" alt=""><div class="overlay">${bannerContent()}</div>`;
            } else {
                banner.innerHTML = `<div class="overlay" style="background:linear-gradient(135deg, var(--theme), var(--theme-dark));height:100%;display:flex;flex-direction:column;justify-content:flex-end;">${bannerContent()}</div>`;
            }
            document.title = store.store_name + ' - ç·šä¸Šé»é¤';
        }
        function bannerContent() {
            const logo = store.logo_url ? `<img class="store-logo" src="${store.logo_url}">` : '';
            const meta = [];
            if (store.description) meta.push(escapeHTML(store.description));
            if (store.phone) meta.push('ğŸ“ ' + escapeHTML(store.phone));
            if (store.address) meta.push('ğŸ“ ' + escapeHTML(store.address));
            return `${logo}<h1 id="storeName">${escapeHTML(store.store_name)}</h1><div class="store-meta">${meta.join(' Â· ')}</div>`;
        }

        // ===== Availability =====
        function checkStoreAvailability() {
            const banner = document.getElementById('closedBanner');
            const hoursEl = document.getElementById('hoursBar');
            if (store.accept_orders === false) {
                banner.textContent = 'â¸ï¸ æœ¬åº—æš«åœæ¥å–®'; banner.style.display = ''; isStoreClosed = true; return;
            }
            const bh = store.business_hours;
            if (bh && typeof bh === 'object') {
                const dayKeys = ['sun','mon','tue','wed','thu','fri','sat'];
                const now = new Date();
                const todayKey = dayKeys[now.getDay()];
                const todayHours = bh[todayKey];
                if (todayHours && !todayHours.open) {
                    banner.textContent = 'ğŸ• ä»Šæ—¥ä¼‘æ¯ï¼Œç„¡æ³•é»é¤'; banner.style.display = ''; isStoreClosed = true;
                } else if (todayHours && todayHours.start && todayHours.end) {
                    const nowMin = now.getHours()*60+now.getMinutes();
                    const [sh,sm] = todayHours.start.split(':').map(Number);
                    const [eh,em] = todayHours.end.split(':').map(Number);
                    if (nowMin < sh*60+sm || nowMin > eh*60+em) {
                        banner.textContent = `ğŸ• ç›®å‰éç‡Ÿæ¥­æ™‚é–“ï¼ˆ${todayHours.start} ~ ${todayHours.end}ï¼‰`;
                        banner.style.display = ''; isStoreClosed = true;
                    }
                }
                const dayLabels = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                const parts = dayKeys.map((k,idx) => { const h = bh[k]; return !h || !h.open ? `<span style="opacity:0.5;">${dayLabels[idx]}ä¼‘</span>` : `<span>${dayLabels[idx]} ${h.start}-${h.end}</span>`; });
                hoursEl.innerHTML = 'ğŸ• ' + parts.join('&nbsp;&nbsp;');
                hoursEl.style.display = '';
            }
        }

        // ===== Loyalty =====
        async function loadLoyalty() {
            if (!lineUserId || !store.loyalty_config) return;
            try {
                const { data } = await sb.from('loyalty_points').select('*').eq('store_id', store.id).eq('customer_line_id', lineUserId).maybeSingle();
                customerLoyalty = data;
                renderLoyaltyBar();
            } catch(e) { console.log('loyalty load failed', e); }
        }
        function renderLoyaltyBar() {
            const el = document.getElementById('loyaltyBar');
            const lc = store.loyalty_config; if (!lc) return;
            const pts = customerLoyalty?.points || 0;
            const canRedeem = pts >= (lc.points_to_redeem || 999999);
            el.style.display = '';
            el.innerHTML = `<span>ğŸ¯ æˆ‘çš„é»æ•¸ï¼š<b>${pts}</b> é»</span>` + (canRedeem ? `<span style="color:#059669;font-weight:700;">å¯æŠ˜æŠµ $${lc.discount_amount}</span>` : `<span style="color:#6B7280;">å† ${(lc.points_to_redeem||10)-pts} é»å¯æŠ˜ $${lc.discount_amount||50}</span>`);
        }

        // ===== Menu =====
        async function loadMenu() {
            const { data: cats } = await sb.from('menu_categories').select('*').eq('store_id', store.id).eq('is_active', true).order('sort_order');
            categories = cats || [];
            const { data: items } = await sb.from('menu_items').select('*').eq('store_id', store.id).order('sort_order');
            menuItems = items || [];
            if (menuItems.length > 3) document.getElementById('searchBar').style.display = '';
            renderCategoryNav();
            renderMenuSections();
            // Fix #4: å‹•æ…‹è¨ˆç®—é»æ€§åç§»
            fixStickyOffsets();
            initScrollSpy();
        }

        function renderCategoryNav() {
            if (categories.length === 0) return;
            const nav = document.getElementById('categoryNav');
            nav.style.display = '';
            const tabs = document.getElementById('categoryTabs');
            tabs.innerHTML = `<div class="cat-tab active" data-cat="all" onclick="scrollToSection('all', this)">å…¨éƒ¨</div>` +
                categories.map(c => `<div class="cat-tab" data-cat="${c.id}" onclick="scrollToSection('${c.id}', this)">${escapeHTML(c.name)}</div>`).join('');
        }

        function renderMenuSections() {
            const container = document.getElementById('menuContainer');
            let items = menuItems;
            // Fix #12: æœå°‹ä¹Ÿæœæè¿°
            if (searchQuery) items = items.filter(i => i.name.toLowerCase().includes(searchQuery.toLowerCase()) || (i.description||'').toLowerCase().includes(searchQuery.toLowerCase()));

            // Fix #12: æœå°‹ç„¡çµæœæç¤º
            if (items.length === 0 && searchQuery) {
                container.innerHTML = '<div class="menu-section" style="text-align:center;padding:60px 20px;"><div style="font-size:48px;margin-bottom:12px;">ğŸ”</div><p style="color:#9CA3AF;font-size:15px;font-weight:600;">æ‰¾ä¸åˆ°ã€Œ' + escapeHTML(searchQuery) + 'ã€</p><p style="color:#CBD5E1;font-size:13px;margin-top:4px;">è©¦è©¦å…¶ä»–é—œéµå­—</p></div>';
                return;
            }

            if (categories.length === 0) {
                container.innerHTML = `<div class="menu-section" id="section-all"><div class="section-title">èœå–®</div>${items.map(i => renderItem(i)).join('')}</div>`;
                if (items.length === 0) container.innerHTML = '<div class="menu-section"><p style="text-align:center;color:#9CA3AF;padding:40px;">å°šç„¡é¤é»</p></div>';
                return;
            }
            const uncategorized = items.filter(i => !i.category_id);
            container.innerHTML = categories.map(c => {
                const catItems = items.filter(i => i.category_id === c.id);
                if (catItems.length === 0 && searchQuery) return '';
                return `<div class="menu-section" id="section-${c.id}" data-cat="${c.id}">
                    <div class="section-title">${escapeHTML(c.name)}</div>
                    ${catItems.length > 0 ? catItems.map(i => renderItem(i)).join('') : '<p style="color:#9CA3AF;font-size:13px;">æ­¤åˆ†é¡æš«ç„¡é¤é»</p>'}
                </div>`;
            }).join('') + (uncategorized.length > 0 ? `<div class="menu-section" id="section-other"><div class="section-title">å…¶ä»–</div>${uncategorized.map(i => renderItem(i)).join('')}</div>` : '');
        }

        function renderItem(item) {
            const avail = item.is_available !== false;
            const disabled = !avail || isStoreClosed;
            const photo = item.image_url
                ? `<img src="${item.image_url}" alt="${escapeHTML(item.name)}" loading="lazy">`
                : `<div class="no-img">ğŸ½ï¸</div>`;
            return `<div class="menu-item ${disabled ? 'item-unavailable' : ''}" onclick="${disabled ? '' : `addToCart('${item.id}')`}">
                <div class="item-info">
                    <div class="item-name">
                        ${escapeHTML(item.name)}
                        ${item.is_combo ? '<span class="tag tag-combo">å¥—é¤</span>' : ''}
                        ${!avail ? '<span class="tag tag-sold">å”®å®Œ</span>' : ''}
                    </div>
                    ${item.description ? `<div class="item-desc">${escapeHTML(item.description)}</div>` : ''}
                    <div class="item-price">$${item.price}</div>
                </div>
                <div class="item-photo">
                    ${photo}
                    ${disabled ? '' : `<button class="add-btn" onclick="event.stopPropagation();addToCart('${item.id}')">+</button>`}
                </div>
            </div>`;
        }

        // ===== Search =====
        let searchTimer = null;
        function handleSearch(val) {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => { searchQuery = val.trim(); renderMenuSections(); }, 200);
        }

        // ===== Scroll Spy =====
        // Fix #4 + #14: å‹•æ…‹è¨ˆç®— sticky offset
        let stickyOffset = 0;
        function fixStickyOffsets() {
            const sb = document.getElementById('searchBar');
            const cn = document.getElementById('categoryNav');
            if (sb && sb.style.display !== 'none') {
                const h = sb.offsetHeight;
                cn.style.top = h + 'px';
                stickyOffset = h + (cn.offsetHeight || 50);
            } else {
                stickyOffset = cn ? cn.offsetHeight || 50 : 50;
            }
        }
        function scrollToSection(catId, el) {
            document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
            if (el) el.classList.add('active');
            if (catId === 'all') { window.scrollTo({ top: 0, behavior: 'smooth' }); return; }
            const section = document.getElementById('section-' + catId);
            if (section) { window.scrollTo({ top: section.offsetTop - stickyOffset - 10, behavior: 'smooth' }); }
        }
        function initScrollSpy() {
            if (categories.length === 0) return;
            const sections = document.querySelectorAll('.menu-section[data-cat]');
            if (sections.length === 0) return;
            // Fix #14: rootMargin ç”¨å¯¦éš› stickyOffset
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const catId = entry.target.dataset.cat;
                        document.querySelectorAll('.cat-tab').forEach(t => t.classList.toggle('active', t.dataset.cat === catId));
                        const activeTab = document.querySelector(`.cat-tab[data-cat="${catId}"]`);
                        if (activeTab) activeTab.scrollIntoView({ behavior:'smooth', block:'nearest', inline:'center' });
                    }
                });
            }, { rootMargin: `-${stickyOffset + 20}px 0px -60% 0px`, threshold: 0 });
            sections.forEach(s => observer.observe(s));
        }

        // ===== Pickup Times =====
        function populatePickupTimes() {
            const sel = document.getElementById('pickupTime');
            const now = new Date();
            const start = new Date(now); start.setMinutes(Math.ceil(start.getMinutes()/15)*15+15, 0, 0);
            for (let i = 0; i < 12; i++) {
                const t = new Date(start.getTime() + i*15*60000);
                const label = t.getHours().toString().padStart(2,'0') + ':' + t.getMinutes().toString().padStart(2,'0');
                const opt = document.createElement('option'); opt.value = label; opt.textContent = label; sel.appendChild(opt);
            }
        }

        // ===== Add to Cart =====
        function addToCart(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            if (item.is_combo && item.combo_config && item.combo_config.groups) { pendingComboItem = item; openComboModal(item); return; }
            const opts = item.options;
            if (opts && Array.isArray(opts) && opts.length > 0) { pendingItem = item; openOptionsModal(item); return; }
            const existing = cart.find(c => c.item.id === itemId && !c.optionsLabel);
            if (existing) { existing.qty++; } else { cart.push({ item, qty:1, selectedOptions:null, optionsLabel:'', optionsPrice:0 }); }
            updateCartUI(); saveCart(); showToast(`âœ“ ${item.name}`);
        }

        // ===== Options Modal =====
        // Fix #8: æ•¸é‡é¸æ“‡
        let modalQty = 1;
        function adjustModalQty(d) {
            modalQty = Math.max(1, Math.min(99, modalQty + d));
            document.getElementById('optQty').textContent = modalQty;
            calcOptionSubtotal();
        }
        function openOptionsModal(item) {
            modalQty = 1;
            document.getElementById('optQty').textContent = 1;
            document.getElementById('optItemName').textContent = item.name;
            document.getElementById('optGroupsContainer').innerHTML = item.options.map((g, gIdx) => {
                const inputType = g.type === 'multi' ? 'checkbox' : 'radio';
                return `<div class="opt-group">
                    <div class="opt-group-title">${escapeHTML(g.name)} ${g.required ? '<span class="opt-group-req">å¿…é¸</span>' : ''}</div>
                    ${g.choices.map((c, cIdx) => `<label class="opt-choice">
                        <input type="${inputType}" name="optGrp${gIdx}" value="${cIdx}" onchange="calcOptionSubtotal()" ${g.type !== 'multi' && cIdx === 0 && g.required ? 'checked' : ''}>
                        <span class="opt-choice-label">${escapeHTML(c.name || c.label)}</span>
                        ${c.price > 0 ? `<span class="opt-choice-price">+$${c.price}</span>` : ''}
                    </label>`).join('')}
                </div>`;
            }).join('');
            calcOptionSubtotal();
            document.getElementById('optionsModal').classList.add('open');
            lockScroll();
        }
        function closeOptionsModal() { document.getElementById('optionsModal').classList.remove('open'); pendingItem = null; unlockScroll(); }
        function calcOptionSubtotal() {
            if (!pendingItem) return; let extra = 0;
            pendingItem.options.forEach((g, gIdx) => { document.querySelectorAll(`[name="optGrp${gIdx}"]:checked`).forEach(inp => { const c = g.choices[parseInt(inp.value)]; if (c) extra += c.price || 0; }); });
            const unitPrice = pendingItem.price + extra;
            // Fix #8: é¡¯ç¤ºæ•¸é‡ Ã— å°è¨ˆ
            document.getElementById('optSubtotal').textContent = modalQty > 1 ? `$${unitPrice} Ã— ${modalQty} = $${unitPrice * modalQty}` : '$' + unitPrice;
        }
        function confirmAddToCart() {
            if (!pendingItem) return; const item = pendingItem;
            for (let gIdx = 0; gIdx < item.options.length; gIdx++) { if (item.options[gIdx].required && document.querySelectorAll(`[name="optGrp${gIdx}"]:checked`).length === 0) return showToast(`è«‹é¸æ“‡${item.options[gIdx].name}`); }
            const labels = []; let extra = 0; const selected = [];
            // Fix #1: c.name || c.label é›™å‘ç›¸å®¹
            item.options.forEach((g, gIdx) => { document.querySelectorAll(`[name="optGrp${gIdx}"]:checked`).forEach(inp => { const c = g.choices[parseInt(inp.value)]; if (c) { const lbl = c.name || c.label; labels.push(lbl); extra += c.price||0; selected.push({ group:g.name, label:lbl, price:c.price||0 }); } }); });
            cart.push({ item, qty:modalQty, selectedOptions:selected, optionsLabel:labels.join(' '), optionsPrice:extra });
            updateCartUI(); saveCart(); closeOptionsModal(); showToast(`âœ“ ${item.name}`);
        }

        // ===== Combo Modal =====
        function openComboModal(item) {
            document.getElementById('comboItemName').textContent = item.name;
            const groups = item.combo_config.groups;
            document.getElementById('comboGroupsContainer').innerHTML = groups.map((g, gIdx) => {
                const pickLabel = g.pick === -1 ? 'ä»»é¸' : `é¸ ${g.pick} é …`;
                const inputType = g.pick === 1 ? 'radio' : 'checkbox';
                const groupItems = (g.items||[]).map(id => menuItems.find(i => i.id === id)).filter(Boolean);
                return `<div class="opt-group">
                    <div class="opt-group-title">${escapeHTML(g.name)} <span style="font-size:12px;color:#6B7280;font-weight:400;">(${pickLabel})</span></div>
                    ${groupItems.map(gi => `<label class="opt-choice"><input type="${inputType}" name="comboGrp${gIdx}" value="${gi.id}" onchange="calcComboSubtotal()"><span class="opt-choice-label">${escapeHTML(gi.name)}</span><span class="opt-choice-price">$${gi.price}</span></label>`).join('')}
                    ${groupItems.length === 0 ? '<p style="font-size:13px;color:#9CA3AF;">æ­¤ç¾¤çµ„æš«ç„¡å“é …</p>' : ''}
                </div>`;
            }).join('');
            document.getElementById('comboSubtotal').textContent = '$' + item.price;
            document.getElementById('comboModal').classList.add('open');
            lockScroll();
        }
        function closeComboModal() { document.getElementById('comboModal').classList.remove('open'); pendingComboItem = null; unlockScroll(); }
        function calcComboSubtotal() { if (pendingComboItem) document.getElementById('comboSubtotal').textContent = '$' + pendingComboItem.price; }
        function confirmAddCombo() {
            if (!pendingComboItem) return; const item = pendingComboItem; const groups = item.combo_config.groups; const labels = [];
            for (let gIdx = 0; gIdx < groups.length; gIdx++) { const g = groups[gIdx]; const checked = document.querySelectorAll(`[name="comboGrp${gIdx}"]:checked`); if (g.pick > 0 && checked.length !== g.pick) return showToast(`${g.name}ï¼šè«‹é¸æ“‡ ${g.pick} é …`); checked.forEach(inp => { const gi = menuItems.find(i => i.id === inp.value); if (gi) labels.push(gi.name); }); }
            cart.push({ item, qty:1, selectedOptions:null, optionsLabel:labels.join('+'), optionsPrice:0 });
            updateCartUI(); saveCart(); closeComboModal(); showToast(`âœ“ ${item.name}`);
        }

        // ===== Cart =====
        // Fix #6: å¤–å¸¶æ™‚éš±è—æ¡Œè™Ÿ
        function toggleTableNumber() {
            const grp = document.getElementById('tableNumberGroup');
            const isIn = document.getElementById('orderType').value === 'dine_in';
            grp.style.display = isIn ? '' : 'none';
            if (!isIn) document.getElementById('tableNumber').value = '';
        }
        // Fix #9: æ¸…ç©ºè³¼ç‰©è»Š
        function clearCart() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ')) return;
            cart = []; saveCart(); updateCartUI(); renderCartItems();
        }
        function updateCartQty(idx, delta) {
            cart[idx].qty += delta;
            if (cart[idx].qty <= 0) cart.splice(idx, 1);
            updateCartUI(); saveCart(); renderCartItems();
        }
        function updateCartUI() {
            const qty = cart.reduce((s,c) => s + c.qty, 0);
            const price = cart.reduce((s,c) => s + (c.item.price + (c.optionsPrice||0)) * c.qty, 0);
            const el = document.getElementById('floatingCart');
            el.style.display = qty > 0 ? 'flex' : 'none';
            document.getElementById('cartBadge').textContent = qty;
            // Fix #15: Badge å½ˆè·³å‹•ç•«
            const badge = document.getElementById('cartBadge');
            badge.classList.remove('bounce');
            void badge.offsetWidth;
            badge.classList.add('bounce');
            document.getElementById('cartTotalPrice').textContent = '$' + price;
            // Fix #13: åº—ä¼‘æ™‚æµ®å‹•æŒ‰éˆ•é¡¯ç¤ºè­¦å‘Š
            const ckBtn = document.getElementById('checkoutBtn');
            if (isStoreClosed) {
                ckBtn.textContent = 'â¸ æš«åœæ¥å–®';
                ckBtn.style.background = '#6B7280';
            } else {
                ckBtn.textContent = 'å»çµå¸³ â†’';
                ckBtn.style.background = '';
            }
            const subBtn = document.getElementById('submitOrderBtn');
            if (subBtn) {
                subBtn.disabled = isStoreClosed;
                subBtn.textContent = isStoreClosed ? 'â¸ ç›®å‰æš«åœæ¥å–®' : 'é€å‡ºè¨‚å–®';
            }
        }
        function openCart() {
            if (cart.length === 0) return showToast('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
            renderCartItems();
            toggleTableNumber();
            document.getElementById('cartModal').classList.add('open');
            lockScroll();
        }
        function closeCart() { document.getElementById('cartModal').classList.remove('open'); unlockScroll(); }
        function renderCartItems() {
            const el = document.getElementById('cartItems');
            // Fix #9: ç©ºç‹€æ…‹
            if (cart.length === 0) {
                el.innerHTML = '<div style="text-align:center;padding:40px 20px;"><div style="font-size:48px;margin-bottom:8px;">ğŸ›’</div><div style="font-size:15px;font-weight:700;color:#9CA3AF;">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div><div style="font-size:13px;color:#CBD5E1;margin-top:4px;">å¿«å»é¸å¹¾é“å¥½æ–™å§ï¼</div></div>';
                document.getElementById('cartTotal').textContent = '$0';
                return;
            }
            el.innerHTML = cart.map((c,idx) => {
                const up = c.item.price + (c.optionsPrice||0);
                // Fix #15: qty=1 æ™‚é¡¯ç¤ºåƒåœ¾æ¡¶
                return `<div class="cart-item">
                    <div class="ci-info">
                        <div class="ci-name">${escapeHTML(c.item.name)}</div>
                        ${c.optionsLabel ? `<div class="ci-opts">${escapeHTML(c.optionsLabel)}</div>`:''}
                    </div>
                    <div class="qty-ctrl">
                        <button class="qty-btn" onclick="updateCartQty(${idx},-1)">${c.qty === 1 ? 'ğŸ—‘' : 'âˆ’'}</button>
                        <span class="qty-num">${c.qty}</span>
                        <button class="qty-btn" onclick="updateCartQty(${idx},1)">+</button>
                    </div>
                    <div class="ci-price">$${up*c.qty}</div>
                </div>`;
            }).join('');
            document.getElementById('cartTotal').textContent = '$' + cart.reduce((s,c) => s + (c.item.price+(c.optionsPrice||0))*c.qty, 0);
        }

        // ===== Submit Order =====
        let isSubmitting = false;
        async function submitOrder() {
            if (isSubmitting) return;
            // Fix #7: åº—ä¼‘é˜»æ“‹é€å‡º
            if (isStoreClosed) return showToast('æœ¬åº—ç›®å‰æš«åœæ¥å–®');
            const name = document.getElementById('custName').value.trim();
            if (!name) return showToast('è«‹è¼¸å…¥å§“å');
            if (cart.length === 0) return showToast('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
            isSubmitting = true;
            const btn = document.getElementById('submitOrderBtn');
            btn.disabled = true; btn.textContent = 'é€å‡ºä¸­...';
            try {
                const items = cart.map(c => ({ name:c.item.name, qty:c.qty, price:c.item.price+(c.optionsPrice||0), subtotal:(c.item.price+(c.optionsPrice||0))*c.qty, options:c.optionsLabel||null }));
                const total = items.reduce((s,i) => s+i.subtotal, 0);
                const orderNumber = 'O' + Date.now().toString(36).toUpperCase();
                // Fix #2: ç”¨æœ¬åœ°æ—¥æœŸé¿å… UTC æ™‚å€åç§»
                const now0 = new Date();
                const today = `${now0.getFullYear()}-${String(now0.getMonth()+1).padStart(2,'0')}-${String(now0.getDate()).padStart(2,'0')}`;
                const { data: maxOrder } = await sb.from('orders').select('pickup_number').eq('store_id', store.id).gte('created_at', today+'T00:00:00').order('pickup_number',{ascending:false}).limit(1).maybeSingle();
                const pickupNumber = (maxOrder?.pickup_number || 0) + 1;
                const pickupTime = document.getElementById('pickupTime').value || null;
                const record = {
                    store_id: store.id,
                    order_number: orderNumber,
                    pickup_number: pickupNumber,
                    customer_name: name,
                    customer_phone: document.getElementById('custPhone').value.trim() || null,
                    customer_line_id: lineUserId || null,
                    order_type: document.getElementById('orderType').value,
                    table_number: document.getElementById('tableNumber').value.trim() || null,
                    pickup_time: pickupTime,
                    items, total,
                    notes: document.getElementById('orderNotes').value.trim() || null,
                    status: 'pending'
                };
                const { data, error } = await sb.from('orders').insert(record).select().single();
                if (error) throw error;
                // LINE group push
                if (store.line_group_id) {
                    try {
                        const itemStr = items.map(i => `${i.name}${i.options ? '(' + i.options + ')' : ''} Ã—${i.qty}`).join('\n');
                        const tl = { dine_in:'å…§ç”¨', takeout:'å¤–å¸¶' };
                        await sb.functions.invoke('send-line-notify', { body: { groupId: store.line_group_id, message: `ğŸ”” æ–°è¨‚å–® #${String(pickupNumber).padStart(3,'0')}\nå®¢äººï¼š${name}\n${tl[record.order_type]||''}\n${itemStr}\nåˆè¨ˆ $${total}` } });
                    } catch(e2) {}
                }
                // Loyalty
                if (lineUserId && store.loyalty_config) {
                    try {
                        const lc = store.loyalty_config;
                        const earnPts = Math.floor(total / (lc.spend_per_point || 50));
                        if (earnPts > 0) {
                            if (customerLoyalty) {
                                await sb.from('loyalty_points').update({ points: (customerLoyalty.points||0)+earnPts, total_earned: (customerLoyalty.total_earned||0)+earnPts, updated_at: new Date().toISOString() }).eq('id', customerLoyalty.id);
                            } else {
                                await sb.from('loyalty_points').insert({ store_id: store.id, customer_line_id: lineUserId, points: earnPts, total_earned: earnPts });
                            }
                        }
                    } catch(e2) {}
                }
                showOrderConfirmation(data, items, pickupNumber);
                cart = []; saveCart(); updateCartUI(); closeCart();
            } catch(e) { console.error(e); showToast('è¨‚å–®é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦'); }
            isSubmitting = false;
            btn.disabled = false; btn.textContent = 'é€å‡ºè¨‚å–®';
        }

        function showOrderConfirmation(order, items, pickupNumber) {
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('floatingCart').style.display = 'none';
            document.getElementById('orderConfirmView').style.display = 'block';
            document.getElementById('confirmPickup').textContent = '#' + String(pickupNumber).padStart(3,'0');
            document.getElementById('confirmOrderNo').textContent = 'è¨‚å–®ç·¨è™Ÿ ' + order.order_number;
            const tl = {dine_in:'å…§ç”¨',takeout:'å¤–å¸¶',delivery:'å¤–é€'};
            document.getElementById('confirmDetail').innerHTML = `
                <div class="confirm-card">
                    <h4>é¡§å®¢è³‡è¨Š</h4>
                    <div style="font-weight:600;">${escapeHTML(order.customer_name)}</div>
                    <div style="font-size:13px;color:#6B7280;">${tl[order.order_type]||order.order_type}${order.table_number?' Â· æ¡Œè™Ÿ '+escapeHTML(order.table_number):''}${order.pickup_time?' Â· å–é¤ '+escapeHTML(order.pickup_time):''}</div>
                </div>
                <div class="confirm-card">
                    <h4>è¨‚å–®æ˜ç´°</h4>
                    ${items.map(i=>`<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:14px;"><div>${escapeHTML(i.name)} Ã—${i.qty}${i.options?'<div style="font-size:11px;color:#9CA3AF;">'+escapeHTML(i.options)+'</div>':''}</div><div style="font-weight:700;">$${i.subtotal}</div></div>`).join('')}
                    <div style="display:flex;justify-content:space-between;padding:12px 0 4px;border-top:2px solid #1a1a2e;margin-top:8px;font-weight:800;font-size:18px;"><span>åˆè¨ˆ</span><span style="color:var(--theme);">$${order.total}</span></div>
                </div>
                ${order.notes?'<div class="confirm-card"><h4>å‚™è¨»</h4><p style="font-size:14px;">'+escapeHTML(order.notes)+'</p></div>':''}`;
        }

        // Fix #14 + #15: resetOrder ä¿ç•™ LINE åç¨±
        function resetOrder() {
            document.getElementById('orderConfirmView').style.display = 'none';
            document.getElementById('mainView').style.display = 'block';
            // ä¿ç•™ LINE è‡ªå‹•å¸¶å…¥çš„åç¨±
            document.getElementById('custPhone').value = '';
            document.getElementById('tableNumber').value = '';
            document.getElementById('orderNotes').value = '';
            document.getElementById('pickupTime').value = '';
            if (!lineDisplayName) document.getElementById('custName').value = '';
        }

        init();
    </script>
</body>
</html>
