<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#E8430A">
<title>ÊéÉÁ¢ºÈªûÈ§ê</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
<style>
/* ===== CSS VARIABLES ===== */
:root {
  --primary: #E8430A;
  --primary-light: #FF6B35;
  --primary-dark: #C23508;
  --accent: #FFB800;
  --accent-light: #FFD466;
  --bg: #F5F0EB;
  --bg-card: #FFFFFF;
  --bg-sidebar: #FAFAFA;
  --text-primary: #1A1A1A;
  --text-secondary: #666666;
  --text-muted: #999999;
  --border: #E8E8E8;
  --border-light: #F0F0F0;
  --shadow-sm: 0 1px 4px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.07);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.10);
  --shadow-xl: 0 16px 48px rgba(0,0,0,0.14);
  --radius-sm: 10px;
  --radius-md: 14px;
  --radius-lg: 18px;
  --radius-xl: 24px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

/* ===== RESET & BASE ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
body {
  font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text-primary);
  line-height: 1.6;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ===== LOADING SCREEN ===== */
.loading-screen {
  position: fixed; inset: 0; z-index: 9999;
  background: linear-gradient(160deg, var(--primary) 0%, var(--primary-dark) 100%);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  transition: opacity 0.6s ease, visibility 0.6s;
}
.loading-screen.hide { opacity: 0; visibility: hidden; pointer-events: none; }
.loading-logo {
  width: 88px; height: 88px; border-radius: 24px;
  background: rgba(255,255,255,0.12); backdrop-filter: blur(20px);
  display: flex; align-items: center; justify-content: center;
  font-size: 36px; margin-bottom: 24px; color: white; font-weight: 900;
  animation: logoPulse 2s ease-in-out infinite;
  border: 1px solid rgba(255,255,255,0.15);
}
@keyframes logoPulse { 0%,100% { transform: scale(1) rotate(0); } 50% { transform: scale(1.06) rotate(1deg); } }
.loading-text { color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 500; letter-spacing: 2px; }
.loading-dots::after { content: ''; animation: dots 1.2s steps(4) infinite; }
@keyframes dots { 0% { content: ''; } 25% { content: '.'; } 50% { content: '..'; } 75% { content: '...'; } }

/* ===== BRAND HERO ===== */
.brand-hero {
  display: none; background: var(--bg-card);
  position: relative; overflow: hidden;
}
.brand-hero.show { display: block; }
/* Banner Ê®°ÂºèÔºöÂÖ®ÂØ¨Â§ßÂúñ */
.brand-hero.mode-banner .brand-hero-img {
  width: 100%; display: block; object-fit: contain;
  max-height: 280px; min-height: 120px;
  background: var(--bg-card, #f8f8f8);
}
/* Logo Ê®°ÂºèÔºöÂ±Ö‰∏≠ logo + ÂìÅÁâåÂêç + Ë£ùÈ£æËÉåÊôØ */
.brand-hero.mode-logo {
  background: var(--header-gradient, linear-gradient(160deg, var(--primary) 0%, var(--primary-dark) 100%));
  padding: 28px 20px 24px; text-align: center;
}
.brand-hero.mode-logo .brand-hero-img {
  width: 88px; height: 88px; border-radius: 22px;
  object-fit: cover; margin: 0 auto 12px;
  box-shadow: 0 6px 24px rgba(0,0,0,0.18);
  border: 3px solid rgba(255,255,255,0.25);
  display: block; background: rgba(255,255,255,0.1);
}
.brand-hero-name {
  display: none; font-size: 20px; font-weight: 800;
  color: #fff; letter-spacing: 0.5px;
  text-shadow: 0 2px 8px rgba(0,0,0,0.12);
}
.brand-hero.mode-logo .brand-hero-name { display: block; }
.brand-hero-tagline {
  display: none; font-size: 12px; color: rgba(255,255,255,0.75);
  margin-top: 4px; font-weight: 400;
}
.brand-hero.mode-logo .brand-hero-tagline { display: block; }
/* Banner Ê®°Âºè‰∏ãÁöÑÊº∏Â±§ÁñäÂä† */
.brand-hero.mode-banner::after {
  content: ''; position: absolute; bottom: 0; left: 0; right: 0;
  height: 50%; background: linear-gradient(to top, rgba(0,0,0,0.15), transparent);
  pointer-events: none;
}
/* Logo Ê®°ÂºèË£ùÈ£æÂúì */
.brand-hero.mode-logo::before {
  content: ''; position: absolute; top: -40%; right: -20%;
  width: 200px; height: 200px; border-radius: 50%;
  background: radial-gradient(circle, rgba(255,255,255,0.08), transparent 70%);
  pointer-events: none;
}
.brand-hero.mode-logo::after {
  content: ''; position: absolute; bottom: -30%; left: -15%;
  width: 160px; height: 160px; border-radius: 50%;
  background: radial-gradient(circle, rgba(255,255,255,0.05), transparent 70%);
  pointer-events: none;
}

/* ===== SHARE BTN ===== */
.share-btn {
  background: rgba(255,255,255,0.18); padding: 4px 12px;
  border-radius: 20px; font-size: 11px; font-weight: 600;
  color: #FFF; cursor: pointer; backdrop-filter: blur(8px);
  text-decoration: none; white-space: nowrap;
  border: 1px solid rgba(255,255,255,0.12);
  transition: background 0.2s;
}
.share-btn:hover { background: rgba(255,255,255,0.28); }

/* ===== SHOP HEADER ===== */
.shop-header {
  background: var(--header-gradient, linear-gradient(160deg, var(--primary) 0%, var(--primary-dark) 100%));
  color: white; padding: 0 0 20px; position: relative; overflow: hidden;
}
.shop-header::before {
  content: ''; position: absolute; top: -60%; right: -30%;
  width: 300px; height: 300px; border-radius: 50%;
  background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
}
.shop-header::after {
  content: ''; position: absolute; bottom: -40%; left: -15%;
  width: 200px; height: 200px; border-radius: 50%;
  background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
}
.header-status-bar {
  padding: 14px 18px 10px; font-size: 12px;
  display: flex; justify-content: space-between; align-items: center;
  position: relative; z-index: 1;
}
.header-status-bar .badge {
  background: rgba(255,255,255,0.18); padding: 4px 12px;
  border-radius: 20px; font-size: 11px; backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.1);
  font-weight: 600;
}
.badge.open { background: rgba(76,175,80,0.25); border-color: rgba(76,175,80,0.2); }
.badge.closed { background: rgba(244,67,54,0.25); border-color: rgba(244,67,54,0.2); }
.shop-info { padding: 0 20px; position: relative; z-index: 1; }
.shop-name-row { display: flex; align-items: center; gap: 14px; margin-bottom: 12px; }
.shop-logo {
  width: 60px; height: 60px; border-radius: 16px;
  background: rgba(255,255,255,0.12); backdrop-filter: blur(16px);
  display: flex; align-items: center; justify-content: center;
  font-size: 28px; flex-shrink: 0;
  border: 1.5px solid rgba(255,255,255,0.18);
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}
.shop-name {
  font-size: 24px; font-weight: 900; letter-spacing: 0.5px;
  text-shadow: 0 2px 12px rgba(0,0,0,0.12);
  line-height: 1.3;
}
.shop-subtitle {
  font-size: 12.5px; opacity: 0.8; margin-top: 3px; font-weight: 400;
  letter-spacing: 0.3px;
}
.shop-details {
  display: flex; flex-wrap: wrap; gap: 4px 16px;
  font-size: 12px; opacity: 0.85; margin-top: 2px;
}
.shop-details .detail-row { display: flex; align-items: center; gap: 5px; }
.shop-details .icon { width: 14px; text-align: center; flex-shrink: 0; opacity: 0.75; font-size: 11px; }

/* ===== TABLE / GUEST SELECTOR ===== */
.table-selector {
  background: var(--bg-card); margin: -10px 14px 0; border-radius: var(--radius-lg);
  padding: 18px 20px; position: relative; z-index: 2;
  box-shadow: var(--shadow-lg); border: 1px solid rgba(255,255,255,0.8);
}
.table-selector h3 {
  font-size: 14px; font-weight: 700; color: var(--text-primary);
  margin-bottom: 14px; display: flex; align-items: center; gap: 8px;
}
.table-row { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
.table-label { font-size: 13px; color: var(--text-secondary); min-width: 48px; font-weight: 600; }
.table-input {
  flex: 1; height: 44px; border: 1.5px solid var(--border);
  border-radius: var(--radius-sm); padding: 0 14px;
  font-size: 16px; font-weight: 700; text-align: center;
  font-family: inherit; outline: none; transition: all 0.25s;
  background: var(--bg);
}
.table-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(232,67,10,0.08); background: #fff; }
.guest-selector { display: flex; gap: 8px; flex-wrap: wrap; }
.guest-btn {
  width: 44px; height: 44px; border-radius: 12px;
  border: 1.5px solid var(--border); background: var(--bg);
  font-size: 15px; font-weight: 700; cursor: pointer;
  transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;
  font-family: inherit; color: var(--text-secondary);
}
.guest-btn:hover { border-color: var(--primary); color: var(--primary); background: #fff; }
.guest-btn.active {
  background: var(--primary); color: white;
  border-color: var(--primary); transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}
.guest-btn-more {
  width: 44px; height: 44px; border-radius: 12px;
  border: 1.5px dashed var(--border); background: var(--bg);
  font-size: 18px; color: var(--text-muted); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s; font-family: inherit;
}
.guest-btn-more:hover { border-color: var(--primary); color: var(--primary); }

/* ===== MAIN LAYOUT ===== */
.menu-container {
  display: flex; height: calc(100vh - 280px); height: calc(100dvh - 280px);
  margin-top: 12px; position: relative;
}

/* ===== LEFT SIDEBAR CATEGORIES ===== */
.category-sidebar {
  width: 76px; flex-shrink: 0;
  background: var(--bg-sidebar);
  overflow-y: auto; overflow-x: hidden;
  scrollbar-width: none; -ms-overflow-style: none;
  border-right: 1px solid var(--border-light);
  padding: 6px 0;
}
.category-sidebar::-webkit-scrollbar { display: none; }
.cat-item {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 10px 4px; cursor: pointer;
  position: relative; transition: all 0.25s ease;
  margin: 2px 6px; border-radius: 12px;
  min-height: 62px;
}
.cat-item:hover { background: rgba(0,0,0,0.03); }
.cat-item.active {
  background: var(--bg-card);
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.cat-item.active .cat-name { color: var(--primary); font-weight: 700; }
.cat-icon { font-size: 22px; margin-bottom: 3px; transition: transform 0.2s; }
.cat-item.active .cat-icon { transform: scale(1.1); }
.cat-name {
  font-size: 11px; font-weight: 500; text-align: center;
  color: var(--text-secondary); line-height: 1.3;
  word-break: keep-all; letter-spacing: -0.2px;
}
.cat-badge {
  position: absolute; top: 4px; right: 4px;
  background: var(--primary); color: white;
  font-size: 9px; font-weight: 800;
  min-width: 16px; height: 16px; line-height: 16px;
  border-radius: 8px; text-align: center; padding: 0 4px;
  display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}
.cat-badge.show { display: block; animation: badgePop 0.3s ease; }
@keyframes badgePop { 0% { transform: scale(0); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

/* ===== RIGHT MENU CONTENT ===== */
.menu-content {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  scroll-behavior: smooth; padding-bottom: 110px;
  scrollbar-width: none; -ms-overflow-style: none;
}
.menu-content::-webkit-scrollbar { display: none; }

/* ===== FEATURED / RECOMMENDED ===== */
.featured-section { padding: 18px 14px 10px; }
.section-title {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 14px;
}
.section-title .fire { font-size: 18px; }
.section-title h2 { font-size: 16px; font-weight: 800; color: var(--text-primary); letter-spacing: -0.3px; }
.section-title .subtitle { font-size: 11px; color: var(--text-muted); margin-left: auto; font-weight: 500; }
.featured-scroll {
  display: flex; gap: 10px; overflow-x: auto;
  padding-bottom: 10px; scrollbar-width: none;
  -ms-overflow-style: none; scroll-snap-type: x mandatory;
  margin: 0 -4px; padding: 4px;
}
.featured-scroll::-webkit-scrollbar { display: none; }
.featured-card {
  flex-shrink: 0; width: 200px; scroll-snap-align: start;
  background: var(--bg-card); border-radius: var(--radius-lg);
  overflow: hidden; box-shadow: var(--shadow-md);
  cursor: pointer; transition: all 0.25s cubic-bezier(0.32,0.72,0,1);
  position: relative; border: 1px solid var(--border-light);
}
.featured-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
.featured-card:active { transform: scale(0.97); }
.featured-img {
  width: 100%; height: 150px; object-fit: cover; background: linear-gradient(135deg, #f5f0eb, #ebe5de);
  transition: transform 0.4s ease;
}
.featured-card:hover .featured-img { transform: scale(1.05); }
/* ÂúñÁâáÂ∫ïÈÉ®Êº∏Â±§ÁñäÂä† */
.featured-card::after {
  content: ''; position: absolute; top: 80px; left: 0; right: 0; height: 70px;
  background: linear-gradient(to top, rgba(0,0,0,0.35), transparent);
  pointer-events: none; z-index: 1;
}
.featured-badge {
  position: absolute; top: 10px; left: 10px;
  background: var(--primary); color: white;
  font-size: 10px; font-weight: 700; padding: 4px 12px;
  border-radius: 20px; letter-spacing: 0.5px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 2;
}
.featured-info { padding: 12px 14px 14px; }
.featured-name {
  font-size: 14px; font-weight: 700;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  margin-bottom: 6px; letter-spacing: -0.2px;
}
.featured-desc {
  font-size: 11px; color: var(--text-muted); line-height: 1.4;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  margin-bottom: 8px;
}
.featured-price { font-size: 18px; font-weight: 800; color: var(--primary); }
.featured-price .currency { font-size: 12px; font-weight: 600; }
.featured-add {
  position: absolute; bottom: 12px; right: 12px;
  width: 34px; height: 34px; border-radius: 11px;
  background: var(--primary); color: white;
  border: none; font-size: 20px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.featured-add:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
.featured-add:active { transform: scale(0.85); }

/* ===== CATEGORY SECTION ===== */
.category-section { padding: 12px 14px 4px; }
.category-header {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 0 12px; border-bottom: 1.5px solid var(--border-light);
  margin-bottom: 6px; position: sticky; top: 0;
  background: var(--bg); z-index: 5;
}
.category-header .cat-emoji { font-size: 18px; }
.category-header h3 { font-size: 15px; font-weight: 800; letter-spacing: -0.2px; }
.category-header .count {
  font-size: 10px; color: var(--text-muted); margin-left: auto;
  background: var(--border-light); padding: 3px 10px; border-radius: 20px;
  font-weight: 600;
}

/* ===== MENU ITEM CARD ===== */
.menu-item {
  display: flex; gap: 12px; padding: 14px 4px;
  border-bottom: 1px solid var(--border-light);
  position: relative; cursor: pointer;
  transition: all 0.2s ease; border-radius: var(--radius-sm);
  margin: 0 -4px;
}
.menu-item:last-child { border-bottom: none; }
.menu-item:active { background: rgba(0,0,0,0.015); transform: scale(0.995); }
.item-img-wrap {
  width: 100px; height: 100px; flex-shrink: 0;
  border-radius: var(--radius-md); overflow: hidden; position: relative;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.item-img {
  width: 100%; height: 100%; object-fit: cover;
  background: linear-gradient(135deg, #f5f0eb, #ebe5de);
  transition: transform 0.4s ease;
}
.menu-item:hover .item-img { transform: scale(1.06); }
.item-sold-tag {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: rgba(0,0,0,0.6); color: white;
  font-size: 10px; text-align: center; padding: 3px 0;
  backdrop-filter: blur(6px);
}
.item-spicy {
  position: absolute; top: 6px; right: 6px;
  font-size: 14px; filter: drop-shadow(0 1px 3px rgba(0,0,0,0.3));
}
.item-info { flex: 1; min-width: 0; display: flex; flex-direction: column; padding: 2px 0; }
.item-name {
  font-size: 15px; font-weight: 700; margin-bottom: 4px; letter-spacing: -0.2px;
  display: -webkit-box; -webkit-line-clamp: 2;
  -webkit-box-orient: vertical; overflow: hidden;
  line-height: 1.4;
}
.item-desc {
  font-size: 11.5px; color: var(--text-muted); margin-bottom: auto;
  display: -webkit-box; -webkit-line-clamp: 2;
  -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5;
}
.item-tags { display: flex; gap: 4px; margin: 6px 0 4px; flex-wrap: wrap; }
.item-tag {
  font-size: 10px; padding: 2px 8px; border-radius: 6px; font-weight: 600;
  letter-spacing: 0.2px;
}
.item-tag.hot { background: #FFF3E0; color: #E65100; }
.item-tag.new { background: #E8F5E9; color: #2E7D32; }
.item-tag.chef { background: #FFF8E1; color: #F57F17; }
.item-tag.\u63A8\u85A6 { background: rgba(232,67,10,0.08); color: var(--primary); }
.item-tag.\u5957\u9910 { background: rgba(79,70,229,0.08); color: #4F46E5; }
.item-bottom {
  display: flex; align-items: flex-end; justify-content: space-between; margin-top: auto;
}
.item-price { font-size: 18px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
.item-price .currency { font-size: 12px; font-weight: 600; margin-right: 1px; }
.item-sizes { display: flex; gap: 6px; margin-top: 4px; }
.size-option {
  font-size: 11px; color: var(--text-muted);
  cursor: pointer; padding: 3px 10px; border-radius: 8px;
  border: 1px solid var(--border); transition: all 0.2s; font-weight: 500;
}
.size-option:hover, .size-option.active {
  border-color: var(--primary); color: var(--primary);
  background: rgba(232,67,10,0.04);
}
.item-actions { display: flex; align-items: center; gap: 0; }
.qty-control {
  display: flex; align-items: center; gap: 0;
  background: var(--bg-card); border-radius: 12px; overflow: hidden;
  box-shadow: var(--shadow-sm); border: 1.5px solid var(--border);
}
.qty-btn {
  width: 32px; height: 32px; border: none;
  background: transparent; font-size: 16px; font-weight: 700;
  cursor: pointer; display: flex; align-items: center;
  justify-content: center; transition: all 0.15s;
  color: var(--text-secondary); font-family: inherit;
}
.qty-btn:hover { background: rgba(0,0,0,0.04); color: var(--primary); }
.qty-btn:active { transform: scale(0.85); }
.qty-btn.minus { color: var(--text-muted); }
.qty-num {
  width: 28px; text-align: center; font-size: 14px;
  font-weight: 800; color: var(--text-primary);
}
.add-btn {
  width: 34px; height: 34px; border-radius: 11px;
  background: var(--primary); color: white; border: none;
  font-size: 20px; cursor: pointer; display: flex;
  align-items: center; justify-content: center;
  transition: all 0.2s ease;
  box-shadow: 0 3px 10px rgba(0,0,0,0.12);
  font-family: inherit;
}
.add-btn:hover { transform: scale(1.1); box-shadow: 0 4px 14px rgba(0,0,0,0.18); }
.add-btn:active { transform: scale(0.85); }

/* ===== GROUP ORDER (ÂúòÈ´îÈªûÈ§ê) ===== */
.group-start-btn, .group-join-btn {
  padding: 8px 16px; border: 1.5px solid var(--primary);
  border-radius: 10px; background: rgba(232,67,10,0.05);
  color: var(--primary); font-size: 13px; font-weight: 700;
  cursor: pointer; font-family: inherit; transition: all 0.2s;
}
.group-start-btn:active, .group-join-btn:active { transform: scale(0.96); }
.group-join-btn { border-color: var(--border); color: var(--text-secondary); background: var(--bg); }

.group-panel {
  background: var(--bg-card); margin: -6px 14px 0; border-radius: 0 0 18px 18px;
  padding: 0 16px 14px; position: relative; z-index: 2;
  box-shadow: var(--shadow-md); border: 1px solid rgba(255,255,255,0.8);
  border-top: 1.5px dashed var(--border);
}
.group-panel-header {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 0 10px;
}
.group-panel-title { font-size: 14px; font-weight: 800; }
.group-panel-session {
  font-size: 11px; color: var(--text-muted);
  background: var(--border-light); padding: 3px 10px;
  border-radius: 12px; font-weight: 600;
}
.group-panel-close {
  margin-left: auto; width: 28px; height: 28px;
  border: none; border-radius: 50%; background: var(--border-light);
  color: var(--text-muted); font-size: 14px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.group-members {
  display: flex; flex-direction: column; gap: 8px;
  max-height: 180px; overflow-y: auto; padding: 2px 0;
}
.group-member {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 10px; border-radius: 12px;
  background: var(--bg); border: 1px solid var(--border-light);
}
.group-member.me { border-color: var(--primary); background: rgba(232,67,10,0.03); }
.group-member-avatar {
  width: 36px; height: 36px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; background: var(--border-light); flex-shrink: 0;
}
.group-member-info { flex: 1; min-width: 0; }
.group-member-name { font-size: 13px; font-weight: 700; }
.group-member-status { font-size: 11px; color: var(--text-muted); }
.group-member-total {
  font-size: 15px; font-weight: 800; color: var(--primary);
  white-space: nowrap;
}
.group-invite-btn {
  width: 100%; margin-top: 10px; padding: 10px;
  border: 1.5px dashed var(--border); border-radius: 10px;
  background: transparent; color: var(--text-secondary);
  font-size: 13px; font-weight: 600; cursor: pointer;
  font-family: inherit; transition: all 0.2s;
}
.group-invite-btn:hover { border-color: var(--primary); color: var(--primary); }

/* Âä†ÂÖ•ÂúòÈ´îÈªûÈ§ê Modal */
.group-join-modal { text-align: center; }
.group-avatar-picker {
  display: flex; justify-content: center; gap: 10px;
  margin: 16px 0; flex-wrap: wrap;
}
.group-avatar-opt {
  width: 48px; height: 48px; border-radius: 50%;
  border: 2px solid var(--border); background: var(--bg);
  font-size: 26px; cursor: pointer; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center;
}
.group-avatar-opt.active {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(232,67,10,0.12);
  transform: scale(1.1);
}

/* ===== SERVICE CALL FAB (ÊúçÂãôÂëºÂè´) ===== */
.service-call-fab {
  position: fixed; bottom: 100px; right: 16px; z-index: 90;
}
.service-fab-btn {
  width: 48px; height: 48px; border-radius: 50%;
  background: var(--bg-card); border: 1.5px solid var(--border);
  box-shadow: var(--shadow-lg); cursor: pointer;
  font-size: 22px; display: flex; align-items: center; justify-content: center;
  transition: all 0.25s cubic-bezier(0.32,0.72,0,1);
}
.service-fab-btn:active { transform: scale(0.9); }
.service-menu {
  position: absolute; bottom: 56px; right: 0;
  background: var(--bg-card); border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl); border: 1px solid var(--border-light);
  padding: 6px; min-width: 160px;
  opacity: 0; visibility: hidden; transform: translateY(8px) scale(0.95);
  transition: all 0.2s cubic-bezier(0.32,0.72,0,1);
}
.service-menu.show {
  opacity: 1; visibility: visible; transform: translateY(0) scale(1);
}
.service-menu-item {
  display: flex; align-items: center; gap: 8px;
  width: 100%; padding: 12px 14px; border: none;
  background: transparent; border-radius: var(--radius-sm);
  font-size: 14px; font-weight: 600; cursor: pointer;
  font-family: inherit; color: var(--text-primary);
  transition: background 0.15s;
}
.service-menu-item:hover { background: var(--border-light); }
.service-menu-item:active { background: rgba(232,67,10,0.06); }

/* ===== BOTTOM CART BAR ===== */
.cart-bar {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
  padding: 0 14px calc(12px + var(--safe-bottom));
  pointer-events: none;
  transition: transform 0.35s cubic-bezier(0.32,0.72,0,1);
}
.cart-bar.hidden { transform: translateY(120%); }
.cart-inner {
  background: linear-gradient(135deg, #1E1E24 0%, #141418 100%);
  border-radius: var(--radius-xl);
  display: flex; align-items: center;
  padding: 10px 12px 10px 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.05) inset;
  pointer-events: auto; position: relative; overflow: hidden;
}
.cart-inner::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.04), transparent 60%);
  pointer-events: none;
}
.cart-icon-wrap { position: relative; margin-right: 14px; cursor: pointer; }
.cart-icon {
  width: 46px; height: 46px; border-radius: 14px;
  background: var(--primary);
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transition: transform 0.2s;
}
.cart-icon:active { transform: scale(0.9); }
.cart-count {
  position: absolute; top: -5px; right: -5px;
  background: var(--accent); color: #1A1A1A;
  font-size: 10px; font-weight: 800;
  min-width: 20px; height: 20px; line-height: 20px;
  border-radius: 10px; text-align: center;
  padding: 0 5px; border: 2px solid #1E1E24;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.cart-info { flex: 1; }
.cart-items-text { color: rgba(255,255,255,0.55); font-size: 11px; font-weight: 500; }
.cart-total { color: white; font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
.cart-total .currency { font-size: 13px; font-weight: 600; }
.cart-submit {
  background: var(--primary); color: white; border: none;
  height: 48px; padding: 0 22px; border-radius: 14px;
  font-size: 14px; font-weight: 700; cursor: pointer;
  font-family: inherit; transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  display: flex; align-items: center; gap: 6px; white-space: nowrap;
  letter-spacing: 0.3px;
}
.cart-submit:hover { filter: brightness(1.08); transform: translateY(-1px); }
.cart-submit:active { transform: scale(0.97); }
.cart-submit:disabled { background: #3A3A42; cursor: not-allowed; box-shadow: none; }

/* ===== CART DRAWER ===== */
.cart-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.45); backdrop-filter: blur(6px);
  opacity: 0; visibility: hidden; transition: all 0.3s;
}
.cart-overlay.show { opacity: 1; visibility: visible; }
.cart-drawer {
  position: fixed; bottom: 0; left: 0; right: 0;
  z-index: 201; background: var(--bg-card);
  border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  max-height: 70vh; overflow: hidden;
  transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.32,0.72,0,1);
  display: flex; flex-direction: column;
  box-shadow: 0 -8px 32px rgba(0,0,0,0.12);
}
.cart-drawer.show { transform: translateY(0); }
.drawer-handle {
  width: 40px; height: 4px; background: var(--border);
  border-radius: 2px; margin: 12px auto 8px;
}
.drawer-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 4px 22px 16px; border-bottom: 1px solid var(--border-light);
}
.drawer-header h3 { font-size: 17px; font-weight: 800; }
.drawer-clear {
  font-size: 13px; color: var(--text-muted); cursor: pointer;
  background: none; border: none; font-family: inherit;
  padding: 6px 12px; border-radius: 8px; transition: all 0.2s;
  font-weight: 500;
}
.drawer-clear:hover { background: rgba(0,0,0,0.04); color: var(--primary); }
.drawer-items { flex: 1; overflow-y: auto; padding: 8px 22px; }
.drawer-item {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 0; border-bottom: 1px solid var(--border-light);
}
.drawer-item:last-child { border-bottom: none; }
.drawer-item-img {
  width: 56px; height: 56px; border-radius: var(--radius-sm);
  object-fit: cover; background: linear-gradient(135deg, #f5f0eb, #ebe5de);
}
.drawer-item-info { flex: 1; }
.drawer-item-name { font-size: 14px; font-weight: 700; }
.drawer-item-size { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.drawer-item-price { font-size: 15px; font-weight: 800; color: var(--primary); margin-top: 2px; }
.drawer-item-qty {
  display: flex; align-items: center; gap: 0;
  border: 1.5px solid var(--border); border-radius: 12px; overflow: hidden;
}
.drawer-qty-btn {
  width: 30px; height: 30px; border: none;
  background: transparent; font-size: 15px; font-weight: 700;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.15s; font-family: inherit;
}
.drawer-qty-btn:hover { background: rgba(0,0,0,0.04); }
.drawer-qty-num { width: 26px; text-align: center; font-size: 14px; font-weight: 800; }
.drawer-footer {
  padding: 16px 22px calc(16px + var(--safe-bottom));
  border-top: 1px solid var(--border-light); background: var(--bg-card);
}
.drawer-total-row {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;
}
.drawer-total-label { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
.drawer-total-price { font-size: 24px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
.drawer-submit {
  width: 100%; height: 52px; border: none; border-radius: var(--radius-md);
  background: var(--primary); color: white;
  font-size: 16px; font-weight: 700; cursor: pointer;
  font-family: inherit; transition: all 0.2s;
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  letter-spacing: 0.3px;
}
.drawer-submit:active { transform: scale(0.98); }

/* ===== ITEM DETAIL MODAL ===== */
.item-modal-overlay {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,0.55); backdrop-filter: blur(6px);
  opacity: 0; visibility: hidden; transition: all 0.3s;
  display: flex; align-items: flex-end; justify-content: center;
}
.item-modal-overlay.show { opacity: 1; visibility: visible; }
.item-modal {
  background: var(--bg-card); border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  width: 100%; max-height: 88vh; overflow: hidden;
  transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.32,0.72,0,1);
  display: flex; flex-direction: column;
  box-shadow: 0 -8px 40px rgba(0,0,0,0.15);
}
.item-modal-overlay.show .item-modal { transform: translateY(0); }
.modal-img {
  width: 100%; height: 260px; object-fit: cover;
  background: linear-gradient(135deg, #f5f0eb, #ebe5de);
}
.modal-close {
  position: absolute; top: 16px; right: 16px;
  width: 36px; height: 36px; border-radius: 12px;
  background: rgba(0,0,0,0.35); color: white; border: none;
  font-size: 18px; cursor: pointer; backdrop-filter: blur(8px);
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.modal-close:hover { background: rgba(0,0,0,0.55); }
.modal-body { padding: 22px; overflow-y: auto; flex: 1; }
.modal-name { font-size: 22px; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.3px; }
.modal-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.7; margin-bottom: 20px; }
.modal-option-group { margin-bottom: 18px; }
.modal-option-title {
  font-size: 14px; font-weight: 700; margin-bottom: 10px;
  display: flex; align-items: center; gap: 8px;
}
.modal-option-title .required {
  font-size: 10px; background: var(--primary); color: white;
  padding: 2px 8px; border-radius: 6px; font-weight: 700;
}
.modal-options { display: flex; flex-wrap: wrap; gap: 8px; }
.modal-opt-btn {
  padding: 10px 18px; border: 1.5px solid var(--border);
  border-radius: var(--radius-sm); background: var(--bg);
  font-size: 13px; cursor: pointer; transition: all 0.2s;
  font-family: inherit; font-weight: 600;
}
.modal-opt-btn:hover { border-color: var(--primary); background: #fff; }
.modal-opt-btn.active {
  border-color: var(--primary); color: var(--primary);
  background: rgba(232,67,10,0.05);
  box-shadow: 0 0 0 3px rgba(232,67,10,0.06);
}
/* ÂâØÈ§êÂúñÁâáÂç°ÁâáÊ®°Âºè */
.modal-options.has-images {
  display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
}
.modal-opt-card {
  border: 1.5px solid var(--border); border-radius: var(--radius-md);
  overflow: hidden; cursor: pointer; transition: all 0.2s;
  background: var(--bg-card); position: relative;
}
.modal-opt-card:active { transform: scale(0.97); }
.modal-opt-card.active {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(232,67,10,0.08);
}
.modal-opt-card .opt-card-img {
  width: 100%; height: 80px; object-fit: cover;
  background: linear-gradient(135deg, #f5f0eb, #ebe5de);
  display: block;
}
.modal-opt-card .opt-card-info {
  padding: 8px 10px 10px;
}
.modal-opt-card .opt-card-name {
  font-size: 12px; font-weight: 700; margin-bottom: 3px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.modal-opt-card .opt-card-price {
  font-size: 13px; font-weight: 800; color: var(--primary);
}
.modal-opt-card .opt-card-check {
  position: absolute; top: 6px; right: 6px;
  width: 22px; height: 22px; border-radius: 50%;
  background: rgba(255,255,255,0.85); border: 1.5px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; color: transparent; transition: all 0.2s;
  backdrop-filter: blur(4px);
}
.modal-opt-card.active .opt-card-check {
  background: var(--primary); border-color: var(--primary);
  color: white;
}
.modal-footer {
  padding: 16px 22px calc(16px + var(--safe-bottom));
  border-top: 1px solid var(--border-light);
  display: flex; align-items: center; gap: 14px;
  background: var(--bg-card);
}
.modal-price { font-size: 26px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
.modal-price .currency { font-size: 14px; }
.modal-qty-area { display: flex; align-items: center; gap: 0; }
.modal-add-cart {
  flex: 1; height: 50px; border: none; border-radius: var(--radius-md);
  background: var(--primary); color: white;
  font-size: 15px; font-weight: 700; cursor: pointer;
  font-family: inherit; transition: all 0.2s;
  box-shadow: 0 4px 14px rgba(0,0,0,0.12);
  letter-spacing: 0.3px;
}
.modal-add-cart:active { transform: scale(0.97); }

/* ===== EMPTY STATE ===== */
.empty-state {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 60px 30px; text-align: center;
}
.empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.4; }
.empty-title { font-size: 16px; font-weight: 700; color: var(--text-secondary); margin-bottom: 4px; }
.empty-desc { font-size: 13px; color: var(--text-muted); }

/* ===== FLY DOT ANIMATION ===== */
.fly-dot {
  position: fixed; z-index: 999;
  width: 14px; height: 14px; border-radius: 50%;
  background: var(--primary); pointer-events: none;
  transition: all 0.55s cubic-bezier(0.2, 0.8, 0.2, 1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* ===== LANGUAGE SWITCHER (Â§öË™ûÂàáÊèõ) ===== */
.lang-btn {
  background: rgba(255,255,255,0.18); padding: 4px 10px;
  border-radius: 20px; font-size: 11px; font-weight: 600;
  color: #FFF; cursor: pointer; backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.12);
  font-family: inherit; transition: all 0.2s;
}
.lang-btn:active { transform: scale(0.95); }
.lang-menu {
  position: fixed; top: 50px; right: 16px; z-index: 200;
  background: var(--bg-card); border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl); border: 1px solid var(--border-light);
  padding: 6px; min-width: 150px;
  opacity: 0; visibility: hidden; transform: translateY(-8px) scale(0.95);
  transition: all 0.2s cubic-bezier(0.32,0.72,0,1);
}
.lang-menu.show {
  opacity: 1; visibility: visible; transform: translateY(0) scale(1);
}
.lang-menu-item {
  display: flex; align-items: center; gap: 10px;
  width: 100%; padding: 11px 14px; border: none;
  background: transparent; border-radius: var(--radius-sm);
  font-size: 14px; cursor: pointer; font-family: inherit;
  color: var(--text-primary); transition: background 0.15s;
}
.lang-menu-item:hover { background: var(--border-light); }
.lang-menu-item.active { color: var(--primary); font-weight: 700; }
.lang-menu-item .lang-flag { font-size: 18px; }
.lang-menu-item .lang-check {
  margin-left: auto; color: var(--primary); font-size: 16px;
  display: none;
}
.lang-menu-item.active .lang-check { display: block; }

/* translated item name secondary */
.item-name-translated {
  font-size: 11px; color: var(--text-muted); font-weight: 400;
  margin-top: 1px; line-height: 1.3;
  display: -webkit-box; -webkit-line-clamp: 1;
  -webkit-box-orient: vertical; overflow: hidden;
}

/* ===== AI SMART RECOMMENDATIONS (Êô∫ÊÖßÊé®Ëñ¶) ===== */
.smart-rec-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px; margin: 8px 14px 0;
  background: linear-gradient(135deg, rgba(232,67,10,0.06), rgba(255,184,0,0.06));
  border-radius: var(--radius-md); border: 1px solid rgba(232,67,10,0.1);
  overflow-x: auto; scrollbar-width: none;
}
.smart-rec-bar::-webkit-scrollbar { display: none; }
.smart-rec-chip {
  flex-shrink: 0; display: flex; align-items: center; gap: 6px;
  padding: 6px 14px; border-radius: 20px;
  background: var(--bg-card); border: 1px solid var(--border-light);
  font-size: 12px; font-weight: 600; cursor: pointer;
  transition: all 0.2s; white-space: nowrap;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}
.smart-rec-chip:active { transform: scale(0.95); }
.smart-rec-chip.highlight {
  background: var(--primary); color: white;
  border-color: var(--primary); box-shadow: 0 2px 8px rgba(232,67,10,0.2);
}
.smart-rec-chip .rec-emoji { font-size: 14px; }

.smart-rec-section {
  margin: 12px 14px 0; padding: 14px 16px;
  background: var(--bg-card); border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm); border: 1px solid var(--border-light);
}
.smart-rec-title {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 12px;
}
.smart-rec-title .rec-ai-badge {
  font-size: 10px; font-weight: 700; padding: 3px 8px;
  border-radius: 6px; background: linear-gradient(135deg, #667eea, #764ba2);
  color: white; letter-spacing: 0.5px;
}
.smart-rec-title h4 { font-size: 14px; font-weight: 700; }
.smart-rec-title .rec-reason {
  font-size: 11px; color: var(--text-muted); margin-left: auto;
}
.smart-rec-items {
  display: flex; gap: 10px; overflow-x: auto;
  padding-bottom: 4px; scrollbar-width: none;
}
.smart-rec-items::-webkit-scrollbar { display: none; }
.smart-rec-item {
  flex-shrink: 0; width: 110px; cursor: pointer;
  transition: all 0.2s; text-align: center;
}
.smart-rec-item:active { transform: scale(0.96); }
.smart-rec-item-img {
  width: 100%; height: 80px; border-radius: var(--radius-sm);
  object-fit: cover; background: linear-gradient(135deg, #f5f0eb, #ebe5de);
  margin-bottom: 6px; display: block;
}
.smart-rec-item-name {
  font-size: 12px; font-weight: 600;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.smart-rec-item-price {
  font-size: 14px; font-weight: 800; color: var(--primary);
}

/* ===== UPSELL SECTION (ÁµêÂ∏≥ÂâçÂä†Ë≥ºÊé®Ëñ¶) ===== */
.upsell-section {
  margin: 16px 0 10px; padding: 16px 0 4px;
  border-top: 1.5px dashed var(--border);
}
.upsell-header {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 12px; padding: 0 2px;
}
.upsell-header .upsell-icon { font-size: 18px; }
.upsell-header h4 {
  font-size: 14px; font-weight: 700; color: var(--text-primary);
  letter-spacing: -0.2px;
}
.upsell-header .upsell-hint {
  font-size: 11px; color: var(--text-muted); margin-left: auto;
}
.upsell-scroll {
  display: flex; gap: 10px; overflow-x: auto;
  padding-bottom: 8px; scrollbar-width: none;
}
.upsell-scroll::-webkit-scrollbar { display: none; }
.upsell-card {
  flex-shrink: 0; width: 120px; background: var(--bg-card);
  border-radius: var(--radius-md); overflow: hidden;
  border: 1px solid var(--border-light); cursor: pointer;
  transition: all 0.2s; position: relative;
}
.upsell-card:active { transform: scale(0.96); }
.upsell-card-img {
  width: 100%; height: 80px; object-fit: cover;
  background: linear-gradient(135deg, #f5f0eb, #ebe5de);
}
.upsell-card-info { padding: 8px 10px 10px; }
.upsell-card-name {
  font-size: 12px; font-weight: 600; margin-bottom: 4px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.upsell-card-price {
  font-size: 14px; font-weight: 800; color: var(--primary);
}
.upsell-card-add {
  position: absolute; bottom: 8px; right: 8px;
  width: 26px; height: 26px; border-radius: 8px;
  background: var(--primary); color: white; border: none;
  font-size: 16px; cursor: pointer; display: flex;
  align-items: center; justify-content: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

/* ===== VIEW MODE TOGGLE (Â§ßÂúñ/ÂàóË°®ÂàáÊèõ) ===== */
.view-toggle {
  display: flex; gap: 4px; margin-left: auto;
  background: var(--border-light); border-radius: 8px; padding: 2px;
}
.view-toggle-btn {
  width: 28px; height: 28px; border: none; border-radius: 6px;
  background: transparent; cursor: pointer; font-size: 14px;
  display: flex; align-items: center; justify-content: center;
  color: var(--text-muted); transition: all 0.2s;
}
.view-toggle-btn.active {
  background: var(--bg-card); color: var(--primary);
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
/* Â§ßÂúñÊ®°Âºè */
.menu-items.grid-view {
  display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
  padding: 8px 0;
}
.menu-items.grid-view .menu-item {
  flex-direction: column; gap: 0; padding: 0;
  border-bottom: none; border-radius: var(--radius-md);
  background: var(--bg-card); overflow: hidden;
  border: 1px solid var(--border-light);
  box-shadow: var(--shadow-sm); margin: 0;
}
.menu-items.grid-view .item-img-wrap {
  width: 100%; height: 120px; border-radius: 0;
  box-shadow: none;
}
.menu-items.grid-view .item-info {
  padding: 10px 12px 12px;
}
.menu-items.grid-view .item-desc { display: none; }
.menu-items.grid-view .item-tags { display: none; }
.menu-items.grid-view .item-sizes { display: none; }
.menu-items.grid-view .item-name {
  font-size: 13px; -webkit-line-clamp: 1; margin-bottom: 6px;
}
.menu-items.grid-view .item-bottom {
  flex-direction: row; align-items: center;
}
.menu-items.grid-view .item-price { font-size: 16px; }
.menu-items.grid-view .add-btn {
  width: 30px; height: 30px; font-size: 16px;
}

/* ===== TOAST ===== */
.toast {
  position: fixed; top: 56px; left: 50%; transform: translateX(-50%) translateY(-24px);
  z-index: 500; background: rgba(30,30,30,0.92); color: white;
  padding: 12px 24px; border-radius: 14px;
  font-size: 13px; font-weight: 600;
  opacity: 0; visibility: hidden; transition: all 0.35s cubic-bezier(0.32,0.72,0,1);
  box-shadow: 0 8px 32px rgba(0,0,0,0.18); white-space: nowrap;
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.08);
}
.toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }

/* ===== SEARCH BAR ===== */
.search-bar { padding: 12px 14px 8px; background: var(--bg); }
.search-input-wrap {
  display: flex; align-items: center; gap: 10px;
  background: var(--bg-card); border-radius: 12px;
  padding: 0 14px; height: 42px; border: 1.5px solid var(--border);
  transition: all 0.25s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.03);
}
.search-input-wrap:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(232,67,10,0.06); }
.search-input-wrap .icon { color: var(--text-muted); font-size: 14px; flex-shrink: 0; }
.search-input {
  flex: 1; border: none; outline: none; font-size: 14px;
  font-family: inherit; background: transparent; font-weight: 500;
}
.search-input::placeholder { color: var(--text-muted); font-weight: 400; }
.search-clear {
  width: 22px; height: 22px; border-radius: 50%;
  background: var(--border); border: none; font-size: 12px;
  cursor: pointer; display: none; align-items: center; justify-content: center;
  color: var(--text-muted); transition: all 0.15s;
}
.search-clear:hover { background: var(--primary); color: white; }
.search-clear.show { display: flex; }

/* ===== THEME PICKER ===== */
.theme-fab {
  position: fixed; top: 12px; right: 12px; z-index: 150;
  height: 40px; border-radius: 12px;
  background: rgba(0,0,0,0.5); backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.12);
  padding: 0 14px 0 12px;
  display: flex; align-items: center; gap: 6px;
  cursor: pointer; font-size: 14px; transition: all 0.25s;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  color: #fff; font-weight: 600;
}
.theme-fab:hover { transform: scale(1.05); background: rgba(0,0,0,0.6); }
.theme-fab:active { transform: scale(0.95); }
.theme-fab-icon { font-size: 17px; display: flex; }
.theme-fab-label { font-size: 12px; font-weight: 700; letter-spacing: 0.5px; }
.theme-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.45); backdrop-filter: blur(4px);
  display: none; align-items: flex-end; justify-content: center;
}
.theme-overlay.show { display: flex; }
.theme-panel {
  background: var(--bg-card); border-radius: 24px 24px 0 0;
  padding: 20px 20px calc(24px + env(safe-area-inset-bottom, 0px));
  width: 100%; max-width: 480px; max-height: 80vh; overflow-y: auto;
  box-shadow: 0 -8px 40px rgba(0,0,0,0.15);
  animation: slideUpPanel 0.35s cubic-bezier(0.32,0.72,0,1);
}
@keyframes slideUpPanel { from { transform: translateY(100%); } to { transform: translateY(0); } }
.theme-panel-handle { width: 40px; height: 4px; border-radius: 2px; background: var(--border); margin: 0 auto 16px; }
.theme-panel h4 { font-size: 18px; font-weight: 800; margin-bottom: 4px; color: var(--text-primary); text-align: center; letter-spacing: -0.3px; }
.theme-panel-sub { font-size: 12px; color: var(--text-muted); text-align: center; margin-bottom: 16px; }
.theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.theme-card {
  position: relative; border-radius: 14px; padding: 14px 8px 10px;
  cursor: pointer; transition: all 0.25s ease; text-align: center;
  border: 2.5px solid transparent;
}
.theme-card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
.theme-card.active {
  border-color: var(--primary);
  box-shadow: 0 0 0 2px var(--primary), 0 4px 16px rgba(0,0,0,0.1);
}
.theme-card.active::after {
  content: '\2713'; position: absolute; top: 6px; right: 6px;
  width: 20px; height: 20px; border-radius: 50%;
  background: var(--primary); color: #fff;
  font-size: 11px; font-weight: 700; line-height: 20px; text-align: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
.theme-card-dots { display: flex; gap: 5px; justify-content: center; margin-bottom: 8px; }
.theme-card-dot {
  width: 22px; height: 22px; border-radius: 7px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.12);
}
.theme-card-name { font-size: 12px; font-weight: 700; color: #444; letter-spacing: -0.2px; }
.theme-card-dark .theme-card-name { color: #ddd; }

/* ===== RESPONSIVE ===== */
@media (min-width: 480px) {
  body { max-width: 480px; margin: 0 auto; box-shadow: -1px 0 0 #eee, 1px 0 0 #eee; min-height: 100vh; }
}

/* ===== ANIMATIONS ===== */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-in { animation: fadeInUp 0.4s ease-out both; }
.menu-item { animation: fadeInUp 0.35s ease-out both; }
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-logo">&#x1F37D;&#xFE0F;</div>
  <div class="loading-text">ËºâÂÖ•ËèúÂñÆ‰∏≠<span class="loading-dots"></span></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- LANGUAGE MENU -->
<div class="lang-menu" id="langMenu">
  <button class="lang-menu-item active" onclick="setLanguage('zh')" data-lang="zh">
    <span class="lang-flag">üáπüáº</span> ‰∏≠Êñá <span class="lang-check">‚úì</span>
  </button>
  <button class="lang-menu-item" onclick="setLanguage('en')" data-lang="en">
    <span class="lang-flag">üá∫üá∏</span> English <span class="lang-check">‚úì</span>
  </button>
  <button class="lang-menu-item" onclick="setLanguage('ja')" data-lang="ja">
    <span class="lang-flag">üáØüáµ</span> Êó•Êú¨Ë™û <span class="lang-check">‚úì</span>
  </button>
  <button class="lang-menu-item" onclick="setLanguage('ko')" data-lang="ko">
    <span class="lang-flag">üá∞üá∑</span> ÌïúÍµ≠Ïñ¥ <span class="lang-check">‚úì</span>
  </button>
  <button class="lang-menu-item" onclick="setLanguage('vi')" data-lang="vi">
    <span class="lang-flag">üáªüá≥</span> Ti·∫øng Vi·ªát <span class="lang-check">‚úì</span>
  </button>
  <button class="lang-menu-item" onclick="setLanguage('th')" data-lang="th">
    <span class="lang-flag">üáπüá≠</span> ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ <span class="lang-check">‚úì</span>
  </button>
</div>

<!-- THEME PICKER -->
<div class="theme-fab" id="themeFab" onclick="toggleThemePanel()">
  <span class="theme-fab-icon">&#x1F3A8;</span>
  <span class="theme-fab-label">È¢®Ê†º</span>
</div>
<div class="theme-overlay" id="themeOverlay" onclick="if(event.target===this)closeThemePanel()">
  <div class="theme-panel" id="themePanel"></div>
</div>

<!-- ===== BRAND HERO (DM) ===== -->
<div class="brand-hero" id="brandHero">
  <img class="brand-hero-img" id="brandHeroImg" src="" alt="">
  <div class="brand-hero-name" id="brandHeroName"></div>
  <div class="brand-hero-tagline" id="brandHeroTagline"></div>
</div>

<!-- ===== SHOP HEADER ===== -->
<header class="shop-header" id="shopHeader">
  <div class="header-status-bar">
    <span id="headerTitle">ÊéÉÁ¢ºÈªûÈ§ê</span>
    <div style="display:flex;align-items:center;gap:8px;">
      <button class="lang-btn" id="langBtn" onclick="toggleLangMenu()">üåê ‰∏≠</button>
      <span class="badge open" id="shopStatus">ÁáüÊ•≠‰∏≠</span>
      <a class="share-btn" id="shareBtn" onclick="shareOrder()" style="display:none;">&#x1F4E4; ÂàÜ‰∫´Ë®ÇÂñÆ</a>
    </div>
  </div>
  <div class="shop-info">
    <div class="shop-name-row">
      <div class="shop-logo" id="shopLogo">&#x1F37D;&#xFE0F;</div>
      <div>
        <div class="shop-name" id="shopName">ÊùæËæ£Ê§í</div>
        <div class="shop-subtitle" id="shopSubtitle">ÂÇ≥Áµ±Á∂ìÂÖ∏Âè∞ÂºèÁÜ±ÁÇíÁæéÈ£ü</div>
      </div>
    </div>
    <div class="shop-details">
      <div class="detail-row"><span class="icon">&#x1F4CD;</span><span id="shopAddress">Âè∞‰∏≠Â∏ÇË•øÂçÄÁ≤æË™†Ë∑Ø 88 Ëôü</span></div>
      <div class="detail-row"><span class="icon">&#x1F4DE;</span><span id="shopPhone">04-2310-8888</span></div>
      <div class="detail-row"><span class="icon">&#x1F550;</span><span id="shopHours">11:00 - 22:00</span></div>
    </div>
  </div>
</header>

<!-- ===== TABLE / GUEST SELECTOR ===== -->
<div class="table-selector" id="tableSelector">
  <h3>&#9745; ÈÅ∏ÊìáÊ°åËôü / Áî®È§ê‰∫∫Êï∏</h3>
  <div class="table-row">
    <span class="table-label">Ê°åËôü</span>
    <input type="text" class="table-input" id="tableNumber" placeholder="Ëº∏ÂÖ•Ê°åËôü" maxlength="10">
  </div>
  <div class="table-row">
    <span class="table-label">‰∫∫Êï∏</span>
    <div class="guest-selector" id="guestSelector">
      <button class="guest-btn" data-num="1">1</button>
      <button class="guest-btn" data-num="2">2</button>
      <button class="guest-btn active" data-num="3">3</button>
      <button class="guest-btn" data-num="4">4</button>
      <button class="guest-btn" data-num="5">5</button>
      <button class="guest-btn" data-num="6">6</button>
      <button class="guest-btn-more" onclick="promptGuestCount()">&#8943;</button>
    </div>
  </div>
  <!-- ÂúòÈ´îÈªûÈ§êÂÖ•Âè£ -->
  <div class="group-order-entry" id="groupOrderEntry" style="display:none;">
    <div class="table-row" style="border-top:1px dashed var(--border);padding-top:12px;margin-top:8px;">
      <span class="table-label">Â§ö‰∫∫</span>
      <div style="display:flex;gap:8px;flex:1;">
        <button class="group-start-btn" id="groupStartBtn" onclick="startGroupOrder()">üë• ÈñãÂïüÂúòÈ´îÈªûÈ§ê</button>
        <button class="group-join-btn" id="groupJoinBtn" onclick="showJoinGroup()" style="display:none;">üîó Âä†ÂÖ•</button>
      </div>
    </div>
  </div>
</div>

<!-- GROUP ORDER PANEL (ÂúòÈ´îÈªûÈ§êÈù¢Êùø) -->
<div class="group-panel" id="groupPanel" style="display:none;">
  <div class="group-panel-header">
    <div class="group-panel-title">üë• ÂúòÈ´îÈªûÈ§ê‰∏≠</div>
    <div class="group-panel-session" id="groupSessionInfo"></div>
    <button class="group-panel-close" onclick="leaveGroupOrder()">‚úï</button>
  </div>
  <div class="group-members" id="groupMembers"></div>
  <div class="group-panel-actions">
    <button class="group-invite-btn" onclick="shareGroupLink()">üì§ ÈÇÄË´ãÊúãÂèãÂä†ÂÖ•</button>
  </div>
</div>

<!-- ===== MEMBERSHIP / PHONE ===== -->
<div id="memberSection" style="display:none;margin:0 16px 8px;background:var(--bg-card);border-radius:12px;padding:12px 14px;box-shadow:var(--shadow-sm);">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
    <span style="font-size:18px;">üéØ</span>
    <span style="font-weight:700;font-size:14px;">ÊúÉÂì°ÈõÜÈªû</span>
    <span id="memberPoints" style="margin-left:auto;font-size:13px;color:var(--text-secondary);"></span>
  </div>
  <div style="display:flex;gap:8px;">
    <input type="tel" id="memberPhone" placeholder="ÊâãÊ©üËôüÁ¢ºÔºàÈõÜÈªûÁî®Ôºâ" maxlength="10" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px;">
    <button onclick="checkMemberPoints()" style="padding:8px 14px;border:none;border-radius:10px;background:var(--primary);color:#fff;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;">Êü•ÈªûÊï∏</button>
  </div>
  <div id="memberInfo" style="display:none;margin-top:8px;padding:8px;background:rgba(0,0,0,0.03);border-radius:8px;font-size:12px;color:var(--text-secondary);"></div>
</div>

<!-- ===== SEARCH BAR ===== -->
<div class="search-bar">
  <div class="search-input-wrap">
    <span class="icon">&#9740;</span>
    <input type="text" class="search-input" id="searchInput" placeholder="ÊêúÂ∞ãËèúÂìÅÂêçÁ®±...">
    <button class="search-clear" id="searchClear" onclick="clearSearch()">&#10005;</button>
  </div>
</div>

<!-- ===== MAIN LAYOUT ===== -->
<div class="menu-container" id="menuContainer">
  <nav class="category-sidebar" id="categorySidebar"></nav>
  <main class="menu-content" id="menuContent"></main>
</div>

<!-- ===== BOTTOM CART BAR ===== -->
<!-- ===== SERVICE CALL (ÊúçÂãôÂëºÂè´) ===== -->
<div class="service-call-fab" id="serviceCallFab" style="display:none;">
  <button class="service-fab-btn" onclick="toggleServiceMenu()">üîî</button>
  <div class="service-menu" id="serviceMenu">
    <button class="service-menu-item" onclick="sendServiceCall('water')">üíß Âä†Ê∞¥</button>
    <button class="service-menu-item" onclick="sendServiceCall('utensils')">üç¥ Âä†È§êÂÖ∑</button>
    <button class="service-menu-item" onclick="sendServiceCall('napkin')">üßª Âä†Á¥ôÂ∑æ</button>
    <button class="service-menu-item" onclick="sendServiceCall('staff')">üôã ÂëºÂè´ÊúçÂãôÂì°</button>
  </div>
</div>

<div class="cart-bar hidden" id="cartBar">
  <div class="cart-inner">
    <div class="cart-icon-wrap" onclick="toggleCartDrawer()">
      <div class="cart-icon">&#9635;</div>
      <span class="cart-count" id="cartCount">0</span>
    </div>
    <div class="cart-info">
      <div class="cart-items-text" id="cartItemsText">Â∑≤ÈÅ∏ 0 ‰ª∂</div>
      <div class="cart-total"><span class="currency">$</span><span id="cartTotal">0</span></div>
    </div>
    <button class="cart-submit" id="cartSubmit" onclick="submitOrder()">ÈÄÅÂá∫Ë®ÇÂñÆ &#8594;</button>
  </div>
</div>

<!-- ===== CART DRAWER ===== -->
<div class="cart-overlay" id="cartOverlay" onclick="toggleCartDrawer()"></div>
<div class="cart-drawer" id="cartDrawer">
  <div class="drawer-handle"></div>
  <div class="drawer-header">
    <h3>&#9635; Â∑≤ÈÅ∏ËèúÂìÅ</h3>
    <button class="drawer-clear" onclick="clearCart()">Ê∏ÖÁ©∫</button>
  </div>
  <div class="drawer-items" id="drawerItems"></div>
  <div class="drawer-footer">
    <div class="drawer-total-row">
      <span class="drawer-total-label">ÂêàË®à</span>
      <span class="drawer-total-price"><span class="currency">$</span><span id="drawerTotal">0</span></span>
    </div>
    <button class="drawer-submit" onclick="submitOrder()">ÈÄÅÂá∫Ë®ÇÂñÆÔºà<span id="drawerCount">0</span> ‰ª∂Ôºâ</button>
  </div>
</div>

<!-- ===== ITEM DETAIL MODAL ===== -->
<div class="item-modal-overlay" id="itemModalOverlay" onclick="closeItemModal(event)">
  <div class="item-modal" onclick="event.stopPropagation()">
    <img class="modal-img" id="modalImg" src="" alt="">
    <button class="modal-close" onclick="closeItemModal()">&#10005;</button>
    <div class="modal-body">
      <div class="modal-name" id="modalName"></div>
      <div class="modal-desc" id="modalDesc"></div>
      <div id="modalOptions"></div>
    </div>
    <div class="modal-footer">
      <div class="modal-price"><span class="currency">$</span><span id="modalPrice">0</span></div>
      <div class="modal-qty-area">
        <div class="qty-control">
          <button class="qty-btn minus" onclick="modalQtyChange(-1)">&#8722;</button>
          <span class="qty-num" id="modalQty">1</span>
          <button class="qty-btn" onclick="modalQtyChange(1)">+</button>
        </div>
      </div>
      <button class="modal-add-cart" onclick="modalAddToCart()">Âä†ÂÖ•Ë≥ºÁâ©Ëªä</button>
    </div>
  </div>
</div>

<script>
// ===== CONFIG =====
const SUPABASE_URL = 'https://nssuisyvlrqnqfxupklb.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3Vpc3l2bHJxbnFmeHVwa2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTAwMzUsImV4cCI6MjA4NDg2NjAzNX0.q_B6v3gf1TOCuAq7z0xIw10wDueCSJn0p37VzdMfmbc';

// ===== THEME SYSTEM =====
const THEMES = {
  // --- ÊöñËâ≤Á≥ª ---
  fire:    { name: 'ÁÜ±ÊÉÖÊ©òÁ¥Ö', group: 'warm', primary: '#E8430A', primaryLight: '#FF6B35', primaryDark: '#C23508', accent: '#FFB800', accentLight: '#FFD466', bg: '#F5F0EB', bgCard: '#FFFFFF', bgSidebar: '#FAFAFA', textPrimary: '#1A1A1A', textSecondary: '#666666', textMuted: '#999999', border: '#E8E8E8', borderLight: '#F0F0F0', headerGrad: 'linear-gradient(135deg,#E8430A 0%,#C23508 50%,#8B1A00 100%)' },
  rose:    { name: 'Áé´Áë∞ÂÖ∏ÈõÖ', group: 'warm', primary: '#E11D48', primaryLight: '#FB7185', primaryDark: '#BE123C', accent: '#F59E0B', accentLight: '#FCD34D', bg: '#FFF5F7', bgCard: '#FFF0F3', bgSidebar: '#FFF8FA', textPrimary: '#2E1A1E', textSecondary: '#7A5060', textMuted: '#B08090', border: '#F0D8DF', borderLight: '#F8E8EE', headerGrad: 'linear-gradient(135deg,#E11D48 0%,#9F1239 50%,#7F1D3A 100%)' },
  coral:   { name: 'ÁèäÁëöÁîúÊ©ô', group: 'warm', primary: '#F97066', primaryLight: '#FCA5A5', primaryDark: '#DC2626', accent: '#FBBF24', accentLight: '#FDE68A', bg: '#FFF7F5', bgCard: '#FFF3F0', bgSidebar: '#FFFAF9', textPrimary: '#1F1717', textSecondary: '#7A5A5A', textMuted: '#B09090', border: '#F0E0DD', borderLight: '#F8EEEC', headerGrad: 'linear-gradient(135deg,#F97066 0%,#E74C3C 50%,#C0392B 100%)' },
  amber:   { name: 'Áê•ÁèÄÈáëÈªÉ', group: 'warm', primary: '#D97706', primaryLight: '#F59E0B', primaryDark: '#B45309', accent: '#EF4444', accentLight: '#FCA5A5', bg: '#FFFBEB', bgCard: '#FFF8E0', bgSidebar: '#FFFDF5', textPrimary: '#1C1408', textSecondary: '#78600A', textMuted: '#A09060', border: '#F0E6C8', borderLight: '#F8F0DD', headerGrad: 'linear-gradient(135deg,#D97706 0%,#B45309 50%,#8B4000 100%)' },
  cherry:  { name: 'Ê´ªËä±Á≤âÂ´©', group: 'warm', primary: '#EC4899', primaryLight: '#F472B6', primaryDark: '#DB2777', accent: '#A855F7', accentLight: '#C084FC', bg: '#FDF2F8', bgCard: '#FFF0F6', bgSidebar: '#FFF5F9', textPrimary: '#2E1A28', textSecondary: '#8A5070', textMuted: '#C090A8', border: '#F5D0E0', borderLight: '#FAE8F0', headerGrad: 'linear-gradient(135deg,#EC4899 0%,#DB2777 40%,#BE185D 100%)' },
  // --- ÂÜ∑Ëâ≤Á≥ª ---
  indigo:  { name: 'ÈùõËóçÁ∂ìÂÖ∏', group: 'cool', primary: '#4F46E5', primaryLight: '#6366F1', primaryDark: '#3730A3', accent: '#F59E0B', accentLight: '#FCD34D', bg: '#F0F0FF', bgCard: '#EEEEFF', bgSidebar: '#F8F8FF', textPrimary: '#1A1A2E', textSecondary: '#5B5B7A', textMuted: '#9090A8', border: '#E0E0F0', borderLight: '#F0F0F8', headerGrad: 'linear-gradient(135deg,#4F46E5 0%,#3730A3 50%,#2E1E80 100%)' },
  ocean:   { name: 'Êµ∑Ê¥ãÊ∏ÖÊñ∞', group: 'cool', primary: '#0891B2', primaryLight: '#22D3EE', primaryDark: '#0E7490', accent: '#F59E0B', accentLight: '#FCD34D', bg: '#F0F9FF', bgCard: '#E8F4FA', bgSidebar: '#F5FBFF', textPrimary: '#1A2530', textSecondary: '#506A7A', textMuted: '#90B0C0', border: '#D0E8F0', borderLight: '#E8F4F8', headerGrad: 'linear-gradient(135deg,#0891B2 0%,#0E7490 40%,#164E63 100%)' },
  sky:     { name: 'Â§©Á©∫ËîöËóç', group: 'cool', primary: '#2563EB', primaryLight: '#3B82F6', primaryDark: '#1D4ED8', accent: '#F59E0B', accentLight: '#FCD34D', bg: '#F0F5FF', bgCard: '#E8F0FF', bgSidebar: '#F5F8FF', textPrimary: '#1A2040', textSecondary: '#506080', textMuted: '#90A0B8', border: '#D0DCF0', borderLight: '#E8EEF8', headerGrad: 'linear-gradient(135deg,#2563EB 0%,#1D4ED8 50%,#1E3A8A 100%)' },
  violet:  { name: 'Â§¢ÂπªÁ¥´ÁæÖ', group: 'cool', primary: '#7C3AED', primaryLight: '#A78BFA', primaryDark: '#6D28D9', accent: '#F472B6', accentLight: '#FBCFE8', bg: '#F5F0FF', bgCard: '#F0EAFF', bgSidebar: '#FAF5FF', textPrimary: '#1A1030', textSecondary: '#6A5080', textMuted: '#A090B8', border: '#E0D0F0', borderLight: '#F0E8F8', headerGrad: 'linear-gradient(135deg,#7C3AED 0%,#6D28D9 40%,#4C1D95 100%)' },
  teal:    { name: 'ÈùíÁ¢ßÈõÖËá¥', group: 'cool', primary: '#0D9488', primaryLight: '#14B8A6', primaryDark: '#0F766E', accent: '#F59E0B', accentLight: '#FCD34D', bg: '#F0FDFA', bgCard: '#E6FAF5', bgSidebar: '#F5FEFC', textPrimary: '#1A2E2A', textSecondary: '#4A706A', textMuted: '#80AAA0', border: '#C8E8E4', borderLight: '#E0F5F0', headerGrad: 'linear-gradient(135deg,#0D9488 0%,#0F766E 50%,#115E59 100%)' },
  // --- Ëá™ÁÑ∂Á≥ª ---
  forest:  { name: 'Ê£ÆÁ∂†Ëá™ÁÑ∂', group: 'nature', primary: '#059669', primaryLight: '#10B981', primaryDark: '#047857', accent: '#F59E0B', accentLight: '#FCD34D', bg: '#F0FAF4', bgCard: '#E8F5EE', bgSidebar: '#F5FBF8', textPrimary: '#1A2E1A', textSecondary: '#4A6A4A', textMuted: '#8AAA8A', border: '#D0E8D0', borderLight: '#E8F5E8', headerGrad: 'linear-gradient(135deg,#059669 0%,#047857 50%,#064E3B 100%)' },
  earth:   { name: 'Â§ßÂú∞Ê£ïË™ø', group: 'nature', primary: '#92400E', primaryLight: '#B45309', primaryDark: '#78350F', accent: '#059669', accentLight: '#34D399', bg: '#FAF5F0', bgCard: '#F5EDE4', bgSidebar: '#FBF8F5', textPrimary: '#1C1510', textSecondary: '#6A5A48', textMuted: '#A09080', border: '#E8DDD0', borderLight: '#F0EAE0', headerGrad: 'linear-gradient(135deg,#92400E 0%,#78350F 50%,#5C2A0A 100%)' },
  olive:   { name: 'Ê©ÑÊ¨ñÁî∞Âúí', group: 'nature', primary: '#65A30D', primaryLight: '#84CC16', primaryDark: '#4D7C0F', accent: '#EAB308', accentLight: '#FDE047', bg: '#F7FEE7', bgCard: '#F0FADB', bgSidebar: '#FBFFF0', textPrimary: '#1A2E10', textSecondary: '#4A6A30', textMuted: '#88AA68', border: '#D4E8B8', borderLight: '#E8F5D8', headerGrad: 'linear-gradient(135deg,#65A30D 0%,#4D7C0F 50%,#365314 100%)' },
  sand:    { name: 'Ê≤ôÊº†ÊöñÈôΩ', group: 'nature', primary: '#CA8A04', primaryLight: '#EAB308', primaryDark: '#A16207', accent: '#DC2626', accentLight: '#F87171', bg: '#FEFCE8', bgCard: '#FEF9C3', bgSidebar: '#FFFDE6', textPrimary: '#1C1A08', textSecondary: '#78720A', textMuted: '#A0980A', border: '#F0E8A0', borderLight: '#F8F0C8', headerGrad: 'linear-gradient(135deg,#CA8A04 0%,#A16207 50%,#854D0E 100%)' },
  // --- ÁâπËâ≤Á≥ª ---
  sunset:  { name: 'Â§ïÈôΩÊôöÈúû', group: 'special', primary: '#E44D26', primaryLight: '#F97316', primaryDark: '#C2410C', accent: '#A855F7', accentLight: '#C084FC', bg: '#FEF3EC', bgCard: '#FFEDE0', bgSidebar: '#FFF8F3', textPrimary: '#2A1510', textSecondary: '#7A5040', textMuted: '#B08878', border: '#F0D8C8', borderLight: '#F8EAE0', headerGrad: 'linear-gradient(135deg,#F97316 0%,#E44D26 30%,#9333EA 100%)' },
  candy:   { name: 'Á≥ñÊûúÁπΩÁ¥õ', group: 'special', primary: '#D946EF', primaryLight: '#E879F9', primaryDark: '#C026D3', accent: '#06B6D4', accentLight: '#67E8F9', bg: '#FDF4FF', bgCard: '#FAE8FF', bgSidebar: '#FEF5FF', textPrimary: '#2A1030', textSecondary: '#7A4890', textMuted: '#A878C0', border: '#E8D0F8', borderLight: '#F5E8FC', headerGrad: 'linear-gradient(135deg,#D946EF 0%,#C026D3 40%,#7C3AED 100%)' },
  matcha:  { name: 'ÊäπËå∂ÊãøÈêµ', group: 'special', primary: '#4D7C0F', primaryLight: '#65A30D', primaryDark: '#3F6212', accent: '#92400E', accentLight: '#B45309', bg: '#F5F5DC', bgCard: '#FAFAE0', bgSidebar: '#F8F8E0', textPrimary: '#1A1A10', textSecondary: '#5A5A30', textMuted: '#8A8A60', border: '#E0E0B8', borderLight: '#ECECD0', headerGrad: 'linear-gradient(135deg,#4D7C0F 0%,#3F6212 40%,#365314 100%)' },
  cafe:    { name: 'ÂíñÂï°ÊôÇÂÖâ', group: 'special', primary: '#78350F', primaryLight: '#92400E', primaryDark: '#5C2A0A', accent: '#D97706', accentLight: '#F59E0B', bg: '#FAF5F0', bgCard: '#F5EBE0', bgSidebar: '#FBF6F0', textPrimary: '#1A1210', textSecondary: '#6A5848', textMuted: '#9A8878', border: '#E0D4C4', borderLight: '#F0E8D8', headerGrad: 'linear-gradient(135deg,#78350F 0%,#5C2A0A 40%,#451A03 100%)' },
  wine:    { name: 'Á¥ÖÈÖíÂ•¢ËèØ', group: 'special', primary: '#881337', primaryLight: '#BE185D', primaryDark: '#6B0F2A', accent: '#D4A574', accentLight: '#E8C9A8', bg: '#FBF5F5', bgCard: '#FFF5F5', bgSidebar: '#FDF8F8', textPrimary: '#1A0E12', textSecondary: '#6A4050', textMuted: '#A08090', border: '#E8D0D8', borderLight: '#F5E8EE', headerGrad: 'linear-gradient(135deg,#881337 0%,#6B0F2A 50%,#4A0A1E 100%)' },
  sakura:  { name: 'Êó•ÂºèÂíåÈ¢®', group: 'special', primary: '#C2185B', primaryLight: '#E91E63', primaryDark: '#880E4F', accent: '#4DB6AC', accentLight: '#80CBC4', bg: '#FFF8FA', bgCard: '#FFF0F4', bgSidebar: '#FFFBFC', textPrimary: '#2D1520', textSecondary: '#7A4560', textMuted: '#B08898', border: '#F0D0DC', borderLight: '#F8E4EC', headerGrad: 'linear-gradient(135deg,#C2185B 0%,#880E4F 50%,#560027 100%)' },
  // --- ÊöóËâ≤Á≥ª ---
  midnight:{ name: 'ÂçàÂ§úÊ∑±ÈÇÉ', group: 'dark', dark: true, primary: '#6366F1', primaryLight: '#818CF8', primaryDark: '#4F46E5', accent: '#FBBF24', accentLight: '#FDE68A', bg: '#0F1117', bgCard: '#181B25', bgSidebar: '#12141C', textPrimary: '#E8EAF0', textSecondary: '#8A8FA8', textMuted: '#5A5F78', border: '#262A38', borderLight: '#1E2230', headerGrad: 'linear-gradient(160deg,#1A1D2E 0%,#0F1117 100%)' },
  charcoal:{ name: 'Á¢≥ÈªëË≥™ÊÑü', group: 'dark', dark: true, primary: '#10B981', primaryLight: '#34D399', primaryDark: '#059669', accent: '#F59E0B', accentLight: '#FBBF24', bg: '#111111', bgCard: '#1A1A1A', bgSidebar: '#151515', textPrimary: '#E5E5E5', textSecondary: '#888888', textMuted: '#555555', border: '#2A2A2A', borderLight: '#222222', headerGrad: 'linear-gradient(160deg,#1A1A1A 0%,#111111 100%)' },
  darkocean:{ name: 'Ê∑±Êµ∑ÂπΩËóç', group: 'dark', dark: true, primary: '#06B6D4', primaryLight: '#22D3EE', primaryDark: '#0891B2', accent: '#F472B6', accentLight: '#FBCFE8', bg: '#0B1120', bgCard: '#111828', bgSidebar: '#0E1520', textPrimary: '#E0E8F0', textSecondary: '#7090AA', textMuted: '#406080', border: '#1C2838', borderLight: '#162030', headerGrad: 'linear-gradient(160deg,#111828 0%,#0B1120 100%)' },
  darkrose:{ name: 'ÊöóÂ§úÁé´Áë∞', group: 'dark', dark: true, primary: '#F43F5E', primaryLight: '#FB7185', primaryDark: '#E11D48', accent: '#A78BFA', accentLight: '#C4B5FD', bg: '#110B10', bgCard: '#1A1218', bgSidebar: '#140E12', textPrimary: '#F0E0E8', textSecondary: '#A07888', textMuted: '#684858', border: '#2A1E28', borderLight: '#221820', headerGrad: 'linear-gradient(160deg,#1A1218 0%,#110B10 100%)' },
  noir:    { name: 'Ê•µËá¥Á¥îÈªë', group: 'dark', dark: true, primary: '#E2E8F0', primaryLight: '#F1F5F9', primaryDark: '#CBD5E1', accent: '#FBBF24', accentLight: '#FDE68A', bg: '#000000', bgCard: '#0A0A0A', bgSidebar: '#050505', textPrimary: '#F0F0F0', textSecondary: '#808080', textMuted: '#484848', border: '#1A1A1A', borderLight: '#121212', headerGrad: 'linear-gradient(160deg,#0A0A0A 0%,#000000 100%)' },
};

function applyTheme(name) {
  const t = THEMES[name];
  if (!t) return;
  const r = document.documentElement.style;
  r.setProperty('--primary', t.primary);
  r.setProperty('--primary-light', t.primaryLight);
  r.setProperty('--primary-dark', t.primaryDark);
  r.setProperty('--accent', t.accent);
  r.setProperty('--accent-light', t.accentLight);
  r.setProperty('--bg', t.bg);
  r.setProperty('--bg-card', t.bgCard);
  r.setProperty('--bg-sidebar', t.bgSidebar);
  r.setProperty('--text-primary', t.textPrimary);
  r.setProperty('--text-secondary', t.textSecondary);
  r.setProperty('--text-muted', t.textMuted);
  r.setProperty('--border', t.border);
  r.setProperty('--border-light', t.borderLight);
  // Header gradient
  if (t.headerGrad) {
    r.setProperty('--header-gradient', t.headerGrad);
  }
  // Dark theme: update shadows for dark backgrounds
  if (t.dark) {
    r.setProperty('--shadow-sm', '0 1px 4px rgba(0,0,0,0.2)');
    r.setProperty('--shadow-md', '0 4px 16px rgba(0,0,0,0.3)');
    r.setProperty('--shadow-lg', '0 8px 30px rgba(0,0,0,0.35)');
    r.setProperty('--shadow-xl', '0 16px 48px rgba(0,0,0,0.4)');
  } else {
    r.setProperty('--shadow-sm', '0 1px 4px rgba(0,0,0,0.05)');
    r.setProperty('--shadow-md', '0 4px 16px rgba(0,0,0,0.07)');
    r.setProperty('--shadow-lg', '0 8px 30px rgba(0,0,0,0.10)');
    r.setProperty('--shadow-xl', '0 16px 48px rgba(0,0,0,0.14)');
  }
  // Menu cards use theme bg
  document.querySelectorAll('.menu-card, .featured-card').forEach(function(el) {
    el.style.background = t.bgCard;
    if (t.dark) el.style.borderColor = t.border;
  });
  document.querySelector('meta[name="theme-color"]')?.setAttribute('content', t.primary);
  currentTheme = name;
  try { localStorage.setItem('selectedTheme', name); } catch(e) {}
  // Update theme panel active state if open
  document.querySelectorAll('.theme-card').forEach(function(c) {
    c.classList.toggle('active', c.getAttribute('onclick')?.includes("'" + name + "'"));
  });
}

let currentTheme = 'fire';

function toggleThemePanel() {
  var overlay = document.getElementById('themeOverlay');
  if (!overlay.classList.contains('show')) renderThemePanel();
  overlay.classList.toggle('show');
}
function closeThemePanel() {
  document.getElementById('themeOverlay').classList.remove('show');
}

function renderThemePanel() {
  var groups = [
    { key: 'warm',    label: '\u{2600}\u{FE0F} \u6EAB\u6696\u7CFB' },
    { key: 'cool',    label: '\u{2744}\u{FE0F} \u6E05\u6DBC\u7CFB' },
    { key: 'nature',  label: '\u{1F33F} \u81EA\u7136\u7CFB' },
    { key: 'special', label: '\u{2728} \u7279\u8272\u7CFB' },
    { key: 'dark',    label: '\u{1F30C} \u6697\u8272\u7CFB' }
  ];
  var html = '<div class="theme-panel-handle"></div>' +
    '<h4>\u{1F3A8} \u9078\u64C7\u98A8\u683C</h4>' +
    '<div class="theme-panel-sub">\u9078\u64C7\u559C\u6B61\u7684\u914D\u8272\uFF0C\u81EA\u52D5\u5132\u5B58</div>';
  groups.forEach(function(g) {
    html += '<div style="font-size:12px;font-weight:700;color:var(--text-secondary);margin:12px 0 6px;padding-left:4px;">' + g.label + '</div><div class="theme-grid">';
    Object.entries(THEMES).forEach(function(entry) {
      var key = entry[0], t = entry[1];
      if (t.group !== g.key) return;
      var cardBg = t.dark ? t.bgCard : t.bg;
      var isDark = t.dark ? ' theme-card-dark' : '';
      html += '<div class="theme-card' + (key === currentTheme ? ' active' : '') + isDark + '" ' +
        'style="background:' + cardBg + ';" onclick="applyTheme(\'' + key + '\')">' +
        '<div style="height:28px;border-radius:8px;margin-bottom:8px;' + (t.headerGrad ? 'background:' + t.headerGrad : 'background:' + t.primary) + ';"></div>' +
        '<div class="theme-card-dots">' +
          '<div class="theme-card-dot" style="background:' + t.primary + ';"></div>' +
          '<div class="theme-card-dot" style="background:' + t.primaryLight + ';"></div>' +
          '<div class="theme-card-dot" style="background:' + t.accent + ';"></div>' +
        '</div>' +
        '<div class="theme-card-name">' + t.name + '</div></div>';
    });
    html += '</div>';
  });
  // È†êË¶ΩÊ®°ÂºèÊâçÈ°ØÁ§∫ÂÑ≤Â≠òÊåâÈàï
  if (!window._orderMode) {
    html += '<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);">' +
      '<button onclick="saveThemeToStore()" style="width:100%;padding:12px;border:none;border-radius:12px;background:var(--primary);color:#fff;font-weight:700;font-size:14px;cursor:pointer;">üíæ ÂÑ≤Â≠òÁÇ∫ÂïÜÂ∫óÈ¢®Ê†º</button>' +
      '<div style="font-size:11px;color:var(--text-muted);text-align:center;margin-top:6px;">ÂÑ≤Â≠òÂæåÊâÄÊúâÊ∂àË≤ªËÄÖÈÉΩÊúÉÁúãÂà∞Ê≠§È¢®Ê†º</div></div>';
  }
  document.getElementById('themePanel').innerHTML = html;
}

// Apply store theme ‚Äî ÊîØÊè¥‰∏ªÈ°å keyÔºàÂ¶Ç "fire"ÔºâÊàñ hex Ëâ≤Á¢ºÔºàÂ¶Ç "#E8430A"Ôºâ
function applyStoreThemeColor(val) {
  // Ê∞∏ÈÅ†Â•óÁî® DB ÂÑ≤Â≠òÁöÑÈ¢®Ê†ºÔºåÁ¢∫‰øùÈ†êË¶ΩÂíåÊ∂àË≤ªËÄÖÁúãÂà∞‰∏ÄËá¥ÁöÑÁµêÊûú
  // Â¶ÇÊûúÂÄºÊòØ‰∏ªÈ°å keyÔºåÁõ¥Êé•Â•óÁî®
  if (THEMES[val]) { applyTheme(val); return; }
  // 3. Hex Ëâ≤Á¢ºÔºöÊâæÊúÄÊé•ËøëÁöÑÂÖßÂª∫‰∏ªÈ°å
  var bestKey = null, bestDist = Infinity;
  Object.entries(THEMES).forEach(function(entry) {
    var d = colorDistance(val, entry[1].primary);
    if (d < bestDist) { bestDist = d; bestKey = entry[0]; }
  });
  if (bestDist < 80) { applyTheme(bestKey); return; }
  // 4. ÁÑ°ÂåπÈÖçÔºöÁõ¥Êé•Â•óÁî®Ëâ≤Á¢º
  var r = document.documentElement.style;
  r.setProperty('--primary', val);
  r.setProperty('--primary-light', adjustBrightness(val, 30));
  r.setProperty('--primary-dark', adjustBrightness(val, -30));
}
function colorDistance(a, b) {
  var ra = parseInt(a.slice(1,3),16), ga = parseInt(a.slice(3,5),16), ba = parseInt(a.slice(5,7),16);
  var rb = parseInt(b.slice(1,3),16), gb = parseInt(b.slice(3,5),16), bb = parseInt(b.slice(5,7),16);
  return Math.sqrt((ra-rb)*(ra-rb)+(ga-gb)*(ga-gb)+(ba-bb)*(ba-bb));
}
function adjustBrightness(hex, amount) {
  var r = Math.max(0,Math.min(255,parseInt(hex.slice(1,3),16)+amount));
  var g = Math.max(0,Math.min(255,parseInt(hex.slice(3,5),16)+amount));
  var b = Math.max(0,Math.min(255,parseInt(hex.slice(5,7),16)+amount));
  return '#' + [r,g,b].map(function(c){return c.toString(16).padStart(2,'0');}).join('');
}

// Save theme to store (Supabase) ‚Äî Â≠ò‰∏ªÈ°å keyÔºåÁ¢∫‰øùÊâÄÊúâ‰∫∫ÁúãÂà∞ÂêåÊ®£È¢®Ê†º
async function saveThemeToStore() {
  var t = THEMES[currentTheme];
  if (!t || !currentStoreId) { showToast('ÁÑ°Ê≥ïÂÑ≤Â≠òÔºöÊú™ÈÄ£Êé•ÂïÜÂ∫ó'); return; }
  try {
    var res = await fetch(SUPABASE_URL + '/rest/v1/store_profiles?id=eq.' + currentStoreId, {
      method: 'PATCH',
      headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
      body: JSON.stringify({ theme_color: currentTheme })
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    showToast('‚úÖ È¢®Ê†ºÂ∑≤ÂÑ≤Â≠òÔºÅÊâÄÊúâÊ∂àË≤ªËÄÖÂ∞áÁúãÂà∞„Äå' + t.name + '„Äç');
    closeThemePanel();
  } catch(e) {
    showToast('‚ùå ÂÑ≤Â≠òÂ§±Êïó: ' + e.message);
  }
}

// Close theme panel on ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeThemePanel();
});

// ===== UTILS =====
function escHtml(s) { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#x27;'); }

// ===== STATE =====
let currentStoreId = null;
let shopInfo = {};
let categories = [];
let menuItems = [];
let cart = [];
let activeCategory = null;
let modalItem = null;
let modalQtyVal = 1;
let modalSelectedSize = null;
let guestCount = 3;
let isScrollingByClick = false;
let loyaltyConfig = null;
let memberPointsData = null;
let _toastTimer = null;

// ===== EMOJI ICONS (ES6 \u{} safe encoding) =====
const ICONS = {
  restaurant: '\u{1F37D}\u{FE0F}',  // üçΩÔ∏è
  search:     '\u{1F50D}',           // üîç
  phone:      '\u{1F4DE}',           // üìû
  pin:        '\u{1F4CD}',           // üìç
  clock:      '\u{1F550}',           // üïê
  fire:       '\u{1F525}',           // üî•
  cart:       '\u{1F6D2}',           // üõí
  trash:      '\u{1F5D1}',           // üóë
  bell:       '\u{1F514}',           // üîî
  chili:      '\u{1F336}\u{FE0F}',  // üå∂Ô∏è
  star:       '\u{2B50}',            // ‚≠ê
  noodle:     '\u{1F35C}',           // üçú
  salad:      '\u{1F957}',           // ü•ó
  curry:      '\u{1F35B}',           // üçõ
  chicken:    '\u{1F357}',           // üçó
  pig:        '\u{1F969}',           // ü•©
  beef:       '\u{1F404}',           // üêÑ
  fish:       '\u{1F41F}',           // üêü
  soup:       '\u{1F372}',           // üç≤
  leaf:       '\u{1F96C}',           // ü•¨
  rice:       '\u{1F35A}',           // üçö
  drink:      '\u{1F964}',           // ü•§
  empty:      '\u{1F371}',           // üç±
  check:      '\u{2705}',            // ‚úÖ
};

// ===== DEMO DATA (Êú¨Á±≥ Benmi ËèúÂñÆ) =====
const DEMO_CATEGORIES = [
  { id: 'bread',  name: 'È∫µÂåÖÂñÆÈªû', icon: '\u{1F956}', sort: 1 },
  { id: 'setL',   name: 'Â§ßÂ•óÈ§ê',   icon: '\u{1F371}', sort: 2 },
  { id: 'setM',   name: 'Â∞èÂ•óÈ§ê',   icon: '\u{1F371}', sort: 3 },
  { id: 'drink',  name: 'È£≤Êñô',     icon: '\u{1F964}', sort: 4 },
  { id: 'addon',  name: 'Âä†Êñô',     icon: '\u{2795}',  sort: 5 },
];

const DEMO_ITEMS = [
  // È∫µÂåÖÂñÆÈªû
  { id: 1, name: 'ÁáíËÇâÈ∫µÂåÖ', desc: 'Braised pork / Th·ªãt ngu·ªôi', price: 80, category: 'bread', image: '', tags: ['Êé®Ëñ¶'], featured: true, sizes: [{name:'Mini',price:56},{name:'L-SIZE',price:80}] },
  { id: 2, name: 'ÁÅ´ËÖøÈ∫µÂåÖ', desc: 'Ham / Ch·∫£', price: 80, category: 'bread', image: '', tags: [], sizes: [{name:'Mini',price:56},{name:'L-SIZE',price:80}] },
  { id: 3, name: 'ÈõûËÇâÈ∫µÂåÖ', desc: 'Chicken / Th·ªãt g√†', price: 100, category: 'bread', image: '', tags: [], sizes: [{name:'Mini',price:68},{name:'L-SIZE',price:100}] },
  { id: 4, name: 'ÁÉ§ËÇâÈ∫µÂåÖ', desc: 'Grilled Meat / Th·ªãt n∆∞·ªõng', price: 105, category: 'bread', image: '', tags: [], sizes: [{name:'Mini',price:72},{name:'L-SIZE',price:105}] },
  { id: 5, name: 'ÈõôÂ±§ÁÉ§ËÇâÈ∫µÂåÖ', desc: 'Double Cheesebanhmi / Th·ªãt n∆∞·ªõng ph√¥ mai', price: 115, category: 'bread', image: '', tags: ['Êé®Ëñ¶'], featured: true, sizes: [{name:'Mini',price:78},{name:'L-SIZE',price:115}] },
  { id: 6, name: 'Á∂úÂêàÈ∫µÂåÖ', desc: 'Mixed / Th·∫≠p c·∫©m', price: 130, category: 'bread', image: '', tags: [], sizes: [{name:'Mini',price:79},{name:'L-SIZE',price:130}] },
  // Â§ßÂ•óÈ§ê SET L-SIZE
  { id: 7,  name: 'Set 1 ÁáíËÇâ+È£≤Êñô', desc: 'L-SIZE ÁáíËÇâÈ∫µÂåÖ+È£≤Êñô', price: 90, category: 'setL', image: '', tags: ['Â•óÈ§ê'] },
  { id: 8,  name: 'Set 2 ÁÅ´ËÖø+È£≤Êñô', desc: 'L-SIZE ÁÅ´ËÖøÈ∫µÂåÖ+È£≤Êñô', price: 90, category: 'setL', image: '', tags: ['Â•óÈ§ê'] },
  { id: 9,  name: 'Set 3 ÈõûËÇâ+È£≤Êñô', desc: 'L-SIZE ÈõûËÇâÈ∫µÂåÖ+È£≤Êñô', price: 118, category: 'setL', image: '', tags: ['Â•óÈ§ê'] },
  { id: 10, name: 'Set 4 ÁÉ§ËÇâ+È£≤Êñô', desc: 'L-SIZE ÁÉ§ËÇâÈ∫µÂåÖ+È£≤Êñô', price: 128, category: 'setL', image: '', tags: ['Â•óÈ§ê'] },
  { id: 11, name: 'Set 5 ÈõôÂ±§ÁÉ§ËÇâ+È£≤Êñô', desc: 'L-SIZE ÈõôÂ±§ÁÉ§ËÇâÈ∫µÂåÖ+È£≤Êñô', price: 135, category: 'setL', image: '', tags: ['Â•óÈ§ê'] },
  { id: 12, name: 'Set 6 Á∂úÂêà+È£≤Êñô', desc: 'L-SIZE Á∂úÂêàÈ∫µÂåÖ+È£≤Êñô', price: 142, category: 'setL', image: '', tags: ['Â•óÈ§ê'] },
  // Â∞èÂ•óÈ§ê SET Mini
  { id: 13, name: 'Set 7 ÁáíËÇâ/ÁÅ´ËÖø+È£≤Êñô', desc: 'Mini ÁáíËÇâÊàñÁÅ´ËÖøÈ∫µÂåÖ+È£≤Êñô', price: 77, category: 'setM', image: '', tags: ['Â•óÈ§ê'] },
  { id: 14, name: 'Set 8 ÈõûËÇâ+È£≤Êñô', desc: 'Mini ÈõûËÇâÈ∫µÂåÖ+È£≤Êñô', price: 88, category: 'setM', image: '', tags: ['Â•óÈ§ê'] },
  { id: 15, name: 'Set 9 ÁÉ§ËÇâ+È£≤Êñô', desc: 'Mini ÁÉ§ËÇâÈ∫µÂåÖ+È£≤Êñô', price: 95, category: 'setM', image: '', tags: ['Â•óÈ§ê'] },
  { id: 16, name: 'Set 10 ÈõôÂ±§ÁÉ§ËÇâ+È£≤Êñô', desc: 'Mini ÈõôÂ±§ÁÉ§ËÇâÈ∫µÂåÖ+È£≤Êñô', price: 99, category: 'setM', image: '', tags: ['Â•óÈ§ê'] },
  { id: 17, name: 'Set 11 Á∂úÂêà+È£≤Êñô', desc: 'Mini Á∂úÂêàÈ∫µÂåÖ+È£≤Êñô', price: 100, category: 'setM', image: '', tags: ['Â•óÈ§ê'] },
  // È£≤Êñô
  { id: 18, name: 'Ë∂äÂçóÂíñÂï°', desc: 'C√† ph√™ s·ªØa / Coffee with Condensed Milk', price: 48, category: 'drink', image: '', tags: ['Êé®Ëñ¶'], featured: true },
  { id: 19, name: 'Ë±ÜÊºø', desc: 'S·ªØa ƒë·∫≠u n√†nh / Soy Milk', price: 37, category: 'drink', image: '', tags: [] },
  { id: 20, name: 'Á¥ÖËå∂', desc: 'H·ªìng tr√† / Black Tea', price: 37, category: 'drink', image: '', tags: [] },
  { id: 21, name: 'ÂèØÊ®Ç/Èõ™Á¢ß', desc: 'Cocacola / Sprite', price: 37, category: 'drink', image: '', tags: [] },
  // Âä†Êñô
  { id: 22, name: 'Âä†Ëµ∑Âè∏', desc: 'Cheese / Ph√¥ mai', price: 15, category: 'addon', image: '', tags: [] },
  { id: 23, name: 'Âä†ÁÅ´ËÖø', desc: 'Ham / Ch·∫£ l·ª•a', price: 20, category: 'addon', image: '', tags: [] },
  { id: 24, name: 'Âä†ÁáíËÇâ', desc: 'Braised Meat / Th·ªãt ngu·ªôi', price: 20, category: 'addon', image: '', tags: [] },
  { id: 25, name: 'Âä†ÁÉ§ËÇâ', desc: 'Grilled Meat / Th·ªãt n∆∞·ªõng', price: 25, category: 'addon', image: '', tags: [] },
  { id: 26, name: 'Âä†ÈõûËÇâ', desc: 'Chicken / Th·ªãt g√†', price: 25, category: 'addon', image: '', tags: [] },
];

// ===== INITIALIZE =====
document.addEventListener('DOMContentLoaded', () => { initApp(); });

async function initApp() {
  const params = new URLSearchParams(window.location.search);
  const storeSlug = params.get('store');

  // ÂÖàË®≠ÂÆöÊ®°ÂºèÔºåËÆì applyStoreThemeColor Áü•ÈÅìÊòØÂê¶ÁÇ∫Ê∂àË≤ªËÄÖÊ®°Âºè
  const mode = params.get('mode');   // 'dine-in' | 'takeout'
  const tbl = params.get('table');
  window._orderMode = mode || (tbl ? 'dine-in' : null);

  // Apply theme (URL param > localStorage > default) ‚Äî Âø´ÈÄüÈ°ØÁ§∫ÔºåÁ≠â DB ËºâÂÖ•ÂæåÂÜçË¶ÜËìã
  const urlTheme = params.get('theme');
  const savedTheme = localStorage.getItem('selectedTheme');
  applyTheme(urlTheme || savedTheme || 'fire');

  try {
    if (storeSlug) {
      await loadStoreFromSupabase(storeSlug);
    } else {
      loadDemoData();
    }
  } catch (e) {
    console.warn('Supabase load failed, using demo data:', e);
    loadDemoData();
  }

  renderSidebar();
  renderMenuContent();
  setupScrollSpy();
  setupSearch();
  setupGuestSelector();
  initServiceCall();
  loadSharedCart();
  initGroupOrder();
  hookGroupOrderToCart();
  initSmartRecommendations();
  initLanguage();

  // Ê∂àË≤ªËÄÖÊ®°ÂºèÔºàÊúâ mode ÂèÉÊï∏ÔºâÈö±ËóèÈ¢®Ê†ºÈÅ∏ÊìáÊåâÈàïÔºõÈ†êË¶ΩÊ®°ÂºèÈ°ØÁ§∫
  if (mode) {
    document.getElementById('themeFab').style.display = 'none';
  }

  if (mode === 'takeout') {
    // Â§ñÂ∏∂ÔºöÈö±ËóèÊ°åËôü/‰∫∫Êï∏ÂçÄÂ°ä
    document.getElementById('tableSelector').style.display = 'none';
    // Â§ñÂ∏∂Ê®°ÂºèËèúÂñÆÂçÄÂüüÂä†È´òÔºàÊ°åËôüÂçÄÂ°äÈö±ËóèÂæåÁ©∫ÈñìÂõûÊî∂Ôºâ
    document.getElementById('menuContainer').style.height = 'calc(100dvh - 170px)';
    // È°ØÁ§∫Â§ñÂ∏∂Ê®ôÁ±§
    var badge = document.createElement('div');
    badge.style.cssText = 'text-align:center;padding:8px;margin:8px 16px;background:#FEF3C7;border-radius:10px;font-size:13px;font-weight:700;color:#B45309;';
    badge.textContent = '\u{1F6CD}\u{FE0F} Â§ñÂ∏∂ÈªûÈ§ê';
    document.getElementById('tableSelector').parentNode.insertBefore(badge, document.getElementById('tableSelector'));
  } else if (tbl) {
    // ÂÖßÁî®ÔºöËá™ÂãïÂ∏∂ÂÖ•Ê°åËôüÔºåÈéñÂÆö
    document.getElementById('tableNumber').value = tbl;
    document.getElementById('tableNumber').readOnly = true;
    document.getElementById('tableNumber').style.background = '#F1F5F9';
    // È°ØÁ§∫ÂÖßÁî®Ê®ôÁ±§
    var h3 = document.querySelector('#tableSelector h3');
    if (h3) h3.innerHTML = '\u{1F37D}\u{FE0F} ÂÖßÁî® \u2014 Ê°åËôü ' + escHtml(tbl);
  }

  setTimeout(() => { document.getElementById('loadingScreen').classList.add('hide'); }, 600);
}

async function loadStoreFromSupabase(slug) {
  const headers = { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' };

  // 1. Êü•ÊâæÂïÜÂ∫ó
  const storeRes = await fetch(SUPABASE_URL + '/rest/v1/store_profiles?store_slug=eq.' + encodeURIComponent(slug) + '&limit=1', { headers });
  const storeData = await storeRes.json();
  if (!storeData || storeData.length === 0) throw new Error('Store not found: ' + slug);

  const store = storeData[0];
  currentStoreId = store.id;

  // Êõ¥Êñ∞ÂïÜÂ∫ó header
  shopInfo = {
    name: store.store_name || '',
    subtitle: store.description || '',
    address: store.address || '',
    phone: store.phone || '',
    hours: '',
    logo: store.logo_url || ''
  };
  // Ëß£ÊûêÁáüÊ•≠ÊôÇÈñì
  if (store.business_hours && typeof store.business_hours === 'object') {
    const bh = store.business_hours;
    const dayNames = { mon:'ÈÄ±‰∏Ä', tue:'ÈÄ±‰∫å', wed:'ÈÄ±‰∏â', thu:'ÈÄ±Âõõ', fri:'ÈÄ±‰∫î', sat:'ÈÄ±ÂÖ≠', sun:'ÈÄ±Êó•' };
    const parts = [];
    Object.keys(dayNames).forEach(function(d) {
      if (bh[d] && bh[d].open !== false && (bh[d].start || bh[d].close)) {
        var st = bh[d].start || bh[d].open || '';
        var en = bh[d].end || bh[d].close || '';
        if (st && en) parts.push(dayNames[d] + ' ' + st + '-' + en);
      }
    });
    if (parts.length > 0) shopInfo.hours = parts.join(' / ');
  }
  updateShopHeader(shopInfo);

  // ÂìÅÁâåÂΩ¢Ë±° DM
  renderBrandHero(store);

  // Â•óÁî®ÂïÜÂ∫ó‰∏ªÈ°åËâ≤
  if (store.theme_color) {
    applyStoreThemeColor(store.theme_color);
  }

  // ‰∏çÊé•ÂèóË®ÇÂñÆÊôÇÈ°ØÁ§∫ÊèêÁ§∫
  if (store.accept_orders === false) {
    document.getElementById('shopSubtitle').textContent = '\u{1F534} ÁõÆÂâçÊö´ÂÅúÊé•ÂñÆ';
  }

  // ÊúÉÂì°ÈõÜÈªûË®≠ÂÆö
  loyaltyConfig = store.loyalty_config || null;
  if (loyaltyConfig && loyaltyConfig.spend_per_point) {
    document.getElementById('memberSection').style.display = '';
    // Âæû localStorage ÂõûÂ°´ÊâãÊ©ü
    const savedPhone = localStorage.getItem('member_phone_' + currentStoreId);
    if (savedPhone) {
      document.getElementById('memberPhone').value = savedPhone;
      checkMemberPoints();
    }
  }

  // 2. ËºâÂÖ•ÂàÜÈ°û
  const catRes = await fetch(SUPABASE_URL + '/rest/v1/menu_categories?store_id=eq.' + currentStoreId + '&is_active=eq.true&order=sort_order', { headers });
  const catData = await catRes.json();

  // ÂæûÂàÜÈ°ûÂêçÁ®±ÊèêÂèñ emoji ‰ΩúÁÇ∫ iconÔºå‰∏¶ÈÅéÊøæÊôÇÊÆµ
  var nowHHMM = new Date().toTimeString().slice(0, 5); // "HH:MM"
  categories = (catData || []).filter(function(c) {
    // Ëã•ÁÑ°Ë®≠ÂÆöÊôÇÊÆµÔºåÂÖ®Â§©È°ØÁ§∫
    if (!c.time_periods || !Array.isArray(c.time_periods) || c.time_periods.length === 0) return true;
    // Ê™¢Êü•ÊòØÂê¶Âú®‰ªª‰∏ÄÊôÇÊÆµÂÖß
    return c.time_periods.some(function(p) {
      if (p.from <= p.to) return nowHHMM >= p.from && nowHHMM <= p.to;
      return nowHHMM >= p.from || nowHHMM <= p.to;
    });
  }).map(function(c) {
    var icon = ICONS.star;
    var name = c.name;
    var emojiMatch = name.match(/^([\u{1F000}-\u{1FFFF}][\u{FE00}-\u{FE0F}]?|[\u{2600}-\u{27BF}]|[\u{2B00}-\u{2BFF}]|[\u{E000}-\u{F8FF}]|[\u2702-\u27B0]|‚ûï)\s*/u);
    if (emojiMatch) {
      icon = emojiMatch[1];
      name = name.substring(emojiMatch[0].length);
    }
    return { id: c.id, name: name, icon: icon, sort: c.sort_order };
  });

  // 3. ËºâÂÖ•ÂìÅÈ†Ö
  const itemRes = await fetch(SUPABASE_URL + '/rest/v1/menu_items?store_id=eq.' + currentStoreId + '&is_available=eq.true&order=sort_order', { headers });
  const itemData = await itemRes.json();

  menuItems = (itemData || []).map(function(i) {
    // Â∞á options ‰∏≠ÁöÑ„ÄåÂ∞∫ÂØ∏„Äçgroup ËΩâÁÇ∫ sizes Ê†ºÂºè
    var sizes = null;
    var opts = i.options || [];
    if (Array.isArray(opts)) {
      for (var g = 0; g < opts.length; g++) {
        if (opts[g].group === 'Â∞∫ÂØ∏' && Array.isArray(opts[g].items)) {
          sizes = opts[g].items.map(function(s) { return { name: s.name, price: s.price }; });
        }
      }
    }
    // Âà§Êñ∑ÊòØÂê¶ÁÇ∫Êé®Ëñ¶
    var tags = i.tags || [];
    var featured = tags.indexOf('Êé®Ëñ¶') >= 0;

    return {
      id: i.id, name: i.name, desc: i.description || '',
      price: i.price, category: i.category_id,
      image: i.image_url || '', tags: tags,
      spicy: 0, featured: featured, sizes: sizes,
      options: opts  // ‰øùÁïôÂÆåÊï¥ options ‰æõ modal ‰ΩøÁî®
    };
  });
}

function loadDemoData() {
  categories = DEMO_CATEGORIES.map(function(c) { return Object.assign({}, c, { id: String(c.id) }); });
  menuItems = DEMO_ITEMS.map(function(i) { return Object.assign({}, i, { id: String(i.id), category: String(i.category) }); });
}

function updateShopHeader(shop) {
  if (shop.name) document.getElementById('shopName').textContent = shop.name;
  if (shop.subtitle) document.getElementById('shopSubtitle').textContent = shop.subtitle;
  if (shop.address) document.getElementById('shopAddress').textContent = shop.address;
  if (shop.phone) document.getElementById('shopPhone').textContent = shop.phone;
  if (shop.hours) document.getElementById('shopHours').textContent = shop.hours;
  if (shop.logo) {
    var logoEl = document.getElementById('shopLogo');
    logoEl.innerHTML = '<img src="' + escHtml(shop.logo) + '" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">';
  }
}

function renderBrandHero(store) {
  var hero = document.getElementById('brandHero');
  var hasBanner = store.banner_url && store.banner_url.trim();
  var hasLogo = store.logo_url && store.logo_url.trim();
  if (!hasBanner && !hasLogo) return;

  var img = document.getElementById('brandHeroImg');

  if (hasBanner) {
    // Banner Ê®°ÂºèÔºöÂÖ®ÂØ¨Â§ßÂúñ
    hero.classList.add('mode-banner');
    img.src = store.banner_url;
    img.alt = store.store_name || '';
  } else if (hasLogo) {
    // Logo Ê®°ÂºèÔºöÂ±Ö‰∏≠ÂúìËßí logo + ÂìÅÁâåÂêçÁ®± + ÂâØÊ®ôÈ°å
    hero.classList.add('mode-logo');
    img.src = store.logo_url;
    img.alt = store.store_name || '';
    // Â°´ÂÖ•ÂìÅÁâåÂêçÁ®±
    var nameEl = document.getElementById('brandHeroName');
    if (nameEl && store.store_name) nameEl.textContent = store.store_name;
    var tagEl = document.getElementById('brandHeroTagline');
    if (tagEl && store.description) tagEl.textContent = store.description;
  }
  hero.classList.add('show');

  // Â¶ÇÊûúÊúâ BannerÔºåÈö±Ëóè‰∏ãÊñπÁöÑ shop-header ÈáçË§áË≥áË®äÔºàÈÅøÂÖçË¶ñË¶∫ÈáçË§áÔºâ
  // ‰∏çÈö±Ëóè ‚Äî ‰øùÁïô header ÁöÑÁáüÊ•≠Ë≥áË®ä

  // È°ØÁ§∫ÂàÜ‰∫´ÊåâÈàïÔºàÊîØÊè¥ Web Share API ÊàñÂâ™Ë≤ºÁ∞øË§áË£ΩÔºâ
  document.getElementById('shareBtn').style.display = 'inline-block';
}

// ===== MULTI-LANGUAGE TRANSLATION (Â§öË™ûÁøªË≠Ø) =====
var currentLang = 'zh';
var translationCache = {}; // { 'zh_en_ÁáíËÇâÈ∫µÂåÖ': 'Grilled Pork Sandwich' }

// UI Â≠ó‰∏≤ÁøªË≠ØË°®
var UI_STRINGS = {
  zh: {
    scanOrder: 'ÊéÉÁ¢ºÈªûÈ§ê', open: 'ÁáüÊ•≠‰∏≠', closed: '‰ºëÊÅØ‰∏≠', shareOrder: 'üì§ ÂàÜ‰∫´Ë®ÇÂñÆ',
    selectTable: '‚òë ÈÅ∏ÊìáÊ°åËôü / Áî®È§ê‰∫∫Êï∏', tableLabel: 'Ê°åËôü', guestLabel: '‰∫∫Êï∏',
    tablePlaceholder: 'Ëº∏ÂÖ•Ê°åËôü', featured: 'Êú¨Â∫óÂøÖÈªûÊé®Ëñ¶', popular: '‰∫∫Ê∞£Á≤æÈÅ∏',
    searchPlaceholder: 'ÊêúÂ∞ãËèúÂìÅ...', addToCart: 'Âä†ÂÖ•Ë≥ºÁâ©Ëªä', submitOrder: 'ÈÄÅÂá∫Ë®ÇÂñÆ',
    confirmOrder: 'Á¢∫Ë™çË®ÇÂñÆ', backEdit: 'ËøîÂõû‰øÆÊîπ', confirmSubmit: 'Á¢∫Ë™çÈÄÅÂá∫',
    dineIn: 'ÂÖßÁî®', takeout: 'Â§ñÂ∏∂', guest: '‰∫∫', items: '‰ª∂', total: 'ÂêàË®à',
    soldOut: 'Â∑≤ÂîÆÂÆå', required: 'ÂøÖÈÅ∏', portionSize: '‰ªΩÈáè', spicy: 'Ëæ£Â∫¶',
    noSpicy: '‰∏çËæ£', mildSpicy: 'Â∞èËæ£', medSpicy: '‰∏≠Ëæ£', hotSpicy: 'Â§ßËæ£',
    cartEmpty: 'Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ', cartEmptyHint: 'ÂéªÊåëÈÅ∏ÁæéÂë≥ËèúÂìÅÂêßÔºÅ',
    clearCart: 'Ê∏ÖÁ©∫', upsellTitle: 'Âà•‰∫∫‰πüÂä†‰∫ÜÈÄô‰∫õ', upsellHint: 'ÈªûÊìäÂä†ÂÖ•',
    orderSuccess: 'Ë®ÇÂñÆÂ∑≤ÈÄÅÂá∫ÔºÅ', orderNum: 'Ë®ÇÂñÆÁ∑®Ëôü', newOrder: 'ÂÜç‰æÜ‰∏ÄÂñÆ',
    groupOrder: 'ÈñãÂïüÂúòÈ´îÈªûÈ§ê', groupOrdering: 'ÂúòÈ´îÈªûÈ§ê‰∏≠', groupJoin: 'Âä†ÂÖ•',
    groupInvite: 'ÈÇÄË´ãÊúãÂèãÂä†ÂÖ•', groupLeave: 'Èõ¢Èñã', groupTotal: 'ÂúòÈ´îÂêàË®à',
    serviceWater: 'üíß Âä†Ê∞¥', serviceUtensils: 'üç¥ Âä†È§êÂÖ∑', serviceNapkin: 'üßª Âä†Á¥ôÂ∑æ', serviceStaff: 'üôã ÂëºÂè´ÊúçÂãôÂì°',
    serviceNotified: 'Â∑≤ÈÄöÁü•Â∫óÂì°ÔºÅ', aiRec: 'AI', complementRec: 'Êê≠ÈÖçÊé®Ëñ¶', popularRec: '‰∫∫Ê∞£ÂøÖÈªû',
    budgetRec: 'ÈäÖÊùøÁæéÈ£ü', upgradeRec: 'ÂçáÁ¥ö‰∫´Âèó'
  },
  en: {
    scanOrder: 'Scan to Order', open: 'Open', closed: 'Closed', shareOrder: 'üì§ Share',
    selectTable: '‚òë Table / Guests', tableLabel: 'Table', guestLabel: 'Guests',
    tablePlaceholder: 'Table No.', featured: 'Chef\'s Picks', popular: 'Popular',
    searchPlaceholder: 'Search menu...', addToCart: 'Add to Cart', submitOrder: 'Place Order',
    confirmOrder: 'Confirm Order', backEdit: 'Go Back', confirmSubmit: 'Confirm',
    dineIn: 'Dine-in', takeout: 'Takeout', guest: ' pax', items: ' items', total: 'Total',
    soldOut: 'Sold Out', required: 'Required', portionSize: 'Size', spicy: 'Spice Level',
    noSpicy: 'None', mildSpicy: 'Mild', medSpicy: 'Medium', hotSpicy: 'Hot',
    cartEmpty: 'Cart is empty', cartEmptyHint: 'Browse the menu!',
    clearCart: 'Clear', upsellTitle: 'Others also ordered', upsellHint: 'Tap to add',
    orderSuccess: 'Order placed!', orderNum: 'Order #', newOrder: 'Order Again',
    groupOrder: 'üë• Group Order', groupOrdering: 'Group Ordering', groupJoin: 'Join',
    groupInvite: 'Invite Friends', groupLeave: 'Leave', groupTotal: 'Group Total',
    serviceWater: 'üíß Water', serviceUtensils: 'üç¥ Utensils', serviceNapkin: 'üßª Napkins', serviceStaff: 'üôã Staff',
    serviceNotified: 'Staff notified!', aiRec: 'AI', complementRec: 'Pair With', popularRec: 'Popular',
    budgetRec: 'Budget Picks', upgradeRec: 'Upgrade'
  },
  ja: {
    scanOrder: 'QRÊ≥®Êñá', open: 'Âñ∂Ê•≠‰∏≠', closed: 'Ê∫ñÂÇô‰∏≠', shareOrder: 'üì§ ÂÖ±Êúâ',
    selectTable: '‚òë „ÉÜ„Éº„Éñ„É´ / ‰∫∫Êï∞', tableLabel: '„ÉÜ„Éº„Éñ„É´', guestLabel: '‰∫∫Êï∞',
    tablePlaceholder: '„ÉÜ„Éº„Éñ„É´Áï™Âè∑', featured: '„Åä„Åô„Åô„ÇÅ', popular: '‰∫∫Ê∞ó',
    searchPlaceholder: '„É°„Éã„É•„ÉºÊ§úÁ¥¢...', addToCart: '„Ç´„Éº„Éà„Å´ËøΩÂä†', submitOrder: 'Ê≥®Êñá„Åô„Çã',
    confirmOrder: 'Ê≥®ÊñáÁ¢∫Ë™ç', backEdit: 'Êàª„Çã', confirmSubmit: 'Ê≥®ÊñáÁ¢∫ÂÆö',
    dineIn: 'Â∫óÂÜÖ', takeout: '„ÉÜ„Ç§„ÇØ„Ç¢„Ç¶„Éà', guest: 'Âêç', items: 'ÂìÅ', total: 'ÂêàË®à',
    soldOut: 'Â£≤„ÇäÂàá„Çå', required: 'ÂøÖÈ†à', portionSize: '„Çµ„Ç§„Ç∫', spicy: 'Ëæõ„Åï',
    noSpicy: 'Ëæõ„Åè„Å™„ÅÑ', mildSpicy: 'Â∞ë„ÅóËæõ„ÅÑ', medSpicy: '‰∏≠Ëæõ', hotSpicy: 'ÊøÄËæõ',
    cartEmpty: '„Ç´„Éº„Éà„ÅØÁ©∫„Åß„Åô', cartEmptyHint: '„É°„Éã„É•„Éº„ÇíË¶ã„Å¶„Åø„Çà„ÅÜÔºÅ',
    clearCart: '„ÇØ„É™„Ç¢', upsellTitle: '‰∏ÄÁ∑í„Å´„ÅÑ„Åã„ÅåÔºü', upsellHint: '„Çø„ÉÉ„Éó„ÅßËøΩÂä†',
    orderSuccess: 'Ê≥®ÊñáÂÆå‰∫ÜÔºÅ', orderNum: 'Ê≥®ÊñáÁï™Âè∑', newOrder: '„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ê≥®Êñá',
    groupOrder: 'üë• „Ç∞„É´„Éº„ÉóÊ≥®Êñá', groupOrdering: '„Ç∞„É´„Éº„ÉóÊ≥®Êñá‰∏≠', groupJoin: 'ÂèÇÂä†',
    groupInvite: 'ÂèãÈÅî„ÇíÊãõÂæÖ', groupLeave: 'ÈÄÄÂá∫', groupTotal: '„Ç∞„É´„Éº„ÉóÂêàË®à',
    serviceWater: 'üíß „ÅäÊ∞¥', serviceUtensils: 'üç¥ È£üÂô®', serviceNapkin: 'üßª „Éä„Éó„Ç≠„É≥', serviceStaff: 'üôã „Çπ„Çø„ÉÉ„Éï',
    serviceNotified: '„Çπ„Çø„ÉÉ„Éï„Å´ÈÄöÁü•„Åó„Åæ„Åó„ÅüÔºÅ', aiRec: 'AI', complementRec: '„Åä„Åô„Åô„ÇÅÁµÑÂêà„Åõ', popularRec: '‰∫∫Ê∞ó',
    budgetRec: '„ÅäÊâãÈ†É', upgradeRec: '„Ç∞„É¨„Éº„Éâ„Ç¢„ÉÉ„Éó'
  },
  ko: {
    scanOrder: 'QR Ï£ºÎ¨∏', open: 'ÏòÅÏóÖÏ§ë', closed: 'Ï§ÄÎπÑÏ§ë', shareOrder: 'üì§ Í≥µÏú†',
    selectTable: '‚òë ÌÖåÏù¥Î∏î / Ïù∏Ïõê', tableLabel: 'ÌÖåÏù¥Î∏î', guestLabel: 'Ïù∏Ïõê',
    tablePlaceholder: 'ÌÖåÏù¥Î∏î Î≤àÌò∏', featured: 'Ï∂îÏ≤ú Î©îÎâ¥', popular: 'Ïù∏Í∏∞',
    searchPlaceholder: 'Î©îÎâ¥ Í≤ÄÏÉâ...', addToCart: 'Îã¥Í∏∞', submitOrder: 'Ï£ºÎ¨∏ÌïòÍ∏∞',
    confirmOrder: 'Ï£ºÎ¨∏ ÌôïÏù∏', backEdit: 'ÎèåÏïÑÍ∞ÄÍ∏∞', confirmSubmit: 'Ï£ºÎ¨∏ ÌôïÏ†ï',
    dineIn: 'Îß§Ïû•', takeout: 'Ìè¨Ïû•', guest: 'Î™Ö', items: 'Í∞ú', total: 'Ìï©Í≥Ñ',
    soldOut: 'ÌíàÏ†à', required: 'ÌïÑÏàò', portionSize: 'ÏÇ¨Ïù¥Ï¶à', spicy: 'ÎßµÍ∏∞',
    noSpicy: 'Ïïà Îß§ÏõÄ', mildSpicy: 'ÏïΩÍ∞Ñ', medSpicy: 'Î≥¥ÌÜµ', hotSpicy: 'Îß§ÏõÄ',
    cartEmpty: 'Ïû•Î∞îÍµ¨ÎãàÍ∞Ä ÎπÑÏóàÏäµÎãàÎã§', cartEmptyHint: 'Î©îÎâ¥Î•º ÎëòÎü¨Î≥¥ÏÑ∏Ïöî!',
    clearCart: 'ÎπÑÏö∞Í∏∞', upsellTitle: 'Ïù¥Í≤ÉÎèÑ Ìï®Íªò Ïñ¥ÎïåÏöî?', upsellHint: 'ÌÉ≠ÌïòÏó¨ Ï∂îÍ∞Ä',
    orderSuccess: 'Ï£ºÎ¨∏ ÏôÑÎ£å!', orderNum: 'Ï£ºÎ¨∏Î≤àÌò∏', newOrder: 'Îã§Ïãú Ï£ºÎ¨∏',
    groupOrder: 'üë• Îã®Ï≤¥ Ï£ºÎ¨∏', groupOrdering: 'Îã®Ï≤¥ Ï£ºÎ¨∏ Ï§ë', groupJoin: 'Ï∞∏Ïó¨',
    groupInvite: 'ÏπúÍµ¨ Ï¥àÎåÄ', groupLeave: 'ÎÇòÍ∞ÄÍ∏∞', groupTotal: 'Îã®Ï≤¥ Ìï©Í≥Ñ',
    serviceWater: 'üíß Î¨º', serviceUtensils: 'üç¥ ÏàòÏ†Ä', serviceNapkin: 'üßª ÎÉÖÌÇ®', serviceStaff: 'üôã ÏßÅÏõêÌò∏Ï∂ú',
    serviceNotified: 'ÏßÅÏõêÏóêÍ≤å ÏïåÎ†∏ÏäµÎãàÎã§!', aiRec: 'AI', complementRec: 'Ìï®Íªò Ï∂îÏ≤ú', popularRec: 'Ïù∏Í∏∞',
    budgetRec: 'Í∞ÄÏÑ±ÎπÑ', upgradeRec: 'ÏóÖÍ∑∏Î†àÏù¥Îìú'
  },
  vi: {
    scanOrder: 'Qu√©t QR ƒë·∫∑t m√≥n', open: 'ƒêang m·ªü', closed: 'ƒê√£ ƒë√≥ng', shareOrder: 'üì§ Chia s·∫ª',
    selectTable: '‚òë B√†n / S·ªë ng∆∞·ªùi', tableLabel: 'B√†n', guestLabel: 'Ng∆∞·ªùi',
    tablePlaceholder: 'S·ªë b√†n', featured: 'M√≥n ƒë·ªÅ xu·∫•t', popular: 'Ph·ªï bi·∫øn',
    searchPlaceholder: 'T√¨m m√≥n...', addToCart: 'Th√™m v√†o gi·ªè', submitOrder: 'ƒê·∫∑t m√≥n',
    confirmOrder: 'X√°c nh·∫≠n ƒë∆°n', backEdit: 'Quay l·∫°i', confirmSubmit: 'X√°c nh·∫≠n',
    dineIn: 'T·∫°i ch·ªó', takeout: 'Mang ƒëi', guest: ' ng∆∞·ªùi', items: ' m√≥n', total: 'T·ªïng',
    soldOut: 'H·∫øt m√≥n', required: 'B·∫Øt bu·ªôc', portionSize: 'K√≠ch c·ª°', spicy: 'ƒê·ªô cay',
    noSpicy: 'Kh√¥ng cay', mildSpicy: '√çt cay', medSpicy: 'V·ª´a', hotSpicy: 'R·∫•t cay',
    cartEmpty: 'Gi·ªè h√†ng tr·ªëng', cartEmptyHint: 'H√£y ch·ªçn m√≥n!',
    clearCart: 'X√≥a', upsellTitle: 'M·ªçi ng∆∞·ªùi c≈©ng g·ªçi th√™m', upsellHint: 'Ch·∫°m ƒë·ªÉ th√™m',
    orderSuccess: 'ƒê√£ ƒë·∫∑t m√≥n!', orderNum: 'S·ªë ƒë∆°n', newOrder: 'G·ªçi th√™m',
    groupOrder: 'üë• ƒê·∫∑t nh√≥m', groupOrdering: 'ƒêang ƒë·∫∑t nh√≥m', groupJoin: 'Tham gia',
    groupInvite: 'M·ªùi b·∫°n b√®', groupLeave: 'R·ªùi', groupTotal: 'T·ªïng nh√≥m',
    serviceWater: 'üíß N∆∞·ªõc', serviceUtensils: 'üç¥ ƒê·ªì ƒÉn', serviceNapkin: 'üßª KhƒÉn', serviceStaff: 'üôã G·ªçi nh√¢n vi√™n',
    serviceNotified: 'ƒê√£ th√¥ng b√°o!', aiRec: 'AI', complementRec: 'G·ª£i √Ω k·∫øt h·ª£p', popularRec: 'Ph·ªï bi·∫øn',
    budgetRec: 'Ti·∫øt ki·ªám', upgradeRec: 'N√¢ng c·∫•p'
  },
  th: {
    scanOrder: '‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£', open: '‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà', closed: '‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß', shareOrder: 'üì§ ‡πÅ‡∏ä‡∏£‡πå',
    selectTable: '‚òë ‡πÇ‡∏ï‡πä‡∏∞ / ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô', tableLabel: '‡πÇ‡∏ï‡πä‡∏∞', guestLabel: '‡∏Ñ‡∏ô',
    tablePlaceholder: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞', featured: '‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', popular: '‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°',
    searchPlaceholder: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π...', addToCart: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤', submitOrder: '‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£',
    confirmOrder: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå', backEdit: '‡∏Å‡∏•‡∏±‡∏ö', confirmSubmit: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
    dineIn: '‡∏ó‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô', takeout: '‡∏™‡∏±‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö', guest: ' ‡∏Ñ‡∏ô', items: ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', total: '‡∏£‡∏ß‡∏°',
    soldOut: '‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß', required: '‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô', portionSize: '‡∏Ç‡∏ô‡∏≤‡∏î', spicy: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ú‡πá‡∏î',
    noSpicy: '‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î', mildSpicy: '‡πÄ‡∏ú‡πá‡∏î‡∏ô‡πâ‡∏≠‡∏¢', medSpicy: '‡πÄ‡∏ú‡πá‡∏î‡∏Å‡∏•‡∏≤‡∏á', hotSpicy: '‡πÄ‡∏ú‡πá‡∏î‡∏°‡∏≤‡∏Å',
    cartEmpty: '‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á', cartEmptyHint: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢!',
    clearCart: '‡∏•‡πâ‡∏≤‡∏á', upsellTitle: '‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°', upsellHint: '‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°',
    orderSuccess: '‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß!', orderNum: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå', newOrder: '‡∏™‡∏±‡πà‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
    groupOrder: 'üë• ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°', groupOrdering: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏±‡πà‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°', groupJoin: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°',
    groupInvite: '‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô', groupLeave: '‡∏≠‡∏≠‡∏Å', groupTotal: '‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°',
    serviceWater: 'üíß ‡∏ô‡πâ‡∏≥', serviceUtensils: 'üç¥ ‡∏ä‡πâ‡∏≠‡∏ô‡∏™‡πâ‡∏≠‡∏°', serviceNapkin: 'üßª ‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà', serviceStaff: 'üôã ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
    serviceNotified: '‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!', aiRec: 'AI', complementRec: '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏π‡πà', popularRec: '‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°',
    budgetRec: '‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î', upgradeRec: '‡∏≠‡∏±‡∏û‡πÄ‡∏Å‡∏£‡∏î'
  }
};

// Á∞°ÊòìËèúÂìÅÂêçÁøªË≠ØÂ≠óÂÖ∏ÔºàÂ∏∏Ë¶ãÂè∞ÁÅ£È§êÈ£≤Áî®Ë™ûÔºâ
var FOOD_DICT = {
  en: {
    'ÁáíËÇâ': 'Braised Pork', 'ÁÅ´ËÖø': 'Ham', 'ÈõûËÇâ': 'Chicken', 'ÁÉ§ËÇâ': 'Grilled Meat',
    'ÈõôÂ±§': 'Double', 'Á∂úÂêà': 'Mixed', 'È∫µÂåÖ': 'Sandwich', 'Â•óÈ§ê': 'Set Meal',
    'È£≤Êñô': 'Drink', 'Â∞è': 'Small', 'Â§ß': 'Large', 'Âä†Êñô': 'Extra', 'Á¥ÖËå∂': 'Black Tea',
    'Á∂†Ëå∂': 'Green Tea', 'Â•∂Ëå∂': 'Milk Tea', 'ÂíñÂï°': 'Coffee', 'Ë∂äÂçó': 'Vietnamese',
    'ÁâõËÇâ': 'Beef', 'Ë±¨ËÇâ': 'Pork', 'È≠ö': 'Fish', 'Ëù¶': 'Shrimp', 'ÊπØ': 'Soup',
    'È£Ø': 'Rice', 'È∫µ': 'Noodles', 'ÁÇí': 'Stir-fried', 'ÁÇ∏': 'Fried', 'Ëí∏': 'Steamed',
    'Ê∂ºÊãå': 'Cold', 'Ê≤ôÊãâ': 'Salad', 'ÁîúÈªû': 'Dessert', 'ÂÜ∞': 'Iced', 'ÁÜ±': 'Hot',
    'ÁèçÁè†': 'Boba', 'Ë±ÜËä±': 'Tofu Pudding', 'Á¥ÖË±Ü': 'Red Bean', 'ËäíÊûú': 'Mango'
  },
  ja: {
    'ÁáíËÇâ': 'ÁÑºËÇâ', 'ÁÅ´ËÖø': '„Éè„É†', 'ÈõûËÇâ': '„ÉÅ„Ç≠„É≥', 'ÁÉ§ËÇâ': '„Ç∞„É™„É´ËÇâ',
    'ÈõôÂ±§': '„ÉÄ„Éñ„É´', 'Á∂úÂêà': '„Éü„ÉÉ„ÇØ„Çπ', 'È∫µÂåÖ': '„Çµ„É≥„Éâ„Ç§„ÉÉ„ÉÅ', 'Â•óÈ§ê': '„Çª„ÉÉ„Éà',
    'È£≤Êñô': '„Éâ„É™„É≥„ÇØ', 'Â∞è': 'Â∞è', 'Â§ß': 'Â§ß', 'Âä†Êñô': '„Éà„ÉÉ„Éî„É≥„Ç∞', 'Á¥ÖËå∂': 'Á¥ÖËå∂',
    'Á∂†Ëå∂': 'Á∑ëËå∂', 'Â•∂Ëå∂': '„Éü„É´„ÇØ„ÉÜ„Ç£„Éº', 'ÂíñÂï°': '„Ç≥„Éº„Éí„Éº', 'Ë∂äÂçó': '„Éô„Éà„Éä„É†',
    'ÁâõËÇâ': 'ÁâõËÇâ', 'Ë±¨ËÇâ': 'Ë±öËÇâ', 'È≠ö': 'È≠ö', 'Ëù¶': '„Ç®„Éì', 'ÊπØ': '„Çπ„Éº„Éó',
    'È£Ø': '„ÅîÈ£Ø', 'È∫µ': 'È∫∫', 'ÁÇí': 'ÁÇí„ÇÅ', 'ÁÇ∏': 'Êèö„Åí', 'Ëí∏': 'Ëí∏„Åó'
  },
  ko: {
    'ÁáíËÇâ': 'ÏàØÎ∂àÍ≥†Í∏∞', 'ÁÅ´ËÖø': 'ÌñÑ', 'ÈõûËÇâ': 'ÏπòÌÇ®', 'ÁÉ§ËÇâ': 'Íµ¨Ïö¥Í≥†Í∏∞',
    'ÈõôÂ±§': 'ÎçîÎ∏î', 'Á∂úÂêà': 'Î™®Îì¨', 'È∫µÂåÖ': 'ÏÉåÎìúÏúÑÏπò', 'Â•óÈ§ê': 'ÏÑ∏Ìä∏',
    'È£≤Êñô': 'ÏùåÎ£å', 'Â∞è': 'ÏÜå', 'Â§ß': 'ÎåÄ', 'Âä†Êñô': 'ÌÜ†Ìïë', 'Á¥ÖËå∂': 'ÌôçÏ∞®',
    'Á∂†Ëå∂': 'ÎÖπÏ∞®', 'Â•∂Ëå∂': 'Î∞ÄÌÅ¨Ìã∞', 'ÂíñÂï°': 'Ïª§Ìîº', 'Ë∂äÂçó': 'Î≤†Ìä∏ÎÇ®'
  },
  vi: {
    'ÁáíËÇâ': 'Th·ªãt ngu·ªôi', 'ÁÅ´ËÖø': 'Ch·∫£', 'ÈõûËÇâ': 'Th·ªãt g√†', 'ÁÉ§ËÇâ': 'Th·ªãt n∆∞·ªõng',
    'ÈõôÂ±§': 'ƒê√¥i', 'Á∂úÂêà': 'Th·∫≠p c·∫©m', 'È∫µÂåÖ': 'B√°nh m√¨', 'Â•óÈ§ê': 'Combo',
    'È£≤Êñô': 'N∆∞·ªõc', 'Â∞è': 'Nh·ªè', 'Â§ß': 'L·ªõn', 'Âä†Êñô': 'Th√™m', 'ÂíñÂï°': 'C√† ph√™',
    'Ë∂äÂçó': 'Vi·ªát Nam'
  },
  th: {
    'ÁáíËÇâ': '‡∏´‡∏°‡∏π‡∏¢‡πà‡∏≤‡∏á', 'ÁÅ´ËÖø': '‡πÅ‡∏Æ‡∏°', 'ÈõûËÇâ': '‡πÑ‡∏Å‡πà', 'ÁÉ§ËÇâ': '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á',
    'ÈõôÂ±§': '‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡πâ‡∏•', 'Á∂úÂêà': '‡∏£‡∏ß‡∏°', 'È∫µÂåÖ': '‡πÅ‡∏ã‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏ä', 'Â•óÈ§ê': '‡πÄ‡∏ã‡πá‡∏ï',
    'È£≤Êñô': '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°', 'Â∞è': '‡πÄ‡∏•‡πá‡∏Å', 'Â§ß': '‡πÉ‡∏´‡∏ç‡πà', 'ÂíñÂï°': '‡∏Å‡∏≤‡πÅ‡∏ü'
  }
};

function t(key) {
  var strings = UI_STRINGS[currentLang] || UI_STRINGS.zh;
  return strings[key] || (UI_STRINGS.zh[key] || key);
}

function translateFoodName(name, lang) {
  if (!lang || lang === 'zh') return '';
  var cacheKey = 'zh_' + lang + '_' + name;
  if (translationCache[cacheKey]) return translationCache[cacheKey];

  var dict = FOOD_DICT[lang] || FOOD_DICT.en;
  var result = name;
  // ÊõøÊèõÂ≠óÂÖ∏‰∏≠ÁöÑÈóúÈçµÂ≠ó
  Object.keys(dict).forEach(function(zh) {
    result = result.replace(new RegExp(zh, 'g'), dict[zh]);
  });

  // Â¶ÇÊûúÊúâ desc ÂåÖÂê´Ëã±Êñá/Ë∂äÂçóÊñáÔºåÂÑ™ÂÖàÁî®ÈÇ£ÂÄã
  translationCache[cacheKey] = result;
  return result !== name ? result : '';
}

function getTranslatedName(item) {
  if (currentLang === 'zh') return '';
  // Â¶ÇÊûú desc ‰∏≠ÊúâÁõÆÊ®ôË™ûË®ÄÔºåËß£ÊûêÂá∫‰æÜ
  if (item.desc) {
    var parts = item.desc.split('/').map(function(s) { return s.trim(); });
    if (currentLang === 'en' && parts.length >= 1 && /[a-zA-Z]/.test(parts[0])) return parts[0];
    if (currentLang === 'vi' && parts.length >= 2) return parts[parts.length - 1];
  }
  return translateFoodName(item.name, currentLang);
}

function toggleLangMenu() {
  document.getElementById('langMenu').classList.toggle('show');
  // Âª∂ÈÅ≤Âä†Â§ñÈÉ®ÈªûÊìäÈóúÈñâ
  setTimeout(function() {
    document.addEventListener('click', closeLangMenuOutside, { once: true });
  }, 10);
}
function closeLangMenuOutside(e) {
  var menu = document.getElementById('langMenu');
  var btn = document.getElementById('langBtn');
  if (menu && !menu.contains(e.target) && btn && !btn.contains(e.target)) {
    menu.classList.remove('show');
  }
}

function setLanguage(lang) {
  currentLang = lang;
  document.getElementById('langMenu').classList.remove('show');

  // Êõ¥Êñ∞ÊåâÈàïÊñáÂ≠ó
  var labels = { zh: '‰∏≠', en: 'EN', ja: 'Êó•', ko: 'Ìïú', vi: 'VN', th: 'TH' };
  document.getElementById('langBtn').textContent = 'üåê ' + (labels[lang] || lang);

  // Êõ¥Êñ∞ active ÁãÄÊÖã
  document.querySelectorAll('.lang-menu-item').forEach(function(el) {
    el.classList.toggle('active', el.dataset.lang === lang);
  });

  // ÁøªË≠Ø UI
  applyLanguage();

  // ÈáçÊñ∞Ê∏≤ÊüìËèúÂñÆ
  renderMenuContent();
  renderSidebar();

  showToast(labels[lang] + ' ‚úì');
}

function applyLanguage() {
  // Header
  var headerTitle = document.getElementById('headerTitle');
  if (headerTitle) headerTitle.textContent = t('scanOrder');
  var shopStatus = document.getElementById('shopStatus');
  if (shopStatus) shopStatus.textContent = t(shopStatus.classList.contains('open') ? 'open' : 'closed');

  // Table selector
  var tableH3 = document.querySelector('#tableSelector h3');
  if (tableH3) tableH3.textContent = t('selectTable');
  var tableLabel = document.querySelector('#tableSelector .table-label');
  if (tableLabel) tableLabel.textContent = t('tableLabel');
  var tableInput = document.getElementById('tableNumber');
  if (tableInput) tableInput.placeholder = t('tablePlaceholder');
  var guestLabel = document.querySelectorAll('#tableSelector .table-label');
  if (guestLabel.length > 1) guestLabel[1].textContent = t('guestLabel');

  // Cart bar
  var submitBtn = document.getElementById('cartSubmit');
  if (submitBtn) submitBtn.innerHTML = t('submitOrder') + ' &#8594;';

  // Search
  var searchInput = document.querySelector('.search-input');
  if (searchInput) searchInput.placeholder = t('searchPlaceholder');

  // Group order
  var groupBtn = document.getElementById('groupStartBtn');
  if (groupBtn && !groupBtn.disabled) groupBtn.textContent = t('groupOrder');
}

function initLanguage() {
  // ÂÅµÊ∏¨ÁÄèË¶ΩÂô®Ë™ûË®Ä
  var browserLang = (navigator.language || navigator.userLanguage || 'zh').substring(0, 2).toLowerCase();
  // ‰πüÊ™¢Êü• URL ÂèÉÊï∏
  var urlLang = new URLSearchParams(window.location.search).get('lang');
  var targetLang = urlLang || (UI_STRINGS[browserLang] ? browserLang : 'zh');

  if (targetLang !== 'zh') {
    setLanguage(targetLang);
  }
}

// ===== AI SMART RECOMMENDATIONS (Êô∫ÊÖßÊé®Ëñ¶) =====
var smartRecContext = { hour: new Date().getHours(), dayType: 'weekday', cartTotal: 0 };

function initSmartRecommendations() {
  var now = new Date();
  smartRecContext.hour = now.getHours();
  smartRecContext.dayType = (now.getDay() === 0 || now.getDay() === 6) ? 'weekend' : 'weekday';

  renderSmartRecBar();
  renderSmartRecSection();
}

function getTimeContext() {
  var h = smartRecContext.hour;
  if (h >= 6 && h < 11) return { period: 'morning', label: 'Êó©ÂÆâ', emoji: 'üåÖ', suggest: '‰æÜ‰ªΩÂÖÉÊ∞£Êó©È§ê' };
  if (h >= 11 && h < 14) return { period: 'lunch', label: 'ÂçàÈ§ê', emoji: '‚òÄÔ∏è', suggest: 'ÂçàÈñìÂ•óÈ§êÊúÄÂàíÁÆó' };
  if (h >= 14 && h < 17) return { period: 'afternoon', label: '‰∏ãÂçà', emoji: 'üçµ', suggest: '‰∏ãÂçàËå∂ÊôÇÂÖâ' };
  if (h >= 17 && h < 21) return { period: 'dinner', label: 'ÊôöÈ§ê', emoji: 'üåô', suggest: '‰ªäÊôöÊÉ≥ÂêÉ‰ªÄÈ∫ºÔºü' };
  return { period: 'late', label: 'ÂÆµÂ§ú', emoji: 'üåÉ', suggest: 'Ê∑±Â§úÈ£üÂ†Ç' };
}

function getSmartCategories() {
  // Ê†πÊìöË≥ºÁâ©ËªäÂàÜÊûê‰∫íË£úÂàÜÈ°û
  var cartCats = {};
  cart.forEach(function(c) {
    var item = menuItems.find(function(i) { return i.id === c.id; });
    if (item) cartCats[item.category] = (cartCats[item.category] || 0) + 1;
  });

  var allCats = {};
  menuItems.forEach(function(i) { if (i.available !== false) allCats[i.category] = true; });
  var catList = Object.keys(allCats);

  // ÊâæÂá∫Êú™Ë≥ºË≤∑ÁöÑÂàÜÈ°û‰ΩúÁÇ∫Êé®Ëñ¶
  var missingCats = catList.filter(function(c) { return !cartCats[c]; });
  return { cartCats: cartCats, missingCats: missingCats, allCats: catList };
}

function getSmartRecommendations(type) {
  var cartIds = cart.map(function(c) { return c.id; });
  var available = menuItems.filter(function(i) { return i.available !== false && cartIds.indexOf(i.id) === -1; });
  var timeCtx = getTimeContext();
  var catInfo = getSmartCategories();

  switch(type) {
    case 'complement':
      // ‰∫íË£úÊé®Ëñ¶ÔºöÊé®Ëñ¶‰∏çÂêåÂàÜÈ°ûÁöÑÁÜ±ÈñÄÂìÅÈ†Ö
      return {
        title: 'Êê≠ÈÖçÊé®Ëñ¶',
        reason: 'Ê†πÊìö‰Ω†ÁöÑË≥ºÁâ©Ëªä',
        emoji: 'üß©',
        items: available
          .filter(function(i) { return catInfo.missingCats.indexOf(i.category) !== -1; })
          .sort(function(a, b) {
            var as = (a.featured ? 10 : 0) + ((a.tags || []).indexOf('hot') >= 0 ? 5 : 0) + (a.image ? 3 : 0);
            var bs = (b.featured ? 10 : 0) + ((b.tags || []).indexOf('hot') >= 0 ? 5 : 0) + (b.image ? 3 : 0);
            return bs - as;
          })
          .slice(0, 5)
      };

    case 'popular':
      // ‰∫∫Ê∞£Êé®Ëñ¶Ôºöfeatured + hot Ê®ôÁ±§
      return {
        title: 'Â§ßÂÆ∂ÈÉΩÂú®Èªû',
        reason: '‰∫∫Ê∞£ÊéíË°å',
        emoji: 'üî•',
        items: available
          .filter(function(i) { return i.featured || (i.tags || []).indexOf('hot') >= 0 || (i.tags || []).indexOf('Êé®Ëñ¶') >= 0; })
          .slice(0, 5)
      };

    case 'budget':
      // Â∞èË≥áÊé®Ëñ¶ÔºöÂÉπÊ†ºÊúÄÂÑ™ÊÉ†ÁöÑ
      var cartTotal = cart.reduce(function(s, c) { return s + c.price * c.qty; }, 0);
      return {
        title: 'ÈäÖÊùøÁæéÈ£ü',
        reason: 'Â∞èË≥áÈ¶ñÈÅ∏',
        emoji: 'üí∞',
        items: available
          .filter(function(i) { return i.price <= 60; })
          .sort(function(a, b) {
            var as = (a.image ? 5 : 0) + (a.featured ? 3 : 0);
            var bs = (b.image ? 5 : 0) + (b.featured ? 3 : 0);
            return bs - as;
          })
          .slice(0, 5)
      };

    case 'time':
      // ÊôÇÊÆµÊé®Ëñ¶
      var drinkCats = ['drink', 'drinks', 'È£≤Êñô', 'È£≤ÂìÅ'];
      var setCats = ['setL', 'setS', 'set', 'Â•óÈ§ê', 'Â§ßÂ•óÈ§ê', 'Â∞èÂ•óÈ§ê'];
      var targetCats = [];
      if (timeCtx.period === 'afternoon') targetCats = drinkCats;
      else if (timeCtx.period === 'lunch' || timeCtx.period === 'dinner') targetCats = setCats;

      var filtered = targetCats.length > 0
        ? available.filter(function(i) { return targetCats.indexOf(i.category) >= 0; })
        : available.filter(function(i) { return i.featured; });

      return {
        title: timeCtx.suggest,
        reason: timeCtx.label + 'ÊôÇÊÆµ',
        emoji: timeCtx.emoji,
        items: filtered.sort(function(a, b) {
          return (b.featured ? 1 : 0) - (a.featured ? 1 : 0);
        }).slice(0, 5)
      };

    case 'upgrade':
      // ÂçáÁ¥öÊé®Ëñ¶ÔºöË≥ºÁâ©ËªäË£°ÁöÑÂìÅÈ†ÖÊúâÊõ¥È´òÂÉπÁöÑÂêåÂàÜÈ°ûÈÅ∏Êìá
      var upgrades = [];
      cart.forEach(function(c) {
        var item = menuItems.find(function(i) { return i.id === c.id; });
        if (!item) return;
        var better = available.filter(function(i) {
          return i.category === item.category && i.price > item.price;
        }).sort(function(a, b) { return a.price - b.price; });
        if (better.length > 0 && upgrades.length < 5) upgrades.push(better[0]);
      });
      return {
        title: 'ÂçáÁ¥ö‰∫´Âèó',
        reason: 'Âä†‰∏ÄÈªûÊõ¥ÊªøË∂≥',
        emoji: '‚¨ÜÔ∏è',
        items: upgrades
      };

    default:
      return { title: '', reason: '', emoji: '', items: [] };
  }
}

function renderSmartRecBar() {
  var menuArea = document.getElementById('menuContent');
  if (!menuArea) return;

  // Âú®ËèúÂñÆÂÖßÂÆπÈ†ÇÈÉ®Âä†ÂÖ•Êô∫ÊÖßÊé®Ëñ¶Âàó
  var existing = document.getElementById('smartRecBar');
  if (existing) existing.remove();

  var timeCtx = getTimeContext();
  var chips = [
    { type: 'time', emoji: timeCtx.emoji, label: timeCtx.suggest },
    { type: 'popular', emoji: 'üî•', label: '‰∫∫Ê∞£ÂøÖÈªû' },
    { type: 'budget', emoji: 'üí∞', label: 'ÈäÖÊùøÁæéÈ£ü' }
  ];
  if (cart.length > 0) {
    chips.unshift({ type: 'complement', emoji: 'üß©', label: 'Êê≠ÈÖçÊé®Ëñ¶', highlight: true });
    chips.push({ type: 'upgrade', emoji: '‚¨ÜÔ∏è', label: 'ÂçáÁ¥ö‰∫´Âèó' });
  }

  var html = '<div class="smart-rec-bar" id="smartRecBar">';
  html += '<span style="font-size:13px;font-weight:700;white-space:nowrap;color:var(--text-secondary);">ü§ñ AI</span>';
  chips.forEach(function(c) {
    html += '<div class="smart-rec-chip' + (c.highlight ? ' highlight' : '') + '" onclick="showSmartRec(\'' + c.type + '\')">' +
      '<span class="rec-emoji">' + c.emoji + '</span>' + c.label + '</div>';
  });
  html += '</div>';

  // ÊèíÂÖ•Âà∞ËèúÂñÆÂçÄÂüüÈ†ÇÈÉ®
  var contentArea = document.querySelector('.content-area');
  if (contentArea) {
    var recDiv = document.createElement('div');
    recDiv.id = 'smartRecBar';
    recDiv.innerHTML = html;
    var first = contentArea.firstChild;
    if (first) contentArea.insertBefore(recDiv, first);
    else contentArea.appendChild(recDiv);
  }
}

function renderSmartRecSection() {
  // Ëá™ÂãïÈ°ØÁ§∫‰∏ÄÂÄãÊôÇÊÆµÊé®Ëñ¶
  var existing = document.getElementById('smartRecSection');
  if (existing) existing.remove();

  var timeRec = getSmartRecommendations('time');
  if (timeRec.items.length === 0) {
    timeRec = getSmartRecommendations('popular');
  }
  if (timeRec.items.length === 0) return;

  insertSmartRecSection(timeRec);
}

function showSmartRec(type) {
  var rec = getSmartRecommendations(type);
  if (rec.items.length === 0) { showToast('Êö´ÁÑ°Áõ∏ÈóúÊé®Ëñ¶'); return; }

  var existing = document.getElementById('smartRecSection');
  if (existing) existing.remove();

  insertSmartRecSection(rec);

  // ÊªæÂãïÂà∞Êé®Ëñ¶ÂçÄ
  setTimeout(function() {
    var el = document.getElementById('smartRecSection');
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

function insertSmartRecSection(rec) {
  var itemsHtml = '';
  rec.items.forEach(function(item) {
    var imgSrc = item.image || generatePlaceholder(item.name);
    itemsHtml += '<div class="smart-rec-item" onclick="openItemModal(\'' + item.id + '\')">' +
      '<img class="smart-rec-item-img" src="' + imgSrc + '" onerror="this.src=\'' + generatePlaceholder(item.name) + '\'">' +
      '<div class="smart-rec-item-name">' + escHtml(item.name) + '</div>' +
      '<div class="smart-rec-item-price">$' + item.price + '</div>' +
    '</div>';
  });

  var html = '<div class="smart-rec-section" id="smartRecSection">' +
    '<div class="smart-rec-title">' +
      '<span class="rec-ai-badge">AI</span>' +
      '<h4>' + rec.emoji + ' ' + rec.title + '</h4>' +
      '<span class="rec-reason">' + rec.reason + '</span>' +
    '</div>' +
    '<div class="smart-rec-items">' + itemsHtml + '</div>' +
  '</div>';

  var contentArea = document.querySelector('.content-area');
  if (contentArea) {
    var recBar = document.getElementById('smartRecBar');
    var insertAfter = recBar || contentArea.firstChild;
    var div = document.createElement('div');
    div.id = 'smartRecSection';
    div.innerHTML = html;
    if (insertAfter && insertAfter.nextSibling) {
      contentArea.insertBefore(div, insertAfter.nextSibling);
    } else {
      contentArea.appendChild(div);
    }
  }
}

// Ë≥ºÁâ©ËªäËÆäÂãïÊôÇÂà∑Êñ∞Êé®Ëñ¶
function refreshSmartRec() {
  renderSmartRecBar();
}

// ===== GROUP ORDER (ÂúòÈ´îÈªûÈ§ê) =====
var groupSession = null;  // { sessionId, tableNum, storeId, createdAt }
var groupMe = null;       // { memberId, nickname, avatar }
var groupMembers = [];    // [{ memberId, nickname, avatar, items, total, status }]
var groupPollTimer = null;
var GROUP_AVATARS = ['üê±','üê∂','üê∞','üêª','üêº','ü¶ä','üê∏','üêµ','üêß','ü¶Å','üêØ','üêÆ'];

function initGroupOrder() {
  // ÂÖßÁî®Ê®°Âºè 2‰∫∫‰ª•‰∏äÊâçÈ°ØÁ§∫ÂúòÈ´îÈªûÈ§êÂÖ•Âè£
  if (window._orderMode === 'takeout') return;
  document.getElementById('groupOrderEntry').style.display = '';

  // Ê™¢Êü• URL ÊòØÂê¶Êúâ group ÂèÉÊï∏ÔºàË¢´ÈÇÄË´ãÂä†ÂÖ•Ôºâ
  var params = new URLSearchParams(window.location.search);
  var groupId = params.get('group');
  if (groupId) {
    document.getElementById('groupJoinBtn').style.display = '';
    document.getElementById('groupJoinBtn').setAttribute('data-group', groupId);
    // Ëá™ÂãïÂΩàÂá∫Âä†ÂÖ•Â∞çË©±Ê°Ü
    setTimeout(function() { showJoinGroup(groupId); }, 500);
  }
}

function generateSessionId() {
  return 'grp_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 6);
}
function generateMemberId() {
  return 'mem_' + Math.random().toString(36).substr(2, 8);
}

// ÈñãÂïüÂúòÈ´îÈªûÈ§êÔºàÁôºËµ∑‰∫∫Ôºâ
function startGroupOrder() {
  var tableNum = document.getElementById('tableNumber').value.trim();
  if (!tableNum) { showToast('Ë´ãÂÖàËº∏ÂÖ•Ê°åËôü'); document.getElementById('tableNumber').focus(); return; }

  groupSession = {
    sessionId: generateSessionId(),
    tableNum: tableNum,
    storeId: currentStoreId,
    createdAt: new Date().toISOString()
  };

  // ÈÅ∏È†≠ÂÉèÂíåÊö±Á®±
  showAvatarPicker(true);
}

// Âä†ÂÖ•ÂúòÈ´îÈªûÈ§êÔºàË¢´ÈÇÄË´ãËÄÖÔºâ
function showJoinGroup(groupId) {
  if (!groupId) {
    var btn = document.getElementById('groupJoinBtn');
    groupId = btn ? btn.getAttribute('data-group') : null;
  }
  if (!groupId) { showToast('ÁÑ°ÊïàÁöÑÂúòÈ´îÈªûÈ§êÈÄ£Áµê'); return; }

  // Ë®≠ÂÆö sessionÔºàÁ∞°ÂåñÁâàÔºöÁî® sessionId Âä†ÂÖ•Ôºâ
  var tableNum = document.getElementById('tableNumber').value.trim();
  groupSession = {
    sessionId: groupId,
    tableNum: tableNum || '?',
    storeId: currentStoreId,
    createdAt: null
  };

  showAvatarPicker(false);
}

function showAvatarPicker(isHost) {
  var avatarHtml = GROUP_AVATARS.map(function(a, i) {
    return '<div class="group-avatar-opt' + (i === 0 ? ' active' : '') + '" onclick="pickGroupAvatar(this)" data-avatar="' + a + '">' + a + '</div>';
  }).join('');

  var overlay = document.getElementById('itemModalOverlay');
  overlay.innerHTML = '<div class="item-modal group-join-modal" onclick="event.stopPropagation()" style="padding:24px 20px;">' +
    '<h2 style="font-size:20px;font-weight:800;margin:0 0 4px;">' + (isHost ? 'üë• ÈñãÂïüÂúòÈ´îÈªûÈ§ê' : 'üë• Âä†ÂÖ•ÂúòÈ´îÈªûÈ§ê') + '</h2>' +
    '<div style="font-size:13px;color:#888;margin-bottom:12px;">' + (isHost ? 'ÈÅ∏Êìá‰Ω†ÁöÑÈ†≠ÂÉèÂíåÊö±Á®±ÔºåÊúãÂèãÂèØÊéÉÁ¢ºÂä†ÂÖ•' : 'ÈÅ∏ÊìáÈ†≠ÂÉèËÆìÂ§ßÂÆ∂Ë™çË≠ò‰Ω†') + '</div>' +
    '<div class="group-avatar-picker">' + avatarHtml + '</div>' +
    '<input type="text" id="groupNickname" placeholder="Ëº∏ÂÖ•Êö±Á®±Ôºà‰æãÔºöÂ∞èÊòéÔºâ" maxlength="10" ' +
      'style="width:100%;padding:12px 16px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:15px;font-family:inherit;text-align:center;margin-bottom:16px;background:var(--bg);">' +
    '<button onclick="confirmJoinGroup(' + (isHost ? 'true' : 'false') + ')" ' +
      'style="width:100%;padding:14px;border:none;border-radius:var(--radius-md);background:var(--primary);color:#FFF;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;">' +
      (isHost ? 'ÈñãÂßãÂúòÈ´îÈªûÈ§ê' : 'Âä†ÂÖ•ÈªûÈ§ê') +
    '</button>' +
  '</div>';
  overlay.classList.add('show');
}

function pickGroupAvatar(el) {
  el.parentElement.querySelectorAll('.group-avatar-opt').forEach(function(a) { a.classList.remove('active'); });
  el.classList.add('active');
}

function confirmJoinGroup(isHost) {
  var nickname = document.getElementById('groupNickname').value.trim();
  if (!nickname) { showToast('Ë´ãËº∏ÂÖ•Êö±Á®±'); document.getElementById('groupNickname').focus(); return; }
  var avatarEl = document.querySelector('.group-avatar-opt.active');
  var avatar = avatarEl ? avatarEl.dataset.avatar : 'üê±';

  groupMe = {
    memberId: generateMemberId(),
    nickname: nickname,
    avatar: avatar,
    isHost: isHost
  };

  // ÈóúÈñâ modal
  document.getElementById('itemModalOverlay').classList.remove('show');

  // ÂÑ≤Â≠ò session
  saveGroupMember();

  // È°ØÁ§∫ÂúòÈ´îÈù¢Êùø
  showGroupPanel();

  // ÈñãÂßãÂÆöÊôÇÂêåÊ≠•
  startGroupSync();

  // Êõ¥Êñ∞ UI
  document.getElementById('groupStartBtn').textContent = 'üë• ÂúòÈ´îÈªûÈ§ê‰∏≠';
  document.getElementById('groupStartBtn').disabled = true;
  document.getElementById('groupStartBtn').style.opacity = '0.5';

  showToast(avatar + ' ' + nickname + ' Â∑≤Âä†ÂÖ•ÂúòÈ´îÈªûÈ§êÔºÅ');

  // Ê∏ÖÈô§ URL ‰∏≠ÁöÑ group ÂèÉÊï∏
  var url = new URL(window.location);
  url.searchParams.delete('group');
  window.history.replaceState({}, '', url);
}

function showGroupPanel() {
  document.getElementById('groupPanel').style.display = '';
  document.getElementById('groupSessionInfo').textContent = groupSession.tableNum + ' Ê°å';
  renderGroupMembers();
}

function renderGroupMembers() {
  var container = document.getElementById('groupMembers');
  if (!container) return;

  // Âêà‰ΩµËá™Â∑±ÁöÑÂç≥ÊôÇË≥ºÁâ©ËªäË≥áÊñô
  var myData = {
    memberId: groupMe.memberId,
    nickname: groupMe.nickname,
    avatar: groupMe.avatar,
    items: cart.map(function(c) {
      var item = menuItems.find(function(i) { return i.id === c.id; });
      return { name: item ? item.name : '???', qty: c.qty, price: c.price };
    }),
    total: cart.reduce(function(s, c) { return s + c.price * c.qty; }, 0),
    count: cart.reduce(function(s, c) { return s + c.qty; }, 0),
    status: cart.length > 0 ? 'ordering' : 'browsing'
  };

  // Âêà‰ΩµÊâÄÊúâÊàêÂì°ÔºàËá™Â∑± + ÂÖ∂‰ªñ‰∫∫Ôºâ
  var allMembers = [myData];
  groupMembers.forEach(function(m) {
    if (m.memberId !== groupMe.memberId) allMembers.push(m);
  });

  var html = '';
  var grandTotal = 0;
  allMembers.forEach(function(m) {
    var isMe = m.memberId === groupMe.memberId;
    var statusText = '';
    if (m.count > 0) {
      statusText = m.count + ' È†Ö';
      var itemNames = (m.items || []).slice(0, 3).map(function(i) { return i.name; }).join('„ÄÅ');
      if (itemNames) statusText += 'Ôºö' + itemNames;
      if ((m.items || []).length > 3) statusText += '‚Ä¶';
    } else {
      statusText = m.status === 'browsing' ? 'ÁÄèË¶ΩËèúÂñÆ‰∏≠‚Ä¶' : 'Â∞öÊú™ÈñãÂßã';
    }
    grandTotal += (m.total || 0);

    html += '<div class="group-member' + (isMe ? ' me' : '') + '">' +
      '<div class="group-member-avatar">' + m.avatar + '</div>' +
      '<div class="group-member-info">' +
        '<div class="group-member-name">' + m.nickname + (isMe ? 'Ôºà‰Ω†Ôºâ' : '') + '</div>' +
        '<div class="group-member-status">' + statusText + '</div>' +
      '</div>' +
      (m.total > 0 ? '<div class="group-member-total">$' + m.total + '</div>' : '') +
    '</div>';
  });

  // ÂêàË®àÂàó
  if (allMembers.length > 1) {
    html += '<div style="display:flex;justify-content:space-between;padding:8px 10px 2px;border-top:1px solid var(--border-light);margin-top:4px;">' +
      '<span style="font-size:13px;font-weight:700;color:var(--text-secondary);">ÂúòÈ´îÂêàË®à</span>' +
      '<span style="font-size:16px;font-weight:800;color:var(--primary);">$' + grandTotal + '</span>' +
    '</div>';
  }

  container.innerHTML = html;
}

// ÂêåÊ≠•Ë≥ºÁâ©ËªäÂà∞ SupabaseÔºà‰ΩøÁî® orders Ë°®‰ΩúÁÇ∫Âç≥ÊôÇÈÄöË®äÈÄöÈÅìÔºâ
async function saveGroupMember() {
  if (!groupSession || !groupMe || !currentStoreId) return;
  try {
    var myItems = cart.map(function(c) {
      var item = menuItems.find(function(i) { return i.id === c.id; });
      return { name: item ? item.name : '???', qty: c.qty, price: c.price };
    });

    var payload = {
      store_id: currentStoreId,
      table_number: groupSession.tableNum,
      order_type: 'group_sync',
      status: 'active',
      notes: JSON.stringify({
        sessionId: groupSession.sessionId,
        memberId: groupMe.memberId,
        nickname: groupMe.nickname,
        avatar: groupMe.avatar,
        isHost: groupMe.isHost || false,
        timestamp: new Date().toISOString()
      }),
      items: myItems,
      total: cart.reduce(function(s, c) { return s + c.price * c.qty; }, 0)
    };

    await fetch(SUPABASE_URL + '/rest/v1/orders', {
      method: 'POST',
      headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates,return=minimal' },
      body: JSON.stringify(payload)
    });
  } catch(e) { /* ÈùúÈªòËôïÁêÜ */ }
}

// ÂÆöÊôÇÂêåÊ≠•
function startGroupSync() {
  if (groupPollTimer) clearInterval(groupPollTimer);

  // ÊØè 3 ÁßíÂêåÊ≠•‰∏ÄÊ¨°
  groupPollTimer = setInterval(function() {
    syncGroupData();
    saveGroupMember(); // ÂêåÊôÇ‰∏äÂÇ≥Ëá™Â∑±ÁöÑÊúÄÊñ∞ÁãÄÊÖã
  }, 3000);

  // Á´ãÂç≥ÂêåÊ≠•‰∏ÄÊ¨°
  syncGroupData();
}

async function syncGroupData() {
  if (!groupSession || !currentStoreId) return;
  try {
    // Êü•Ë©¢Âêå session ÁöÑÊâÄÊúâÊàêÂì°ÊúÄÊñ∞Ë≥áÊñô
    var res = await fetch(SUPABASE_URL + '/rest/v1/orders?store_id=eq.' + currentStoreId +
      '&order_type=eq.group_sync&status=eq.active' +
      '&table_number=eq.' + encodeURIComponent(groupSession.tableNum) +
      '&notes=like.*' + encodeURIComponent(groupSession.sessionId) + '*' +
      '&order=created_at.desc&limit=20', {
      headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' }
    });
    var data = await res.json();
    if (!Array.isArray(data)) return;

    // Âè™‰øùÁïôÊØèÂÄã memberId ÁöÑÊúÄÊñ∞‰∏ÄÁ≠Ü
    var latest = {};
    data.forEach(function(row) {
      try {
        var meta = JSON.parse(row.notes);
        if (!meta.memberId) return;
        if (!latest[meta.memberId] || new Date(meta.timestamp) > new Date(latest[meta.memberId]._ts)) {
          latest[meta.memberId] = {
            memberId: meta.memberId,
            nickname: meta.nickname,
            avatar: meta.avatar,
            items: row.items || [],
            total: row.total || 0,
            count: (row.items || []).reduce(function(s, i) { return s + (i.qty || 1); }, 0),
            status: (row.items || []).length > 0 ? 'ordering' : 'browsing',
            _ts: meta.timestamp
          };
        }
      } catch(e) {}
    });

    groupMembers = Object.values(latest);
    renderGroupMembers();
  } catch(e) { /* ÈùúÈªòËôïÁêÜ */ }
}

function shareGroupLink() {
  if (!groupSession) return;
  var name = document.getElementById('shopName').textContent;
  var baseUrl = window.location.origin + window.location.pathname;
  var params = '?store=' + currentStoreId + '&table=' + encodeURIComponent(groupSession.tableNum) + '&group=' + groupSession.sessionId;
  var url = baseUrl + params;

  if (navigator.share) {
    navigator.share({
      title: name + ' ÂúòÈ´îÈªûÈ§ê',
      text: 'Âä†ÂÖ• ' + name + ' ' + groupSession.tableNum + ' Ê°åÁöÑÂúòÈ´îÈªûÈ§êÔºÅ',
      url: url
    }).catch(function() {});
  } else {
    copyToClipboard(url);
  }
}

function leaveGroupOrder() {
  if (groupPollTimer) { clearInterval(groupPollTimer); groupPollTimer = null; }
  groupSession = null;
  groupMe = null;
  groupMembers = [];
  document.getElementById('groupPanel').style.display = 'none';
  document.getElementById('groupStartBtn').textContent = 'üë• ÈñãÂïüÂúòÈ´îÈªûÈ§ê';
  document.getElementById('groupStartBtn').disabled = false;
  document.getElementById('groupStartBtn').style.opacity = '';
  showToast('Â∑≤Èõ¢ÈñãÂúòÈ´îÈªûÈ§ê');
}

// ÊîîÊà™ updateCartUI ‰ª•ÂêåÊ≠•ÂúòÈ´îÈù¢Êùø
var _originalUpdateCartUI = null;
function hookGroupOrderToCart() {
  if (_originalUpdateCartUI) return;
  _originalUpdateCartUI = updateCartUI;
  updateCartUI = function() {
    _originalUpdateCartUI();
    if (groupSession && groupMe) {
      renderGroupMembers();
    }
    // Ë≥ºÁâ©ËªäËÆäÂãïÊôÇÂà∑Êñ∞ AI Êé®Ëñ¶Âàó
    refreshSmartRec();
  };
}

// ===== SERVICE CALL (ÊúçÂãôÂëºÂè´) =====
function initServiceCall() {
  // ÂÖßÁî®Ê®°ÂºèÊâçÈ°ØÁ§∫ÊúçÂãôÂëºÂè´ÊåâÈàï
  if (window._orderMode !== 'takeout') {
    var fab = document.getElementById('serviceCallFab');
    if (fab) fab.style.display = '';
  }
}
function toggleServiceMenu() {
  var menu = document.getElementById('serviceMenu');
  menu.classList.toggle('show');
  // ÈªûÊìäÂ§ñÈÉ®ÈóúÈñâ
  if (menu.classList.contains('show')) {
    setTimeout(function() {
      document.addEventListener('click', closeServiceMenuOutside, { once: true });
    }, 10);
  }
}
function closeServiceMenuOutside(e) {
  var fab = document.getElementById('serviceCallFab');
  if (fab && !fab.contains(e.target)) {
    document.getElementById('serviceMenu').classList.remove('show');
  }
}
async function sendServiceCall(type) {
  document.getElementById('serviceMenu').classList.remove('show');
  var labels = { water: 'üíß Âä†Ê∞¥', utensils: 'üç¥ Âä†È§êÂÖ∑', napkin: 'üßª Âä†Á¥ôÂ∑æ', staff: 'üôã ÂëºÂè´ÊúçÂãôÂì°' };
  var tableNum = document.getElementById('tableNumber') ? document.getElementById('tableNumber').value.trim() : '';
  // ÂòóË©¶ÂØ´ÂÖ• Supabase orders Ë°®Ôºàtype: service_callÔºâ
  if (currentStoreId && window.SUPABASE_URL) {
    try {
      await fetch(window.SUPABASE_URL + '/rest/v1/orders', {
        method: 'POST', headers: { 'apikey': window.SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
        body: JSON.stringify({ store_id: currentStoreId, table_number: tableNum || 'Êú™Áü•', order_type: 'service_call', status: 'pending', items: [{ type: type, label: labels[type] }], total: 0, notes: labels[type] })
      });
    } catch(e) { /* Â§±Êïó‰∏çÂΩ±ÈüøÊèêÁ§∫ */ }
  }
  showToast(labels[type] + ' Â∑≤ÈÄöÁü•Â∫óÂì°ÔºÅ');
}

function shareOrder() {
  var name = document.getElementById('shopName').textContent;
  // Â¶ÇÊûúË≥ºÁâ©ËªäÊúâÊù±Ë•øÔºåÂàÜ‰∫´Ë≥ºÁâ©ËªäÈÄ£Áµê
  if (cart.length > 0) {
    showShareOptions(name);
  } else {
    // Á©∫Ë≥ºÁâ©ËªäÔºåÂàÜ‰∫´Â∫óÈù¢ÈÄ£Áµê
    shareStoreLink(name);
  }
}

function shareStoreLink(name) {
  var baseUrl = window.location.origin + window.location.pathname + '?store=' + currentStoreId;
  if (navigator.share) {
    navigator.share({ title: name + ' ‚Äî Á∑ö‰∏äÈªûÈ§ê', text: '‰∏ÄËµ∑‰æÜ ' + name + ' ÈªûÈ§êÂêßÔºÅ', url: baseUrl }).catch(function() {});
  } else {
    copyToClipboard(baseUrl);
  }
}

function showShareOptions(name) {
  var cartSummary = cart.map(function(c) {
    var item = menuItems.find(function(i) { return i.id === c.id; });
    return (item ? item.name : '???') + ' x' + c.qty;
  }).join('„ÄÅ');
  var totalPrice = cart.reduce(function(s, c) { return s + c.price * c.qty; }, 0);
  var totalQty = cart.reduce(function(s, c) { return s + c.qty; }, 0);

  // Á∑®Á¢ºË≥ºÁâ©ËªäÂà∞ URL
  var cartData = cart.map(function(c) {
    return { i: c.id, q: c.qty, p: c.price, s: c.sizeName || '', o: (c.selectedOpts || []).map(function(op) { return typeof op === 'string' ? op : (op.name || ''); }) };
  });
  var encoded = btoa(unescape(encodeURIComponent(JSON.stringify(cartData))));
  var baseUrl = window.location.origin + window.location.pathname + '?store=' + currentStoreId;
  var cartUrl = baseUrl + '&cart=' + encoded;

  var overlay = document.getElementById('itemModalOverlay');
  overlay.innerHTML = '<div class="item-modal" onclick="event.stopPropagation()" style="padding:24px 20px;max-height:80vh;">' +
    '<h2 style="text-align:center;font-size:18px;font-weight:800;margin:0 0 4px;">üì§ ÂàÜ‰∫´ÈªûÈ§ê</h2>' +
    '<div style="text-align:center;font-size:13px;color:#888;margin-bottom:18px;">ÈÅ∏ÊìáÂàÜ‰∫´ÊñπÂºè</div>' +

    '<div style="background:var(--bg);border-radius:var(--radius-md);padding:14px 16px;margin-bottom:16px;">' +
      '<div style="font-size:13px;font-weight:700;margin-bottom:6px;">Ë≥ºÁâ©ËªäÂÖßÂÆπÔºà' + totalQty + ' ‰ª∂ ¬∑ $' + totalPrice + 'Ôºâ</div>' +
      '<div style="font-size:12px;color:#888;line-height:1.6;max-height:60px;overflow:hidden;">' + cartSummary + '</div>' +
    '</div>' +

    '<button onclick="shareCartNative()" style="width:100%;padding:14px;border:none;border-radius:var(--radius-md);background:var(--primary);color:#FFF;font-size:15px;font-weight:700;cursor:pointer;margin-bottom:8px;font-family:inherit;">' +
      'üì± ÂàÜ‰∫´Ë≥ºÁâ©ËªäÈÄ£Áµê' +
    '</button>' +
    '<button onclick="shareTextSummary()" style="width:100%;padding:14px;border:none;border-radius:var(--radius-md);background:var(--bg);color:var(--text-primary);font-size:15px;font-weight:700;cursor:pointer;margin-bottom:8px;font-family:inherit;border:1.5px solid var(--border);">' +
      'üìã Ë§áË£ΩÊñáÂ≠óÊ∏ÖÂñÆ' +
    '</button>' +
    '<button onclick="shareStoreOnly()" style="width:100%;padding:14px;border:none;border-radius:var(--radius-md);background:transparent;color:var(--text-muted);font-size:13px;cursor:pointer;font-family:inherit;">' +
      'Âè™ÂàÜ‰∫´Â∫óÈù¢ÈÄ£Áµê' +
    '</button>' +
  '</div>';
  overlay.classList.add('show');

  // Êö´Â≠òÂàÜ‰∫´Ë≥áÊñô
  window._shareData = { name: name, cartUrl: cartUrl, baseUrl: baseUrl, cartSummary: cartSummary, totalPrice: totalPrice, totalQty: totalQty };
}

function shareCartNative() {
  var d = window._shareData;
  document.getElementById('itemModalOverlay').classList.remove('show');
  if (navigator.share) {
    navigator.share({
      title: d.name + ' ‚Äî ÊàëÁöÑÈªûÈ§êÊ∏ÖÂñÆ',
      text: 'ÊàëÂú® ' + d.name + ' Èªû‰∫Ü ' + d.totalQty + ' Ê®£Ôºà$' + d.totalPrice + 'ÔºâÔºå‰∏ÄËµ∑ÁúãÁúãÔºö',
      url: d.cartUrl
    }).catch(function() {});
  } else {
    copyToClipboard(d.cartUrl);
  }
}

function shareTextSummary() {
  var d = window._shareData;
  var text = 'üìã ' + d.name + ' ÈªûÈ§êÊ∏ÖÂñÆ\n';
  cart.forEach(function(c) {
    var item = menuItems.find(function(i) { return i.id === c.id; });
    var name = item ? item.name : '???';
    var detail = '';
    if (c.sizeName) detail += c.sizeName;
    if (c.selectedOpts && c.selectedOpts.length > 0) {
      var optNames = c.selectedOpts.map(function(o) { return typeof o === 'string' ? o : (o.name || ''); }).filter(Boolean).join(', ');
      detail += (detail ? ' / ' : '') + optNames;
    }
    text += '‚Ä¢ ' + name + (detail ? 'Ôºà' + detail + 'Ôºâ' : '') + ' x' + c.qty + '  $' + (c.price * c.qty) + '\n';
  });
  text += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nÂêàË®à ' + d.totalQty + ' ‰ª∂  $' + d.totalPrice + '\n';
  text += 'üëâ ' + d.baseUrl;

  copyToClipboard(text);
  document.getElementById('itemModalOverlay').classList.remove('show');
}

function shareStoreOnly() {
  var d = window._shareData;
  document.getElementById('itemModalOverlay').classList.remove('show');
  shareStoreLink(d.name);
}

function copyToClipboard(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(function() {
      showToast('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ');
    }).catch(function() { fallbackCopy(text); });
  } else {
    fallbackCopy(text);
  }
}
function fallbackCopy(text) {
  var ta = document.createElement('textarea');
  ta.value = text; ta.style.cssText = 'position:fixed;left:-9999px';
  document.body.appendChild(ta); ta.select();
  try { document.execCommand('copy'); showToast('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ'); } catch(e) { showToast('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£Ω'); }
  document.body.removeChild(ta);
}

// ===== Êé•Êî∂ÂàÜ‰∫´Ë≥ºÁâ©ËªäÈÄ£Áµê =====
function loadSharedCart() {
  var params = new URLSearchParams(window.location.search);
  var cartParam = params.get('cart');
  if (!cartParam) return;
  try {
    var decoded = JSON.parse(decodeURIComponent(escape(atob(cartParam))));
    if (!Array.isArray(decoded) || decoded.length === 0) return;
    // Á≠âËèúÂñÆËºâÂÖ•ÂæåÊâçÂåØÂÖ•
    var checkMenu = setInterval(function() {
      if (menuItems.length > 0) {
        clearInterval(checkMenu);
        var imported = 0;
        decoded.forEach(function(c) {
          var item = menuItems.find(function(i) { return i.id === c.i; });
          if (item && item.available) {
            cart.push({ id: c.i, qty: c.q || 1, price: c.p || item.price, sizeName: c.s || null, selectedOpts: (c.o || []).map(function(n) { return { name: n }; }) });
            imported++;
          }
        });
        if (imported > 0) {
          updateCartUI();
          showToast('Â∑≤ÂåØÂÖ• ' + imported + ' È†ÖÂÖ±‰∫´ÈªûÈ§êÔºÅ');
          // Ê∏ÖÈô§ URL ‰∏≠ÁöÑ cart ÂèÉÊï∏
          var url = new URL(window.location);
          url.searchParams.delete('cart');
          window.history.replaceState({}, '', url);
        }
      }
    }, 200);
  } catch(e) { /* Ëß£ÊûêÂ§±ÊïóÈùúÈªòÂøΩÁï• */ }
}

// ===== RENDER SIDEBAR =====
function renderSidebar() {
  const sidebar = document.getElementById('categorySidebar');
  sidebar.innerHTML = categories.map((cat, i) =>
    '<div class="cat-item ' + (i === 0 ? 'active' : '') + '" data-cat="' + cat.id + '" onclick="scrollToCategory(\'' + cat.id + '\')">' +
      '<span class="cat-icon">' + escHtml(cat.icon) + '</span>' +
      '<span class="cat-name">' + escHtml(cat.name) + '</span>' +
      '<span class="cat-badge" id="catBadge_' + cat.id + '">0</span>' +
    '</div>'
  ).join('');
  activeCategory = categories[0]?.id;
}

// ===== RENDER MENU CONTENT =====
function renderMenuContent(filter) {
  filter = filter || '';
  const content = document.getElementById('menuContent');
  let html = '';

  const featured = menuItems.filter(i => i.featured);
  if (featured.length > 0 && !filter) {
    html += '<div class="featured-section">' +
      '<div class="section-title"><span class="fire">' + ICONS.fire + '</span><h2>Êú¨Â∫óÂøÖÈªûÊé®Ëñ¶</h2><span class="subtitle">‰∫∫Ê∞£Á≤æÈÅ∏ &#8594;</span></div>' +
      '<div class="featured-scroll">' + featured.map(item => renderFeaturedCard(item)).join('') + '</div></div>';
  }

  categories.forEach(cat => {
    let items = menuItems.filter(i => i.category === cat.id);
    if (filter) { var q = filter.toLowerCase(); items = items.filter(i => i.name.toLowerCase().includes(q) || (i.desc && i.desc.toLowerCase().includes(q))); }
    if (items.length === 0 && filter) return;

    html += '<div class="category-section" id="catSection_' + cat.id + '" data-cat="' + cat.id + '">' +
      '<div class="category-header"><span class="cat-emoji">' + escHtml(cat.icon) + '</span><h3>' + escHtml(cat.name) + '</h3><span class="count">' + items.length + ' ÈÅì</span>' +
      '<div class="view-toggle"><button class="view-toggle-btn active" onclick="setViewMode(\'list\', this)" title="ÂàóË°®"><svg width="14" height="14" viewBox="0 0 14 14" fill="none"><rect x="0" y="1" width="14" height="2.5" rx="1" fill="currentColor"/><rect x="0" y="5.75" width="14" height="2.5" rx="1" fill="currentColor"/><rect x="0" y="10.5" width="14" height="2.5" rx="1" fill="currentColor"/></svg></button><button class="view-toggle-btn" onclick="setViewMode(\'grid\', this)" title="Â§ßÂúñ"><svg width="14" height="14" viewBox="0 0 14 14" fill="none"><rect x="0" y="0" width="6" height="6" rx="1.5" fill="currentColor"/><rect x="8" y="0" width="6" height="6" rx="1.5" fill="currentColor"/><rect x="0" y="8" width="6" height="6" rx="1.5" fill="currentColor"/><rect x="8" y="8" width="6" height="6" rx="1.5" fill="currentColor"/></svg></button></div>' +
      '</div>' +
      (items.length === 0
        ? '<div class="empty-state"><div class="empty-icon">' + ICONS.empty + '</div><div class="empty-title">Âç≥Â∞áÊé®Âá∫</div><div class="empty-desc">Ê≠§È°ûÂà•Êö´ÁÑ°ËèúÂìÅ</div></div>'
        : items.map((item, idx) => renderMenuItem(item, idx)).join('')) +
    '</div>';
  });

  content.innerHTML = html;
  content.querySelectorAll('.menu-item').forEach((el, i) => { el.style.animationDelay = Math.min(i * 0.04, 0.4) + 's'; });
}

// ÂÆâÂÖ®ÂºïÁî® IDÔºàÊîØÊè¥ UUID Â≠ó‰∏≤ÂíåÊï∏Â≠óÔºâ
function qid(id) { return "'" + id + "'"; }

function renderFeaturedCard(item) {
  const imgSrc = item.image || generatePlaceholder(item.name);
  const desc = item.description ? '<div class="featured-desc">' + escHtml(item.description) + '</div>' : '';
  var transName = getTranslatedName(item);
  var transHtml = transName ? '<div class="item-name-translated">' + escHtml(transName) + '</div>' : '';
  return '<div class="featured-card" onclick="openItemModal(' + qid(item.id) + ')">' +
    '<img class="featured-img" src="' + imgSrc + '" alt="' + escHtml(item.name) + '" onerror="this.src=\'' + generatePlaceholder(item.name) + '\'">' +
    '<span class="featured-badge">' + (currentLang === 'zh' ? 'ÂøÖÈªû' : '‚òÖ') + '</span>' +
    '<div class="featured-info"><div class="featured-name">' + escHtml(item.name) + '</div>' +
    transHtml + desc +
    '<div class="featured-price"><span class="currency">$</span>' + item.price + '</div></div>' +
    '<button class="featured-add" aria-label="Âä†ÂÖ• ' + escHtml(item.name) + '" onclick="event.stopPropagation(); addToCart(' + qid(item.id) + ', event)">+</button></div>';
}

function renderMenuItem(item) {
  const imgSrc = item.image || generatePlaceholder(item.name);
  const cartQty = getCartQty(item.id);
  const tagHtml = (item.tags || []).map(t => {
    const labels = { hot: 'ÁÜ±Èä∑', new: 'Êñ∞ÂìÅ', chef: '‰∏ªÂªöÊé®Ëñ¶', 'Êé®Ëñ¶': 'Êé®Ëñ¶', 'Â•óÈ§ê': 'Â•óÈ§ê' };
    return '<span class="item-tag ' + t + '">' + (labels[t] || t) + '</span>';
  }).join('');
  const spicyIcons = item.spicy > 0 ? ICONS.chili.repeat(Math.min(item.spicy, 3)) : '';
  let sizeHtml = '';
  if (item.sizes && item.sizes.length > 0) {
    sizeHtml = '<div class="item-sizes">' + item.sizes.map((s, i) =>
      '<span class="size-option ' + (i === item.sizes.length - 1 ? 'active' : '') + '" onclick="event.stopPropagation(); selectSize(' + qid(item.id) + ', ' + i + ')">' + s.name + ' $' + s.price + '</span>'
    ).join('') + '</div>';
  }
  return '<div class="menu-item" data-id="' + item.id + '" onclick="openItemModal(' + qid(item.id) + ')">' +
    '<div class="item-img-wrap"><img class="item-img" src="' + imgSrc + '" alt="' + escHtml(item.name) + '" loading="lazy" onerror="this.src=\'' + generatePlaceholder(item.name) + '\'">' +
    (spicyIcons ? '<span class="item-spicy">' + spicyIcons + '</span>' : '') + '</div>' +
    '<div class="item-info"><div class="item-name">' + escHtml(item.name) + '</div>' +
    (currentLang !== 'zh' ? '<div class="item-name-translated">' + escHtml(getTranslatedName(item)) + '</div>' : '') +
    '<div class="item-desc">' + escHtml(item.desc || '') + '</div>' +
    (tagHtml ? '<div class="item-tags">' + tagHtml + '</div>' : '') +
    '<div class="item-bottom"><div class="item-price-area">' +
    '<div class="item-price"><span class="currency">$</span>' + getItemDisplayPrice(item) + '</div>' + sizeHtml + '</div>' +
    '<div class="item-actions" onclick="event.stopPropagation()">' +
    (cartQty > 0
      ? '<div class="qty-control"><button class="qty-btn minus" aria-label="Ê∏õÂ∞ëÊï∏Èáè" onclick="changeQty(' + qid(item.id) + ', -1, event)">&#8722;</button><span class="qty-num">' + cartQty + '</span><button class="qty-btn" aria-label="Â¢ûÂä†Êï∏Èáè" onclick="changeQty(' + qid(item.id) + ', 1, event)">+</button></div>'
      : '<button class="add-btn" aria-label="Âä†ÂÖ• ' + escHtml(item.name) + '" onclick="addToCart(' + qid(item.id) + ', event)">+</button>') +
    '</div></div></div></div>';
}

function getItemDisplayPrice(item) {
  return (item.sizes && item.sizes.length > 0) ? item.sizes[item.sizes.length - 1].price : item.price;
}

function generatePlaceholder(name) {
  const colors = ['#FFE0B2','#FFCCBC','#C8E6C9','#B3E5FC','#F0F4C3','#D1C4E9','#FFCDD2','#B2DFDB'];
  const hash = name.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
  const bg = colors[hash % colors.length];
  const ch = name.charAt(0);
  return 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="' + bg + '" width="200" height="200"/><text x="100" y="115" font-size="56" text-anchor="middle" fill="#555">' + ch + '</text></svg>');
}

// ===== SCROLL SPY =====
function setupScrollSpy() {
  const content = document.getElementById('menuContent');
  content.addEventListener('scroll', function() {
    if (isScrollingByClick) return;
    const sections = content.querySelectorAll('.category-section');
    let current = null;
    sections.forEach(sec => {
      const rect = sec.getBoundingClientRect();
      const contentRect = content.getBoundingClientRect();
      if (rect.top <= contentRect.top + 80) current = sec.dataset.cat;
    });
    if (current && current !== activeCategory) setActiveCategory(current);
  }, { passive: true });
}

function scrollToCategory(catId) {
  const section = document.getElementById('catSection_' + catId);
  if (!section) return;
  isScrollingByClick = true;
  setActiveCategory(catId);
  const content = document.getElementById('menuContent');
  const contentRect = content.getBoundingClientRect();
  const sectionRect = section.getBoundingClientRect();
  content.scrollTo({ top: content.scrollTop + sectionRect.top - contentRect.top - 8, behavior: 'smooth' });
  setTimeout(function() { isScrollingByClick = false; }, 600);
}

function setActiveCategory(catId) {
  activeCategory = catId;
  document.querySelectorAll('.cat-item').forEach(el => { el.classList.toggle('active', el.dataset.cat === catId); });
  const activeEl = document.querySelector('.cat-item[data-cat="' + catId + '"]');
  if (activeEl) activeEl.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
}

// ===== SEARCH =====
function setupSearch() {
  const input = document.getElementById('searchInput');
  const clear = document.getElementById('searchClear');
  let timer;
  input.addEventListener('input', function() {
    clearTimeout(timer);
    clear.classList.toggle('show', input.value.length > 0);
    timer = setTimeout(function() { renderMenuContent(input.value.trim()); }, 200);
  });
}
function clearSearch() {
  const input = document.getElementById('searchInput');
  input.value = '';
  document.getElementById('searchClear').classList.remove('show');
  renderMenuContent();
  input.focus();
}

// ===== GUEST SELECTOR =====
function setupGuestSelector() {
  document.querySelectorAll('.guest-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.guest-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      guestCount = parseInt(btn.dataset.num);
    });
  });
}
function promptGuestCount() {
  const num = prompt('Ë´ãËº∏ÂÖ•Áî®È§ê‰∫∫Êï∏Ôºö', '7');
  if (num && parseInt(num) > 0) {
    guestCount = parseInt(num);
    document.querySelectorAll('.guest-btn').forEach(b => b.classList.remove('active'));
    showToast('Â∑≤ÈÅ∏Êìá ' + guestCount + ' ‰∫∫Áî®È§ê');
  }
}

// ===== CART LOGIC =====
function addToCart(itemId, event) {
  const item = menuItems.find(i => i.id === itemId);
  if (!item) return;
  const existing = cart.find(c => c.id === itemId && !c.optKey);
  if (existing) { existing.qty += 1; }
  else {
    const price = item.sizes ? item.sizes[item.sizes.length - 1].price : item.price;
    const sizeName = item.sizes ? item.sizes[item.sizes.length - 1].name : null;
    cart.push({ id: itemId, qty: 1, price: price, sizeName: sizeName });
  }
  updateCartUI();
  animateAddToCart(event);
  refreshItemDisplay(itemId);
}

function changeQty(itemId, delta, event) {
  if (event) event.stopPropagation();
  const idx = cart.findIndex(c => c.id === itemId);
  if (idx === -1) return;
  cart[idx].qty += delta;
  if (cart[idx].qty <= 0) cart.splice(idx, 1);
  updateCartUI();
  refreshItemDisplay(itemId);
}
function changeCartIdx(idx, delta) {
  if (idx < 0 || idx >= cart.length) return;
  var itemId = cart[idx].id;
  cart[idx].qty += delta;
  if (cart[idx].qty <= 0) cart.splice(idx, 1);
  updateCartUI();
  refreshItemDisplay(itemId);
}

function getCartQty(itemId) {
  return cart.filter(c => c.id === itemId).reduce((sum, c) => sum + c.qty, 0);
}

function refreshItemDisplay(itemId) {
  const itemEl = document.querySelector('.menu-item[data-id="' + itemId + '"]');
  if (!itemEl) return;
  const item = menuItems.find(i => i.id === itemId);
  if (!item) return;
  const actionsEl = itemEl.querySelector('.item-actions');
  const cartQty = getCartQty(itemId);
  var itemName = item ? escHtml(item.name) : '';
  actionsEl.innerHTML = cartQty > 0
    ? '<div class="qty-control"><button class="qty-btn minus" aria-label="Ê∏õÂ∞ëÊï∏Èáè" onclick="changeQty(' + qid(itemId) + ', -1, event)">&#8722;</button><span class="qty-num">' + cartQty + '</span><button class="qty-btn" aria-label="Â¢ûÂä†Êï∏Èáè" onclick="changeQty(' + qid(itemId) + ', 1, event)">+</button></div>'
    : '<button class="add-btn" aria-label="Âä†ÂÖ• ' + itemName + '" onclick="addToCart(' + qid(itemId) + ', event)">+</button>';
}

function updateCartUI() {
  const totalQty = cart.reduce((s, c) => s + c.qty, 0);
  const totalPrice = cart.reduce((s, c) => s + c.price * c.qty, 0);
  document.getElementById('cartBar').classList.toggle('hidden', totalQty === 0);
  document.getElementById('cartCount').textContent = totalQty;
  document.getElementById('cartItemsText').textContent = 'Â∑≤ÈÅ∏ ' + totalQty + ' ‰ª∂';
  document.getElementById('cartTotal').textContent = totalPrice;
  document.getElementById('drawerTotal').textContent = totalPrice;
  document.getElementById('drawerCount').textContent = totalQty;

  categories.forEach(cat => {
    const badge = document.getElementById('catBadge_' + cat.id);
    if (!badge) return;
    const catQty = cart.filter(c => { const item = menuItems.find(i => i.id === c.id); return item && item.category === cat.id; }).reduce((s, c) => s + c.qty, 0);
    badge.textContent = catQty;
    badge.classList.toggle('show', catQty > 0);
  });
  renderDrawerItems();
}

function renderDrawerItems() {
  const container = document.getElementById('drawerItems');
  if (cart.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">' + ICONS.cart + '</div><div class="empty-title">Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ</div><div class="empty-desc">Âø´ÂéªÈÅ∏ÂπæÈÅìÂ•ΩËèúÂêßÔºÅ</div></div>';
    return;
  }
  container.innerHTML = cart.map(function(c, idx) {
    const item = menuItems.find(i => i.id === c.id);
    if (!item) return '';
    const imgSrc = item.image || generatePlaceholder(item.name);
    return '<div class="drawer-item">' +
      '<img class="drawer-item-img" src="' + imgSrc + '" alt="' + escHtml(item.name) + '" onerror="this.src=\'' + generatePlaceholder(item.name) + '\'">' +
      '<div class="drawer-item-info"><div class="drawer-item-name">' + escHtml(item.name) + '</div>' +
      (c.optKey ? '<div class="drawer-item-size">' + escHtml(c.optKey) + '</div>' : '') +
      '<div class="drawer-item-price"><span class="currency">$</span>' + (c.price * c.qty) + '</div></div>' +
      '<div class="drawer-item-qty"><button class="drawer-qty-btn" onclick="changeCartIdx(' + idx + ', -1)">&#8722;</button>' +
      '<span class="drawer-qty-num">' + c.qty + '</span>' +
      '<button class="drawer-qty-btn" onclick="changeCartIdx(' + idx + ', 1)">+</button></div></div>';
  }).join('');
}

function clearCart() {
  if (!confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫Ë≥ºÁâ©ËªäÂóéÔºü')) return;
  const ids = cart.map(c => c.id);
  cart = [];
  updateCartUI();
  ids.forEach(id => refreshItemDisplay(id));
  toggleCartDrawer();
  showToast('Ë≥ºÁâ©ËªäÂ∑≤Ê∏ÖÁ©∫');
}

function toggleCartDrawer() {
  const overlay = document.getElementById('cartOverlay');
  const drawer = document.getElementById('cartDrawer');
  const isOpen = drawer.classList.contains('show');
  if (isOpen) { overlay.classList.remove('show'); drawer.classList.remove('show'); }
  else { renderDrawerItems(); overlay.classList.add('show'); drawer.classList.add('show'); }
}

// ===== ITEM DETAIL MODAL =====
function openItemModal(itemId) {
  const item = menuItems.find(i => i.id === itemId);
  if (!item) return;
  modalItem = item;
  modalQtyVal = 1;
  modalSelectedSize = item.sizes ? item.sizes.length - 1 : null;
  const imgSrc = item.image || generatePlaceholder(item.name);
  document.getElementById('modalImg').src = imgSrc;
  document.getElementById('modalImg').onerror = function() { this.src = generatePlaceholder(item.name); };
  document.getElementById('modalName').textContent = item.name;
  document.getElementById('modalDesc').textContent = item.desc || 'Êö´ÁÑ°ÊèèËø∞';
  document.getElementById('modalQty').textContent = modalQtyVal;
  let optHtml = '';
  if (item.sizes && item.sizes.length > 0) {
    var hasImgs = item.sizes.some(function(s) { return s.image; });
    if (hasImgs) {
      optHtml += '<div class="modal-option-group"><div class="modal-option-title">‰ªΩÈáè <span class="required">ÂøÖÈÅ∏</span></div><div class="modal-options has-images">' +
        item.sizes.map(function(s, i) {
          var sImg = s.image || generatePlaceholder(s.name);
          return '<div class="modal-opt-card ' + (i === modalSelectedSize ? 'active' : '') + '" onclick="selectModalSize(' + i + ')">' +
            '<img class="opt-card-img" src="' + sImg + '" onerror="this.src=\'' + generatePlaceholder(s.name) + '\'">' +
            '<div class="opt-card-check">‚úì</div>' +
            '<div class="opt-card-info"><div class="opt-card-name">' + escHtml(s.name) + '</div>' +
            '<div class="opt-card-price">$' + s.price + '</div></div></div>';
        }).join('') +
      '</div></div>';
    } else {
      optHtml += '<div class="modal-option-group"><div class="modal-option-title">‰ªΩÈáè <span class="required">ÂøÖÈÅ∏</span></div><div class="modal-options">' +
        item.sizes.map((s, i) => '<button class="modal-opt-btn ' + (i === modalSelectedSize ? 'active' : '') + '" onclick="selectModalSize(' + i + ')">' + escHtml(s.name) + ' - $' + s.price + '</button>').join('') +
      '</div></div>';
    }
  }
  // È°ØÁ§∫ÈùûÂ∞∫ÂØ∏ÁöÑ optionsÔºàÂ¶ÇÈ£≤ÊñôÈÅ∏Êìá„ÄÅÂèØÊ®Ç/Èõ™Á¢ßÔºâ
  if (item.options && Array.isArray(item.options)) {
    item.options.forEach(function(grp, gi) {
      if (grp.group === 'Â∞∫ÂØ∏') return; // Â∑≤ËôïÁêÜÁÇ∫ sizes
      var reqHtml = grp.required ? ' <span class="required">ÂøÖÈÅ∏</span>' : '';
      var grpItems = grp.items || [];
      var grpHasImgs = grpItems.some(function(o) { return o.image; });
      if (grpHasImgs) {
        optHtml += '<div class="modal-option-group" data-optgrp="' + gi + '"><div class="modal-option-title">' + escHtml(grp.group) + reqHtml + '</div><div class="modal-options has-images">' +
          grpItems.map(function(opt, oi) {
            var oImg = opt.image || generatePlaceholder(opt.name);
            var priceText = opt.price ? '+$' + opt.price : 'ÂÖçË≤ª';
            return '<div class="modal-opt-card' + (oi === 0 ? ' active' : '') + '" onclick="selectOption(this, ' + gi + ', ' + oi + ')">' +
              '<img class="opt-card-img" src="' + oImg + '" onerror="this.src=\'' + generatePlaceholder(opt.name) + '\'">' +
              '<div class="opt-card-check">‚úì</div>' +
              '<div class="opt-card-info"><div class="opt-card-name">' + escHtml(opt.name) + '</div>' +
              '<div class="opt-card-price">' + priceText + '</div></div></div>';
          }).join('') +
        '</div></div>';
      } else {
        optHtml += '<div class="modal-option-group" data-optgrp="' + gi + '"><div class="modal-option-title">' + escHtml(grp.group) + reqHtml + '</div><div class="modal-options">' +
          grpItems.map(function(opt, oi) {
            return '<button class="modal-opt-btn' + (oi === 0 ? ' active' : '') + '" onclick="selectOption(this, ' + gi + ', ' + oi + ')">' + escHtml(opt.name) + (opt.price ? ' +$' + opt.price : '') + '</button>';
          }).join('') +
        '</div></div>';
      }
    });
  }
  if (item.spicy > 0) {
    optHtml += '<div class="modal-option-group"><div class="modal-option-title">Ëæ£Â∫¶</div><div class="modal-options">' +
      '<button class="modal-opt-btn" onclick="selectSpicy(this, 0)">‰∏çËæ£</button>' +
      '<button class="modal-opt-btn active" onclick="selectSpicy(this, 1)">Â∞èËæ£</button>' +
      '<button class="modal-opt-btn" onclick="selectSpicy(this, 2)">‰∏≠Ëæ£</button>' +
      '<button class="modal-opt-btn" onclick="selectSpicy(this, 3)">Â§ßËæ£</button></div></div>';
  }
  document.getElementById('modalOptions').innerHTML = optHtml;
  updateModalPrice();
  document.getElementById('itemModalOverlay').classList.add('show');
}

function closeItemModal(event) {
  if (event && event.target !== document.getElementById('itemModalOverlay') && !event.target.classList.contains('modal-close')) return;
  document.getElementById('itemModalOverlay').classList.remove('show');
  modalItem = null;
}

function selectModalSize(idx) {
  modalSelectedSize = idx;
  // ÊîØÊè¥ button Ê®°ÂºèÂíå card Ê®°Âºè
  var grp = document.querySelector('#modalOptions .modal-option-group:first-child');
  if (grp) {
    grp.querySelectorAll('.modal-opt-btn').forEach(function(btn, i) { btn.classList.toggle('active', i === idx); });
    grp.querySelectorAll('.modal-opt-card').forEach(function(card, i) { card.classList.toggle('active', i === idx); });
  }
  updateModalPrice();
}

function selectSpicy(btn, level) {
  btn.closest('.modal-options').querySelectorAll('.modal-opt-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function selectOption(el, grpIdx, optIdx) {
  // el ÂèØËÉΩÊòØ button Êàñ card div
  var container = el.closest('.modal-options');
  container.querySelectorAll('.modal-opt-btn').forEach(b => b.classList.remove('active'));
  container.querySelectorAll('.modal-opt-card').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}

function updateModalPrice() {
  if (!modalItem) return;
  let price = modalItem.price;
  if (modalItem.sizes && modalSelectedSize !== null) price = modalItem.sizes[modalSelectedSize].price;
  document.getElementById('modalPrice').textContent = price * modalQtyVal;
}

function modalQtyChange(delta) {
  modalQtyVal = Math.max(1, modalQtyVal + delta);
  document.getElementById('modalQty').textContent = modalQtyVal;
  updateModalPrice();
}

function modalAddToCart() {
  if (!modalItem) return;
  let price = modalItem.price;
  let sizeName = null;
  if (modalItem.sizes && modalSelectedSize !== null) {
    price = modalItem.sizes[modalSelectedSize].price;
    sizeName = modalItem.sizes[modalSelectedSize].name;
  }
  // Êî∂ÈõÜÈÅ∏ÊìáÁöÑ options
  var selectedOpts = [];
  document.querySelectorAll('#modalOptions [data-optgrp]').forEach(function(grpEl) {
    var activeBtn = grpEl.querySelector('.modal-opt-btn.active');
    if (activeBtn) selectedOpts.push(activeBtn.textContent.trim());
  });
  var optKey = sizeName ? sizeName : '';
  if (selectedOpts.length > 0) optKey += (optKey ? '/' : '') + selectedOpts.join('/');

  const existing = cart.find(c => c.id === modalItem.id && c.sizeName === sizeName && c.optKey === optKey);
  if (existing) { existing.qty += modalQtyVal; }
  else { cart.push({ id: modalItem.id, qty: modalQtyVal, price: price, sizeName: sizeName, optKey: optKey, selectedOpts: selectedOpts }); }
  updateCartUI();
  refreshItemDisplay(modalItem.id);
  closeItemModal({ target: document.getElementById('itemModalOverlay') });
  showToast('Â∑≤Âä†ÂÖ• ' + modalItem.name + ' x ' + modalQtyVal);
}

function selectSize(itemId, sizeIdx) {
  const itemEl = document.querySelector('.menu-item[data-id="' + itemId + '"]');
  if (!itemEl) return;
  itemEl.querySelectorAll('.size-option').forEach((el, i) => { el.classList.toggle('active', i === sizeIdx); });
}

function animateAddToCart(event) {
  if (!event) return;
  const btn = event.target || event.currentTarget;
  const rect = btn.getBoundingClientRect();
  const cartIcon = document.querySelector('.cart-icon-wrap');
  if (!cartIcon) return;
  const cartRect = cartIcon.getBoundingClientRect();
  const dot = document.createElement('div');
  dot.className = 'fly-dot';
  dot.style.left = (rect.left + rect.width / 2 - 7) + 'px';
  dot.style.top = (rect.top + rect.height / 2 - 7) + 'px';
  document.body.appendChild(dot);
  requestAnimationFrame(function() {
    dot.style.left = (cartRect.left + cartRect.width / 2 - 7) + 'px';
    dot.style.top = (cartRect.top + cartRect.height / 2 - 7) + 'px';
    dot.style.transform = 'scale(0.3)';
    dot.style.opacity = '0.5';
  });
  setTimeout(function() { dot.remove(); }, 600);
}

// ===== SUBMIT ORDER =====
function submitOrder() {
  if (cart.length === 0) { showToast('Ë´ãÂÖàÈÅ∏ÊìáËèúÂìÅ'); return; }
  const isTakeout = window._orderMode === 'takeout';
  const tableNum = isTakeout ? 'Â§ñÂ∏∂' : document.getElementById('tableNumber').value.trim();
  if (!isTakeout && !tableNum) { showToast('Ë´ãËº∏ÂÖ•Ê°åËôü'); document.getElementById('tableNumber').focus(); return; }
  const totalQty = cart.reduce((s, c) => s + c.qty, 0);
  const totalPrice = cart.reduce((s, c) => s + c.price * c.qty, 0);

  // ÁµÑÂêàÁ¢∫Ë™çÊ∏ÖÂñÆ HTML
  var listHtml = '';
  cart.forEach(function(c) {
    var item = menuItems.find(function(i) { return i.id === c.id; });
    var name = item ? item.name : 'Unknown';
    var detail = '';
    if (c.sizeName) detail += c.sizeName;
    if (c.selectedOpts && c.selectedOpts.length > 0) {
      var optNames = c.selectedOpts.map(function(o) { return typeof o === 'string' ? o : (o.name || ''); }).filter(Boolean).join(', ');
      detail += (detail ? ' / ' : '') + optNames;
    }
    listHtml += '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #F0F0F0;">' +
      '<div style="flex:1;min-width:0;">' +
        '<div style="font-weight:700;font-size:15px;color:#1A1A2E;">' + escHtml(name) + '</div>' +
        (detail ? '<div style="font-size:12px;color:#888;margin-top:2px;">' + escHtml(detail) + '</div>' : '') +
      '</div>' +
      '<div style="text-align:right;white-space:nowrap;margin-left:12px;">' +
        '<span style="font-size:13px;color:#666;">x' + c.qty + '</span>' +
        '<div style="font-weight:800;font-size:15px;color:var(--primary);">$' + (c.price * c.qty) + '</div>' +
      '</div></div>';
  });

  var overlay = document.getElementById('itemModalOverlay');
  overlay.innerHTML = '<div class="item-modal" onclick="event.stopPropagation()" style="padding:24px 20px;max-height:85vh;overflow-y:auto;">' +
    '<h2 style="text-align:center;font-size:20px;font-weight:800;margin:0 0 4px;">Á¢∫Ë™çË®ÇÂñÆ</h2>' +
    '<div style="text-align:center;font-size:13px;color:#888;margin-bottom:16px;">' +
      (isTakeout ? 'Â§ñÂ∏∂ÈªûÈ§ê' : 'ÂÖßÁî® ‚Äî Ê°åËôü ' + tableNum + '„Éª' + guestCount + ' ‰∫∫') +
    '</div>' +
    '<div style="margin-bottom:16px;">' + listHtml + '</div>' +
    renderUpsellSection() +
    '<div style="display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-top:2px solid #E5E5E5;">' +
      '<span style="font-size:15px;font-weight:700;">ÂêàË®à (' + totalQty + ' ‰ª∂)</span>' +
      '<span style="font-size:22px;font-weight:900;color:var(--primary);">$' + totalPrice + '</span>' +
    '</div>' +
    '<div style="display:flex;gap:10px;margin-top:16px;">' +
      '<button onclick="closeConfirmOrder()" style="flex:1;padding:14px;border:2px solid #DDD;border-radius:12px;background:#FFF;font-size:15px;font-weight:700;color:#666;cursor:pointer;">ËøîÂõû‰øÆÊîπ</button>' +
      '<button onclick="confirmAndSubmitOrder()" id="confirmSubmitBtn" style="flex:2;padding:14px;border:none;border-radius:12px;background:var(--primary);color:#FFF;font-size:15px;font-weight:700;cursor:pointer;">Á¢∫Ë™çÈÄÅÂá∫</button>' +
    '</div>' +
  '</div>';
  overlay.classList.add('show');
}

function closeConfirmOrder() {
  document.getElementById('itemModalOverlay').classList.remove('show');
}

// ===== VIEW MODE TOGGLE =====
function setViewMode(mode, btn) {
  var section = btn.closest('.category-section');
  var items = section.querySelector('.menu-items');
  if (!items) return;
  if (mode === 'grid') {
    items.classList.add('grid-view');
  } else {
    items.classList.remove('grid-view');
  }
  // Toggle button active state
  var btns = btn.parentElement.querySelectorAll('.view-toggle-btn');
  btns.forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
}

// ===== UPSELL RECOMMENDATIONS (ÁµêÂ∏≥ÂâçÂä†Ë≥ºÊé®Ëñ¶) =====
function getUpsellItems() {
  // ÂæûË≥ºÁâ©Ëªä‰∏≠ÊâæÂá∫Êú™ÈªûÁöÑÂêåÂàÜÈ°ûÊàñÊé®Ëñ¶ÂìÅÈ†Ö
  var cartIds = cart.map(function(c) { return c.id; });
  var cartCats = [];
  cart.forEach(function(c) {
    var item = menuItems.find(function(i) { return i.id === c.id; });
    if (item && item.category_id) cartCats.push(item.category_id);
  });

  // ÂÑ™ÂÖàÊé®Ëñ¶ÔºöÊúâÂúñÁâáÁöÑ + ‰∏çÂú®Ë≥ºÁâ©ËªäË£°ÁöÑ + ÂÉπÊ†ºËºÉ‰ΩéÔºàÈÖçËèú/È£≤ÊñôÈ°ûÔºâ
  var candidates = menuItems.filter(function(item) {
    if (cartIds.indexOf(item.id) !== -1) return false;
    if (!item.available) return false;
    return true;
  });

  // ÊéíÂ∫èÁ≠ñÁï•ÔºöÊúâÂúñÁâáÂÑ™ÂÖà„ÄÅÊé®Ëñ¶Ê®ôÁ±§ÂÑ™ÂÖà„ÄÅ‰ΩéÂÉπÂÑ™ÂÖàÔºàÂä†Ë≥ºÈÄöÂ∏∏ÊòØÂ∞èÂìÅÈ†ÖÔºâ
  candidates.sort(function(a, b) {
    var aScore = 0, bScore = 0;
    if (a.image) aScore += 10;
    if (b.image) bScore += 10;
    if (a.is_featured) aScore += 5;
    if (b.is_featured) bScore += 5;
    if ((a.tags || []).indexOf('hot') !== -1) aScore += 3;
    if ((b.tags || []).indexOf('hot') !== -1) bScore += 3;
    // ÂêåÂàÜÈ°ûÁöÑ‰∏çÂÑ™ÂÖàÔºàÈÅøÂÖçÊé®Ëñ¶ÂêåÈ°ûÂûãÔºâ
    if (cartCats.indexOf(a.category_id) === -1) aScore += 2;
    if (cartCats.indexOf(b.category_id) === -1) bScore += 2;
    return bScore - aScore;
  });

  return candidates.slice(0, 6);
}

function renderUpsellSection() {
  var items = getUpsellItems();
  if (items.length === 0) return '';

  var cardsHtml = '';
  items.forEach(function(item) {
    var imgSrc = item.image || generatePlaceholder(item.name);
    cardsHtml += '<div class="upsell-card" onclick="addUpsellItem(\'' + item.id + '\')">' +
      '<img class="upsell-card-img" src="' + imgSrc + '" alt="' + item.name + '" onerror="this.src=\'' + generatePlaceholder(item.name) + '\'">' +
      '<div class="upsell-card-info">' +
        '<div class="upsell-card-name">' + escHtml(item.name) + '</div>' +
        '<div class="upsell-card-price">$' + item.price + '</div>' +
      '</div>' +
      '<button class="upsell-card-add" onclick="event.stopPropagation()">+</button>' +
    '</div>';
  });

  return '<div class="upsell-section">' +
    '<div class="upsell-header"><span class="upsell-icon">ü§§</span><h4>Âà•‰∫∫‰πüÂä†‰∫ÜÈÄô‰∫õ</h4><span class="upsell-hint">ÈªûÊìäÂä†ÂÖ•</span></div>' +
    '<div class="upsell-scroll">' + cardsHtml + '</div>' +
  '</div>';
}

function addUpsellItem(itemId) {
  var item = menuItems.find(function(i) { return i.id === itemId; });
  if (!item) return;

  // Áõ¥Êé•Âä†ÂÖ•Ë≥ºÁâ©Ëªä
  var cartItem = { id: item.id, qty: 1, price: item.price, sizeName: null, selectedOpts: [] };
  cart.push(cartItem);
  updateCartUI();

  // ÈáçÊñ∞Ê∏≤ÊüìÁ¢∫Ë™çË®ÇÂñÆÈ†ÅÔºàÂåÖÂê´Êõ¥Êñ∞ÂæåÁöÑÊ∏ÖÂñÆÔºâ
  closeConfirmOrder();
  setTimeout(function() { submitOrder(); }, 150);
}

async function confirmAndSubmitOrder() {
  var btn = document.getElementById('confirmSubmitBtn');
  btn.disabled = true;
  btn.textContent = 'ÈÄÅÂá∫‰∏≠...';

  const isTakeout = window._orderMode === 'takeout';
  const tableNum = isTakeout ? 'Â§ñÂ∏∂' : document.getElementById('tableNumber').value.trim();
  const totalQty = cart.reduce((s, c) => s + c.qty, 0);
  const totalPrice = cart.reduce((s, c) => s + c.price * c.qty, 0);
  const orderItems = cart.map(c => {
    const item = menuItems.find(i => i.id === c.id);
    return { item_id: c.id, name: item ? item.name : 'Unknown', size: c.sizeName || null, options: c.selectedOpts || [], qty: c.qty, unit_price: c.price, subtotal: c.price * c.qty };
  });

  var orderNum = '';
  const memberPhone = document.getElementById('memberPhone')?.value?.trim() || '';
  const order = {
    store_id: currentStoreId,
    table_number: tableNum,
    items: orderItems,
    total: totalPrice,
    status: 'pending',
    order_type: isTakeout ? 'takeout' : 'dine_in',
    customer_phone: memberPhone || null,
    notes: isTakeout ? '' : 'Áî®È§ê‰∫∫Êï∏: ' + guestCount
  };
  try {
    if (currentStoreId) {
      const res = await fetch(SUPABASE_URL + '/rest/v1/orders', {
        method: 'POST', headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
        body: JSON.stringify(order)
      });
      if (!res.ok) {
        const errText = await res.text();
        console.error('Order API error:', res.status, errText, JSON.stringify(order));
        showToast('Ë®ÇÂñÆÈÄÅÂá∫Â§±Êïó: ' + res.status + ' ' + (errText || '').substring(0, 80));
        btn.disabled = false;
        btn.textContent = 'Á¢∫Ë™çÈÄÅÂá∫';
        return;
      }
      const resData = await res.json();
      if (resData && resData[0] && resData[0].order_number) orderNum = resData[0].order_number;
    }
  } catch (e) {
    console.error('Order submit error:', e);
    showToast('Ë®ÇÂñÆÈÄÅÂá∫Â§±Êïó: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'Á¢∫Ë™çÈÄÅÂá∫';
    return;
  }
  // ÊúÉÂì°ÈõÜÈªû
  let earnedPts = 0;
  if (loyaltyConfig) {
    earnedPts = await awardLoyaltyPoints(totalPrice) || 0;
  }
  showOrderSuccess(totalQty, totalPrice, tableNum, orderNum, earnedPts);
}

function showOrderSuccess(qty, price, table, orderNum, earnedPts) {
  const isTakeout = table === 'Â§ñÂ∏∂';
  const pointsHtml = earnedPts > 0 ? '<div style="background:#FEF3C7;border-radius:10px;padding:8px 16px;margin-bottom:16px;display:inline-block;font-size:13px;color:#92400E;">üéØ Êú¨Ê¨°Áç≤Âæó <b>' + earnedPts + '</b> Èªû</div>' : '';
  const overlay = document.getElementById('itemModalOverlay');
  overlay.innerHTML = '<div class="item-modal" onclick="event.stopPropagation()" style="text-align:center; padding: 40px 20px;">' +
    '<div style="font-size:64px; margin-bottom:16px; color:#4CAF50;">&#10003;</div>' +
    '<h2 style="font-size:22px; font-weight:800; margin-bottom:8px;">Ë®ÇÂñÆÂ∑≤ÈÄÅÂá∫ÔºÅ</h2>' +
    (orderNum ? '<div style="background:#F0FDF4;border:2px solid #86EFAC;border-radius:12px;padding:12px 20px;margin-bottom:16px;display:inline-block;"><div style="font-size:11px;color:#16A34A;margin-bottom:2px;">' + (isTakeout ? 'ÂèñÈ§êËôüÁ¢º' : 'Ë®ÇÂñÆËôüÁ¢º') + '</div><div style="font-size:36px;font-weight:900;color:#15803D;letter-spacing:4px;">' + orderNum + '</div></div>' : '') +
    '<p style="color:#666; font-size:14px; margin-bottom:20px;">' + (isTakeout ? 'Â§ñÂ∏∂' : 'Ê°åËôü ' + table) + '&#12288;' + qty + ' ÈÅìËèúÂìÅ&#12288;ÂêàË®à $' + price + '</p>' +
    pointsHtml +
    '<p style="color:#999; font-size:12px; margin-bottom:24px;">' + (isTakeout ? 'Ë´ãËá≥Ê´ÉÊ™ØÁ≠âÂÄôÂè´ËôüÂèñÈ§ê' : 'ÂªöÊàøÊ≠£Âú®Ê∫ñÂÇôÊÇ®ÁöÑÈ§êÈªûÔºåË´ãÁ®çÂÄô') + '</p>' +
    '<button onclick="resetOrder()" style="background: var(--primary); color: white; border: none; padding: 14px 40px; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; font-family: inherit;">ÁπºÁ∫åÈªûÈ§ê</button></div>';
  overlay.classList.add('show');
  document.getElementById('cartOverlay').classList.remove('show');
  document.getElementById('cartDrawer').classList.remove('show');
}

function resetOrder() {
  cart = [];
  updateCartUI();
  renderMenuContent();
  document.getElementById('itemModalOverlay').classList.remove('show');
  setTimeout(function() {
    document.getElementById('itemModalOverlay').innerHTML =
      '<div class="item-modal" onclick="event.stopPropagation()">' +
      '<img class="modal-img" id="modalImg" src="" alt="">' +
      '<button class="modal-close" onclick="closeItemModal()">&#10005;</button>' +
      '<div class="modal-body"><div class="modal-name" id="modalName"></div><div class="modal-desc" id="modalDesc"></div><div id="modalOptions"></div></div>' +
      '<div class="modal-footer"><div class="modal-price"><span class="currency">$</span><span id="modalPrice">0</span></div>' +
      '<div class="modal-qty-area"><div class="qty-control"><button class="qty-btn minus" onclick="modalQtyChange(-1)">&#8722;</button><span class="qty-num" id="modalQty">1</span><button class="qty-btn" onclick="modalQtyChange(1)">+</button></div></div>' +
      '<button class="modal-add-cart" onclick="modalAddToCart()">Âä†ÂÖ•Ë≥ºÁâ©Ëªä</button></div></div>';
  }, 400);
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  if (_toastTimer) clearTimeout(_toastTimer);
  _toastTimer = setTimeout(function() { toast.classList.remove('show'); _toastTimer = null; }, 2200);
}

// ===== ÊúÉÂì°ÈõÜÈªû =====
async function checkMemberPoints() {
  const phone = document.getElementById('memberPhone').value.trim();
  if (!phone || phone.length < 9) { showToast('Ë´ãËº∏ÂÖ•Ê≠£Á¢∫ÊâãÊ©üËôüÁ¢º'); return; }
  localStorage.setItem('member_phone_' + currentStoreId, phone);
  try {
    const res = await fetch(SUPABASE_URL + '/rest/v1/loyalty_points?store_id=eq.' + currentStoreId + '&customer_line_id=eq.' + encodeURIComponent(phone) + '&limit=1', {
      headers: { 'apikey': SUPABASE_KEY }
    });
    const data = await res.json();
    const info = document.getElementById('memberInfo');
    if (data && data.length > 0) {
      memberPointsData = data[0];
      const pts = memberPointsData.points || 0;
      const cfg = loyaltyConfig || {};
      const needed = cfg.points_per_reward || 10;
      const discount = cfg.reward_discount || 50;
      document.getElementById('memberPoints').textContent = 'üéØ ' + pts + ' Èªû';
      info.style.display = '';
      if (pts >= needed) {
        info.innerHTML = 'üéâ ÊÇ®Êúâ <b>' + pts + '</b> ÈªûÔºåÂèØÂÖåÊèõ <b>$' + discount + '</b> ÊäòÊâ£ÔºÅ<br><span style="font-size:11px;color:#94A3B8;">‰∏ãÊ¨°ÁµêÂ∏≥ÊôÇËá™ÂãïÊäòÊäµ</span>';
      } else {
        info.innerHTML = 'ÁõÆÂâç <b>' + pts + '</b> ÈªûÔºåÂÜçÈõÜ <b>' + (needed - pts) + '</b> ÈªûÂèØÂÖåÊèõ $' + discount + ' ÊäòÊâ£';
      }
    } else {
      memberPointsData = null;
      document.getElementById('memberPoints').textContent = 'Êñ∞ÊúÉÂì°';
      info.style.display = '';
      info.innerHTML = 'Ê≠°ËøéÂä†ÂÖ•ÔºÅÊ∂àË≤ªÂç≥ÂèØÈñãÂßãÈõÜÈªû';
    }
  } catch(e) { console.warn('Check points error:', e); }
}

async function awardLoyaltyPoints(orderTotal) {
  const phone = document.getElementById('memberPhone')?.value?.trim();
  if (!phone || phone.length < 9 || !loyaltyConfig) return;
  const spendPer = loyaltyConfig.spend_per_point || 50;
  const earnedPoints = Math.floor(orderTotal / spendPer);
  if (earnedPoints <= 0) return;
  try {
    if (memberPointsData) {
      // Update existing
      await fetch(SUPABASE_URL + '/rest/v1/loyalty_points?id=eq.' + memberPointsData.id, {
        method: 'PATCH',
        headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
        body: JSON.stringify({
          points: (memberPointsData.points || 0) + earnedPoints,
          total_earned: (memberPointsData.total_earned || 0) + earnedPoints,
          updated_at: new Date().toISOString()
        })
      });
    } else {
      // Insert new
      await fetch(SUPABASE_URL + '/rest/v1/loyalty_points', {
        method: 'POST',
        headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
        body: JSON.stringify({
          store_id: currentStoreId,
          customer_line_id: phone,
          points: earnedPoints,
          total_earned: earnedPoints
        })
      });
    }
    return earnedPoints;
  } catch(e) { console.warn('Award points error:', e); return 0; }
}
</script>
</body>
</html>