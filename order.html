<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Á∑ö‰∏äÈªûÈ§ê</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#F8FAFC; color:#0F172A; min-height:100vh; }

        .store-header {
            background:linear-gradient(135deg, var(--theme, #4F46E5), var(--theme-dark, #3730A3));
            color:#fff; padding:24px 16px; text-align:center;
        }
        .store-header .store-logo { width:60px; height:60px; border-radius:50%; border:3px solid rgba(255,255,255,0.3); object-fit:cover; margin-bottom:8px; }
        .store-header h1 { font-size:20px; margin-bottom:4px; }
        .store-header .store-desc { font-size:13px; opacity:0.85; }
        .store-header .store-info { font-size:12px; opacity:0.7; margin-top:8px; }

        .closed-banner { background:#FEF2F2; color:#DC2626; text-align:center; padding:14px; font-weight:700; font-size:14px; }
        .hours-info { background:#FFFBEB; color:#92400E; text-align:center; padding:8px; font-size:11px; }

        .category-tabs {
            display:flex; overflow-x:auto; gap:8px; padding:12px 16px; background:#fff;
            border-bottom:1px solid #E2E8F0; position:sticky; top:0; z-index:10;
            -webkit-overflow-scrolling:touch; scrollbar-width:none;
        }
        .category-tabs::-webkit-scrollbar { display:none; }
        .cat-tab {
            padding:8px 18px; border-radius:20px; border:1px solid #E2E8F0; background:#fff;
            font-size:13px; font-weight:600; white-space:nowrap; cursor:pointer; transition:all 0.2s;
        }
        .cat-tab.active { background:var(--theme, #4F46E5); color:#fff; border-color:var(--theme, #4F46E5); }

        .menu-list { padding:12px 16px; }
        .menu-card {
            display:flex; gap:12px; background:#fff; border-radius:14px; padding:12px;
            margin-bottom:10px; box-shadow:0 1px 4px rgba(0,0,0,0.06); align-items:center;
        }
        .menu-card img { width:80px; height:80px; border-radius:10px; object-fit:cover; flex-shrink:0; }
        .menu-card .no-img { width:80px; height:80px; border-radius:10px; background:#E2E8F0; display:flex; align-items:center; justify-content:center; font-size:28px; flex-shrink:0; }
        .menu-card .info { flex:1; min-width:0; }
        .menu-card .name { font-weight:700; font-size:14px; margin-bottom:2px; }
        .menu-card .desc { font-size:12px; color:#64748B; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .menu-card .price { font-size:16px; font-weight:800; color:var(--theme, #4F46E5); }
        .menu-card .tags { display:flex; gap:4px; margin-bottom:4px; }
        .menu-card .tag { font-size:10px; padding:2px 6px; border-radius:4px; background:#EEF2FF; color:#4F46E5; font-weight:600; }
        .add-btn {
            width:36px; height:36px; border-radius:50%; border:none; background:var(--theme, #4F46E5);
            color:#fff; font-size:20px; font-weight:700; cursor:pointer; flex-shrink:0; line-height:36px; text-align:center;
        }
        .unavailable { opacity:0.5; pointer-events:none; }

        .cart-fab {
            position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%;
            background:var(--theme, #4F46E5); color:#fff; border:none; font-size:28px;
            box-shadow:0 4px 16px rgba(0,0,0,0.2); cursor:pointer; z-index:100; display:none;
        }
        .cart-fab .badge {
            position:absolute; top:-4px; right:-4px; background:#EF4444; color:#fff;
            width:22px; height:22px; border-radius:50%; font-size:12px; font-weight:700;
            display:flex; align-items:center; justify-content:center;
        }

        .modal-overlay {
            display:none; position:fixed; top:0; left:0; right:0; bottom:0;
            background:rgba(0,0,0,0.5); z-index:200; align-items:flex-end; justify-content:center;
        }
        .modal-overlay.open { display:flex; }
        .modal-sheet {
            background:#fff; border-radius:20px 20px 0 0; width:100%; max-width:500px;
            max-height:85vh; overflow-y:auto; padding:24px 16px 32px;
        }
        .modal-sheet h2 { font-size:18px; margin-bottom:16px; }

        .cart-item { display:flex; align-items:center; gap:12px; padding:10px 0; border-bottom:1px solid #F1F5F9; }
        .cart-item .ci-name { flex:1; font-weight:600; font-size:14px; }
        .cart-item .ci-opts { font-size:11px; color:#94A3B8; }
        .cart-item .ci-price { font-weight:700; color:var(--theme, #4F46E5); min-width:60px; text-align:right; }
        .qty-ctrl { display:flex; align-items:center; gap:8px; }
        .qty-btn { width:28px; height:28px; border-radius:50%; border:1px solid #E2E8F0; background:#fff; font-size:16px; cursor:pointer; text-align:center; line-height:26px; }
        .qty-num { font-weight:700; font-size:14px; min-width:20px; text-align:center; }

        .cart-total { display:flex; justify-content:space-between; padding:14px 0; font-size:16px; font-weight:800; border-top:2px solid #0F172A; margin-top:8px; }

        .form-group { margin-bottom:12px; }
        .form-group label { display:block; font-size:13px; font-weight:600; color:#374151; margin-bottom:4px; }
        .form-group input, .form-group select, .form-group textarea {
            width:100%; padding:12px; border:1px solid #E2E8F0; border-radius:10px; font-size:14px; box-sizing:border-box;
        }

        .submit-btn {
            width:100%; padding:16px; border:none; border-radius:14px; font-size:16px; font-weight:700;
            color:#fff; background:var(--theme, #4F46E5); cursor:pointer; margin-top:12px;
        }
        .submit-btn:disabled { opacity:0.5; cursor:not-allowed; }

        .order-confirm { padding:24px 16px; text-align:center; }
        .order-confirm .check-icon { font-size:60px; margin-bottom:12px; }
        .order-confirm .order-no { font-size:24px; font-weight:900; color:var(--theme, #4F46E5); }
        .order-confirm .pickup-no { font-size:40px; font-weight:900; color:var(--theme, #4F46E5); margin-top:8px; }
        .order-confirm .status-badge { display:inline-block; padding:6px 16px; border-radius:20px; font-size:13px; font-weight:700; margin-top:12px; }

        .loading { text-align:center; padding:60px 20px; color:#94A3B8; }
        .error-page { text-align:center; padding:60px 20px; color:#EF4444; }

        /* ÂÆ¢Ë£ΩÂåñÈÅ∏È†Ö bottom sheet */
        .opt-group { margin-bottom:14px; }
        .opt-group-title { font-weight:700; font-size:14px; margin-bottom:6px; }
        .opt-group-req { font-size:11px; color:#EF4444; margin-left:4px; }
        .opt-choice { display:flex; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid #F8FAFC; cursor:pointer; }
        .opt-choice input { accent-color:var(--theme, #4F46E5); }
        .opt-choice-label { flex:1; font-size:14px; }
        .opt-choice-price { font-size:13px; color:#64748B; }
        .opt-total { font-size:16px; font-weight:800; text-align:right; margin-top:8px; color:var(--theme, #4F46E5); }

        .loyalty-bar { background:#F5F3FF; padding:8px 16px; display:flex; justify-content:space-between; align-items:center; font-size:12px; }

        .toast {
            position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:#0F172A;
            color:#fff; padding:10px 24px; border-radius:20px; font-size:13px; font-weight:600;
            z-index:9999; opacity:0; transition:opacity 0.3s; pointer-events:none;
        }
        .toast.show { opacity:1; }
    </style>
</head>
<body>
    <div id="loadingView" class="loading">
        <p style="font-size:24px;">üçΩÔ∏è</p>
        <p>ËºâÂÖ•‰∏≠...</p>
    </div>

    <div id="errorView" class="error-page" style="display:none;">
        <p style="font-size:48px;">üò•</p>
        <p style="font-size:16px;font-weight:700;margin-top:12px;">Êâæ‰∏çÂà∞ÂïÜÂ∫ó</p>
        <p style="font-size:13px;color:#94A3B8;margin-top:8px;">Ë´ãÁ¢∫Ë™ç QR Code ÊàñÁ∂≤ÂùÄÊòØÂê¶Ê≠£Á¢∫</p>
    </div>

    <div id="mainView" style="display:none;">
        <div class="store-header" id="storeHeader">
            <img id="storeLogo" class="store-logo" src="" style="display:none;">
            <h1 id="storeName"></h1>
            <div id="storeDesc" class="store-desc"></div>
            <div id="storeInfo" class="store-info"></div>
        </div>
        <!-- ÈõÜÈªû -->
        <div id="loyaltyBar" class="loyalty-bar" style="display:none;"></div>
        <!-- ÈùûÁáüÊ•≠ÊôÇÈñì / Êö´ÂÅúÊé•ÂñÆ -->
        <div id="closedBanner" class="closed-banner" style="display:none;"></div>
        <div id="hoursInfo" class="hours-info" style="display:none;"></div>
        <!-- ÂàÜÈ°û Tab -->
        <div class="category-tabs" id="categoryTabs"></div>
        <!-- ËèúÂñÆÂàóË°® -->
        <div class="menu-list" id="menuList"></div>
        <!-- Ë≥ºÁâ©ËªäÊµÆÂãïÊåâÈàï -->
        <button class="cart-fab" id="cartFab" onclick="openCart()">üõí<span class="badge" id="cartBadge">0</span></button>
    </div>

    <!-- ÂÆ¢Ë£ΩÂåñÈÅ∏È†Ö Modal -->
    <div class="modal-overlay" id="optionsModal">
        <div class="modal-sheet">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h2 id="optItemName" style="margin:0;"></h2>
                <button onclick="closeOptionsModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#94A3B8;">√ó</button>
            </div>
            <div id="optGroupsContainer"></div>
            <div class="opt-total">Â∞èË®àÔºö<span id="optSubtotal">$0</span></div>
            <button class="submit-btn" onclick="confirmAddToCart()" style="margin-top:10px;">Âä†ÂÖ•Ë≥ºÁâ©Ëªä</button>
        </div>
    </div>

    <!-- Ë≥ºÁâ©Ëªä Modal -->
    <div class="modal-overlay" id="cartModal">
        <div class="modal-sheet">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h2 style="margin:0;">üõí Ë≥ºÁâ©Ëªä</h2>
                <button onclick="closeCart()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#94A3B8;">√ó</button>
            </div>
            <div id="cartItems"></div>
            <div class="cart-total"><span>ÂêàË®à</span><span id="cartTotal">$0</span></div>
            <hr style="border:none;border-top:1px solid #E2E8F0;margin:16px 0;">
            <div class="form-group">
                <label>ÂßìÂêç *</label>
                <input type="text" id="custName" placeholder="Ë´ãËº∏ÂÖ•ÂßìÂêç">
            </div>
            <div class="form-group">
                <label>ÈõªË©±</label>
                <input type="tel" id="custPhone" placeholder="ÈÅ∏Â°´">
            </div>
            <div class="form-group">
                <label>Áî®È§êÊñπÂºè</label>
                <select id="orderType">
                    <option value="dine_in">ÂÖßÁî®</option>
                    <option value="takeout">Â§ñÂ∏∂</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ê°åËôü</label>
                <input type="text" id="tableNumber" placeholder="ÈÅ∏Â°´ÔºåÂÖßÁî®Ë´ãÂ°´ÂØ´">
            </div>
            <div class="form-group">
                <label>ÂèñÈ§êÊôÇÈñì</label>
                <select id="pickupTime">
                    <option value="">Áõ°Âø´</option>
                </select>
            </div>
            <div class="form-group">
                <label>ÂÇôË®ª</label>
                <textarea id="orderNotes" rows="2" placeholder="ÈÅ∏Â°´"></textarea>
            </div>
            <button class="submit-btn" id="submitOrderBtn" onclick="submitOrder()">ÈÄÅÂá∫Ë®ÇÂñÆ</button>
        </div>
    </div>

    <!-- Â•óÈ§êÈÅ∏Êìá Modal -->
    <div class="modal-overlay" id="comboModal">
        <div class="modal-sheet">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h2 id="comboItemName" style="margin:0;"></h2>
                <button onclick="closeComboModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#94A3B8;">√ó</button>
            </div>
            <div id="comboGroupsContainer"></div>
            <div class="opt-total">Â•óÈ§êÂÉπÔºö<span id="comboSubtotal">$0</span></div>
            <button class="submit-btn" onclick="confirmAddCombo()" style="margin-top:10px;">Âä†ÂÖ•Ë≥ºÁâ©Ëªä</button>
        </div>
    </div>

    <!-- Ë®ÇÂñÆÁ¢∫Ë™çÈ†Å -->
    <div id="orderConfirmView" style="display:none;">
        <div class="store-header" id="confirmHeader">
            <h1 id="confirmStoreName"></h1>
        </div>
        <div class="order-confirm">
            <div class="check-icon">‚úÖ</div>
            <p style="font-size:14px;color:#64748B;">Ë®ÇÂñÆÂ∑≤ÈÄÅÂá∫</p>
            <div class="pickup-no" id="confirmPickup"></div>
            <div class="order-no" id="confirmOrderNo" style="font-size:14px;"></div>
            <div class="status-badge" id="confirmStatus" style="background:#ECFDF5;color:#059669;">Á≠âÂæÖÁ¢∫Ë™ç</div>
            <div id="confirmDetail" style="text-align:left;margin-top:20px;background:#fff;border-radius:14px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,0.06);"></div>
            <button onclick="resetOrder()" style="margin-top:20px;padding:14px 32px;border:1px solid #E2E8F0;border-radius:12px;background:#fff;font-size:14px;font-weight:600;cursor:pointer;">ÁπºÁ∫åÈªûÈ§ê</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const SUPABASE_URL = 'https://nssuisyvlrqnqfxupklb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3Vpc3l2bHJxbnFmeHVwa2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTAwMzUsImV4cCI6MjA4NDg2NjAzNX0.q_B6v3gf1TOCuAq7z0xIw10wDueCSJn0p37VzdMfmbc';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const LIFF_ID = '2008962829-bnsS1bbB';

        let store = null;
        let categories = [];
        let menuItems = [];
        let cart = []; // [{item, qty, selectedOptions, optionsLabel, optionsPrice}]
        let activeCategoryId = null;
        let lineUserId = null;
        let customerLoyalty = null;
        let pendingItem = null; // Á≠âÂæÖÂÆ¢Ë£ΩÂåñÈÅ∏ÊìáÁöÑÂìÅÈ†Ö
        let pendingComboItem = null; // Á≠âÂæÖÂ•óÈ§êÈÅ∏ÊìáÁöÑÂìÅÈ†Ö
        let isStoreClosed = false;

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
        function escapeHTML(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

        // ===== ÂàùÂßãÂåñ =====
        async function init() {
            // ÂòóË©¶ LIFF ÁôªÂÖ•ÂèñÂæó userId
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    lineUserId = profile.userId;
                }
            } catch(e) { console.log('LIFF init skipped', e); }

            const params = new URLSearchParams(location.search);
            const slug = params.get('store');
            const sid = params.get('sid');
            try {
                let query = sb.from('store_profiles').select('*').eq('is_active', true);
                if (slug) query = query.eq('store_slug', slug);
                else if (sid) query = query.eq('id', sid);
                else throw new Error('no store param');
                const { data, error } = await query.maybeSingle();
                if (error) throw error;
                if (!data) throw new Error('store not found');

                store = data;
                applyTheme(store.theme_color);
                renderStoreHeader();
                checkStoreAvailability();
                await loadMenu();
                populatePickupTimes();
                if (lineUserId) loadLoyalty();
                document.getElementById('loadingView').style.display = 'none';
                document.getElementById('mainView').style.display = 'block';
            } catch(e) {
                console.error(e);
                document.getElementById('loadingView').style.display = 'none';
                document.getElementById('errorView').style.display = 'block';
            }
        }

        function applyTheme(color) {
            if (!color) return;
            document.documentElement.style.setProperty('--theme', color);
            const r = parseInt(color.slice(1,3),16), g = parseInt(color.slice(3,5),16), b = parseInt(color.slice(5,7),16);
            const darker = '#' + [r,g,b].map(c => Math.max(0, c - 40).toString(16).padStart(2,'0')).join('');
            document.documentElement.style.setProperty('--theme-dark', darker);
        }

        function renderStoreHeader() {
            document.getElementById('storeName').textContent = store.store_name;
            document.getElementById('storeDesc').textContent = store.description || '';
            const info = [];
            if (store.phone) info.push('üìû ' + store.phone);
            if (store.address) info.push('üìç ' + store.address);
            document.getElementById('storeInfo').textContent = info.join('  |  ');
            if (store.logo_url) {
                const logo = document.getElementById('storeLogo');
                logo.src = store.logo_url; logo.style.display = 'block';
            }
            document.title = store.store_name + ' - Á∑ö‰∏äÈªûÈ§ê';
        }

        // ===== ÁáüÊ•≠ÊôÇÈñì & Êé•ÂñÆÊ™¢Êü• =====
        function checkStoreAvailability() {
            const banner = document.getElementById('closedBanner');
            const hoursEl = document.getElementById('hoursInfo');
            // Êö´ÂÅúÊé•ÂñÆ
            if (store.accept_orders === false) {
                banner.textContent = '‚è∏Ô∏è Êú¨Â∫óÊö´ÂÅúÊé•ÂñÆ';
                banner.style.display = '';
                isStoreClosed = true;
                return;
            }
            // ÁáüÊ•≠ÊôÇÈñì
            const bh = store.business_hours;
            if (bh && typeof bh === 'object') {
                const dayKeys = ['sun','mon','tue','wed','thu','fri','sat'];
                const now = new Date();
                const todayKey = dayKeys[now.getDay()];
                const todayHours = bh[todayKey];
                if (todayHours && !todayHours.open) {
                    banner.textContent = 'üïê ‰ªäÊó•‰ºëÊÅØÔºåÁÑ°Ê≥ïÈªûÈ§ê';
                    banner.style.display = '';
                    isStoreClosed = true;
                } else if (todayHours && todayHours.start && todayHours.end) {
                    const nowMin = now.getHours() * 60 + now.getMinutes();
                    const [sh, sm] = todayHours.start.split(':').map(Number);
                    const [eh, em] = todayHours.end.split(':').map(Number);
                    const startMin = sh * 60 + sm;
                    const endMin = eh * 60 + em;
                    if (nowMin < startMin || nowMin > endMin) {
                        banner.textContent = `üïê ÁõÆÂâçÈùûÁáüÊ•≠ÊôÇÈñìÔºà${todayHours.start} ~ ${todayHours.end}Ôºâ`;
                        banner.style.display = '';
                        isStoreClosed = true;
                    }
                }
                // È°ØÁ§∫ÁáüÊ•≠ÊôÇÈñì
                const dayLabels = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'];
                const hoursStr = dayKeys.map((k, idx) => {
                    const h = bh[k];
                    if (!h || !h.open) return dayLabels[idx] + ' ‰ºë';
                    return dayLabels[idx] + ' ' + (h.start || '') + '-' + (h.end || '');
                }).join('„ÄÄ');
                hoursEl.textContent = 'ÁáüÊ•≠ÊôÇÈñìÔºö' + hoursStr;
                hoursEl.style.display = '';
            }
        }

        // ===== ÈõÜÈªû =====
        async function loadLoyalty() {
            if (!lineUserId || !store.loyalty_config) return;
            try {
                const { data } = await sb.from('loyalty_points').select('*')
                    .eq('store_id', store.id).eq('customer_line_id', lineUserId).maybeSingle();
                customerLoyalty = data;
                renderLoyaltyBar();
            } catch(e) { console.log('loyalty load failed', e); }
        }

        function renderLoyaltyBar() {
            const el = document.getElementById('loyaltyBar');
            const lc = store.loyalty_config;
            if (!lc) return;
            const pts = customerLoyalty?.points || 0;
            const canRedeem = pts >= (lc.points_to_redeem || 999999);
            el.style.display = '';
            el.innerHTML = `<span>üéØ ÊàëÁöÑÈªûÊï∏Ôºö<b>${pts}</b> Èªû</span>` +
                (canRedeem ? `<span style="color:#059669;font-weight:700;">ÂèØÊäòÊäµ $${lc.discount_amount}</span>` : `<span>ÂÜç ${(lc.points_to_redeem || 10) - pts} ÈªûÂèØÊäò $${lc.discount_amount || 50}</span>`);
        }

        // ===== ËèúÂñÆ =====
        async function loadMenu() {
            const { data: cats } = await sb.from('menu_categories').select('*').eq('store_id', store.id).eq('is_active', true).order('sort_order');
            categories = cats || [];
            const { data: items } = await sb.from('menu_items').select('*').eq('store_id', store.id).order('sort_order');
            menuItems = items || [];
            renderCategoryTabs();
            renderMenuItems();
        }

        function renderCategoryTabs() {
            const el = document.getElementById('categoryTabs');
            if (categories.length === 0) { el.style.display = 'none'; return; }
            activeCategoryId = null;
            el.innerHTML = `<div class="cat-tab active" onclick="filterCategory(null, this)">ÂÖ®ÈÉ®</div>` +
                categories.map(c => `<div class="cat-tab" onclick="filterCategory('${c.id}', this)">${escapeHTML(c.name)}</div>`).join('');
        }

        function filterCategory(catId, el) {
            activeCategoryId = catId;
            document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
            if (el) el.classList.add('active');
            renderMenuItems();
        }

        function renderMenuItems() {
            const el = document.getElementById('menuList');
            let items = menuItems;
            if (activeCategoryId) items = items.filter(i => i.category_id === activeCategoryId);
            if (items.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#94A3B8;padding:40px;">Â∞öÁÑ°È§êÈªû</p>';
                return;
            }
            el.innerHTML = items.map(item => {
                const avail = item.is_available !== false;
                const closed = isStoreClosed;
                const disabled = !avail || closed;
                const tags = (item.tags || []).map(t => `<span class="tag">${escapeHTML(t)}</span>`).join('');
                return `<div class="menu-card ${disabled ? 'unavailable' : ''}">
                    ${item.image_url ? `<img src="${item.image_url}" alt="${escapeHTML(item.name)}">` : `<div class="no-img">üçΩÔ∏è</div>`}
                    <div class="info">
                        ${tags ? '<div class="tags">' + tags + '</div>' : ''}
                        <div class="name">${escapeHTML(item.name)} ${item.is_combo ? '<span class="tag" style="background:#FEF3C7;color:#D97706;">Â•óÈ§ê</span>' : ''}</div>
                        <div class="desc">${escapeHTML(item.description || '')}</div>
                        <div class="price">$${item.price}</div>
                    </div>
                    ${disabled ? (avail ? '' : '<span style="font-size:12px;color:#EF4444;font-weight:700;">ÂîÆÂÆå</span>') : `<button class="add-btn" onclick="addToCart('${item.id}')">+</button>`}
                </div>`;
            }).join('');
        }

        // ===== ÂèñÈ§êÊôÇÈñì =====
        function populatePickupTimes() {
            const sel = document.getElementById('pickupTime');
            const now = new Date();
            const start = new Date(now);
            start.setMinutes(Math.ceil(start.getMinutes() / 15) * 15 + 15, 0, 0);
            for (let i = 0; i < 12; i++) {
                const t = new Date(start.getTime() + i * 15 * 60000);
                const label = t.getHours().toString().padStart(2, '0') + ':' + t.getMinutes().toString().padStart(2, '0');
                const opt = document.createElement('option');
                opt.value = label; opt.textContent = label;
                sel.appendChild(opt);
            }
        }

        // ===== ÂÆ¢Ë£ΩÂåñÈÅ∏È†Ö =====
        function addToCart(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            // Â•óÈ§êÁµÑÂêà
            if (item.is_combo && item.combo_config && item.combo_config.groups) {
                pendingComboItem = item;
                openComboModal(item);
                return;
            }
            // ÂÆ¢Ë£ΩÂåñÈÅ∏È†Ö
            const opts = item.options;
            if (opts && Array.isArray(opts) && opts.length > 0) {
                pendingItem = item;
                openOptionsModal(item);
                return;
            }
            // ÁÑ°ÂÆ¢Ë£Ω ‚Üí Áõ¥Êé•Âä†ÂÖ•
            const existing = cart.find(c => c.item.id === itemId && !c.optionsLabel);
            if (existing) { existing.qty++; }
            else { cart.push({ item, qty: 1, selectedOptions: null, optionsLabel: '', optionsPrice: 0 }); }
            updateCartUI();
            showToast(`Â∑≤Âä†ÂÖ• ${item.name}`);
        }

        function openOptionsModal(item) {
            document.getElementById('optItemName').textContent = item.name;
            const container = document.getElementById('optGroupsContainer');
            container.innerHTML = item.options.map((g, gIdx) => {
                const inputType = g.type === 'multi' ? 'checkbox' : 'radio';
                return `<div class="opt-group">
                    <div class="opt-group-title">${escapeHTML(g.name)} ${g.required ? '<span class="opt-group-req">*ÂøÖÈÅ∏</span>' : ''}</div>
                    ${g.choices.map((c, cIdx) => `
                        <label class="opt-choice">
                            <input type="${inputType}" name="optGrp${gIdx}" value="${cIdx}" onchange="calcOptionSubtotal()" ${g.type !== 'multi' && cIdx === 0 && g.required ? 'checked' : ''}>
                            <span class="opt-choice-label">${escapeHTML(c.label)}</span>
                            ${c.price > 0 ? `<span class="opt-choice-price">+$${c.price}</span>` : ''}
                        </label>
                    `).join('')}
                </div>`;
            }).join('');
            calcOptionSubtotal();
            document.getElementById('optionsModal').classList.add('open');
        }

        function closeOptionsModal() {
            document.getElementById('optionsModal').classList.remove('open');
            pendingItem = null;
        }

        function calcOptionSubtotal() {
            if (!pendingItem) return;
            let extra = 0;
            pendingItem.options.forEach((g, gIdx) => {
                document.querySelectorAll(`[name="optGrp${gIdx}"]:checked`).forEach(inp => {
                    const c = g.choices[parseInt(inp.value)];
                    if (c) extra += c.price || 0;
                });
            });
            document.getElementById('optSubtotal').textContent = '$' + (pendingItem.price + extra);
        }

        function confirmAddToCart() {
            if (!pendingItem) return;
            const item = pendingItem;
            // È©óË≠âÂøÖÈÅ∏
            for (let gIdx = 0; gIdx < item.options.length; gIdx++) {
                const g = item.options[gIdx];
                if (g.required) {
                    const checked = document.querySelectorAll(`[name="optGrp${gIdx}"]:checked`);
                    if (checked.length === 0) return showToast(`Ë´ãÈÅ∏Êìá${g.name}`);
                }
            }
            // Êî∂ÈõÜÈÅ∏È†Ö
            const labels = [];
            let extra = 0;
            const selected = [];
            item.options.forEach((g, gIdx) => {
                const checked = document.querySelectorAll(`[name="optGrp${gIdx}"]:checked`);
                checked.forEach(inp => {
                    const c = g.choices[parseInt(inp.value)];
                    if (c) {
                        labels.push(c.label);
                        extra += c.price || 0;
                        selected.push({ group: g.name, label: c.label, price: c.price || 0 });
                    }
                });
            });
            const optionsLabel = labels.join(' ');
            cart.push({ item, qty: 1, selectedOptions: selected, optionsLabel, optionsPrice: extra });
            updateCartUI();
            closeOptionsModal();
            showToast(`Â∑≤Âä†ÂÖ• ${item.name} ${optionsLabel}`);
        }

        // ===== Â•óÈ§êÁµÑÂêà =====
        function openComboModal(item) {
            document.getElementById('comboItemName').textContent = item.name;
            const groups = item.combo_config.groups;
            const container = document.getElementById('comboGroupsContainer');
            container.innerHTML = groups.map((g, gIdx) => {
                const pickLabel = g.pick === -1 ? '‰ªªÈÅ∏' : `ÈÅ∏ ${g.pick} È†Ö`;
                const inputType = g.pick === 1 ? 'radio' : 'checkbox';
                // ÊâæÂà∞Áæ§ÁµÑ‰∏≠ÂèØÈÅ∏ÁöÑÂìÅÈ†Ö
                const groupItems = (g.items || []).map(id => menuItems.find(i => i.id === id)).filter(Boolean);
                return `<div class="opt-group">
                    <div class="opt-group-title">${escapeHTML(g.name)} <span style="font-size:11px;color:#64748B;font-weight:400;">(${pickLabel})</span></div>
                    ${groupItems.map((gi, iIdx) => `
                        <label class="opt-choice">
                            <input type="${inputType}" name="comboGrp${gIdx}" value="${gi.id}" onchange="calcComboSubtotal()">
                            <span class="opt-choice-label">${escapeHTML(gi.name)}</span>
                            <span class="opt-choice-price">$${gi.price}</span>
                        </label>
                    `).join('')}
                    ${groupItems.length === 0 ? '<p style="font-size:12px;color:#94A3B8;">Ê≠§Áæ§ÁµÑÊö´ÁÑ°ÂìÅÈ†Ö</p>' : ''}
                </div>`;
            }).join('');
            document.getElementById('comboSubtotal').textContent = '$' + item.price;
            document.getElementById('comboModal').classList.add('open');
        }
        function closeComboModal() {
            document.getElementById('comboModal').classList.remove('open');
            pendingComboItem = null;
        }
        function calcComboSubtotal() {
            if (!pendingComboItem) return;
            document.getElementById('comboSubtotal').textContent = '$' + pendingComboItem.price;
        }
        function confirmAddCombo() {
            if (!pendingComboItem) return;
            const item = pendingComboItem;
            const groups = item.combo_config.groups;
            const labels = [];
            // È©óË≠âÊØèÂÄãÁæ§ÁµÑÁöÑÈÅ∏ÊìáÊï∏Èáè
            for (let gIdx = 0; gIdx < groups.length; gIdx++) {
                const g = groups[gIdx];
                const checked = document.querySelectorAll(`[name="comboGrp${gIdx}"]:checked`);
                if (g.pick > 0 && checked.length !== g.pick) {
                    return showToast(`${g.name}ÔºöË´ãÈÅ∏Êìá ${g.pick} È†Ö`);
                }
                checked.forEach(inp => {
                    const gi = menuItems.find(i => i.id === inp.value);
                    if (gi) labels.push(gi.name);
                });
            }
            const optionsLabel = labels.join('+');
            cart.push({ item, qty: 1, selectedOptions: null, optionsLabel, optionsPrice: 0 });
            updateCartUI();
            closeComboModal();
            showToast(`Â∑≤Âä†ÂÖ• ${item.name}`);
        }

        // ===== Ë≥ºÁâ©Ëªä =====
        function updateCartQty(cartIdx, delta) {
            cart[cartIdx].qty += delta;
            if (cart[cartIdx].qty <= 0) cart.splice(cartIdx, 1);
            updateCartUI();
            renderCartItems();
        }

        function updateCartUI() {
            const total = cart.reduce((s, c) => s + c.qty, 0);
            const fab = document.getElementById('cartFab');
            fab.style.display = total > 0 ? 'block' : 'none';
            document.getElementById('cartBadge').textContent = total;
        }

        function openCart() {
            if (cart.length === 0) return showToast('Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ');
            renderCartItems();
            document.getElementById('cartModal').classList.add('open');
        }
        function closeCart() { document.getElementById('cartModal').classList.remove('open'); }

        function renderCartItems() {
            const el = document.getElementById('cartItems');
            el.innerHTML = cart.map((c, idx) => {
                const unitPrice = c.item.price + (c.optionsPrice || 0);
                return `<div class="cart-item">
                    <div style="flex:1;">
                        <div class="ci-name">${escapeHTML(c.item.name)}</div>
                        ${c.optionsLabel ? `<div class="ci-opts">${escapeHTML(c.optionsLabel)}</div>` : ''}
                    </div>
                    <div class="qty-ctrl">
                        <button class="qty-btn" onclick="updateCartQty(${idx}, -1)">‚àí</button>
                        <span class="qty-num">${c.qty}</span>
                        <button class="qty-btn" onclick="updateCartQty(${idx}, 1)">+</button>
                    </div>
                    <div class="ci-price">$${unitPrice * c.qty}</div>
                </div>`;
            }).join('');
            const total = cart.reduce((s, c) => s + (c.item.price + (c.optionsPrice || 0)) * c.qty, 0);
            document.getElementById('cartTotal').textContent = '$' + total;
        }

        // ===== ÈÄÅÂá∫Ë®ÇÂñÆ =====
        async function submitOrder() {
            const name = document.getElementById('custName').value.trim();
            if (!name) return showToast('Ë´ãËº∏ÂÖ•ÂßìÂêç');
            if (cart.length === 0) return showToast('Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ');

            const btn = document.getElementById('submitOrderBtn');
            btn.disabled = true; btn.textContent = 'ÈÄÅÂá∫‰∏≠...';

            try {
                const items = cart.map(c => ({
                    name: c.item.name,
                    qty: c.qty,
                    price: c.item.price + (c.optionsPrice || 0),
                    subtotal: (c.item.price + (c.optionsPrice || 0)) * c.qty,
                    options: c.optionsLabel || null
                }));
                const total = items.reduce((s, i) => s + i.subtotal, 0);
                const orderNumber = 'O' + Date.now().toString(36).toUpperCase();

                // ÂèñÈ§êËôüÁ¢ºÔºö‰ªäÊó•Ë©≤Â∫óÊúÄÂ§ß + 1
                const today = new Date().toISOString().split('T')[0];
                const { data: maxOrder } = await sb.from('orders')
                    .select('pickup_number')
                    .eq('store_id', store.id)
                    .gte('created_at', today + 'T00:00:00')
                    .order('pickup_number', { ascending: false })
                    .limit(1)
                    .maybeSingle();
                const pickupNumber = (maxOrder?.pickup_number || 0) + 1;

                const pickupTime = document.getElementById('pickupTime').value || null;

                const record = {
                    store_id: store.id,
                    order_number: orderNumber,
                    pickup_number: pickupNumber,
                    customer_name: name,
                    customer_phone: document.getElementById('custPhone').value.trim() || null,
                    customer_line_id: lineUserId || null,
                    order_type: document.getElementById('orderType').value,
                    table_number: document.getElementById('tableNumber').value.trim() || null,
                    pickup_time: pickupTime,
                    items: items,
                    total: total,
                    notes: document.getElementById('orderNotes').value.trim() || null,
                    status: 'pending'
                };

                const { data, error } = await sb.from('orders').insert(record).select().single();
                if (error) throw error;

                // LINE Áæ§ÁµÑÊé®Êí≠Êñ∞Ë®ÇÂñÆ
                if (store.line_group_id) {
                    try {
                        const itemStr = items.map(i => `${i.name}${i.options ? '('+i.options+')' : ''} √ó${i.qty}`).join('\n');
                        const typeLabel = { dine_in: 'ÂÖßÁî®', takeout: 'Â§ñÂ∏∂' };
                        const msg = `üîî Êñ∞Ë®ÇÂñÆ #${String(pickupNumber).padStart(3, '0')}\nÂÆ¢‰∫∫Ôºö${name}\n${typeLabel[record.order_type] || ''}\n${itemStr}\nÂêàË®à $${total}`;
                        await sb.functions.invoke('send-line-notify', { body: { groupId: store.line_group_id, message: msg } });
                    } catch(e2) { console.warn('Áæ§ÁµÑÊé®Êí≠Â§±Êïó', e2); }
                }

                // ÈõÜÈªû
                if (lineUserId && store.loyalty_config) {
                    try {
                        const lc = store.loyalty_config;
                        const earnPts = Math.floor(total / (lc.spend_per_point || 50));
                        if (earnPts > 0) {
                            if (customerLoyalty) {
                                await sb.from('loyalty_points').update({
                                    points: (customerLoyalty.points || 0) + earnPts,
                                    total_earned: (customerLoyalty.total_earned || 0) + earnPts,
                                    updated_at: new Date().toISOString()
                                }).eq('id', customerLoyalty.id);
                            } else {
                                await sb.from('loyalty_points').insert({
                                    store_id: store.id,
                                    customer_line_id: lineUserId,
                                    points: earnPts,
                                    total_earned: earnPts
                                });
                            }
                        }
                    } catch(e2) { console.warn('ÈõÜÈªûÂ§±Êïó', e2); }
                }

                showOrderConfirmation(data, items, pickupNumber);
                cart = [];
                updateCartUI();
                closeCart();
            } catch(e) {
                console.error(e);
                showToast('Ë®ÇÂñÆÈÄÅÂá∫Â§±ÊïóÔºåË´ãÈáçË©¶');
            }
            btn.disabled = false; btn.textContent = 'ÈÄÅÂá∫Ë®ÇÂñÆ';
        }

        function showOrderConfirmation(order, items, pickupNumber) {
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('orderConfirmView').style.display = 'block';
            document.getElementById('confirmStoreName').textContent = store.store_name;
            document.getElementById('confirmPickup').textContent = 'ÂèñÈ§êËôüÁ¢º #' + String(pickupNumber).padStart(3, '0');
            document.getElementById('confirmOrderNo').textContent = 'Ë®ÇÂñÆÁ∑®Ëôü ' + order.order_number;

            const typeLabel = { dine_in:'ÂÖßÁî®', takeout:'Â§ñÂ∏∂', delivery:'Â§ñÈÄÅ' };
            document.getElementById('confirmDetail').innerHTML = `
                <div style="margin-bottom:12px;">
                    <div style="font-size:13px;color:#64748B;margin-bottom:4px;">È°ßÂÆ¢</div>
                    <div style="font-weight:600;">${escapeHTML(order.customer_name)} ${order.table_number ? '¬∑ Ê°åËôü ' + escapeHTML(order.table_number) : ''}</div>
                    <div style="font-size:13px;color:#64748B;">${typeLabel[order.order_type] || order.order_type} ${order.pickup_time ? '¬∑ ÂèñÈ§ê ' + escapeHTML(order.pickup_time) : ''}</div>
                </div>
                <div style="border-top:1px solid #F1F5F9;padding-top:8px;">
                    ${items.map(i => `
                        <div style="padding:4px 0;font-size:14px;">
                            <div style="display:flex;justify-content:space-between;">
                                <span>${escapeHTML(i.name)} x${i.qty}</span>
                                <span style="font-weight:600;">$${i.subtotal}</span>
                            </div>
                            ${i.options ? '<div style="font-size:11px;color:#94A3B8;margin-left:12px;">' + escapeHTML(i.options) + '</div>' : ''}
                        </div>
                    `).join('')}
                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-top:1px solid #E2E8F0;margin-top:8px;font-weight:800;font-size:16px;">
                        <span>ÂêàË®à</span>
                        <span style="color:var(--theme, #4F46E5);">$${order.total}</span>
                    </div>
                </div>
                ${order.notes ? '<div style="margin-top:8px;font-size:13px;color:#64748B;">ÂÇôË®ªÔºö' + escapeHTML(order.notes) + '</div>' : ''}
            `;
        }

        function resetOrder() {
            document.getElementById('orderConfirmView').style.display = 'none';
            document.getElementById('mainView').style.display = 'block';
            document.getElementById('custName').value = '';
            document.getElementById('custPhone').value = '';
            document.getElementById('tableNumber').value = '';
            document.getElementById('orderNotes').value = '';
            document.getElementById('pickupTime').value = '';
        }

        init();
    </script>
</body>
</html>
