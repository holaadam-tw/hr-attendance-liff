<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ç·šä¸Šé ç´„</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #F1F5F9; min-height: 100vh; }

.header { background: linear-gradient(135deg, #6366F1, #8B5CF6); color: #fff; padding: 16px 20px; }
.header h1 { font-size: 18px; font-weight: 700; }
.header .subtitle { font-size: 13px; opacity: .8; margin-top: 2px; }

.container { max-width: 480px; margin: 0 auto; padding: 16px; }

/* æ­¥é©ŸæŒ‡ç¤ºå™¨ */
.steps { display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 20px; padding: 16px 0; }
.step-dot { width: 10px; height: 10px; border-radius: 50%; background: #CBD5E1; transition: all .3s; }
.step-dot.active { background: #6366F1; width: 24px; border-radius: 5px; }
.step-dot.done { background: #10B981; }

/* æ­¥é©Ÿå…§å®¹ */
.step-panel { display: none; }
.step-panel.active { display: block; }

/* å¡ç‰‡æ¨™é¡Œ */
.panel-title { font-size: 18px; font-weight: 700; margin-bottom: 14px; color: #1E293B; }

/* æœå‹™å¡ç‰‡ */
.service-card { padding: 16px; background: #fff; border: 2px solid #E2E8F0; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: all .2s; }
.service-card:hover { border-color: #A5B4FC; }
.service-card.selected { border-color: #6366F1; background: #F5F3FF; }

/* äººå“¡å¡ç‰‡ */
.staff-card { display: flex; align-items: center; gap: 12px; padding: 14px; background: #fff; border: 2px solid #E2E8F0; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: all .2s; }
.staff-card.selected { border-color: #6366F1; background: #F5F3FF; }
.staff-avatar { width: 48px; height: 48px; border-radius: 24px; background: linear-gradient(135deg,#6366F1,#8B5CF6); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; font-size: 18px; flex-shrink: 0; }

/* æ—¥æœŸ */
.date-list { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 16px; padding-bottom: 4px; }
.date-item { flex-shrink: 0; min-width: 64px; padding: 10px 12px; text-align: center; background: #fff; border: 2px solid #E2E8F0; border-radius: 10px; cursor: pointer; transition: all .2s; }
.date-item.selected { border-color: #6366F1; background: #6366F1; color: #fff; }

/* æ™‚æ®µæ ¼å­ */
.time-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
.time-slot { padding: 12px; text-align: center; background: #fff; border: 2px solid #E2E8F0; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all .2s; }
.time-slot:hover { border-color: #A5B4FC; }
.time-slot.selected { border-color: #6366F1; background: #6366F1; color: #fff; }
.time-slot.disabled { background: #F8FAFC; color: #CBD5E1; cursor: not-allowed; border-color: #F1F5F9; }

/* æŒ‰éˆ• */
.btn-primary { width: 100%; padding: 14px; background: #6366F1; color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; font-family: inherit; margin-top: 16px; }
.btn-primary:disabled { background: #CBD5E1; cursor: not-allowed; }
.btn-outline { width: 100%; padding: 14px; background: #fff; color: #6366F1; border: 2px solid #6366F1; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; font-family: inherit; margin-top: 8px; }

/* è¡¨å–® */
.form-group { margin-bottom: 12px; }
.form-group label { font-size: 13px; font-weight: 600; display: block; margin-bottom: 4px; color: #374151; }
.form-input { width: 100%; padding: 12px; border: 2px solid #E2E8F0; border-radius: 10px; font-size: 15px; font-family: inherit; outline: none; transition: border-color .2s; }
.form-input:focus { border-color: #6366F1; }
textarea.form-input { resize: none; }

/* æ‘˜è¦å¡ */
.summary-card { background: #F5F3FF; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
.summary-grid { display: grid; grid-template-columns: auto 1fr; gap: 6px 12px; font-size: 14px; }
.summary-label { color: #94A3B8; }
.summary-value { font-weight: 600; color: #1E293B; }

/* æˆåŠŸé  */
.success-page { text-align: center; padding: 40px 20px; }
.success-icon { font-size: 64px; margin-bottom: 16px; }
.booking-number { background: #F5F3FF; padding: 16px; border-radius: 12px; margin-bottom: 20px; font-size: 22px; font-weight: 800; color: #6366F1; }
</style>
</head>
<body>

<div class="header">
  <h1 id="storeName">è¼‰å…¥ä¸­...</h1>
  <div class="subtitle" id="storeSubtitle"></div>
</div>

<div class="container">
  <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
  <div class="steps">
    <div class="step-dot active" id="dot0"></div>
    <div class="step-dot" id="dot1"></div>
    <div class="step-dot" id="dot2"></div>
    <div class="step-dot" id="dot3"></div>
  </div>

  <!-- Step 0: é¸æ“‡æœå‹™ -->
  <div class="step-panel active" id="step0">
    <div class="panel-title">é¸æ“‡æœå‹™</div>
    <div id="serviceList"></div>
  </div>

  <!-- Step 1: é¸æ“‡äººå“¡ -->
  <div class="step-panel" id="step1">
    <div class="panel-title">é¸æ“‡æœå‹™äººå“¡</div>
    <div class="staff-card selected" onclick="selectStaff(null)" id="staffAny">
      <div class="staff-avatar">ğŸ²</div>
      <div>
        <div style="font-weight:700;">ä¸æŒ‡å®š</div>
        <div style="font-size:12px;color:#94A3B8;">ç”±åº—å®¶å®‰æ’</div>
      </div>
    </div>
    <div id="staffList"></div>
    <button class="btn-primary" onclick="goStep(2)">ä¸‹ä¸€æ­¥</button>
    <button class="btn-outline" onclick="goStep(0)">ä¸Šä¸€æ­¥</button>
  </div>

  <!-- Step 2: é¸æ“‡æ—¥æœŸæ™‚é–“ -->
  <div class="step-panel" id="step2">
    <div class="panel-title">é¸æ“‡æ—¥æœŸ</div>
    <div class="date-list" id="dateList"></div>
    <div class="panel-title" style="font-size:16px;margin-bottom:10px;">é¸æ“‡æ™‚æ®µ</div>
    <div class="time-grid" id="timeGrid"><p style="grid-column:1/-1;text-align:center;color:#94A3B8;">è«‹å…ˆé¸æ“‡æ—¥æœŸ</p></div>
    <button class="btn-primary" onclick="goStep(3)" id="btnToStep3" disabled>ä¸‹ä¸€æ­¥</button>
    <button class="btn-outline" onclick="goStep(1)">ä¸Šä¸€æ­¥</button>
  </div>

  <!-- Step 3: å¡«å¯«è³‡æ–™ -->
  <div class="step-panel" id="step3">
    <div class="panel-title">å¡«å¯«è³‡æ–™</div>
    <div class="summary-card" id="bookingSummary"></div>
    <div class="form-group">
      <label>å§“å *</label>
      <input type="text" id="custName" class="form-input" placeholder="è«‹è¼¸å…¥å§“å">
    </div>
    <div class="form-group">
      <label>é›»è©± *</label>
      <input type="tel" id="custPhone" class="form-input" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼">
    </div>
    <div class="form-group">
      <label>äººæ•¸</label>
      <input type="number" id="custParty" class="form-input" value="1" min="1" max="20">
    </div>
    <div class="form-group">
      <label>å‚™è¨»</label>
      <textarea id="custNotes" class="form-input" rows="2" placeholder="ç‰¹æ®Šéœ€æ±‚ï¼ˆé¸å¡«ï¼‰"></textarea>
    </div>
    <button class="btn-primary" onclick="submitBooking()">ç¢ºèªé ç´„</button>
    <button class="btn-outline" onclick="goStep(2)">ä¸Šä¸€æ­¥</button>
  </div>

  <!-- æˆåŠŸé  -->
  <div class="step-panel" id="stepSuccess">
    <div class="success-page">
      <div class="success-icon">ğŸ‰</div>
      <h2 style="margin-bottom:8px;font-size:22px;">é ç´„æˆåŠŸï¼</h2>
      <div id="successDetail" style="color:#64748B;font-size:14px;margin-bottom:20px;line-height:1.8;"></div>
      <div class="booking-number" id="successNumber"></div>
      <button class="btn-outline" onclick="resetBooking()">é‡æ–°é ç´„</button>
    </div>
  </div>
</div>

<script>
var SUPABASE_URL = 'https://nssuisyvlrqnqfxupklb.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3Vpc3l2bHJxbnFmeHVwa2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTAwMzUsImV4cCI6MjA4NDg2NjAzNX0.q_B6v3gf1TOCuAq7z0xIw10wDueCSJn0p37VzdMfmbc';

var currentStoreId = null;
var selectedService = null;
var selectedStaff = null;
var selectedDate = null;
var selectedTime = null;
var services = [];
var staffList = [];
var currentStep = 0;

function esc(str) {
  if (str == null) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function sbFetch(path, opts) {
  var url = SUPABASE_URL + '/rest/v1/' + path;
  var headers = { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Content-Type': 'application/json' };
  if (opts && opts.prefer) headers['Prefer'] = opts.prefer;
  var res = await fetch(url, {
    method: (opts && opts.method) || 'GET',
    headers: headers,
    body: (opts && opts.body) ? JSON.stringify(opts.body) : undefined
  });
  if (opts && opts.prefer && opts.prefer.includes('return=representation')) {
    return res.json();
  }
  if (res.status === 204) return null;
  return res.json();
}

// ===== åˆå§‹åŒ– =====
async function init() {
  var params = new URLSearchParams(window.location.search);
  var slug = params.get('store');
  if (!slug) {
    document.querySelector('.container').innerHTML = '<p style="text-align:center;padding:40px;color:#EF4444;">ç¼ºå°‘å•†åº—åƒæ•¸</p>';
    return;
  }

  var stores = await sbFetch('store_profiles?store_slug=eq.' + encodeURIComponent(slug) + '&limit=1');
  if (!Array.isArray(stores) || stores.length === 0) {
    document.querySelector('.container').innerHTML = '<p style="text-align:center;padding:40px;color:#EF4444;">æ‰¾ä¸åˆ°å•†åº—</p>';
    return;
  }
  var store = stores[0];
  currentStoreId = store.id;
  document.getElementById('storeName').textContent = store.store_name || 'ç·šä¸Šé ç´„';
  document.getElementById('storeSubtitle').textContent = store.description || '';

  services = await sbFetch('booking_services?store_id=eq.' + currentStoreId + '&is_active=eq.true&order=sort_order');
  if (!Array.isArray(services)) services = [];

  staffList = await sbFetch('booking_staff?store_id=eq.' + currentStoreId + '&is_active=eq.true&order=sort_order');
  if (!Array.isArray(staffList)) staffList = [];

  renderServices();
  renderStaff();
  generateDates();
}

// ===== æ­¥é©Ÿåˆ‡æ› =====
function goStep(n) {
  if (n === 1 && !selectedService) { alert('è«‹å…ˆé¸æ“‡æœå‹™'); return; }
  if (n === 2 && !selectedService) { alert('è«‹å…ˆé¸æ“‡æœå‹™'); return; }
  if (n === 3 && (!selectedDate || !selectedTime)) { alert('è«‹å…ˆé¸æ“‡æ—¥æœŸå’Œæ™‚æ®µ'); return; }

  document.querySelectorAll('.step-panel').forEach(function(p) { p.classList.remove('active'); });
  document.getElementById('step' + n).classList.add('active');

  for (var i = 0; i < 4; i++) {
    var dot = document.getElementById('dot' + i);
    dot.className = 'step-dot' + (i === n ? ' active' : (i < n ? ' done' : ''));
  }
  currentStep = n;

  if (n === 2) { generateTimeSlots(); }
  if (n === 3) { renderSummary(); }
  window.scrollTo(0, 0);
}

// ===== æœå‹™åˆ—è¡¨ =====
function renderServices() {
  var el = document.getElementById('serviceList');
  if (services.length === 0) {
    el.innerHTML = '<p style="text-align:center;color:#94A3B8;padding:30px;">æ­¤å•†åº—å°šæœªè¨­å®šæœå‹™é …ç›®</p>';
    return;
  }
  el.innerHTML = services.map(function(s) {
    return '<div class="service-card" id="svc_' + s.id + '" onclick="selectService(\'' + s.id + '\')">' +
      '<div style="display:flex;justify-content:space-between;align-items:flex-start;">' +
      '<div style="flex:1;">' +
      '<div style="font-weight:700;font-size:15px;">' + esc(s.name) + '</div>' +
      (s.description ? '<div style="font-size:12px;color:#94A3B8;margin-top:3px;">' + esc(s.description) + '</div>' : '') +
      '<div style="font-size:12px;color:#64748B;margin-top:6px;">â± ' + s.duration_minutes + ' åˆ†é˜' + (s.price ? ' Â· $' + s.price : ' Â· å…è²»') + '</div>' +
      '</div>' +
      '<div style="font-size:18px;font-weight:800;color:#6366F1;margin-left:12px;">' + (s.price ? '$' + s.price : '') + '</div>' +
      '</div></div>';
  }).join('');
}

function selectService(id) {
  selectedService = null;
  for (var i = 0; i < services.length; i++) {
    if (services[i].id === id) { selectedService = services[i]; break; }
  }
  document.querySelectorAll('.service-card').forEach(function(c) { c.classList.remove('selected'); });
  document.getElementById('svc_' + id).classList.add('selected');
  setTimeout(function() { goStep(1); }, 200);
}

// ===== äººå“¡åˆ—è¡¨ =====
function renderStaff() {
  var el = document.getElementById('staffList');
  if (staffList.length === 0) {
    el.innerHTML = '';
    return;
  }
  el.innerHTML = staffList.map(function(s) {
    return '<div class="staff-card" id="staff_' + s.id + '" onclick="selectStaff(\'' + s.id + '\')">' +
      '<div class="staff-avatar">' + esc((s.display_name || '?').substring(0, 1)) + '</div>' +
      '<div>' +
      '<div style="font-weight:700;">' + esc(s.display_name) + '</div>' +
      (s.title ? '<div style="font-size:12px;color:#94A3B8;">' + esc(s.title) + '</div>' : '') +
      '</div></div>';
  }).join('');
}

function selectStaff(id) {
  selectedStaff = null;
  if (id) {
    for (var i = 0; i < staffList.length; i++) {
      if (staffList[i].id === id) { selectedStaff = staffList[i]; break; }
    }
  }
  document.querySelectorAll('.staff-card').forEach(function(c) { c.classList.remove('selected'); });
  if (id) {
    document.getElementById('staff_' + id).classList.add('selected');
  } else {
    document.getElementById('staffAny').classList.add('selected');
  }
}

// ===== æ—¥æœŸé¸æ“‡ =====
function generateDates() {
  var el = document.getElementById('dateList');
  var days = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
  var html = '';
  for (var i = 0; i < 14; i++) {
    var d = new Date();
    d.setDate(d.getDate() + i);
    var dateStr = d.toISOString().split('T')[0];
    var topLabel = (d.getMonth() + 1) + '/' + d.getDate();
    var botLabel = 'é€±' + days[d.getDay()];
    if (i === 0) { topLabel = 'ä»Šå¤©'; botLabel = (d.getMonth() + 1) + '/' + d.getDate(); }
    else if (i === 1) { topLabel = 'æ˜å¤©'; botLabel = (d.getMonth() + 1) + '/' + d.getDate(); }
    html += '<div class="date-item" id="date_' + dateStr + '" onclick="selectDate(\'' + dateStr + '\')">' +
      '<div style="font-size:13px;font-weight:700;">' + topLabel + '</div>' +
      '<div style="font-size:11px;color:inherit;opacity:.7;">' + botLabel + '</div>' +
      '</div>';
  }
  el.innerHTML = html;
}

function selectDate(dateStr) {
  selectedDate = dateStr;
  selectedTime = null;
  document.getElementById('btnToStep3').disabled = true;
  document.querySelectorAll('.date-item').forEach(function(d) { d.classList.remove('selected'); });
  var el = document.getElementById('date_' + dateStr);
  if (el) el.classList.add('selected');
  generateTimeSlots();
}

// ===== æ™‚æ®µé¸æ“‡ =====
async function generateTimeSlots() {
  var grid = document.getElementById('timeGrid');
  if (!selectedDate) {
    grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#94A3B8;">è«‹å…ˆé¸æ“‡æ—¥æœŸ</p>';
    return;
  }
  grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#94A3B8;padding:12px;">è¼‰å…¥ä¸­...</p>';

  var existing = await sbFetch('bookings?store_id=eq.' + currentStoreId + '&booking_date=eq.' + selectedDate + '&status=neq.cancelled&select=booking_time,duration_minutes');
  if (!Array.isArray(existing)) existing = [];

  var bookedTimes = existing.map(function(b) { return b.booking_time ? b.booking_time.substring(0, 5) : ''; });

  var now = new Date();
  var isToday = selectedDate === now.toISOString().split('T')[0];
  var html = '';

  for (var h = 9; h < 20; h++) {
    for (var m = 0; m < 60; m += 30) {
      var timeStr = (h < 10 ? '0' : '') + h + ':' + (m === 0 ? '00' : '30');
      var isBooked = bookedTimes.indexOf(timeStr) !== -1;
      var isPast = isToday && (h < now.getHours() || (h === now.getHours() && m <= now.getMinutes()));
      var disabled = isBooked || isPast;
      var slotId = 'time_' + h + '_' + (m === 0 ? '00' : '30');
      html += '<div class="time-slot' + (disabled ? ' disabled' : '') + '" id="' + slotId + '"' +
        (disabled ? '' : ' onclick="selectTime(\'' + timeStr + '\',\'' + slotId + '\')"') + '>' +
        timeStr + '</div>';
    }
  }
  grid.innerHTML = html;
}

function selectTime(time, slotId) {
  selectedTime = time;
  document.querySelectorAll('.time-slot').forEach(function(s) { s.classList.remove('selected'); });
  document.getElementById(slotId).classList.add('selected');
  document.getElementById('btnToStep3').disabled = false;
}

// ===== æ‘˜è¦ =====
function renderSummary() {
  var el = document.getElementById('bookingSummary');
  el.innerHTML = '<div style="font-size:14px;font-weight:700;margin-bottom:10px;">ğŸ“‹ é ç´„æ‘˜è¦</div>' +
    '<div class="summary-grid">' +
    '<span class="summary-label">æœå‹™ï¼š</span><span class="summary-value">' + esc(selectedService ? selectedService.name : '-') + '</span>' +
    '<span class="summary-label">äººå“¡ï¼š</span><span class="summary-value">' + esc(selectedStaff ? selectedStaff.display_name : 'ä¸æŒ‡å®š') + '</span>' +
    '<span class="summary-label">æ—¥æœŸï¼š</span><span class="summary-value">' + (selectedDate || '-') + '</span>' +
    '<span class="summary-label">æ™‚æ®µï¼š</span><span class="summary-value">' + (selectedTime || '-') + '</span>' +
    (selectedService && selectedService.price ? '<span class="summary-label">è²»ç”¨ï¼š</span><span class="summary-value" style="color:#059669;">$' + selectedService.price + '</span>' : '') +
    '</div>';
}

// ===== é€å‡ºé ç´„ =====
async function submitBooking() {
  var name = document.getElementById('custName').value.trim();
  var phone = document.getElementById('custPhone').value.trim();
  var party = parseInt(document.getElementById('custParty').value) || 1;
  var notes = document.getElementById('custNotes').value.trim();

  if (!name) { alert('è«‹è¼¸å…¥å§“å'); return; }
  if (!phone || phone.length < 8) { alert('è«‹è¼¸å…¥æœ‰æ•ˆé›»è©±'); return; }

  var now = new Date();
  var bookingNumber = 'B' + (now.getMonth() + 1).toString().padStart(2, '0') +
    now.getDate().toString().padStart(2, '0') + '-' +
    now.getHours().toString().padStart(2, '0') +
    now.getMinutes().toString().padStart(2, '0') +
    now.getSeconds().toString().padStart(2, '0');

  var btn = document.querySelector('#step3 .btn-primary');
  btn.disabled = true;
  btn.textContent = 'é€å‡ºä¸­...';

  try {
    await sbFetch('bookings', {
      method: 'POST',
      prefer: 'return=minimal',
      body: {
        store_id: currentStoreId,
        booking_number: bookingNumber,
        customer_name: name,
        customer_phone: phone,
        booking_date: selectedDate,
        booking_time: selectedTime,
        party_size: party,
        service_id: selectedService ? selectedService.id : null,
        staff_id: selectedStaff ? selectedStaff.id : null,
        duration_minutes: selectedService ? selectedService.duration_minutes : 60,
        notes: notes || null,
        status: 'pending'
      }
    });

    document.querySelectorAll('.step-panel').forEach(function(p) { p.classList.remove('active'); });
    document.getElementById('stepSuccess').classList.add('active');
    document.getElementById('successNumber').textContent = 'é ç´„ç·¨è™Ÿï¼š' + bookingNumber;
    document.getElementById('successDetail').innerHTML =
      esc(selectedService ? selectedService.name : '') + '<br>' +
      selectedDate + ' ' + selectedTime + '<br>' +
      esc(name) + ' Â· ' + esc(phone);
    window.scrollTo(0, 0);
  } catch (e) {
    console.error('Submit booking error:', e);
    alert('é ç´„å¤±æ•—ï¼Œè«‹é‡è©¦');
    btn.disabled = false;
    btn.textContent = 'ç¢ºèªé ç´„';
  }
}

// ===== é‡ç½® =====
function resetBooking() {
  selectedService = null;
  selectedStaff = null;
  selectedDate = null;
  selectedTime = null;
  currentStep = 0;
  document.querySelectorAll('.step-panel').forEach(function(p) { p.classList.remove('active'); });
  document.getElementById('step0').classList.add('active');
  for (var i = 0; i < 4; i++) {
    document.getElementById('dot' + i).className = 'step-dot' + (i === 0 ? ' active' : '');
  }
  document.querySelectorAll('.service-card').forEach(function(c) { c.classList.remove('selected'); });
  document.querySelectorAll('.staff-card').forEach(function(c) { c.classList.remove('selected'); });
  document.getElementById('staffAny').classList.add('selected');
  document.getElementById('custName').value = '';
  document.getElementById('custPhone').value = '';
  document.getElementById('custParty').value = '1';
  document.getElementById('custNotes').value = '';
  document.getElementById('btnToStep3').disabled = true;
  window.scrollTo(0, 0);
}

init();
</script>
</body>
</html>
