<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç·šä¸Šè¨‚ä½</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --brand: #D97706;
  --brand-light: #FDE68A;
  --brand-bg: #FFFBEB;
  --primary: #1E293B;
  --accent: #D97706;
  --success: #059669;
  --danger: #DC2626;
  --text: #1E293B;
  --text2: #475569;
  --text3: #94A3B8;
  --border: #E2E8F0;
  --bg: #FAFAF9;
  --card: #FFFFFF;
  --radius: 16px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Noto Sans TC',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);min-height:100vh;color:var(--text);padding-bottom:env(safe-area-inset-bottom)}

/* Hero */
.hero{position:relative;height:220px;overflow:hidden;background:#1E293B}
.hero-img{width:100%;height:100%;object-fit:cover;opacity:.7}
.hero-overlay{position:absolute;bottom:0;left:0;right:0;padding:20px;background:linear-gradient(transparent,rgba(0,0,0,.7))}
.hero-logo{width:52px;height:52px;border-radius:14px;background:rgba(255,255,255,.95);display:flex;align-items:center;justify-content:center;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);overflow:hidden}
.hero-logo img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.hero-name{font-size:24px;font-weight:900;color:#fff;letter-spacing:-.5px}
.hero-desc{font-size:13px;color:rgba(255,255,255,.8);margin-top:2px}
.hero-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:rgba(255,255,255,.15);backdrop-filter:blur(4px);border-radius:20px;font-size:11px;color:#fff;margin-top:8px}

/* Container */
.container{max-width:480px;margin:0 auto;padding:0 16px 120px}

/* Notice */
.notice{display:flex;gap:10px;padding:14px 16px;background:var(--brand-bg);border-radius:12px;margin:16px 0;font-size:13px;color:#92400E;line-height:1.5}
.notice-icon{font-size:18px;flex-shrink:0;margin-top:1px}

/* Section */
.section{margin-bottom:24px}
.section-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.section-num{width:28px;height:28px;border-radius:14px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800}
.section-num.done{background:var(--success)}
.section-num.done::after{content:'âœ“'}
.section-title{font-size:16px;font-weight:800;letter-spacing:-.3px}

/* Pills */
.pills{display:flex;gap:8px;overflow-x:auto;padding:2px 0;scrollbar-width:none;-webkit-overflow-scrolling:touch}
.pills::-webkit-scrollbar{display:none}
.pill{flex:0 0 auto;padding:12px 22px;border:2px solid var(--border);border-radius:50px;background:var(--card);font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;font-family:inherit;color:var(--text)}
.pill:hover{border-color:var(--brand-light)}
.pill.active{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 4px 12px rgba(30,41,59,.2)}

/* Date cards */
.date-row{display:flex;gap:8px;overflow-x:auto;padding:2px 0;scrollbar-width:none;-webkit-overflow-scrolling:touch}
.date-row::-webkit-scrollbar{display:none}
.date-card{flex:0 0 auto;min-width:62px;padding:10px 14px;text-align:center;border-radius:12px;cursor:pointer;transition:all .2s;background:var(--card);border:2px solid var(--border)}
.date-card:hover{border-color:var(--brand-light)}
.date-card.selected{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 4px 12px rgba(30,41,59,.2)}
.date-card.selected .d-sub{color:rgba(255,255,255,.7)!important}
.d-sub{font-size:11px;color:var(--text3)}
.d-num{font-size:18px;font-weight:800;margin:2px 0}

/* Time grid */
.time-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.time-slot{padding:12px 4px;text-align:center;border-radius:10px;cursor:pointer;transition:all .15s;background:var(--card);border:2px solid var(--border);font-size:14px;font-weight:600}
.time-slot:hover:not(.off){border-color:var(--brand-light)}
.time-slot.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.time-slot.off{background:#F8FAFC;color:#CBD5E1;cursor:not-allowed;border-color:transparent}

/* Tags */
.tags{display:flex;flex-wrap:wrap;gap:6px}
.tag{padding:8px 14px;border:1.5px solid var(--border);border-radius:20px;background:var(--card);font-size:13px;cursor:pointer;transition:all .2s;user-select:none;font-family:inherit}
.tag:hover{border-color:var(--brand-light)}
.tag.on{background:var(--brand-bg);color:var(--accent);border-color:var(--accent);font-weight:600}

/* Form */
.form-row{margin-bottom:14px}
.form-label{font-size:13px;font-weight:600;color:var(--text2);margin-bottom:6px;display:block}
.form-label .req{color:var(--danger);margin-left:2px}
.form-input{width:100%;padding:14px 16px;border:2px solid var(--border);border-radius:12px;font-size:15px;font-family:inherit;transition:border-color .2s;background:var(--card)}
.form-input:focus{outline:none;border-color:var(--accent)}
.title-pills{display:flex;gap:8px;margin-bottom:12px}
.title-pill{padding:10px 20px;border:2px solid var(--border);border-radius:50px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;background:var(--card);font-family:inherit}
.title-pill.active{background:var(--primary);color:#fff;border-color:var(--primary)}

/* Summary */
.summary{background:linear-gradient(135deg,#FFFBEB,#FEF3C7);border-radius:14px;padding:18px;margin-bottom:20px;border:1px solid #FDE68A}
.sum-row{display:flex;justify-content:space-between;padding:5px 0;font-size:14px}
.sum-label{color:var(--text2)}
.sum-val{font-weight:600}
.sum-line{border-top:1px dashed #E5D5A0;margin:6px 0}
.sum-total{font-size:18px;font-weight:900;color:var(--accent)}

/* Sticky */
.sticky{position:fixed;bottom:0;left:0;right:0;padding:12px 16px;padding-bottom:calc(12px + env(safe-area-inset-bottom));background:rgba(255,255,255,.97);backdrop-filter:blur(10px);box-shadow:0 -2px 16px rgba(0,0,0,.06);z-index:50;transition:transform .3s}
.sticky.hide{transform:translateY(100%)}
.sticky-inner{max-width:480px;margin:0 auto}
.sticky-info{font-size:12px;color:var(--text3);text-align:center;margin-bottom:6px}
.sticky-btn{width:100%;padding:16px;background:var(--primary);color:#fff;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s;box-shadow:0 4px 12px rgba(30,41,59,.15)}
.sticky-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(30,41,59,.2)}
.sticky-btn:active{transform:scale(.98)}
.sticky-btn:disabled{background:#CBD5E1;box-shadow:none;cursor:not-allowed}
.sticky-btn .btn-sub{font-size:12px;font-weight:400;opacity:.8;margin-top:2px}

/* Success */
.success-wrap{text-align:center;padding:24px 0}
.success-circle{width:80px;height:80px;margin:0 auto 16px;border-radius:40px;background:linear-gradient(135deg,#059669,#34D399);display:flex;align-items:center;justify-content:center;animation:pop .5s ease}
@keyframes pop{0%{transform:scale(0)}60%{transform:scale(1.15)}100%{transform:scale(1)}}
.success-circle span{font-size:40px;color:#fff}
.bk-num-card{background:linear-gradient(135deg,#FFFBEB,#FEF3C7);border:2px dashed var(--brand-light);border-radius:14px;padding:20px;margin:20px 0}
.bk-num{font-size:28px;font-weight:900;color:var(--accent);letter-spacing:2px}

/* Hidden */
.hidden{display:none!important}

/* Service cards (for non-restaurant: beauty/clinic) */
.svc-card{padding:16px;background:var(--card);border:2px solid var(--border);border-radius:14px;margin-bottom:10px;cursor:pointer;transition:all .2s;position:relative}
.svc-card::after{content:'âœ“';position:absolute;top:12px;right:12px;width:24px;height:24px;border-radius:12px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:14px;opacity:0;transform:scale(.5);transition:all .2s}
.svc-card:hover{border-color:var(--brand-light);transform:translateY(-1px)}
.svc-card.selected{border-color:var(--primary);background:#F8FAFC}
.svc-card.selected::after{opacity:1;transform:scale(1)}
</style>
</head>
<body>

<!-- Hero -->
<div class="hero" id="heroSection">
  <img class="hero-img" id="heroImg" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 220'%3E%3Crect fill='%231E293B' width='400' height='220'/%3E%3C/svg%3E" alt="">
  <div class="hero-overlay">
    <div class="hero-logo" id="heroLogo">ğŸª</div>
    <div class="hero-name" id="storeName">è¼‰å…¥ä¸­...</div>
    <div class="hero-desc" id="storeDesc"></div>
    <div class="hero-badge" id="storeBadge">ğŸ“ <span id="storeAddr">-</span></div>
  </div>
</div>

<div class="container">

<!-- Notice -->
<div class="notice" id="storeNotice" style="display:none">
  <span class="notice-icon">ğŸ’¡</span>
  <span id="noticeText"></span>
</div>

<!-- ========== é¤å»³æ¨¡å¼ï¼šä¸€é å¼é ç´„ ========== -->
<div id="restaurantMode">

<!-- 1. äººæ•¸ -->
<div class="section" id="sec1">
  <div class="section-header">
    <div class="section-num" id="sn1">1</div>
    <div class="section-title">ç”¨é¤äººæ•¸</div>
  </div>
  <div class="pills" id="partyPills"></div>
</div>

<!-- 2. æ—¥æœŸ -->
<div class="section" id="sec2">
  <div class="section-header">
    <div class="section-num" id="sn2">2</div>
    <div class="section-title">é¸æ“‡æ—¥æœŸ</div>
  </div>
  <div class="date-row" id="dateRow"></div>
</div>

<!-- 3. æ™‚æ®µ -->
<div class="section" id="sec3">
  <div class="section-header">
    <div class="section-num" id="sn3">3</div>
    <div class="section-title">é¸æ“‡æ™‚æ®µ</div>
  </div>
  <div id="mealTabs" style="display:flex;gap:8px;margin-bottom:10px;">
    <div class="pill active" onclick="filterMeal('lunch')" id="tabLunch" style="padding:8px 16px;font-size:13px;">ğŸŒ åˆé¤</div>
    <div class="pill" onclick="filterMeal('dinner')" id="tabDinner" style="padding:8px 16px;font-size:13px;">ğŸŒ™ æ™šé¤</div>
  </div>
  <div class="time-grid" id="timeGrid">
    <div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text3)">è«‹å…ˆé¸æ“‡æ—¥æœŸ</div>
  </div>
</div>

<!-- 4. å¡«å¯«è³‡æ–™ï¼ˆé¸å®Œæ™‚é–“å¾Œå±•é–‹ï¼‰ -->
<div class="section hidden" id="sec4">
  <div class="section-header">
    <div class="section-num" id="sn4">4</div>
    <div class="section-title">å¡«å¯«è³‡æ–™</div>
  </div>

  <!-- æ‘˜è¦ -->
  <div class="summary" id="summaryCard"></div>

  <!-- ç¨±è¬‚ -->
  <div class="title-pills">
    <div class="title-pill active" onclick="pickTitle(this,'å…ˆç”Ÿ')">å…ˆç”Ÿ</div>
    <div class="title-pill" onclick="pickTitle(this,'å°å§')">å°å§</div>
    <div class="title-pill" onclick="pickTitle(this,'å…¶ä»–')">å…¶ä»–</div>
  </div>

  <div class="form-row">
    <label class="form-label">å§“å<span class="req">*</span></label>
    <input type="text" class="form-input" id="fName" placeholder="è«‹è¼¸å…¥å§“å">
  </div>
  <div class="form-row">
    <label class="form-label">æ‰‹æ©Ÿ<span class="req">*</span></label>
    <input type="tel" class="form-input" id="fPhone" placeholder="09xxxxxxxx">
  </div>

  <!-- å¿«é€Ÿæ¨™ç±¤ -->
  <div class="form-row">
    <label class="form-label">ç‰¹æ®Šéœ€æ±‚</label>
    <div class="tags" id="quickTags">
      <div class="tag" onclick="toggleTag(this)" data-t="å…’ç«¥æ¤…">ğŸ‘¶ å…’ç«¥æ¤…</div>
      <div class="tag" onclick="toggleTag(this)" data-t="æ…¶ç”Ÿä½ˆç½®">ğŸ‚ æ…¶ç”Ÿ</div>
      <div class="tag" onclick="toggleTag(this)" data-t="é çª—åº§ä½">ğŸªŸ é çª—</div>
      <div class="tag" onclick="toggleTag(this)" data-t="ç´ é£Ÿ">ğŸ¥¬ ç´ é£Ÿ</div>
      <div class="tag" onclick="toggleTag(this)" data-t="è¼ªæ¤…ç©ºé–“">â™¿ ç„¡éšœç¤™</div>
      <div class="tag" onclick="toggleTag(this)" data-t="å®‰éœå€">ğŸ¤« å®‰éœå€</div>
    </div>
  </div>
  <div class="form-row">
    <textarea class="form-input" id="fNotes" rows="2" placeholder="å…¶ä»–å‚™è¨»ï¼ˆé¸å¡«ï¼‰" style="resize:none"></textarea>
  </div>
</div>

</div><!-- restaurantMode -->

<!-- ========== æˆåŠŸé  ========== -->
<div id="successPage" class="hidden">
  <div class="success-wrap">
    <div class="success-circle"><span>âœ“</span></div>
    <div style="font-size:22px;font-weight:900;margin-bottom:4px">è¨‚ä½æˆåŠŸï¼</div>
    <div style="font-size:14px;color:var(--text3)">æˆ‘å€‘æœƒç›¡å¿«èˆ‡æ‚¨ç¢ºèª</div>
    <div class="bk-num-card">
      <div style="font-size:12px;color:var(--text3);margin-bottom:4px">è¨‚ä½ç·¨è™Ÿ</div>
      <div class="bk-num" id="okNum"></div>
    </div>
    <div class="summary" id="okSummary"></div>
    <div class="notice" style="display:flex;margin-bottom:16px;">
      <span class="notice-icon">â°</span>
      <span>è«‹æå‰ 10 åˆ†é˜åˆ°é”ï¼Œé€¾æ™‚ 15 åˆ†é˜å°‡è‡ªå‹•å–æ¶ˆè¨‚ä½</span>
    </div>
    <button class="sticky-btn" onclick="location.reload()" style="background:var(--success)">å®Œæˆ</button>
  </div>
</div>

</div><!-- container -->

<!-- Sticky bottom -->
<div class="sticky hide" id="stickyBar">
  <div class="sticky-inner">
    <div class="sticky-info" id="stickyInfo"></div>
    <button class="sticky-btn" id="stickyBtn" onclick="handleSticky()" disabled>
      è«‹é¸æ“‡é ç´„è³‡è¨Š
    </button>
  </div>
</div>

<script>
var SB_URL='https://nssuisyvlrqnqfxupklb.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zc3Vpc3l2bHJxbnFmeHVwa2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTAwMzUsImV4cCI6MjA4NDg2NjAzNX0.q_B6v3gf1TOCuAq7z0xIw10wDueCSJn0p37VzdMfmbc';

var storeId=null, slug=null;
var party=2, selDate=null, selTime=null, mealFilter='lunch';
var custTitle='å…ˆç”Ÿ', selTags=[];
var services=[], staffList=[];

function esc(s){return s==null?'':String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
async function api(path){var r=await fetch(SB_URL+'/rest/v1/'+path,{headers:{'apikey':SB_KEY}});return r.json()}
async function post(table,data){var r=await fetch(SB_URL+'/rest/v1/'+table,{method:'POST',headers:{'apikey':SB_KEY,'Content-Type':'application/json','Prefer':'return=representation'},body:JSON.stringify(data)});return r.json()}

// ===== Init =====
async function init(){
  slug = new URLSearchParams(location.search).get('store');
  if(!slug){showErr('è«‹é€éåº—å®¶æä¾›çš„é€£çµæˆ– QR Code é€²å…¥');return}

  var stores = await api('store_profiles?store_slug=eq.'+slug+'&limit=1');
  if(!stores?.length){showErr('æ‰¾ä¸åˆ°æ­¤å•†åº—');return}
  var s=stores[0];
  storeId=s.id;

  document.getElementById('storeName').textContent=s.store_name||'ç·šä¸Šè¨‚ä½';
  document.getElementById('storeDesc').textContent=s.description||'';
  if(s.address){document.getElementById('storeAddr').textContent=s.address}
  if(s.logo_url){
    document.getElementById('heroLogo').innerHTML='<img src="'+esc(s.logo_url)+'" alt="">';
  }
  // å¦‚æœæœ‰å°é¢åœ– hero image
  if(s.cover_url||s.logo_url){
    document.getElementById('heroImg').src=s.cover_url||s.logo_url;
  }
  document.title=(s.store_name||'è¨‚ä½')+' - ç·šä¸Šè¨‚ä½';

  // è¼‰å…¥æœå‹™
  services = await api('booking_services?store_id=eq.'+storeId+'&is_active=eq.true&order=sort_order');
  if(!Array.isArray(services)) services=[];

  renderParty();
  renderDates();
  updateSticky();
}

function showErr(msg){
  document.getElementById('restaurantMode').innerHTML='<div style="text-align:center;padding:60px 20px"><div style="font-size:48px;margin-bottom:12px">ğŸ˜•</div><div style="font-size:16px;color:var(--text2)">'+esc(msg)+'</div></div>';
  document.getElementById('stickyBar').classList.add('hide');
}

// ===== Party pills =====
function renderParty(){
  var el=document.getElementById('partyPills');
  var opts=[1,2,3,4,5,6,7,8];
  el.innerHTML=opts.map(function(n){
    var lbl=n===8?'8äºº+':n+'äºº';
    return '<div class="pill'+(party===n?' active':'')+'" onclick="pickParty('+n+')">'+lbl+'</div>';
  }).join('');
}

function pickParty(n){
  if(n===8){var c=prompt('è«‹è¼¸å…¥äººæ•¸ï¼š','8');if(!c)return;party=parseInt(c)||8}
  else party=n;
  renderParty();
  document.getElementById('sn1').classList.add('done');
  document.getElementById('sn1').textContent='';
  // æ»‘åˆ°æ—¥æœŸ
  document.getElementById('sec2').scrollIntoView({behavior:'smooth',block:'start'});
  updateSticky();
}

// ===== Dates =====
function renderDates(){
  var el=document.getElementById('dateRow');
  var dn=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
  var html='';
  for(var i=0;i<14;i++){
    var d=new Date();d.setDate(d.getDate()+i);
    var ds=d.toISOString().split('T')[0];
    var isToday=i===0;
    html+='<div class="date-card'+(selDate===ds?' selected':'')+'" id="d_'+ds+'" onclick="pickDate(\''+ds+'\')">';
    html+='<div class="d-sub">é€±'+dn[d.getDay()]+'</div>';
    html+='<div class="d-num">'+(isToday?'ä»Šå¤©':d.getDate())+'</div>';
    html+='<div class="d-sub">'+(d.getMonth()+1)+'æœˆ</div>';
    html+='</div>';
  }
  el.innerHTML=html;
}

function pickDate(ds){
  selDate=ds; selTime=null;
  document.querySelectorAll('.date-card').forEach(function(c){c.classList.remove('selected')});
  var el=document.getElementById('d_'+ds);if(el)el.classList.add('selected');
  document.getElementById('sn2').classList.add('done');
  document.getElementById('sn2').textContent='';
  loadTimes();
  updateSticky();
}

// ===== Meal tabs =====
function filterMeal(m){
  mealFilter=m;
  document.getElementById('tabLunch').className='pill'+(m==='lunch'?' active':'');
  document.getElementById('tabDinner').className='pill'+(m==='dinner'?' active':'');
  loadTimes();
}

// ===== Time slots =====
async function loadTimes(){
  var grid=document.getElementById('timeGrid');
  if(!selDate){grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text3)">è«‹å…ˆé¸æ“‡æ—¥æœŸ</div>';return}
  grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text3)">è¼‰å…¥ä¸­...</div>';

  var existing=await api('bookings?store_id=eq.'+storeId+'&booking_date=eq.'+selDate+'&status=neq.cancelled&select=booking_time');
  if(!Array.isArray(existing))existing=[];
  var booked=existing.map(function(b){return b.booking_time?.substring(0,5)});

  var now=new Date();
  var isToday=selDate===now.toISOString().split('T')[0];
  var html='';

  // åˆé¤ 11:00-14:00ï¼Œæ™šé¤ 17:00-21:00
  var ranges=mealFilter==='lunch'?[[11,0],[14,0]]:[[17,0],[21,0]];
  var startH=ranges[0][0], endH=ranges[1][0];
  var hasSlots=false;

  for(var h=startH;h<=endH;h++){
    for(var m=0;m<60;m+=30){
      if(h===endH&&m>0)break;
      var ts=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');
      var isPast=isToday&&(h<now.getHours()||(h===now.getHours()&&m<=now.getMinutes()));
      var isFull=booked.includes(ts);
      var off=isPast||isFull;
      hasSlots=true;

      html+='<div class="time-slot'+(off?' off':'')+(selTime===ts?' active':'')+'" '+
        (off?'':'onclick="pickTime(\''+ts+'\')"')+
        ' id="t_'+ts.replace(':','')+'">'+ts+'</div>';
    }
  }
  grid.innerHTML=html||'<div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text3)">æ­¤æ™‚æ®µç„¡å¯ç”¨æ™‚é–“</div>';
}

function pickTime(t){
  selTime=t;
  document.querySelectorAll('.time-slot').forEach(function(s){s.classList.remove('active')});
  var el=document.getElementById('t_'+t.replace(':',''));if(el)el.classList.add('active');
  document.getElementById('sn3').classList.add('done');
  document.getElementById('sn3').textContent='';

  // å±•é–‹å¡«å¯«å€
  document.getElementById('sec4').classList.remove('hidden');
  renderSummary();
  setTimeout(function(){document.getElementById('sec4').scrollIntoView({behavior:'smooth',block:'start'})},100);
  updateSticky();
}

// ===== Title & Tags =====
function pickTitle(el,t){
  custTitle=t;
  document.querySelectorAll('.title-pill').forEach(function(p){p.classList.remove('active')});
  el.classList.add('active');
}

function toggleTag(el){
  el.classList.toggle('on');
  var t=el.getAttribute('data-t');
  var i=selTags.indexOf(t);
  if(i>=0)selTags.splice(i,1);else selTags.push(t);
}

// ===== Summary =====
function renderSummary(){
  var h='';
  h+='<div class="sum-row"><span class="sum-label">äººæ•¸</span><span class="sum-val">'+party+' ä½</span></div>';
  h+='<div class="sum-row"><span class="sum-label">æ—¥æœŸ</span><span class="sum-val">'+formatDate(selDate)+'</span></div>';
  h+='<div class="sum-row"><span class="sum-label">æ™‚æ®µ</span><span class="sum-val">'+(selTime||'-')+'</span></div>';
  document.getElementById('summaryCard').innerHTML=h;
}

function formatDate(ds){
  if(!ds)return'-';
  var d=new Date(ds+'T00:00:00');
  var dn=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
  return (d.getMonth()+1)+'/'+d.getDate()+' (é€±'+dn[d.getDay()]+')';
}

// ===== Sticky =====
function updateSticky(){
  var bar=document.getElementById('stickyBar');
  var btn=document.getElementById('stickyBtn');
  var info=document.getElementById('stickyInfo');

  if(!selDate||!selTime){
    if(party&&selDate&&!selTime){
      bar.classList.remove('hide');
      btn.disabled=true;
      btn.innerHTML='è«‹é¸æ“‡ç”¨é¤æ™‚æ®µ';
      info.textContent=party+'äºº Â· '+formatDate(selDate);
    } else if(party&&!selDate){
      bar.classList.remove('hide');
      btn.disabled=true;
      btn.innerHTML='è«‹é¸æ“‡ç”¨é¤æ—¥æœŸ';
      info.textContent=party+'äººç”¨é¤';
    } else {
      bar.classList.add('hide');
    }
    return;
  }

  bar.classList.remove('hide');
  btn.disabled=false;
  info.textContent=party+'äºº Â· '+formatDate(selDate)+' Â· '+selTime;
  btn.innerHTML='ç¢ºèªè¨‚ä½<div class="btn-sub">'+party+'äºº Â· '+formatDate(selDate)+' '+selTime+'</div>';
}

function handleSticky(){
  submitBooking();
}

// ===== Submit =====
async function submitBooking(){
  var name=document.getElementById('fName').value.trim();
  var phone=document.getElementById('fPhone').value.trim();
  var notes=document.getElementById('fNotes').value.trim();

  if(!name){alert('è«‹è¼¸å…¥å§“å');document.getElementById('fName').focus();return}
  if(!phone||phone.length<9){alert('è«‹è¼¸å…¥æœ‰æ•ˆæ‰‹æ©Ÿè™Ÿç¢¼');document.getElementById('fPhone').focus();return}

  var btn=document.getElementById('stickyBtn');
  btn.disabled=true;btn.textContent='è¨‚ä½ä¸­...';

  var now=new Date();
  var bn='R'+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0')+String(now.getSeconds()).padStart(2,'0');

  var allNotes=[];
  if(selTags.length)allNotes.push(selTags.join('ã€'));
  if(notes)allNotes.push(notes);
  var finalNotes=allNotes.join(' / ')||null;

  try{
    await post('bookings',{
      store_id:storeId,
      booking_number:bn,
      customer_name:custTitle+' '+name,
      customer_phone:phone,
      booking_date:selDate,
      booking_time:selTime,
      party_size:party,
      notes:finalNotes,
      status:'pending',
      booking_type:'restaurant'
    });

    // æˆåŠŸ
    document.getElementById('restaurantMode').classList.add('hidden');
    document.getElementById('successPage').classList.remove('hidden');
    document.getElementById('stickyBar').classList.add('hide');
    document.getElementById('okNum').textContent=bn;

    var sh='';
    sh+='<div class="sum-row"><span class="sum-label">äººæ•¸</span><span class="sum-val">'+party+' ä½</span></div>';
    sh+='<div class="sum-row"><span class="sum-label">æ—¥æœŸ</span><span class="sum-val">'+formatDate(selDate)+'</span></div>';
    sh+='<div class="sum-row"><span class="sum-label">æ™‚æ®µ</span><span class="sum-val">'+selTime+'</span></div>';
    sh+='<div class="sum-row"><span class="sum-label">å§“å</span><span class="sum-val">'+esc(custTitle+' '+name)+'</span></div>';
    sh+='<div class="sum-row"><span class="sum-label">é›»è©±</span><span class="sum-val">'+esc(phone)+'</span></div>';
    if(finalNotes)sh+='<div class="sum-row"><span class="sum-label">å‚™è¨»</span><span class="sum-val">'+esc(finalNotes)+'</span></div>';
    document.getElementById('okSummary').innerHTML=sh;

    window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){
    console.error(e);alert('è¨‚ä½å¤±æ•—ï¼Œè«‹é‡è©¦');
    btn.disabled=false;updateSticky();
  }
}

init();
</script>
</body>
</html>