<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“Š æŸ¥è©¢è¨˜éŒ„ - å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .att-nav { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 16px; }
        .att-nav button { background: none; border: none; font-size: 20px; cursor: pointer; padding: 6px 10px; border-radius: 8px; }
        .att-nav button:active { background: var(--gray-light); }
        .att-nav span { font-size: 16px; font-weight: 700; color: var(--dark); min-width: 120px; text-align: center; }

        .att-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px; }
        .att-stat { text-align: center; padding: 10px 6px; border-radius: 12px; }
        .att-stat .as-num { font-size: 22px; font-weight: 900; }
        .att-stat .as-label { font-size: 11px; font-weight: 600; margin-top: 2px; }

        .att-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .att-weekday { text-align: center; font-size: 11px; font-weight: 700; color: var(--gray); padding: 6px 0; }
        .att-day {
            min-height: 54px; border-radius: 10px; padding: 4px 2px; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.15s;
        }
        .att-day:active { transform: scale(0.92); }
        .att-day.empty { cursor: default; }
        .att-day .day-num { margin-bottom: 2px; }
        .att-day .day-badge { font-size: 9px; font-weight: 700; padding: 1px 4px; border-radius: 4px; white-space: nowrap; }
        .att-day .day-sub { font-size: 8px; color: var(--gray); margin-top: 1px; }

        .att-day.s-ok { background: #ECFDF5; color: #059669; }
        .att-day.s-late { background: #FFF7ED; color: #EA580C; }
        .att-day.s-leave { background: #EFF6FF; color: #2563EB; }
        .att-day.s-absent { background: #FEF2F2; color: #DC2626; }
        .att-day.s-off { background: var(--gray-light); color: #94A3B8; opacity: 0.6; }
        .att-day.s-future { background: transparent; color: #CBD5E1; }
        .att-day.today-ring { box-shadow: 0 0 0 2px var(--primary); }

        .att-legend { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 14px; }
        .att-legend-item { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--gray); }
        .att-legend-dot { width: 10px; height: 10px; border-radius: 3px; }

        .att-detail { background: var(--white); border-radius: 14px; padding: 16px; margin-top: 16px; box-shadow: var(--shadow-md); display: none; }
        .att-detail.show { display: block; animation: pageIn 0.25s ease-out; }
        .att-detail-hdr { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .att-detail-hdr h3 { font-size: 15px; font-weight: 800; color: var(--dark); margin: 0; }
        .adr { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-light); font-size: 13px; }
        .adr:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div id="loadingPage" class="loading-screen"><div class="spinner"></div><p>ç³»çµ±è¼‰å…¥ä¸­...</p></div>

    <div class="container">
        <!-- é é¢å°èˆª -->
        <div style="display:flex;gap:4px;padding:10px 16px 0;background:transparent;">
            <button class="recTab" onclick="showPage('leavePage')" style="flex:1;padding:10px 6px;border:none;border-radius:10px 10px 0 0;font-weight:700;font-size:12px;background:#fff;color:#4F46E5;cursor:pointer;">ğŸ“ è«‹å‡</button>
            <button class="recTab" onclick="showPage('makeupPunchPage')" style="flex:1;padding:10px 6px;border:none;border-radius:10px 10px 0 0;font-weight:700;font-size:12px;background:#E5E7EB;color:#94A3B8;cursor:pointer;">ğŸ”§ è£œå¡</button>
            <button class="recTab" onclick="showPage('overtimePage')" style="flex:1;padding:10px 6px;border:none;border-radius:10px 10px 0 0;font-weight:700;font-size:12px;background:#E5E7EB;color:#94A3B8;cursor:pointer;">â° åŠ ç­</button>
            <button class="recTab" onclick="showPage('attendancePage')" style="flex:1;padding:10px 6px;border:none;border-radius:10px 10px 0 0;font-weight:700;font-size:12px;background:#E5E7EB;color:#94A3B8;cursor:pointer;">ğŸ“Š è€ƒå‹¤</button>
        </div>

        <!-- è«‹å‡é é¢ -->
        <div id="leavePage" class="page active">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“ è«‹å‡ç”³è«‹</h2>
                <div class="form-group"><label>å‡åˆ¥</label>
                    <select id="leaveType">
                        <option value="annual">ç‰¹ä¼‘å‡</option><option value="sick">ç—…å‡</option>
                        <option value="personal">äº‹å‡</option><option value="compensatory">è£œä¼‘</option>
                    </select>
                </div>
                <div class="form-group"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="leaveStartDate" onchange="onLeaveDateChange()"></div>
                <div class="form-group"><label>çµæŸæ—¥æœŸ</label><input type="date" id="leaveEndDate" onchange="onLeaveDateChange()"></div>

                <!-- å³æ™‚è¡çªè­¦å‘Š -->
                <div id="leaveConflictWarn" style="display:none;padding:12px 14px;border-radius:12px;margin-bottom:12px;font-size:13px;line-height:1.6;"></div>

                <div class="form-group"><label>åŸå› </label><textarea id="leaveReason"></textarea></div>
                <button class="btn btn-primary" id="leaveSubmitBtn" onclick="submitLeave()">ğŸ“¤ æäº¤ç”³è«‹</button>
                <div id="leaveStatus" class="status-box"></div>
                <div style="margin-top:30px; padding-top:20px; border-top:2px dashed #e5e7eb;">
                    <h3 style="margin-bottom:15px;">ğŸ“‹ æˆ‘çš„è«‹å‡è¨˜éŒ„</h3>
                    <div id="leaveHistoryList"><p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p></div>
                </div>
            </div>
        </div>

        <!-- ====== è£œæ‰“å¡ç”³è«‹ ====== -->
        <div id="makeupPunchPage" class="page">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ”§ è£œæ‰“å¡ç”³è«‹</h2>
                <p style="color:#94A3B8;font-size:12px;margin-bottom:16px;">å¿˜è¨˜æ‰“å¡ï¼Ÿç³»çµ±ç•°å¸¸ï¼Ÿåœ¨é€™è£¡ç”³è«‹è£œæ‰“å¡ï¼Œå¯©æ ¸é€šéå¾Œè‡ªå‹•å¯«å…¥å‡ºå‹¤è¨˜éŒ„ã€‚</p>

                <div class="form-group">
                    <label>è£œæ‰“å¡æ—¥æœŸ</label>
                    <input type="date" id="mpDate">
                </div>

                <div class="form-group">
                    <label>æ‰“å¡é¡å‹</label>
                    <div style="display:flex;gap:8px;">
                        <label style="flex:1;display:flex;align-items:center;gap:8px;padding:12px;border:2px solid #E5E7EB;border-radius:10px;cursor:pointer;transition:all 0.2s;" onclick="selectMpType('clock_in',this)">
                            <input type="radio" name="mpType" value="clock_in" id="mpTypeIn" checked style="display:none;">
                            <span style="font-size:20px;">â˜€ï¸</span>
                            <span style="font-weight:700;font-size:13px;">ä¸Šç­æ‰“å¡</span>
                        </label>
                        <label style="flex:1;display:flex;align-items:center;gap:8px;padding:12px;border:2px solid #E5E7EB;border-radius:10px;cursor:pointer;transition:all 0.2s;" onclick="selectMpType('clock_out',this)">
                            <input type="radio" name="mpType" value="clock_out" id="mpTypeOut" style="display:none;">
                            <span style="font-size:20px;">ğŸŒ™</span>
                            <span style="font-weight:700;font-size:13px;">ä¸‹ç­æ‰“å¡</span>
                        </label>
                    </div>
                    <input type="hidden" id="mpType" value="clock_in">
                </div>

                <div class="form-group">
                    <label>å¯¦éš›æ‰“å¡æ™‚é–“</label>
                    <input type="time" id="mpTime">
                </div>

                <div class="form-group">
                    <label>åŸå› </label>
                    <select id="mpReasonType">
                        <option value="forgot">å¿˜è¨˜æ‰“å¡</option>
                        <option value="field">å¤–å‡ºå…¬å‹™</option>
                        <option value="phone_dead">æ‰‹æ©Ÿæ²’é›»</option>
                        <option value="system_error">ç³»çµ±æ•…éšœ</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>è£œå……èªªæ˜ (é¸å¡«)</label>
                    <textarea id="mpReasonText" placeholder="ä¾‹ï¼šç•¶å¤©å¿˜è¨˜å¸¶æ‰‹æ©Ÿ"></textarea>
                </div>

                <button class="btn btn-primary" onclick="submitMakeupPunch()">ğŸ“¤ æäº¤è£œæ‰“å¡ç”³è«‹</button>
                <div id="mpStatus" class="status-box"></div>

                <div style="margin-top:30px;padding-top:20px;border-top:2px dashed #e5e7eb;">
                    <h3 style="margin-bottom:15px;">ğŸ“‹ è£œæ‰“å¡è¨˜éŒ„</h3>
                    <div id="makeupHistoryList"><p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p></div>
                </div>
            </div>
        </div>

        <!-- ====== åŠ ç­ç”³è«‹ ====== -->
        <div id="overtimePage" class="page">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>â° åŠ ç­ç”³è«‹</h2>
                <p style="color:#94A3B8;font-size:12px;margin-bottom:16px;">åŠ ç­éœ€äº‹å‰æˆ–äº‹å¾Œç”³è«‹ï¼Œå¯©æ ¸é€šéå¾Œä¾æ ¸å‡†æ™‚æ•¸è¨ˆç®—</p>

                <div class="form-group"><label>åŠ ç­æ—¥æœŸ</label><input type="date" id="otDate"></div>

                <div class="form-group">
                    <label>é è¨ˆåŠ ç­æ™‚æ•¸</label>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input type="number" id="otHours" min="0.5" max="12" step="0.5" value="2" style="flex:1;">
                        <span style="font-size:13px;color:#64748B;">å°æ™‚</span>
                    </div>
                    <div style="font-size:11px;color:#94A3B8;margin-top:4px;">
                        ğŸ’¡ å‰ 2hï¼šæ™‚è–ª Ã—1.34 Â· å¾Œ 2hï¼šæ™‚è–ª Ã—1.67
                    </div>
                </div>

                <div class="form-group">
                    <label>åŠ ç­è£œå„Ÿæ–¹å¼</label>
                    <div style="display:flex;gap:8px;">
                        <label onclick="document.getElementById('otCompType').value='pay'" style="flex:1;display:flex;align-items:center;gap:8px;padding:12px;border:2px solid #4F46E5;border-radius:10px;background:#F5F3FF;cursor:pointer;">
                            <span style="font-size:18px;">ğŸ’°</span>
                            <span style="font-weight:700;font-size:13px;">é ˜åŠ ç­è²»</span>
                        </label>
                        <label onclick="document.getElementById('otCompType').value='comp_leave'" style="flex:1;display:flex;align-items:center;gap:8px;padding:12px;border:2px solid #E5E7EB;border-radius:10px;cursor:pointer;">
                            <span style="font-size:18px;">ğŸ–ï¸</span>
                            <span style="font-weight:700;font-size:13px;">æ›è£œä¼‘</span>
                        </label>
                    </div>
                    <input type="hidden" id="otCompType" value="pay">
                </div>

                <div class="form-group"><label>åŠ ç­åŸå› </label><textarea id="otReason" placeholder="ä¾‹ï¼šè¶•å‡ºè²¨ã€å®¢æˆ¶æœƒè­°"></textarea></div>
                <button class="btn btn-primary" onclick="submitOvertime()">ğŸ“¤ æäº¤åŠ ç­ç”³è«‹</button>
                <div id="otStatus" class="status-box"></div>

                <div style="margin-top:30px;padding-top:20px;border-top:2px dashed #e5e7eb;">
                    <h3 style="margin-bottom:15px;">ğŸ“‹ åŠ ç­è¨˜éŒ„</h3>
                    <div id="overtimeHistoryList"><p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p></div>
                </div>
            </div>
        </div>

        <!-- ====== è€ƒå‹¤æœˆæ›† ====== -->
        <div id="attendancePage" class="page">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>

            <div class="card">
                <h2 style="text-align:center;font-size:18px;font-weight:800;color:var(--dark);margin-bottom:16px;">ğŸ“Š è€ƒå‹¤è¨˜éŒ„</h2>
                <div class="att-nav">
                    <button onclick="changeAttMonth(-1)">â—€</button>
                    <span id="attMonthLabel">-</span>
                    <button onclick="changeAttMonth(1)">â–¶</button>
                </div>
                <div class="att-summary">
                    <div class="att-stat" style="background:#ECFDF5;"><div class="as-num" style="color:#059669;" id="stOk">0</div><div class="as-label" style="color:#059669;">å‡ºå‹¤</div></div>
                    <div class="att-stat" style="background:#FFF7ED;"><div class="as-num" style="color:#EA580C;" id="stLate">0</div><div class="as-label" style="color:#EA580C;">é²åˆ°</div></div>
                    <div class="att-stat" style="background:#EFF6FF;"><div class="as-num" style="color:#2563EB;" id="stLeave">0</div><div class="as-label" style="color:#2563EB;">è«‹å‡</div></div>
                    <div class="att-stat" style="background:#FEF2F2;"><div class="as-num" style="color:#DC2626;" id="stAbsent">0</div><div class="as-label" style="color:#DC2626;">ç¼ºå‹¤</div></div>
                </div>
                <div style="text-align:center;margin-bottom:16px;font-size:13px;color:var(--gray);">
                    â±ï¸ ç¸½å·¥æ™‚ <b id="stHours" style="color:var(--dark);">0</b> å°æ™‚
                </div>
            </div>

            <div class="card" style="padding:12px;">
                <div class="att-grid" id="attGrid">
                    <div class="att-weekday">æ—¥</div><div class="att-weekday">ä¸€</div><div class="att-weekday">äºŒ</div>
                    <div class="att-weekday">ä¸‰</div><div class="att-weekday">å››</div><div class="att-weekday">äº”</div><div class="att-weekday">å…­</div>
                </div>
                <div class="att-legend">
                    <span class="att-legend-item"><span class="att-legend-dot" style="background:#ECFDF5;border:1px solid #059669;"></span>å‡ºå‹¤</span>
                    <span class="att-legend-item"><span class="att-legend-dot" style="background:#FFF7ED;border:1px solid #EA580C;"></span>é²åˆ°</span>
                    <span class="att-legend-item"><span class="att-legend-dot" style="background:#EFF6FF;border:1px solid #2563EB;"></span>è«‹å‡</span>
                    <span class="att-legend-item"><span class="att-legend-dot" style="background:#FEF2F2;border:1px solid #DC2626;"></span>ç¼ºå‹¤</span>
                    <span class="att-legend-item"><span class="att-legend-dot" style="background:var(--gray-light);border:1px solid #94A3B8;"></span>ä¼‘</span>
                </div>
            </div>

            <div class="att-detail" id="attDetail">
                <div class="att-detail-hdr"><h3 id="adTitle">-</h3><span id="adBadge"></span></div>
                <div id="adRows"></div>
            </div>
        </div>

        <!-- è–ªè³‡æŸ¥è©¢é é¢ -->
        <div id="salaryPage" class="page">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ’° è–ªè³‡æŸ¥è©¢</h2>
                <div class="form-group"><label>æŸ¥è©¢å¹´åº¦</label>
                    <select id="salaryYear" onchange="loadAnnualSummary()"><option value="2026">2026</option><option value="2025">2025</option></select>
                </div>
                <div id="yearEndStatusCard" class="status-card" style="display:none; margin-bottom:20px;">
                    <h1 id="statusResult" style="margin:10px 0;">è¨ˆç®—ä¸­...</h1>
                    <p id="statusReason" style="margin:0; opacity:0.8;"></p>
                </div>
                <div class="stats-grid" id="statsGrid" style="display:none;">
                    <div class="stat-item"><label>ğŸ“… åˆ°è·æ—¥æœŸ</label><input type="date" id="bonusHireDate" style="border:1px solid #ddd; padding:5px; border-radius:5px; text-align:right;"></div>
                    <div class="stat-item"><label>â³ å¯¦éš›å¹´è³‡</label><span id="bonusMonths">-</span></div>
                    <div class="stat-item"><label>ğŸƒ ç¸½å‡ºå‹¤å¤©æ•¸</label><span id="bonusDays">-</span></div>
                    <div class="stat-item"><label>ğŸ“ˆ å‡ºå¸­ç‡</label><span id="attendanceRate">-</span></div>
                    <div class="stat-item"><label>â° é²åˆ°æ¬¡æ•¸</label><span id="bonusLate" style="color:red;">-</span></div>
                    <div class="stat-item"><label>ğŸ“‰ é²åˆ°ç‡</label><span id="lateRate">-</span></div>
                    <div class="stat-item"><label>â±ï¸ ç´¯è¨ˆå·¥æ™‚</label><span id="bonusHours">-</span></div>
                    <div class="stat-item"><label>ğŸ“Š å¹³å‡æ¯æ—¥å·¥æ™‚</label><span id="bonusAvgHours">-</span></div>
                </div>
                <div style="margin-top:20px;"><h3>ğŸ“„ è–ªè³‡å–®æŸ¥è©¢</h3><p class="status-box show info">è«‹å‰å¾€ ğŸ’° è–ªè³‡ä¸­å¿ƒ æŸ¥çœ‹æ˜ç´°</p></div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        let attYear = new Date().getFullYear();
        let attMonth = new Date().getMonth();
        let attData = [], lvData = [];

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            // Tab é«˜äº®
            const tabs = document.querySelectorAll('.recTab');
            if (tabs.length) {
                tabs.forEach(t => { t.style.background = '#E5E7EB'; t.style.color = '#94A3B8'; });
                const idx = { leavePage:0, makeupPunchPage:1, overtimePage:2, attendancePage:3 }[id];
                if (idx !== undefined && tabs[idx]) { tabs[idx].style.background = '#fff'; tabs[idx].style.color = '#4F46E5'; }
            }
            if (id === 'attendancePage') { attYear = new Date().getFullYear(); attMonth = new Date().getMonth(); loadAttCal(); }
            if (id === 'leavePage') loadLeaveHistory();
            if (id === 'makeupPunchPage') { loadMakeupHistory(); initMpDate(); }
            if (id === 'overtimePage') { loadOvertimeHistory(); initOtDate(); }
            if (id === 'salaryPage') { document.getElementById('salaryYear').value = new Date().getFullYear(); loadAnnualSummary(); }
        }

        function initOtDate() {
            const el = document.getElementById('otDate');
            if (el && !el.value) el.value = fmtDate(new Date());
        }

        // è£œæ‰“å¡é¡å‹é¸æ“‡
        function selectMpType(type, el) {
            document.getElementById('mpType').value = type;
            el.closest('.form-group').querySelectorAll('label[onclick]').forEach(l => {
                l.style.borderColor = '#E5E7EB'; l.style.background = '#fff';
            });
            el.style.borderColor = '#4F46E5'; el.style.background = '#F5F3FF';
        }
        function initMpDate() {
            const mpDate = document.getElementById('mpDate');
            if (mpDate && !mpDate.value) {
                const y = new Date(); y.setDate(y.getDate() - 1);
                mpDate.value = fmtDate(y);
                mpDate.max = fmtDate(new Date());
            }
        }

        function changeAttMonth(d) {
            attMonth += d;
            if (attMonth < 0) { attMonth = 11; attYear--; }
            if (attMonth > 11) { attMonth = 0; attYear++; }
            loadAttCal();
        }

        async function loadAttCal() {
            document.getElementById('attMonthLabel').textContent = `${attYear}å¹´ ${attMonth + 1}æœˆ`;
            if (!currentEmployee) return;

            const ms = `${attYear}-${String(attMonth+1).padStart(2,'0')}-01`;
            const ld = new Date(attYear, attMonth+1, 0).getDate();
            const me = `${attYear}-${String(attMonth+1).padStart(2,'0')}-${ld}`;

            try {
                const {data} = await sb.rpc('get_monthly_attendance', { p_line_user_id: liffProfile.userId, p_year: attYear, p_month: attMonth+1 });
                attData = data || [];
            } catch(e) { attData = []; }

            try {
                const {data} = await sb.from('leave_requests').select('*').eq('employee_id', currentEmployee.id).eq('status','approved').gte('start_date', ms).lte('start_date', me);
                lvData = data || [];
            } catch(e) { lvData = []; }

            renderAttCal();
        }

        function getStatus(ds) {
            const att = attData.find(r => r.date === ds);
            const lv = lvData.find(r => ds >= r.start_date && ds <= (r.end_date || r.start_date));
            const d = new Date(ds), dow = d.getDay();
            const now = new Date(); now.setHours(0,0,0,0);

            if (d > now) return { s: 'future', l: '' };
            if (dow === 0 || dow === 6) return att ? { s: 'ok', l: 'åŠ ç­', att } : { s: 'off', l: 'ä¼‘' };
            if (lv) {
                const m = { annual:'ç‰¹ä¼‘', sick:'ç—…å‡', personal:'äº‹å‡', compensatory:'è£œä¼‘', maternity:'ç”¢å‡', marriage:'å©šå‡' };
                return { s: 'leave', l: m[lv.leave_type] || 'å‡', lv };
            }
            if (att) {
                if (att.is_late) {
                    let min = '';
                    try { const t = new Date(att.check_in_time); const sc = new Date(t); sc.setHours(8,0,0,0); const df = Math.round((t-sc)/60000); if(df>0) min = df+'åˆ†'; } catch(e){}
                    return { s: 'late', l: 'é²'+(min||'åˆ°'), att };
                }
                return { s: 'ok', l: 'âœ“', att };
            }
            return { s: 'absent', l: 'ç¼ºå‹¤' };
        }

        function renderAttCal() {
            const grid = document.getElementById('attGrid');
            const wk = grid.querySelectorAll('.att-weekday');
            grid.innerHTML = ''; wk.forEach(w => grid.appendChild(w));

            const fd = new Date(attYear, attMonth, 1).getDay();
            const dim = new Date(attYear, attMonth+1, 0).getDate();
            const todayS = fmtDate(new Date());

            let cOk=0, cLate=0, cLv=0, cAb=0, tH=0;

            for (let i=0; i<fd; i++) { const e=document.createElement('div'); e.className='att-day empty'; grid.appendChild(e); }

            for (let d=1; d<=dim; d++) {
                const ds = `${attYear}-${String(attMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const info = getStatus(ds);
                const el = document.createElement('div');
                let cls = 'att-day';
                if (info.s==='ok') { cls+=' s-ok'; cOk++; }
                else if (info.s==='late') { cls+=' s-late'; cLate++; cOk++; }
                else if (info.s==='leave') { cls+=' s-leave'; cLv++; }
                else if (info.s==='absent') { cls+=' s-absent'; cAb++; }
                else if (info.s==='off') cls+=' s-off';
                else if (info.s==='future') cls+=' s-future';
                if (ds===todayS) cls+=' today-ring';
                el.className = cls;

                if (info.att) tH += parseFloat(info.att.total_work_hours) || 0;

                const bc = {ok:'background:#D1FAE5;color:#059669;',late:'background:#FFEDD5;color:#EA580C;',leave:'background:#DBEAFE;color:#2563EB;',absent:'background:#FEE2E2;color:#DC2626;',off:'color:#94A3B8;'}[info.s] || '';
                el.innerHTML = `<span class="day-num">${d}</span>${info.l?`<span class="day-badge" style="${bc}">${info.l}</span>`:''}${info.att&&info.att.total_work_hours?`<span class="day-sub">${parseFloat(info.att.total_work_hours).toFixed(1)}h</span>`:''}`;

                if (info.s!=='future' && info.s!=='off') el.onclick = () => showDetail(ds, info);
                grid.appendChild(el);
            }

            document.getElementById('stOk').textContent = cOk;
            document.getElementById('stLate').textContent = cLate;
            document.getElementById('stLeave').textContent = cLv;
            document.getElementById('stAbsent').textContent = cAb;
            document.getElementById('stHours').textContent = tH.toFixed(1);
        }

        function showDetail(ds, info) {
            const card = document.getElementById('attDetail');
            const wd = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            const dd = new Date(ds);
            document.getElementById('adTitle').textContent = `${ds} é€±${wd[dd.getDay()]}`;

            const sm = {ok:'<span style="color:#059669;font-weight:700;">âœ… æ­£å¸¸å‡ºå‹¤</span>',late:'<span style="color:#EA580C;font-weight:700;">âš ï¸ é²åˆ°</span>',leave:'<span style="color:#2563EB;font-weight:700;">ğŸ“ è«‹å‡</span>',absent:'<span style="color:#DC2626;font-weight:700;">âŒ ç¼ºå‹¤</span>'};
            document.getElementById('adBadge').innerHTML = sm[info.s] || '';

            let r = '';
            if (info.att) {
                let ci='-', co='-';
                try {
                    if(info.att.check_in_time){const p=info.att.check_in_time.split(' ');ci=p.length>1?p[1].substring(0,5):info.att.check_in_time.substring(0,5);}
                    if(info.att.check_out_time){const p=info.att.check_out_time.split(' ');co=p.length>1?p[1].substring(0,5):info.att.check_out_time.substring(0,5);}
                } catch(e){}
                r += `<div class="adr"><span style="color:var(--gray)">ä¸Šç­æ‰“å¡</span><b>${ci}</b></div>`;
                r += `<div class="adr"><span style="color:var(--gray)">ä¸‹ç­æ‰“å¡</span><b>${co}</b></div>`;
                if (info.att.total_work_hours) r += `<div class="adr"><span style="color:var(--gray)">å·¥ä½œæ™‚æ•¸</span><b>${parseFloat(info.att.total_work_hours).toFixed(1)} å°æ™‚</b></div>`;
                if (info.att.is_late) {
                    try { const t=new Date(info.att.check_in_time),sc=new Date(t);sc.setHours(8,0,0,0);const df=Math.round((t-sc)/60000);if(df>0) r+=`<div class="adr"><span style="color:#EA580C">é²åˆ°æ™‚é–“</span><b style="color:#EA580C">${df} åˆ†é˜</b></div>`; } catch(e){}
                }
                if (info.att.check_in_location) r += `<div class="adr"><span style="color:var(--gray)">æ‰“å¡åœ°é»</span><b>${info.att.check_in_location}</b></div>`;
                if (info.att.photo_url) r += `<div class="adr"><span style="color:var(--gray)">æ‰“å¡ç…§ç‰‡</span><a href="${info.att.photo_url}" target="_blank" style="color:var(--primary);font-weight:700;">ğŸ“· æŸ¥çœ‹</a></div>`;
            }
            if (info.lv) {
                const tm = {annual:'ç‰¹ä¼‘å‡',sick:'ç—…å‡',personal:'äº‹å‡',compensatory:'è£œä¼‘',maternity:'ç”¢å‡',marriage:'å©šå‡'};
                r += `<div class="adr"><span style="color:var(--gray)">å‡åˆ¥</span><b style="color:#2563EB">${tm[info.lv.leave_type]||info.lv.leave_type}</b></div>`;
                r += `<div class="adr"><span style="color:var(--gray)">å¤©æ•¸</span><b>${info.lv.days||1} å¤©</b></div>`;
                if (info.lv.reason) r += `<div class="adr"><span style="color:var(--gray)">åŸå› </span><b>${info.lv.reason}</b></div>`;
            }
            if (info.s==='absent') r += `<div class="adr"><span style="color:#DC2626">èªªæ˜</span><b style="color:#DC2626">æœªæ‰“å¡ä¸”ç„¡è«‹å‡ç´€éŒ„</b></div>`;

            document.getElementById('adRows').innerHTML = r;
            card.classList.add('show');
            card.scrollIntoView({ behavior:'smooth', block:'nearest' });
        }

        // ===== æ—¥æœŸé¸å–å³æ™‚è¡çªæª¢æŸ¥ =====
        async function onLeaveDateChange() {
            const start = document.getElementById('leaveStartDate')?.value;
            const end = document.getElementById('leaveEndDate')?.value;
            const warn = document.getElementById('leaveConflictWarn');
            const btn = document.getElementById('leaveSubmitBtn');
            if (!start || !end || !warn) return;
            if (new Date(end) < new Date(start)) {
                warn.style.display = 'block';
                warn.style.background = '#FEF2F2';
                warn.style.color = '#DC2626';
                warn.innerHTML = 'âŒ çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ';
                if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; }
                return;
            }

            warn.style.display = 'block';
            warn.style.background = '#F5F3FF';
            warn.style.color = '#6D28D9';
            warn.innerHTML = 'â³ æª¢æŸ¥äººåŠ›ç‹€æ…‹...';
            if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; }

            const check = await checkLeaveAvailability(start, end);

            if (!check.ok) {
                warn.style.background = '#FEF2F2';
                warn.style.color = '#DC2626';
                let html = `<b>${check.message}</b>`;
                if (check.conflicts.length > 0) {
                    html += '<div style="margin-top:6px;font-size:12px;">';
                    check.conflicts.slice(0, 5).forEach(c => {
                        html += `<div style="padding:2px 0;">ğŸ“… ${c.date}ï¼š${c.names.join('ã€')}ï¼ˆ${c.count}äººï¼‰</div>`;
                    });
                    html += '</div>';
                }
                warn.innerHTML = html;
                if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; }
            } else if (check.conflicts && check.conflicts.length > 0) {
                warn.style.background = '#FFF7ED';
                warn.style.color = '#EA580C';
                let html = `<b>${check.message}</b>`;
                html += '<div style="margin-top:6px;font-size:12px;">';
                check.conflicts.slice(0, 5).forEach(c => {
                    html += `<div style="padding:2px 0;">ğŸ“… ${c.date}ï¼š${c.names.join('ã€')}ï¼ˆ${c.count}äººï¼‰</div>`;
                });
                html += '</div>';
                if (check.staffWarning) html += `<div style="margin-top:4px;font-weight:700;">${check.staffWarning}</div>`;
                warn.innerHTML = html;
                if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
            } else {
                warn.style.background = '#ECFDF5';
                warn.style.color = '#059669';
                warn.innerHTML = '<b>âœ… è©²æœŸé–“ç„¡äººè«‹å‡ï¼Œå¯æ­£å¸¸ç”³è«‹</b>';
                if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
            }
        }

        window.addEventListener('load', async () => {
            if (typeof initializeLiff === 'undefined') return;
            const hash = window.location.hash || '#leave';
            let pid = hash==='#attendance'?'attendancePage':hash==='#salary'?'salaryPage':hash==='#makeup'?'makeupPunchPage':hash==='#overtime'?'overtimePage':'leavePage';
            const ok = await initializeLiff();
            if (ok) { const li = await checkUserStatus(); if(li){initBottomNav();showPage(pid);}else window.location.href='index.html'; }
        });
    </script>

    <nav class="bottom-nav" style="display:none;">
        <a class="nav-item" onclick="window.location.href='index.html'"><span class="nav-icon">ğŸ </span><span class="nav-label">é¦–é </span></a>
        <a class="nav-item" onclick="window.location.href='schedule.html'"><span class="nav-icon">ğŸ“…</span><span class="nav-label">ç­è¡¨</span></a>
        <a class="nav-item" onclick="window.location.href='checkin.html?type=in'"><span class="nav-icon">ğŸ“</span><span class="nav-label">æ‰“å¡</span></a>
        <a class="nav-item active"><span class="nav-icon">ğŸ’°</span><span class="nav-label">è–ªè³‡</span></a>
        <a class="nav-item" onclick="window.location.href='admin.html'"><span class="nav-icon">âš™ï¸</span><span class="nav-label">ç®¡ç†</span></a>
    </nav>
</body>
</html>
