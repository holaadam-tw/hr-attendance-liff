<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“Š æŸ¥è©¢è¨˜éŒ„ - å“¡å·¥æœå‹™ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loadingPage" class="loading-screen">
        <div class="spinner"></div>
        <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div class="container">
        <!-- è«‹å‡é é¢ -->
        <div id="leavePage" class="page active">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“ è«‹å‡ç”³è«‹</h2>
                <div class="form-group">
                    <label>å‡åˆ¥</label>
                    <select id="leaveType">
                        <option value="annual">ç‰¹ä¼‘å‡</option>
                        <option value="sick">ç—…å‡</option>
                        <option value="personal">äº‹å‡</option>
                        <option value="compensatory">è£œä¼‘</option>
                    </select>
                </div>
                <div class="form-group"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="leaveStartDate"></div>
                <div class="form-group"><label>çµæŸæ—¥æœŸ</label><input type="date" id="leaveEndDate"></div>
                <div class="form-group"><label>åŸå› </label><textarea id="leaveReason"></textarea></div>
                <button class="btn btn-primary" onclick="submitLeave()">ğŸ“¤ æäº¤ç”³è«‹</button>
                <div id="leaveStatus" class="status-box"></div>
                
                <div style="margin-top:30px; padding-top:20px; border-top:2px dashed #e5e7eb;">
                    <h3 style="margin-bottom:15px;">ğŸ“‹ æˆ‘çš„è«‹å‡è¨˜éŒ„</h3>
                    <div id="leaveHistoryList">
                        <p style="text-align:center;color:#666;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è€ƒå‹¤æŸ¥è©¢é é¢ -->
        <div id="attendancePage" class="page">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ“Š è€ƒå‹¤è¨˜éŒ„</h2>
                <div class="form-group">
                    <label>æŸ¥è©¢æœˆä»½</label>
                    <div style="display:flex; gap:10px;">
                        <select id="attendanceYear" onchange="loadMonthlyAttendance()" style="flex:1;">
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                        </select>
                        <select id="attendanceMonth" onchange="loadMonthlyAttendance()" style="flex:1;">
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                    </div>
                </div>
                <div id="attendanceList" style="margin-top:15px;"></div>
            </div>
        </div>

        <!-- è–ªè³‡æŸ¥è©¢é é¢ -->
        <div id="salaryPage" class="page">
            <button class="btn btn-secondary" onclick="window.location.href='index.html'" style="width:auto;margin-bottom:10px;">â† è¿”å›</button>
            <div class="checkin-page">
                <h2>ğŸ’° è–ªè³‡æŸ¥è©¢</h2>
                <div class="form-group">
                    <label>æŸ¥è©¢å¹´åº¦</label>
                    <select id="salaryYear" onchange="loadAnnualSummary()">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                
                <!-- å¹´åº¦æˆç¸¾å–®ç‹€æ…‹å¡ç‰‡ -->
                <div id="yearEndStatusCard" class="status-card" style="display:none; margin-bottom:20px;">
                    <h1 id="statusResult" style="margin:10px 0;">è¨ˆç®—ä¸­...</h1>
                    <p id="statusReason" style="margin:0; opacity:0.8;"></p>
                </div>

                <!-- è©³ç´°çµ±è¨ˆè³‡æ–™ -->
                <div class="stats-grid" id="statsGrid" style="display:none;">
                    <div class="stat-item">
                        <label>ğŸ“… åˆ°è·æ—¥æœŸ</label>
                        <span id="bonusHireDate">-</span>
                    </div>
                    <div class="stat-item">
                        <label>â³ å¯¦éš›å¹´è³‡</label>
                        <span id="bonusMonths">-</span>
                    </div>
                    <div class="stat-item">
                        <label>ğŸƒ ç¸½å‡ºå‹¤å¤©æ•¸</label>
                        <span id="bonusDays">-</span>
                    </div>
                    <div class="stat-item">
                        <label>ğŸ“ˆ å‡ºå¸­ç‡</label>
                        <span id="attendanceRate">-</span>
                    </div>
                    <div class="stat-item">
                        <label>â° é²åˆ°æ¬¡æ•¸</label>
                        <span id="bonusLate" style="color:red;">-</span>
                    </div>
                    <div class="stat-item">
                        <label>ğŸ“‰ é²åˆ°ç‡</label>
                        <span id="lateRate">-</span>
                    </div>
                    <div class="stat-item">
                        <label>â±ï¸ ç´¯è¨ˆå·¥æ™‚</label>
                        <span id="bonusHours">-</span>
                    </div>
                    <div class="stat-item">
                        <label>ğŸ“Š å¹³å‡æ¯æ—¥å·¥æ™‚</label>
                        <span id="bonusAvgHours">-</span>
                    </div>
                </div>
                <div style="margin-top:20px;">
                    <h3>ğŸ“„ è–ªè³‡å–®æŸ¥è©¢</h3>
                    <p class="status-box show info">åŠŸèƒ½é–‹ç™¼ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // é é¢åˆ‡æ›åŠŸèƒ½
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if(id==='attendancePage') {
                const now = new Date();
                const yearEl = document.getElementById('attendanceYear');
                const monthEl = document.getElementById('attendanceMonth');
                if (yearEl) yearEl.value = now.getFullYear();
                if (monthEl) monthEl.value = now.getMonth() + 1;
                loadMonthlyAttendance();
            }
            if(id==='leavePage') loadLeaveHistory();
            if(id==='salaryPage') {
                const salaryYearEl = document.getElementById('salaryYear');
                if (salaryYearEl) salaryYearEl.value = new Date().getFullYear();
                loadAnnualSummary();
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        window.addEventListener('load', async () => {
            // ç¢ºä¿ common.js ä¸­çš„å‡½æ•¸å·²è¼‰å…¥
            if (typeof initializeLiff === 'undefined') {
                console.error('initializeLiff å‡½æ•¸æœªå®šç¾©ï¼Œè«‹æª¢æŸ¥ common.js æ˜¯å¦æ­£ç¢ºè¼‰å…¥');
                return;
            }
            
            // æ ¹æ“š hash æ±ºå®šé¡¯ç¤ºå“ªå€‹é é¢
            const hash = window.location.hash || '#leave';
            let pageId = 'leavePage';
            
            if (hash === '#attendance') pageId = 'attendancePage';
            else if (hash === '#salary') pageId = 'salaryPage';

            const initialized = await initializeLiff();
            if (initialized) {
                const isLoggedIn = await checkUserStatus();
                if (isLoggedIn) {
                    showPage(pageId);
                } else {
                    window.location.href = 'index.html';
                }
            }
        });
    </script>
</body>
</html>
