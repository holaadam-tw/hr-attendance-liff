<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´€éŒ„æŸ¥è©¢</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
    <style>.tab-content { display: none; } .tab-content.active { display: block; }</style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="btn btn-secondary" style="margin-bottom:15px;">â† è¿”å›é¦–é </a>
        
        <div style="display:flex; gap:5px; margin-bottom:20px;">
            <button class="btn btn-secondary" onclick="switchTab('leave')">è«‹å‡</button>
            <button class="btn btn-secondary" onclick="switchTab('attendance')">è€ƒå‹¤</button>
            <button class="btn btn-secondary" onclick="switchTab('salary')">è–ªè³‡</button>
        </div>

        <div id="leave" class="tab-content">
            <div class="card">
                <h3>ğŸ“ ç”³è«‹è«‹å‡</h3>
                <select id="leaveType"><option value="annual">ç‰¹ä¼‘</option><option value="sick">ç—…å‡</option><option value="personal">äº‹å‡</option></select>
                <input type="date" id="leaveStart"><input type="date" id="leaveEnd">
                <input type="text" id="leaveReason" placeholder="åŸå› ">
                <button class="btn btn-primary" onclick="submitLeave()">æäº¤ç”³è«‹</button>
            </div>
            <div class="card">
                <h3>ğŸ“‹ æ­·å²ç´€éŒ„</h3>
                <div id="leaveList">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div id="attendance" class="tab-content">
            <div class="card">
                <h3>ğŸ“Š æœˆåº¦è€ƒå‹¤</h3>
                <div style="display:flex;gap:5px;">
                    <select id="attYear"><option value="2026">2026</option></select>
                    <select id="attMonth"><option value="1">1æœˆ</option><option value="2">2æœˆ</option></select>
                    <button class="btn btn-primary" style="margin-top:0;width:auto;" onclick="loadAttendance()">æŸ¥è©¢</button>
                </div>
                <div id="attList" style="margin-top:15px;"></div>
            </div>
        </div>

        <div id="salary" class="tab-content">
            <div class="card">
                <h3>ğŸ’° å¹´çµ‚èˆ‡è–ªè³‡</h3>
                <select id="salaryYear" onchange="loadSalary()"><option value="2026">2026</option></select>
                <div id="salaryResult" class="lunch-summary" style="display:none;margin-top:15px;"></div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        window.onload = () => initApp(() => {
            const hash = window.location.hash.substring(1) || 'leave';
            switchTab(hash);
        });

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'leave') loadLeave();
            if(id === 'salary') loadSalary();
        }

        // è«‹å‡é‚è¼¯
        async function loadLeave() {
            const { data } = await sb.rpc('get_leave_history', { p_line_user_id: liffProfile.userId });
            const list = document.getElementById('leaveList');
            if(!data || !data.length) list.innerHTML = 'ç„¡ç´€éŒ„';
            else list.innerHTML = data.map(r => `<div class="attendance-item"><div class="date">${r.leave_type} (${r.status})</div><div>${r.start_date}~${r.end_date}</div></div>`).join('');
        }
        async function submitLeave() {
            const type = document.getElementById('leaveType').value;
            const start = document.getElementById('leaveStart').value;
            const end = document.getElementById('leaveEnd').value;
            const reason = document.getElementById('leaveReason').value;
            if(!start) return alert('è«‹è¼¸å…¥æ—¥æœŸ');
            const { data, error } = await sb.rpc('submit_leave_request', {
                p_line_user_id: liffProfile.userId, p_leave_type: type, p_start_date: start, p_end_date: end, p_reason: reason
            });
            if(data && data.success) { alert('âœ… å·²æäº¤'); loadLeave(); }
            else alert('å¤±æ•—');
        }

        // è€ƒå‹¤é‚è¼¯
        async function loadAttendance() {
            const y = document.getElementById('attYear').value;
            const m = document.getElementById('attMonth').value;
            const { data } = await sb.rpc('get_monthly_attendance_v2', { p_line_user_id: liffProfile.userId, p_year: parseInt(y), p_month: parseInt(m) });
            document.getElementById('attList').innerHTML = (data||[]).map(r => `<div class="attendance-item"><div class="date">${r.date}</div><div>${r.check_in_time||'--'} - ${r.check_out_time||'--'}</div></div>`).join('');
        }

        // è–ªè³‡é‚è¼¯
        async function loadSalary() {
            const y = document.getElementById('salaryYear').value;
            const { data } = await sb.rpc('get_annual_summary', { p_line_user_id: liffProfile.userId, p_year: parseInt(y) });
            if(data && data.success) {
                const div = document.getElementById('salaryResult');
                div.style.display = 'block';
                div.innerHTML = `<div>åˆ°è·æ—¥: ${data.hire_date}</div><div>å¹´è³‡: ${data.months_worked}æœˆ</div><div style="font-weight:bold;margin-top:10px;">è³‡æ ¼: ${data.message}</div>`;
            }
        }
    </script>
</body>
</html>
